<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬4ç« ï¼šçµ„æˆãƒ™ãƒ¼ã‚¹ vs GNNå®šé‡çš„æ¯”è¼ƒ | GNNç‰¹å¾´é‡æ¯”è¼ƒå…¥é–€</title>
    <meta name="description" content="Matbenchãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¨RF/CGCNNã®å®šé‡çš„æ€§èƒ½æ¯”è¼ƒã€‚çµ±è¨ˆçš„æœ‰æ„æ€§æ¤œå®šã€è¨ˆç®—ã‚³ã‚¹ãƒˆã€ãƒ‡ãƒ¼ã‚¿è¦æ±‚é‡ã€è§£é‡ˆå¯èƒ½æ€§ã‚’å®Ÿè¨¼åˆ†æã€‚">

    <!-- MathJax 3.x for mathematical equations -->
    <script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        }
    };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Mermaid for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#fff',
                primaryBorderColor: '#764ba2',
                lineColor: '#764ba2',
                secondaryColor: '#764ba2',
                tertiaryColor: '#fff'
            }
        });
    </script>

    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            line-height: 1.8;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 3rem;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            font-size: 1.8rem;
            margin: 2.5rem 0 1.5rem;
            color: #667eea;
            border-left: 4px solid #764ba2;
            padding-left: 1rem;
        }

        h3 {
            font-size: 1.4rem;
            margin: 2rem 0 1rem;
            color: #764ba2;
        }

        p {
            margin-bottom: 1.2rem;
            text-align: justify;
        }

        .highlight-box {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 4px solid #667eea;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 8px;
        }

        .warning-box {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 8px;
        }

        pre {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .mermaid {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin: 2rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .exercise {
            background: rgba(118, 75, 162, 0.05);
            border: 2px solid #764ba2;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .exercise-header {
            font-weight: 600;
            color: #764ba2;
            margin-bottom: 0.5rem;
        }

        .difficulty {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .difficulty-easy {
            background: #4caf50;
            color: white;
        }

        .difficulty-medium {
            background: #ff9800;
            color: white;
        }

        .difficulty-hard {
            background: #f44336;
            color: white;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid #e0e0e0;
        }

        .nav-button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .nav-button:hover {
            transform: translateY(-2px);
        }

        ul, ol {
            margin: 1rem 0 1rem 2rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            pre {
                padding: 1rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç¬¬4ç« ï¼šçµ„æˆãƒ™ãƒ¼ã‚¹ vs GNNå®šé‡çš„æ¯”è¼ƒ</h1>

        <p>æœ¬ç« ã§ã¯ã€<strong>çµ„æˆãƒ™ãƒ¼ã‚¹ç‰¹å¾´é‡ï¼ˆMagpieï¼‰</strong>ã¨<strong>GNNæ§‹é€ ãƒ™ãƒ¼ã‚¹ç‰¹å¾´é‡ï¼ˆCGCNNï¼‰</strong>ã®æ€§èƒ½ã‚’ã€<strong>Matbenchæ¨™æº–ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</strong>ã‚’ç”¨ã„ã¦å®šé‡çš„ã«æ¯”è¼ƒã—ã¾ã™ã€‚å˜ãªã‚‹ç²¾åº¦æ¯”è¼ƒã ã‘ã§ãªãã€çµ±è¨ˆçš„æœ‰æ„æ€§ã€è¨ˆç®—ã‚³ã‚¹ãƒˆã€ãƒ‡ãƒ¼ã‚¿è¦æ±‚é‡ã€è§£é‡ˆå¯èƒ½æ€§ã®å¤šè§’çš„ãªè¦³ç‚¹ã‹ã‚‰å®Ÿè¨¼åˆ†æã‚’è¡Œã„ã¾ã™ã€‚</p>

        <div class="highlight-box">
            <strong>ğŸ¯ å­¦ç¿’ç›®æ¨™</strong>
            <ul>
                <li>Matbenchãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®æ§‹é€ ã¨è©•ä¾¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ç†è§£ã™ã‚‹</li>
                <li>Random Forest (Magpie) ã¨CGCNNã®äºˆæ¸¬ç²¾åº¦ã‚’å®šé‡çš„ã«æ¯”è¼ƒã™ã‚‹</li>
                <li>çµ±è¨ˆçš„æœ‰æ„æ€§æ¤œå®šï¼ˆtæ¤œå®šã€ä¿¡é ¼åŒºé–“ã€på€¤ï¼‰ã‚’å®Ÿè£…ã™ã‚‹</li>
                <li>è¨ˆç®—ã‚³ã‚¹ãƒˆï¼ˆè¨“ç·´æ™‚é–“ã€æ¨è«–æ™‚é–“ã€ãƒ¡ãƒ¢ãƒªï¼‰ã‚’æ¸¬å®šãƒ»æ¯”è¼ƒã™ã‚‹</li>
                <li>ãƒ‡ãƒ¼ã‚¿è¦æ±‚é‡ã®é•ã„ã‚’å­¦ç¿’æ›²ç·šã§å¯è¦–åŒ–ã™ã‚‹</li>
                <li>SHAPå€¤ã¨Attentionæ©Ÿæ§‹ã«ã‚ˆã‚‹è§£é‡ˆå¯èƒ½æ€§ã‚’æ¯”è¼ƒã™ã‚‹</li>
                <li>æ‰‹æ³•é¸æŠã®æ„æ€æ±ºå®šãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹</li>
            </ul>
        </div>

        <h2>4.1 Matbenchãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®æ¦‚è¦</h2>

        <p>Matbenchï¼ˆMaterials Benchmarkï¼‰ã¯ã€ææ–™ç§‘å­¦ã«ãŠã‘ã‚‹æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®<strong>æ¨™æº–åŒ–ã•ã‚ŒãŸè©•ä¾¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </strong>ã§ã™ã€‚13ç¨®é¡ã®ææ–™ç‰©æ€§äºˆæ¸¬ã‚¿ã‚¹ã‚¯ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€å„ã‚¿ã‚¹ã‚¯ã«ã¯è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã€æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒäº‹å‰ã«åˆ†å‰²ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç•°ãªã‚‹ç ”ç©¶é–“ã§ã®å…¬å¹³ãªæ€§èƒ½æ¯”è¼ƒãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>

        <h3>4.1.1 Matbenchã®ä¸»è¦ã‚¿ã‚¹ã‚¯</h3>

        <table>
            <thead>
                <tr>
                    <th>ã‚¿ã‚¹ã‚¯å</th>
                    <th>ç‰©æ€§</th>
                    <th>ãƒ‡ãƒ¼ã‚¿æ•°</th>
                    <th>è©•ä¾¡æŒ‡æ¨™</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>matbench_mp_e_form</td>
                    <td>ç”Ÿæˆã‚¨ãƒãƒ«ã‚®ãƒ¼ (eV/atom)</td>
                    <td>132,752</td>
                    <td>MAE</td>
                </tr>
                <tr>
                    <td>matbench_mp_gap</td>
                    <td>ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ— (eV)</td>
                    <td>106,113</td>
                    <td>MAE</td>
                </tr>
                <tr>
                    <td>matbench_perovskites</td>
                    <td>ç”Ÿæˆã‚¨ãƒãƒ«ã‚®ãƒ¼ (eV/atom)</td>
                    <td>18,928</td>
                    <td>MAE</td>
                </tr>
                <tr>
                    <td>matbench_phonons</td>
                    <td>æœ€å¤§ãƒ•ã‚©ãƒãƒ³å‘¨æ³¢æ•° (cmâ»Â¹)</td>
                    <td>1,265</td>
                    <td>MAE</td>
                </tr>
                <tr>
                    <td>matbench_jdft2d</td>
                    <td>å‰¥é›¢ã‚¨ãƒãƒ«ã‚®ãƒ¼ (meV/atom)</td>
                    <td>636</td>
                    <td>MAE</td>
                </tr>
            </tbody>
        </table>

        <p>æœ¬ç« ã§ã¯ã€<strong>matbench_mp_e_formï¼ˆç”Ÿæˆã‚¨ãƒãƒ«ã‚®ãƒ¼äºˆæ¸¬ï¼‰</strong>ã¨<strong>matbench_mp_gapï¼ˆãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—äºˆæ¸¬ï¼‰</strong>ã®2ã¤ã®ã‚¿ã‚¹ã‚¯ã‚’å¯¾è±¡ã«ã€Random Forestï¼ˆMagpieç‰¹å¾´é‡ï¼‰ã¨CGCNNã®æ€§èƒ½ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚</p>

        <h3>4.1.2 è©•ä¾¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«</h3>

        <p>Matbenchã§ã¯ã€<strong>5-foldäº¤å·®æ¤œè¨¼</strong>ã«ã‚ˆã‚‹è©•ä¾¡ãŒæ¨™æº–ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå…¨ä½“ãŒ5ã¤ã®foldã«åˆ†å‰²ã•ã‚Œã¦ãŠã‚Šã€å„foldã«ã¤ã„ã¦ä»¥ä¸‹ã®è©•ä¾¡ã‚’å®Ÿæ–½ã—ã¾ã™ï¼š</p>

        <ol>
            <li><strong>è¨“ç·´ï¼ˆTrainingï¼‰</strong>ï¼šæ®‹ã‚Šã®4 foldã§ãƒ¢ãƒ‡ãƒ«ã‚’è¨“ç·´</li>
            <li><strong>æ¤œè¨¼ï¼ˆValidationï¼‰</strong>ï¼šãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ä½¿ç”¨ï¼ˆä»»æ„ï¼‰</li>
            <li><strong>ãƒ†ã‚¹ãƒˆï¼ˆTestingï¼‰</strong>ï¼šè©²å½“foldã§æ€§èƒ½è©•ä¾¡ï¼ˆMAEã€RMSEã€RÂ²ã‚’è¨ˆç®—ï¼‰</li>
        </ol>

        <p>5ã¤ã®foldã®è©•ä¾¡æŒ‡æ¨™ã‚’å¹³å‡ã™ã‚‹ã“ã¨ã§ã€<strong>æ±åŒ–æ€§èƒ½ã®ä¿¡é ¼æ€§ã®é«˜ã„æ¨å®š</strong>ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚</p>

        <h2>4.2 Matbenchãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè£…</h2>

        <p>æœ¬ç¯€ã§ã¯ã€Random Forestï¼ˆMagpieï¼‰ã¨CGCNN on Matbench mp_e_formã‚¿ã‚¹ã‚¯ã‚’å®Ÿè£…ã—ã€äºˆæ¸¬ç²¾åº¦ã‚’å®šé‡çš„ã«æ¯”è¼ƒã—ã¾ã™ã€‚</p>

        <h3>4.2.1 ç’°å¢ƒæ§‹ç¯‰ã¨ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰</h3>

        <div class="highlight-box">
            <strong>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹1ï¼šMatbenchãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ‰</strong>
        </div>

        <pre><code class="language-python"># Matbenchãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ‰ã¨å‰å‡¦ç†
import numpy as np
import pandas as pd
from matbench.bench import MatbenchBenchmark
from pymatgen.core import Structure
from matminer.featurizers.composition import ElementProperty
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
import warnings
warnings.filterwarnings('ignore')

# Matbenchãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®åˆæœŸåŒ–
mb = MatbenchBenchmark(autoload=False)

# mp_e_formã‚¿ã‚¹ã‚¯ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆç”Ÿæˆã‚¨ãƒãƒ«ã‚®ãƒ¼äºˆæ¸¬ï¼‰
task = mb.matbench_mp_e_form
task.load()

print(f"ã‚¿ã‚¹ã‚¯å: {task.metadata['task_type']}")
print(f"ãƒ‡ãƒ¼ã‚¿æ•°: {len(task.df)}")
print(f"å…¥åŠ›: {task.metadata['input_type']}")
print(f"å‡ºåŠ›: {task.metadata['target']}")

# ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ç¢ºèª
print("\nãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:")
print(task.df.head(3))

# å‡ºåŠ›ä¾‹ï¼š
# ã‚¿ã‚¹ã‚¯å: regression
# ãƒ‡ãƒ¼ã‚¿æ•°: 132752
# å…¥åŠ›: structure
# å‡ºåŠ›: e_form (eV/atom)
#
# ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:
#                                           structure  e_form
# 0  Structure: Fe2 O3 ...                    -2.54
# 1  Structure: Mn2 O3 ...                    -2.89
# 2  Structure: Co2 O3 ...                    -2.31
</code></pre>

        <h3>4.2.2 Random Forestï¼ˆMagpieç‰¹å¾´é‡ï¼‰ã®å®Ÿè£…</h3>

        <div class="highlight-box">
            <strong>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹2ï¼šMagpieç‰¹å¾´é‡æŠ½å‡ºã¨Random Forestè¨“ç·´</strong>
        </div>

        <pre><code class="language-python"># Random Forest + Magpieç‰¹å¾´é‡ã®å®Ÿè£…
from matminer.featurizers.composition import ElementProperty

def extract_magpie_features(structures):
    """
    Pymatgenã®Structureã‹ã‚‰Magpieç‰¹å¾´é‡ã‚’æŠ½å‡º

    Parameters:
    -----------
    structures : list of Structure
        çµæ™¶æ§‹é€ ã®ãƒªã‚¹ãƒˆ

    Returns:
    --------
    features : np.ndarray, shape (n_samples, 145)
        Magpieç‰¹å¾´é‡ï¼ˆ145æ¬¡å…ƒï¼‰
    """
    # Magpieç‰¹å¾´é‡æŠ½å‡ºå™¨ã®åˆæœŸåŒ–
    featurizer = ElementProperty.from_preset("magpie")

    features = []
    for struct in structures:
        # Structureã‹ã‚‰Compositionã‚’å–å¾—
        comp = struct.composition
        # Magpieç‰¹å¾´é‡ã‚’è¨ˆç®—ï¼ˆ145æ¬¡å…ƒï¼‰
        feat = featurizer.featurize(comp)
        features.append(feat)

    return np.array(features)

# 5-foldäº¤å·®æ¤œè¨¼ã®è©•ä¾¡
rf_results = []

for fold_idx, fold in enumerate(task.folds):
    print(f"\n=== Fold {fold_idx + 1}/5 ===")

    # è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    train_inputs, train_outputs = task.get_train_and_val_data(fold)
    test_inputs, test_outputs = task.get_test_data(fold, include_target=True)

    # Magpieç‰¹å¾´é‡æŠ½å‡º
    print("Magpieç‰¹å¾´é‡ã‚’æŠ½å‡ºä¸­...")
    X_train = extract_magpie_features(train_inputs)
    X_test = extract_magpie_features(test_inputs)
    y_train = train_outputs.values
    y_test = test_outputs.values

    print(f"è¨“ç·´ãƒ‡ãƒ¼ã‚¿: {X_train.shape}, ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿: {X_test.shape}")

    # Random Forestãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´
    print("Random Forestã‚’è¨“ç·´ä¸­...")
    rf_model = RandomForestRegressor(
        n_estimators=100,
        max_depth=30,
        min_samples_split=5,
        random_state=42,
        n_jobs=-1
    )
    rf_model.fit(X_train, y_train)

    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§äºˆæ¸¬
    y_pred = rf_model.predict(X_test)

    # è©•ä¾¡æŒ‡æ¨™ã‚’è¨ˆç®—
    mae = mean_absolute_error(y_test, y_pred)
    rmse = np.sqrt(mean_squared_error(y_test, y_pred))
    r2 = r2_score(y_test, y_pred)

    print(f"MAE:  {mae:.4f} eV/atom")
    print(f"RMSE: {rmse:.4f} eV/atom")
    print(f"RÂ²:   {r2:.4f}")

    rf_results.append({
        'fold': fold_idx + 1,
        'mae': mae,
        'rmse': rmse,
        'r2': r2
    })

# 5-foldå¹³å‡ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
rf_df = pd.DataFrame(rf_results)
print("\n=== Random Forest (Magpie) ç·åˆçµæœ ===")
print(f"MAE:  {rf_df['mae'].mean():.4f} Â± {rf_df['mae'].std():.4f} eV/atom")
print(f"RMSE: {rf_df['rmse'].mean():.4f} Â± {rf_df['rmse'].std():.4f} eV/atom")
print(f"RÂ²:   {rf_df['r2'].mean():.4f} Â± {rf_df['r2'].std():.4f}")

# å‡ºåŠ›ä¾‹ï¼š
# === Random Forest (Magpie) ç·åˆçµæœ ===
# MAE:  0.0325 Â± 0.0012 eV/atom
# RMSE: 0.0678 Â± 0.0019 eV/atom
# RÂ²:   0.9321 Â± 0.0045
</code></pre>

        <h3>4.2.3 CGCNNã®å®Ÿè£…</h3>

        <div class="highlight-box">
            <strong>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹3ï¼šCGCNN on Matbenchè¨“ç·´</strong>
        </div>

        <pre><code class="language-python"># CGCNN on Matbenchã®å®Ÿè£…
import torch
import torch.nn as nn
from torch_geometric.data import Data, DataLoader
from torch_geometric.nn import CGConv, global_mean_pool
import time

# CGCNN for Matbenchã®å®šç¾©ï¼ˆChapter 2ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ï¼‰
class CGCNNMatbench(nn.Module):
    def __init__(self, atom_fea_len=92, nbr_fea_len=41, hidden_dim=128, n_conv=3):
        super(CGCNNMatbench, self).__init__()

        # Atom embedding
        self.atom_embedding = nn.Linear(atom_fea_len, hidden_dim)

        # Convolution layers
        self.conv_layers = nn.ModuleList([
            CGConv(hidden_dim, nbr_fea_len) for _ in range(n_conv)
        ])
        self.bn_layers = nn.ModuleList([
            nn.BatchNorm1d(hidden_dim) for _ in range(n_conv)
        ])

        # Readout
        self.fc1 = nn.Linear(hidden_dim, 64)
        self.fc2 = nn.Linear(64, 1)
        self.activation = nn.Softplus()

    def forward(self, data):
        x, edge_index, edge_attr, batch = data.x, data.edge_index, data.edge_attr, data.batch

        # Atom embedding
        x = self.atom_embedding(x)

        # Graph convolutions
        for conv, bn in zip(self.conv_layers, self.bn_layers):
            x = conv(x, edge_index, edge_attr)
            x = bn(x)
            x = self.activation(x)

        # Global pooling
        x = global_mean_pool(x, batch)

        # Fully connected layers
        x = self.fc1(x)
        x = self.activation(x)
        x = self.fc2(x)

        return x.squeeze()

def structure_to_pyg_data(structure, target, cutoff=8.0):
    """
    Pymatgenã®Structureã‚’PyTorch Geometricã®ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›

    Parameters:
    -----------
    structure : Structure
        çµæ™¶æ§‹é€ 
    target : float
        ç›®æ¨™å€¤ï¼ˆç”Ÿæˆã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼‰
    cutoff : float
        ã‚«ãƒƒãƒˆã‚ªãƒ•åŠå¾„ (Ã…)

    Returns:
    --------
    data : Data
        PyTorch Geometricã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    """
    # ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ï¼ˆå…ƒç´ ã®one-hot encodingã€92æ¬¡å…ƒï¼‰
    atom_types = [site.specie.Z for site in structure]
    x = torch.zeros(len(atom_types), 92)
    for i, z in enumerate(atom_types):
        x[i, z - 1] = 1.0

    # ã‚¨ãƒƒã‚¸æ§‹ç¯‰ï¼ˆcutoffåŠå¾„ä»¥å†…ã®åŸå­ãƒšã‚¢ï¼‰
    neighbors = structure.get_all_neighbors(cutoff)
    edge_index = []
    edge_attr = []

    for i, neighbors_i in enumerate(neighbors):
        for neighbor in neighbors_i:
            j = neighbor.index
            distance = neighbor.nn_distance

            # Gaussian distance expansion (41æ¬¡å…ƒ)
            distances = torch.linspace(0, cutoff, 41)
            sigma = 0.5
            edge_feature = torch.exp(-((distance - distances) ** 2) / (2 * sigma ** 2))

            edge_index.append([i, j])
            edge_attr.append(edge_feature)

    edge_index = torch.tensor(edge_index, dtype=torch.long).t().contiguous()
    edge_attr = torch.stack(edge_attr)
    y = torch.tensor([target], dtype=torch.float)

    return Data(x=x, edge_index=edge_index, edge_attr=edge_attr, y=y)

# 5-foldäº¤å·®æ¤œè¨¼ã®è©•ä¾¡
cgcnn_results = []

device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
print(f"ä½¿ç”¨ãƒ‡ãƒã‚¤ã‚¹: {device}")

for fold_idx, fold in enumerate(task.folds):
    print(f"\n=== Fold {fold_idx + 1}/5 ===")

    # è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    train_inputs, train_outputs = task.get_train_and_val_data(fold)
    test_inputs, test_outputs = task.get_test_data(fold, include_target=True)

    # PyTorch Geometricãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
    print("ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ä¸­...")
    train_data = [structure_to_pyg_data(s, t) for s, t in zip(train_inputs, train_outputs.values)]
    test_data = [structure_to_pyg_data(s, t) for s, t in zip(test_inputs, test_outputs.values)]

    train_loader = DataLoader(train_data, batch_size=32, shuffle=True)
    test_loader = DataLoader(test_data, batch_size=32, shuffle=False)

    # CGCNNãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–
    model = CGCNNMatbench().to(device)
    optimizer = torch.optim.Adam(model.parameters(), lr=0.001)
    criterion = nn.L1Loss()  # MAEæå¤±

    # è¨“ç·´
    print("CGCNNã‚’è¨“ç·´ä¸­...")
    model.train()
    for epoch in range(50):  # å®Ÿéš›ã«ã¯early stoppingã‚’ä½¿ç”¨ã™ã¹ã
        total_loss = 0
        for batch in train_loader:
            batch = batch.to(device)
            optimizer.zero_grad()
            out = model(batch)
            loss = criterion(out, batch.y)
            loss.backward()
            optimizer.step()
            total_loss += loss.item()

        if (epoch + 1) % 10 == 0:
            print(f"Epoch {epoch+1}/50, Loss: {total_loss/len(train_loader):.4f}")

    # ãƒ†ã‚¹ãƒˆ
    model.eval()
    y_true = []
    y_pred = []

    with torch.no_grad():
        for batch in test_loader:
            batch = batch.to(device)
            out = model(batch)
            y_true.extend(batch.y.cpu().numpy())
            y_pred.extend(out.cpu().numpy())

    y_true = np.array(y_true)
    y_pred = np.array(y_pred)

    # è©•ä¾¡æŒ‡æ¨™ã‚’è¨ˆç®—
    mae = mean_absolute_error(y_true, y_pred)
    rmse = np.sqrt(mean_squared_error(y_true, y_pred))
    r2 = r2_score(y_true, y_pred)

    print(f"MAE:  {mae:.4f} eV/atom")
    print(f"RMSE: {rmse:.4f} eV/atom")
    print(f"RÂ²:   {r2:.4f}")

    cgcnn_results.append({
        'fold': fold_idx + 1,
        'mae': mae,
        'rmse': rmse,
        'r2': r2
    })

# 5-foldå¹³å‡ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
cgcnn_df = pd.DataFrame(cgcnn_results)
print("\n=== CGCNN ç·åˆçµæœ ===")
print(f"MAE:  {cgcnn_df['mae'].mean():.4f} Â± {cgcnn_df['mae'].std():.4f} eV/atom")
print(f"RMSE: {cgcnn_df['rmse'].mean():.4f} Â± {cgcnn_df['rmse'].std():.4f} eV/atom")
print(f"RÂ²:   {cgcnn_df['r2'].mean():.4f} Â± {cgcnn_df['r2'].std():.4f}")

# å‡ºåŠ›ä¾‹ï¼š
# === CGCNN ç·åˆçµæœ ===
# MAE:  0.0286 Â± 0.0009 eV/atom
# RMSE: 0.0592 Â± 0.0014 eV/atom
# RÂ²:   0.9524 Â± 0.0032
</code></pre>

        <h3>4.2.4 äºˆæ¸¬ç²¾åº¦ã®å®šé‡çš„æ¯”è¼ƒ</h3>

        <p>5-foldäº¤å·®æ¤œè¨¼ã®çµæœã‚’çµ±åˆã—ã€Random Forestï¼ˆMagpieï¼‰ã¨CGCNNã®äºˆæ¸¬ç²¾åº¦ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚</p>

        <div class="highlight-box">
            <strong>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹4ï¼šäºˆæ¸¬ç²¾åº¦æ¯”è¼ƒã®å¯è¦–åŒ–</strong>
        </div>

        <pre><code class="language-python"># äºˆæ¸¬ç²¾åº¦æ¯”è¼ƒã®å¯è¦–åŒ–
import matplotlib.pyplot as plt
import seaborn as sns

# çµæœã‚’çµ±åˆ
comparison_df = pd.DataFrame({
    'Model': ['RF (Magpie)'] * 5 + ['CGCNN'] * 5,
    'Fold': list(range(1, 6)) * 2,
    'MAE': list(rf_df['mae']) + list(cgcnn_df['mae']),
    'RMSE': list(rf_df['rmse']) + list(cgcnn_df['rmse']),
    'RÂ²': list(rf_df['r2']) + list(cgcnn_df['r2'])
})

# å¯è¦–åŒ–
fig, axes = plt.subplots(1, 3, figsize=(15, 5))

# MAEæ¯”è¼ƒ
sns.barplot(data=comparison_df, x='Model', y='MAE', ax=axes[0], palette=['#667eea', '#764ba2'])
axes[0].set_title('MAE Comparison (Lower is Better)', fontsize=14, fontweight='bold')
axes[0].set_ylabel('MAE (eV/atom)', fontsize=12)
axes[0].axhline(0.03, color='red', linestyle='--', linewidth=1, label='Target: 0.03')
axes[0].legend()

# RMSEæ¯”è¼ƒ
sns.barplot(data=comparison_df, x='Model', y='RMSE', ax=axes[1], palette=['#667eea', '#764ba2'])
axes[1].set_title('RMSE Comparison (Lower is Better)', fontsize=14, fontweight='bold')
axes[1].set_ylabel('RMSE (eV/atom)', fontsize=12)

# RÂ²æ¯”è¼ƒ
sns.barplot(data=comparison_df, x='Model', y='RÂ²', ax=axes[2], palette=['#667eea', '#764ba2'])
axes[2].set_title('RÂ² Comparison (Higher is Better)', fontsize=14, fontweight='bold')
axes[2].set_ylabel('RÂ²', fontsize=12)
axes[2].axhline(0.95, color='red', linestyle='--', linewidth=1, label='Target: 0.95')
axes[2].legend()

plt.tight_layout()
plt.savefig('accuracy_comparison.png', dpi=300, bbox_inches='tight')
plt.show()

# çµ±è¨ˆã‚µãƒãƒªãƒ¼
print("=== äºˆæ¸¬ç²¾åº¦ã®çµ±è¨ˆã‚µãƒãƒªãƒ¼ ===")
print(comparison_df.groupby('Model').agg({
    'MAE': ['mean', 'std'],
    'RMSE': ['mean', 'std'],
    'RÂ²': ['mean', 'std']
}).round(4))

# ç›¸å¯¾çš„ãªæ”¹å–„ç‡ã‚’è¨ˆç®—
mae_improvement = (rf_df['mae'].mean() - cgcnn_df['mae'].mean()) / rf_df['mae'].mean() * 100
rmse_improvement = (rf_df['rmse'].mean() - cgcnn_df['rmse'].mean()) / rf_df['rmse'].mean() * 100
r2_improvement = (cgcnn_df['r2'].mean() - rf_df['r2'].mean()) / rf_df['r2'].mean() * 100

print(f"\n=== CGCNNã®ç›¸å¯¾çš„æ”¹å–„ç‡ ===")
print(f"MAEæ”¹å–„:  {mae_improvement:.2f}%")
print(f"RMSEæ”¹å–„: {rmse_improvement:.2f}%")
print(f"RÂ²æ”¹å–„:   {r2_improvement:.2f}%")

# å‡ºåŠ›ä¾‹ï¼š
# === CGCNNã®ç›¸å¯¾çš„æ”¹å–„ç‡ ===
# MAEæ”¹å–„:  12.00%
# RMSEæ”¹å–„: 12.68%
# RÂ²æ”¹å–„:   2.18%
</code></pre>

        <p><strong>çµæœã®è§£é‡ˆï¼š</strong></p>
        <ul>
            <li><strong>MAEæ”¹å–„ï¼š12.00%</strong> - CGCNNã¯ç”Ÿæˆã‚¨ãƒãƒ«ã‚®ãƒ¼äºˆæ¸¬ã«ãŠã„ã¦ã€Magpie+RFã‚ˆã‚Šã‚‚ç´„12%ä½ã„èª¤å·®ã‚’é”æˆ</li>
            <li><strong>RÂ²æ”¹å–„ï¼š2.18%</strong> - æ—¢ã«RFãŒé«˜ã„RÂ²ï¼ˆ0.932ï¼‰ã‚’é”æˆã—ã¦ã„ã‚‹ãŸã‚ã€ç›¸å¯¾çš„æ”¹å–„ç‡ã¯å°ã•ã„ãŒã€CGCNNã¯0.952ã¨ã„ã†æ¥µã‚ã¦é«˜ã„æ±ºå®šä¿‚æ•°ã‚’å®Ÿç¾</li>
            <li><strong>çµ±è¨ˆçš„æœ‰æ„æ€§ã®æ¤œè¨¼ãŒå¿…è¦</strong> - æ¬¡ç¯€ã§ã€ã“ã®ç²¾åº¦å·®ãŒçµ±è¨ˆçš„ã«æœ‰æ„ã‹ã‚’æ¤œå®šã—ã¾ã™</li>
        </ul>

        <div class="warning-box">
            <strong>âš ï¸ é‡è¦ãªæ³¨æ„ç‚¹</strong>
            <p>æœ¬ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã¯è¨ˆç®—æ™‚é–“ã®éƒ½åˆä¸Šã€CGCNNã®ã‚¨ãƒãƒƒã‚¯æ•°ã‚’50ã«åˆ¶é™ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ã¯<strong>early stoppingã¨ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–</strong>ã‚’å®Ÿæ–½ã™ã¹ãã§ã™ã€‚ã¾ãŸã€GPUç’°å¢ƒã§ã®å®Ÿè¡Œã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ï¼ˆè¨“ç·´æ™‚é–“ãŒ10-20å€é«˜é€ŸåŒ–ï¼‰ã€‚</p>
        </div>

        <h2>4.3 çµ±è¨ˆçš„æœ‰æ„æ€§æ¤œå®š</h2>

        <p>å‰ç¯€ã§ã¯ã€CGCNNãŒRandom Forestï¼ˆMagpieï¼‰ã‚ˆã‚Šã‚‚ç´„12%ä½ã„MAEã‚’é”æˆã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ã—ã‹ã—ã€ã“ã®ç²¾åº¦å·®ãŒ<strong>çµ±è¨ˆçš„ã«æœ‰æ„</strong>ã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã—ãªã‘ã‚Œã°ã€å˜ãªã‚‹å¶ç„¶ã®å¯èƒ½æ€§ã‚’æ’é™¤ã§ãã¾ã›ã‚“ã€‚æœ¬ç¯€ã§ã¯ã€<strong>å¯¾å¿œã®ã‚ã‚‹tæ¤œå®šï¼ˆpaired t-testï¼‰</strong>ã¨<strong>95%ä¿¡é ¼åŒºé–“</strong>ã‚’ç”¨ã„ã¦çµ±è¨ˆçš„æœ‰æ„æ€§ã‚’è©•ä¾¡ã—ã¾ã™ã€‚</p>

        <h3>4.3.1 å¯¾å¿œã®ã‚ã‚‹tæ¤œå®šã®åŸç†</h3>

        <p>5-foldäº¤å·®æ¤œè¨¼ã§ã¯ã€åŒã˜ãƒ‡ãƒ¼ã‚¿åˆ†å‰²ã«å¯¾ã—ã¦RFã¨CGCNNã®ä¸¡æ–¹ã‚’è©•ä¾¡ã—ã¦ã„ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€å„foldã®MAEå·®ã¯<strong>å¯¾å¿œã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆpaired dataï¼‰</strong>ã¨ã—ã¦æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚å¯¾å¿œã®ã‚ã‚‹tæ¤œå®šã¯ã€ä»¥ä¸‹ã®å¸°ç„¡ä»®èª¬ã‚’æ¤œå®šã—ã¾ã™ï¼š</p>

        <p>$$H_0: \mu_{\text{diff}} = 0 \quad \text{ï¼ˆRFã¨CGCNNã®å¹³å‡MAEå·®ã¯ã‚¼ãƒ­ï¼‰}$$</p>

        <p>$$H_1: \mu_{\text{diff}} \neq 0 \quad \text{ï¼ˆå¹³å‡MAEå·®ã¯ã‚¼ãƒ­ã§ã¯ãªã„ï¼‰}$$</p>

        <p>æ¤œå®šçµ±è¨ˆé‡tã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨ˆç®—ã•ã‚Œã¾ã™ï¼š</p>

        <p>$$t = \frac{\bar{d}}{s_d / \sqrt{n}}$$</p>

        <p>ã“ã“ã§ã€$\bar{d}$ã¯å·®ã®å¹³å‡ã€$s_d$ã¯å·®ã®æ¨™æº–åå·®ã€$n$ã¯ã‚µãƒ³ãƒ—ãƒ«æ•°ï¼ˆfoldæ•°=5ï¼‰ã§ã™ã€‚</p>

        <h3>4.3.2 tæ¤œå®šã®å®Ÿè£…</h3>

        <div class="highlight-box">
            <strong>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹5ï¼šå¯¾å¿œã®ã‚ã‚‹tæ¤œå®šã®å®Ÿè£…</strong>
        </div>

        <pre><code class="language-python"># å¯¾å¿œã®ã‚ã‚‹tæ¤œå®šã®å®Ÿè£…
from scipy import stats
import numpy as np

# Random Forestã¨CGCNNã®MAEï¼ˆ5 foldã®çµæœï¼‰
rf_mae = np.array([0.0325, 0.0338, 0.0312, 0.0329, 0.0321])  # ä¾‹ç¤ºãƒ‡ãƒ¼ã‚¿
cgcnn_mae = np.array([0.0286, 0.0293, 0.0279, 0.0288, 0.0284])  # ä¾‹ç¤ºãƒ‡ãƒ¼ã‚¿

# MAEã®å·®ã‚’è¨ˆç®—
mae_diff = rf_mae - cgcnn_mae

print("=== å¯¾å¿œã®ã‚ã‚‹tæ¤œå®š ===")
print(f"RF MAE:     {rf_mae}")
print(f"CGCNN MAE:  {cgcnn_mae}")
print(f"MAEå·®:      {mae_diff}")
print(f"å¹³å‡å·®:     {mae_diff.mean():.4f} eV/atom")
print(f"æ¨™æº–åå·®:   {mae_diff.std(ddof=1):.4f} eV/atom")

# å¯¾å¿œã®ã‚ã‚‹tæ¤œå®šã‚’å®Ÿæ–½
t_statistic, p_value = stats.ttest_rel(rf_mae, cgcnn_mae)

print(f"\ntçµ±è¨ˆé‡:    {t_statistic:.4f}")
print(f"på€¤:        {p_value:.4f}")

# æœ‰æ„æ°´æº–Î±=0.05ã§åˆ¤å®š
alpha = 0.05
if p_value < alpha:
    print(f"\nåˆ¤å®š: på€¤ ({p_value:.4f}) < Î± ({alpha}) â†’ å¸°ç„¡ä»®èª¬ã‚’æ£„å´")
    print("çµè«–: CGCNNã¨RFã®ç²¾åº¦å·®ã¯çµ±è¨ˆçš„ã«æœ‰æ„ã§ã™ã€‚")
else:
    print(f"\nåˆ¤å®š: på€¤ ({p_value:.4f}) â‰¥ Î± ({alpha}) â†’ å¸°ç„¡ä»®èª¬ã‚’æ£„å´ã§ãã¾ã›ã‚“")
    print("çµè«–: CGCNNã¨RFã®ç²¾åº¦å·®ã¯çµ±è¨ˆçš„ã«æœ‰æ„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")

# åŠ¹æœé‡ï¼ˆCohen's dï¼‰ã‚’è¨ˆç®—
cohens_d = mae_diff.mean() / mae_diff.std(ddof=1)
print(f"\nåŠ¹æœé‡ï¼ˆCohen's dï¼‰: {cohens_d:.4f}")
if abs(cohens_d) < 0.2:
    print("åŠ¹æœé‡ã®å¤§ãã•: å°ã•ã„")
elif abs(cohens_d) < 0.5:
    print("åŠ¹æœé‡ã®å¤§ãã•: ä¸­ç¨‹åº¦")
elif abs(cohens_d) < 0.8:
    print("åŠ¹æœé‡ã®å¤§ãã•: å¤§ãã„")
else:
    print("åŠ¹æœé‡ã®å¤§ãã•: éå¸¸ã«å¤§ãã„")

# å‡ºåŠ›ä¾‹ï¼š
# === å¯¾å¿œã®ã‚ã‚‹tæ¤œå®š ===
# RF MAE:     [0.0325 0.0338 0.0312 0.0329 0.0321]
# CGCNN MAE:  [0.0286 0.0293 0.0279 0.0288 0.0284]
# MAEå·®:      [0.0039 0.0045 0.0033 0.0041 0.0037]
# å¹³å‡å·®:     0.0039 eV/atom
# æ¨™æº–åå·®:   0.0004 eV/atom
#
# tçµ±è¨ˆé‡:    20.5891
# på€¤:        0.0001
#
# åˆ¤å®š: på€¤ (0.0001) < Î± (0.05) â†’ å¸°ç„¡ä»®èª¬ã‚’æ£„å´
# çµè«–: CGCNNã¨RFã®ç²¾åº¦å·®ã¯çµ±è¨ˆçš„ã«æœ‰æ„ã§ã™ã€‚
#
# åŠ¹æœé‡ï¼ˆCohen's dï¼‰: 9.1894
# åŠ¹æœé‡ã®å¤§ãã•: éå¸¸ã«å¤§ãã„
</code></pre>

        <h3>4.3.3 95%ä¿¡é ¼åŒºé–“ã®è¨ˆç®—</h3>

        <p>95%ä¿¡é ¼åŒºé–“ã¯ã€<strong>çœŸã®å¹³å‡å·®ãŒ95%ã®ç¢ºç‡ã§å«ã¾ã‚Œã‚‹ç¯„å›²</strong>ã‚’ç¤ºã—ã¾ã™ã€‚ä¿¡é ¼åŒºé–“ãŒ0ã‚’å«ã¾ãªã„å ´åˆã€çµ±è¨ˆçš„ã«æœ‰æ„ãªå·®ãŒã‚ã‚‹ã¨çµè«–ã§ãã¾ã™ã€‚</p>

        <div class="highlight-box">
            <strong>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹6ï¼š95%ä¿¡é ¼åŒºé–“ã®è¨ˆç®—ã¨å¯è¦–åŒ–</strong>
        </div>

        <pre><code class="language-python"># 95%ä¿¡é ¼åŒºé–“ã®è¨ˆç®—ã¨å¯è¦–åŒ–
from scipy import stats
import matplotlib.pyplot as plt

# 95%ä¿¡é ¼åŒºé–“ã‚’è¨ˆç®—
confidence_level = 0.95
degrees_freedom = len(mae_diff) - 1
t_critical = stats.t.ppf((1 + confidence_level) / 2, degrees_freedom)

mean_diff = mae_diff.mean()
se_diff = mae_diff.std(ddof=1) / np.sqrt(len(mae_diff))
margin_error = t_critical * se_diff

ci_lower = mean_diff - margin_error
ci_upper = mean_diff + margin_error

print("=== 95%ä¿¡é ¼åŒºé–“ ===")
print(f"å¹³å‡å·®:          {mean_diff:.4f} eV/atom")
print(f"æ¨™æº–èª¤å·®:        {se_diff:.4f} eV/atom")
print(f"tè‡¨ç•Œå€¤ (df={degrees_freedom}): {t_critical:.4f}")
print(f"èª¤å·®ç¯„å›²:        Â±{margin_error:.4f} eV/atom")
print(f"95%ä¿¡é ¼åŒºé–“:     [{ci_lower:.4f}, {ci_upper:.4f}] eV/atom")

if ci_lower > 0:
    print("\nåˆ¤å®š: ä¿¡é ¼åŒºé–“ãŒ0ã‚’å«ã¾ãªã„ â†’ çµ±è¨ˆçš„ã«æœ‰æ„ãªå·®ã‚ã‚Š")
else:
    print("\nåˆ¤å®š: ä¿¡é ¼åŒºé–“ãŒ0ã‚’å«ã‚€ â†’ çµ±è¨ˆçš„ã«æœ‰æ„ãªå·®ãªã—")

# å¯è¦–åŒ–
fig, ax = plt.subplots(figsize=(10, 6))

# å„foldã®MAEå·®ã‚’ãƒ—ãƒ­ãƒƒãƒˆ
ax.scatter(range(1, 6), mae_diff, s=100, color='#764ba2', zorder=3, label='å„foldã®MAEå·®')

# å¹³å‡ç·š
ax.axhline(mean_diff, color='#667eea', linestyle='--', linewidth=2, label=f'å¹³å‡å·®: {mean_diff:.4f}')

# 95%ä¿¡é ¼åŒºé–“
ax.axhspan(ci_lower, ci_upper, alpha=0.2, color='#667eea', label=f'95%ä¿¡é ¼åŒºé–“: [{ci_lower:.4f}, {ci_upper:.4f}]')

# ã‚¼ãƒ­ãƒ©ã‚¤ãƒ³
ax.axhline(0, color='red', linestyle='-', linewidth=1, label='å·®ãªã—ï¼ˆHâ‚€ï¼‰')

ax.set_xlabel('Foldç•ªå·', fontsize=12)
ax.set_ylabel('MAEå·® (RF - CGCNN) [eV/atom]', fontsize=12)
ax.set_title('5-foldäº¤å·®æ¤œè¨¼ã«ãŠã‘ã‚‹MAEå·®ã¨95%ä¿¡é ¼åŒºé–“', fontsize=14, fontweight='bold')
ax.set_xticks(range(1, 6))
ax.legend(fontsize=10)
ax.grid(alpha=0.3)

plt.tight_layout()
plt.savefig('statistical_significance.png', dpi=300, bbox_inches='tight')
plt.show()

# å‡ºåŠ›ä¾‹ï¼š
# === 95%ä¿¡é ¼åŒºé–“ ===
# å¹³å‡å·®:          0.0039 eV/atom
# æ¨™æº–èª¤å·®:        0.0002 eV/atom
# tè‡¨ç•Œå€¤ (df=4): 2.7764
# èª¤å·®ç¯„å›²:        Â±0.0005 eV/atom
# 95%ä¿¡é ¼åŒºé–“:     [0.0034, 0.0044] eV/atom
#
# åˆ¤å®š: ä¿¡é ¼åŒºé–“ãŒ0ã‚’å«ã¾ãªã„ â†’ çµ±è¨ˆçš„ã«æœ‰æ„ãªå·®ã‚ã‚Š
</code></pre>

        <h3>4.3.4 çµ±è¨ˆçš„æ¤œå®šçµæœã®ã¾ã¨ã‚</h3>

        <table>
            <thead>
                <tr>
                    <th>æ¤œå®šæ‰‹æ³•</th>
                    <th>çµæœ</th>
                    <th>è§£é‡ˆ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>å¯¾å¿œã®ã‚ã‚‹tæ¤œå®š</td>
                    <td>t=20.59, p=0.0001</td>
                    <td>p < 0.05 â†’ çµ±è¨ˆçš„ã«æœ‰æ„</td>
                </tr>
                <tr>
                    <td>95%ä¿¡é ¼åŒºé–“</td>
                    <td>[0.0034, 0.0044] eV/atom</td>
                    <td>0ã‚’å«ã¾ãªã„ â†’ çµ±è¨ˆçš„ã«æœ‰æ„</td>
                </tr>
                <tr>
                    <td>åŠ¹æœé‡ï¼ˆCohen's dï¼‰</td>
                    <td>9.19</td>
                    <td>éå¸¸ã«å¤§ãã„åŠ¹æœé‡</td>
                </tr>
                <tr>
                    <td>ç›¸å¯¾çš„æ”¹å–„ç‡</td>
                    <td>12.00%</td>
                    <td>å®Ÿç”¨ä¸Šã®æ„ç¾©ã‚ã‚Š</td>
                </tr>
            </tbody>
        </table>

        <p><strong>çµè«–ï¼š</strong></p>
        <ul>
            <li>CGCNNã¯Random Forestï¼ˆMagpieï¼‰ã«å¯¾ã—ã¦<strong>çµ±è¨ˆçš„ã«æœ‰æ„ãªç²¾åº¦å‘ä¸Š</strong>ã‚’ç¤ºã—ã¾ã—ãŸï¼ˆp=0.0001 << 0.05ï¼‰</li>
            <li>95%ä¿¡é ¼åŒºé–“ [0.0034, 0.0044] eV/atomã¯0ã‚’å«ã¾ãªã„ãŸã‚ã€ç²¾åº¦å·®ã®å­˜åœ¨ã¯çµ±è¨ˆçš„ã«æ”¯æŒã•ã‚Œã¾ã™</li>
            <li>Cohen's d = 9.19ã¨ã„ã†æ¥µã‚ã¦å¤§ãã„åŠ¹æœé‡ã¯ã€CGCNNã®å®Ÿç”¨ä¸Šã®å„ªä½æ€§ã‚’ç¤ºã—ã¦ã„ã¾ã™</li>
            <li>12%ã®ç›¸å¯¾çš„æ”¹å–„ç‡ã¯ã€ææ–™æ¢ç´¢ã®åŠ¹ç‡åŒ–ã«ç›´çµã™ã‚‹å®Ÿå‹™çš„ãªãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™</li>
        </ul>

        <div class="warning-box">
            <strong>âš ï¸ çµ±è¨ˆçš„æœ‰æ„æ€§ vs å®Ÿç”¨çš„æœ‰æ„æ€§</strong>
            <p>çµ±è¨ˆçš„ã«æœ‰æ„ãªå·®ãŒèªã‚ã‚‰ã‚Œã¦ã‚‚ã€ãã®å·®ãŒ<strong>å®Ÿç”¨ä¸Šæ„å‘³ãŒã‚ã‚‹ã‹</strong>ã¯åˆ¥é€”æ¤œè¨ãŒå¿…è¦ã§ã™ã€‚æœ¬ã‚±ãƒ¼ã‚¹ã§ã¯ã€MAEå·®0.0039 eV/atomã¯ææ–™æ¢ç´¢ã«ãŠã„ã¦ååˆ†å®Ÿç”¨çš„ãªæ”¹å–„ã¨åˆ¤æ–­ã§ãã¾ã™ï¼ˆç”Ÿæˆã‚¨ãƒãƒ«ã‚®ãƒ¼äºˆæ¸¬ç²¾åº¦ãŒç´„1 meV/atomå‘ä¸Šï¼‰ã€‚</p>
        </div>

        <h2>4.4 è¨ˆç®—ã‚³ã‚¹ãƒˆã®å®šé‡çš„æ¯”è¼ƒ</h2>

        <p>ç²¾åº¦ã ã‘ã§ãªãã€<strong>è¨ˆç®—ã‚³ã‚¹ãƒˆï¼ˆè¨“ç·´æ™‚é–“ã€æ¨è«–æ™‚é–“ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ï¼‰</strong>ã‚‚ãƒ¢ãƒ‡ãƒ«é¸æŠã®é‡è¦ãªè¦ç´ ã§ã™ã€‚æœ¬ç¯€ã§ã¯ã€Random Forestã¨CGCNNã®è¨ˆç®—ã‚³ã‚¹ãƒˆã‚’å®Ÿæ¸¬ã—ã€å®šé‡çš„ã«æ¯”è¼ƒã—ã¾ã™ã€‚</p>

        <h3>4.4.1 è¨“ç·´æ™‚é–“ã®æ¸¬å®š</h3>

        <div class="highlight-box">
            <strong>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹7ï¼šè¨“ç·´æ™‚é–“ã¨æ¨è«–æ™‚é–“ã®æ¸¬å®š</strong>
        </div>

        <pre><code class="language-python"># è¨“ç·´æ™‚é–“ã¨æ¨è«–æ™‚é–“ã®æ¸¬å®š
import time
import psutil
import os

def measure_training_time_and_memory(model_type='rf'):
    """
    ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´æ™‚é–“ã¨ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’æ¸¬å®š

    Parameters:
    -----------
    model_type : str
        'rf' (Random Forest) or 'cgcnn'

    Returns:
    --------
    results : dict
        è¨“ç·´æ™‚é–“ã€æ¨è«–æ™‚é–“ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
    """
    # ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’å–å¾—
    process = psutil.Process(os.getpid())
    mem_before = process.memory_info().rss / (1024 ** 2)  # MB

    # è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆFold 1ã®ã¿ä½¿ç”¨ï¼‰
    train_inputs, train_outputs = task.get_train_and_val_data(task.folds[0])
    test_inputs, test_outputs = task.get_test_data(task.folds[0], include_target=True)

    if model_type == 'rf':
        # Random Forestã®è¨“ç·´æ™‚é–“æ¸¬å®š
        X_train = extract_magpie_features(train_inputs)
        X_test = extract_magpie_features(test_inputs)
        y_train = train_outputs.values

        # è¨“ç·´é–‹å§‹
        start_train = time.time()
        rf_model = RandomForestRegressor(
            n_estimators=100,
            max_depth=30,
            random_state=42,
            n_jobs=-1
        )
        rf_model.fit(X_train, y_train)
        train_time = time.time() - start_train

        # æ¨è«–æ™‚é–“æ¸¬å®š
        start_infer = time.time()
        _ = rf_model.predict(X_test)
        infer_time = time.time() - start_infer

        mem_after = process.memory_info().rss / (1024 ** 2)
        memory_usage = mem_after - mem_before

    elif model_type == 'cgcnn':
        # CGCNNã®è¨“ç·´æ™‚é–“æ¸¬å®š
        train_data = [structure_to_pyg_data(s, t) for s, t in zip(train_inputs, train_outputs.values)]
        test_data = [structure_to_pyg_data(s, t) for s, t in zip(test_inputs, test_outputs.values)]

        train_loader = DataLoader(train_data, batch_size=32, shuffle=True)
        test_loader = DataLoader(test_data, batch_size=32, shuffle=False)

        model = CGCNNMatbench().to(device)
        optimizer = torch.optim.Adam(model.parameters(), lr=0.001)
        criterion = nn.L1Loss()

        # è¨“ç·´é–‹å§‹
        start_train = time.time()
        model.train()
        for epoch in range(50):
            for batch in train_loader:
                batch = batch.to(device)
                optimizer.zero_grad()
                out = model(batch)
                loss = criterion(out, batch.y)
                loss.backward()
                optimizer.step()
        train_time = time.time() - start_train

        # æ¨è«–æ™‚é–“æ¸¬å®š
        model.eval()
        start_infer = time.time()
        with torch.no_grad():
            for batch in test_loader:
                batch = batch.to(device)
                _ = model(batch)
        infer_time = time.time() - start_infer

        mem_after = process.memory_info().rss / (1024 ** 2)
        memory_usage = mem_after - mem_before

    return {
        'train_time': train_time,
        'infer_time': infer_time,
        'memory_usage': memory_usage
    }

# Random Forestã®è¨ˆç®—ã‚³ã‚¹ãƒˆæ¸¬å®š
print("=== Random Forestè¨ˆç®—ã‚³ã‚¹ãƒˆæ¸¬å®šä¸­... ===")
rf_cost = measure_training_time_and_memory('rf')

print(f"è¨“ç·´æ™‚é–“:   {rf_cost['train_time']:.2f} ç§’")
print(f"æ¨è«–æ™‚é–“:   {rf_cost['infer_time']:.2f} ç§’")
print(f"ãƒ¡ãƒ¢ãƒªä½¿ç”¨: {rf_cost['memory_usage']:.2f} MB")

# CGCNNã®è¨ˆç®—ã‚³ã‚¹ãƒˆæ¸¬å®šï¼ˆGPUä½¿ç”¨æ™‚ï¼‰
print("\n=== CGCNNè¨ˆç®—ã‚³ã‚¹ãƒˆæ¸¬å®šä¸­... ===")
cgcnn_cost = measure_training_time_and_memory('cgcnn')

print(f"è¨“ç·´æ™‚é–“:   {cgcnn_cost['train_time']:.2f} ç§’")
print(f"æ¨è«–æ™‚é–“:   {cgcnn_cost['infer_time']:.2f} ç§’")
print(f"ãƒ¡ãƒ¢ãƒªä½¿ç”¨: {cgcnn_cost['memory_usage']:.2f} MB")

# æ¯”è¼ƒ
print("\n=== è¨ˆç®—ã‚³ã‚¹ãƒˆæ¯”è¼ƒ ===")
print(f"è¨“ç·´æ™‚é–“æ¯” (CGCNN/RF): {cgcnn_cost['train_time'] / rf_cost['train_time']:.2f}x")
print(f"æ¨è«–æ™‚é–“æ¯” (CGCNN/RF): {cgcnn_cost['infer_time'] / rf_cost['infer_time']:.2f}x")
print(f"ãƒ¡ãƒ¢ãƒªæ¯” (CGCNN/RF):   {cgcnn_cost['memory_usage'] / rf_cost['memory_usage']:.2f}x")

# å‡ºåŠ›ä¾‹ï¼š
# === Random Forestè¨ˆç®—ã‚³ã‚¹ãƒˆæ¸¬å®šä¸­... ===
# è¨“ç·´æ™‚é–“:   45.32 ç§’
# æ¨è«–æ™‚é–“:   0.18 ç§’
# ãƒ¡ãƒ¢ãƒªä½¿ç”¨: 1250.45 MB
#
# === CGCNNè¨ˆç®—ã‚³ã‚¹ãƒˆæ¸¬å®šä¸­... ===
# è¨“ç·´æ™‚é–“:   1832.56 ç§’
# æ¨è«–æ™‚é–“:   2.34 ç§’
# ãƒ¡ãƒ¢ãƒªä½¿ç”¨: 3450.23 MB
#
# === è¨ˆç®—ã‚³ã‚¹ãƒˆæ¯”è¼ƒ ===
# è¨“ç·´æ™‚é–“æ¯” (CGCNN/RF): 40.45x
# æ¨è«–æ™‚é–“æ¯” (CGCNN/RF): 13.00x
# ãƒ¡ãƒ¢ãƒªæ¯” (CGCNN/RF):   2.76x
</code></pre>

        <h3>4.4.2 è¨ˆç®—ã‚³ã‚¹ãƒˆã®å¯è¦–åŒ–</h3>

        <div class="highlight-box">
            <strong>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹8ï¼šè¨ˆç®—ã‚³ã‚¹ãƒˆæ¯”è¼ƒã®å¯è¦–åŒ–</strong>
        </div>

        <pre><code class="language-python"># è¨ˆç®—ã‚³ã‚¹ãƒˆæ¯”è¼ƒã®å¯è¦–åŒ–
import matplotlib.pyplot as plt
import numpy as np

# ãƒ‡ãƒ¼ã‚¿æº–å‚™
models = ['RF (Magpie)', 'CGCNN']
train_times = [45.32, 1832.56]
infer_times = [0.18, 2.34]
memory_usage = [1250.45, 3450.23]

fig, axes = plt.subplots(1, 3, figsize=(15, 5))

# è¨“ç·´æ™‚é–“æ¯”è¼ƒï¼ˆå¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
axes[0].bar(models, train_times, color=['#667eea', '#764ba2'])
axes[0].set_ylabel('è¨“ç·´æ™‚é–“ (ç§’)', fontsize=12)
axes[0].set_title('è¨“ç·´æ™‚é–“æ¯”è¼ƒ', fontsize=14, fontweight='bold')
axes[0].set_yscale('log')
for i, v in enumerate(train_times):
    axes[0].text(i, v, f'{v:.1f}s', ha='center', va='bottom', fontsize=10)

# æ¨è«–æ™‚é–“æ¯”è¼ƒï¼ˆå¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
axes[1].bar(models, infer_times, color=['#667eea', '#764ba2'])
axes[1].set_ylabel('æ¨è«–æ™‚é–“ (ç§’)', fontsize=12)
axes[1].set_title('æ¨è«–æ™‚é–“æ¯”è¼ƒ', fontsize=14, fontweight='bold')
axes[1].set_yscale('log')
for i, v in enumerate(infer_times):
    axes[1].text(i, v, f'{v:.2f}s', ha='center', va='bottom', fontsize=10)

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æ¯”è¼ƒ
axes[2].bar(models, memory_usage, color=['#667eea', '#764ba2'])
axes[2].set_ylabel('ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ (MB)', fontsize=12)
axes[2].set_title('ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æ¯”è¼ƒ', fontsize=14, fontweight='bold')
for i, v in enumerate(memory_usage):
    axes[2].text(i, v, f'{v:.1f}MB', ha='center', va='bottom', fontsize=10)

plt.tight_layout()
plt.savefig('computational_cost_comparison.png', dpi=300, bbox_inches='tight')
plt.show()
</code></pre>

        <h3>4.4.3 è¨ˆç®—ã‚³ã‚¹ãƒˆåˆ†æã®ã¾ã¨ã‚</h3>

        <table>
            <thead>
                <tr>
                    <th>æŒ‡æ¨™</th>
                    <th>RF (Magpie)</th>
                    <th>CGCNN</th>
                    <th>å€ç‡</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>è¨“ç·´æ™‚é–“</td>
                    <td>45.3ç§’</td>
                    <td>1,832.6ç§’ (30.5åˆ†)</td>
                    <td>40.5x é…ã„</td>
                </tr>
                <tr>
                    <td>æ¨è«–æ™‚é–“</td>
                    <td>0.18ç§’</td>
                    <td>2.34ç§’</td>
                    <td>13.0x é…ã„</td>
                </tr>
                <tr>
                    <td>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</td>
                    <td>1,250 MB</td>
                    <td>3,450 MB</td>
                    <td>2.8x å¤§ãã„</td>
                </tr>
            </tbody>
        </table>

        <p><strong>è¨ˆç®—ã‚³ã‚¹ãƒˆã®è§£é‡ˆï¼š</strong></p>
        <ul>
            <li><strong>è¨“ç·´æ™‚é–“ï¼š40å€ã®å·®</strong> - CGCNNã¯ç´„30åˆ†ã®è¨“ç·´æ™‚é–“ãŒå¿…è¦ï¼ˆGPUä½¿ç”¨æ™‚ï¼‰ã€‚CPUã®ã¿ã§ã¯ã•ã‚‰ã«10-20å€é…ããªã‚‹å¯èƒ½æ€§ã‚ã‚Š</li>
            <li><strong>æ¨è«–æ™‚é–“ï¼š13å€ã®å·®</strong> - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äºˆæ¸¬ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹å ´åˆã¯RFãŒæœ‰åˆ©</li>
            <li><strong>ãƒ¡ãƒ¢ãƒªï¼š2.8å€ã®å·®</strong> - CGCNNã¯GPUãƒ¡ãƒ¢ãƒªã‚‚è¿½åŠ ã§å¿…è¦ï¼ˆæœ¬ä¾‹ã§ã¯ç´„2GBï¼‰</li>
            <li><strong>ç²¾åº¦ã¨ã‚³ã‚¹ãƒˆã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•</strong> - 12%ã®ç²¾åº¦å‘ä¸Šã®ãŸã‚ã«40å€ã®è¨ˆç®—æ™‚é–“ã‚’è¨±å®¹ã§ãã‚‹ã‹ã¯ã€ç”¨é€”ã«ä¾å­˜</li>
        </ul>

        <h2>4.5 ãƒ‡ãƒ¼ã‚¿è¦æ±‚é‡ã®åˆ†æ</h2>

        <p>æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®å®Ÿç”¨æ€§ã‚’è©•ä¾¡ã™ã‚‹ä¸Šã§ã€<strong>ã©ã®ç¨‹åº¦ã®è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°ãŒå¿…è¦ã‹</strong>ã¯é‡è¦ãªè¦ç´ ã§ã™ã€‚æœ¬ç¯€ã§ã¯ã€<strong>å­¦ç¿’æ›²ç·šï¼ˆLearning Curveï¼‰</strong>ã‚’ç”¨ã„ã¦ã€Random Forestã¨CGCNNã®ãƒ‡ãƒ¼ã‚¿è¦æ±‚é‡ã®é•ã„ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>

        <h3>4.5.1 å­¦ç¿’æ›²ç·šã®æ¦‚å¿µ</h3>

        <p>å­¦ç¿’æ›²ç·šã¯ã€è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°ã‚’å¤‰åŒ–ã•ã›ãŸã¨ãã®<strong>ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ã®å¤‰åŒ–</strong>ã‚’ãƒ—ãƒ­ãƒƒãƒˆã—ãŸã‚°ãƒ©ãƒ•ã§ã™ã€‚ä¸€èˆ¬çš„ã«ã€ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ï¼š</p>

        <ul>
            <li><strong>è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°ãŒå°‘ãªã„é ˜åŸŸ</strong>ï¼šãƒ¢ãƒ‡ãƒ«ã®æ€§èƒ½ã¯è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°ã«å¼·ãä¾å­˜ã—ã€å¢—åŠ ã¨ã¨ã‚‚ã«æ€¥æ¿€ã«å‘ä¸Š</li>
            <li><strong>è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°ãŒååˆ†ãªé ˜åŸŸ</strong>ï¼šæ€§èƒ½ã¯é£½å’Œã—ã€è¿½åŠ ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹æ”¹å–„ã¯å°ã•ããªã‚‹</li>
            <li><strong>ãƒ‡ãƒ¼ã‚¿åŠ¹ç‡ã®é«˜ã„ãƒ¢ãƒ‡ãƒ«</strong>ï¼šå°‘ãªã„ãƒ‡ãƒ¼ã‚¿ã§é«˜ã„æ€§èƒ½ã«åˆ°é”ã—ã€æ›²ç·šãŒæ—©ãé£½å’Œã™ã‚‹</li>
            <li><strong>ãƒ‡ãƒ¼ã‚¿åŠ¹ç‡ã®ä½ã„ãƒ¢ãƒ‡ãƒ«</strong>ï¼šå¤šãã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã€æ›²ç·šã®é£½å’ŒãŒé…ã„</li>
        </ul>

        <h3>4.5.2 å­¦ç¿’æ›²ç·šã®å®Ÿè£…</h3>

        <div class="highlight-box">
            <strong>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹9ï¼šå­¦ç¿’æ›²ç·šã®ç”Ÿæˆã¨å¯è¦–åŒ–</strong>
        </div>

        <pre><code class="language-python"># å­¦ç¿’æ›²ç·šã®ç”Ÿæˆ
import numpy as np
import matplotlib.pyplot as plt
from sklearn.model_selection import learning_curve

# è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆFold 1ã‚’ä½¿ç”¨ï¼‰
train_inputs, train_outputs = task.get_train_and_val_data(task.folds[0])
test_inputs, test_outputs = task.get_test_data(task.folds[0], include_target=True)

# Magpieç‰¹å¾´é‡æŠ½å‡º
X_train = extract_magpie_features(train_inputs)
X_test = extract_magpie_features(test_inputs)
y_train = train_outputs.values
y_test = test_outputs.values

# è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã®è¨­å®šï¼ˆ10%, 20%, ..., 100%ï¼‰
train_sizes = np.linspace(0.1, 1.0, 10)

# Random Forestã®å­¦ç¿’æ›²ç·š
print("=== Random Forestã®å­¦ç¿’æ›²ç·šã‚’è¨ˆç®—ä¸­... ===")
rf_train_scores = []
rf_test_scores = []

for train_size in train_sizes:
    # è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
    n_samples = int(len(X_train) * train_size)
    indices = np.random.choice(len(X_train), n_samples, replace=False)
    X_train_subset = X_train[indices]
    y_train_subset = y_train[indices]

    # ãƒ¢ãƒ‡ãƒ«è¨“ç·´
    rf_model = RandomForestRegressor(
        n_estimators=100,
        max_depth=30,
        random_state=42,
        n_jobs=-1
    )
    rf_model.fit(X_train_subset, y_train_subset)

    # è¨“ç·´èª¤å·®ã¨ãƒ†ã‚¹ãƒˆèª¤å·®ã‚’è¨ˆç®—
    train_mae = mean_absolute_error(y_train_subset, rf_model.predict(X_train_subset))
    test_mae = mean_absolute_error(y_test, rf_model.predict(X_test))

    rf_train_scores.append(train_mae)
    rf_test_scores.append(test_mae)

    print(f"è¨“ç·´ã‚µã‚¤ã‚º: {train_size*100:.0f}% ({n_samples}ã‚µãƒ³ãƒ—ãƒ«) - è¨“ç·´MAE: {train_mae:.4f}, ãƒ†ã‚¹ãƒˆMAE: {test_mae:.4f}")

# CGCNNã®å­¦ç¿’æ›²ç·šï¼ˆç°¡ç•¥ç‰ˆï¼šè¨ˆç®—æ™‚é–“ã®éƒ½åˆä¸Š3ç‚¹ã®ã¿ï¼‰
print("\n=== CGCNNã®å­¦ç¿’æ›²ç·šã‚’è¨ˆç®—ä¸­... ===")
cgcnn_train_sizes = [0.2, 0.5, 1.0]  # 20%, 50%, 100%
cgcnn_train_scores = []
cgcnn_test_scores = []

for train_size in cgcnn_train_sizes:
    n_samples = int(len(train_inputs) * train_size)
    sampled_inputs = train_inputs[:n_samples]
    sampled_outputs = train_outputs.values[:n_samples]

    # ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
    train_data = [structure_to_pyg_data(s, t) for s, t in zip(sampled_inputs, sampled_outputs)]
    test_data = [structure_to_pyg_data(s, t) for s, t in zip(test_inputs, test_outputs.values)]

    train_loader = DataLoader(train_data, batch_size=32, shuffle=True)
    test_loader = DataLoader(test_data, batch_size=32, shuffle=False)

    # CGCNNè¨“ç·´ï¼ˆç°¡ç•¥ç‰ˆï¼š30ã‚¨ãƒãƒƒã‚¯ï¼‰
    model = CGCNNMatbench().to(device)
    optimizer = torch.optim.Adam(model.parameters(), lr=0.001)
    criterion = nn.L1Loss()

    model.train()
    for epoch in range(30):
        for batch in train_loader:
            batch = batch.to(device)
            optimizer.zero_grad()
            out = model(batch)
            loss = criterion(out, batch.y)
            loss.backward()
            optimizer.step()

    # è©•ä¾¡
    model.eval()
    train_preds, train_true = [], []
    test_preds, test_true = [], []

    with torch.no_grad():
        # è¨“ç·´èª¤å·®
        for batch in train_loader:
            batch = batch.to(device)
            out = model(batch)
            train_preds.extend(out.cpu().numpy())
            train_true.extend(batch.y.cpu().numpy())

        # ãƒ†ã‚¹ãƒˆèª¤å·®
        for batch in test_loader:
            batch = batch.to(device)
            out = model(batch)
            test_preds.extend(out.cpu().numpy())
            test_true.extend(batch.y.cpu().numpy())

    train_mae = mean_absolute_error(train_true, train_preds)
    test_mae = mean_absolute_error(test_true, test_preds)

    cgcnn_train_scores.append(train_mae)
    cgcnn_test_scores.append(test_mae)

    print(f"è¨“ç·´ã‚µã‚¤ã‚º: {train_size*100:.0f}% ({n_samples}ã‚µãƒ³ãƒ—ãƒ«) - è¨“ç·´MAE: {train_mae:.4f}, ãƒ†ã‚¹ãƒˆMAE: {test_mae:.4f}")

# å­¦ç¿’æ›²ç·šã®å¯è¦–åŒ–
fig, ax = plt.subplots(figsize=(12, 7))

# Random Forest
ax.plot(train_sizes * len(X_train), rf_test_scores, 'o-', color='#667eea', linewidth=2,
        markersize=8, label='RF (Magpie) - ãƒ†ã‚¹ãƒˆèª¤å·®')
ax.plot(train_sizes * len(X_train), rf_train_scores, 's--', color='#667eea', linewidth=1.5,
        markersize=6, alpha=0.5, label='RF (Magpie) - è¨“ç·´èª¤å·®')

# CGCNN
cgcnn_train_sizes_abs = [s * len(train_inputs) for s in cgcnn_train_sizes]
ax.plot(cgcnn_train_sizes_abs, cgcnn_test_scores, 'o-', color='#764ba2', linewidth=2,
        markersize=8, label='CGCNN - ãƒ†ã‚¹ãƒˆèª¤å·®')
ax.plot(cgcnn_train_sizes_abs, cgcnn_train_scores, 's--', color='#764ba2', linewidth=1.5,
        markersize=6, alpha=0.5, label='CGCNN - è¨“ç·´èª¤å·®')

ax.set_xlabel('è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°', fontsize=12)
ax.set_ylabel('MAE (eV/atom)', fontsize=12)
ax.set_title('å­¦ç¿’æ›²ç·šï¼šè¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°ã¨äºˆæ¸¬ç²¾åº¦ã®é–¢ä¿‚', fontsize=14, fontweight='bold')
ax.legend(fontsize=10)
ax.grid(alpha=0.3)

plt.tight_layout()
plt.savefig('learning_curve.png', dpi=300, bbox_inches='tight')
plt.show()

# å‡ºåŠ›ä¾‹ï¼š
# === Random Forestã®å­¦ç¿’æ›²ç·šã‚’è¨ˆç®—ä¸­... ===
# è¨“ç·´ã‚µã‚¤ã‚º: 10% (10601ã‚µãƒ³ãƒ—ãƒ«) - è¨“ç·´MAE: 0.0089, ãƒ†ã‚¹ãƒˆMAE: 0.0521
# è¨“ç·´ã‚µã‚¤ã‚º: 20% (21202ã‚µãƒ³ãƒ—ãƒ«) - è¨“ç·´MAE: 0.0085, ãƒ†ã‚¹ãƒˆMAE: 0.0428
# ...
# è¨“ç·´ã‚µã‚¤ã‚º: 100% (106012ã‚µãƒ³ãƒ—ãƒ«) - è¨“ç·´MAE: 0.0078, ãƒ†ã‚¹ãƒˆMAE: 0.0325
#
# === CGCNNã®å­¦ç¿’æ›²ç·šã‚’è¨ˆç®—ä¸­... ===
# è¨“ç·´ã‚µã‚¤ã‚º: 20% (21202ã‚µãƒ³ãƒ—ãƒ«) - è¨“ç·´MAE: 0.0234, ãƒ†ã‚¹ãƒˆMAE: 0.0389
# è¨“ç·´ã‚µã‚¤ã‚º: 50% (53006ã‚µãƒ³ãƒ—ãƒ«) - è¨“ç·´MAE: 0.0198, ãƒ†ã‚¹ãƒˆMAE: 0.0312
# è¨“ç·´ã‚µã‚¤ã‚º: 100% (106012ã‚µãƒ³ãƒ—ãƒ«) - è¨“ç·´MAE: 0.0176, ãƒ†ã‚¹ãƒˆMAE: 0.0286
</code></pre>

        <h3>4.5.3 ãƒ‡ãƒ¼ã‚¿è¦æ±‚é‡ã®è§£é‡ˆ</h3>

        <p><strong>å­¦ç¿’æ›²ç·šã‹ã‚‰èª­ã¿å–ã‚Œã‚‹çŸ¥è¦‹ï¼š</strong></p>

        <ul>
            <li><strong>å°è¦æ¨¡ãƒ‡ãƒ¼ã‚¿é ˜åŸŸï¼ˆ<20%ï¼‰</strong>ï¼šRandom ForestãŒå„ªä½ã€‚CGCNNã¯è¨“ç·´ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã«ã‚ˆã‚Šæ€§èƒ½ãŒä½ã„</li>
            <li><strong>ä¸­è¦æ¨¡ãƒ‡ãƒ¼ã‚¿é ˜åŸŸï¼ˆ20-50%ï¼‰</strong>ï¼šCGCNNã®æ€§èƒ½ãŒæ€¥é€Ÿã«å‘ä¸Šã—ã€RFã«æ¥è¿‘</li>
            <li><strong>å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿é ˜åŸŸï¼ˆ>50%ï¼‰</strong>ï¼šCGCNNãŒRFã‚’ä¸Šå›ã‚Šã€ãƒ‡ãƒ¼ã‚¿æ•°å¢—åŠ ã¨ã¨ã‚‚ã«å·®ãŒæ‹¡å¤§</li>
            <li><strong>ãƒ‡ãƒ¼ã‚¿åŠ¹ç‡</strong>ï¼šRFã¯ç´„20%ã®ãƒ‡ãƒ¼ã‚¿ã§æ€§èƒ½ãŒé£½å’Œã™ã‚‹ã®ã«å¯¾ã—ã€CGCNNã¯100%ã®ãƒ‡ãƒ¼ã‚¿ã§ã‚‚å‘ä¸Šå‚¾å‘ã‚’ç¶­æŒ</li>
        </ul>

        <p><strong>å®Ÿå‹™ä¸Šã®æ„å‘³</strong>ï¼š</p>
        <ul>
            <li><strong>ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å ´åˆï¼ˆ<10,000ã‚µãƒ³ãƒ—ãƒ«ï¼‰</strong>ï¼šRandom Forestï¼ˆMagpieï¼‰ãŒæ¨å¥¨</li>
            <li><strong>ãƒ‡ãƒ¼ã‚¿ãŒååˆ†ãªå ´åˆï¼ˆ>50,000ã‚µãƒ³ãƒ—ãƒ«ï¼‰</strong>ï¼šCGCNNãŒé«˜ç²¾åº¦ã‚’å®Ÿç¾</li>
            <li><strong>ãƒ‡ãƒ¼ã‚¿åé›†ã‚³ã‚¹ãƒˆãŒé«˜ã„å ´åˆ</strong>ï¼šåˆæœŸæ®µéšã§ã¯RFã€ãƒ‡ãƒ¼ã‚¿è“„ç©å¾Œã«CGCNNã¸ç§»è¡Œã™ã‚‹ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æˆ¦ç•¥ãŒæœ‰åŠ¹</li>
        </ul>

        <h2>4.6 è§£é‡ˆå¯èƒ½æ€§ã®æ¯”è¼ƒ</h2>

        <p>æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®<strong>è§£é‡ˆå¯èƒ½æ€§ï¼ˆInterpretabilityï¼‰</strong>ã¯ã€äºˆæ¸¬æ ¹æ‹ ã®ç†è§£ã¨ä¿¡é ¼æ€§å‘ä¸Šã«ä¸å¯æ¬ ã§ã™ã€‚æœ¬ç¯€ã§ã¯ã€Random Forestï¼ˆMagpieï¼‰ã«å¯¾ã™ã‚‹<strong>SHAPå€¤</strong>ã¨ã€CGCNNã«å¯¾ã™ã‚‹<strong>Attentionæ©Ÿæ§‹</strong>ã‚’ç”¨ã„ã¦ã€ä¸¡æ‰‹æ³•ã®è§£é‡ˆå¯èƒ½æ€§ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚</p>

        <h3>4.6.1 SHAPå€¤ã«ã‚ˆã‚‹çµ„æˆãƒ™ãƒ¼ã‚¹ç‰¹å¾´é‡ã®è§£é‡ˆ</h3>

        <p>SHAPï¼ˆSHapley Additive exPlanationsï¼‰ã¯ã€<strong>å„ç‰¹å¾´é‡ã®äºˆæ¸¬ã¸ã®å¯„ä¸åº¦</strong>ã‚’å®šé‡åŒ–ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚Shapleyå€¤ã®ç†è«–ã«åŸºã¥ãã€å…¬å¹³ãªå¯„ä¸åº¦åˆ†é…ã‚’å®Ÿç¾ã—ã¾ã™ã€‚</p>

        <div class="highlight-box">
            <strong>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹10ï¼šSHAPå€¤ã«ã‚ˆã‚‹ç‰¹å¾´é‡é‡è¦åº¦åˆ†æ</strong>
        </div>

        <pre><code class="language-python"># SHAPå€¤ã«ã‚ˆã‚‹ç‰¹å¾´é‡é‡è¦åº¦åˆ†æ
import shap

# Random Forestãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ï¼ˆæ—¢ã«è¨“ç·´æ¸ˆã¿ã®rf_modelã‚’ä½¿ç”¨ï¼‰
# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆè¨ˆç®—æ™‚é–“å‰Šæ¸›ã®ãŸã‚ï¼‰
X_test_sample = X_test[:100]
y_test_sample = y_test[:100]

# SHAPå€¤ã‚’è¨ˆç®—
print("=== SHAPå€¤ã‚’è¨ˆç®—ä¸­... ===")
explainer = shap.TreeExplainer(rf_model)
shap_values = explainer.shap_values(X_test_sample)

# SHAPå€¤ã®ã‚µãƒãƒªãƒ¼ãƒ—ãƒ­ãƒƒãƒˆ
shap.summary_plot(shap_values, X_test_sample,
                  feature_names=[f'Magpie_{i}' for i in range(145)],
                  max_display=20, show=False)
plt.title('SHAPå€¤ã«ã‚ˆã‚‹ç‰¹å¾´é‡é‡è¦åº¦ï¼ˆRandom Forest + Magpieï¼‰', fontsize=14, fontweight='bold')
plt.tight_layout()
plt.savefig('shap_summary.png', dpi=300, bbox_inches='tight')
plt.show()

# ç‰¹å®šã®ã‚µãƒ³ãƒ—ãƒ«ã®äºˆæ¸¬è§£é‡ˆ
sample_idx = 0
print(f"\n=== ã‚µãƒ³ãƒ—ãƒ«{sample_idx}ã®äºˆæ¸¬è§£é‡ˆ ===")
print(f"çœŸã®å€¤: {y_test_sample[sample_idx]:.4f} eV/atom")
print(f"äºˆæ¸¬å€¤: {rf_model.predict(X_test_sample[sample_idx:sample_idx+1])[0]:.4f} eV/atom")

# SHAP Force Plotï¼ˆå€‹åˆ¥ã‚µãƒ³ãƒ—ãƒ«ã®è§£é‡ˆï¼‰
shap.force_plot(explainer.expected_value,
                shap_values[sample_idx],
                X_test_sample[sample_idx],
                feature_names=[f'Magpie_{i}' for i in range(145)],
                matplotlib=True, show=False)
plt.savefig('shap_force_plot.png', dpi=300, bbox_inches='tight')
plt.show()

# ä¸Šä½10å€‹ã®é‡è¦ç‰¹å¾´é‡ã‚’è¡¨ç¤º
feature_importance = np.abs(shap_values).mean(axis=0)
top_features = np.argsort(feature_importance)[-10:][::-1]

print("\n=== ä¸Šä½10å€‹ã®é‡è¦ç‰¹å¾´é‡ ===")
for i, feat_idx in enumerate(top_features):
    print(f"{i+1}. Magpie_{feat_idx}: SHAPé‡è¦åº¦ = {feature_importance[feat_idx]:.4f}")

# å‡ºåŠ›ä¾‹ï¼š
# === ä¸Šä½10å€‹ã®é‡è¦ç‰¹å¾´é‡ ===
# 1. Magpie_34: SHAPé‡è¦åº¦ = 0.0087  # å¹³å‡é›»æ°—é™°æ€§åº¦
# 2. Magpie_12: SHAPé‡è¦åº¦ = 0.0065  # å¹³å‡åŸå­åŠå¾„
# 3. Magpie_78: SHAPé‡è¦åº¦ = 0.0054  # ä¾¡é›»å­æ•°ã®æ¨™æº–åå·®
# ...
</code></pre>

        <h3>4.6.2 Attentionæ©Ÿæ§‹ã«ã‚ˆã‚‹GNNã®è§£é‡ˆ</h3>

        <p>CGCNNã§ã¯ã€<strong>Attentionæ©Ÿæ§‹</strong>ã‚’ç”¨ã„ã¦ã€äºˆæ¸¬ã«é‡è¦ãª<strong>åŸå­-åŸå­ç›¸äº’ä½œç”¨</strong>ã‚’å¯è¦–åŒ–ã§ãã¾ã™ï¼ˆæ­£ç¢ºã«ã¯CGCNNã¯æ¨™æº–çš„ã«ã¯Attentionã‚’æŒãŸãªã„ãŸã‚ã€GATç­‰ã®Attention-based GNNã¨ã®æ¯”è¼ƒãŒé©åˆ‡ã§ã™ãŒã€ã“ã“ã§ã¯æ•™è‚²ç›®çš„ã§CGCNNã®ç•³ã¿è¾¼ã¿é‡ã¿ã‚’å¯è¦–åŒ–ã—ã¾ã™ï¼‰ã€‚</p>

        <div class="warning-box">
            <strong>âš ï¸ æ³¨æ„ï¼šCGCNNã®è§£é‡ˆå¯èƒ½æ€§ã®é™ç•Œ</strong>
            <p>æ¨™æº–çš„ãªCGCNNã¯Attentionæ©Ÿæ§‹ã‚’æŒãŸãªã„ãŸã‚ã€è§£é‡ˆå¯èƒ½æ€§ã¯é™å®šçš„ã§ã™ã€‚æœ¬ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã¯<strong>ç•³ã¿è¾¼ã¿å±¤ã®æ´»æ€§åŒ–ã‚’å¯è¦–åŒ–</strong>ã—ã¾ã™ãŒã€ã‚ˆã‚Šé«˜åº¦ãªè§£é‡ˆã«ã¯GATï¼ˆGraph Attention Networksï¼‰ã‚„Explainable AIæ‰‹æ³•ï¼ˆGNNExplainerç­‰ï¼‰ã®ä½¿ç”¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <pre><code class="language-python"># CGCNNã®æ´»æ€§åŒ–å¯è¦–åŒ–ï¼ˆç°¡æ˜“ç‰ˆï¼‰
import torch
import matplotlib.pyplot as plt
from pymatgen.core import Structure

# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰1ã‚µãƒ³ãƒ—ãƒ«æŠ½å‡º
sample_structure = test_inputs[0]
sample_target = test_outputs.values[0]

# PyTorch Geometricãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
sample_data = structure_to_pyg_data(sample_structure, sample_target).to(device)

# CGCNNã§äºˆæ¸¬ï¼ˆä¸­é–“å±¤ã®æ´»æ€§åŒ–ã‚’å–å¾—ï¼‰
model.eval()
with torch.no_grad():
    # ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ã®åˆæœŸåŒ–
    x = sample_data.x
    x = model.atom_embedding(x)

    # å„ç•³ã¿è¾¼ã¿å±¤ã®æ´»æ€§åŒ–ã‚’è¨˜éŒ²
    activations = []
    for conv, bn in zip(model.conv_layers, model.bn_layers):
        x = conv(x, sample_data.edge_index, sample_data.edge_attr)
        x = bn(x)
        x = model.activation(x)
        activations.append(x.cpu().numpy())

    # æœ€çµ‚äºˆæ¸¬
    x = global_mean_pool(x.unsqueeze(0), torch.zeros(x.size(0), dtype=torch.long))
    prediction = model.fc2(model.activation(model.fc1(x))).item()

print(f"=== CGCNNã®äºˆæ¸¬è§£é‡ˆ ===")
print(f"çœŸã®å€¤: {sample_target:.4f} eV/atom")
print(f"äºˆæ¸¬å€¤: {prediction:.4f} eV/atom")

# å„åŸå­ã®æ´»æ€§åŒ–ã‚’å¯è¦–åŒ–
fig, axes = plt.subplots(1, 3, figsize=(15, 5))

for layer_idx, activation in enumerate(activations):
    # å„åŸå­ã®æ´»æ€§åŒ–ã®å¹³å‡å€¤ã‚’è¨ˆç®—
    atom_importance = activation.mean(axis=1)

    # åŸå­ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
    atom_types = [site.specie.symbol for site in sample_structure]

    # åŸå­ã”ã¨ã®é‡è¦åº¦ã‚’ãƒ—ãƒ­ãƒƒãƒˆ
    axes[layer_idx].bar(range(len(atom_types)), atom_importance)
    axes[layer_idx].set_xlabel('åŸå­ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹', fontsize=12)
    axes[layer_idx].set_ylabel('æ´»æ€§åŒ–ã®å¹³å‡å€¤', fontsize=12)
    axes[layer_idx].set_title(f'ç¬¬{layer_idx+1}ç•³ã¿è¾¼ã¿å±¤', fontsize=12, fontweight='bold')
    axes[layer_idx].set_xticks(range(len(atom_types)))
    axes[layer_idx].set_xticklabels(atom_types, rotation=45)

plt.tight_layout()
plt.savefig('cgcnn_activation.png', dpi=300, bbox_inches='tight')
plt.show()

print("\nå„åŸå­ã®é‡è¦åº¦ï¼ˆç¬¬3å±¤ã®æ´»æ€§åŒ–ï¼‰:")
for i, (atom_type, importance) in enumerate(zip(atom_types, activations[-1].mean(axis=1))):
    print(f"{i+1}. {atom_type}: {importance:.4f}")
</code></pre>

        <h3>4.6.3 è§£é‡ˆå¯èƒ½æ€§ã®æ¯”è¼ƒã¾ã¨ã‚</h3>

        <table>
            <thead>
                <tr>
                    <th>è¦³ç‚¹</th>
                    <th>Random Forestï¼ˆSHAPï¼‰</th>
                    <th>CGCNNï¼ˆæ´»æ€§åŒ–å¯è¦–åŒ–ï¼‰</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>è§£é‡ˆå¯¾è±¡</td>
                    <td>ç‰¹å¾´é‡ã®é‡è¦åº¦ï¼ˆ145æ¬¡å…ƒMagpieï¼‰</td>
                    <td>åŸå­ãƒ»çµåˆã®é‡è¦åº¦</td>
                </tr>
                <tr>
                    <td>è§£é‡ˆã®ç²’åº¦</td>
                    <td>çµ„æˆãƒ¬ãƒ™ãƒ«ï¼ˆé›»æ°—é™°æ€§åº¦ã€åŸå­åŠå¾„ç­‰ï¼‰</td>
                    <td>æ§‹é€ ãƒ¬ãƒ™ãƒ«ï¼ˆç‰¹å®šã®åŸå­ãƒ»çµåˆï¼‰</td>
                </tr>
                <tr>
                    <td>ç†è«–çš„åŸºç›¤</td>
                    <td>Shapleyå€¤ï¼ˆã‚²ãƒ¼ãƒ ç†è«–ï¼‰</td>
                    <td>ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆæ´»æ€§åŒ–</td>
                </tr>
                <tr>
                    <td>è¨ˆç®—ã‚³ã‚¹ãƒˆ</td>
                    <td>ä¸­ç¨‹åº¦ï¼ˆTreeExplainerã¯é«˜é€Ÿï¼‰</td>
                    <td>ä½ã„ï¼ˆForward passã®ã¿ï¼‰</td>
                </tr>
                <tr>
                    <td>è§£é‡ˆã®ç›´æ„Ÿæ€§</td>
                    <td>é«˜ã„ï¼ˆç‰¹å¾´é‡åãŒæ„å‘³ã‚’æŒã¤ï¼‰</td>
                    <td>ä¸­ç¨‹åº¦ï¼ˆå°‚é–€çŸ¥è­˜ãŒå¿…è¦ï¼‰</td>
                </tr>
            </tbody>
        </table>

        <p><strong>å®Ÿå‹™ä¸Šã®é¸æŠï¼š</strong></p>
        <ul>
            <li><strong>çµ„æˆãƒ¬ãƒ™ãƒ«ã®çŸ¥è¦‹ãŒå¿…è¦</strong>ï¼ˆä¾‹ï¼šã©ã®å…ƒç´ ãŒé‡è¦ã‹ï¼‰ â†’ Random Forest + SHAP</li>
            <li><strong>æ§‹é€ ãƒ¬ãƒ™ãƒ«ã®çŸ¥è¦‹ãŒå¿…è¦</strong>ï¼ˆä¾‹ï¼šã©ã®åŸå­é–“ç›¸äº’ä½œç”¨ãŒé‡è¦ã‹ï¼‰ â†’ CGCNN + GAT/GNNExplainer</li>
            <li><strong>ãƒ‰ãƒ¡ã‚¤ãƒ³å°‚é–€å®¶ã¸ã®èª¬æ˜</strong> â†’ SHAPå€¤ã®æ–¹ãŒç›´æ„Ÿçš„</li>
            <li><strong>ç ”ç©¶ç›®çš„ã®è©³ç´°åˆ†æ</strong> â†’ GNN Attentionæ©Ÿæ§‹ãŒæœ‰ç”¨</li>
        </ul>

        <h2>4.7 æ‰‹æ³•é¸æŠã®æ„æ€æ±ºå®šãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ</h2>

        <p>æœ¬ç« ã®å®šé‡çš„æ¯”è¼ƒçµæœã‚’çµ±åˆã—ã€<strong>å®Ÿå‹™ä¸Šã®æ‰‹æ³•é¸æŠã‚’æ”¯æ´ã™ã‚‹æ„æ€æ±ºå®šãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ</strong>ã‚’Mermaidã§æ§‹ç¯‰ã—ã¾ã™ã€‚</p>

        <div class="mermaid">
graph TD
    A[ææ–™ç‰©æ€§äºˆæ¸¬ã‚¿ã‚¹ã‚¯] --> B{è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°ã¯?}
    B -->|<10,000| C[Random Forest + Magpie]
    B -->|10,000-50,000| D{è¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ã¯?}
    B -->|>50,000| E{ç²¾åº¦å„ªå…ˆã‹é€Ÿåº¦å„ªå…ˆã‹?}

    D -->|GPUåˆ©ç”¨å¯| F[CGCNNæ¨å¥¨<br/>ç²¾åº¦ã¨ãƒ‡ãƒ¼ã‚¿åŠ¹ç‡ã®ãƒãƒ©ãƒ³ã‚¹]
    D -->|CPUã®ã¿| C

    E -->|ç²¾åº¦å„ªå…ˆ| G[CGCNNæ¨å¥¨<br/>MAE 12%æ”¹å–„]
    E -->|é€Ÿåº¦å„ªå…ˆ| H{ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äºˆæ¸¬ãŒå¿…è¦?}

    H -->|ã¯ã„| C
    H -->|ã„ã„ãˆ| F

    C --> I{è§£é‡ˆå¯èƒ½æ€§ã¯å¿…é ˆ?}
    F --> J{çµ±è¨ˆçš„æœ‰æ„æ€§ã‚’ç¢ºèªã—ãŸã‹?}
    G --> J

    I -->|ã¯ã„| K[SHAPå€¤ã§ç‰¹å¾´é‡é‡è¦åº¦åˆ†æ<br/>ãƒ‰ãƒ¡ã‚¤ãƒ³å°‚é–€å®¶ã«æç¤º]
    I -->|ã„ã„ãˆ| L[Random Forestæ¡ç”¨æ±ºå®š]

    J -->|ã¯ã„ãƒ»p<0.05| M{è¨ˆç®—ã‚³ã‚¹ãƒˆè¨±å®¹å¯èƒ½?}
    J -->|ã¾ã | N[tæ¤œå®šã¨95%ä¿¡é ¼åŒºé–“ã‚’å®Ÿæ–½]

    M -->|è¨“ç·´æ™‚é–“40xè¨±å®¹| O[CGCNNæ¡ç”¨æ±ºå®š]
    M -->|è¨±å®¹ä¸å¯| P[ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ¤œè¨<br/>åˆæœŸRFã‹ã‚‰CGCNNã¸ç§»è¡Œ]

    N --> J

    K --> L
    O --> Q[æœ¬ç•ªç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤]
    L --> Q
    P --> Q

    style A fill:#667eea,color:#fff
    style C fill:#4caf50,color:#fff
    style F fill:#ff9800,color:#fff
    style G fill:#764ba2,color:#fff
    style O fill:#764ba2,color:#fff
    style L fill:#4caf50,color:#fff
    style Q fill:#2196f3,color:#fff
        </div>

        <h3>4.7.1 æ„æ€æ±ºå®šãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®ä½¿ç”¨ã‚¬ã‚¤ãƒ‰</h3>

        <p><strong>å„æ±ºå®šãƒã‚¤ãƒ³ãƒˆã®è©³ç´°ï¼š</strong></p>

        <ol>
            <li><strong>è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°ã®è©•ä¾¡</strong>
                <ul>
                    <li><10,000ã‚µãƒ³ãƒ—ãƒ«ï¼šRandom ForestãŒå®‰å®šã—ã¦é«˜æ€§èƒ½ï¼ˆå­¦ç¿’æ›²ç·šã®çŸ¥è¦‹ï¼‰</li>
                    <li>10,000-50,000ã‚µãƒ³ãƒ—ãƒ«ï¼šè¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ã«å¿œã˜ã¦é¸æŠ</li>
                    <li>>50,000ã‚µãƒ³ãƒ—ãƒ«ï¼šCGCNNã®å„ªä½æ€§ãŒé¡•è‘—</li>
                </ul>
            </li>
            <li><strong>è¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ã®ç¢ºèª</strong>
                <ul>
                    <li>GPUåˆ©ç”¨å¯ï¼šCGCNNè¨“ç·´æ™‚é–“ãŒ30åˆ†ç¨‹åº¦ã«çŸ­ç¸®</li>
                    <li>CPUã®ã¿ï¼šCGCNNè¨“ç·´æ™‚é–“ãŒ5-10æ™‚é–“ã‹ã‹ã‚‹å¯èƒ½æ€§</li>
                </ul>
            </li>
            <li><strong>ç²¾åº¦ vs é€Ÿåº¦ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•</strong>
                <ul>
                    <li>MAE 12%æ”¹å–„ã®ä¾¡å€¤ vs è¨“ç·´æ™‚é–“40å€ã®ã‚³ã‚¹ãƒˆã‚’è©•ä¾¡</li>
                    <li>æ¨è«–é€Ÿåº¦13å€ã®å·®ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äºˆæ¸¬ã«å½±éŸ¿ã™ã‚‹ã‹ã‚’ç¢ºèª</li>
                </ul>
            </li>
            <li><strong>çµ±è¨ˆçš„æœ‰æ„æ€§ã®æ¤œè¨¼</strong>
                <ul>
                    <li>5-foldäº¤å·®æ¤œè¨¼ã§å¯¾å¿œã®ã‚ã‚‹tæ¤œå®šã‚’å®Ÿæ–½</li>
                    <li>på€¤<0.05ã‹ã¤95%ä¿¡é ¼åŒºé–“ãŒ0ã‚’å«ã¾ãªã„ã“ã¨ã‚’ç¢ºèª</li>
                </ul>
            </li>
            <li><strong>è§£é‡ˆå¯èƒ½æ€§ã®è¦æ±‚</strong>
                <ul>
                    <li>SHAPå€¤ï¼šçµ„æˆãƒ¬ãƒ™ãƒ«ã®çŸ¥è¦‹ï¼ˆã©ã®å…ƒç´ ç‰¹æ€§ãŒé‡è¦ã‹ï¼‰</li>
                    <li>Attention/GNNExplainerï¼šæ§‹é€ ãƒ¬ãƒ™ãƒ«ã®çŸ¥è¦‹ï¼ˆã©ã®åŸå­é–“ç›¸äº’ä½œç”¨ãŒé‡è¦ã‹ï¼‰</li>
                </ul>
            </li>
        </ol>

        <h2>4.8 æœ¬ç« ã®ã¾ã¨ã‚</h2>

        <p>æœ¬ç« ã§ã¯ã€Random Forestï¼ˆMagpieï¼‰ã¨CGCNNã‚’ã€Matbenchãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’ç”¨ã„ã¦<strong>7ã¤ã®è¦³ç‚¹ã‹ã‚‰å®šé‡çš„ã«æ¯”è¼ƒ</strong>ã—ã¾ã—ãŸã€‚</p>

        <h3>ä¸»è¦ãªçŸ¥è¦‹</h3>

        <table>
            <thead>
                <tr>
                    <th>è©•ä¾¡è¦³ç‚¹</th>
                    <th>çµæœ</th>
                    <th>æ¨å¥¨æ¡ä»¶</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>äºˆæ¸¬ç²¾åº¦</td>
                    <td>CGCNN: MAE 12%æ”¹å–„</td>
                    <td>é«˜ç²¾åº¦ãŒå¿…é ˆã®å ´åˆ</td>
                </tr>
                <tr>
                    <td>çµ±è¨ˆçš„æœ‰æ„æ€§</td>
                    <td>p=0.0001 << 0.05 (æœ‰æ„)</td>
                    <td>ç§‘å­¦çš„æ ¹æ‹ ãŒå¿…è¦ãªå ´åˆ</td>
                </tr>
                <tr>
                    <td>è¨“ç·´æ™‚é–“</td>
                    <td>CGCNN: 40å€é…ã„</td>
                    <td>é«˜é€Ÿãªé–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ãŒå¿…è¦ãªã‚‰RF</td>
                </tr>
                <tr>
                    <td>æ¨è«–æ™‚é–“</td>
                    <td>CGCNN: 13å€é…ã„</td>
                    <td>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äºˆæ¸¬ãŒå¿…è¦ãªã‚‰RF</td>
                </tr>
                <tr>
                    <td>ãƒ‡ãƒ¼ã‚¿è¦æ±‚é‡</td>
                    <td>RF: å°‘ãƒ‡ãƒ¼ã‚¿ã§é£½å’Œã€CGCNN: å¤šãƒ‡ãƒ¼ã‚¿ã§å‘ä¸Š</td>
                    <td>>50,000ã‚µãƒ³ãƒ—ãƒ«ãªã‚‰CGCNN</td>
                </tr>
                <tr>
                    <td>è§£é‡ˆå¯èƒ½æ€§</td>
                    <td>RF+SHAP: çµ„æˆãƒ¬ãƒ™ãƒ«ã€CGCNN: æ§‹é€ ãƒ¬ãƒ™ãƒ«</td>
                    <td>è¦æ±‚ã•ã‚Œã‚‹çŸ¥è¦‹ã®ç²’åº¦ã«ã‚ˆã‚‹</td>
                </tr>
                <tr>
                    <td>å®Ÿè£…å®¹æ˜“æ€§</td>
                    <td>RF: å®¹æ˜“ã€CGCNN: è¤‡é›‘</td>
                    <td>è¿…é€Ÿãªãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãªã‚‰RF</td>
                </tr>
            </tbody>
        </table>

        <h3>å®Ÿå‹™ä¸Šã®æ¨å¥¨</h3>

        <div class="highlight-box">
            <strong>ğŸ¯ æ‰‹æ³•é¸æŠã®æ¨å¥¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯</strong>
            <ul>
                <li><strong>æ¢ç´¢çš„åˆ†ææ®µéš</strong>ï¼šRandom Forestï¼ˆMagpieï¼‰ã§è¿…é€Ÿã«ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ§‹ç¯‰</li>
                <li><strong>ç²¾åº¦å‘ä¸Šæ®µéš</strong>ï¼šãƒ‡ãƒ¼ã‚¿ãŒååˆ†ï¼ˆ>50,000ï¼‰ã‹ã¤GPUåˆ©ç”¨å¯èƒ½ãªã‚‰CGCNNå°å…¥</li>
                <li><strong>æœ¬ç•ªé‹ç”¨æ®µéš</strong>ï¼šæ¨è«–é€Ÿåº¦ã¨ç²¾åº¦ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’è©•ä¾¡ã—ã€æœ€çµ‚æ±ºå®š</li>
                <li><strong>ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æˆ¦ç•¥</strong>ï¼šåˆæœŸæ®µéšã§RFã€ãƒ‡ãƒ¼ã‚¿è“„ç©å¾Œã«CGCNNã¸æ®µéšçš„ç§»è¡Œ</li>
            </ul>
        </div>

        <h2>æ¼”ç¿’å•é¡Œ</h2>

        <div class="exercise">
            <div class="exercise-header">æ¼”ç¿’1ï¼šMatbenchã‚¿ã‚¹ã‚¯ã®ç†è§£ <span class="difficulty difficulty-easy">Easy</span></div>
            <p><strong>å•é¡Œï¼š</strong>Matbenchãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®<code>matbench_mp_gap</code>ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®è³ªå•ã«ç­”ãˆã‚ˆã€‚</p>
            <ol>
                <li>äºˆæ¸¬å¯¾è±¡ã®ç‰©æ€§ã¯ä½•ã‹ï¼Ÿ</li>
                <li>ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã‚µã‚¤ã‚ºã¯ï¼Ÿ</li>
                <li>è©•ä¾¡æŒ‡æ¨™ã¯ä½•ã‹ï¼Ÿ</li>
            </ol>
            <p><strong>è§£ç­”ï¼š</strong></p>
            <ol>
                <li>ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—ï¼ˆeVï¼‰</li>
                <li>106,113ã‚µãƒ³ãƒ—ãƒ«</li>
                <li>MAEï¼ˆMean Absolute Errorï¼‰</li>
            </ol>
        </div>

        <div class="exercise">
            <div class="exercise-header">æ¼”ç¿’2ï¼štæ¤œå®šã®è§£é‡ˆ <span class="difficulty difficulty-easy">Easy</span></div>
            <p><strong>å•é¡Œï¼š</strong>5-foldäº¤å·®æ¤œè¨¼ã§å¾—ã‚‰ã‚ŒãŸ2ã¤ã®ãƒ¢ãƒ‡ãƒ«ã®MAEãŒä»¥ä¸‹ã®é€šã‚Šã ã£ãŸã€‚å¯¾å¿œã®ã‚ã‚‹tæ¤œå®šã‚’å®Ÿæ–½ã—ã€på€¤ãŒ0.03ã ã£ãŸå ´åˆã€æœ‰æ„æ°´æº–Î±=0.05ã§çµ±è¨ˆçš„ã«æœ‰æ„ãªå·®ãŒã‚ã‚‹ã¨è¨€ãˆã‚‹ã‹ï¼Ÿ</p>
            <p>ãƒ¢ãƒ‡ãƒ«A: [0.035, 0.038, 0.033, 0.036, 0.034]<br>
            ãƒ¢ãƒ‡ãƒ«B: [0.032, 0.035, 0.030, 0.033, 0.031]</p>
            <p><strong>è§£ç­”ï¼š</strong></p>
            <p>ã¯ã„ã€çµ±è¨ˆçš„ã«æœ‰æ„ãªå·®ãŒã‚ã‚Šã¾ã™ã€‚på€¤ï¼ˆ0.03ï¼‰< Î±ï¼ˆ0.05ï¼‰ã§ã‚ã‚‹ãŸã‚ã€å¸°ç„¡ä»®èª¬ã€Œ2ã¤ã®ãƒ¢ãƒ‡ãƒ«ã®å¹³å‡MAEå·®ã¯ã‚¼ãƒ­ã€ã‚’æ£„å´ã§ãã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ¢ãƒ‡ãƒ«Bã¯ãƒ¢ãƒ‡ãƒ«Aã«å¯¾ã—ã¦çµ±è¨ˆçš„ã«æœ‰æ„ãªç²¾åº¦å‘ä¸Šã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
        </div>

        <div class="exercise">
            <div class="exercise-header">æ¼”ç¿’3ï¼š95%ä¿¡é ¼åŒºé–“ã®è¨ˆç®— <span class="difficulty difficulty-medium">Medium</span></div>
            <p><strong>å•é¡Œï¼š</strong>5ã¤ã®foldã§MAEå·®ï¼ˆModelA - ModelBï¼‰ãŒ [0.003, 0.004, 0.003, 0.005, 0.004] eV/atomã ã£ãŸã€‚ã“ã®MAEå·®ã®95%ä¿¡é ¼åŒºé–“ã‚’è¨ˆç®—ã›ã‚ˆï¼ˆtåˆ†å¸ƒã®è‡¨ç•Œå€¤ã¯2.776ã¨ã™ã‚‹ï¼‰ã€‚</p>
            <p><strong>ãƒ’ãƒ³ãƒˆï¼š</strong>æ¨™æº–èª¤å·® SE = std(å·®) / sqrt(n)</p>
            <p><strong>è§£ç­”ï¼š</strong></p>
            <pre><code class="language-python">import numpy as np
from scipy import stats

mae_diff = np.array([0.003, 0.004, 0.003, 0.005, 0.004])
mean_diff = mae_diff.mean()  # 0.00380
std_diff = mae_diff.std(ddof=1)  # 0.00084
se_diff = std_diff / np.sqrt(len(mae_diff))  # 0.00037
t_critical = 2.776

margin_error = t_critical * se_diff  # 0.00104
ci_lower = mean_diff - margin_error  # 0.00276
ci_upper = mean_diff + margin_error  # 0.00484

print(f"95%ä¿¡é ¼åŒºé–“: [{ci_lower:.5f}, {ci_upper:.5f}] eV/atom")
# å‡ºåŠ›: 95%ä¿¡é ¼åŒºé–“: [0.00276, 0.00484] eV/atom
</code></pre>
            <p>95%ä¿¡é ¼åŒºé–“ã¯ [0.00276, 0.00484] eV/atomã§ã™ã€‚ã“ã®åŒºé–“ãŒ0ã‚’å«ã¾ãªã„ãŸã‚ã€ç²¾åº¦å·®ã¯çµ±è¨ˆçš„ã«æœ‰æ„ã§ã™ã€‚</p>
        </div>

        <div class="exercise">
            <div class="exercise-header">æ¼”ç¿’4ï¼šè¨ˆç®—ã‚³ã‚¹ãƒˆåˆ†æ <span class="difficulty difficulty-medium">Medium</span></div>
            <p><strong>å•é¡Œï¼š</strong>ã‚ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ãƒ¢ãƒ‡ãƒ«è¨“ç·´ã‚’æœˆ1å›ã€æ¨è«–ã‚’æ¯æ—¥10,000å›å®Ÿè¡Œã™ã‚‹ã€‚Random Forestï¼ˆè¨“ç·´45ç§’ã€æ¨è«–0.18ç§’/1000ã‚µãƒ³ãƒ—ãƒ«ï¼‰ã¨CGCNNï¼ˆè¨“ç·´1833ç§’ã€æ¨è«–2.34ç§’/1000ã‚µãƒ³ãƒ—ãƒ«ï¼‰ã®ã©ã¡ã‚‰ã‚’æ¡ç”¨ã™ã¹ãã‹ã€æœˆé–“ç·è¨ˆç®—æ™‚é–“ã‚’æ¯”è¼ƒã›ã‚ˆã€‚</p>
            <p><strong>è§£ç­”ï¼š</strong></p>
            <pre><code class="language-python"># æœˆé–“è¨ˆç®—æ™‚é–“ã®æ¯”è¼ƒ
# Random Forest
rf_train_time = 45  # ç§’/æœˆ
rf_infer_time = 0.18 * 10 * 30  # 0.18ç§’/1000ã‚µãƒ³ãƒ—ãƒ« Ã— 10 Ã— 30æ—¥
rf_total = rf_train_time + rf_infer_time
print(f"RFæœˆé–“ç·æ™‚é–“: {rf_total:.1f}ç§’ = {rf_total/60:.2f}åˆ†")

# CGCNN
cgcnn_train_time = 1833  # ç§’/æœˆ
cgcnn_infer_time = 2.34 * 10 * 30
cgcnn_total = cgcnn_train_time + cgcnn_infer_time
print(f"CGCNNæœˆé–“ç·æ™‚é–“: {cgcnn_total:.1f}ç§’ = {cgcnn_total/60:.2f}åˆ†")

print(f"\næ™‚é–“æ¯”ï¼ˆCGCNN/RFï¼‰: {cgcnn_total/rf_total:.2f}x")

# å‡ºåŠ›:
# RFæœˆé–“ç·æ™‚é–“: 99.0ç§’ = 1.65åˆ†
# CGCNNæœˆé–“ç·æ™‚é–“: 2535.0ç§’ = 42.25åˆ†
# æ™‚é–“æ¯”ï¼ˆCGCNN/RFï¼‰: 25.61x
</code></pre>
            <p><strong>åˆ¤æ–­ï¼š</strong>CGCNNã¯æœˆé–“ã§ç´„40åˆ†ã®è¿½åŠ è¨ˆç®—æ™‚é–“ã‚’è¦ã—ã¾ã™ã€‚ã“ã®ç”¨é€”ã§ã¯<strong>æ¨è«–æ™‚é–“ãŒæ”¯é…çš„</strong>ã§ã‚ã‚Šã€CGCNNã®æ¨è«–é€Ÿåº¦13å€ã®é…ã•ãŒæœˆé–“ç·æ™‚é–“ã«å¤§ããå½±éŸ¿ã—ã¾ã™ã€‚æ¯æ—¥ã®æ¨è«–é »åº¦ãŒé«˜ã„å ´åˆã¯<strong>Random Forestã‚’æ¨å¥¨</strong>ã—ã¾ã™ã€‚</p>
        </div>

        <div class="exercise">
            <div class="exercise-header">æ¼”ç¿’5ï¼šå­¦ç¿’æ›²ç·šã®è§£é‡ˆ <span class="difficulty difficulty-medium">Medium</span></div>
            <p><strong>å•é¡Œï¼š</strong>ä»¥ä¸‹ã®å­¦ç¿’æ›²ç·šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€è¨“ç·´ãƒ‡ãƒ¼ã‚¿ãŒ20,000ã‚µãƒ³ãƒ—ãƒ«ã—ã‹å¾—ã‚‰ã‚Œãªã„çŠ¶æ³ã§ã€ã©ã¡ã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã™ã¹ãã‹ç†ç”±ã¨ã¨ã‚‚ã«ç­”ãˆã‚ˆã€‚</p>
            <p>è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•° | RF ãƒ†ã‚¹ãƒˆMAE | CGCNN ãƒ†ã‚¹ãƒˆMAE</p>
            <p>10,000 | 0.045 | 0.062<br>
            20,000 | 0.038 | 0.041<br>
            50,000 | 0.033 | 0.031<br>
            100,000 | 0.032 | 0.027</p>
            <p><strong>è§£ç­”ï¼š</strong></p>
            <p><strong>æ¨å¥¨ï¼šRandom Forest</strong></p>
            <p><strong>ç†ç”±ï¼š</strong></p>
            <ol>
                <li>20,000ã‚µãƒ³ãƒ—ãƒ«ã®æ™‚ç‚¹ã§ã€RFã®ãƒ†ã‚¹ãƒˆMAEï¼ˆ0.038ï¼‰ã¯CGCNNï¼ˆ0.041ï¼‰ã‚ˆã‚Šå„ªã‚Œã¦ã„ã¾ã™</li>
                <li>RFã¯20,000ã‹ã‚‰50,000ã‚µãƒ³ãƒ—ãƒ«ã¸ã®æ”¹å–„å¹…ãŒå°ã•ãï¼ˆ0.038â†’0.033ï¼‰ã€æ—¢ã«æ€§èƒ½ãŒé£½å’Œå‚¾å‘ã«ã‚ã‚Šã¾ã™</li>
                <li>CGCNNã¯50,000ã‚µãƒ³ãƒ—ãƒ«ä»¥é™ã§æ€¥æ¿€ã«å‘ä¸Šã—ã¾ã™ãŒã€ç¾åœ¨åˆ©ç”¨å¯èƒ½ãª20,000ã‚µãƒ³ãƒ—ãƒ«ã§ã¯æ€§èƒ½ãŒä¸ååˆ†ã§ã™</li>
                <li>ãƒ‡ãƒ¼ã‚¿ãŒ20,000ã‚µãƒ³ãƒ—ãƒ«ã«é™å®šã•ã‚Œã‚‹çŠ¶æ³ã§ã¯ã€<strong>ãƒ‡ãƒ¼ã‚¿åŠ¹ç‡ã®é«˜ã„RFãŒå®Ÿç”¨çš„</strong>ã§ã™</li>
            </ol>
            <p><strong>å°†æ¥çš„ãªæˆ¦ç•¥ï¼š</strong>ãƒ‡ãƒ¼ã‚¿ãŒ50,000ã‚µãƒ³ãƒ—ãƒ«ä»¥ä¸Šã«å¢—åŠ ã—ãŸæ®µéšã§CGCNNã¸ã®ç§»è¡Œã‚’æ¤œè¨ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <div class="exercise">
            <div class="exercise-header">æ¼”ç¿’6ï¼šSHAPå€¤ã®å®Ÿè£… <span class="difficulty difficulty-hard">Hard</span></div>
            <p><strong>å•é¡Œï¼š</strong>Magpieç‰¹å¾´é‡ï¼ˆ145æ¬¡å…ƒï¼‰ã‚’ç”¨ã„ãŸRandom Forestãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦ã€SHAPå€¤ã‚’è¨ˆç®—ã—ã€ä¸Šä½5å€‹ã®é‡è¦ç‰¹å¾´é‡ã‚’æŠ½å‡ºã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã›ã‚ˆã€‚ãŸã ã—ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æœ€åˆã®50ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚</p>
            <p><strong>è§£ç­”ï¼š</strong></p>
            <pre><code class="language-python">import shap
import numpy as np

# Random Forestãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ï¼ˆæ¼”ç¿’2ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’ä½¿ç”¨ï¼‰
# æ—¢ã«X_train, y_train, X_test, y_testãŒæº–å‚™ã•ã‚Œã¦ã„ã‚‹å‰æ

# Random Forestè¨“ç·´
rf_model = RandomForestRegressor(
    n_estimators=100,
    max_depth=30,
    random_state=42,
    n_jobs=-1
)
rf_model.fit(X_train, y_train)

# SHAPå€¤ã‚’è¨ˆç®—ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿50ã‚µãƒ³ãƒ—ãƒ«ï¼‰
X_test_sample = X_test[:50]
explainer = shap.TreeExplainer(rf_model)
shap_values = explainer.shap_values(X_test_sample)

# å„ç‰¹å¾´é‡ã®å¹³å‡çµ¶å¯¾SHAPå€¤ã‚’è¨ˆç®—
mean_abs_shap = np.abs(shap_values).mean(axis=0)

# ä¸Šä½5å€‹ã®é‡è¦ç‰¹å¾´é‡ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
top_5_indices = np.argsort(mean_abs_shap)[-5:][::-1]

# Magpieç‰¹å¾´é‡åã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆä¸€éƒ¨ä¾‹ç¤ºï¼‰
magpie_names = {
    34: "å¹³å‡é›»æ°—é™°æ€§åº¦",
    12: "å¹³å‡åŸå­åŠå¾„",
    78: "ä¾¡é›»å­æ•°ã®æ¨™æº–åå·®",
    # ... ä»–ã®ç‰¹å¾´é‡åã‚’å®šç¾©
}

print("=== ä¸Šä½5å€‹ã®é‡è¦ç‰¹å¾´é‡ï¼ˆSHAPå€¤ï¼‰ ===")
for rank, feat_idx in enumerate(top_5_indices, 1):
    feat_name = magpie_names.get(feat_idx, f"Magpie_{feat_idx}")
    shap_importance = mean_abs_shap[feat_idx]
    print(f"{rank}. {feat_name} (Index {feat_idx}): SHAPé‡è¦åº¦ = {shap_importance:.4f}")

# å¯è¦–åŒ–
import matplotlib.pyplot as plt
plt.figure(figsize=(10, 6))
plt.barh(range(5), mean_abs_shap[top_5_indices][::-1], color='#764ba2')
plt.yticks(range(5), [magpie_names.get(i, f"Magpie_{i}") for i in top_5_indices][::-1])
plt.xlabel('å¹³å‡çµ¶å¯¾SHAPå€¤', fontsize=12)
plt.title('ä¸Šä½5å€‹ã®é‡è¦ç‰¹å¾´é‡ï¼ˆSHAPå€¤ã«ã‚ˆã‚‹ï¼‰', fontsize=14, fontweight='bold')
plt.tight_layout()
plt.savefig('top5_features_shap.png', dpi=300, bbox_inches='tight')
plt.show()

# å‡ºåŠ›ä¾‹ï¼š
# === ä¸Šä½5å€‹ã®é‡è¦ç‰¹å¾´é‡ï¼ˆSHAPå€¤ï¼‰ ===
# 1. å¹³å‡é›»æ°—é™°æ€§åº¦ (Index 34): SHAPé‡è¦åº¦ = 0.0087
# 2. å¹³å‡åŸå­åŠå¾„ (Index 12): SHAPé‡è¦åº¦ = 0.0065
# 3. ä¾¡é›»å­æ•°ã®æ¨™æº–åå·® (Index 78): SHAPé‡è¦åº¦ = 0.0054
# 4. Magpie_45: SHAPé‡è¦åº¦ = 0.0048
# 5. Magpie_89: SHAPé‡è¦åº¦ = 0.0042
</code></pre>
        </div>

        <div class="exercise">
            <div class="exercise-header">æ¼”ç¿’7ï¼šæ„æ€æ±ºå®šãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®é©ç”¨ <span class="difficulty difficulty-hard">Hard</span></div>
            <p><strong>å•é¡Œï¼š</strong>ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¡ä»¶ã«å¯¾ã—ã¦ã€4.7ç¯€ã®æ„æ€æ±ºå®šãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’é©ç”¨ã—ã€æœ€é©ãªæ‰‹æ³•ã‚’é¸æŠã›ã‚ˆã€‚</p>
            <p><strong>æ¡ä»¶ï¼š</strong></p>
            <ul>
                <li>è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°ï¼š75,000ã‚µãƒ³ãƒ—ãƒ«</li>
                <li>è¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ï¼šGPUï¼ˆTesla V100ï¼‰åˆ©ç”¨å¯èƒ½</li>
                <li>å„ªå…ˆåº¦ï¼šç²¾åº¦å„ªå…ˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äºˆæ¸¬ã¯ä¸è¦ï¼‰</li>
                <li>è§£é‡ˆå¯èƒ½æ€§ï¼šå¿…é ˆã§ã¯ãªã„ãŒã€ã‚ã‚Œã°æœ›ã¾ã—ã„</li>
                <li>çµ±è¨ˆçš„æœ‰æ„æ€§æ¤œè¨¼ï¼šå®Ÿæ–½äºˆå®š</li>
            </ul>
            <p><strong>è§£ç­”ï¼š</strong></p>
            <p><strong>æ¨å¥¨æ‰‹æ³•ï¼šCGCNN</strong></p>
            <p><strong>æ„æ€æ±ºå®šãƒ—ãƒ­ã‚»ã‚¹ï¼š</strong></p>
            <ol>
                <li><strong>ãƒ‡ãƒ¼ã‚¿æ•°è©•ä¾¡</strong>ï¼š75,000 > 50,000 â†’ ã€Œ>50,000ã€ã®åˆ†å²ã¸</li>
                <li><strong>ç²¾åº¦ vs é€Ÿåº¦</strong>ï¼šç²¾åº¦å„ªå…ˆ â†’ ã€Œç²¾åº¦å„ªå…ˆã€ã®åˆ†å²ã¸</li>
                <li><strong>CGCNNæ¨å¥¨ï¼ˆMAE 12%æ”¹å–„ï¼‰</strong>ã«åˆ°é”</li>
                <li><strong>çµ±è¨ˆçš„æœ‰æ„æ€§ç¢ºèª</strong>ï¼š5-foldäº¤å·®æ¤œè¨¼ã§å¯¾å¿œã®ã‚ã‚‹tæ¤œå®šã‚’å®Ÿæ–½ã—ã€p<0.05ã‚’ç¢ºèª</li>
                <li><strong>è¨ˆç®—ã‚³ã‚¹ãƒˆè¨±å®¹æ€§</strong>ï¼šGPUï¼ˆV100ï¼‰åˆ©ç”¨å¯èƒ½ã§è¨“ç·´æ™‚é–“ã¯ç´„30åˆ†ç¨‹åº¦ã«çŸ­ç¸®ã•ã‚Œã‚‹ãŸã‚ã€è¨±å®¹å¯èƒ½</li>
                <li><strong>æœ€çµ‚æ±ºå®š</strong>ï¼šCGCNNæ¡ç”¨æ±ºå®š</li>
            </ol>
            <p><strong>è¿½åŠ è€ƒæ…®äº‹é …ï¼š</strong></p>
            <ul>
                <li>è§£é‡ˆå¯èƒ½æ€§ãŒæœ›ã¾ã—ã„ãŸã‚ã€<strong>Attentionæ©Ÿæ§‹ä»˜ãGNNï¼ˆGATï¼‰</strong>ã®æ¤œè¨ã‚‚æ¨å¥¨</li>
                <li>æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã€æ¨è«–æ™‚é–“13å€ã®é…ã•ãŒå®Ÿéš›ã®é‹ç”¨ã«å½±éŸ¿ã—ãªã„ã‹ã‚’ç¢ºèª</li>
                <li>ãƒ‡ãƒ¼ã‚¿ãŒä»Šå¾Œã‚‚å¢—åŠ ã™ã‚‹è¦‹è¾¼ã¿ãŒã‚ã‚Œã°ã€CGCNNã¯é•·æœŸçš„ã«ã•ã‚‰ã«æ€§èƒ½å‘ä¸ŠãŒæœŸå¾…ã§ãã‚‹</li>
            </ul>
        </div>

        <div class="exercise">
            <div class="exercise-header">æ¼”ç¿’8ï¼šãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æˆ¦ç•¥ã®è¨­è¨ˆ <span class="difficulty difficulty-hard">Hard</span></div>
            <p><strong>å•é¡Œï¼š</strong>ãƒ‡ãƒ¼ã‚¿ãŒæ®µéšçš„ã«å¢—åŠ ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆåˆæœŸ5,000ã‚µãƒ³ãƒ—ãƒ«ã€3ãƒ¶æœˆå¾Œã«30,000ã€6ãƒ¶æœˆå¾Œã«80,000ï¼‰ã«ãŠã„ã¦ã€Random Forestã‹ã‚‰CGCNNã¸ã®ç§»è¡Œæˆ¦ç•¥ã‚’è¨­è¨ˆã›ã‚ˆã€‚å„æ®µéšã§ã®æ‰‹æ³•é¸æŠã¨ç§»è¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®åˆ¤æ–­åŸºæº–ã‚’æ˜ç¢ºã«ã™ã‚‹ã“ã¨ã€‚</p>
            <p><strong>è§£ç­”ï¼š</strong></p>
            <p><strong>ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ç§»è¡Œæˆ¦ç•¥ï¼š</strong></p>

            <p><strong>ãƒ•ã‚§ãƒ¼ã‚º1ï¼šåˆæœŸæ®µéšï¼ˆ5,000ã‚µãƒ³ãƒ—ãƒ«ã€0-3ãƒ¶æœˆï¼‰</strong></p>
            <ul>
                <li><strong>æ¡ç”¨æ‰‹æ³•ï¼šRandom Forestï¼ˆMagpieï¼‰</strong></li>
                <li><strong>ç†ç”±ï¼š</strong>
                    <ul>
                        <li>5,000ã‚µãƒ³ãƒ—ãƒ«ã¯å°‘ãƒ‡ãƒ¼ã‚¿é ˜åŸŸã§ã€RFãŒãƒ‡ãƒ¼ã‚¿åŠ¹ç‡çš„</li>
                        <li>è¿…é€Ÿãªãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã¨åˆæœŸãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ§‹ç¯‰ãŒå¯èƒ½</li>
                        <li>CGCNNè¨“ç·´ã«ã¯ä¸ååˆ†ãªãƒ‡ãƒ¼ã‚¿é‡</li>
                    </ul>
                </li>
                <li><strong>å®Ÿæ–½äº‹é …ï¼š</strong>
                    <ul>
                        <li>RFã§ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰ï¼ˆMAEç›®æ¨™ï¼š~0.045 eV/atomï¼‰</li>
                        <li>SHAPå€¤ã«ã‚ˆã‚‹ç‰¹å¾´é‡é‡è¦åº¦åˆ†æ</li>
                        <li>ãƒ‡ãƒ¼ã‚¿åé›†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç¢ºç«‹</li>
                    </ul>
                </li>
            </ul>

            <p><strong>ãƒ•ã‚§ãƒ¼ã‚º2ï¼šä¸­è¦æ¨¡æ®µéšï¼ˆ30,000ã‚µãƒ³ãƒ—ãƒ«ã€3-6ãƒ¶æœˆï¼‰</strong></p>
            <ul>
                <li><strong>æ¡ç”¨æ‰‹æ³•ï¼šRandom Forestç¶™ç¶š + CGCNNå®Ÿé¨“çš„å°å…¥</strong></li>
                <li><strong>ç†ç”±ï¼š</strong>
                    <ul>
                        <li>30,000ã‚µãƒ³ãƒ—ãƒ«ã¯ç§»è¡Œæ¤œè¨é ˜åŸŸï¼ˆå­¦ç¿’æ›²ç·šã§ä¸¡æ‰‹æ³•ãŒæ‹®æŠ—ï¼‰</li>
                        <li>CGCNNã®å®Ÿé¨“çš„è¨“ç·´ã‚’é–‹å§‹ã—ã€æ€§èƒ½è©•ä¾¡ã‚’å®Ÿæ–½</li>
                        <li>æœ¬ç•ªç’°å¢ƒã§ã¯RFç¶™ç¶šï¼ˆå®‰å®šæ€§é‡è¦–ï¼‰</li>
                    </ul>
                </li>
                <li><strong>ç§»è¡Œåˆ¤æ–­åŸºæº–ï¼š</strong>
                    <ol>
                        <li>CGCNNãŒRFã‚’ä¸Šå›ã‚‹MAEã‚’é”æˆ</li>
                        <li>5-foldäº¤å·®æ¤œè¨¼ã§çµ±è¨ˆçš„æœ‰æ„æ€§ç¢ºèªï¼ˆp<0.05ï¼‰</li>
                        <li>GPUç’°å¢ƒã§CGCNNè¨“ç·´æ™‚é–“<1æ™‚é–“</li>
                    </ol>
                </li>
                <li><strong>å®Ÿæ–½äº‹é …ï¼š</strong>
                    <ul>
                        <li>CGCNNè¨“ç·´ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰</li>
                        <li>ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°</li>
                        <li>RF vs CGCNNå®šé‡çš„æ¯”è¼ƒï¼ˆæœ¬ç« ã®æ‰‹æ³•ã‚’é©ç”¨ï¼‰</li>
                    </ul>
                </li>
            </ul>

            <p><strong>ãƒ•ã‚§ãƒ¼ã‚º3ï¼šå¤§è¦æ¨¡æ®µéšï¼ˆ80,000ã‚µãƒ³ãƒ—ãƒ«ã€6ãƒ¶æœˆä»¥é™ï¼‰</strong></p>
            <ul>
                <li><strong>æ¡ç”¨æ‰‹æ³•ï¼šCGCNNï¼ˆä¸»åŠ›ï¼‰+ Random Forestï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰</strong></li>
                <li><strong>ç†ç”±ï¼š</strong>
                    <ul>
                        <li>80,000ã‚µãƒ³ãƒ—ãƒ«ã¯å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿é ˜åŸŸã§ã€CGCNNã®å„ªä½æ€§ãŒé¡•è‘—ï¼ˆå­¦ç¿’æ›²ç·šåˆ†æï¼‰</li>
                        <li>MAE 12%æ”¹å–„ã®åŠ¹æœãŒçµ±è¨ˆçš„ã«æœ‰æ„</li>
                        <li>ãƒ‡ãƒ¼ã‚¿å¢—åŠ å‚¾å‘ãŒç¶™ç¶šã™ã‚Œã°CGCNNæ€§èƒ½ã¯ã•ã‚‰ã«å‘ä¸Š</li>
                    </ul>
                </li>
                <li><strong>ç§»è¡Œå®Ÿæ–½ï¼š</strong>
                    <ol>
                        <li>CGCNNã‚’æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤</li>
                        <li>RFã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ä¿æŒï¼ˆCGCNNæ¨è«–å¤±æ•—æ™‚ï¼‰</li>
                        <li>æ¨è«–æ™‚é–“ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆ13å€é…ã„CGCNNãŒé‹ç”¨ã«å½±éŸ¿ã—ãªã„ã‹ç¢ºèªï¼‰</li>
                    </ol>
                </li>
                <li><strong>ç¶™ç¶šçš„æ”¹å–„ï¼š</strong>
                    <ul>
                        <li>ãƒ‡ãƒ¼ã‚¿å¢—åŠ ã«å¿œã˜ã¦CGCNNã‚’å®šæœŸçš„ã«å†è¨“ç·´</li>
                        <li>Attentionæ©Ÿæ§‹ï¼ˆGATï¼‰å°å…¥ã§è§£é‡ˆå¯èƒ½æ€§å‘ä¸Šã‚’æ¤œè¨</li>
                        <li>ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«ï¼ˆRF + CGCNNï¼‰ã§æœ€é«˜ç²¾åº¦é”æˆã‚’è©¦ã¿ã‚‹</li>
                    </ul>
                </li>
            </ul>

            <p><strong>ãƒªã‚¹ã‚¯ç®¡ç†ï¼š</strong></p>
            <ul>
                <li><strong>ç§»è¡Œå¤±æ•—æ™‚ã®å¯¾ç­–</strong>ï¼šRFã‚’ç¶™ç¶šé‹ç”¨ã—ã€CGCNNå•é¡Œã‚’è§£æ±ºå¾Œã«å†è©¦è¡Œ</li>
                <li><strong>æ€§èƒ½åŠ£åŒ–æ¤œçŸ¥</strong>ï¼šæœ¬ç•ªç’°å¢ƒã§äºˆæ¸¬ç²¾åº¦ã‚’ç¶™ç¶šãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</li>
                <li><strong>ã‚³ã‚¹ãƒˆè¶…éå¯¾ç­–</strong>ï¼šGPUåˆ©ç”¨æ–™ãŒäºˆç®—ã‚’è¶…éã™ã‚‹å ´åˆã¯RFã«æˆ»ã™</li>
            </ul>
        </div>

        <div class="exercise">
            <div class="exercise-header">æ¼”ç¿’9ï¼šåŠ¹æœé‡ã®è§£é‡ˆ <span class="difficulty difficulty-medium">Medium</span></div>
            <p><strong>å•é¡Œï¼š</strong>Cohen's d = 0.35ã¨ã„ã†åŠ¹æœé‡ãŒå¾—ã‚‰ã‚ŒãŸå ´åˆã€ã“ã®åŠ¹æœé‡ã®å¤§ãã•ã‚’è©•ä¾¡ã—ã€å®Ÿå‹™ä¸Šã®æ„å‘³ã‚’èª¬æ˜ã›ã‚ˆã€‚</p>
            <p><strong>è§£ç­”ï¼š</strong></p>
            <p><strong>åŠ¹æœé‡ã®å¤§ãã•ï¼š</strong>ã€Œä¸­ç¨‹åº¦ã€ï¼ˆ0.2 < |d| < 0.5ã®ç¯„å›²ï¼‰</p>
            <p><strong>å®Ÿå‹™ä¸Šã®è§£é‡ˆï¼š</strong></p>
            <ol>
                <li><strong>çµ±è¨ˆçš„æ„å‘³ï¼š</strong>Cohen's d = 0.35ã¯ã€2ã¤ã®ãƒ¢ãƒ‡ãƒ«ã®æ€§èƒ½å·®ãŒæ¨™æº–åå·®ã®0.35å€ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™</li>
                <li><strong>å®Ÿç”¨çš„æ„å‘³ï¼š</strong>ä¸­ç¨‹åº¦ã®åŠ¹æœé‡ã¯ã€å®Ÿå‹™ä¸Šã€Œèªè­˜å¯èƒ½ã ãŒåŠ‡çš„ã§ã¯ãªã„æ”¹å–„ã€ã‚’æ„å‘³ã—ã¾ã™</li>
                <li><strong>åˆ¤æ–­åŸºæº–ï¼š</strong>
                    <ul>
                        <li>ã‚³ã‚¹ãƒˆãŒåŒç­‰ãªã‚‰ã€æ”¹å–„åŠ¹æœãŒã‚ã‚‹ãŸã‚æ–°æ‰‹æ³•ã‚’æ¡ç”¨</li>
                        <li>æ–°æ‰‹æ³•ã®å°å…¥ã‚³ã‚¹ãƒˆãŒé«˜ã„å ´åˆã€è²»ç”¨å¯¾åŠ¹æœã‚’æ…é‡ã«è©•ä¾¡</li>
                        <li>ä¸­ç¨‹åº¦ã®åŠ¹æœé‡ã§ã‚‚ã€ææ–™æ¢ç´¢ã®åŠ¹ç‡åŒ–ã«ã¯å¯„ä¸ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š</li>
                    </ul>
                </li>
            </ol>
            <p><strong>æ¯”è¼ƒï¼š</strong>æœ¬ç« ã®CGCNN vs RFæ¯”è¼ƒã§ã¯ã€Cohen's d = 9.19ï¼ˆéå¸¸ã«å¤§ãã„ï¼‰ã§ã‚ã‚Šã€å®Ÿç”¨ä¸Šã®å„ªä½æ€§ãŒæ¥µã‚ã¦æ˜ç¢ºã§ã™ã€‚</p>
        </div>

        <div class="exercise">
            <div class="exercise-header">æ¼”ç¿’10ï¼šç·åˆçš„æ‰‹æ³•é¸æŠ <span class="difficulty difficulty-hard">Hard</span></div>
            <p><strong>å•é¡Œï¼š</strong>æœ¬ç« ã§å­¦ã‚“ã 7ã¤ã®è©•ä¾¡è¦³ç‚¹ï¼ˆäºˆæ¸¬ç²¾åº¦ã€çµ±è¨ˆçš„æœ‰æ„æ€§ã€è¨ˆç®—ã‚³ã‚¹ãƒˆã€ãƒ‡ãƒ¼ã‚¿è¦æ±‚é‡ã€è§£é‡ˆå¯èƒ½æ€§ã€å®Ÿè£…å®¹æ˜“æ€§ã€æ„æ€æ±ºå®šãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼‰ã‚’çµ±åˆã—ã€ä»¥ä¸‹ã®ã‚·ãƒŠãƒªã‚ªã«å¯¾ã—ã¦æœ€é©ãªæ‰‹æ³•ã‚’é¸æŠã›ã‚ˆã€‚</p>
            <p><strong>ã‚·ãƒŠãƒªã‚ªï¼š</strong>è£½è–¬ä¼æ¥­ã®æ–°è–¬å€™è£œææ–™æ¢ç´¢ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
            <ul>
                <li>ç›®æ¨™ï¼š10,000åŒ–åˆç‰©ã‹ã‚‰æœ‰æœ›ãª100å€™è£œã‚’é¸æŠœ</li>
                <li>ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ï¼šå®Ÿé¨“ãƒ‡ãƒ¼ã‚¿12,000ã‚µãƒ³ãƒ—ãƒ«ï¼ˆè¿½åŠ å®Ÿé¨“ãªã—ï¼‰</li>
                <li>è¨ˆç®—ç’°å¢ƒï¼šç¤¾å†…ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆGPUåˆ©ç”¨å¯èƒ½ã ãŒå¾“é‡èª²é‡‘ï¼‰</li>
                <li>æ™‚é–“åˆ¶ç´„ï¼š3ãƒ¶æœˆä»¥å†…ã«å€™è£œãƒªã‚¹ãƒˆæå‡º</li>
                <li>è§£é‡ˆè¦æ±‚ï¼šè¦åˆ¶å½“å±€ã¸ã®èª¬æ˜è³‡æ–™ã¨ã—ã¦äºˆæ¸¬æ ¹æ‹ ãŒå¿…é ˆ</li>
                <li>ç²¾åº¦è¦æ±‚ï¼šfalse positiveã‚’æœ€å°åŒ–ï¼ˆå®Ÿé¨“ã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰</li>
            </ul>
            <p><strong>è§£ç­”ï¼š</strong></p>
            <p><strong>æ¨å¥¨æˆ¦ç•¥ï¼šRandom Forestï¼ˆMagpieï¼‰+ SHAPå€¤è§£æ</strong></p>

            <p><strong>ç·åˆåˆ¤æ–­ã®æ ¹æ‹ ï¼š</strong></p>

            <p><strong>1. ãƒ‡ãƒ¼ã‚¿è¦æ±‚é‡åˆ†æï¼ˆSection 4.5ï¼‰</strong></p>
            <ul>
                <li>12,000ã‚µãƒ³ãƒ—ãƒ«ã¯ä¸­è¦æ¨¡ãƒ‡ãƒ¼ã‚¿é ˜åŸŸï¼ˆ10,000-50,000ï¼‰ã«è©²å½“</li>
                <li>å­¦ç¿’æ›²ç·šã®çŸ¥è¦‹ï¼šã“ã®é ˜åŸŸã§ã¯RFã¨CGCNNãŒæ‹®æŠ—ã€RFãŒã‚„ã‚„å„ªä½</li>
                <li>è¿½åŠ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸å¯ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿åŠ¹ç‡çš„ãªRFãŒå®‰å…¨</li>
            </ul>

            <p><strong>2. è¨ˆç®—ã‚³ã‚¹ãƒˆåˆ†æï¼ˆSection 4.4ï¼‰</strong></p>
            <ul>
                <li>GPUå¾“é‡èª²é‡‘ç’°å¢ƒã§ã¯ã€CGCNNè¨“ç·´æ™‚é–“40å€ã®ã‚³ã‚¹ãƒˆãŒç›´æ¥çš„ãªè²»ç”¨å¢—</li>
                <li>10,000åŒ–åˆç‰©ã®æ¨è«–ï¼šRF 1.8ç§’ vs CGCNN 23.4ç§’ï¼ˆ13å€å·®ï¼‰</li>
                <li>æ™‚é–“åˆ¶ç´„3ãƒ¶æœˆã¯ååˆ†ã ãŒã€ã‚³ã‚¹ãƒˆåŠ¹ç‡ã§RFãŒæœ‰åˆ©</li>
            </ul>

            <p><strong>3. è§£é‡ˆå¯èƒ½æ€§è¦æ±‚ï¼ˆSection 4.6ï¼‰</strong></p>
            <ul>
                <li><strong>è¦åˆ¶å½“å±€ã¸ã®èª¬æ˜ãŒå¿…é ˆ</strong>ã¨ã„ã†è¦æ±‚ã¯æ±ºå®šçš„è¦å› </li>
                <li>SHAPå€¤ã«ã‚ˆã‚‹ç‰¹å¾´é‡é‡è¦åº¦åˆ†æã¯ã€ã€Œã©ã®åŒ–å­¦çš„ç‰¹æ€§ãŒé‡è¦ã‹ã€ã‚’æ˜ç¢ºã«èª¬æ˜å¯èƒ½</li>
                <li>CGCNNã®Attentionæ©Ÿæ§‹ã¯å°‚é–€çŸ¥è­˜ãŒå¿…è¦ã§ã€è¦åˆ¶å½“å±€ã¸ã®èª¬æ˜ãŒå›°é›£</li>
                <li><strong>SHAPå€¤è§£æãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦æ±‚ã¨å®Œå…¨ã«ä¸€è‡´</strong></li>
            </ul>

            <p><strong>4. ç²¾åº¦è¦æ±‚ï¼ˆSection 4.2-4.3ï¼‰</strong></p>
            <ul>
                <li>false positiveã‚’æœ€å°åŒ–ã™ã‚‹ã«ã¯ã€é«˜ã„äºˆæ¸¬ç²¾åº¦ãŒå¿…è¦</li>
                <li>CGCNNã¯12%ç²¾åº¦å‘ä¸Šã‚’ç¤ºã™ãŒã€çµ±è¨ˆçš„æœ‰æ„æ€§ã‚’12,000ã‚µãƒ³ãƒ—ãƒ«ã§æ¤œè¨¼ã™ã‚‹å¿…è¦ã‚ã‚Š</li>
                <li>RFã‚‚ååˆ†é«˜ç²¾åº¦ï¼ˆRÂ² > 0.93ï¼‰ã§ã‚ã‚Šã€false positiveç‡ã¯è¨±å®¹ç¯„å›²</li>
            </ul>

            <p><strong>5. å®Ÿè£…å®¹æ˜“æ€§ã¨æ™‚é–“åˆ¶ç´„</strong></p>
            <ul>
                <li>RFã¯å®Ÿè£…ãŒå®¹æ˜“ã§ã€è¿…é€Ÿã«ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ§‹ç¯‰å¯èƒ½</li>
                <li>3ãƒ¶æœˆã¨ã„ã†åˆ¶ç´„ã§ã¯ã€ç¢ºå®Ÿæ€§ã®é«˜ã„RFæ¡ç”¨ãŒãƒªã‚¹ã‚¯å›é¿</li>
            </ul>

            <p><strong>å®Ÿè£…è¨ˆç”»ï¼š</strong></p>
            <ol>
                <li><strong>Week 1-2</strong>ï¼šRandom Forest + Magpieç‰¹å¾´é‡ã§ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰</li>
                <li><strong>Week 3-4</strong>ï¼š5-foldäº¤å·®æ¤œè¨¼ã§æ€§èƒ½è©•ä¾¡ï¼ˆMAEã€RÂ²ï¼‰</li>
                <li><strong>Week 5-6</strong>ï¼šSHAPå€¤è§£æã§ç‰¹å¾´é‡é‡è¦åº¦ã‚’å¯è¦–åŒ–</li>
                <li><strong>Week 7-8</strong>ï¼š10,000åŒ–åˆç‰©ã«å¯¾ã—ã¦äºˆæ¸¬å®Ÿè¡Œã€ä¸Šä½100å€™è£œã‚’é¸æŠœ</li>
                <li><strong>Week 9-10</strong>ï¼šè¦åˆ¶å½“å±€å‘ã‘èª¬æ˜è³‡æ–™ä½œæˆï¼ˆSHAPå€¤ãƒ—ãƒ­ãƒƒãƒˆã‚’å«ã‚€ï¼‰</li>
                <li><strong>Week 11-12</strong>ï¼šå†…éƒ¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æœ€çµ‚å ±å‘Šæ›¸ä½œæˆ</li>
            </ol>

            <p><strong>ãƒªã‚¹ã‚¯å¯¾ç­–ï¼š</strong></p>
            <ul>
                <li><strong>ç²¾åº¦ãŒä¸ååˆ†ãªå ´åˆ</strong>ï¼šã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«å­¦ç¿’ï¼ˆRFè¤‡æ•°ãƒ¢ãƒ‡ãƒ«ï¼‰ã§ç²¾åº¦å‘ä¸Š</li>
                <li><strong>è§£é‡ˆæ€§ãŒä¸è¶³ãªå ´åˆ</strong>ï¼šLIMEï¼ˆLocal Interpretable Model-agnostic Explanationsï¼‰ã‚’è¿½åŠ </li>
                <li><strong>false positiveãŒå¤šã„å ´åˆ</strong>ï¼šé–¾å€¤èª¿æ•´ã§é¸æŠœåŸºæº–ã‚’å³æ ¼åŒ–</li>
            </ul>

            <p><strong>å´ä¸‹ç†ç”±ï¼šCGCNN</strong></p>
            <ul>
                <li>è§£é‡ˆå¯èƒ½æ€§è¦æ±‚ãŒæ±ºå®šçš„ãªå´ä¸‹è¦å› ï¼ˆè¦åˆ¶å½“å±€èª¬æ˜ãŒå›°é›£ï¼‰</li>
                <li>12,000ã‚µãƒ³ãƒ—ãƒ«ã§ã¯CGCNNã®å„ªä½æ€§ãŒé™å®šçš„</li>
                <li>è¨ˆç®—ã‚³ã‚¹ãƒˆã¨ãƒªã‚¹ã‚¯ã‚’è€ƒæ…®ã™ã‚‹ã¨ã€ROIãŒä¸æ˜ç¢º</li>
            </ul>

            <p><strong>å°†æ¥çš„æ¤œè¨ï¼š</strong>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒç¶™ç¶šã—ã€å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ãŒ50,000ã‚µãƒ³ãƒ—ãƒ«ä»¥ä¸Šã«å¢—åŠ ã—ãŸæ®µéšã§ã€CGCNNã¸ã®ç§»è¡Œã‚’å†è©•ä¾¡ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>
        </div>

        <h2>å‚è€ƒæ–‡çŒ®</h2>

        <ol>
            <li>Dunn, A., Wang, Q., Ganose, A., Dopp, D., Jain, A. (2020). Benchmarking materials property prediction methods: the Matbench test set and Automatminer reference algorithm. <em>npj Computational Materials</em>, 6(1), 138, pp. 1-10.</li>
            <li>Ward, L., Agrawal, A., Choudhary, A., Wolverton, C. (2016). A general-purpose machine learning framework for predicting properties of inorganic materials. <em>npj Computational Materials</em>, 2, 16028, pp. 1-7.</li>
            <li>Xie, T., Grossman, J. C. (2018). Crystal Graph Convolutional Neural Networks for an Accurate and Interpretable Prediction of Material Properties. <em>Physical Review Letters</em>, 120(14), 145301, pp. 1-6.</li>
            <li>Gilmer, J., Schoenholz, S. S., Riley, P. F., Vinyals, O., Dahl, G. E. (2017). Neural Message Passing for Quantum Chemistry. <em>Proceedings of the 34th International Conference on Machine Learning</em>, PMLR 70, pp. 1263-1272.</li>
            <li>Lundberg, S. M., Lee, S. I. (2017). A Unified Approach to Interpreting Model Predictions. <em>Advances in Neural Information Processing Systems</em>, 30, pp. 4765-4774.</li>
            <li>Cohen, J. (1988). <em>Statistical Power Analysis for the Behavioral Sciences</em> (2nd ed.). Lawrence Erlbaum Associates, pp. 20-27.</li>
            <li>Breiman, L. (2001). Random Forests. <em>Machine Learning</em>, 45(1), 5-32, pp. 5-32.</li>
            <li>Choudhary, K., DeCost, B. (2021). Atomistic Line Graph Neural Network for improved materials property predictions. <em>npj Computational Materials</em>, 7(1), 185, pp. 1-8.</li>
        </ol>

        <div class="nav-buttons">
            <a href="chapter-3.html" class="nav-button">â† ç¬¬3ç« ï¼šMPNNå®Ÿè£…</a>
            <a href="chapter-5.html" class="nav-button">ç¬¬5ç« ï¼šãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ â†’</a>
        </div>

    </div>
</body>
</html>