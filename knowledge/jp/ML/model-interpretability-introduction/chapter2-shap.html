<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬2ç« ï¼šSHAP (SHapley Additive exPlanations) - AI Terakoya</title>

    <style>
        :root {
            --color-primary: #2c3e50;
            --color-primary-dark: #1a252f;
            --color-accent: #7b2cbf;
            --color-accent-light: #9d4edd;
            --color-text: #2d3748;
            --color-text-light: #4a5568;
            --color-bg: #ffffff;
            --color-bg-alt: #f7fafc;
            --color-border: #e2e8f0;
            --color-code-bg: #f8f9fa;
            --color-link: #3182ce;
            --color-link-hover: #2c5aa0;

            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;

            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;

            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.7;
            color: var(--color-text);
            background-color: var(--color-bg);
            font-size: 16px;
        }

        header {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: var(--spacing-md);
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 var(--spacing-md) var(--spacing-xl);
        }

        h2 {
            font-size: 1.75rem;
            color: var(--color-primary);
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-xs);
            border-bottom: 3px solid var(--color-accent);
        }

        h3 {
            font-size: 1.4rem;
            color: var(--color-primary);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
        }

        h4 {
            font-size: 1.1rem;
            color: var(--color-primary-dark);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        p {
            margin-bottom: var(--spacing-md);
            color: var(--color-text);
        }

        a {
            color: var(--color-link);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--color-link-hover);
            text-decoration: underline;
        }

        ul, ol {
            margin-left: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        li {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text);
        }

        pre {
            background-color: var(--color-code-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            overflow-x: auto;
            margin-bottom: var(--spacing-md);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            font-family: var(--font-mono);
            font-size: 0.9em;
            background-color: var(--color-code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
            font-size: 0.95rem;
        }

        th, td {
            border: 1px solid var(--color-border);
            padding: var(--spacing-sm);
            text-align: left;
        }

        th {
            background-color: var(--color-bg-alt);
            font-weight: 600;
            color: var(--color-primary);
        }

        blockquote {
            border-left: 4px solid var(--color-accent);
            padding-left: var(--spacing-md);
            margin: var(--spacing-md) 0;
            color: var(--color-text-light);
            font-style: italic;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .mermaid {
            text-align: center;
            margin: var(--spacing-lg) 0;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        details {
            background-color: var(--color-bg-alt);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--color-primary);
            user-select: none;
            padding: var(--spacing-xs);
            margin: calc(-1 * var(--spacing-md));
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        summary:hover {
            background-color: rgba(123, 44, 191, 0.1);
        }

        details[open] summary {
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin: var(--spacing-xl) 0;
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--color-border);
        }

        .nav-button {
            flex: 1;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--box-shadow);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-decoration: none;
        }

        footer {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg) var(--spacing-md);
            background-color: var(--color-bg-alt);
            border-top: 1px solid var(--color-border);
            text-align: center;
            font-size: 0.9rem;
            color: var(--color-text-light);
        }
        .disclaimer {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            border-radius: 4px;
        }

        .disclaimer h3 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .disclaimer ul {
            list-style: none;
            padding-left: 0;
        }

        .disclaimer li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
            font-size: 0.9rem;
            color: #6c757d;
            line-height: 1.6;
        }

        .disclaimer li::before {
            content: "âš ï¸";
            position: absolute;
            left: 0;
        }


        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.4rem;
            }

            h3 {
                font-size: 1.2rem;
            }

            .meta {
                font-size: 0.85rem;
            }

            .navigation {
                flex-direction: column;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: var(--spacing-xs);
            }
        }
    
        
    
        /* Breadcrumb styles */
        .breadcrumb {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .breadcrumb-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a0aec0;
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: #4a5568;
            font-weight: 500;
        }
    </style>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>

    <!-- MathJax for LaTeX equation rendering -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'mermaid'
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>

    <style>
        /* Locale Switcher Styles */
        .locale-switcher {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .current-locale {
            font-weight: 600;
            color: #7b2cbf;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .locale-separator {
            color: #adb5bd;
            font-weight: 300;
        }

        .locale-link {
            color: #f093fb;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .locale-link:hover {
            background: rgba(240, 147, 251, 0.1);
            color: #d07be8;
            transform: translateY(-1px);
        }

        .locale-meta {
            color: #868e96;
            font-size: 0.85rem;
            font-style: italic;
            margin-left: auto;
        }

        @media (max-width: 768px) {
            .locale-switcher {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
            }
            .locale-meta {
                display: none;
            }
        }
    </style>
</head>
<body>
            <div class="locale-switcher">
<span class="current-locale">ğŸŒ JP</span>
<span class="locale-separator">|</span>
<a href="../../../en/ML/model-interpretability-introduction/chapter2-shap.html" class="locale-link">ğŸ‡¬ğŸ‡§ EN</a>
<span class="locale-separator">|</span>
<span class="locale-meta">Last sync: 2025-11-16</span>
</div>
<nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="../../index.html">AIå¯ºå­å±‹ãƒˆãƒƒãƒ—</a><span class="breadcrumb-separator">â€º</span><a href="../../ML/index.html">æ©Ÿæ¢°å­¦ç¿’</a><span class="breadcrumb-separator">â€º</span><a href="../../ML/model-interpretability-introduction/index.html">Model Interpretability</a><span class="breadcrumb-separator">â€º</span><span class="breadcrumb-current">Chapter 2</span>
        </div>
    </nav>

        <header>
        <div class="header-content">
            <h1>ç¬¬2ç« ï¼šSHAP (SHapley Additive exPlanations)</h1>
            <p class="subtitle">ã‚²ãƒ¼ãƒ ç†è«–ã«åŸºã¥ãçµ±ä¸€çš„ç‰¹å¾´é‡é‡è¦åº¦</p>
            <div class="meta">
                <span class="meta-item">ğŸ“– èª­äº†æ™‚é–“: 35-40åˆ†</span>
                <span class="meta-item">ğŸ“Š é›£æ˜“åº¦: ä¸­ç´šã€œä¸Šç´š</span>
                <span class="meta-item">ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹: 10å€‹</span>
                <span class="meta-item">ğŸ“ æ¼”ç¿’å•é¡Œ: 5å•</span>
            </div>
        </div>
    </header>

    <main class="container">

<h2>å­¦ç¿’ç›®æ¨™</h2>
<p>ã“ã®ç« ã‚’èª­ã‚€ã“ã¨ã§ã€ä»¥ä¸‹ã‚’ç¿’å¾—ã§ãã¾ã™ï¼š</p>
<ul>
<li>âœ… ã‚²ãƒ¼ãƒ ç†è«–ã«ãŠã‘ã‚‹Shapleyå€¤ã®æ¦‚å¿µã¨æ€§è³ªã‚’ç†è§£ã™ã‚‹</li>
<li>âœ… SHAPå€¤ã®æ•°å­¦çš„å®šå¼åŒ–ã¨å…¬ç†çš„ç‰¹æ€§ã‚’èª¬æ˜ã§ãã‚‹</li>
<li>âœ… TreeSHAPã€KernelSHAPãªã©ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ç†è§£ã™ã‚‹</li>
<li>âœ… SHAPãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç”¨ã„ãŸå®Ÿè£…ã¨å¯è¦–åŒ–ãŒã§ãã‚‹</li>
<li>âœ… Waterfallã€Forceã€Summary plotsãªã©ã®è§£é‡ˆæ‰‹æ³•ã‚’ä½¿ãˆã‚‹</li>
<li>âœ… SHAPã®å¿œç”¨ç¯„å›²ã¨é™ç•Œã‚’ç†è§£ã™ã‚‹</li>
</ul>

<hr>

<h2>2.1 Shapleyå€¤ã®ç†è«–</h2>

<h3>ã‚²ãƒ¼ãƒ ç†è«–ã®åŸºç¤</h3>

<p><strong>Shapleyå€¤</strong>ã¯ã€å”åŠ›ã‚²ãƒ¼ãƒ ç†è«–ï¼ˆCooperative Game Theoryï¼‰ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸæ¦‚å¿µã§ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è²¢çŒ®åº¦ã‚’å…¬å¹³ã«è©•ä¾¡ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚</p>

<h4>å”åŠ›ã‚²ãƒ¼ãƒ ã®å®šç¾©</h4>

<p>å”åŠ›ã‚²ãƒ¼ãƒ  $(N, v)$ ã¯ä»¥ä¸‹ã§å®šç¾©ã•ã‚Œã¾ã™ï¼š</p>
<ul>
<li>$N = \{1, 2, \ldots, n\}$ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é›†åˆ</li>
<li>$v: 2^N \rightarrow \mathbb{R}$ï¼šç‰¹æ€§é–¢æ•°ï¼ˆcoalitional value functionï¼‰</li>
<li>$v(S)$ï¼šé€£æº $S \subseteq N$ ã®ä¾¡å€¤</li>
</ul>

<p>æ¡ä»¶ï¼š</p>
<ul>
<li>$v(\emptyset) = 0$ï¼ˆç©ºé›†åˆã®ä¾¡å€¤ã¯0ï¼‰</li>
<li>$v(N)$ï¼šå…¨å“¡ãŒå”åŠ›ã—ãŸã¨ãã®ç·ä¾¡å€¤</li>
</ul>

<h4>æ©Ÿæ¢°å­¦ç¿’ã¸ã®é©ç”¨</h4>

<p>æ©Ÿæ¢°å­¦ç¿’ã«ãŠã‘ã‚‹è§£é‡ˆå•é¡Œã§ã¯ï¼š</p>
<ul>
<li><strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</strong>ï¼šç‰¹å¾´é‡ï¼ˆfeaturesï¼‰</li>
<li><strong>ä¾¡å€¤</strong>ï¼šäºˆæ¸¬å€¤ï¼ˆpredictionï¼‰</li>
<li><strong>é€£æº</strong>ï¼šç‰¹å¾´é‡ã®éƒ¨åˆ†é›†åˆ</li>
</ul>

<div class="mermaid">
graph TB
    GameTheory["å”åŠ›ã‚²ãƒ¼ãƒ ç†è«–<br/>N: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼, v: ä¾¡å€¤é–¢æ•°"] --> Shapley["Shapleyå€¤<br/>å…¬å¹³ãªè²¢çŒ®åº¦åˆ†é…"]
    Shapley --> ML["æ©Ÿæ¢°å­¦ç¿’è§£é‡ˆ<br/>ç‰¹å¾´é‡ã®å¯„ä¸åº¦"]
    ML --> SHAP["SHAP<br/>çµ±ä¸€çš„è§£é‡ˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯"]

    style GameTheory fill:#b3e5fc
    style Shapley fill:#c5e1a5
    style ML fill:#fff9c4
    style SHAP fill:#ffab91
</div>

<h3>Shapleyå€¤ã®å®šç¾©</h3>

<p>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ $i$ ã®<strong>Shapleyå€¤</strong>ã¯ã€ã™ã¹ã¦ã®å¯èƒ½ãªé€£æºã¸ã®è²¢çŒ®ã®å¹³å‡ã¨ã—ã¦å®šç¾©ã•ã‚Œã¾ã™ï¼š</p>

$$
\phi_i(v) = \sum_{S \subseteq N \setminus \{i\}} \frac{|S|! \cdot (|N| - |S| - 1)!}{|N|!} \left[ v(S \cup \{i\}) - v(S) \right]
$$

<p>ã“ã“ã§ï¼š</p>
<ul>
<li>$S$ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ $i$ ã‚’å«ã¾ãªã„é€£æº</li>
<li>$v(S \cup \{i\}) - v(S)$ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ $i$ ã®é™ç•Œè²¢çŒ®ï¼ˆmarginal contributionï¼‰</li>
<li>$\frac{|S|! \cdot (|N| - |S| - 1)!}{|N|!}$ï¼šé‡ã¿ï¼ˆã™ã¹ã¦ã®é †åºã‚’è€ƒæ…®ï¼‰</li>
</ul>

<h3>Shapleyå€¤ã®æ€§è³ªï¼ˆå…¬ç†ï¼‰</h3>

<p>Shapleyå€¤ã¯ã€ä»¥ä¸‹ã®4ã¤ã®å…¬ç†ã‚’æº€ãŸã™<strong>å”¯ä¸€ã®è§£</strong>ã§ã™ï¼š</p>

<table>
<thead>
<tr>
<th>å…¬ç†</th>
<th>æ•°å­¦çš„è¡¨ç¾</th>
<th>æ„å‘³</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>åŠ¹ç‡æ€§ï¼ˆEfficiencyï¼‰</strong></td>
<td>$\sum_{i=1}^{n} \phi_i(v) = v(N)$</td>
<td>å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è²¢çŒ®ã®åˆè¨ˆ = ç·ä¾¡å€¤</td>
</tr>
<tr>
<td><strong>å¯¾ç§°æ€§ï¼ˆSymmetryï¼‰</strong></td>
<td>$v(S \cup \{i\}) = v(S \cup \{j\})$ ãªã‚‰ã° $\phi_i = \phi_j$</td>
<td>åŒã˜è²¢çŒ®ãªã‚‰åŒã˜å ±é…¬</td>
</tr>
<tr>
<td><strong>ãƒ€ãƒŸãƒ¼æ€§ï¼ˆDummyï¼‰</strong></td>
<td>$v(S \cup \{i\}) = v(S)$ ãªã‚‰ã° $\phi_i = 0$</td>
<td>è²¢çŒ®ãŒãªã„ãªã‚‰å ±é…¬ã‚‚ã‚¼ãƒ­</td>
</tr>
<tr>
<td><strong>åŠ æ³•æ€§ï¼ˆAdditivityï¼‰</strong></td>
<td>$\phi_i(v + w) = \phi_i(v) + \phi_i(w)$</td>
<td>ç‹¬ç«‹ã—ãŸã‚²ãƒ¼ãƒ ã¯åˆ†è§£å¯èƒ½</td>
</tr>
</tbody>
</table>

<h3>è¨ˆç®—ã®è¤‡é›‘æ€§</h3>

<p>Shapleyå€¤ã®æ­£ç¢ºãªè¨ˆç®—ã¯ã€$2^n$ å€‹ã®é€£æºã‚’è©•ä¾¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€<strong>æŒ‡æ•°æ™‚é–“è¨ˆç®—é‡</strong> $O(2^n)$ ã¨ãªã‚Šã¾ã™ã€‚</p>

<pre><code class="language-python">import numpy as np
from itertools import combinations

def shapley_value_exact(n, value_function):
    """
    Shapleyå€¤ã®å³å¯†è¨ˆç®—ï¼ˆå°è¦æ¨¡ãªç‰¹å¾´é‡æ•°ã®ã¿ï¼‰

    Args:
        n: ç‰¹å¾´é‡æ•°
        value_function: éƒ¨åˆ†é›†åˆ S ã«å¯¾ã™ã‚‹ä¾¡å€¤ã‚’è¿”ã™é–¢æ•°

    Returns:
        shapley_values: (n,) Shapleyå€¤
    """
    players = list(range(n))
    shapley_values = np.zeros(n)

    # å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¤ã„ã¦
    for i in players:
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼iã‚’é™¤ãä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
        others = [p for p in players if p != i]

        # ã™ã¹ã¦ã®å¯èƒ½ãªé€£æºSã«ã¤ã„ã¦
        for r in range(len(others) + 1):
            for S in combinations(others, r):
                S = list(S)

                # é™ç•Œè²¢çŒ®: v(S âˆª {i}) - v(S)
                marginal_contribution = value_function(S + [i]) - value_function(S)

                # é‡ã¿: |S|! * (n - |S| - 1)! / n!
                weight = (np.math.factorial(len(S)) *
                         np.math.factorial(n - len(S) - 1) /
                         np.math.factorial(n))

                shapley_values[i] += weight * marginal_contribution

    return shapley_values


# ç°¡å˜ãªä¾‹ï¼š3ç‰¹å¾´é‡
print("=== Shapleyå€¤ã®å³å¯†è¨ˆç®— ===")
n = 3

# ä¾¡å€¤é–¢æ•°ã®ä¾‹ï¼ˆç·šå½¢ãƒ¢ãƒ‡ãƒ«ï¼‰
def value_func(S):
    """ç‰¹å¾´é‡ã®éƒ¨åˆ†é›†åˆSã«å¯¾ã™ã‚‹äºˆæ¸¬å€¤"""
    # ç°¡ç•¥åŒ–ï¼šå„ç‰¹å¾´é‡ã®é‡ã¿ãŒ [1, 2, 3]
    weights = np.array([1.0, 2.0, 3.0])
    if len(S) == 0:
        return 0.0
    return weights[S].sum()

# Shapleyå€¤ã‚’è¨ˆç®—
shapley = shapley_value_exact(n, value_func)

print(f"ç‰¹å¾´é‡æ•°: {n}")
print(f"Shapleyå€¤: {shapley}")
print(f"åˆè¨ˆ: {shapley.sum()} (= v(N) = {value_func([0, 1, 2])})")
print("\nâ†’ åŠ¹ç‡æ€§å…¬ç†ã‚’æº€ãŸã™ï¼šåˆè¨ˆ = ç·ä¾¡å€¤")
</code></pre>

<h3>è¨ˆç®—é‡ã®å•é¡Œ</h3>

<pre><code class="language-python">import matplotlib.pyplot as plt
import numpy as np

# è¨ˆç®—é‡ã®å¯è¦–åŒ–
n_features = np.arange(1, 21)
num_coalitions = 2 ** n_features

plt.figure(figsize=(10, 6))
plt.semilogy(n_features, num_coalitions, 'o-', linewidth=2, markersize=8)
plt.xlabel('Number of Features', fontsize=12)
plt.ylabel('Number of Coalitions (log scale)', fontsize=12)
plt.title('Computational Complexity of Exact Shapley Value', fontsize=14)
plt.grid(True, alpha=0.3)

# å‚è€ƒç·š
plt.axhline(y=1e6, color='r', linestyle='--', label='1 million')
plt.axhline(y=1e9, color='orange', linestyle='--', label='1 billion')

plt.legend()
plt.tight_layout()
plt.savefig('shapley_complexity.png', dpi=150, bbox_inches='tight')
print("è¨ˆç®—é‡ã®å›³ã‚’ä¿å­˜: shapley_complexity.png")
plt.close()

print("\n=== è¨ˆç®—é‡ã®ä¾‹ ===")
for n in [5, 10, 15, 20, 30]:
    coalitions = 2 ** n
    print(f"ç‰¹å¾´é‡æ•° {n:2d}: {coalitions:,} å€‹ã®é€£æº")

print("\nâ†’ ç‰¹å¾´é‡ãŒå¢—ãˆã‚‹ã¨è¨ˆç®—ãŒä¸å¯èƒ½ã«ãªã‚‹")
print("â†’ è¿‘ä¼¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆKernelSHAP, TreeSHAPãªã©ï¼‰ãŒå¿…è¦")
</code></pre>

<hr>

<h2>2.2 SHAPå€¤</h2>

<h3>Additive Feature Attribution</h3>

<p><strong>SHAP (SHapley Additive exPlanations)</strong>ã¯ã€Shapleyå€¤ã‚’æ©Ÿæ¢°å­¦ç¿’ã®è§£é‡ˆã«é©ç”¨ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚</p>

<p>äºˆæ¸¬å€¤ $f(x)$ ã«å¯¾ã™ã‚‹èª¬æ˜ãƒ¢ãƒ‡ãƒ« $g$ ã¯ã€ä»¥ä¸‹ã®å½¢å¼ã‚’æŒã¡ã¾ã™ï¼š</p>

$$
g(z') = \phi_0 + \sum_{i=1}^{M} \phi_i z'_i
$$

<p>ã“ã“ã§ï¼š</p>
<ul>
<li>$z' \in \{0, 1\}^M$ï¼šç°¡ç•¥åŒ–ã•ã‚ŒãŸå…¥åŠ›ï¼ˆç‰¹å¾´é‡ã®æœ‰ç„¡ï¼‰</li>
<li>$\phi_i$ï¼šç‰¹å¾´é‡ $i$ ã®SHAPå€¤ï¼ˆå¯„ä¸åº¦ï¼‰</li>
<li>$\phi_0 = \mathbb{E}[f(X)]$ï¼šãƒ™ãƒ¼ã‚¹å€¤ï¼ˆå…¨ä½“ã®æœŸå¾…å€¤ï¼‰</li>
</ul>

<h3>SHAPå€¤ã®å®šç¾©</h3>

<p>å…¥åŠ› $x$ ã«å¯¾ã™ã‚‹ç‰¹å¾´é‡ $i$ ã®SHAPå€¤ã¯ï¼š</p>

$$
\phi_i(f, x) = \sum_{S \subseteq F \setminus \{i\}} \frac{|S|! \cdot (|F| - |S| - 1)!}{|F|!} \left[ f_x(S \cup \{i\}) - f_x(S) \right]
$$

<p>ã“ã“ã§ï¼š</p>
<ul>
<li>$F = \{1, 2, \ldots, M\}$ï¼šã™ã¹ã¦ã®ç‰¹å¾´é‡ã®é›†åˆ</li>
<li>$f_x(S)$ï¼šç‰¹å¾´é‡ã®éƒ¨åˆ†é›†åˆ $S$ ã®ã¿ã‚’ä½¿ã£ãŸäºˆæ¸¬ï¼ˆä»–ã¯æœŸå¾…å€¤ã§ç½®æ›ï¼‰</li>
</ul>

<h3>SHAPå€¤ã®è¨ˆç®—</h3>

<p>å®Ÿéš›ã«ã¯ã€æ¬ æã—ãŸç‰¹å¾´é‡ã‚’<strong>æœŸå¾…å€¤ã§æ¡ä»¶ä»˜ã‘ã¦</strong>è¨ˆç®—ã—ã¾ã™ï¼š</p>

$$
f_x(S) = \mathbb{E}[f(X) \mid X_S = x_S]
$$

<p>ã“ã®æœŸå¾…å€¤ã‚’è¨ˆç®—ã™ã‚‹æ–¹æ³•ã«ã‚ˆã£ã¦ã€ç•°ãªã‚‹SHAPã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒå­˜åœ¨ã—ã¾ã™ã€‚</p>

<div class="mermaid">
graph TB
    SHAP["SHAP<br/>çµ±ä¸€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯"] --> TreeSHAP["TreeSHAP<br/>æ±ºå®šæœ¨ãƒ¢ãƒ‡ãƒ«<br/>å¤šé …å¼æ™‚é–“"]
    SHAP --> KernelSHAP["KernelSHAP<br/>ä»»æ„ã®ãƒ¢ãƒ‡ãƒ«<br/>ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¿‘ä¼¼"]
    SHAP --> DeepSHAP["DeepSHAP<br/>ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°<br/>å‹¾é…ãƒ™ãƒ¼ã‚¹"]
    SHAP --> LinearSHAP["LinearSHAP<br/>ç·šå½¢ãƒ¢ãƒ‡ãƒ«<br/>è§£æçš„è¨ˆç®—"]

    style SHAP fill:#ffab91
    style TreeSHAP fill:#c5e1a5
    style KernelSHAP fill:#fff9c4
    style DeepSHAP fill:#b3e5fc
</div>

<h3>TreeSHAPã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </h3>

<p><strong>TreeSHAP</strong>ã¯ã€æ±ºå®šæœ¨ãƒ™ãƒ¼ã‚¹ã®ãƒ¢ãƒ‡ãƒ«ï¼ˆæ±ºå®šæœ¨ã€ãƒ©ãƒ³ãƒ€ãƒ ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆã€XGBoostã€LightGBMãªã©ï¼‰ã«å¯¾ã™ã‚‹åŠ¹ç‡çš„ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚</p>

<p>ç‰¹å¾´ï¼š</p>
<ul>
<li>è¨ˆç®—é‡ï¼š$O(TLD^2)$ï¼ˆ$T$: æœ¨ã®æ•°ã€$L$: è‘‰ã®æ•°ã€$D$: æ·±ã•ï¼‰</li>
<li>å³å¯†ãªShapleyå€¤ã‚’è¨ˆç®—</li>
<li>æœ¨æ§‹é€ ã‚’åˆ©ç”¨ã—ãŸé«˜é€ŸåŒ–</li>
</ul>

<h3>KernelSHAP</h3>

<p><strong>KernelSHAP</strong>ã¯ã€ä»»æ„ã®ãƒ¢ãƒ‡ãƒ«ã«é©ç”¨å¯èƒ½ãªè¿‘ä¼¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚</p>

<p>ã‚¢ã‚¤ãƒ‡ã‚¢ï¼š</p>
<ol>
<li>ãƒ©ãƒ³ãƒ€ãƒ ã«ç‰¹å¾´é‡ã®éƒ¨åˆ†é›†åˆã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°</li>
<li>å„éƒ¨åˆ†é›†åˆã§äºˆæ¸¬ã‚’è¨ˆç®—</li>
<li>é‡ã¿ä»˜ãç·šå½¢å›å¸°ã§SHAPå€¤ã‚’æ¨å®š</li>
</ol>

<p>é‡ã¿é–¢æ•°ï¼š</p>

$$
\pi_{x}(z') = \frac{(M-1)}{\binom{M}{|z'|} |z'|(M - |z'|)}
$$

<hr>

<h2>2.3 SHAPå¯è¦–åŒ–</h2>

<h3>Waterfall Plots</h3>

<p><strong>Waterfall plot</strong>ã¯ã€1ã¤ã®ã‚µãƒ³ãƒ—ãƒ«ã«ã¤ã„ã¦ã€ãƒ™ãƒ¼ã‚¹å€¤ã‹ã‚‰æœ€çµ‚äºˆæ¸¬å€¤ã¾ã§ã®å„ç‰¹å¾´é‡ã®å¯„ä¸ã‚’æ»ã®ã‚ˆã†ã«è¡¨ç¤ºã—ã¾ã™ã€‚</p>

<pre><code class="language-python">import shap
import numpy as np
from sklearn.ensemble import RandomForestClassifier
from sklearn.datasets import load_breast_cancer

# ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿
print("=== Breast Cancerãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®æº–å‚™ ===")
X, y = load_breast_cancer(return_X_y=True, as_frame=True)
print(f"ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: {X.shape}")
print(f"ç‰¹å¾´é‡æ•°: {X.shape[1]}")

# ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´
print("\n=== ãƒ©ãƒ³ãƒ€ãƒ ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆã®è¨“ç·´ ===")
model = RandomForestClassifier(n_estimators=100, random_state=42, max_depth=5)
model.fit(X, y)

train_acc = model.score(X, y)
print(f"è¨“ç·´ç²¾åº¦: {train_acc:.4f}")

# TreeExplainerã®ä½œæˆ
print("\n=== TreeExplainerã®ä½œæˆ ===")
explainer = shap.TreeExplainer(model)

# 1ã¤ã®ã‚µãƒ³ãƒ—ãƒ«ã®SHAPå€¤ã‚’è¨ˆç®—
sample_idx = 0
shap_values = explainer(X.iloc[[sample_idx]])

print(f"ã‚µãƒ³ãƒ—ãƒ« {sample_idx} ã®SHAPå€¤:")
print(f"  å½¢çŠ¶: {shap_values.values.shape}")
print(f"  ãƒ™ãƒ¼ã‚¹å€¤: {shap_values.base_values[0]:.4f}")
print(f"  äºˆæ¸¬å€¤: {shap_values.base_values[0] + shap_values.values[0].sum():.4f}")

# Waterfall plotã®ä½œæˆ
print("\n=== Waterfall Plotã®ä½œæˆ ===")
shap.plots.waterfall(shap_values[0], show=False)
import matplotlib.pyplot as plt
plt.tight_layout()
plt.savefig('shap_waterfall.png', dpi=150, bbox_inches='tight')
print("Waterfall plotã‚’ä¿å­˜: shap_waterfall.png")
plt.close()
</code></pre>

<h3>Force Plots</h3>

<p><strong>Force plot</strong>ã¯ã€Waterfall plotã¨åŒæ§˜ã«1ã‚µãƒ³ãƒ—ãƒ«ã®èª¬æ˜ã‚’è¦–è¦šåŒ–ã—ã¾ã™ãŒã€æ­£è² ã®å¯„ä¸ã‚’æ¨ªã«ä¸¦ã¹ã¦è¡¨ç¤ºã—ã¾ã™ã€‚</p>

<pre><code class="language-python">import shap
import matplotlib.pyplot as plt

print("\n=== Force Plotã®ä½œæˆ ===")

# Force plotï¼ˆé™çš„ç‰ˆï¼‰
shap.plots.force(
    shap_values.base_values[0],
    shap_values.values[0],
    X.iloc[sample_idx],
    matplotlib=True,
    show=False
)
plt.tight_layout()
plt.savefig('shap_force.png', dpi=150, bbox_inches='tight')
print("Force plotã‚’ä¿å­˜: shap_force.png")
plt.close()

print("\nâ†’ èµ¤è‰²: äºˆæ¸¬ã‚’å¢—åŠ ã•ã›ã‚‹ç‰¹å¾´é‡")
print("â†’ é’è‰²: äºˆæ¸¬ã‚’æ¸›å°‘ã•ã›ã‚‹ç‰¹å¾´é‡")
</code></pre>

<h3>Summary Plots</h3>

<p><strong>Summary plot</strong>ã¯ã€ã™ã¹ã¦ã®ã‚µãƒ³ãƒ—ãƒ«ã®SHAPå€¤ã‚’é›†ç´„ã—ã¦ã€å„ç‰¹å¾´é‡ã®é‡è¦åº¦ã¨åŠ¹æœã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>

<pre><code class="language-python">import shap
import matplotlib.pyplot as plt

print("\n=== Summary Plotã®ä½œæˆ ===")

# å…¨ã‚µãƒ³ãƒ—ãƒ«ã®SHAPå€¤ã‚’è¨ˆç®—ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆã¯ã‚µãƒ–ã‚»ãƒƒãƒˆä½¿ç”¨ï¼‰
shap_values_all = explainer(X[:100])  # æœ€åˆã®100ã‚µãƒ³ãƒ—ãƒ«

# Summary plotï¼ˆbee swarm plotï¼‰
shap.summary_plot(shap_values_all, X[:100], show=False)
plt.tight_layout()
plt.savefig('shap_summary.png', dpi=150, bbox_inches='tight')
print("Summary plotã‚’ä¿å­˜: shap_summary.png")
plt.close()

print("\nâ†’ å„ç‚¹ã¯1ã‚µãƒ³ãƒ—ãƒ«")
print("â†’ æ¨ªè»¸: SHAPå€¤ï¼ˆå¯„ä¸åº¦ï¼‰")
print("â†’ è‰²: ç‰¹å¾´é‡ã®å€¤ï¼ˆèµ¤=é«˜ã€é’=ä½ï¼‰")
</code></pre>

<h3>Bar Plotsï¼ˆç‰¹å¾´é‡é‡è¦åº¦ï¼‰</h3>

<pre><code class="language-python">import shap
import matplotlib.pyplot as plt

print("\n=== Bar Plotï¼ˆç‰¹å¾´é‡é‡è¦åº¦ï¼‰===")

# å¹³å‡çµ¶å¯¾SHAPå€¤ã§ã‚½ãƒ¼ãƒˆ
shap.plots.bar(shap_values_all, show=False)
plt.tight_layout()
plt.savefig('shap_bar.png', dpi=150, bbox_inches='tight')
print("Bar plotã‚’ä¿å­˜: shap_bar.png")
plt.close()

# æ‰‹å‹•ã§è¨ˆç®—
mean_abs_shap = np.abs(shap_values_all.values).mean(axis=0)
feature_importance = sorted(
    zip(X.columns, mean_abs_shap),
    key=lambda x: x[1],
    reverse=True
)

print("\nç‰¹å¾´é‡é‡è¦åº¦ï¼ˆä¸Šä½10ï¼‰:")
for i, (feature, importance) in enumerate(feature_importance[:10]):
    print(f"{i+1:2d}. {feature:25s}: {importance:.4f}")
</code></pre>

<h3>Dependence Plots</h3>

<p><strong>Dependence plot</strong>ã¯ã€1ã¤ã®ç‰¹å¾´é‡ã®å€¤ã¨ãã®SHAPå€¤ã®é–¢ä¿‚ã‚’æ•£å¸ƒå›³ã§è¡¨ç¤ºã—ã¾ã™ã€‚</p>

<pre><code class="language-python">import shap
import matplotlib.pyplot as plt

print("\n=== Dependence Plotã®ä½œæˆ ===")

# æœ€ã‚‚é‡è¦ãªç‰¹å¾´é‡ã‚’é¸æŠ
top_feature = feature_importance[0][0]
print(f"åˆ†æå¯¾è±¡: {top_feature}")

# Dependence plot
shap.dependence_plot(
    top_feature,
    shap_values_all.values,
    X[:100],
    show=False
)
plt.tight_layout()
plt.savefig('shap_dependence.png', dpi=150, bbox_inches='tight')
print("Dependence plotã‚’ä¿å­˜: shap_dependence.png")
plt.close()

print("\nâ†’ æ¨ªè»¸: ç‰¹å¾´é‡ã®å€¤")
print("â†’ ç¸¦è»¸: SHAPå€¤ï¼ˆãã®ç‰¹å¾´é‡ã®å¯„ä¸åº¦ï¼‰")
print("â†’ éç·šå½¢é–¢ä¿‚ã‚„ç›¸äº’ä½œç”¨ã‚’ç™ºè¦‹ã§ãã‚‹")
</code></pre>

<hr>

<h2>2.4 SHAPãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å®Ÿè·µ</h2>

<h3>TreeExplainerï¼ˆæ±ºå®šæœ¨ãƒ¢ãƒ‡ãƒ«ï¼‰</h3>

<p><strong>TreeExplainer</strong>ã¯ã€æ±ºå®šæœ¨ãƒ™ãƒ¼ã‚¹ã®ãƒ¢ãƒ‡ãƒ«ï¼ˆRandomForestã€XGBoostã€LightGBMã€CatBoostãªã©ï¼‰ã«å¯¾ã™ã‚‹æœ€ã‚‚åŠ¹ç‡çš„ãªExplainerã§ã™ã€‚</p>

<pre><code class="language-python">import shap
import xgboost as xgb
from sklearn.datasets import load_boston
from sklearn.model_selection import train_test_split
import numpy as np

# ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆBoston Housing - å›å¸°ã‚¿ã‚¹ã‚¯ï¼‰
print("=== Boston Housingãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ ===")
# Note: load_boston is deprecated, using California housing as alternative
from sklearn.datasets import fetch_california_housing
data = fetch_california_housing(as_frame=True)
X, y = data.data, data.target

print(f"ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: {X.shape}")
print(f"ç‰¹å¾´é‡: {list(X.columns)}")

# è¨“ç·´/ãƒ†ã‚¹ãƒˆåˆ†å‰²
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# XGBoostãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´
print("\n=== XGBoostãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ ===")
model = xgb.XGBRegressor(
    n_estimators=100,
    max_depth=5,
    learning_rate=0.1,
    random_state=42
)
model.fit(X_train, y_train)

train_score = model.score(X_train, y_train)
test_score = model.score(X_test, y_test)
print(f"è¨“ç·´ RÂ²: {train_score:.4f}")
print(f"ãƒ†ã‚¹ãƒˆ RÂ²: {test_score:.4f}")

# TreeExplainerã®ä½¿ç”¨
print("\n=== TreeExplainerã®ä½¿ç”¨ ===")
explainer = shap.TreeExplainer(model)

# SHAPå€¤ã®è¨ˆç®—
shap_values = explainer(X_test)

print(f"SHAPå€¤ã®å½¢çŠ¶: {shap_values.values.shape}")
print(f"ãƒ™ãƒ¼ã‚¹å€¤: {shap_values.base_values[0]:.4f}")

# Summary plot
shap.summary_plot(shap_values, X_test, show=False)
import matplotlib.pyplot as plt
plt.tight_layout()
plt.savefig('xgboost_shap_summary.png', dpi=150, bbox_inches='tight')
print("Summary plotã‚’ä¿å­˜: xgboost_shap_summary.png")
plt.close()
</code></pre>

<h3>LinearExplainerï¼ˆç·šå½¢ãƒ¢ãƒ‡ãƒ«ï¼‰</h3>

<p><strong>LinearExplainer</strong>ã¯ã€ç·šå½¢ãƒ¢ãƒ‡ãƒ«ï¼ˆç·šå½¢å›å¸°ã€ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ãªã©ï¼‰ã«å¯¾ã™ã‚‹è§£æçš„ãªExplainerã§ã™ã€‚</p>

<pre><code class="language-python">import shap
from sklearn.linear_model import LogisticRegression
from sklearn.datasets import load_iris
from sklearn.model_selection import train_test_split

print("\n=== LinearExplainerï¼ˆãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ï¼‰===")

# Irisãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
X, y = load_iris(return_X_y=True, as_frame=True)
# 2ã‚¯ãƒ©ã‚¹åˆ†é¡ã«ç°¡ç•¥åŒ–
X = X[y != 2]
y = y[y != 2]

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.3, random_state=42
)

# ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°
model = LogisticRegression()
model.fit(X_train, y_train)

print(f"ãƒ†ã‚¹ãƒˆç²¾åº¦: {model.score(X_test, y_test):.4f}")

# LinearExplainer
explainer = shap.LinearExplainer(model, X_train)
shap_values = explainer(X_test)

print(f"SHAPå€¤ã®å½¢çŠ¶: {shap_values.values.shape}")

# Waterfall plotï¼ˆ1ã‚µãƒ³ãƒ—ãƒ«ï¼‰
shap.plots.waterfall(shap_values[0], show=False)
plt.tight_layout()
plt.savefig('linear_shap_waterfall.png', dpi=150, bbox_inches='tight')
print("Waterfall plotã‚’ä¿å­˜: linear_shap_waterfall.png")
plt.close()
</code></pre>

<h3>KernelExplainerï¼ˆä»»æ„ã®ãƒ¢ãƒ‡ãƒ«ï¼‰</h3>

<p><strong>KernelExplainer</strong>ã¯ã€ä»»æ„ã®ãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ¢ãƒ‡ãƒ«å«ã‚€ï¼‰ã«é©ç”¨ã§ãã¾ã™ãŒã€è¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„ã§ã™ã€‚</p>

<pre><code class="language-python">import shap
from sklearn.ensemble import GradientBoostingClassifier
from sklearn.datasets import load_wine
import numpy as np

print("\n=== KernelExplainerï¼ˆä»»æ„ã®ãƒ¢ãƒ‡ãƒ«ï¼‰===")

# Wineãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
X, y = load_wine(return_X_y=True, as_frame=True)

# ãƒ¢ãƒ‡ãƒ«è¨“ç·´
model = GradientBoostingClassifier(n_estimators=50, random_state=42)
model.fit(X, y)

print(f"è¨“ç·´ç²¾åº¦: {model.score(X, y):.4f}")

# KernelExplainerï¼ˆè¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„ã®ã§å°ã‚µãƒ³ãƒ—ãƒ«ä½¿ç”¨ï¼‰
print("\n=== KernelExplainerã®ä½œæˆï¼ˆèƒŒæ™¯ãƒ‡ãƒ¼ã‚¿: 50ã‚µãƒ³ãƒ—ãƒ«ï¼‰===")
background = shap.sample(X, 50)  # èƒŒæ™¯ãƒ‡ãƒ¼ã‚¿
explainer = shap.KernelExplainer(model.predict_proba, background)

# SHAPå€¤ã®è¨ˆç®—ï¼ˆ3ã‚µãƒ³ãƒ—ãƒ«ã®ã¿ï¼‰
print("SHAPå€¤ã‚’è¨ˆç®—ä¸­ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰...")
test_samples = X.iloc[:3]
shap_values = explainer.shap_values(test_samples)

print(f"SHAPå€¤ã®å½¢çŠ¶: {np.array(shap_values).shape}")
print("â†’ (ã‚¯ãƒ©ã‚¹æ•°, ã‚µãƒ³ãƒ—ãƒ«æ•°, ç‰¹å¾´é‡æ•°)")

# Force plotï¼ˆã‚¯ãƒ©ã‚¹0ï¼‰
shap.force_plot(
    explainer.expected_value[0],
    shap_values[0][0],
    test_samples.iloc[0],
    matplotlib=True,
    show=False
)
plt.tight_layout()
plt.savefig('kernel_shap_force.png', dpi=150, bbox_inches='tight')
print("Force plotã‚’ä¿å­˜: kernel_shap_force.png")
plt.close()

print("\nâ†’ KernelSHAPã¯é…ã„ãŒã€ä»»æ„ã®ãƒ¢ãƒ‡ãƒ«ã«é©ç”¨å¯èƒ½")
</code></pre>

<h3>DeepExplainerï¼ˆãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰</h3>

<p><strong>DeepExplainer</strong>ã¯ã€ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ï¼ˆTensorFlowã€PyTorchãªã©ï¼‰ã«å¯¾ã™ã‚‹åŠ¹ç‡çš„ãªExplainerã§ã™ã€‚</p>

<pre><code class="language-python">import shap
import torch
import torch.nn as nn
from sklearn.datasets import make_classification
from sklearn.model_selection import train_test_split
import numpy as np

print("\n=== DeepExplainerï¼ˆPyTorchãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰===")

# ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
X, y = make_classification(
    n_samples=1000,
    n_features=20,
    n_informative=15,
    n_classes=2,
    random_state=42
)

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# PyTorchãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
X_train_t = torch.FloatTensor(X_train)
y_train_t = torch.LongTensor(y_train)
X_test_t = torch.FloatTensor(X_test)

# ç°¡å˜ãªãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
class SimpleNN(nn.Module):
    def __init__(self, input_dim):
        super(SimpleNN, self).__init__()
        self.fc1 = nn.Linear(input_dim, 64)
        self.fc2 = nn.Linear(64, 32)
        self.fc3 = nn.Linear(32, 2)

    def forward(self, x):
        x = torch.relu(self.fc1(x))
        x = torch.relu(self.fc2(x))
        x = self.fc3(x)
        return x

model = SimpleNN(input_dim=20)

# è¨“ç·´ï¼ˆç°¡ç•¥ç‰ˆï¼‰
criterion = nn.CrossEntropyLoss()
optimizer = torch.optim.Adam(model.parameters(), lr=0.001)

for epoch in range(50):
    optimizer.zero_grad()
    outputs = model(X_train_t)
    loss = criterion(outputs, y_train_t)
    loss.backward()
    optimizer.step()

# è©•ä¾¡
model.eval()
with torch.no_grad():
    outputs = model(X_test_t)
    _, predicted = torch.max(outputs, 1)
    accuracy = (predicted == torch.LongTensor(y_test)).float().mean()
    print(f"ãƒ†ã‚¹ãƒˆç²¾åº¦: {accuracy:.4f}")

# DeepExplainer
print("\n=== DeepExplainerã®ä½¿ç”¨ ===")
background = X_train_t[:100]  # èƒŒæ™¯ãƒ‡ãƒ¼ã‚¿
explainer = shap.DeepExplainer(model, background)

# SHAPå€¤ã®è¨ˆç®—
test_samples = X_test_t[:10]
shap_values = explainer.shap_values(test_samples)

print(f"SHAPå€¤ã®å½¢çŠ¶: {np.array(shap_values).shape}")

# Summary plotï¼ˆã‚¯ãƒ©ã‚¹1ï¼‰
shap.summary_plot(
    shap_values[1],
    test_samples.numpy(),
    show=False
)
plt.tight_layout()
plt.savefig('deep_shap_summary.png', dpi=150, bbox_inches='tight')
print("Summary plotã‚’ä¿å­˜: deep_shap_summary.png")
plt.close()
</code></pre>

<hr>

<h2>2.5 SHAPã®å¿œç”¨ã¨é™ç•Œ</h2>

<h3>ãƒ¢ãƒ‡ãƒ«è¨ºæ–­</h3>

<p>SHAPã‚’ä½¿ã£ã¦ã€ãƒ¢ãƒ‡ãƒ«ã®å•é¡Œç‚¹ã‚’è¨ºæ–­ã§ãã¾ã™ï¼š</p>

<pre><code class="language-python">import shap
import numpy as np
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestClassifier
from sklearn.datasets import make_classification

print("=== SHAPã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«è¨ºæ–­ ===")

# æ„å›³çš„ã«ãƒã‚¤ã‚¢ã‚¹ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
np.random.seed(42)
n_samples = 1000
X = np.random.randn(n_samples, 10)

# ç‰¹å¾´é‡0ã¨1ã ã‘ãŒçœŸã«é‡è¦
y = (X[:, 0] + X[:, 1] > 0).astype(int)

# ãƒã‚¤ã‚ºç‰¹å¾´é‡ã‚’è¿½åŠ ï¼ˆé«˜ã„ç›¸é–¢ã‚’æŒã¤ï¼‰
X[:, 2] = X[:, 0] + np.random.randn(n_samples) * 0.1  # ç‰¹å¾´é‡0ã¨ç›¸é–¢

# ãƒ¢ãƒ‡ãƒ«è¨“ç·´
model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X, y)

print(f"è¨“ç·´ç²¾åº¦: {model.score(X, y):.4f}")

# SHAPåˆ†æ
explainer = shap.TreeExplainer(model)
shap_values = explainer(X)

# ç‰¹å¾´é‡é‡è¦åº¦
mean_abs_shap = np.abs(shap_values.values).mean(axis=0)

plt.figure(figsize=(10, 6))
plt.bar(range(10), mean_abs_shap)
plt.xlabel('Feature Index')
plt.ylabel('Mean |SHAP value|')
plt.title('Feature Importance via SHAP')
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.savefig('shap_diagnosis.png', dpi=150, bbox_inches='tight')
print("è¨ºæ–­çµæœã‚’ä¿å­˜: shap_diagnosis.png")
plt.close()

print("\nç‰¹å¾´é‡é‡è¦åº¦:")
for i, importance in enumerate(mean_abs_shap):
    print(f"  ç‰¹å¾´é‡ {i}: {importance:.4f}")

print("\nâ†’ ç‰¹å¾´é‡2ï¼ˆç›¸é–¢ãƒã‚¤ã‚ºï¼‰ãŒé‡è¦ã¨èª¤èªã•ã‚Œã‚‹å¯èƒ½æ€§")
print("â†’ SHAPã§å¤šé‡å…±ç·šæ€§ã®å•é¡Œã‚’ç™ºè¦‹")
</code></pre>

<h3>ç‰¹å¾´é‡é¸æŠ</h3>

<p>SHAPã‚’ä½¿ã£ã¦ã€çœŸã«é‡è¦ãªç‰¹å¾´é‡ã‚’é¸æŠã§ãã¾ã™ï¼š</p>

<pre><code class="language-python">import shap
import numpy as np
from sklearn.ensemble import RandomForestRegressor
from sklearn.datasets import make_regression
from sklearn.model_selection import cross_val_score

print("\n=== SHAPã«ã‚ˆã‚‹ç‰¹å¾´é‡é¸æŠ ===")

# ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆ20ç‰¹å¾´é‡ã€ã†ã¡5ã¤ã ã‘ãŒé‡è¦ï¼‰
X, y = make_regression(
    n_samples=500,
    n_features=20,
    n_informative=5,
    noise=10.0,
    random_state=42
)

# åˆæœŸãƒ¢ãƒ‡ãƒ«
model = RandomForestRegressor(n_estimators=100, random_state=42)
model.fit(X, y)

# SHAPå€¤ã§ç‰¹å¾´é‡é‡è¦åº¦ã‚’è¨ˆç®—
explainer = shap.TreeExplainer(model)
shap_values = explainer(X)
mean_abs_shap = np.abs(shap_values.values).mean(axis=0)

# é‡è¦åº¦ã§ã‚½ãƒ¼ãƒˆ
feature_importance = sorted(
    enumerate(mean_abs_shap),
    key=lambda x: x[1],
    reverse=True
)

print("ç‰¹å¾´é‡é‡è¦åº¦ï¼ˆSHAPï¼‰:")
for i, (idx, importance) in enumerate(feature_importance[:10]):
    print(f"{i+1:2d}. ç‰¹å¾´é‡ {idx:2d}: {importance:.4f}")

# ä¸Šä½kå€‹ã®ç‰¹å¾´é‡ã§å†è¨“ç·´
for k in [5, 10, 15, 20]:
    top_features = [idx for idx, _ in feature_importance[:k]]
    X_selected = X[:, top_features]

    scores = cross_val_score(
        RandomForestRegressor(n_estimators=100, random_state=42),
        X_selected, y, cv=5, scoring='r2'
    )

    print(f"\nä¸Šä½ {k:2d} ç‰¹å¾´é‡: CV RÂ² = {scores.mean():.4f} Â± {scores.std():.4f}")

print("\nâ†’ ä¸Šä½5ç‰¹å¾´é‡ã§ååˆ†ãªæ€§èƒ½")
print("â†’ SHAPã§åŠ¹ç‡çš„ãªç‰¹å¾´é‡é¸æŠãŒå¯èƒ½")
</code></pre>

<h3>è¨ˆç®—ã‚³ã‚¹ãƒˆ</h3>

<p>SHAPã®è¨ˆç®—ã‚³ã‚¹ãƒˆã¯ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦å¤§ããç•°ãªã‚Šã¾ã™ï¼š</p>

<pre><code class="language-python">import shap
import numpy as np
import time
from sklearn.ensemble import RandomForestClassifier
from sklearn.datasets import make_classification

print("\n=== SHAPã®è¨ˆç®—ã‚³ã‚¹ãƒˆæ¯”è¼ƒ ===")

# ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’å¤‰ãˆã¦è¨ˆç®—æ™‚é–“ã‚’æ¸¬å®š
results = []

for n_samples in [100, 500, 1000, 2000]:
    X, y = make_classification(
        n_samples=n_samples,
        n_features=20,
        n_informative=15,
        random_state=42
    )

    # ãƒ¢ãƒ‡ãƒ«è¨“ç·´
    model = RandomForestClassifier(n_estimators=50, max_depth=5, random_state=42)
    model.fit(X, y)

    # TreeExplainer
    explainer_tree = shap.TreeExplainer(model)
    start = time.time()
    shap_values_tree = explainer_tree(X)
    time_tree = time.time() - start

    # KernelExplainerï¼ˆå°ã‚µãƒ³ãƒ—ãƒ«ã®ã¿ï¼‰
    if n_samples <= 500:
        background = shap.sample(X, 50)
        explainer_kernel = shap.KernelExplainer(model.predict_proba, background)
        test_samples = X[:10]  # 10ã‚µãƒ³ãƒ—ãƒ«ã®ã¿
        start = time.time()
        shap_values_kernel = explainer_kernel.shap_values(test_samples)
        time_kernel = time.time() - start
    else:
        time_kernel = np.nan

    results.append((n_samples, time_tree, time_kernel))
    print(f"ã‚µãƒ³ãƒ—ãƒ«æ•° {n_samples:4d}: TreeSHAP={time_tree:.3f}s, KernelSHAP={time_kernel:.3f}s")

print("\nâ†’ TreeSHAPã¯å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã§ã‚‚é«˜é€Ÿ")
print("â†’ KernelSHAPã¯å°è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã®ã¿å®Ÿç”¨çš„")
</code></pre>

<h3>è§£é‡ˆã®æ³¨æ„ç‚¹</h3>

<table>
<thead>
<tr>
<th>æ³¨æ„ç‚¹</th>
<th>èª¬æ˜</th>
<th>å¯¾ç­–</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å¤šé‡å…±ç·šæ€§</strong></td>
<td>ç›¸é–¢ã™ã‚‹ç‰¹å¾´é‡é–“ã§SHAPå€¤ãŒä¸å®‰å®š</td>
<td>ç›¸é–¢åˆ†æã¨ä½µç”¨ã€ç‰¹å¾´é‡ã®äº‹å‰é¸æŠ</td>
</tr>
<tr>
<td><strong>èƒŒæ™¯ãƒ‡ãƒ¼ã‚¿ã®é¸æŠ</strong></td>
<td>KernelSHAPã®çµæœãŒèƒŒæ™¯ãƒ‡ãƒ¼ã‚¿ã«ä¾å­˜</td>
<td>ä»£è¡¨çš„ãªã‚µãƒ³ãƒ—ãƒ«ã‚’é¸æŠã€è¤‡æ•°ã®èƒŒæ™¯ã§æ¤œè¨¼</td>
</tr>
<tr>
<td><strong>å¤–æŒ¿</strong></td>
<td>è¨“ç·´ãƒ‡ãƒ¼ã‚¿å¤–ã®é ˜åŸŸã§ä¿¡é ¼æ€§ä½ä¸‹</td>
<td>äºˆæ¸¬ã®ä¿¡é ¼åŒºé–“ã¨ä½µç”¨</td>
</tr>
<tr>
<td><strong>å› æœé–¢ä¿‚</strong></td>
<td>SHAPå€¤ã¯ç›¸é–¢ã§ã‚ã‚Šå› æœã§ã¯ãªã„</td>
<td>å› æœæ¨è«–æ‰‹æ³•ã¨ä½µç”¨</td>
</tr>
</tbody>
</table>

<hr>

<h2>æ¼”ç¿’å•é¡Œ</h2>

<details>
<summary><strong>æ¼”ç¿’1ï¼šTreeSHAPã¨KernelSHAPã®æ¯”è¼ƒ</strong></summary>

<p>åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨ãƒ¢ãƒ‡ãƒ«ã§ã€TreeSHAPã¨KernelSHAPã®SHAPå€¤ã‚’è¨ˆç®—ã—ã€çµæœã‚’æ¯”è¼ƒã—ã¦ãã ã•ã„ã€‚ã©ã®ç¨‹åº¦ä¸€è‡´ã—ã¾ã™ã‹ï¼Ÿ</p>

<pre><code class="language-python">import shap
from sklearn.ensemble import RandomForestClassifier

# TODO: ãƒ‡ãƒ¼ã‚¿ã¨ãƒ¢ãƒ‡ãƒ«ã‚’æº–å‚™
# TODO: TreeSHAPã¨KernelSHAPã§åŒã˜ã‚µãƒ³ãƒ—ãƒ«ã®SHAPå€¤ã‚’è¨ˆç®—
# TODO: SHAPå€¤ã®ç›¸é–¢ä¿‚æ•°ã‚’è¨ˆç®—
# TODO: æ•£å¸ƒå›³ã§æ¯”è¼ƒ
# æœŸå¾…: ã»ã¼ä¸€è‡´ã™ã‚‹ãŒã€KernelSHAPã¯è¿‘ä¼¼ã®ãŸã‚è‹¥å¹²ç•°ãªã‚‹
</code></pre>

</details>

<details>
<summary><strong>æ¼”ç¿’2ï¼šå¤šé‡å…±ç·šæ€§ã®å½±éŸ¿èª¿æŸ»</strong></summary>

<p>æ„å›³çš„ã«ç›¸é–¢ã™ã‚‹ç‰¹å¾´é‡ã‚’ä½œæˆã—ã€SHAPã§ã©ã®ã‚ˆã†ã«è§£é‡ˆã•ã‚Œã‚‹ã‹èª¿æŸ»ã—ã¦ãã ã•ã„ã€‚</p>

<pre><code class="language-python">import numpy as np
import shap

# TODO: X1ã¨X2ã‚’ä½œæˆï¼ˆX2 = X1 + ãƒã‚¤ã‚ºï¼‰
# TODO: y = f(X1)ã¨ã—ã¦ã€X2ã¯çœŸã«ã¯é–¢ä¿‚ãªã„
# TODO: ãƒ¢ãƒ‡ãƒ«ã‚’è¨“ç·´ã—ã€SHAPã§åˆ†æ
# TODO: X1ã¨X2ã®SHAPå€¤ã‚’æ¯”è¼ƒ
# åˆ†æ: ç›¸é–¢ã™ã‚‹ç‰¹å¾´é‡é–“ã§SHAPå€¤ãŒåˆ†æ•£ã•ã‚Œã‚‹
</code></pre>

</details>

<details>
<summary><strong>æ¼”ç¿’3ï¼šSHAPå€¤ã«ã‚ˆã‚‹ç•°å¸¸æ¤œçŸ¥</strong></summary>

<p>æ­£å¸¸ã‚µãƒ³ãƒ—ãƒ«ã¨ç•°å¸¸ã‚µãƒ³ãƒ—ãƒ«ã®SHAPå€¤ã®åˆ†å¸ƒã‚’æ¯”è¼ƒã—ã€ç•°å¸¸ã®åŸå› ã¨ãªã‚‹ç‰¹å¾´é‡ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚</p>

<pre><code class="language-python">import shap
from sklearn.ensemble import IsolationForest

# TODO: æ­£å¸¸ãƒ‡ãƒ¼ã‚¿ã¨ç•°å¸¸ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
# TODO: IsolationForestã§ç•°å¸¸æ¤œçŸ¥
# TODO: ç•°å¸¸ã‚µãƒ³ãƒ—ãƒ«ã®SHAPå€¤ã‚’åˆ†æ
# TODO: ã©ã®ç‰¹å¾´é‡ãŒç•°å¸¸ã®åŸå› ã‹ç‰¹å®š
# ãƒ’ãƒ³ãƒˆ: Summary plotã‚„Dependence plotã‚’æ´»ç”¨
</code></pre>

</details>

<details>
<summary><strong>æ¼”ç¿’4ï¼šæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã§ã®SHAPå¿œç”¨</strong></summary>

<p>æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹ï¼šéå»Næ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç¿Œæ—¥ã‚’äºˆæ¸¬ï¼‰ã«å¯¾ã—ã¦SHAPã‚’é©ç”¨ã—ã€ã©ã®æ™‚ç‚¹ã®æƒ…å ±ãŒé‡è¦ã‹åˆ†æã—ã¦ãã ã•ã„ã€‚</p>

<pre><code class="language-python">import numpy as np
import shap

# TODO: æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆï¼ˆä¾‹ï¼šæ ªä¾¡ã€æ°—æ¸©ãªã©ï¼‰
# TODO: ãƒ©ã‚°ç‰¹å¾´é‡ã‚’ä½œæˆï¼ˆt-1, t-2, ..., t-Nï¼‰
# TODO: ãƒ¢ãƒ‡ãƒ«ã§äºˆæ¸¬
# TODO: SHAPã§å„æ™‚ç‚¹ã®é‡è¦åº¦ã‚’åˆ†æ
# æœŸå¾…: ç›´è¿‘ã®æ™‚ç‚¹ãŒã‚ˆã‚Šé‡è¦ï¼ˆä¸€èˆ¬çš„ã«ï¼‰
</code></pre>

</details>

<details>
<summary><strong>æ¼”ç¿’5ï¼šSHAPã¨PFIï¼ˆPermutation Feature Importanceï¼‰ã®æ¯”è¼ƒ</strong></summary>

<p>SHAPã«ã‚ˆã‚‹ç‰¹å¾´é‡é‡è¦åº¦ã¨ã€Permutation Feature Importanceã‚’æ¯”è¼ƒã—ã€é•ã„ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚</p>

<pre><code class="language-python">import shap
from sklearn.inspection import permutation_importance

# TODO: ãƒ¢ãƒ‡ãƒ«ã‚’è¨“ç·´
# TODO: SHAPã§ç‰¹å¾´é‡é‡è¦åº¦ã‚’è¨ˆç®—
# TODO: Permutation Importanceã‚’è¨ˆç®—
# TODO: 2ã¤ã®é‡è¦åº¦ã®ç›¸é–¢ã‚’åˆ†æ
# TODO: é•ã„ãŒå¤§ãã„ç‰¹å¾´é‡ã‚’èª¿æŸ»
# åˆ†æ: SHAPã¯å±€æ‰€çš„ã€PFIã¯å¤§åŸŸçš„ãªé‡è¦åº¦
</code></pre>

</details>

<hr>

<h2>ã¾ã¨ã‚</h2>

<p>ã“ã®ç« ã§ã¯ã€SHAP (SHapley Additive exPlanations)ã®ç†è«–ã¨å®Ÿè·µã‚’å­¦ã³ã¾ã—ãŸã€‚</p>

<h3>é‡è¦ãƒã‚¤ãƒ³ãƒˆ</h3>

<ul>
<li><strong>Shapleyå€¤</strong>ï¼šå”åŠ›ã‚²ãƒ¼ãƒ ç†è«–ã«åŸºã¥ãå…¬å¹³ãªè²¢çŒ®åº¦è©•ä¾¡</li>
<li><strong>å…¬ç†çš„æ€§è³ª</strong>ï¼šåŠ¹ç‡æ€§ã€å¯¾ç§°æ€§ã€ãƒ€ãƒŸãƒ¼æ€§ã€åŠ æ³•æ€§ã‚’æº€ãŸã™å”¯ä¸€ã®è§£</li>
<li><strong>SHAP</strong>ï¼šShapleyå€¤ã‚’æ©Ÿæ¢°å­¦ç¿’ã®è§£é‡ˆã«é©ç”¨ã—ãŸçµ±ä¸€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯</li>
<li><strong>TreeSHAP</strong>ï¼šæ±ºå®šæœ¨ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã™ã‚‹åŠ¹ç‡çš„ãªå³å¯†è¨ˆç®—</li>
<li><strong>KernelSHAP</strong>ï¼šä»»æ„ã®ãƒ¢ãƒ‡ãƒ«ã«é©ç”¨å¯èƒ½ãªè¿‘ä¼¼æ‰‹æ³•</li>
<li><strong>å¯è¦–åŒ–</strong>ï¼šWaterfallã€Forceã€Summaryã€Dependence plotsã§å¤šè§’çš„ã«åˆ†æ</li>
<li><strong>å¿œç”¨</strong>ï¼šãƒ¢ãƒ‡ãƒ«è¨ºæ–­ã€ç‰¹å¾´é‡é¸æŠã€ç•°å¸¸æ¤œçŸ¥ãªã©</li>
<li><strong>é™ç•Œ</strong>ï¼šè¨ˆç®—ã‚³ã‚¹ãƒˆã€å¤šé‡å…±ç·šæ€§ã€å› æœé–¢ä¿‚ã®è§£é‡ˆã«ã¯æ³¨æ„ãŒå¿…è¦</li>
</ul>

<h3>SHAPã®åˆ©ç‚¹ã¨é™ç•Œ</h3>

<table>
<thead>
<tr>
<th>é …ç›®</th>
<th>åˆ©ç‚¹</th>
<th>é™ç•Œ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç†è«–çš„åŸºç›¤</strong></td>
<td>ã‚²ãƒ¼ãƒ ç†è«–ã®ç¢ºå›ºãŸã‚‹åŸºç¤</td>
<td>è¨ˆç®—é‡ã®å•é¡Œï¼ˆå³å¯†è¨ˆç®—ã¯å›°é›£ï¼‰</td>
</tr>
<tr>
<td><strong>ä¸€è²«æ€§</strong></td>
<td>å…¬ç†çš„æ€§è³ªã«ã‚ˆã‚Šä¸€è²«ã—ãŸè§£é‡ˆ</td>
<td>å¤šé‡å…±ç·šæ€§ã§ä¸å®‰å®š</td>
</tr>
<tr>
<td><strong>é©ç”¨ç¯„å›²</strong></td>
<td>ä»»æ„ã®ãƒ¢ãƒ‡ãƒ«ã«é©ç”¨å¯èƒ½</td>
<td>ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦è¨ˆç®—ã‚³ã‚¹ãƒˆãŒå¤§ããç•°ãªã‚‹</td>
</tr>
<tr>
<td><strong>è§£é‡ˆæ€§</strong></td>
<td>å±€æ‰€çš„èª¬æ˜ã¨å¤§åŸŸçš„é‡è¦åº¦ã®ä¸¡æ–¹</td>
<td>ç›¸é–¢ã¨å› æœã®æ··åŒãƒªã‚¹ã‚¯</td>
</tr>
</tbody>
</table>

<h3>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>

<p>æ¬¡ç« ã§ã¯ã€<strong>Integrated Gradients</strong>ã¨<strong>Attentionæ©Ÿæ§‹</strong>ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã®è§£é‡ˆæ‰‹æ³•ã€å‹¾é…ãƒ™ãƒ¼ã‚¹ã®å±æ€§åˆ†æã€Transformerãƒ¢ãƒ‡ãƒ«ã®æ³¨æ„æ©Ÿæ§‹ã®å¯è¦–åŒ–ãªã©ã€ã‚ˆã‚Šé«˜åº¦ãªè§£é‡ˆæŠ€è¡“ã‚’ç¿’å¾—ã—ã¾ã™ã€‚</p>

<h3>å‚è€ƒæ–‡çŒ®</h3>

<ul>
<li>Lundberg, S. M., & Lee, S. I. (2017). "A unified approach to interpreting model predictions." <em>NeurIPS</em>.</li>
<li>Shapley, L. S. (1953). "A value for n-person games." <em>Contributions to the Theory of Games</em>, 2(28), 307-317.</li>
<li>Lundberg, S. M., et al. (2020). "From local explanations to global understanding with explainable AI for trees." <em>Nature Machine Intelligence</em>, 2(1), 2522-5839.</li>
<li>Molnar, C. (2022). "Interpretable Machine Learning." <a href="https://christophm.github.io/interpretable-ml-book/">https://christophm.github.io/interpretable-ml-book/</a></li>
</ul>

<div class="navigation">
    <a href="chapter1-lime.html" class="nav-button">â† ç¬¬1ç« ï¼šLIME</a>
    <a href="chapter3-integrated-gradients.html" class="nav-button">ç¬¬3ç« ï¼šIntegrated Gradients â†’</a>
</div>

</main>


    <section class="disclaimer">
        <h3>å…è²¬äº‹é …</h3>
        <ul>
            <li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯æ•™è‚²ãƒ»ç ”ç©¶ãƒ»æƒ…å ±æä¾›ã®ã¿ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€å°‚é–€çš„ãªåŠ©è¨€(æ³•å¾‹ãƒ»ä¼šè¨ˆãƒ»æŠ€è¡“çš„ä¿è¨¼ãªã©)ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
            <li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŠã‚ˆã³ä»˜éšã™ã‚‹ã‚³ãƒ¼ãƒ‰ä¾‹ã¯ã€Œç¾çŠ¶æœ‰å§¿(AS IS)ã€ã§æä¾›ã•ã‚Œã€æ˜ç¤ºã¾ãŸã¯é»™ç¤ºã‚’å•ã‚ãšã€å•†å“æ€§ã€ç‰¹å®šç›®çš„é©åˆæ€§ã€æ¨©åˆ©éä¾µå®³ã€æ­£ç¢ºæ€§ãƒ»å®Œå…¨æ€§ã€å‹•ä½œãƒ»å®‰å…¨æ€§ç­‰ã„ã‹ãªã‚‹ä¿è¨¼ã‚‚ã—ã¾ã›ã‚“ã€‚</li>
            <li>å¤–éƒ¨ãƒªãƒ³ã‚¯ã€ç¬¬ä¸‰è€…ãŒæä¾›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ»ãƒ„ãƒ¼ãƒ«ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç­‰ã®å†…å®¹ãƒ»å¯ç”¨æ€§ãƒ»å®‰å…¨æ€§ã«ã¤ã„ã¦ã€ä½œæˆè€…ãŠã‚ˆã³æ±åŒ—å¤§å­¦ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
            <li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ©ç”¨ãƒ»å®Ÿè¡Œãƒ»è§£é‡ˆã«ã‚ˆã‚Šç›´æ¥çš„ãƒ»é–“æ¥çš„ãƒ»ä»˜éšçš„ãƒ»ç‰¹åˆ¥ãƒ»çµæœçš„ãƒ»æ‡²ç½°çš„æå®³ãŒç”Ÿã˜ãŸå ´åˆã§ã‚‚ã€é©ç”¨æ³•ã§è¨±å®¹ã•ã‚Œã‚‹æœ€å¤§é™ã®ç¯„å›²ã§ã€ä½œæˆè€…ãŠã‚ˆã³æ±åŒ—å¤§å­¦ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
            <li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å†…å®¹ã¯ã€äºˆå‘Šãªãå¤‰æ›´ãƒ»æ›´æ–°ãƒ»æä¾›åœæ­¢ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</li>
            <li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è‘—ä½œæ¨©ãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯æ˜è¨˜ã•ã‚ŒãŸæ¡ä»¶(ä¾‹: CC BY 4.0)ã«å¾“ã„ã¾ã™ã€‚å½“è©²ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯é€šå¸¸ã€ç„¡ä¿è¨¼æ¡é …ã‚’å«ã¿ã¾ã™ã€‚</li>
        </ul>
    </section>

<footer>
    <p>&copy; 2024 AI Terakoya. All rights reserved.</p>
</footer>

</body>
</html>
