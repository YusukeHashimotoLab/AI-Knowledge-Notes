<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬5ç« : ãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡ã¸ã®å¿œç”¨ | ç¢ºç‡è«–ã¨ç¢ºç‡éç¨‹</title>
    <meta name="description" content="æ™‚ç³»åˆ—ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã€ARMA/ARIMAã€ç®¡ç†å›³ã€ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã€æ•…éšœäºˆæ¸¬ã€äºˆçŸ¥ä¿å…¨ã‚’å­¦ã³ã¾ã™ã€‚">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.8; color: #333; background: #f5f5f5; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; text-align: center; }
        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
        .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        .breadcrumb { margin-bottom: 1.5rem; font-size: 0.9rem; }
        .breadcrumb a { color: #667eea; text-decoration: none; }
        .content { background: white; padding: 2.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        h2 { color: #667eea; margin: 2rem 0 1rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid #e0e0e0; }
        h3 { color: #764ba2; margin: 1.5rem 0 0.8rem 0; }
        .definition { background: #e7f3ff; border-left: 4px solid #667eea; padding: 1rem 1.5rem; margin: 1.5rem 0; border-radius: 4px; }
        .theorem { background: #f3e5f5; border-left: 4px solid #764ba2; padding: 1rem 1.5rem; margin: 1.5rem 0; border-radius: 4px; }
        .code-block { background: #282c34; color: #abb2bf; padding: 1.5rem; border-radius: 8px; overflow-x: auto; margin: 1rem 0; font-size: 0.85rem; white-space: pre-wrap; }
        .output { background: #f8f9fa; border: 1px solid #dee2e6; padding: 1rem; border-radius: 6px; margin: 1rem 0; font-family: monospace; font-size: 0.9rem; white-space: pre-wrap; }
        .note { background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem 1.5rem; margin: 1.5rem 0; border-radius: 4px; }
        .exercise { background: #d4edda; border-left: 4px solid #28a745; padding: 1rem 1.5rem; margin: 1.5rem 0; border-radius: 4px; }
        .nav-buttons { display: flex; justify-content: space-between; margin: 2rem 0; }
        .nav-button { padding: 0.8rem 1.5rem; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; }
        footer { background: #2c3e50; color: white; text-align: center; padding: 2rem 1rem; margin-top: 3rem; }
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <header>
        <h1>ç¬¬5ç« : ãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡ã¸ã®å¿œç”¨</h1>
        <p class="subtitle">Applications to Process Control</p>
    </header>

    <div class="container">
        <div class="breadcrumb">
            <a href="../index.html">åŸºç¤æ•°ç†é“å ´</a> &gt;
            <a href="index.html">ç¢ºç‡è«–ã¨ç¢ºç‡éç¨‹</a> &gt;
            ç¬¬5ç« 
        </div>

        <div class="content">
            <h2>5.1 æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®ç¢ºç‡ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</h2>

            <div class="definition">
                <strong>ğŸ“ å®šç¾©: æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã¨è‡ªå·±ç›¸é–¢</strong><br>
                æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ \(\{X_t\}_{t=1,2,\ldots,n}\) ã¯ã€æ™‚é–“é †åºã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿åˆ—ã§ã™ã€‚

                <strong>è‡ªå·±ç›¸é–¢é–¢æ•°ï¼ˆACF: Autocorrelation Functionï¼‰:</strong>
                \[\rho(k) = \frac{Cov(X_t, X_{t-k})}{\sqrt{Var(X_t) Var(X_{t-k})}}\]

                <strong>åè‡ªå·±ç›¸é–¢é–¢æ•°ï¼ˆPACF: Partial Autocorrelation Functionï¼‰:</strong>
                ãƒ©ã‚° k ã§ã®ç›´æ¥çš„ãªç›¸é–¢ï¼ˆä¸­é–“ãƒ©ã‚°ã®å½±éŸ¿ã‚’é™¤å»ï¼‰

                ã“ã‚Œã‚‰ã¯æ™‚ç³»åˆ—ãƒ¢ãƒ‡ãƒ«ã®é¸æŠã«ä½¿ã‚ã‚Œã¾ã™ã€‚
            </div>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹1: æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®ç¢ºç‡ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</h3>
            <div class="code-block">import numpy as np
import matplotlib.pyplot as plt
from scipy import stats
from statsmodels.graphics.tsaplots import plot_acf, plot_pacf
from statsmodels.tsa.stattools import acf, pacf

# ä»®æƒ³ãƒ‡ãƒ¼ã‚¿ï¼šè£½é€ ãƒ—ãƒ­ã‚»ã‚¹ã®æ¸©åº¦ãƒ‡ãƒ¼ã‚¿
np.random.seed(42)
n_obs = 500

# ãƒˆãƒ¬ãƒ³ãƒ‰ + å­£ç¯€æ€§ + ãƒã‚¤ã‚º
time = np.arange(n_obs)
trend = 100 + 0.02 * time  # ç·šå½¢ãƒˆãƒ¬ãƒ³ãƒ‰
seasonality = 5 * np.sin(2 * np.pi * time / 50)  # å‘¨æœŸ50ã®å­£ç¯€æ€§
noise = np.random.normal(0, 2, n_obs)  # ãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚º

temperature = trend + seasonality + noise

fig, axes = plt.subplots(3, 2, figsize=(14, 12))

# (1) æ™‚ç³»åˆ—ãƒ—ãƒ­ãƒƒãƒˆ
axes[0, 0].plot(time, temperature, linewidth=1.5, color='#667eea')
axes[0, 0].plot(time, trend, '--', linewidth=2, color='red', label='ãƒˆãƒ¬ãƒ³ãƒ‰')
axes[0, 0].plot(time, trend + seasonality, '--', linewidth=2, color='green',
                 label='ãƒˆãƒ¬ãƒ³ãƒ‰+å­£ç¯€æ€§')
axes[0, 0].set_xlabel('æ™‚é–“', fontsize=11)
axes[0, 0].set_ylabel('æ¸©åº¦ (Â°C)', fontsize=11)
axes[0, 0].set_title('è£½é€ ãƒ—ãƒ­ã‚»ã‚¹æ¸©åº¦ã®æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿', fontsize=12, fontweight='bold')
axes[0, 0].legend()
axes[0, 0].grid(alpha=0.3)

# (2) ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
axes[0, 1].hist(temperature, bins=50, density=True, alpha=0.6,
                 color='#667eea', edgecolor='black')
axes[0, 1].set_xlabel('æ¸©åº¦ (Â°C)', fontsize=11)
axes[0, 1].set_ylabel('å¯†åº¦', fontsize=11)
axes[0, 1].set_title('æ¸©åº¦ã®åˆ†å¸ƒ', fontsize=12, fontweight='bold')
axes[0, 1].grid(alpha=0.3)

# (3) è‡ªå·±ç›¸é–¢é–¢æ•°ï¼ˆACFï¼‰
lags = 50
acf_values = acf(temperature, nlags=lags)

axes[1, 0].stem(range(lags+1), acf_values, linefmt='#667eea', markerfmt='o',
                 basefmt=' ')
axes[1, 0].axhline(y=0, color='black', linestyle='-', linewidth=0.8)
axes[1, 0].axhline(y=1.96/np.sqrt(n_obs), color='red', linestyle='--',
                    linewidth=1.5, label='95%ä¿¡é ¼åŒºé–“')
axes[1, 0].axhline(y=-1.96/np.sqrt(n_obs), color='red', linestyle='--', linewidth=1.5)
axes[1, 0].set_xlabel('ãƒ©ã‚°', fontsize=11)
axes[1, 0].set_ylabel('ACF', fontsize=11)
axes[1, 0].set_title('è‡ªå·±ç›¸é–¢é–¢æ•°ï¼ˆACFï¼‰', fontsize=12, fontweight='bold')
axes[1, 0].legend()
axes[1, 0].grid(alpha=0.3)

# (4) åè‡ªå·±ç›¸é–¢é–¢æ•°ï¼ˆPACFï¼‰
pacf_values = pacf(temperature, nlags=lags)

axes[1, 1].stem(range(lags+1), pacf_values, linefmt='#764ba2', markerfmt='o',
                 basefmt=' ')
axes[1, 1].axhline(y=0, color='black', linestyle='-', linewidth=0.8)
axes[1, 1].axhline(y=1.96/np.sqrt(n_obs), color='red', linestyle='--', linewidth=1.5)
axes[1, 1].axhline(y=-1.96/np.sqrt(n_obs), color='red', linestyle='--', linewidth=1.5)
axes[1, 1].set_xlabel('ãƒ©ã‚°', fontsize=11)
axes[1, 1].set_ylabel('PACF', fontsize=11)
axes[1, 1].set_title('åè‡ªå·±ç›¸é–¢é–¢æ•°ï¼ˆPACFï¼‰', fontsize=12, fontweight='bold')
axes[1, 1].grid(alpha=0.3)

# (5) å·®åˆ†ç³»åˆ—ï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰é™¤å»ï¼‰
diff_temp = np.diff(temperature)

axes[2, 0].plot(diff_temp, linewidth=1.5, color='#667eea')
axes[2, 0].axhline(y=0, color='red', linestyle='--', linewidth=2)
axes[2, 0].set_xlabel('æ™‚é–“', fontsize=11)
axes[2, 0].set_ylabel('å·®åˆ† Î”T', fontsize=11)
axes[2, 0].set_title('1æ¬¡å·®åˆ†ç³»åˆ—ï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰é™¤å»å¾Œï¼‰', fontsize=12, fontweight='bold')
axes[2, 0].grid(alpha=0.3)

# (6) å·®åˆ†ç³»åˆ—ã®ACF
diff_acf = acf(diff_temp, nlags=lags)

axes[2, 1].stem(range(lags+1), diff_acf, linefmt='#667eea', markerfmt='o',
                 basefmt=' ')
axes[2, 1].axhline(y=0, color='black', linestyle='-', linewidth=0.8)
axes[2, 1].axhline(y=1.96/np.sqrt(len(diff_temp)), color='red', linestyle='--', linewidth=1.5)
axes[2, 1].axhline(y=-1.96/np.sqrt(len(diff_temp)), color='red', linestyle='--', linewidth=1.5)
axes[2, 1].set_xlabel('ãƒ©ã‚°', fontsize=11)
axes[2, 1].set_ylabel('ACF', fontsize=11)
axes[2, 1].set_title('å·®åˆ†ç³»åˆ—ã®ACF', fontsize=12, fontweight='bold')
axes[2, 1].grid(alpha=0.3)

plt.tight_layout()
plt.show()

# çµ±è¨ˆã‚µãƒãƒªãƒ¼
print("æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆ:")
print(f"å¹³å‡: {temperature.mean():.2f} Â°C")
print(f"æ¨™æº–åå·®: {temperature.std():.2f} Â°C")
print(f"æœ€å°å€¤: {temperature.min():.2f} Â°C")
print(f"æœ€å¤§å€¤: {temperature.max():.2f} Â°C")
print(f"\nå·®åˆ†ç³»åˆ—ã®çµ±è¨ˆ:")
print(f"å¹³å‡: {diff_temp.mean():.4f}")
print(f"æ¨™æº–åå·®: {diff_temp.std():.2f}")</div>

            <h2>5.2 ARMA/ARIMAãƒ¢ãƒ‡ãƒ«</h2>

            <div class="theorem">
                <strong>ğŸ“Š å®šç†: ARMA/ARIMAãƒ¢ãƒ‡ãƒ«</strong><br>

                <strong>AR(p)ãƒ¢ãƒ‡ãƒ«ï¼ˆè‡ªå·±å›å¸°ï¼‰:</strong>
                \[X_t = c + \sum_{i=1}^p \phi_i X_{t-i} + \epsilon_t\]

                <strong>MA(q)ãƒ¢ãƒ‡ãƒ«ï¼ˆç§»å‹•å¹³å‡ï¼‰:</strong>
                \[X_t = \mu + \epsilon_t + \sum_{i=1}^q \theta_i \epsilon_{t-i}\]

                <strong>ARMA(p,q)ãƒ¢ãƒ‡ãƒ«:</strong>
                \[X_t = c + \sum_{i=1}^p \phi_i X_{t-i} + \epsilon_t + \sum_{i=1}^q \theta_i \epsilon_{t-i}\]

                <strong>ARIMA(p,d,q)ãƒ¢ãƒ‡ãƒ«:</strong>
                ARMA(p,q)ã‚’ d å›å·®åˆ†ã—ãŸç³»åˆ—ã«é©ç”¨
            </div>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹2: ARMA/ARIMAãƒ¢ãƒ‡ãƒ«</h3>
            <div class="code-block">from statsmodels.tsa.arima.model import ARIMA
from statsmodels.tsa.stattools import adfuller

# ARIMAãƒ¢ãƒ‡ãƒ«ã®ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°
# ã¾ãšå®šå¸¸æ€§ã‚’æ¤œå®šï¼ˆAugmented Dickey-Fuller testï¼‰
adf_result = adfuller(temperature)
print("Augmented Dickey-Fulleræ¤œå®š:")
print(f"ADFçµ±è¨ˆé‡: {adf_result[0]:.4f}")
print(f"på€¤: {adf_result[1]:.4f}")
print(f"çµè«–: {'å®šå¸¸' if adf_result[1] < 0.05 else 'éå®šå¸¸'}")

# ARIMA(1,1,1)ãƒ¢ãƒ‡ãƒ«ã®ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°
model = ARIMA(temperature, order=(1, 1, 1))
model_fit = model.fit()

print("\n" + "="*60)
print(model_fit.summary())

# äºˆæ¸¬
n_forecast = 50
forecast = model_fit.forecast(steps=n_forecast)
forecast_index = np.arange(n_obs, n_obs + n_forecast)

# ä¿¡é ¼åŒºé–“
forecast_result = model_fit.get_forecast(steps=n_forecast)
forecast_ci = forecast_result.conf_int()

fig, axes = plt.subplots(2, 2, figsize=(14, 10))

# (1) ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã¨äºˆæ¸¬
axes[0, 0].plot(time, temperature, linewidth=1.5, color='#667eea',
                 label='å®Ÿæ¸¬å€¤')
axes[0, 0].plot(time, model_fit.fittedvalues, '--', linewidth=2, color='red',
                 label='ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°', alpha=0.7)
axes[0, 0].plot(forecast_index, forecast, linewidth=2, color='green',
                 label='äºˆæ¸¬')
axes[0, 0].fill_between(forecast_index,
                          forecast_ci.iloc[:, 0],
                          forecast_ci.iloc[:, 1],
                          alpha=0.2, color='green', label='95%ä¿¡é ¼åŒºé–“')
axes[0, 0].set_xlabel('æ™‚é–“', fontsize=11)
axes[0, 0].set_ylabel('æ¸©åº¦ (Â°C)', fontsize=11)
axes[0, 0].set_title('ARIMAãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã¨äºˆæ¸¬', fontsize=12, fontweight='bold')
axes[0, 0].legend()
axes[0, 0].grid(alpha=0.3)

# (2) æ®‹å·®ãƒ—ãƒ­ãƒƒãƒˆ
residuals = model_fit.resid

axes[0, 1].plot(residuals, linewidth=1.5, color='#667eea')
axes[0, 1].axhline(y=0, color='red', linestyle='--', linewidth=2)
axes[0, 1].set_xlabel('æ™‚é–“', fontsize=11)
axes[0, 1].set_ylabel('æ®‹å·®', fontsize=11)
axes[0, 1].set_title('æ®‹å·®ãƒ—ãƒ­ãƒƒãƒˆ', fontsize=12, fontweight='bold')
axes[0, 1].grid(alpha=0.3)

# (3) æ®‹å·®ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
axes[1, 0].hist(residuals, bins=50, density=True, alpha=0.6,
                 color='#667eea', edgecolor='black')

# æ­£è¦åˆ†å¸ƒãƒ•ã‚£ãƒƒãƒˆ
x = np.linspace(residuals.min(), residuals.max(), 1000)
mu, sigma = residuals.mean(), residuals.std()
axes[1, 0].plot(x, stats.norm.pdf(x, mu, sigma), 'r-', linewidth=2.5,
                 label=f'N({mu:.2f}, {sigma:.2f}Â²)')

axes[1, 0].set_xlabel('æ®‹å·®', fontsize=11)
axes[1, 0].set_ylabel('å¯†åº¦', fontsize=11)
axes[1, 0].set_title('æ®‹å·®ã®åˆ†å¸ƒ', fontsize=12, fontweight='bold')
axes[1, 0].legend()
axes[1, 0].grid(alpha=0.3)

# (4) æ®‹å·®ã®ACF
residual_acf = acf(residuals, nlags=40)

axes[1, 1].stem(range(len(residual_acf)), residual_acf, linefmt='#667eea',
                 markerfmt='o', basefmt=' ')
axes[1, 1].axhline(y=0, color='black', linestyle='-', linewidth=0.8)
axes[1, 1].axhline(y=1.96/np.sqrt(len(residuals)), color='red',
                    linestyle='--', linewidth=1.5, label='95%ä¿¡é ¼åŒºé–“')
axes[1, 1].axhline(y=-1.96/np.sqrt(len(residuals)), color='red',
                    linestyle='--', linewidth=1.5)
axes[1, 1].set_xlabel('ãƒ©ã‚°', fontsize=11)
axes[1, 1].set_ylabel('ACF', fontsize=11)
axes[1, 1].set_title('æ®‹å·®ã®ACFï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºæ¤œå®šï¼‰', fontsize=12, fontweight='bold')
axes[1, 1].legend()
axes[1, 1].grid(alpha=0.3)

plt.tight_layout()
plt.show()

# ãƒ¢ãƒ‡ãƒ«è¨ºæ–­
from statsmodels.stats.diagnostic import acorr_ljungbox

lb_test = acorr_ljungbox(residuals, lags=20, return_df=True)
print("\n\nLjung-Boxæ¤œå®šï¼ˆæ®‹å·®ã®ç‹¬ç«‹æ€§ï¼‰:")
print(lb_test.head(10))</div>

            <h2>5.3 ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã«ã‚ˆã‚‹çŠ¶æ…‹æ¨å®š</h2>

            <div class="definition">
                <strong>ğŸ“ å®šç¾©: ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿</strong><br>
                ç·šå½¢å‹•çš„ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ã‚’ã€ãƒã‚¤ã‚ºã®ã‚ã‚‹è¦³æ¸¬ã‹ã‚‰æœ€é©ã«æ¨å®šã™ã‚‹å†å¸°çš„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€‚

                <strong>çŠ¶æ…‹ç©ºé–“ãƒ¢ãƒ‡ãƒ«:</strong>
                \[\mathbf{x}_{t} = \mathbf{F}\mathbf{x}_{t-1} + \mathbf{w}_t \quad (\text{çŠ¶æ…‹æ–¹ç¨‹å¼})\]
                \[\mathbf{z}_t = \mathbf{H}\mathbf{x}_t + \mathbf{v}_t \quad (\text{è¦³æ¸¬æ–¹ç¨‹å¼})\]

                ã“ã“ã§ \(\mathbf{w}_t \sim N(0, \mathbf{Q})\)ï¼ˆãƒ—ãƒ­ã‚»ã‚¹ãƒã‚¤ã‚ºï¼‰ã€\(\mathbf{v}_t \sim N(0, \mathbf{R})\)ï¼ˆè¦³æ¸¬ãƒã‚¤ã‚ºï¼‰

                <strong>ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã®æ›´æ–°å¼:</strong>
                <ol>
                    <li>äºˆæ¸¬: \(\hat{\mathbf{x}}_{t|t-1} = \mathbf{F}\hat{\mathbf{x}}_{t-1|t-1}\)</li>
                    <li>æ›´æ–°: \(\hat{\mathbf{x}}_{t|t} = \hat{\mathbf{x}}_{t|t-1} + \mathbf{K}_t(\mathbf{z}_t - \mathbf{H}\hat{\mathbf{x}}_{t|t-1})\)</li>
                </ol>
            </div>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹3: ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã«ã‚ˆã‚‹çŠ¶æ…‹æ¨å®š</h3>
            <div class="code-block">from pykalman import KalmanFilter

# çœŸã®çŠ¶æ…‹ï¼ˆä½ç½®ã¨é€Ÿåº¦ï¼‰ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
np.random.seed(42)
n_timesteps = 100
dt = 0.1

# çœŸã®çŠ¶æ…‹
true_position = np.zeros(n_timesteps)
true_velocity = np.zeros(n_timesteps)

true_position[0] = 0
true_velocity[0] = 1  # åˆæœŸé€Ÿåº¦

process_noise_std = 0.1
for t in range(1, n_timesteps):
    # çœŸã®é‹å‹•æ–¹ç¨‹å¼: x = x + v*dt, v = v + w
    true_velocity[t] = true_velocity[t-1] + np.random.normal(0, process_noise_std)
    true_position[t] = true_position[t-1] + true_velocity[t-1] * dt

# è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒã‚¤ã‚ºã‚ã‚Šï¼‰
observation_noise_std = 0.5
observations = true_position + np.random.normal(0, observation_noise_std, n_timesteps)

# ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã®è¨­å®š
# çŠ¶æ…‹: [position, velocity]
# è¦³æ¸¬: [position]

# çŠ¶æ…‹é·ç§»è¡Œåˆ— F
F = np.array([[1, dt],
              [0, 1]])

# è¦³æ¸¬è¡Œåˆ— H
H = np.array([[1, 0]])

# ãƒ—ãƒ­ã‚»ã‚¹ãƒã‚¤ã‚ºå…±åˆ†æ•£ Q
Q = np.array([[0.01, 0],
              [0, process_noise_std**2]])

# è¦³æ¸¬ãƒã‚¤ã‚ºå…±åˆ†æ•£ R
R = np.array([[observation_noise_std**2]])

# åˆæœŸçŠ¶æ…‹
initial_state_mean = np.array([0, 0])
initial_state_covariance = np.eye(2)

# ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿
kf = KalmanFilter(
    transition_matrices=F,
    observation_matrices=H,
    transition_covariance=Q,
    observation_covariance=R,
    initial_state_mean=initial_state_mean,
    initial_state_covariance=initial_state_covariance
)

# ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
state_means, state_covariances = kf.filter(observations)

# ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ãŸäº‹å¾Œæ¨å®šï¼‰
smoothed_state_means, smoothed_state_covariances = kf.smooth(observations)

fig, axes = plt.subplots(2, 2, figsize=(14, 10))

# (1) ä½ç½®ã®æ¨å®š
time = np.arange(n_timesteps) * dt

axes[0, 0].plot(time, true_position, 'g-', linewidth=2.5, label='çœŸã®ä½ç½®')
axes[0, 0].plot(time, observations, 'r.', markersize=6, alpha=0.5,
                 label='è¦³æ¸¬ï¼ˆãƒã‚¤ã‚ºã‚ã‚Šï¼‰')
axes[0, 0].plot(time, state_means[:, 0], 'b-', linewidth=2,
                 label='ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿')
axes[0, 0].plot(time, smoothed_state_means[:, 0], 'c--', linewidth=2,
                 label='ã‚«ãƒ«ãƒãƒ³ã‚¹ãƒ ãƒ¼ã‚¶')

axes[0, 0].set_xlabel('æ™‚é–“', fontsize=11)
axes[0, 0].set_ylabel('ä½ç½®', fontsize=11)
axes[0, 0].set_title('ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã«ã‚ˆã‚‹ä½ç½®æ¨å®š', fontsize=12, fontweight='bold')
axes[0, 0].legend()
axes[0, 0].grid(alpha=0.3)

# (2) é€Ÿåº¦ã®æ¨å®š
axes[0, 1].plot(time, true_velocity, 'g-', linewidth=2.5, label='çœŸã®é€Ÿåº¦')
axes[0, 1].plot(time, state_means[:, 1], 'b-', linewidth=2,
                 label='ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿')
axes[0, 1].plot(time, smoothed_state_means[:, 1], 'c--', linewidth=2,
                 label='ã‚«ãƒ«ãƒãƒ³ã‚¹ãƒ ãƒ¼ã‚¶')

axes[0, 1].set_xlabel('æ™‚é–“', fontsize=11)
axes[0, 1].set_ylabel('é€Ÿåº¦', fontsize=11)
axes[0, 1].set_title('é€Ÿåº¦ã®æ¨å®šï¼ˆè¦³æ¸¬ãªã—ï¼‰', fontsize=12, fontweight='bold')
axes[0, 1].legend()
axes[0, 1].grid(alpha=0.3)

# (3) æ¨å®šèª¤å·®
position_error = state_means[:, 0] - true_position
velocity_error = state_means[:, 1] - true_velocity

axes[1, 0].plot(time, position_error, linewidth=2, color='#667eea',
                 label='ä½ç½®æ¨å®šèª¤å·®')
axes[1, 0].plot(time, velocity_error, linewidth=2, color='#764ba2',
                 label='é€Ÿåº¦æ¨å®šèª¤å·®')
axes[1, 0].axhline(y=0, color='red', linestyle='--', linewidth=2)

axes[1, 0].set_xlabel('æ™‚é–“', fontsize=11)
axes[1, 0].set_ylabel('æ¨å®šèª¤å·®', fontsize=11)
axes[1, 0].set_title('æ¨å®šèª¤å·®ã®æ™‚é–“æ¨ç§»', fontsize=12, fontweight='bold')
axes[1, 0].legend()
axes[1, 0].grid(alpha=0.3)

# (4) æ¨å®šèª¤å·®ã®å…±åˆ†æ•£ï¼ˆä¸ç¢ºå®Ÿæ€§ï¼‰
position_std = np.sqrt([cov[0, 0] for cov in state_covariances])

axes[1, 1].plot(time, state_means[:, 0], 'b-', linewidth=2, label='æ¨å®šä½ç½®')
axes[1, 1].fill_between(time,
                          state_means[:, 0] - 2*position_std,
                          state_means[:, 0] + 2*position_std,
                          alpha=0.3, color='blue', label='95%ä¿¡é ¼åŒºé–“')
axes[1, 1].plot(time, true_position, 'g--', linewidth=2, label='çœŸã®ä½ç½®')

axes[1, 1].set_xlabel('æ™‚é–“', fontsize=11)
axes[1, 1].set_ylabel('ä½ç½®', fontsize=11)
axes[1, 1].set_title('æ¨å®šã®ä¸ç¢ºå®Ÿæ€§', fontsize=12, fontweight='bold')
axes[1, 1].legend()
axes[1, 1].grid(alpha=0.3)

plt.tight_layout()
plt.show()

print("ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã®æ€§èƒ½:")
print(f"ä½ç½®æ¨å®šã®RMSE: {np.sqrt(np.mean(position_error**2)):.4f}")
print(f"é€Ÿåº¦æ¨å®šã®RMSE: {np.sqrt(np.mean(velocity_error**2)):.4f}")
print(f"\nè¦³æ¸¬ãƒã‚¤ã‚ºã®RMSE: {observation_noise_std:.4f}")
print(f"ãƒ•ã‚£ãƒ«ã‚¿ã«ã‚ˆã‚‹æ”¹å–„ç‡: {(1 - np.sqrt(np.mean(position_error**2))/observation_noise_std)*100:.1f}%")</div>

            <h2>5.4 å“è³ªç®¡ç†ã¨ç®¡ç†å›³</h2>

            <div class="definition">
                <strong>ğŸ“ å®šç¾©: ç®¡ç†å›³ï¼ˆControl Chartï¼‰</strong><br>
                ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ±è¨ˆçš„ç®¡ç†çŠ¶æ…‹ã«ã‚ã‚‹ã‹ã‚’ç›£è¦–ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã€‚

                <strong>Xbar-Rç®¡ç†å›³:</strong>
                <ul>
                    <li>ä¸­å¿ƒç·šï¼ˆCLï¼‰: \(\bar{\bar{X}} = \frac{1}{k}\sum_{i=1}^k \bar{X}_i\)</li>
                    <li>ä¸Šæ–¹ç®¡ç†é™ç•Œï¼ˆUCLï¼‰: \(\bar{\bar{X}} + A_2 \bar{R}\)</li>
                    <li>ä¸‹æ–¹ç®¡ç†é™ç•Œï¼ˆLCLï¼‰: \(\bar{\bar{X}} - A_2 \bar{R}\)</li>
                </ul>

                <strong>CUSUMç®¡ç†å›³:</strong> ç´¯ç©å’Œã‚’ç›£è¦–ã—ã€å°ã•ãªã‚·ãƒ•ãƒˆã‚’æ¤œå‡º
                \[C_i = \max(0, C_{i-1} + (X_i - \mu_0) - k)\]
            </div>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹4: ç®¡ç†å›³ï¼ˆXbar-R chart, CUSUMï¼‰</h3>
            <div class="code-block"># è£½é€ ãƒ—ãƒ­ã‚»ã‚¹ã®å“è³ªç®¡ç†
np.random.seed(42)

# ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼šæ­£å¸¸æ™‚ã¨ã‚·ãƒ•ãƒˆç™ºç”Ÿæ™‚
n_groups = 50
group_size = 5

# æ­£å¸¸æ™‚ï¼ˆæœ€åˆã®30ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
normal_data = np.random.normal(100, 2, (30, group_size))

# ã‚·ãƒ•ãƒˆç™ºç”Ÿï¼ˆå¾ŒåŠ20ã‚°ãƒ«ãƒ¼ãƒ—ã€å¹³å‡ãŒ101.5ã«ã‚·ãƒ•ãƒˆï¼‰
shifted_data = np.random.normal(101.5, 2, (20, group_size))

data = np.vstack([normal_data, shifted_data])

# ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã®å¹³å‡ã¨ç¯„å›²
group_means = data.mean(axis=1)
group_ranges = data.max(axis=1) - data.min(axis=1)

# ç®¡ç†é™ç•Œã®è¨ˆç®—
CL_mean = group_means[:30].mean()  # æ­£å¸¸æ™‚ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨ˆç®—
R_bar = group_ranges[:30].mean()

# Xbarç®¡ç†å›³ã®ä¿‚æ•°ï¼ˆã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º5ã®å ´åˆï¼‰
A2 = 0.577
D3 = 0
D4 = 2.114

UCL_mean = CL_mean + A2 * R_bar
LCL_mean = CL_mean - A2 * R_bar

UCL_range = D4 * R_bar
LCL_range = D3 * R_bar

fig, axes = plt.subplots(3, 2, figsize=(14, 12))

# (1) Xbarç®¡ç†å›³
axes[0, 0].plot(group_means, 'o-', linewidth=2, color='#667eea', markersize=6)
axes[0, 0].axhline(y=CL_mean, color='green', linestyle='-', linewidth=2,
                    label=f'CL={CL_mean:.2f}')
axes[0, 0].axhline(y=UCL_mean, color='red', linestyle='--', linewidth=2,
                    label=f'UCL={UCL_mean:.2f}')
axes[0, 0].axhline(y=LCL_mean, color='red', linestyle='--', linewidth=2,
                    label=f'LCL={LCL_mean:.2f}')
axes[0, 0].axvline(x=29.5, color='orange', linestyle=':', linewidth=2,
                    alpha=0.7, label='ã‚·ãƒ•ãƒˆç™ºç”Ÿç‚¹')

# ç®¡ç†å¤–ã‚Œç‚¹ã‚’å¼·èª¿
out_of_control = (group_means > UCL_mean) | (group_means < LCL_mean)
axes[0, 0].plot(np.where(out_of_control)[0], group_means[out_of_control],
                 'rx', markersize=12, markeredgewidth=3, label='ç®¡ç†å¤–ã‚Œ')

axes[0, 0].set_xlabel('ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·', fontsize=11)
axes[0, 0].set_ylabel('ã‚°ãƒ«ãƒ¼ãƒ—å¹³å‡', fontsize=11)
axes[0, 0].set_title('Xbarç®¡ç†å›³', fontsize=12, fontweight='bold')
axes[0, 0].legend(fontsize=9)
axes[0, 0].grid(alpha=0.3)

# (2) Rç®¡ç†å›³
axes[0, 1].plot(group_ranges, 'o-', linewidth=2, color='#764ba2', markersize=6)
axes[0, 1].axhline(y=R_bar, color='green', linestyle='-', linewidth=2,
                    label=f'CL={R_bar:.2f}')
axes[0, 1].axhline(y=UCL_range, color='red', linestyle='--', linewidth=2,
                    label=f'UCL={UCL_range:.2f}')
axes[0, 1].axhline(y=LCL_range, color='red', linestyle='--', linewidth=2,
                    label=f'LCL={LCL_range:.2f}')
axes[0, 1].axvline(x=29.5, color='orange', linestyle=':', linewidth=2, alpha=0.7)

axes[0, 1].set_xlabel('ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·', fontsize=11)
axes[0, 1].set_ylabel('ã‚°ãƒ«ãƒ¼ãƒ—ç¯„å›²', fontsize=11)
axes[0, 1].set_title('Rç®¡ç†å›³ï¼ˆç¯„å›²ï¼‰', fontsize=12, fontweight='bold')
axes[0, 1].legend(fontsize=9)
axes[0, 1].grid(alpha=0.3)

# (3) CUSUMç®¡ç†å›³
mu_0 = CL_mean  # ç›®æ¨™å€¤
sigma = 2  # æ¨™æº–åå·®ï¼ˆæ—¢çŸ¥ã¨ä»®å®šï¼‰
k = 0.5 * sigma  # è¨±å®¹å€¤ï¼ˆ0.5Ïƒã®ã‚·ãƒ•ãƒˆã‚’æ¤œå‡ºï¼‰
h = 5 * sigma  # æ±ºå®šé–“éš”ï¼ˆ5Ïƒï¼‰

# ä¸Šå´CUSUMã¨ä¸‹å´CUSUM
C_plus = np.zeros(n_groups + 1)
C_minus = np.zeros(n_groups + 1)

for i in range(n_groups):
    C_plus[i+1] = max(0, C_plus[i] + (group_means[i] - mu_0) - k)
    C_minus[i+1] = max(0, C_minus[i] - (group_means[i] - mu_0) - k)

axes[1, 0].plot(C_plus[1:], 'o-', linewidth=2, color='red', markersize=6,
                 label='ä¸Šå´CUSUM')
axes[1, 0].plot(C_minus[1:], 'o-', linewidth=2, color='blue', markersize=6,
                 label='ä¸‹å´CUSUM')
axes[1, 0].axhline(y=h, color='red', linestyle='--', linewidth=2,
                    label=f'æ±ºå®šé™ç•Œ h={h:.2f}')
axes[1, 0].axvline(x=29.5, color='orange', linestyle=':', linewidth=2, alpha=0.7)

# ã‚¢ãƒ©ãƒ¼ãƒ æ¤œå‡º
alarm_plus = np.where(C_plus[1:] > h)[0]
if len(alarm_plus) > 0:
    axes[1, 0].plot(alarm_plus[0], C_plus[alarm_plus[0]+1], 'r*',
                     markersize=20, label=f'ã‚¢ãƒ©ãƒ¼ãƒ (t={alarm_plus[0]})')

axes[1, 0].set_xlabel('ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·', fontsize=11)
axes[1, 0].set_ylabel('CUSUM', fontsize=11)
axes[1, 0].set_title('CUSUMç®¡ç†å›³', fontsize=12, fontweight='bold')
axes[1, 0].legend(fontsize=9)
axes[1, 0].grid(alpha=0.3)

# (4) å€‹åˆ¥å€¤ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ï¼ˆæ­£å¸¸æ™‚ vs ã‚·ãƒ•ãƒˆæ™‚ï¼‰
axes[1, 1].hist(normal_data.flatten(), bins=30, alpha=0.6, density=True,
                 color='green', edgecolor='black', label='æ­£å¸¸æ™‚')
axes[1, 1].hist(shifted_data.flatten(), bins=30, alpha=0.6, density=True,
                 color='red', edgecolor='black', label='ã‚·ãƒ•ãƒˆå¾Œ')

# ç†è«–åˆ†å¸ƒ
x = np.linspace(94, 108, 1000)
axes[1, 1].plot(x, stats.norm.pdf(x, 100, 2), 'g-', linewidth=2.5,
                 label='N(100, 2Â²)')
axes[1, 1].plot(x, stats.norm.pdf(x, 101.5, 2), 'r-', linewidth=2.5,
                 label='N(101.5, 2Â²)')

axes[1, 1].set_xlabel('æ¸¬å®šå€¤', fontsize=11)
axes[1, 1].set_ylabel('å¯†åº¦', fontsize=11)
axes[1, 1].set_title('ãƒ—ãƒ­ã‚»ã‚¹ã‚·ãƒ•ãƒˆã®æ¤œå‡º', fontsize=12, fontweight='bold')
axes[1, 1].legend()
axes[1, 1].grid(alpha=0.3)

# (5) å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ï¼ˆCpkï¼‰
# Cpk = min((USL - Î¼)/(3Ïƒ), (Î¼ - LSL)/(3Ïƒ))
USL = 106  # ä¸Šé™è¦æ ¼
LSL = 94   # ä¸‹é™è¦æ ¼

# æ­£å¸¸æ™‚
Cp_normal = (USL - LSL) / (6 * sigma)
Cpk_normal = min((USL - CL_mean) / (3 * sigma),
                  (CL_mean - LSL) / (3 * sigma))

# ã‚·ãƒ•ãƒˆå¾Œ
shifted_mean = shifted_data.mean()
Cpk_shifted = min((USL - shifted_mean) / (3 * sigma),
                   (shifted_mean - LSL) / (3 * sigma))

axes[2, 0].bar(['Cp\n(æ­£å¸¸)', 'Cpk\n(æ­£å¸¸)', 'Cpk\n(ã‚·ãƒ•ãƒˆå¾Œ)'],
                [Cp_normal, Cpk_normal, Cpk_shifted],
                color=['green', 'blue', 'red'], alpha=0.7, edgecolor='black')
axes[2, 0].axhline(y=1.33, color='orange', linestyle='--', linewidth=2,
                    label='æ¨å¥¨å€¤(1.33)')
axes[2, 0].axhline(y=1.00, color='red', linestyle='--', linewidth=2,
                    label='æœ€ä½å€¤(1.00)')

axes[2, 0].set_ylabel('å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°', fontsize=11)
axes[2, 0].set_title('å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ï¼ˆCp, Cpkï¼‰', fontsize=12, fontweight='bold')
axes[2, 0].legend()
axes[2, 0].grid(axis='y', alpha=0.3)

# (6) ç®¡ç†å›³ã®æ€§èƒ½æ¯”è¼ƒï¼ˆæ¤œå‡ºæ™‚é–“ï¼‰
axes[2, 1].text(0.1, 0.8, f'ã‚·ãƒ•ãƒˆç™ºç”Ÿ: ã‚°ãƒ«ãƒ¼ãƒ—30', fontsize=12, transform=axes[2, 1].transAxes)
axes[2, 1].text(0.1, 0.7, f'\nXbarç®¡ç†å›³:', fontsize=12, fontweight='bold',
                 transform=axes[2, 1].transAxes)
first_out = np.where(out_of_control)[0]
if len(first_out) > 0:
    axes[2, 1].text(0.1, 0.6, f'  åˆå›æ¤œå‡º: ã‚°ãƒ«ãƒ¼ãƒ—{first_out[0]+1}',
                     fontsize=11, transform=axes[2, 1].transAxes)
    axes[2, 1].text(0.1, 0.5, f'  æ¤œå‡ºé…ã‚Œ: {first_out[0]-29}ã‚°ãƒ«ãƒ¼ãƒ—',
                     fontsize=11, transform=axes[2, 1].transAxes)

axes[2, 1].text(0.1, 0.4, f'\nCUSUMç®¡ç†å›³:', fontsize=12, fontweight='bold',
                 transform=axes[2, 1].transAxes)
if len(alarm_plus) > 0:
    axes[2, 1].text(0.1, 0.3, f'  åˆå›æ¤œå‡º: ã‚°ãƒ«ãƒ¼ãƒ—{alarm_plus[0]+1}',
                     fontsize=11, transform=axes[2, 1].transAxes)
    axes[2, 1].text(0.1, 0.2, f'  æ¤œå‡ºé…ã‚Œ: {alarm_plus[0]-29}ã‚°ãƒ«ãƒ¼ãƒ—',
                     fontsize=11, transform=axes[2, 1].transAxes)

axes[2, 1].axis('off')
axes[2, 1].set_title('æ¤œå‡ºæ€§èƒ½ã®æ¯”è¼ƒ', fontsize=12, fontweight='bold')

plt.tight_layout()
plt.show()

print("å“è³ªç®¡ç†æŒ‡æ¨™:")
print(f"å·¥ç¨‹èƒ½åŠ›æŒ‡æ•° Cp (æ­£å¸¸æ™‚): {Cp_normal:.4f}")
print(f"å·¥ç¨‹èƒ½åŠ›æŒ‡æ•° Cpk (æ­£å¸¸æ™‚): {Cpk_normal:.4f}")
print(f"å·¥ç¨‹èƒ½åŠ›æŒ‡æ•° Cpk (ã‚·ãƒ•ãƒˆå¾Œ): {Cpk_shifted:.4f}")
print(f"\nç®¡ç†å¤–ã‚Œç‚¹æ•°ï¼ˆXbarå›³ï¼‰: {out_of_control.sum()} / {n_groups}")</div>

            <h2>5.5 ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹æœ€é©åŒ–</h2>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹5: ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹æœ€é©åŒ–</h3>
            <div class="code-block"># ãƒ—ãƒ­ã‚»ã‚¹æœ€é©åŒ–å•é¡Œï¼šåç‡æœ€å¤§åŒ–
np.random.seed(42)

# ãƒ—ãƒ­ã‚»ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆä¸ç¢ºå®Ÿæ€§ã‚ã‚Šï¼‰
def process_yield(temperature, pressure, time):
    """
    åç‡è¨ˆç®—ãƒ¢ãƒ‡ãƒ«ï¼ˆç°¡ç•¥åŒ–ï¼‰
    temperature: æ¸©åº¦ï¼ˆÂ°Cï¼‰
    pressure: åœ§åŠ›ï¼ˆMPaï¼‰
    time: åå¿œæ™‚é–“ï¼ˆæ™‚é–“ï¼‰
    """
    # ç†æƒ³çš„ãªåç‡ãƒ¢ãƒ‡ãƒ«
    T_opt = 350
    P_opt = 2.0
    t_opt = 4.0

    # 2æ¬¡é–¢æ•°ã«ã‚ˆã‚‹åç‡ãƒ¢ãƒ‡ãƒ«
    yield_rate = 0.9 - 0.001*(temperature - T_opt)**2 \
                     - 0.05*(pressure - P_opt)**2 \
                     - 0.01*(time - t_opt)**2

    # ãƒ©ãƒ³ãƒ€ãƒ ãƒã‚¤ã‚ºï¼ˆãƒ—ãƒ­ã‚»ã‚¹å¤‰å‹•ï¼‰
    noise = np.random.normal(0, 0.02)

    return max(0, min(1, yield_rate + noise))

# ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
n_simulations = 10000

# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šï¼ˆä¸ç¢ºå®Ÿæ€§ã‚’è€ƒæ…®ï¼‰
temperature_mean = 350
temperature_std = 5

pressure_mean = 2.0
pressure_std = 0.1

time_mean = 4.0
time_std = 0.2

# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
yields = []
temperatures = []
pressures = []
times = []

for _ in range(n_simulations):
    T = np.random.normal(temperature_mean, temperature_std)
    P = np.random.normal(pressure_mean, pressure_std)
    t = np.random.normal(time_mean, time_std)

    y = process_yield(T, P, t)

    yields.append(y)
    temperatures.append(T)
    pressures.append(P)
    times.append(t)

yields = np.array(yields)
temperatures = np.array(temperatures)
pressures = np.array(pressures)
times = np.array(times)

fig, axes = plt.subplots(2, 3, figsize=(16, 10))

# (1) åç‡ã®åˆ†å¸ƒ
axes[0, 0].hist(yields, bins=50, density=True, alpha=0.6,
                 color='#667eea', edgecolor='black')
axes[0, 0].axvline(yields.mean(), color='red', linestyle='--', linewidth=2,
                    label=f'å¹³å‡={yields.mean():.4f}')
axes[0, 0].axvline(np.percentile(yields, 5), color='orange', linestyle=':',
                    linewidth=2, label=f'5%ç‚¹={np.percentile(yields, 5):.4f}')

axes[0, 0].set_xlabel('åç‡', fontsize=11)
axes[0, 0].set_ylabel('å¯†åº¦', fontsize=11)
axes[0, 0].set_title('åç‡ã®åˆ†å¸ƒ', fontsize=12, fontweight='bold')
axes[0, 0].legend()
axes[0, 0].grid(alpha=0.3)

# (2) æ¸©åº¦ vs åç‡
axes[0, 1].scatter(temperatures, yields, alpha=0.3, s=10, color='#667eea')
axes[0, 1].set_xlabel('æ¸©åº¦ (Â°C)', fontsize=11)
axes[0, 1].set_ylabel('åç‡', fontsize=11)
axes[0, 1].set_title('æ¸©åº¦ã¨åç‡ã®é–¢ä¿‚', fontsize=12, fontweight='bold')
axes[0, 1].grid(alpha=0.3)

# æ„Ÿåº¦åˆ†æï¼ˆç·šå½¢å›å¸°ï¼‰
from scipy.stats import pearsonr
corr_T, _ = pearsonr(temperatures, yields)
axes[0, 1].text(0.05, 0.95, f'ç›¸é–¢ä¿‚æ•°: {corr_T:.4f}',
                 transform=axes[0, 1].transAxes, fontsize=10,
                 verticalalignment='top')

# (3) åœ§åŠ› vs åç‡
axes[0, 2].scatter(pressures, yields, alpha=0.3, s=10, color='#764ba2')
axes[0, 2].set_xlabel('åœ§åŠ› (MPa)', fontsize=11)
axes[0, 2].set_ylabel('åç‡', fontsize=11)
axes[0, 2].set_title('åœ§åŠ›ã¨åç‡ã®é–¢ä¿‚', fontsize=12, fontweight='bold')
axes[0, 2].grid(alpha=0.3)

corr_P, _ = pearsonr(pressures, yields)
axes[0, 2].text(0.05, 0.95, f'ç›¸é–¢ä¿‚æ•°: {corr_P:.4f}',
                 transform=axes[0, 2].transAxes, fontsize=10,
                 verticalalignment='top')

# (4) ãƒªã‚¹ã‚¯åˆ†æï¼ˆåç‡ < 0.8 ã®ç¢ºç‡ï¼‰
threshold = 0.8
risk_probability = (yields < threshold).sum() / n_simulations

axes[1, 0].hist(yields, bins=50, density=True, alpha=0.6,
                 color='#667eea', edgecolor='black')
axes[1, 0].axvline(threshold, color='red', linestyle='--', linewidth=2.5,
                    label=f'é–¾å€¤={threshold}')

# ãƒªã‚¹ã‚¯é ˜åŸŸã‚’å¡—ã‚Šã¤ã¶ã—
x_fill = np.linspace(yields.min(), threshold, 100)
axes[1, 0].fill_betweenx([0, 10], threshold, yields.min(),
                          alpha=0.3, color='red')

axes[1, 0].set_xlabel('åç‡', fontsize=11)
axes[1, 0].set_ylabel('å¯†åº¦', fontsize=11)
axes[1, 0].set_title(f'ãƒªã‚¹ã‚¯åˆ†æï¼ˆåç‡<{threshold}ã®ç¢ºç‡: {risk_probability:.2%}ï¼‰',
                      fontsize=12, fontweight='bold')
axes[1, 0].legend()
axes[1, 0].grid(alpha=0.3)
axes[1, 0].set_ylim([0, 20])

# (5) ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ„Ÿåº¦åˆ†æ
sensitivities = {
    'æ¸©åº¦': corr_T,
    'åœ§åŠ›': corr_P,
    'æ™‚é–“': pearsonr(times, yields)[0]
}

axes[1, 1].barh(list(sensitivities.keys()), list(sensitivities.values()),
                 color='#667eea', alpha=0.7, edgecolor='black')
axes[1, 1].axvline(x=0, color='black', linestyle='-', linewidth=0.8)
axes[1, 1].set_xlabel('ç›¸é–¢ä¿‚æ•°', fontsize=11)
axes[1, 1].set_title('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ„Ÿåº¦åˆ†æ', fontsize=12, fontweight='bold')
axes[1, 1].grid(alpha=0.3)

# (6) æœ€é©åŒ–ã‚·ãƒŠãƒªã‚ªã®æ¯”è¼ƒ
scenarios = {
    'ç¾çŠ¶': {'T': (350, 5), 'P': (2.0, 0.1), 't': (4.0, 0.2)},
    'æ¸©åº¦æœ€é©åŒ–': {'T': (350, 2), 'P': (2.0, 0.1), 't': (4.0, 0.2)},
    'åœ§åŠ›æœ€é©åŒ–': {'T': (350, 5), 'P': (2.0, 0.05), 't': (4.0, 0.2)},
    'ç·åˆæœ€é©åŒ–': {'T': (350, 2), 'P': (2.0, 0.05), 't': (4.0, 0.1)}
}

scenario_yields = {}
for name, params in scenarios.items():
    yields_scenario = []
    for _ in range(5000):
        T = np.random.normal(*params['T'])
        P = np.random.normal(*params['P'])
        t = np.random.normal(*params['t'])
        yields_scenario.append(process_yield(T, P, t))
    scenario_yields[name] = np.array(yields_scenario)

axes[1, 2].boxplot([scenario_yields[name] for name in scenarios.keys()],
                     labels=list(scenarios.keys()), patch_artist=True)
axes[1, 2].set_ylabel('åç‡', fontsize=11)
axes[1, 2].set_title('æœ€é©åŒ–ã‚·ãƒŠãƒªã‚ªã®æ¯”è¼ƒ', fontsize=12, fontweight='bold')
axes[1, 2].grid(axis='y', alpha=0.3)
plt.setp(axes[1, 2].xaxis.get_majorticklabels(), rotation=45, ha='right')

plt.tight_layout()
plt.show()

print("ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ:")
print(f"ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°: {n_simulations}")
print(f"\nåç‡çµ±è¨ˆ:")
print(f"  å¹³å‡: {yields.mean():.4f}")
print(f"  æ¨™æº–åå·®: {yields.std():.4f}")
print(f"  æœ€å°å€¤: {yields.min():.4f}")
print(f"  æœ€å¤§å€¤: {yields.max():.4f}")
print(f"  5%ç‚¹: {np.percentile(yields, 5):.4f}")
print(f"  95%ç‚¹: {np.percentile(yields, 95):.4f}")
print(f"\nãƒªã‚¹ã‚¯è©•ä¾¡:")
print(f"  åç‡<{threshold}ã®ç¢ºç‡: {risk_probability:.2%}")

print("\næœ€é©åŒ–ã‚·ãƒŠãƒªã‚ªæ¯”è¼ƒ:")
for name in scenarios.keys():
    mean_yield = scenario_yields[name].mean()
    std_yield = scenario_yields[name].std()
    print(f"  {name}: å¹³å‡={mean_yield:.4f}, Ïƒ={std_yield:.4f}")</div>

            <h2>5.6 ä¿¡é ¼æ€§å·¥å­¦ï¼ˆWeibullåˆ†å¸ƒï¼‰</h2>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹6: ä¿¡é ¼æ€§å·¥å­¦ï¼ˆWeibullåˆ†å¸ƒï¼‰</h3>
            <div class="code-block"># Weibullåˆ†å¸ƒã«ã‚ˆã‚‹ä¿¡é ¼æ€§è§£æ
from scipy.stats import weibull_min

np.random.seed(42)

# æ•…éšœãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆWeibullåˆ†å¸ƒï¼‰
shape_param = 2.5  # Î²ï¼ˆå½¢çŠ¶ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
scale_param = 1000  # Î·ï¼ˆå°ºåº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ç‰¹æ€§å¯¿å‘½ï¼‰

weibull_dist = weibull_min(c=shape_param, scale=scale_param)

# æ•…éšœæ™‚é–“ãƒ‡ãƒ¼ã‚¿
n_samples = 100
failure_times = weibull_dist.rvs(n_samples)

fig, axes = plt.subplots(2, 3, figsize=(16, 10))

# (1) æ•…éšœæ™‚é–“ã®åˆ†å¸ƒ
axes[0, 0].hist(failure_times, bins=30, density=True, alpha=0.6,
                 color='#667eea', edgecolor='black', label='å®Ÿæ¸¬ãƒ‡ãƒ¼ã‚¿')

t = np.linspace(0, failure_times.max(), 1000)
pdf_theory = weibull_dist.pdf(t)
axes[0, 0].plot(t, pdf_theory, 'r-', linewidth=2.5,
                 label=f'Weibull(Î²={shape_param}, Î·={scale_param})')

axes[0, 0].set_xlabel('æ•…éšœæ™‚é–“ï¼ˆæ™‚é–“ï¼‰', fontsize=11)
axes[0, 0].set_ylabel('ç¢ºç‡å¯†åº¦', fontsize=11)
axes[0, 0].set_title('æ•…éšœæ™‚é–“ã®åˆ†å¸ƒ', fontsize=12, fontweight='bold')
axes[0, 0].legend()
axes[0, 0].grid(alpha=0.3)

# (2) ä¿¡é ¼åº¦é–¢æ•° R(t) = 1 - F(t)
cdf_theory = weibull_dist.cdf(t)
reliability = 1 - cdf_theory

axes[0, 1].plot(t, reliability, linewidth=2.5, color='#667eea')
axes[0, 1].axhline(y=0.5, color='red', linestyle='--', linewidth=2,
                    label='R(t)=0.5')

# å¹³å‡å¯¿å‘½ï¼ˆMTTFï¼‰
mttf = weibull_dist.mean()
axes[0, 1].axvline(x=mttf, color='green', linestyle='--', linewidth=2,
                    label=f'MTTF={mttf:.0f}h')

axes[0, 1].set_xlabel('æ™‚é–“ï¼ˆæ™‚é–“ï¼‰', fontsize=11)
axes[0, 1].set_ylabel('ä¿¡é ¼åº¦ R(t)', fontsize=11)
axes[0, 1].set_title('ä¿¡é ¼åº¦é–¢æ•°', fontsize=12, fontweight='bold')
axes[0, 1].legend()
axes[0, 1].grid(alpha=0.3)

# (3) ãƒã‚¶ãƒ¼ãƒ‰é–¢æ•°ï¼ˆæ•…éšœç‡ï¼‰ h(t) = f(t) / R(t)
hazard_rate = pdf_theory / (reliability + 1e-10)

axes[0, 2].plot(t, hazard_rate, linewidth=2.5, color='#764ba2')
axes[0, 2].set_xlabel('æ™‚é–“ï¼ˆæ™‚é–“ï¼‰', fontsize=11)
axes[0, 2].set_ylabel('ãƒã‚¶ãƒ¼ãƒ‰ç‡ h(t)', fontsize=11)
axes[0, 2].set_title('ãƒã‚¶ãƒ¼ãƒ‰é–¢æ•°ï¼ˆæ•…éšœç‡ï¼‰', fontsize=12, fontweight='bold')
axes[0, 2].grid(alpha=0.3)

# Î²>1: æ‘©è€—æ•…éšœï¼ˆæ•…éšœç‡å¢—åŠ ï¼‰
axes[0, 2].text(0.5, 0.9, f'Î²={shape_param} > 1: æ‘©è€—æ•…éšœå‹',
                 transform=axes[0, 2].transAxes, fontsize=10,
                 bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))

# (4) Weibullãƒ—ãƒ­ãƒƒãƒˆï¼ˆç¢ºç‡ç´™ï¼‰
# ln(-ln(1-F(t))) vs ln(t) ãŒç›´ç·šã«ãªã‚‹
sorted_times = np.sort(failure_times)
n = len(sorted_times)
empirical_cdf = np.arange(1, n+1) / (n+1)

# Weibullå¤‰æ›
y_weibull = np.log(-np.log(1 - empirical_cdf))
x_weibull = np.log(sorted_times)

# ç·šå½¢å›å¸°
from scipy.stats import linregress
slope, intercept, r_value, _, _ = linregress(x_weibull, y_weibull)

# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¨å®š
beta_estimated = slope
eta_estimated = np.exp(-intercept / slope)

axes[1, 0].plot(x_weibull, y_weibull, 'o', color='#667eea', markersize=5,
                 label='å®Ÿæ¸¬ãƒ‡ãƒ¼ã‚¿')
axes[1, 0].plot(x_weibull, slope*x_weibull + intercept, 'r-', linewidth=2,
                 label=f'ãƒ•ã‚£ãƒƒãƒˆ: Î²={beta_estimated:.2f}, Î·={eta_estimated:.0f}')

axes[1, 0].set_xlabel('ln(æ™‚é–“)', fontsize=11)
axes[1, 0].set_ylabel('ln(-ln(1-F(t)))', fontsize=11)
axes[1, 0].set_title(f'Weibullãƒ—ãƒ­ãƒƒãƒˆ (RÂ²={r_value**2:.4f})',
                      fontsize=12, fontweight='bold')
axes[1, 0].legend()
axes[1, 0].grid(alpha=0.3)

# (5) ä¿å…¨è¨ˆç”»ï¼ˆäºˆé˜²ä¿å…¨ vs äº‹å¾Œä¿å…¨ï¼‰
# ã‚³ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«
C_preventive = 100  # äºˆé˜²ä¿å…¨ã‚³ã‚¹ãƒˆ
C_corrective = 500  # äº‹å¾Œä¿å…¨ã‚³ã‚¹ãƒˆï¼ˆæ•…éšœä¿®ç†ï¼‰

# äºˆé˜²ä¿å…¨é–“éš”ã‚’å¤‰åŒ–ã•ã›ã‚‹
T_preventive = np.linspace(100, 2000, 100)
expected_costs = []

for T in T_preventive:
    # äºˆé˜²ä¿å…¨ã¾ã§ã®æ•…éšœç¢ºç‡
    F_T = weibull_dist.cdf(T)

    # æœŸå¾…ã‚³ã‚¹ãƒˆï¼ˆ1ã‚µã‚¤ã‚¯ãƒ«ã‚ãŸã‚Šï¼‰
    # E[ã‚³ã‚¹ãƒˆ] = C_preventive + C_corrective * F(T)
    expected_cost = (C_preventive + C_corrective * F_T) / T

    expected_costs.append(expected_cost)

expected_costs = np.array(expected_costs)
optimal_T = T_preventive[np.argmin(expected_costs)]

axes[1, 1].plot(T_preventive, expected_costs, linewidth=2.5, color='#667eea')
axes[1, 1].axvline(x=optimal_T, color='red', linestyle='--', linewidth=2,
                    label=f'æœ€é©é–“éš”={optimal_T:.0f}h')
axes[1, 1].scatter([optimal_T], [expected_costs.min()], color='red',
                    s=100, zorder=5)

axes[1, 1].set_xlabel('äºˆé˜²ä¿å…¨é–“éš”ï¼ˆæ™‚é–“ï¼‰', fontsize=11)
axes[1, 1].set_ylabel('æœŸå¾…ã‚³ã‚¹ãƒˆï¼ˆ/æ™‚é–“ï¼‰', fontsize=11)
axes[1, 1].set_title('ä¿å…¨è¨ˆç”»ã®æœ€é©åŒ–', fontsize=12, fontweight='bold')
axes[1, 1].legend()
axes[1, 1].grid(alpha=0.3)

# (6) ç•°ãªã‚‹å½¢çŠ¶ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã®æ¯”è¼ƒ
betas = [0.5, 1.0, 2.0, 3.0]
colors = ['blue', 'green', 'orange', 'red']

for beta, color in zip(betas, colors):
    dist = weibull_min(c=beta, scale=1000)
    t = np.linspace(0, 3000, 1000)
    pdf = dist.pdf(t)
    axes[1, 2].plot(t, pdf, linewidth=2.5, color=color, label=f'Î²={beta}')

axes[1, 2].set_xlabel('æ™‚é–“', fontsize=11)
axes[1, 2].set_ylabel('ç¢ºç‡å¯†åº¦', fontsize=11)
axes[1, 2].set_title('å½¢çŠ¶ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿Î²ã®å½±éŸ¿', fontsize=12, fontweight='bold')
axes[1, 2].legend()
axes[1, 2].grid(alpha=0.3)

# æ•…éšœãƒ¢ãƒ¼ãƒ‰ã®è§£èª¬
axes[1, 2].text(0.55, 0.9, 'Î²<1: åˆæœŸæ•…éšœå‹',
                 transform=axes[1, 2].transAxes, fontsize=9)
axes[1, 2].text(0.55, 0.8, 'Î²=1: ãƒ©ãƒ³ãƒ€ãƒ æ•…éšœå‹',
                 transform=axes[1, 2].transAxes, fontsize=9)
axes[1, 2].text(0.55, 0.7, 'Î²>1: æ‘©è€—æ•…éšœå‹',
                 transform=axes[1, 2].transAxes, fontsize=9)

plt.tight_layout()
plt.show()

print("Weibullåˆ†å¸ƒã«ã‚ˆã‚‹ä¿¡é ¼æ€§è§£æ:")
print(f"çœŸã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: Î²={shape_param}, Î·={scale_param}")
print(f"æ¨å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: Î²={beta_estimated:.2f}, Î·={eta_estimated:.0f}")
print(f"\nä¿¡é ¼æ€§æŒ‡æ¨™:")
print(f"  å¹³å‡å¯¿å‘½ï¼ˆMTTFï¼‰: {mttf:.2f} æ™‚é–“")
print(f"  B10å¯¿å‘½ï¼ˆ10%æ•…éšœæ™‚é–“ï¼‰: {weibull_dist.ppf(0.1):.2f} æ™‚é–“")
print(f"  ä¸­å¤®å€¤å¯¿å‘½: {weibull_dist.median():.2f} æ™‚é–“")
print(f"\næœ€é©ä¿å…¨è¨ˆç”»:")
print(f"  æœ€é©äºˆé˜²ä¿å…¨é–“éš”: {optimal_T:.0f} æ™‚é–“")
print(f"  æœ€å°æœŸå¾…ã‚³ã‚¹ãƒˆ: {expected_costs.min():.4f} /æ™‚é–“")</div>

            <h2>5.7 äºˆçŸ¥ä¿å…¨ã®ãŸã‚ã®æ•…éšœäºˆæ¸¬ãƒ¢ãƒ‡ãƒ«</h2>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹7: äºˆçŸ¥ä¿å…¨ã®ãŸã‚ã®æ•…éšœäºˆæ¸¬ãƒ¢ãƒ‡ãƒ«</h3>
            <div class="code-block"># äºˆçŸ¥ä¿å…¨ï¼šåŠ£åŒ–ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®æ•…éšœäºˆæ¸¬
np.random.seed(42)

# åŠ£åŒ–ãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ™‚é–“ã¨ã¨ã‚‚ã«å¢—åŠ ï¼‰
n_units = 20  # è£…ç½®æ•°
max_time = 200  # è¦³æ¸¬æœŸé–“

# åŠ£åŒ–ãƒ¢ãƒ‡ãƒ«: X(t) = a*t + b*t^2 + noise
def degradation_model(t, a=0.1, b=0.001, sigma=0.5):
    """åŠ£åŒ–ãƒ¢ãƒ‡ãƒ«ï¼ˆ2æ¬¡é–¢æ•° + ãƒã‚¤ã‚ºï¼‰"""
    return a * t + b * t**2 + np.random.normal(0, sigma)

# è¤‡æ•°è£…ç½®ã®åŠ£åŒ–è»Œè·¡ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
time_points = np.linspace(0, max_time, 50)
degradation_data = []

for i in range(n_units):
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã°ã‚‰ã¤ãã‚’æŒãŸã›ã‚‹
    a = np.random.normal(0.1, 0.02)
    b = np.random.normal(0.001, 0.0002)

    degradation = [degradation_model(t, a, b) for t in time_points]
    degradation_data.append(degradation)

degradation_data = np.array(degradation_data)

# æ•…éšœé–¾å€¤
failure_threshold = 30

fig, axes = plt.subplots(2, 2, figsize=(14, 10))

# (1) åŠ£åŒ–è»Œè·¡
for i in range(n_units):
    axes[0, 0].plot(time_points, degradation_data[i], alpha=0.5, linewidth=1.5)

axes[0, 0].axhline(y=failure_threshold, color='red', linestyle='--',
                    linewidth=2.5, label=f'æ•…éšœé–¾å€¤={failure_threshold}')

# å¹³å‡åŠ£åŒ–è»Œè·¡
mean_degradation = degradation_data.mean(axis=0)
axes[0, 0].plot(time_points, mean_degradation, 'b-', linewidth=3,
                 label='å¹³å‡åŠ£åŒ–è»Œè·¡')

axes[0, 0].set_xlabel('æ™‚é–“', fontsize=11)
axes[0, 0].set_ylabel('åŠ£åŒ–ãƒ¬ãƒ™ãƒ«', fontsize=11)
axes[0, 0].set_title('è£…ç½®ã®åŠ£åŒ–è»Œè·¡', fontsize=12, fontweight='bold')
axes[0, 0].legend()
axes[0, 0].grid(alpha=0.3)

# (2) æ®‹å­˜å¯¿å‘½ï¼ˆRUL: Remaining Useful Lifeï¼‰ã®äºˆæ¸¬
current_time = 100
current_degradation = degradation_data[:, np.argmin(np.abs(time_points - current_time))]

# ç·šå½¢å›å¸°ã«ã‚ˆã‚‹åŠ£åŒ–é€Ÿåº¦ã®æ¨å®š
predicted_ruls = []

for i in range(n_units):
    # éå»ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åŠ£åŒ–é€Ÿåº¦ã‚’æ¨å®š
    past_times = time_points[time_points <= current_time]
    past_degradation = degradation_data[i, :len(past_times)]

    # ç·šå½¢å›å¸°
    slope, intercept, _, _, _ = linregress(past_times, past_degradation)

    # æ•…éšœæ™‚é–“ã®äºˆæ¸¬: failure_threshold = slope * t_failure + intercept
    if slope > 0:
        t_failure = (failure_threshold - intercept) / slope
        rul = max(0, t_failure - current_time)
    else:
        rul = np.inf

    predicted_ruls.append(rul)

predicted_ruls = np.array(predicted_ruls)
predicted_ruls = predicted_ruls[predicted_ruls < 500]  # å¤–ã‚Œå€¤é™¤å»

axes[0, 1].hist(predicted_ruls, bins=20, alpha=0.6, color='#667eea',
                 edgecolor='black')
axes[0, 1].axvline(predicted_ruls.mean(), color='red', linestyle='--',
                    linewidth=2, label=f'å¹³å‡RUL={predicted_ruls.mean():.1f}')

axes[0, 1].set_xlabel('æ®‹å­˜å¯¿å‘½ï¼ˆRULï¼‰', fontsize=11)
axes[0, 1].set_ylabel('é »åº¦', fontsize=11)
axes[0, 1].set_title(f't={current_time}ã§ã®æ®‹å­˜å¯¿å‘½åˆ†å¸ƒ',
                      fontsize=12, fontweight='bold')
axes[0, 1].legend()
axes[0, 1].grid(alpha=0.3)

# (3) äºˆçŸ¥ä¿å…¨ã®æ„æ€æ±ºå®š
# ã‚³ã‚¹ãƒˆè¨ˆç®—
maintenance_cost = 50
failure_cost = 200
inspection_cost = 10

# ä¿å…¨æˆ¦ç•¥ã®æ¯”è¼ƒ
strategies = {
    'äº‹å¾Œä¿å…¨': {'action': 'corrective', 'threshold': failure_threshold},
    'æ™‚é–“åŸºæº–ä¿å…¨': {'action': 'time-based', 'interval': 80},
    'çŠ¶æ…‹åŸºæº–ä¿å…¨': {'action': 'condition-based', 'threshold': 25},
    'äºˆçŸ¥ä¿å…¨': {'action': 'predictive', 'rul_threshold': 20}
}

# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ã‚³ã‚¹ãƒˆè©•ä¾¡
def simulate_maintenance_cost(degradation_data, time_points, strategy, n_sims=100):
    """ä¿å…¨æˆ¦ç•¥ã®ã‚³ã‚¹ãƒˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"""
    total_cost = 0

    for sim in range(n_sims):
        current_deg = 0
        current_time = 0
        cost = 0

        for t_idx, t in enumerate(time_points):
            current_deg = degradation_data[sim % len(degradation_data), t_idx]

            if strategy['action'] == 'corrective':
                if current_deg >= failure_threshold:
                    cost += failure_cost
                    current_deg = 0

            elif strategy['action'] == 'time-based':
                if t % strategy['interval'] == 0 and t > 0:
                    cost += maintenance_cost

            elif strategy['action'] == 'condition-based':
                cost += inspection_cost
                if current_deg >= strategy['threshold']:
                    cost += maintenance_cost
                    current_deg = 0

            elif strategy['action'] == 'predictive':
                # RULæ¨å®šã¨ä¿å…¨åˆ¤æ–­ï¼ˆç°¡ç•¥åŒ–ï¼‰
                if current_deg >= 20:  # åŠ£åŒ–ãŒé€²ã‚“ã ã‚‰äºˆæ¸¬
                    cost += inspection_cost
                    estimated_rul = (failure_threshold - current_deg) / 0.2
                    if estimated_rul < strategy['rul_threshold']:
                        cost += maintenance_cost
                        current_deg = 0

        total_cost += cost

    return total_cost / n_sims

strategy_costs = {}
for name, strategy in strategies.items():
    avg_cost = simulate_maintenance_cost(degradation_data, time_points, strategy)
    strategy_costs[name] = avg_cost

axes[1, 0].bar(strategy_costs.keys(), strategy_costs.values(),
                color=['red', 'orange', 'yellow', 'green'], alpha=0.7,
                edgecolor='black')
axes[1, 0].set_ylabel('æœŸå¾…ç·ã‚³ã‚¹ãƒˆ', fontsize=11)
axes[1, 0].set_title('ä¿å…¨æˆ¦ç•¥ã®ã‚³ã‚¹ãƒˆæ¯”è¼ƒ', fontsize=12, fontweight='bold')
axes[1, 0].grid(axis='y', alpha=0.3)
plt.setp(axes[1, 0].xaxis.get_majorticklabels(), rotation=45, ha='right')

# æœ€é©æˆ¦ç•¥ã‚’å¼·èª¿
min_cost_strategy = min(strategy_costs, key=strategy_costs.get)
min_cost_idx = list(strategy_costs.keys()).index(min_cost_strategy)
axes[1, 0].get_children()[min_cost_idx].set_edgecolor('blue')
axes[1, 0].get_children()[min_cost_idx].set_linewidth(3)

# (4) äºˆçŸ¥ä¿å…¨ã®ROIï¼ˆæŠ•è³‡å¯¾åŠ¹æœï¼‰
preventive_savings = strategy_costs['äº‹å¾Œä¿å…¨'] - strategy_costs['äºˆçŸ¥ä¿å…¨']
inspection_cost_total = inspection_cost * len(time_points)

roi = (preventive_savings / inspection_cost_total) * 100

axes[1, 1].text(0.5, 0.7, 'äºˆçŸ¥ä¿å…¨ã®æŠ•è³‡å¯¾åŠ¹æœ',
                 ha='center', fontsize=14, fontweight='bold',
                 transform=axes[1, 1].transAxes)

axes[1, 1].text(0.5, 0.5, f'äº‹å¾Œä¿å…¨ã‚³ã‚¹ãƒˆ: {strategy_costs["äº‹å¾Œä¿å…¨"]:.2f}',
                 ha='center', fontsize=12, transform=axes[1, 1].transAxes)

axes[1, 1].text(0.5, 0.4, f'äºˆçŸ¥ä¿å…¨ã‚³ã‚¹ãƒˆ: {strategy_costs["äºˆçŸ¥ä¿å…¨"]:.2f}',
                 ha='center', fontsize=12, transform=axes[1, 1].transAxes)

axes[1, 1].text(0.5, 0.3, f'ã‚³ã‚¹ãƒˆå‰Šæ¸›: {preventive_savings:.2f}',
                 ha='center', fontsize=12, color='green',
                 fontweight='bold', transform=axes[1, 1].transAxes)

axes[1, 1].text(0.5, 0.2, f'ROI: {roi:.1f}%',
                 ha='center', fontsize=14, color='blue',
                 fontweight='bold', transform=axes[1, 1].transAxes)

axes[1, 1].axis('off')

plt.tight_layout()
plt.show()

print("äºˆçŸ¥ä¿å…¨ã®åŠ¹æœ:")
print("="*60)
for name, cost in strategy_costs.items():
    print(f"{name:15s}: {cost:8.2f}")

print(f"\näºˆçŸ¥ä¿å…¨ã«ã‚ˆã‚‹ã‚³ã‚¹ãƒˆå‰Šæ¸›: {preventive_savings:.2f}")
print(f"ROI: {roi:.1f}%")</div>

            <div class="note">
                <strong>ğŸ’¡ Note:</strong> äºˆçŸ¥ä¿å…¨ï¼ˆPredictive Maintenanceï¼‰ã¯ã€IoTã‚»ãƒ³ã‚µãƒ¼ã¨æ©Ÿæ¢°å­¦ç¿’ã‚’çµ„ã¿åˆã‚ã›ã¦ã€è£…ç½®ã®æ•…éšœã‚’äº‹å‰ã«äºˆæ¸¬ã—ã€æœ€é©ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä¿å…¨ã‚’å®Ÿæ–½ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚äº‹å¾Œä¿å…¨ï¼ˆå£Šã‚Œã¦ã‹ã‚‰ä¿®ç†ï¼‰ã‚„æ™‚é–“åŸºæº–ä¿å…¨ï¼ˆå®šæœŸä¿å…¨ï¼‰ã¨æ¯”è¼ƒã—ã¦ã€å¤§å¹…ãªã‚³ã‚¹ãƒˆå‰Šæ¸›ã¨ç¨¼åƒç‡å‘ä¸ŠãŒå¯èƒ½ã§ã™ã€‚
            </div>

            <h2>æ¼”ç¿’å•é¡Œ</h2>

            <div class="exercise">
                <strong>ğŸ“ æ¼”ç¿’1: ARIMA ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹äºˆæ¸¬</strong><br>
                æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰ + å­£ç¯€æ€§ + ãƒã‚¤ã‚ºï¼‰ã‚’ç”Ÿæˆã—ï¼š
                <ol>
                    <li>ACF/PACFãƒ—ãƒ­ãƒƒãƒˆã‹ã‚‰ARIMAãƒ¢ãƒ‡ãƒ«ã®æ¬¡æ•°(p,d,q)ã‚’æ±ºå®šã›ã‚ˆ</li>
                    <li>ARIMAãƒ¢ãƒ‡ãƒ«ã‚’ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã—ã€50ã‚¹ãƒ†ãƒƒãƒ—å…ˆã¾ã§äºˆæ¸¬ã›ã‚ˆ</li>
                    <li>æ®‹å·®ãŒãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºã§ã‚ã‚‹ã“ã¨ã‚’Ljung-Boxæ¤œå®šã§ç¢ºèªã›ã‚ˆ</li>
                </ol>
            </div>

            <div class="exercise">
                <strong>ğŸ“ æ¼”ç¿’2: ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã®å®Ÿè£…</strong><br>
                åŠ é€Ÿåº¦è¨ˆã®ãƒã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é€Ÿåº¦ã¨ä½ç½®ã‚’æ¨å®šã™ã‚‹ï¼š
                <ol>
                    <li>çŠ¶æ…‹ç©ºé–“ãƒ¢ãƒ‡ãƒ«ï¼ˆä½ç½®ã€é€Ÿåº¦ã€åŠ é€Ÿåº¦ï¼‰ã‚’å®šç¾©ã›ã‚ˆ</li>
                    <li>ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ã‚’å®Ÿè£…ã—ã€ãƒã‚¤ã‚ºã®ã‚ã‚‹åŠ é€Ÿåº¦ã‹ã‚‰ä½ç½®ã‚’æ¨å®šã›ã‚ˆ</li>
                    <li>è¦³æ¸¬ãƒã‚¤ã‚ºã®å¤§ãã•ã‚’å¤‰åŒ–ã•ã›ã€æ¨å®šç²¾åº¦ã¸ã®å½±éŸ¿ã‚’èª¿ã¹ã‚ˆ</li>
                </ol>
            </div>

            <div class="exercise">
                <strong>ğŸ“ æ¼”ç¿’3: äºˆçŸ¥ä¿å…¨ã‚·ã‚¹ãƒ†ãƒ ã®è¨­è¨ˆ</strong><br>
                æŒ¯å‹•ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è»¸å—ã®æ•…éšœã‚’äºˆæ¸¬ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’è¨­è¨ˆã›ã‚ˆï¼š
                <ol>
                    <li>åŠ£åŒ–ãƒ¢ãƒ‡ãƒ«ï¼ˆæŒ¯å‹•æŒ¯å¹…ã®æ™‚é–“å¢—åŠ ï¼‰ã‚’å®šç¾©ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã›ã‚ˆ</li>
                    <li>æ®‹å­˜å¯¿å‘½ï¼ˆRULï¼‰ã‚’æ¨å®šã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿè£…ã›ã‚ˆ</li>
                    <li>ç•°ãªã‚‹ä¿å…¨æˆ¦ç•¥ï¼ˆäº‹å¾Œã€æ™‚é–“åŸºæº–ã€çŠ¶æ…‹åŸºæº–ã€äºˆçŸ¥ï¼‰ã®ã‚³ã‚¹ãƒˆã‚’æ¯”è¼ƒã›ã‚ˆ</li>
                </ol>
            </div>

            <div class="nav-buttons">
                <a href="chapter-4.html" class="nav-button">â† ç¬¬4ç« </a>
                <a href="index.html" class="nav-button">ã‚·ãƒªãƒ¼ã‚ºãƒˆãƒƒãƒ—ã¸</a>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 AI Terakoya - Fundamentals of Mathematics & Physics Dojo</p>
    </footer>
</body>
</html>
