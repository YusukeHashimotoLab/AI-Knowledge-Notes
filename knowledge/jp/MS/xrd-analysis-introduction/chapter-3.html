<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬3ç« :ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æå…¥é–€ - MS Terakoya</title>

    <style>
        :root {
            --color-primary: #2c3e50;
            --color-primary-dark: #1a252f;
            --color-accent: #f093fb;
            --color-accent-light: #f5576c;
            --color-text: #2d3748;
            --color-text-light: #4a5568;
            --color-bg: #ffffff;
            --color-bg-alt: #f7fafc;
            --color-border: #e2e8f0;
            --color-code-bg: #f8f9fa;
            --color-link: #f093fb;
            --color-link-hover: #d07be8;

            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;

            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;

            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.7;
            color: var(--color-text);
            background-color: var(--color-bg);
            font-size: 16px;
        }

        header {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: var(--spacing-md);
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 var(--spacing-md) var(--spacing-xl);
        }

        h2 {
            font-size: 1.75rem;
            color: var(--color-primary);
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-xs);
            border-bottom: 3px solid var(--color-accent);
        }

        h3 {
            font-size: 1.4rem;
            color: var(--color-primary);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
        }

        h4 {
            font-size: 1.1rem;
            color: var(--color-primary-dark);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        p {
            margin-bottom: var(--spacing-md);
            color: var(--color-text);
        }

        a {
            color: var(--color-link);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--color-link-hover);
            text-decoration: underline;
        }

        ul, ol {
            margin-left: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        li {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text);
        }

        pre {
            background-color: var(--color-code-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            overflow-x: auto;
            margin-bottom: var(--spacing-md);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            font-family: var(--font-mono);
            font-size: 0.9em;
            background-color: var(--color-code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
            font-size: 0.95rem;
        }

        th, td {
            border: 1px solid var(--color-border);
            padding: var(--spacing-sm);
            text-align: left;
        }

        th {
            background-color: var(--color-bg-alt);
            font-weight: 600;
            color: var(--color-primary);
        }

        blockquote {
            border-left: 4px solid var(--color-accent);
            padding-left: var(--spacing-md);
            margin: var(--spacing-md) 0;
            color: var(--color-text-light);
            font-style: italic;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .mermaid {
            text-align: center;
            margin: var(--spacing-lg) 0;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        details {
            background-color: var(--color-bg-alt);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--color-primary);
            user-select: none;
            padding: var(--spacing-xs);
            margin: calc(-1 * var(--spacing-md));
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        summary:hover {
            background-color: rgba(240, 147, 251, 0.1);
        }

        details[open] summary {
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .learning-objectives {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--color-accent);
            margin-bottom: var(--spacing-xl);
        }

        .learning-objectives h2 {
            margin-top: 0;
            border-bottom: none;
        }

        .breadcrumb {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.9rem;
            color: var(--color-text-light);
        }

        .breadcrumb a {
            color: var(--color-link);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin: var(--spacing-xl) 0;
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--color-border);
        }

        .nav-button {
            flex: 1;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--box-shadow);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-decoration: none;
        }

        footer {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg) var(--spacing-md);
            background-color: var(--color-bg-alt);
            border-top: 1px solid var(--color-border);
            text-align: center;
            font-size: 0.9rem;
            color: var(--color-text-light);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.6rem;
            }

            h2 {
                font-size: 1.4rem;
            }

            h3 {
                font-size: 1.2rem;
            }

            .navigation {
                flex-direction: column;
            }

            pre {
                font-size: 0.85rem;
            }
        }
    
        /* Breadcrumb styles */
        .breadcrumb {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .breadcrumb-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a0aec0;
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: #4a5568;
            font-weight: 500;
        }
    </style>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
    </script>
</head>
<body>
        <nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="../../index.html">AIå¯ºå­å±‹ãƒˆãƒƒãƒ—</a><span class="breadcrumb-separator">â€º</span><a href="../../MS/index.html">ææ–™ç§‘å­¦</a><span class="breadcrumb-separator">â€º</span><a href="../../MS/xrd-analysis-introduction/index.html">Xrd Analysis</a><span class="breadcrumb-separator">â€º</span><span class="breadcrumb-current">Chapter 3</span>
        </div>
    </nav>

    <header>
        <div class="header-content">
            <h1>ç¬¬3ç« : ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æå…¥é–€</h1>
            <p class="subtitle">å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã«ã‚ˆã‚‹ç²¾å¯†çµæ™¶æ§‹é€ è§£æ</p>
            <div class="meta">
                <span class="meta-item">ğŸ“– èª­äº†æ™‚é–“: 30-35åˆ†</span>
                <span class="meta-item">ğŸ¯ é›£æ˜“åº¦: ä¸­ã€œä¸Šç´š</span>
                <span class="meta-item">ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹: 8å€‹</span>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="learning-objectives">
            <h2>å­¦ç¿’ç›®æ¨™</h2>
            <p>ã“ã®ç« ã‚’å®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™:</p>
            <ul>
                <li>ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆæ³•ã®åŸç†ã¨æœ€å°äºŒä¹—æ³•ã‚’ç†è§£ã—å®Ÿè£…ã§ãã‚‹</li>
                <li>Pseudo-Voigtãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•°ã‚’ç”¨ã„ãŸå…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ãŒã§ãã‚‹</li>
                <li>Chebyshevå¤šé …å¼ã«ã‚ˆã‚‹ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã§ãã‚‹</li>
                <li>Rå› å­(Rwp, RB, GOF)ã‚’è¨ˆç®—ã—ã€ãƒ•ã‚£ãƒƒãƒˆå“è³ªã‚’è©•ä¾¡ã§ãã‚‹</li>
                <li>lmfit.Minimizerã‚’ç”¨ã„ãŸå®Ÿè·µçš„ãªãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã‚’å®Ÿè¡Œã§ãã‚‹</li>
            </ul>
        </div>

        <h2>3.1 ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆæ³•ã®åŸç†</h2>

        <h3>3.1.1 å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°</h3>

        <p>ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆæ³•ã¯ã€1969å¹´ã«Hugo Rietveldã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚ŒãŸç²‰æœ«Xç·šå›æŠ˜ãƒ‡ãƒ¼ã‚¿ã®å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°æ‰‹æ³•ã§ã™ã€‚å€‹ã€…ã®ãƒ”ãƒ¼ã‚¯ã‚’ç‹¬ç«‹ã«ãƒ•ã‚£ãƒƒãƒˆã™ã‚‹å¾“æ¥æ³•ã¨ç•°ãªã‚Šã€<strong>å…¨æ¸¬å®šç¯„å›²ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¸€åº¦ã«æœ€é©åŒ–</strong>ã—ã¾ã™ã€‚</p>

        <p>è¦³æ¸¬å¼·åº¦\( y_i^{obs} \)ã¨è¨ˆç®—å¼·åº¦\( y_i^{calc} \)ã®å·®ã®äºŒä¹—å’Œã‚’æœ€å°åŒ–:</p>

        <p style="text-align: center; font-size: 1.15em; margin: 1.5em 0;">
            \[ S = \sum_{i} w_i \left(y_i^{obs} - y_i^{calc}\right)^2 \]
        </p>

        <p>ã“ã“ã§ã€\( w_i = 1/y_i^{obs} \) ã¯çµ±è¨ˆçš„é‡ã¿(ã‚«ã‚¦ãƒ³ãƒˆçµ±è¨ˆã«åŸºã¥ã)ã€\( i \) ã¯æ¸¬å®šç‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã™ã€‚</p>

        <div class="mermaid">
flowchart TD
    A[åˆæœŸæ§‹é€ ãƒ¢ãƒ‡ãƒ«<br/>æ ¼å­å®šæ•°ãƒ»åŸå­åº§æ¨™] --> B[è¨ˆç®—å›æŠ˜ãƒ‘ã‚¿ãƒ¼ãƒ³<br/>y_calc]
    B --> C[è¦³æ¸¬ãƒ‘ã‚¿ãƒ¼ãƒ³ y_obs<br/>ã¨ã®å·®ã‚’è¨ˆç®—]
    C --> D{æ®‹å·® S<br/>ååˆ†å°ã•ã„?}
    D -->|No| E[ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´<br/>æœ€å°äºŒä¹—æ³•]
    E --> B
    D -->|Yes| F[æœ€çµ‚æ§‹é€ ãƒ¢ãƒ‡ãƒ«<br/>Rå› å­å‡ºåŠ›]

    style A fill:#fce7f3
    style D fill:#fff3e0
    style F fill:#e8f5e9
        </div>

        <h3>3.1.2 è¨ˆç®—å¼·åº¦ã®å®šå¼åŒ–</h3>

        <p>æ¸¬å®šç‚¹\( i \)ã«ãŠã‘ã‚‹è¨ˆç®—å¼·åº¦ã¯ä»¥ä¸‹ã®å¼ã§ä¸ãˆã‚‰ã‚Œã¾ã™:</p>

        <p style="text-align: center; font-size: 1.05em; margin: 1.5em 0;">
            \[ y_i^{calc} = y_{bi} + \sum_{K} s_K \sum_{hkl} m_{hkl} |F_{hkl}|^2 \Omega(2\theta_i - 2\theta_{hkl}) A_{hkl} \]
        </p>

        <p>å„é …ã®æ„å‘³:</p>
        <ul>
            <li>\( y_{bi} \): ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¼·åº¦</li>
            <li>\( s_K \): ç›¸\( K \)ã®ã‚¹ã‚±ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼</li>
            <li>\( m_{hkl} \): å¤šé‡åº¦</li>
            <li>\( |F_{hkl}|^2 \): æ§‹é€ å› å­ã®äºŒä¹—</li>
            <li>\( \Omega \): ãƒ”ãƒ¼ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•°</li>
            <li>\( A_{hkl} \): ãƒ­ãƒ¼ãƒ¬ãƒ³ãƒ„åå…‰å› å­ã€å¸åè£œæ­£ãªã©</li>
        </ul>

        <h3>3.1.3 æœ€å°äºŒä¹—æ³•ã®å®Ÿè£…</h3>

        <pre><code class="language-python">import numpy as np
from scipy.optimize import minimize

class RietveldRefinement:
    """ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã®åŸºæœ¬å®Ÿè£…"""

    def __init__(self, two_theta_obs, intensity_obs):
        """
        Args:
            two_theta_obs (np.ndarray): è¦³æ¸¬2Î¸è§’åº¦
            intensity_obs (np.ndarray): è¦³æ¸¬å¼·åº¦
        """
        self.two_theta_obs = two_theta_obs
        self.intensity_obs = intensity_obs
        self.weights = 1.0 / np.sqrt(np.maximum(intensity_obs, 1.0))  # çµ±è¨ˆçš„é‡ã¿

    def calculate_pattern(self, params, two_theta, peak_positions, structure_factors):
        """å›æŠ˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨ˆç®—

        Args:
            params (dict): ç²¾å¯†åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            two_theta (np.ndarray): 2Î¸è§’åº¦
            peak_positions (list): ãƒ”ãƒ¼ã‚¯ä½ç½® [(2Î¸_hkl, m_hkl), ...]
            structure_factors (list): æ§‹é€ å› å­ã®äºŒä¹— [|F_hkl|^2, ...]

        Returns:
            np.ndarray: è¨ˆç®—å¼·åº¦
        """
        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ (å¾Œè¿°ã®Chebyshevå¤šé …å¼ã§å®Ÿè£…)
        background = self._calculate_background(two_theta, params['bg_coeffs'])

        # ãƒ”ãƒ¼ã‚¯å¯„ä¸
        intensity_peaks = np.zeros_like(two_theta)

        for (peak_2theta, multiplicity), F_hkl_sq in zip(peak_positions, structure_factors):
            # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•° (Pseudo-Voigt)
            profile = self._pseudo_voigt_profile(
                two_theta,
                center=peak_2theta,
                fwhm=params['fwhm'],
                eta=params['eta']
            )

            # ã‚¹ã‚±ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ Ã— å¤šé‡åº¦ Ã— æ§‹é€ å› å­
            intensity_peaks += params['scale'] * multiplicity * F_hkl_sq * profile

        return background + intensity_peaks

    def _pseudo_voigt_profile(self, x, center, fwhm, eta):
        """Pseudo-Voigtãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•°

        Args:
            x (np.ndarray): 2Î¸
            center (float): ãƒ”ãƒ¼ã‚¯ä¸­å¿ƒ
            fwhm (float): åŠå€¤å…¨å¹…
            eta (float): Lorentzæˆåˆ†æ¯” (0-1)

        Returns:
            np.ndarray: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å½¢çŠ¶
        """
        # Gaussianæˆåˆ†
        sigma = fwhm / (2 * np.sqrt(2 * np.log(2)))
        gauss = np.exp(-0.5 * ((x - center) / sigma) ** 2) / (sigma * np.sqrt(2 * np.pi))

        # Lorentzianæˆåˆ†
        gamma = fwhm / 2
        lorentz = gamma / (np.pi * (gamma**2 + (x - center)**2))

        # Pseudo-Voigt
        return eta * lorentz + (1 - eta) * gauss

    def _calculate_background(self, two_theta, coeffs):
        """Chebyshevå¤šé …å¼ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è¨ˆç®—"""
        # æ­£è¦åŒ–ã•ã‚ŒãŸ x: [-1, 1]
        x_norm = 2 * (two_theta - two_theta.min()) / (two_theta.max() - two_theta.min()) - 1

        # Chebyshevå¤šé …å¼ T_n(x) ã‚’è¨ˆç®—
        bg = np.zeros_like(two_theta)
        for n, c in enumerate(coeffs):
            bg += c * np.polynomial.chebyshev.chebval(x_norm, [0]*n + [1])

        return bg

    def residual(self, params, two_theta, peak_positions, structure_factors):
        """æ®‹å·®é–¢æ•° (æœ€å°åŒ–ã®ç›®çš„é–¢æ•°)

        Returns:
            np.ndarray: é‡ã¿ä»˜ãæ®‹å·®
        """
        y_calc = self.calculate_pattern(params, two_theta, peak_positions, structure_factors)
        residual = (self.intensity_obs - y_calc) * self.weights
        return residual

    def chi_squared(self, residual):
        """Ï‡^2 ã‚’è¨ˆç®—"""
        return np.sum(residual**2)


# ä½¿ç”¨ä¾‹: ç°¡æ˜“ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æ
def simple_rietveld_demo():
    """ç°¡å˜ãªãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã®ãƒ‡ãƒ¢"""
    # æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    two_theta = np.linspace(10, 80, 3500)
    true_params = {
        'scale': 1000,
        'fwhm': 0.15,
        'eta': 0.5,
        'bg_coeffs': [100, -20, 5]
    }

    # ãƒ”ãƒ¼ã‚¯ä½ç½®ã¨æ§‹é€ å› å­ (Î±-Fe BCC)
    peak_positions = [(44.67, 12), (65.02, 6), (82.33, 24)]  # (2Î¸, multiplicity)
    structure_factors = [1.0, 0.8, 1.2]  # æ­£è¦åŒ–ã•ã‚ŒãŸ|F|^2

    # çœŸã®è¨ˆç®—ãƒ‘ã‚¿ãƒ¼ãƒ³
    rietveld = RietveldRefinement(two_theta, np.zeros_like(two_theta))
    y_true = rietveld.calculate_pattern(true_params, two_theta, peak_positions, structure_factors)

    # ãƒã‚¤ã‚ºè¿½åŠ 
    y_obs = y_true + np.random.normal(0, np.sqrt(y_true + 10), len(y_true))

    print("=== ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æãƒ‡ãƒ¢ ===")
    print(f"ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆæ•°: {len(two_theta)}")
    print(f"ãƒ”ãƒ¼ã‚¯æ•°: {len(peak_positions)}")
    print(f"ç²¾å¯†åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°: {1 + 1 + 1 + len(true_params['bg_coeffs'])} (scale, FWHM, Î·, BGä¿‚æ•°Ã—3)")

    return two_theta, y_obs, peak_positions, structure_factors

two_theta, y_obs, peak_pos, F_sq = simple_rietveld_demo()</code></pre>

        <h2>3.2 ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•°</h2>

        <h3>3.2.1 Pseudo-Voigté–¢æ•°ã®è©³ç´°</h3>

        <p>Pseudo-Voigté–¢æ•°ã¯ã€ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã§æœ€ã‚‚ä¸€èˆ¬çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•°ã§ã™:</p>

        <p style="text-align: center; font-size: 1.05em; margin: 1.5em 0;">
            \[ \Omega(x) = \eta L(x) + (1-\eta) G(x) \]
        </p>

        <p>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿\( \eta \)(0-1)ã¯ã€Lorentzianæˆåˆ†ã®å¯„ä¸ã‚’è¡¨ã—ã¾ã™ã€‚</p>

        <p><strong>FWHM(åŠå€¤å…¨å¹…)ã®è§’åº¦ä¾å­˜æ€§</strong> - Cagliotiå¼:</p>

        <p style="text-align: center; font-size: 1.05em; margin: 1.5em 0;">
            \[ \text{FWHM}^2 = U\tan^2\theta + V\tan\theta + W \]
        </p>

        <p>ã“ã“ã§ã€\( U, V, W \) ã¯Cagliotiãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã™ã€‚</p>

        <pre><code class="language-python">def caglioti_fwhm(two_theta, U, V, W):
    """Cagliotiå¼ã§FWHMã‚’è¨ˆç®—

    Args:
        two_theta (float or np.ndarray): 2Î¸è§’åº¦ [åº¦]
        U, V, W (float): Cagliotiãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

    Returns:
        float or np.ndarray: FWHM [åº¦]
    """
    theta_rad = np.radians(two_theta / 2)
    tan_theta = np.tan(theta_rad)

    fwhm_squared = U * tan_theta**2 + V * tan_theta + W

    # è² ã®å€¤ã‚’é¿ã‘ã‚‹
    fwhm_squared = np.maximum(fwhm_squared, 0.001)

    return np.sqrt(fwhm_squared)


# U, V, Wãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å…¸å‹å€¤ (Cu KÎ±, å®Ÿé¨“å®¤ç³»XRD)
U = 0.01  # [åº¦^2]
V = -0.005  # [åº¦^2]
W = 0.005  # [åº¦^2]

# æ§˜ã€…ãªè§’åº¦ã§ã®FWHM
two_theta_range = np.linspace(10, 120, 100)
fwhm_values = caglioti_fwhm(two_theta_range, U, V, W)

import matplotlib.pyplot as plt

plt.figure(figsize=(10, 6))
plt.plot(two_theta_range, fwhm_values, color='#f093fb', linewidth=2)
plt.xlabel('2Î¸ [åº¦]', fontsize=12)
plt.ylabel('FWHM [åº¦]', fontsize=12)
plt.title('Cagliotiå¼: FWHMã®è§’åº¦ä¾å­˜æ€§', fontsize=14)
plt.grid(alpha=0.3)
plt.tight_layout()
plt.show()

print("=== FWHMè¨ˆç®—ä¾‹ ===")
for angle in [20, 40, 60, 80, 100]:
    fwhm = caglioti_fwhm(angle, U, V, W)
    print(f"2Î¸ = {angle:3d}Â°: FWHM = {fwhm:.4f}Â°")</code></pre>

        <h3>3.2.2 Thompson-Cox-Hastings Pseudo-Voigt (TCH-pV)</h3>

        <p>ã‚ˆã‚Šé«˜ç²¾åº¦ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•°ã¨ã—ã¦ã€TCH-pVãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯Gaussianã¨Lorentzianã®å„æˆåˆ†ã®FWHMã‚’ç‹¬ç«‹ã«æ‰±ã„ã¾ã™:</p>

        <pre><code class="language-python">def tch_pseudo_voigt(x, center, fwhm_G, fwhm_L):
    """Thompson-Cox-Hastings Pseudo-Voigté–¢æ•°

    Args:
        x (np.ndarray): 2Î¸
        center (float): ãƒ”ãƒ¼ã‚¯ä¸­å¿ƒ
        fwhm_G (float): Gaussianæˆåˆ†ã®FWHM
        fwhm_L (float): Lorentzianæˆåˆ†ã®FWHM

    Returns:
        np.ndarray: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
    """
    # æœ‰åŠ¹FWHM
    fwhm_eff = (fwhm_G**5 + 2.69269 * fwhm_G**4 * fwhm_L +
                2.42843 * fwhm_G**3 * fwhm_L**2 +
                4.47163 * fwhm_G**2 * fwhm_L**3 +
                0.07842 * fwhm_G * fwhm_L**4 + fwhm_L**5) ** 0.2

    # æ··åˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ Î·
    eta = 1.36603 * (fwhm_L / fwhm_eff) - 0.47719 * (fwhm_L / fwhm_eff)**2 + \
          0.11116 * (fwhm_L / fwhm_eff)**3

    # Gaussianæˆåˆ†
    sigma_G = fwhm_eff / (2 * np.sqrt(2 * np.log(2)))
    G = np.exp(-0.5 * ((x - center) / sigma_G)**2) / (sigma_G * np.sqrt(2 * np.pi))

    # Lorentzianæˆåˆ†
    gamma_L = fwhm_eff / 2
    L = gamma_L / (np.pi * (gamma_L**2 + (x - center)**2))

    return eta * L + (1 - eta) * G


# æ¯”è¼ƒ: å˜ç´”pV vs TCH-pV
x = np.linspace(44, 46, 500)
center = 45.0

# å˜ç´”pV
simple_pv = RietveldRefinement(x, np.zeros_like(x))._pseudo_voigt_profile(
    x, center, fwhm=0.2, eta=0.5
)

# TCH-pV
tch_pv = tch_pseudo_voigt(x, center, fwhm_G=0.15, fwhm_L=0.1)

plt.figure(figsize=(10, 6))
plt.plot(x, simple_pv, label='å˜ç´”Pseudo-Voigt', color='#3498db', linewidth=2)
plt.plot(x, tch_pv, label='TCH Pseudo-Voigt', color='#f093fb', linewidth=2, linestyle='--')
plt.xlabel('2Î¸ [åº¦]', fontsize=12)
plt.ylabel('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å¼·åº¦ (æ­£è¦åŒ–)', fontsize=12)
plt.title('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•°ã®æ¯”è¼ƒ', fontsize=14)
plt.legend(fontsize=11)
plt.grid(alpha=0.3)
plt.tight_layout()
plt.show()</code></pre>

        <h2>3.3 ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¢ãƒ‡ãƒ«</h2>

        <h3>3.3.1 Chebyshevå¤šé …å¼</h3>

        <p>Chebyshevå¤šé …å¼ã¯ã€ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ã™ã‚‹éš›ã®æ¨™æº–çš„ãªé¸æŠè‚¢ã§ã™ã€‚æ•°å€¤çš„ã«å®‰å®šã§ã€å°‘ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§è¤‡é›‘ãªå½¢çŠ¶ã‚’è¡¨ç¾ã§ãã¾ã™:</p>

        <p style="text-align: center; font-size: 1.05em; margin: 1.5em 0;">
            \[ y_{bg}(x) = \sum_{n=0}^{N} c_n T_n(x) \]
        </p>

        <p>ã“ã“ã§ã€\( T_n(x) \) ã¯ç¬¬\( n \)æ¬¡Chebyshevå¤šé …å¼ã€\( x \in [-1, 1] \) (æ­£è¦åŒ–ã•ã‚ŒãŸ2Î¸)ã§ã™ã€‚</p>

        <pre><code class="language-python">import numpy.polynomial.chebyshev as cheb

class BackgroundModel:
    """ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚¯ãƒ©ã‚¹"""

    def __init__(self, two_theta_range):
        """
        Args:
            two_theta_range (tuple): (min, max) æ¸¬å®šç¯„å›²
        """
        self.two_theta_min = two_theta_range[0]
        self.two_theta_max = two_theta_range[1]

    def normalize_two_theta(self, two_theta):
        """2Î¸ã‚’[-1, 1]ã«æ­£è¦åŒ–

        Args:
            two_theta (np.ndarray): 2Î¸è§’åº¦

        Returns:
            np.ndarray: æ­£è¦åŒ–ã•ã‚ŒãŸå€¤
        """
        return 2 * (two_theta - self.two_theta_min) / (self.two_theta_max - self.two_theta_min) - 1

    def chebyshev_background(self, two_theta, coefficients):
        """Chebyshevå¤šé …å¼ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è¨ˆç®—

        Args:
            two_theta (np.ndarray): 2Î¸è§’åº¦
            coefficients (list): Chebyshevä¿‚æ•° [c0, c1, c2, ...]

        Returns:
            np.ndarray: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¼·åº¦
        """
        x_norm = self.normalize_two_theta(two_theta)
        return cheb.chebval(x_norm, coefficients)

    def fit_background(self, two_theta, intensity, degree=5, exclude_peaks=True):
        """ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ãƒ•ã‚£ãƒƒãƒˆ

        Args:
            two_theta (np.ndarray): 2Î¸è§’åº¦
            intensity (np.ndarray): å¼·åº¦
            degree (int): Chebyshevå¤šé …å¼ã®æ¬¡æ•°
            exclude_peaks (bool): ãƒ”ãƒ¼ã‚¯é ˜åŸŸã‚’é™¤å¤–ã™ã‚‹ã‹

        Returns:
            np.ndarray: Chebyshevä¿‚æ•°
        """
        x_norm = self.normalize_two_theta(two_theta)

        if exclude_peaks:
            # å¼·åº¦ãŒé«˜ã„é ˜åŸŸã‚’é™¤å¤– (ç°¡æ˜“ç‰ˆ)
            threshold = np.percentile(intensity, 60)
            mask = intensity < threshold
            coeffs = cheb.chebfit(x_norm[mask], intensity[mask], degree)
        else:
            coeffs = cheb.chebfit(x_norm, intensity, degree)

        return coeffs


# ä½¿ç”¨ä¾‹
two_theta = np.linspace(10, 80, 3500)

# è¤‡é›‘ãªãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å½¢çŠ¶ã‚’æ¨¡æ“¬
true_bg = 200 * np.exp(-two_theta / 40) + 50 + 10 * np.sin(two_theta / 10)

# ãƒ”ãƒ¼ã‚¯è¿½åŠ 
peak1 = 1000 * np.exp(-0.5 * ((two_theta - 45) / 0.15)**2)
peak2 = 500 * np.exp(-0.5 * ((two_theta - 65) / 0.18)**2)
intensity = true_bg + peak1 + peak2 + np.random.normal(0, 5, len(two_theta))

# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ•ã‚£ãƒƒãƒˆ
bg_model = BackgroundModel((10, 80))

# ç•°ãªã‚‹æ¬¡æ•°ã§ãƒ•ã‚£ãƒƒãƒˆ
degrees = [3, 5, 7, 10]
plt.figure(figsize=(12, 8))

plt.subplot(2, 1, 1)
plt.plot(two_theta, intensity, 'gray', alpha=0.5, label='å…¨ãƒ‡ãƒ¼ã‚¿')
plt.plot(two_theta, true_bg, 'k--', linewidth=2, label='çœŸã®BG')

for deg in degrees:
    coeffs = bg_model.fit_background(two_theta, intensity, degree=deg, exclude_peaks=True)
    bg_fitted = bg_model.chebyshev_background(two_theta, coeffs)
    plt.plot(two_theta, bg_fitted, linewidth=1.5, label=f'Chebyshev deg={deg}')

plt.xlabel('2Î¸ [åº¦]')
plt.ylabel('å¼·åº¦ [counts]')
plt.title('Chebyshevãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°')
plt.legend()
plt.grid(alpha=0.3)

plt.subplot(2, 1, 2)
# æ®‹å·®ãƒ—ãƒ­ãƒƒãƒˆ
best_deg = 5
coeffs = bg_model.fit_background(two_theta, intensity, degree=best_deg, exclude_peaks=True)
bg_fitted = bg_model.chebyshev_background(two_theta, coeffs)
residual = intensity - bg_fitted

plt.plot(two_theta, residual, color='#f093fb', linewidth=1)
plt.axhline(y=0, color='k', linestyle='--', linewidth=0.8)
plt.xlabel('2Î¸ [åº¦]')
plt.ylabel('æ®‹å·® [counts]')
plt.title(f'æ®‹å·® (Chebyshev degree={best_deg})')
plt.grid(alpha=0.3)

plt.tight_layout()
plt.show()

print(f"=== Chebyshevä¿‚æ•° (degree={best_deg}) ===")
for i, c in enumerate(coeffs):
    print(f"c_{i} = {c:10.4f}")</code></pre>

        <h2>3.4 Rå› å­ã¨é©åˆåº¦è©•ä¾¡</h2>

        <h3>3.4.1 Rå› å­ã®å®šç¾©</h3>

        <p>ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã®å“è³ªã¯ã€æ§˜ã€…ãªRå› å­ã§è©•ä¾¡ã•ã‚Œã¾ã™:</p>

        <p><strong>Rwp (Weighted Profile R-factor)</strong> - æœ€ã‚‚é‡è¦:</p>
        <p style="text-align: center; font-size: 1.05em; margin: 1.5em 0;">
            \[ R_{wp} = \sqrt{\frac{\sum_i w_i (y_i^{obs} - y_i^{calc})^2}{\sum_i w_i (y_i^{obs})^2}} \times 100\% \]
        </p>

        <p><strong>Rp (Profile R-factor)</strong> - é‡ã¿ãªã—ç‰ˆ:</p>
        <p style="text-align: center; font-size: 1.05em; margin: 1.5em 0;">
            \[ R_p = \frac{\sum_i |y_i^{obs} - y_i^{calc}|}{\sum_i y_i^{obs}} \times 100\% \]
        </p>

        <p><strong>RBragg (Bragg R-factor)</strong> - ç©åˆ†å¼·åº¦ãƒ™ãƒ¼ã‚¹:</p>
        <p style="text-align: center; font-size: 1.05em; margin: 1.5em 0;">
            \[ R_B = \frac{\sum_{hkl} |I_{hkl}^{obs} - I_{hkl}^{calc}|}{\sum_{hkl} I_{hkl}^{obs}} \times 100\% \]
        </p>

        <p><strong>GOF (Goodness of Fit)</strong> - æœŸå¾…å€¤ã¨ã®æ¯”è¼ƒ:</p>
        <p style="text-align: center; font-size: 1.05em; margin: 1.5em 0;">
            \[ \text{GOF} = \sqrt{\frac{\sum_i w_i (y_i^{obs} - y_i^{calc})^2}{N - P}} = \frac{R_{wp}}{R_{exp}} \]
        </p>

        <p>ã“ã“ã§ã€\( N \) ã¯ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆæ•°ã€\( P \) ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ã€\( R_{exp} \) ã¯æœŸå¾…ã•ã‚Œã‚‹Rå› å­ã§ã™ã€‚</p>

        <table>
            <thead>
                <tr>
                    <th>Rå› å­</th>
                    <th>å„ªã‚ŒãŸ</th>
                    <th>è‰¯å¥½</th>
                    <th>è¨±å®¹</th>
                    <th>å•é¡Œã‚ã‚Š</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Rwp</td>
                    <td>&lt; 5%</td>
                    <td>5-10%</td>
                    <td>10-15%</td>
                    <td>&gt; 15%</td>
                </tr>
                <tr>
                    <td>RBragg</td>
                    <td>&lt; 3%</td>
                    <td>3-7%</td>
                    <td>7-12%</td>
                    <td>&gt; 12%</td>
                </tr>
                <tr>
                    <td>GOF</td>
                    <td>1.0-1.3</td>
                    <td>1.3-2.0</td>
                    <td>2.0-3.0</td>
                    <td>&gt; 3.0 ã¾ãŸã¯ &lt; 1.0</td>
                </tr>
            </tbody>
        </table>

        <h3>3.4.2 Rå› å­è¨ˆç®—ã®å®Ÿè£…</h3>

        <pre><code class="language-python">class RFactorCalculator:
    """Rå› å­è¨ˆç®—ã‚¯ãƒ©ã‚¹"""

    @staticmethod
    def calculate_rwp(y_obs, y_calc, weights=None):
        """Weighted Profile R-factorã‚’è¨ˆç®—

        Args:
            y_obs (np.ndarray): è¦³æ¸¬å¼·åº¦
            y_calc (np.ndarray): è¨ˆç®—å¼·åº¦
            weights (np.ndarray): é‡ã¿ (Noneã®å ´åˆã¯1/y_obs)

        Returns:
            float: Rwp [%]
        """
        if weights is None:
            weights = 1.0 / np.sqrt(np.maximum(y_obs, 1.0))

        numerator = np.sum(weights * (y_obs - y_calc)**2)
        denominator = np.sum(weights * y_obs**2)

        return 100 * np.sqrt(numerator / denominator)

    @staticmethod
    def calculate_rp(y_obs, y_calc):
        """Profile R-factorã‚’è¨ˆç®—

        Returns:
            float: Rp [%]
        """
        numerator = np.sum(np.abs(y_obs - y_calc))
        denominator = np.sum(y_obs)

        return 100 * numerator / denominator

    @staticmethod
    def calculate_rexp(y_obs, n_params, weights=None):
        """Expected R-factorã‚’è¨ˆç®—

        Args:
            y_obs (np.ndarray): è¦³æ¸¬å¼·åº¦
            n_params (int): ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°
            weights (np.ndarray): é‡ã¿

        Returns:
            float: Rexp [%]
        """
        if weights is None:
            weights = 1.0 / np.sqrt(np.maximum(y_obs, 1.0))

        N = len(y_obs)
        numerator = N - n_params
        denominator = np.sum(weights * y_obs**2)

        return 100 * np.sqrt(numerator / denominator)

    @staticmethod
    def calculate_gof(rwp, rexp):
        """Goodness of Fitã‚’è¨ˆç®—

        Returns:
            float: GOF
        """
        return rwp / rexp

    @classmethod
    def calculate_all_r_factors(cls, y_obs, y_calc, n_params, weights=None):
        """å…¨ã¦ã®Rå› å­ã‚’è¨ˆç®—

        Returns:
            dict: Rå› å­ã®è¾æ›¸
        """
        rwp = cls.calculate_rwp(y_obs, y_calc, weights)
        rp = cls.calculate_rp(y_obs, y_calc)
        rexp = cls.calculate_rexp(y_obs, n_params, weights)
        gof = cls.calculate_gof(rwp, rexp)

        return {
            'Rwp': rwp,
            'Rp': rp,
            'Rexp': rexp,
            'GOF': gof
        }


# ä½¿ç”¨ä¾‹
# æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿: è‰¯å¥½ãªãƒ•ã‚£ãƒƒãƒˆ
np.random.seed(42)
y_obs = np.abs(np.random.normal(1000, 50, 1000))
y_calc_good = y_obs + np.random.normal(0, 10, 1000)  # å°ã•ã„èª¤å·®

# æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿: ä¸è‰¯ãªãƒ•ã‚£ãƒƒãƒˆ
y_calc_bad = y_obs + np.random.normal(0, 100, 1000)  # å¤§ãã„èª¤å·®

n_params = 15  # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°

# Rå› å­è¨ˆç®—
r_good = RFactorCalculator.calculate_all_r_factors(y_obs, y_calc_good, n_params)
r_bad = RFactorCalculator.calculate_all_r_factors(y_obs, y_calc_bad, n_params)

print("=== Rå› å­æ¯”è¼ƒ ===")
print("\nè‰¯å¥½ãªãƒ•ã‚£ãƒƒãƒˆ:")
for key, value in r_good.items():
    print(f"  {key:<6}: {value:6.2f}{'%' if key != 'GOF' else ''}")

print("\nä¸è‰¯ãªãƒ•ã‚£ãƒƒãƒˆ:")
for key, value in r_bad.items():
    print(f"  {key:<6}: {value:6.2f}{'%' if key != 'GOF' else ''}")

# åˆ¤å®š
print("\nåˆ¤å®š:")
if r_good['Rwp'] < 10 and 1.0 < r_good['GOF'] < 2.0:
    print("  è‰¯å¥½: Rwp < 10%, 1.0 < GOF < 2.0 âœ“")
else:
    print("  è¦æ”¹å–„")

if r_bad['Rwp'] > 15 or r_bad['GOF'] > 3.0:
    print("  ä¸è‰¯: Rwp > 15% ã¾ãŸã¯ GOF > 3.0 âœ—")</code></pre>

        <h2>3.5 Pythonå®Ÿè£…åŸºç¤ (lmfitä½¿ç”¨)</h2>

        <h3>3.5.1 lmfit.Minimizerã®å°å…¥</h3>

        <p>lmfitãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€scipy.optimizeã‚’ãƒ©ãƒƒãƒ—ã—ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¢ƒç•Œè¨­å®šã€åˆ¶ç´„æ¡ä»¶ã€ã‚¨ãƒ©ãƒ¼æ¨å®šã‚’ç°¡å˜ã«æ‰±ãˆã¾ã™:</p>

        <pre><code class="language-python"># lmfitã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å¿…è¦ãªå ´åˆ)
# !pip install lmfit

from lmfit import Parameters, Minimizer, report_fit

class LmfitRietveldRefinement:
    """lmfitã‚’ç”¨ã„ãŸãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æ"""

    def __init__(self, two_theta_obs, intensity_obs):
        self.two_theta_obs = two_theta_obs
        self.intensity_obs = intensity_obs
        self.weights = 1.0 / np.sqrt(np.maximum(intensity_obs, 1.0))

    def setup_parameters(self):
        """ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åˆæœŸå€¤ã¨å¢ƒç•Œã‚’è¨­å®š

        Returns:
            lmfit.Parameters: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        """
        params = Parameters()

        # ã‚¹ã‚±ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼
        params.add('scale', value=1000, min=0, max=1e6)

        # Cagliotiãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        params.add('U', value=0.01, min=0, max=1.0)
        params.add('V', value=-0.005, min=-1.0, max=1.0)
        params.add('W', value=0.005, min=0, max=1.0)

        # Pseudo-Voigtæ··åˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        params.add('eta', value=0.5, min=0, max=1)

        # Chebyshevãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä¿‚æ•°
        params.add('bg0', value=100, min=0)
        params.add('bg1', value=0)
        params.add('bg2', value=0)
        params.add('bg3', value=0)

        # æ ¼å­å®šæ•° (ç«‹æ–¹æ™¶ã®ä¾‹)
        params.add('a', value=2.87, min=2.8, max=3.0)

        return params

    def calculate_pattern_lmfit(self, params, two_theta, hkl_list):
        """lmfitãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å›æŠ˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨ˆç®—

        Args:
            params (lmfit.Parameters): ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            two_theta (np.ndarray): 2Î¸
            hkl_list (list): [(h, k, l, multiplicity, |F|^2), ...]

        Returns:
            np.ndarray: è¨ˆç®—å¼·åº¦
        """
        # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æŠ½å‡º
        scale = params['scale'].value
        U = params['U'].value
        V = params['V'].value
        W = params['W'].value
        eta = params['eta'].value
        a = params['a'].value

        bg_coeffs = [params[f'bg{i}'].value for i in range(4)]

        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰
        bg_model = BackgroundModel((two_theta.min(), two_theta.max()))
        background = bg_model.chebyshev_background(two_theta, bg_coeffs)

        # ãƒ”ãƒ¼ã‚¯è¨ˆç®—
        intensity_peaks = np.zeros_like(two_theta)
        wavelength = 1.54056  # Cu KÎ±

        for h, k, l, mult, F_sq in hkl_list:
            # då€¤è¨ˆç®— (ç«‹æ–¹æ™¶)
            d = a / np.sqrt(h**2 + k**2 + l**2)

            # Braggè§’
            theta = np.degrees(np.arcsin(wavelength / (2 * d)))
            peak_2theta = 2 * theta

            # FWHM (Cagliotiå¼)
            fwhm = caglioti_fwhm(peak_2theta, U, V, W)

            # Pseudo-Voigtãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
            profile = self._pseudo_voigt_profile(two_theta, peak_2theta, fwhm, eta)

            # ã‚¹ã‚±ãƒ¼ãƒ« Ã— å¤šé‡åº¦ Ã— æ§‹é€ å› å­
            intensity_peaks += scale * mult * F_sq * profile

        return background + intensity_peaks

    def _pseudo_voigt_profile(self, x, center, fwhm, eta):
        """Pseudo-Voigtãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«"""
        sigma = fwhm / (2 * np.sqrt(2 * np.log(2)))
        gauss = np.exp(-0.5 * ((x - center) / sigma) ** 2) / (sigma * np.sqrt(2 * np.pi))

        gamma = fwhm / 2
        lorentz = gamma / (np.pi * (gamma**2 + (x - center)**2))

        return eta * lorentz + (1 - eta) * gauss

    def residual_lmfit(self, params, two_theta, intensity_obs, weights, hkl_list):
        """lmfitç”¨ã®æ®‹å·®é–¢æ•°

        Returns:
            np.ndarray: é‡ã¿ä»˜ãæ®‹å·®
        """
        y_calc = self.calculate_pattern_lmfit(params, two_theta, hkl_list)
        return (intensity_obs - y_calc) * weights


# å®Ÿè¡Œä¾‹
def run_lmfit_rietveld():
    """lmfitã§ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã‚’å®Ÿè¡Œ"""
    # æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (Î±-Fe BCC)
    two_theta = np.linspace(40, 90, 2500)

    hkl_list = [
        (1, 1, 0, 12, 1.0),
        (2, 0, 0, 6, 0.8),
        (2, 1, 1, 24, 1.2),
        (2, 2, 0, 12, 0.6),
    ]

    # çœŸã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§è¨ˆç®—
    true_params = {
        'scale': 5000,
        'U': 0.01, 'V': -0.005, 'W': 0.005,
        'eta': 0.5,
        'bg0': 100, 'bg1': -10, 'bg2': 2, 'bg3': 0,
        'a': 2.87
    }

    rietveld = LmfitRietveldRefinement(two_theta, np.zeros_like(two_theta))

    # çœŸã®ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆ
    params_true = rietveld.setup_parameters()
    for key, value in true_params.items():
        params_true[key].value = value

    y_true = rietveld.calculate_pattern_lmfit(params_true, two_theta, hkl_list)
    y_obs = y_true + np.random.normal(0, np.sqrt(y_true + 10), len(y_true))

    # åˆæœŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (çœŸå€¤ã‹ã‚‰å°‘ã—ãšã‚‰ã™)
    params_init = rietveld.setup_parameters()
    params_init['scale'].value = 4500
    params_init['a'].value = 2.90

    # æœ€å°åŒ–å®Ÿè¡Œ
    minimizer = Minimizer(
        rietveld.residual_lmfit,
        params_init,
        fcn_args=(two_theta, y_obs, rietveld.weights, hkl_list)
    )

    result = minimizer.minimize(method='leastsq')  # Levenberg-Marquardtæ³•

    # çµæœè¡¨ç¤º
    print("=== ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æçµæœ (lmfit) ===\n")
    report_fit(result)

    # Rå› å­è¨ˆç®—
    y_final = rietveld.calculate_pattern_lmfit(result.params, two_theta, hkl_list)
    r_factors = RFactorCalculator.calculate_all_r_factors(
        y_obs, y_final, result.nvarys, rietveld.weights
    )

    print("\n=== Rå› å­ ===")
    for key, value in r_factors.items():
        print(f"{key:<6}: {value:6.2f}{'%' if key != 'GOF' else ''}")

    # ãƒ—ãƒ­ãƒƒãƒˆ
    plt.figure(figsize=(12, 8))

    plt.subplot(2, 1, 1)
    plt.plot(two_theta, y_obs, 'o', markersize=2, color='gray', alpha=0.5, label='è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿')
    plt.plot(two_theta, y_final, color='#f093fb', linewidth=2, label='è¨ˆç®—ãƒ‘ã‚¿ãƒ¼ãƒ³')
    plt.xlabel('2Î¸ [åº¦]')
    plt.ylabel('å¼·åº¦ [counts]')
    plt.title('ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æ: ãƒ•ã‚£ãƒƒãƒˆçµæœ')
    plt.legend()
    plt.grid(alpha=0.3)

    plt.subplot(2, 1, 2)
    residual = y_obs - y_final
    plt.plot(two_theta, residual, color='#f5576c', linewidth=1)
    plt.axhline(y=0, color='k', linestyle='--', linewidth=0.8)
    plt.xlabel('2Î¸ [åº¦]')
    plt.ylabel('æ®‹å·® [counts]')
    plt.title(f'æ®‹å·®ãƒ—ãƒ­ãƒƒãƒˆ (Rwp = {r_factors["Rwp"]:.2f}%)')
    plt.grid(alpha=0.3)

    plt.tight_layout()
    plt.show()

    return result

# å®Ÿè¡Œ
# result = run_lmfit_rietveld()  # ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤ã—ã¦å®Ÿè¡Œ</code></pre>

        <h2>å­¦ç¿’ç›®æ¨™ã®ç¢ºèª</h2>

        <div class="learning-objectives">
            <h3>åŸºæœ¬ç†è§£</h3>
            <ul>
                <li>âœ… ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆæ³•ã®å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°åŸç†ã¨æœ€å°äºŒä¹—æ³•</li>
                <li>âœ… Pseudo-Voigté–¢æ•°ã¨Cagliotiå¼ã®ç‰©ç†çš„æ„å‘³</li>
                <li>âœ… Chebyshevå¤šé …å¼ã«ã‚ˆã‚‹ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®åˆ©ç‚¹</li>
                <li>âœ… Rå› å­(Rwp, Rp, RBragg, GOF)ã®å®šç¾©ã¨è©•ä¾¡åŸºæº–</li>
            </ul>

            <h3>å®Ÿè·µã‚¹ã‚­ãƒ«</h3>
            <ul>
                <li>âœ… NumPyã§Pseudo-Voigtãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•°ã‚’å®Ÿè£…</li>
                <li>âœ… Chebyshevå¤šé …å¼ã§è¤‡é›‘ãªãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ãƒ•ã‚£ãƒƒãƒˆ</li>
                <li>âœ… Rå› å­ã‚’è¨ˆç®—ã—ã€ãƒ•ã‚£ãƒƒãƒˆå“è³ªã‚’å®šé‡çš„ã«è©•ä¾¡</li>
                <li>âœ… lmfit.Minimizerã§å®Ÿè·µçš„ãªãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã‚’å®Ÿè¡Œ</li>
            </ul>

            <h3>å¿œç”¨åŠ›</h3>
            <ul>
                <li>âœ… ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åˆæœŸå€¤ãƒ»å¢ƒç•Œã‚’é©åˆ‡ã«è¨­å®š</li>
                <li>âœ… ãƒ•ã‚£ãƒƒãƒˆçµæœã‹ã‚‰æ ¼å­å®šæ•°ã€FWHMã€ã‚¹ã‚±ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’æŠ½å‡º</li>
                <li>âœ… æ®‹å·®ãƒ—ãƒ­ãƒƒãƒˆã¨Rå› å­ã‹ã‚‰ç²¾å¯†åŒ–ã®å•é¡Œç‚¹ã‚’è¨ºæ–­</li>
            </ul>
        </div>

        <h2>æ¼”ç¿’å•é¡Œ</h2>

        <h3>Easy (åŸºç¤ç¢ºèª)</h3>

        <details>
            <summary><strong>Q1</strong>: Rwp = 8.5%, Rexp = 5.2% ã®å ´åˆã€GOFã¯ã„ãã¤ã§ã™ã‹? ã“ã®çµæœã¯è‰¯å¥½ã§ã™ã‹?</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <pre><code>GOF = Rwp / Rexp = 8.5 / 5.2 = 1.63</code></pre>
            <p><strong>åˆ¤å®š</strong>: GOF = 1.63 ã¯ <strong>1.3-2.0ã®ç¯„å›²</strong> â†’ è‰¯å¥½ãªãƒ•ã‚£ãƒƒãƒˆ âœ“</p>
            <p>GOF > 2.0 ã ã¨å•é¡Œã‚ã‚Šã€GOF < 1.0 ã¯éå‰°ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã®å¯èƒ½æ€§ã‚ã‚Šã€‚</p>
        </details>

        <details>
            <summary><strong>Q2</strong>: Cagliotiå¼ã§ã€2Î¸ = 30Â°ã®ä½ç½®ã®FWHMã‚’è¨ˆç®—ã—ã¦ãã ã•ã„ (U=0.01, V=-0.005, W=0.005)ã€‚</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <pre><code class="language-python">fwhm = caglioti_fwhm(two_theta=30, U=0.01, V=-0.005, W=0.005)
print(f"FWHM at 2Î¸=30Â°: {fwhm:.4f}Â°")
# å‡ºåŠ›: FWHM at 2Î¸=30Â°: 0.0844Â°</code></pre>
        </details>

        <h3>Medium (å¿œç”¨)</h3>

        <details>
            <summary><strong>Q3</strong>: Chebyshevå¤šé …å¼ã®æ¬¡æ•°ã‚’3æ¬¡ã‹ã‚‰7æ¬¡ã«å¢—ã‚„ã™ã¨ã€Rwpã¯å¿…ãšæ”¹å–„ã—ã¾ã™ã‹? ç†ç”±ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <p><strong>çµè«–</strong>: é€šå¸¸ã¯æ”¹å–„ã—ã¾ã™ãŒã€å¿…ãšã—ã‚‚ç‰©ç†çš„ã«æ­£ã—ã„ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚</p>
            <p><strong>ç†ç”±</strong>:</p>
            <ul>
                <li><strong>Rwpã¯æ¸›å°‘</strong>: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¢—ãˆã‚‹ã»ã©ã€ãƒ‡ãƒ¼ã‚¿ã¸ã®ãƒ•ã‚£ãƒƒãƒˆã¯æ”¹å–„</li>
                <li><strong>ã—ã‹ã—...</strong></li>
                <ul>
                    <li>éå‰°ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°: ãƒ”ãƒ¼ã‚¯éƒ¨åˆ†ã¾ã§BGã¨ã—ã¦æ‰±ã†å¯èƒ½æ€§</li>
                    <li>GOFã®æ‚ªåŒ–: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°PãŒå¢—ãˆã‚‹ã¨RexpãŒå°ã•ããªã‚Šã€GOF = Rwp/Rexp ãŒä¸Šæ˜‡</li>
                    <li>ç‰©ç†çš„æ„å‘³ã®å–ªå¤±: 7æ¬¡ä»¥ä¸Šã®å¤šé …å¼ã¯æŒ¯å‹•ã—ã€éç‰©ç†çš„ãªBGå½¢çŠ¶ã‚’ç”Ÿæˆ</li>
                </ul>
            </ul>
            <p><strong>æ¨å¥¨</strong>: 3-5æ¬¡ã®Chebyshevå¤šé …å¼ãŒå®Ÿç”¨çš„ã€‚è¦–è¦šçš„è©•ä¾¡ã¨GOFã‚’ç¢ºèªã™ã‚‹ã“ã¨ã€‚</p>
        </details>

        <details>
            <summary><strong>Q4</strong>: Pseudo-Voigté–¢æ•°ã§ã€Î· = 0 ã¨ Î· = 1 ã®ã¨ãã®å½¢çŠ¶ã®é•ã„ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <ul>
                <li><strong>Î· = 0</strong>: å®Œå…¨ãªGaussian â†’ è£¾é‡ãŒæ€¥é€Ÿã«æ¸›è¡°ã€è£…ç½®èµ·å› ã®åºƒãŒã‚Š</li>
                <li><strong>Î· = 1</strong>: å®Œå…¨ãªLorentzian â†’ è£¾é‡ãŒåºƒã„ã€è©¦æ–™èµ·å› (çµæ™¶ã‚µã‚¤ã‚ºã€æ­ªã¿)</li>
            </ul>
            <p>å®Ÿéš›ã®XRDãƒ”ãƒ¼ã‚¯ã¯ä¸¡è€…ã®ä¸­é–“(Î· = 0.3-0.7)ã§ã€è£…ç½®ã¨è©¦æ–™ã®ä¸¡æ–¹ã®åŠ¹æœã‚’åæ˜ ã—ã¾ã™ã€‚</p>
        </details>

        <h3>Hard (ç™ºå±•)</h3>

        <details>
            <summary><strong>Q5</strong>: lmfitã§æ ¼å­å®šæ•°aã‚’ç²¾å¯†åŒ–ã™ã‚‹éš›ã€åˆæœŸå€¤ã‚’2.87Ã…ã¨ã—ã€å¢ƒç•Œã‚’[2.8, 3.0]ã«è¨­å®šã—ã¾ã—ãŸã€‚ãƒ•ã‚£ãƒƒãƒˆå¾Œã€a = 2.999Ã…ã¨ãªã‚Šã¾ã—ãŸã€‚ã“ã®çµæœã‚’ã©ã†è§£é‡ˆã™ã¹ãã§ã™ã‹?</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <p><strong>å•é¡Œ</strong>: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¢ƒç•Œã«å¼µã‚Šä»˜ã„ã¦ã„ã‚‹ â†’ æœ€é©åŒ–ãŒåæŸã—ã¦ã„ãªã„å¯èƒ½æ€§</p>
            <p><strong>å¯¾å‡¦æ³•</strong>:</p>
            <ol>
                <li><strong>å¢ƒç•Œã‚’åºƒã’ã‚‹</strong>: [2.7, 3.2] ã«å¤‰æ›´ã—ã¦å†å®Ÿè¡Œ</li>
                <li><strong>åˆæœŸå€¤ã‚’è¦‹ç›´ã™</strong>: ã‚¤ãƒ³ãƒ‡ã‚­ã‚·ãƒ³ã‚°ã‹ã‚‰æ¨å®šã—ãŸå€¤ã‚’ä½¿ã†</li>
                <li><strong>ä»–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã®ç›¸é–¢ç¢ºèª</strong>: Uãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨aãŒå¼·ãç›¸é–¢ã—ã¦ã„ã‚‹å¯èƒ½æ€§</li>
                <li><strong>æ¶ˆæ»…å‰‡ç¢ºèª</strong>: æƒ³å®šã—ã¦ã„ã‚‹æ ¼å­å‹(BCC/FCC/SC)ãŒæ­£ã—ã„ã‹å†æ¤œè¨¼</li>
                <li><strong>é«˜è§’ãƒ”ãƒ¼ã‚¯ã®ç¢ºèª</strong>: æ ¼å­å®šæ•°ã¯é«˜è§’ãƒ‡ãƒ¼ã‚¿ã«æ•æ„Ÿ â†’ 2Î¸ > 80Â°ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</li>
            </ol>
            <p>å†ç²¾å¯†åŒ–å¾Œã‚‚a = 2.99Ã…ãªã‚‰ã€ãã‚ŒãŒçœŸã®å€¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãŸã ã—<strong>ä»–ã®æ‰‹æ³•(å˜çµæ™¶XRDã€ä¸­æ€§å­å›æŠ˜)ã§æ¤œè¨¼</strong>ãŒæœ›ã¾ã—ã„ã§ã™ã€‚</p>
        </details>

        <h2>å­¦ç¿’ç›®æ¨™ã®ç¢ºèª</h2>

        <p>ã“ã®ç« ã‚’å®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã‚’èª¬æ˜ãƒ»å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š</p>

        <h3>åŸºæœ¬ç†è§£</h3>
        <ul>
            <li>âœ… ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆæ³•ã®åŸç†ï¼ˆæœ€å°äºŒä¹—æ³•ã«ã‚ˆã‚‹å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ï¼‰ã‚’èª¬æ˜ã§ãã‚‹</li>
            <li>âœ… Pseudo-Voigtãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆFWHMã€Î·ï¼‰ã®ç‰©ç†çš„æ„å‘³ã‚’ç†è§£ã—ã¦ã„ã‚‹</li>
            <li>âœ… Chebyshevå¤šé …å¼ã«ã‚ˆã‚‹ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®åˆ©ç‚¹ã‚’èª¬æ˜ã§ãã‚‹</li>
            <li>âœ… Rå› å­ï¼ˆRwp, RB, GOFï¼‰ã®å®šç¾©ã¨è§£é‡ˆåŸºæº–ã‚’ç†è§£ã—ã¦ã„ã‚‹</li>
        </ul>

        <h3>å®Ÿè·µã‚¹ã‚­ãƒ«</h3>
        <ul>
            <li>âœ… Pythonã®lmfitãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚’å®Ÿè£…ã§ãã‚‹</li>
            <li>âœ… ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«åˆæœŸåŒ–ã—ã€ç²¾å¯†åŒ–ã§ãã‚‹</li>
            <li>âœ… ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¤šé …å¼ã§ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã€æœ€é©ãªæ¬¡æ•°ã‚’é¸æŠã§ãã‚‹</li>
            <li>âœ… Rå› å­ã‚’è¨ˆç®—ã—ã€ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°å“è³ªã‚’å®šé‡è©•ä¾¡ã§ãã‚‹</li>
            <li>âœ… å·®åˆ†ãƒ—ãƒ­ãƒƒãƒˆï¼ˆYobs - Ycalcï¼‰ã‚’ç”Ÿæˆã—ã€ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚’è¦–è¦šè©•ä¾¡ã§ãã‚‹</li>
        </ul>

        <h3>å¿œç”¨åŠ›</h3>
        <ul>
            <li>âœ… å®Ÿæ¸¬XRDãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã‚’å®Ÿè¡Œã§ãã‚‹</li>
            <li>âœ… ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç›¸é–¢ã‚’ç†è§£ã—ã€ç²¾å¯†åŒ–æˆ¦ç•¥ã‚’ç«‹æ¡ˆã§ãã‚‹</li>
            <li>âœ… åæŸã—ãªã„å ´åˆã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒã§ãã‚‹</li>
            <li>âœ… ç²¾å¯†åŒ–çµæœã®å¦¥å½“æ€§ã‚’å¤šè§’çš„ã«è©•ä¾¡ã§ãã‚‹</li>
        </ul>

        <h2>å‚è€ƒæ–‡çŒ®</h2>

        <ol>
            <li>Rietveld, H. M. (1969). "A profile refinement method for nuclear and magnetic structures". <em>Journal of Applied Crystallography</em>, 2(2), 65-71. - ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆæ³•ã®å…ƒç¥–è«–æ–‡ã€å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã®åŸºç¤</li>
            <li>Young, R. A. (Ed.). (1993). <em>The Rietveld Method</em>. Oxford University Press. - ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆæ³•ã®ç†è«–ã¨å®Ÿè·µã‚’åŒ…æ‹¬çš„ã«è§£èª¬ã—ãŸæ±ºå®šç‰ˆ</li>
            <li>McCusker, L. B., et al. (1999). "Rietveld refinement guidelines". <em>Journal of Applied Crystallography</em>, 32(1), 36-50. - å›½éš›çµæ™¶å­¦é€£åˆãŒå®šã‚ãŸãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã®å…¬å¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³</li>
            <li>Toby, B. H. (2006). "R factors in Rietveld analysis: How good is good enough?". <em>Powder Diffraction</em>, 21(1), 67-70. - Rå› å­ã®è§£é‡ˆåŸºæº–ã‚’æ˜ç¢ºã«ç¤ºã—ãŸé‡è¦è«–æ–‡</li>
            <li>Thompson, P., Cox, D. E., & Hastings, J. B. (1987). "Rietveld refinement of Debye-Scherrer synchrotron X-ray data from Alâ‚‚Oâ‚ƒ". <em>Journal of Applied Crystallography</em>, 20(2), 79-83. - Pseudo-Voigté–¢æ•°ã®å®šå¼åŒ–è«–æ–‡</li>
            <li>Cheary, R. W., & Coelho, A. (1992). "A fundamental parameters approach to X-ray line-profile fitting". <em>Journal of Applied Crystallography</em>, 25(2), 109-121. - ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç‰©ç†çš„è§£é‡ˆ</li>
            <li>lmfit documentation (2024). "Non-Linear Least-Squares Minimization and Curve-Fitting for Python". - Pythonãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆå®Ÿè£…ã®å®Ÿè·µçš„ã‚¬ã‚¤ãƒ‰</li>
        </ol>

        <h2>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h2>

        <p>ç¬¬3ç« ã§ã¯ã€ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆæ³•ã®ç†è«–ã¨åŸºæœ¬å®Ÿè£…ã‚’å­¦ã³ã¾ã—ãŸã€‚å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é–¢æ•°ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã€ãã—ã¦Rå› å­ã«ã‚ˆã‚‹è©•ä¾¡ã¨ã„ã†ã€ç²¾å¯†è§£æã®åŸºç¤ã‚’ç¿’å¾—ã—ã¾ã—ãŸã€‚</p>

        <p><strong>ç¬¬4ç« </strong>ã§ã¯ã€ã“ã‚Œã‚‰ã®æŠ€è¡“ã‚’ç™ºå±•ã•ã›ã€åŸå­åº§æ¨™ã€æ¸©åº¦å› å­ã€çµæ™¶å­ã‚µã‚¤ã‚ºã€microstrainãªã©ã€ã‚ˆã‚Šè©³ç´°ãªæ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç²¾å¯†åŒ–ã«é€²ã¿ã¾ã™ã€‚åˆ¶ç´„æ¡ä»¶ã‚„æ‹˜æŸæ¡ä»¶ã‚’ç”¨ã„ãŸé«˜åº¦ãªç²¾å¯†åŒ–æ‰‹æ³•ã‚’å­¦ã³ã¾ã™ã€‚</p>

        <div class="navigation">
            <a href="./chapter-2.html" class="nav-button">â† ç¬¬2ç« : ç²‰æœ«XRDæ¸¬å®šã¨è§£æ</a>
            <a href="./chapter-4.html" class="nav-button">ç¬¬4ç« : çµæ™¶æ§‹é€ ç²¾å¯†åŒ– â†’</a>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 MS Terakoya - Materials Science Learning Platform</p>
        <p><a href="../../index.html">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a></p>
    </footer>
</body>
</html>