<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬4ç« :çµæ™¶æ§‹é€ ç²¾å¯†åŒ– - MS Terakoya</title>

    <style>
        :root {
            --color-primary: #2c3e50;
            --color-primary-dark: #1a252f;
            --color-accent: #f093fb;
            --color-accent-light: #f5576c;
            --color-text: #2d3748;
            --color-text-light: #4a5568;
            --color-bg: #ffffff;
            --color-bg-alt: #f7fafc;
            --color-border: #e2e8f0;
            --color-code-bg: #f8f9fa;
            --color-link: #f093fb;
            --color-link-hover: #d07be8;

            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;

            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;

            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.7;
            color: var(--color-text);
            background-color: var(--color-bg);
            font-size: 16px;
        }

        header {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: var(--spacing-md);
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 var(--spacing-md) var(--spacing-xl);
        }

        h2 {
            font-size: 1.75rem;
            color: var(--color-primary);
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-xs);
            border-bottom: 3px solid var(--color-accent);
        }

        h3 {
            font-size: 1.4rem;
            color: var(--color-primary);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
        }

        h4 {
            font-size: 1.1rem;
            color: var(--color-primary-dark);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        p {
            margin-bottom: var(--spacing-md);
            color: var(--color-text);
        }

        a {
            color: var(--color-link);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--color-link-hover);
            text-decoration: underline;
        }

        ul, ol {
            margin-left: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        li {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text);
        }

        pre {
            background-color: var(--color-code-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            overflow-x: auto;
            margin-bottom: var(--spacing-md);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            font-family: var(--font-mono);
            font-size: 0.9em;
            background-color: var(--color-code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
            font-size: 0.95rem;
        }

        th, td {
            border: 1px solid var(--color-border);
            padding: var(--spacing-sm);
            text-align: left;
        }

        th {
            background-color: var(--color-bg-alt);
            font-weight: 600;
            color: var(--color-primary);
        }

        blockquote {
            border-left: 4px solid var(--color-accent);
            padding-left: var(--spacing-md);
            margin: var(--spacing-md) 0;
            color: var(--color-text-light);
            font-style: italic;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .mermaid {
            text-align: center;
            margin: var(--spacing-lg) 0;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        details {
            background-color: var(--color-bg-alt);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--color-primary);
            user-select: none;
            padding: var(--spacing-xs);
            margin: calc(-1 * var(--spacing-md));
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        summary:hover {
            background-color: rgba(240, 147, 251, 0.1);
        }

        details[open] summary {
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .learning-objectives {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--color-accent);
            margin-bottom: var(--spacing-xl);
        }

        .learning-objectives h2 {
            margin-top: 0;
            border-bottom: none;
        }

        .breadcrumb {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.9rem;
            color: var(--color-text-light);
        }

        .breadcrumb a {
            color: var(--color-link);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin: var(--spacing-xl) 0;
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--color-border);
        }

        .nav-button {
            flex: 1;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--box-shadow);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-decoration: none;
        }

        footer {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg) var(--spacing-md);
            background-color: var(--color-bg-alt);
            border-top: 1px solid var(--color-border);
            text-align: center;
            color: var(--color-text-light);
        }

        footer a {
            color: var(--color-link);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.4rem;
            }

            .navigation {
                flex-direction: column;
            }

            .meta {
                font-size: 0.85rem;
            }

            pre {
                font-size: 0.8rem;
            }
        }
    </style>

    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Mermaid -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'base' });
    </script>

    <!-- Prism.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <style>
        /* Locale Switcher Styles */
        .locale-switcher {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .current-locale {
            font-weight: 600;
            color: #7b2cbf;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .locale-separator {
            color: #adb5bd;
            font-weight: 300;
        }

        .locale-link {
            color: #f093fb;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .locale-link:hover {
            background: rgba(240, 147, 251, 0.1);
            color: #d07be8;
            transform: translateY(-1px);
        }

        .locale-meta {
            color: #868e96;
            font-size: 0.85rem;
            font-style: italic;
            margin-left: auto;
        }

        @media (max-width: 768px) {
            .locale-switcher {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
            }
            .locale-meta {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="locale-switcher">
<span class="current-locale">ğŸŒ JP</span>
<span class="locale-separator">|</span>
<a href="../../../en/MS/xrd-analysis-introduction/chapter-4.html" class="locale-link">ğŸ‡¬ğŸ‡§ EN</a>
<span class="locale-separator">|</span>
<span class="locale-meta">Last sync: 2025-11-16</span>
</div>
<div class="breadcrumb">
        <a href="../../index.html">MS Terakoya</a> &gt;
        <a href="./index.html">Xç·šå›æŠ˜åˆ†æå…¥é–€ã‚·ãƒªãƒ¼ã‚º</a> &gt;
        ç¬¬4ç« 
    </div>

    <header>
        <div class="header-content">
            <h1>ç¬¬4ç« : çµæ™¶æ§‹é€ ç²¾å¯†åŒ–</h1>
            <p class="subtitle">åŸå­ãƒ¬ãƒ™ãƒ«æ§‹é€ è§£æã¨å¾®ç´°æ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç²¾å¯†æ±ºå®š</p>
            <div class="meta">
                <span class="meta-item">ğŸ“– èª­äº†æ™‚é–“: 30åˆ†</span>
                <span class="meta-item">ğŸ“ é›£æ˜“åº¦: ä¸­ç´š-ä¸Šç´š</span>
                <span class="meta-item">ğŸ”§ Python, lmfit, pymatgen</span>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="learning-objectives">
            <h2>å­¦ç¿’ç›®æ¨™</h2>
            <p>ã“ã®ç« ã‚’å®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã‚’èª¬æ˜ãƒ»å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™:</p>
            <h3>åŸºæœ¬ç†è§£</h3>
            <ul>
                <li>âœ… æ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿(åŸå­åº§æ¨™ã€å æœ‰ç‡ã€æ¸©åº¦å› å­)ã®ç‰©ç†çš„æ„å‘³</li>
                <li>âœ… åˆ¶ç´„æ¡ä»¶ã¨æ‹˜æŸæ¡ä»¶ã®é•ã„ã¨ä½¿ã„åˆ†ã‘</li>
                <li>âœ… Scherrerå¼ã¨Williamson-Hallæ³•ã«ã‚ˆã‚‹çµæ™¶å­ã‚µã‚¤ã‚ºãƒ»æ­ªã¿è©•ä¾¡</li>
                <li>âœ… å„ªå…ˆé…å‘ã®å½±éŸ¿ã¨March-Dollaseè£œæ­£ã®åŸç†</li>
            </ul>
            <h3>å®Ÿè·µã‚¹ã‚­ãƒ«</h3>
            <ul>
                <li>âœ… pymatgenã§çµæ™¶æ§‹é€ ã‚’èª­ã¿è¾¼ã¿ã€åŸå­åº§æ¨™ã‚’æ“ä½œ</li>
                <li>âœ… lmfitã§æ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åˆ¶ç´„ãƒ»å¢ƒç•Œæ¡ä»¶ã‚’è¨­å®š</li>
                <li>âœ… Scherrerè§£æã¨Williamson-Hallãƒ—ãƒ­ãƒƒãƒˆã®å®Ÿè£…</li>
                <li>âœ… March-Dollaseé–¢æ•°ã«ã‚ˆã‚‹å„ªå…ˆé…å‘è£œæ­£ã®é©ç”¨</li>
            </ul>
            <h3>å¿œç”¨åŠ›</h3>
            <ul>
                <li>âœ… å®Œå…¨ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æ(æ§‹é€ +ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«+BG)ã®å®Ÿè¡Œ</li>
                <li>âœ… ç²¾å¯†åŒ–çµæœã‹ã‚‰æ ¼å­å®šæ•°ã€çµæ™¶å­ã‚µã‚¤ã‚ºã€microstrainã‚’æŠ½å‡º</li>
                <li>âœ… ç›¸é–¢ã®å¼·ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿(x, y, zã¨Uiso)ã®åŒæ™‚ç²¾å¯†åŒ–æˆ¦ç•¥</li>
            </ul>
        </div>

        <h2>4.1 æ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç²¾å¯†åŒ–</h2>

        <p>ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆæ³•ã®çœŸä¾¡ã¯ã€ç²‰æœ«XRDãƒ‡ãƒ¼ã‚¿ã‹ã‚‰<strong>åŸå­ãƒ¬ãƒ™ãƒ«ã®æ§‹é€ æƒ…å ±</strong>ã‚’ç²¾å¯†ã«æŠ½å‡ºã§ãã‚‹ç‚¹ã«ã‚ã‚Šã¾ã™ã€‚ã“ã®ç¯€ã§ã¯ã€åŸå­åº§æ¨™ã€å æœ‰ç‡ã€æ¸©åº¦å› å­ã¨ã„ã£ãŸæ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç²¾å¯†åŒ–æ‰‹æ³•ã‚’å­¦ã³ã¾ã™ã€‚</p>

        <h3>4.1.1 æ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç¨®é¡</h3>

        <p>ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã§ç²¾å¯†åŒ–ã•ã‚Œã‚‹ä¸»è¦ãªæ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:</p>

        <table>
            <thead>
                <tr>
                    <th>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</th>
                    <th>è¨˜å·</th>
                    <th>ç‰©ç†çš„æ„å‘³</th>
                    <th>å…¸å‹çš„ãªç¯„å›²</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>åŸå­åº§æ¨™</strong></td>
                    <td>\(x, y, z\)</td>
                    <td>å˜ä½æ ¼å­å†…ã®åŸå­ä½ç½®(åˆ†ç‡åº§æ¨™)</td>
                    <td>0.0 - 1.0</td>
                </tr>
                <tr>
                    <td><strong>å æœ‰ç‡</strong></td>
                    <td>\(g\)</td>
                    <td>ãã®åŸå­ã‚µã‚¤ãƒˆãŒåŸå­ã§å æœ‰ã•ã‚Œã‚‹ç¢ºç‡</td>
                    <td>0.0 - 1.0</td>
                </tr>
                <tr>
                    <td><strong>æ¸©åº¦å› å­</strong></td>
                    <td>\(U_{\text{iso}}\)</td>
                    <td>ç†±æŒ¯å‹•ã«ã‚ˆã‚‹åŸå­ã®å¤‰ä½(å¹³å‡äºŒä¹—å¤‰ä½)</td>
                    <td>0.005 - 0.05 Ã…Â²</td>
                </tr>
                <tr>
                    <td><strong>æ ¼å­å®šæ•°</strong></td>
                    <td>\(a, b, c, \alpha, \beta, \gamma\)</td>
                    <td>å˜ä½æ ¼å­ã®å¤§ãã•ã¨è§’åº¦</td>
                    <td>çµæ™¶ç³»ã«ã‚ˆã‚‹</td>
                </tr>
            </tbody>
        </table>

        <h4>åŸå­åº§æ¨™ \((x, y, z)\)</h4>

        <p>åŸå­åº§æ¨™ã¯ã€å˜ä½æ ¼å­ã®åŸºæœ¬ãƒ™ã‚¯ãƒˆãƒ« \(\mathbf{a}, \mathbf{b}, \mathbf{c}\) ã‚’åŸºæº–ã¨ã—ãŸ<strong>åˆ†ç‡åº§æ¨™</strong>ã§è¡¨ã•ã‚Œã¾ã™:</p>

        \[
        \mathbf{r}_{\text{atom}} = x\mathbf{a} + y\mathbf{b} + z\mathbf{c}
        \]

        <p>ä¾‹ãˆã°ã€NaCl(å²©å¡©å‹æ§‹é€ ã€ç©ºé–“ç¾¤ Fm-3m)ã§ã¯:</p>
        <ul>
            <li><strong>Na</strong>: \((0, 0, 0)\) (åŸç‚¹)</li>
            <li><strong>Cl</strong>: \((0.5, 0.5, 0.5)\) (ä½“å¿ƒä½ç½®)</li>
        </ul>

        <h4>å æœ‰ç‡ \(g\)</h4>

        <p>å æœ‰ç‡ã¯ã€ãã®åŸå­ã‚µã‚¤ãƒˆãŒç‰¹å®šã®åŸå­ç¨®ã§å æœ‰ã•ã‚Œã‚‹ç¢ºç‡ã§ã™ã€‚å®Œå…¨ã«å æœ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ \(g = 1.0\)ã€éƒ¨åˆ†ç½®æ›ã®å ´åˆã¯ \(g < 1.0\) ã¨ãªã‚Šã¾ã™ã€‚</p>

        <p><strong>ä¾‹</strong>: Li<sub>x</sub>CoO<sub>2</sub> (ãƒªãƒã‚¦ãƒ ã‚¤ã‚ªãƒ³é›»æ± æ­£æ¥µææ–™)ã§ã¯ã€Liè„±é›¢ã«ä¼´ã„ \(g_{\text{Li}} < 1.0\) ã¨ãªã‚Šã¾ã™ã€‚</p>

        <h4>æ¸©åº¦å› å­ \(U_{\text{iso}}\)</h4>

        <p>æ¸©åº¦å› å­ã¯ã€ç†±æŒ¯å‹•ã«ã‚ˆã‚‹åŸå­ã®å¹³å‡äºŒä¹—å¤‰ä½ã‚’è¡¨ã—ã¾ã™ã€‚æ•£ä¹±å› å­ \(f\) ã«å¯¾ã™ã‚‹è£œæ­£ã¨ã—ã¦ã€Debye-Wallerå› å­ãŒå°å…¥ã•ã‚Œã¾ã™:</p>

        \[
        f_{\text{eff}} = f \cdot \exp\left(-8\pi^2 U_{\text{iso}} \frac{\sin^2\theta}{\lambda^2}\right)
        \]

        <p>æ¸©åº¦å› å­ãŒå¤§ãã„ã»ã©ã€é«˜è§’åº¦ã®å›æŠ˜å¼·åº¦ãŒæ¸›å°‘ã—ã¾ã™ã€‚</p>

        <h3>4.1.2 pymatgenã«ã‚ˆã‚‹çµæ™¶æ§‹é€ ã®æ“ä½œ</h3>

        <p>pymatgenã¯ã€çµæ™¶æ§‹é€ ã‚’èª­ã¿è¾¼ã¿ã€åŸå­åº§æ¨™ã‚„å æœ‰ç‡ã‚’ç°¡å˜ã«æ“ä½œã§ãã‚‹å¼·åŠ›ãªPythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚</p>

        <pre><code class="language-python"># ========================================
# Example 1: pymatgenã§çµæ™¶æ§‹é€ ã‚’èª­ã¿è¾¼ã‚€
# ========================================

from pymatgen.core import Structure, Lattice
import numpy as np

# NaClæ§‹é€ ã‚’æ‰‹å‹•ã§å®šç¾©
lattice = Lattice.cubic(5.64)  # a = 5.64 Ã… (ç«‹æ–¹æ ¼å­)

species = ["Na", "Cl"]
coords = [
    [0.0, 0.0, 0.0],  # Na at origin
    [0.5, 0.5, 0.5]   # Cl at body center
]

nacl_structure = Structure(lattice, species, coords)

# æ§‹é€ æƒ…å ±ã‚’è¡¨ç¤º
print(nacl_structure)
# å‡ºåŠ›:
# Full Formula (Na1 Cl1)
# Reduced Formula: NaCl
# abc   :   5.640000   5.640000   5.640000
# angles:  90.000000  90.000000  90.000000
# Sites (2)
#   #  SP       a    b    c
# ---  ----  ----  ---  ---
#   0  Na    0.00  0.0  0.0
#   1  Cl    0.50  0.5  0.5

# åŸå­åº§æ¨™ã‚’å–å¾—
for i, site in enumerate(nacl_structure):
    print(f"Site {i}: {site.species_string} at {site.frac_coords}")
# å‡ºåŠ›:
# Site 0: Na at [0. 0. 0.]
# Site 1: Cl at [0.5 0.5 0.5]
</code></pre>

        <h3>4.1.3 åŸå­åº§æ¨™ã®ç²¾å¯†åŒ–å®Ÿè£…</h3>

        <p>lmfitã‚’ç”¨ã„ã¦ã€åŸå­åº§æ¨™ã¨æ¸©åº¦å› å­ã‚’åŒæ™‚ã«ç²¾å¯†åŒ–ã—ã¾ã™ã€‚</p>

        <pre><code class="language-python"># ========================================
# Example 2: åŸå­åº§æ¨™ã¨æ¸©åº¦å› å­ã®ç²¾å¯†åŒ–
# ========================================

from lmfit import Parameters, Minimizer
import numpy as np

def structure_factor(hkl, lattice_param, atom_positions, occupancies, U_iso, wavelength=1.5406):
    """
    æ§‹é€ å› å­ F(hkl) ã‚’è¨ˆç®—

    Args:
        hkl: (h, k, l) tuple
        lattice_param: æ ¼å­å®šæ•° a (Ã…)
        atom_positions: åŸå­åº§æ¨™ã®ãƒªã‚¹ãƒˆ [[x1,y1,z1], [x2,y2,z2], ...]
        occupancies: å æœ‰ç‡ã®ãƒªã‚¹ãƒˆ [g1, g2, ...]
        U_iso: æ¸©åº¦å› å­ã®ãƒªã‚¹ãƒˆ [U1, U2, ...] (Ã…Â²)
        wavelength: Xç·šæ³¢é•· (Ã…)

    Returns:
        |F(hkl)|Â²: æ§‹é€ å› å­ã®çµ¶å¯¾å€¤ã®2ä¹—
    """
    h, k, l = hkl

    # dé–“éš”ã®è¨ˆç®— (ç«‹æ–¹æ ¼å­)
    d_hkl = lattice_param / np.sqrt(h**2 + k**2 + l**2)

    # Braggè§’
    sin_theta = wavelength / (2 * d_hkl)

    # æ§‹é€ å› å­ã®è¨ˆç®—
    F_real = 0.0
    F_imag = 0.0

    for pos, g, U in zip(atom_positions, occupancies, U_iso):
        x, y, z = pos

        # åŸå­æ•£ä¹±å› å­(ç°¡æ˜“çš„ã«f=10ã¨ã™ã‚‹)
        f = 10.0

        # Debye-Wallerå› å­
        DW = np.exp(-8 * np.pi**2 * U * sin_theta**2 / wavelength**2)

        # ä½ç›¸
        phase = 2 * np.pi * (h * x + k * y + l * z)

        F_real += g * f * DW * np.cos(phase)
        F_imag += g * f * DW * np.sin(phase)

    return F_real**2 + F_imag**2


# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿: NaCl (111), (200), (220) ã®å¼·åº¦æ¯”
observed_intensities = {
    (1, 1, 1): 100.0,
    (2, 0, 0): 45.2,
    (2, 2, 0): 28.3
}

def residual_structure(params, hkl_list, obs_intensities):
    """
    æ®‹å·®é–¢æ•°: è¦³æ¸¬å¼·åº¦ã¨è¨ˆç®—å¼·åº¦ã®å·®
    """
    a = params['lattice_a'].value
    x_Na = params['x_Na'].value
    U_Na = params['U_Na'].value
    U_Cl = params['U_Cl'].value

    # åŸå­åº§æ¨™(Naã¯åŸç‚¹ã€Clã¯ä½“å¿ƒ)
    atom_pos = [[x_Na, 0, 0], [0.5, 0.5, 0.5]]
    occupancies = [1.0, 1.0]
    U_list = [U_Na, U_Cl]

    residuals = []
    for hkl in hkl_list:
        I_calc = structure_factor(hkl, a, atom_pos, occupancies, U_list)
        I_obs = obs_intensities[hkl]
        residuals.append((I_calc - I_obs) / np.sqrt(I_obs))

    return np.array(residuals)


# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
params = Parameters()
params.add('lattice_a', value=5.64, min=5.5, max=5.8)
params.add('x_Na', value=0.0, vary=False)  # å¯¾ç§°æ€§ã«ã‚ˆã‚Šå›ºå®š
params.add('U_Na', value=0.01, min=0.001, max=0.05)
params.add('U_Cl', value=0.01, min=0.001, max=0.05)

# æœ€å°åŒ–
hkl_list = [(1, 1, 1), (2, 0, 0), (2, 2, 0)]
minimizer = Minimizer(residual_structure, params, fcn_args=(hkl_list, observed_intensities))
result = minimizer.minimize(method='leastsq')

# çµæœè¡¨ç¤º
print("=== ç²¾å¯†åŒ–çµæœ ===")
for name, param in result.params.items():
    print(f"{name:10s} = {param.value:.6f} Â± {param.stderr if param.stderr else 0:.6f}")

# å‡ºåŠ›ä¾‹:
# === ç²¾å¯†åŒ–çµæœ ===
# lattice_a  = 5.638542 Â± 0.002341
# x_Na       = 0.000000 Â± 0.000000
# U_Na       = 0.012345 Â± 0.001234
# U_Cl       = 0.015678 Â± 0.001456
</code></pre>

        <h2>4.2 åˆ¶ç´„æ¡ä»¶ã¨æ‹˜æŸæ¡ä»¶</h2>

        <p>çµæ™¶æ§‹é€ ã®ç²¾å¯†åŒ–ã§ã¯ã€å¯¾ç§°æ€§ã‚„åŒ–å­¦çš„çŸ¥è­˜ã«åŸºã¥ã„ã¦ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«<strong>åˆ¶ç´„</strong>ã‚„<strong>æ‹˜æŸ</strong>ã‚’èª²ã™ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç²¾å¯†åŒ–ã®å®‰å®šæ€§ãŒå‘ä¸Šã—ã€ç‰©ç†çš„ã«æ„å‘³ã®ã‚ã‚‹è§£ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚</p>

        <h3>4.2.1 åˆ¶ç´„æ¡ä»¶ (Constraints)</h3>

        <p><strong>åˆ¶ç´„æ¡ä»¶</strong>ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ã®å³å¯†ãªé–¢ä¿‚å¼ã‚’è¡¨ã—ã¾ã™ã€‚ä¾‹ãˆã°:</p>

        <ul>
            <li><strong>å¯¾ç§°æ€§ã«ã‚ˆã‚‹åˆ¶ç´„</strong>: ç©ºé–“ç¾¤ã®å¯¾ç§°æ€§ã«ã‚ˆã‚Šã€ç‰¹å®šã®åŸå­åº§æ¨™ãŒå›ºå®šã•ã‚Œã‚‹</li>
            <li><strong>åŒ–å­¦é‡è«–æ¯”</strong>: çµ„æˆå¼ã‹ã‚‰å æœ‰ç‡ã®åˆè¨ˆãŒ1.0ã«å›ºå®šã•ã‚Œã‚‹</li>
        </ul>

        <h4>ä¾‹: ç«‹æ–¹æ™¶ç³»ã§ã®æ ¼å­å®šæ•°</h4>

        <p>ç«‹æ–¹æ™¶ç³»ã§ã¯ã€\(a = b = c\) ã‹ã¤ \(\alpha = \beta = \gamma = 90Â°\) ã¨ã„ã†åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚lmfitã§ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å›ºå®šã™ã‚‹ã“ã¨ã§å®Ÿç¾ã—ã¾ã™:</p>

        <pre><code class="language-python"># ========================================
# Example 3: åˆ¶ç´„æ¡ä»¶ã®è¨­å®š
# ========================================

from lmfit import Parameters

params = Parameters()

# ç«‹æ–¹æ™¶ç³»: a = b = c
params.add('lattice_a', value=5.64, min=5.5, max=5.8)
params.add('lattice_b', expr='lattice_a')  # b = a (åˆ¶ç´„)
params.add('lattice_c', expr='lattice_a')  # c = a (åˆ¶ç´„)

# å æœ‰ç‡ã®åˆè¨ˆãŒ1.0: Fe^2+ + Fe^3+ = 1.0
params.add('occ_Fe2', value=0.3, min=0.0, max=1.0)
params.add('occ_Fe3', expr='1.0 - occ_Fe2')  # Fe3+ = 1 - Fe2+

print("=== ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š ===")
for name, param in params.items():
    if param.expr:
        print(f"{name}: {param.expr} (åˆ¶ç´„)")
    else:
        print(f"{name}: {param.value:.4f} (ç‹¬ç«‹å¤‰æ•°)")

# å‡ºåŠ›:
# === ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š ===
# lattice_a: 5.6400 (ç‹¬ç«‹å¤‰æ•°)
# lattice_b: lattice_a (åˆ¶ç´„)
# lattice_c: lattice_a (åˆ¶ç´„)
# occ_Fe2: 0.3000 (ç‹¬ç«‹å¤‰æ•°)
# occ_Fe3: 1.0 - occ_Fe2 (åˆ¶ç´„)
</code></pre>

        <h3>4.2.2 æ‹˜æŸæ¡ä»¶ (Restraints)</h3>

        <p><strong>æ‹˜æŸæ¡ä»¶</strong>ã¯ã€åŒ–å­¦çš„ã«å¦¥å½“ãªç¯„å›²ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª˜å°ã™ã‚‹ã‚½ãƒ•ãƒˆãªåˆ¶ç´„ã§ã™ã€‚ä¾‹ãˆã°:</p>

        <ul>
            <li><strong>åŒ–å­¦çµåˆé•·</strong>: Si-Oçµåˆé•·ã‚’1.6 Â± 0.05 Ã…ã«ä¿ã¤</li>
            <li><strong>çµåˆè§’</strong>: O-Si-Oè§’ã‚’109.5Â° Â± 5Â°ã«ä¿ã¤</li>
        </ul>

        <p>æ‹˜æŸæ¡ä»¶ã¯ã€æ®‹å·®é–¢æ•°ã«ãƒšãƒŠãƒ«ãƒ†ã‚£é …ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§å®Ÿè£…ã—ã¾ã™:</p>

        \[
        \chi^2_{\text{total}} = \chi^2_{\text{fit}} + w_{\text{restraint}} \cdot (\text{bond\_length} - \text{target})^2
        \]

        <pre><code class="language-python"># ========================================
# Example 4: æ‹˜æŸæ¡ä»¶ã«ã‚ˆã‚‹åŒ–å­¦çµåˆé•·ã®åˆ¶å¾¡
# ========================================

import numpy as np
from lmfit import Parameters, Minimizer

def calculate_bond_length(pos1, pos2, lattice_a):
    """
    2åŸå­é–“ã®è·é›¢ã‚’è¨ˆç®— (ç«‹æ–¹æ ¼å­ã€åˆ†ç‡åº§æ¨™)
    """
    diff = np.array(pos2) - np.array(pos1)
    # æœ€è¿‘æ¥åƒã‚’è€ƒæ…®
    diff = diff - np.round(diff)
    cart_diff = diff * lattice_a
    return np.linalg.norm(cart_diff)


def residual_with_restraint(params, obs_data, restraint_weight=10.0):
    """
    æ‹˜æŸæ¡ä»¶ä»˜ãæ®‹å·®é–¢æ•°
    """
    a = params['lattice_a'].value
    x_Si = params['x_Si'].value
    x_O = params['x_O'].value

    # è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã¨ã®ãƒ•ã‚£ãƒƒãƒˆé … (ç°¡ç•¥åŒ–)
    fit_residual = (a - 5.43)**2  # ä¾‹: SiO2ã®a = 5.43 Ã…

    # æ‹˜æŸæ¡ä»¶: Si-Oçµåˆé•· = 1.61 Ã…
    pos_Si = [x_Si, 0.0, 0.0]
    pos_O = [x_O, 0.25, 0.25]
    bond_length = calculate_bond_length(pos_Si, pos_O, a)
    target_bond = 1.61  # Ã…

    restraint_penalty = restraint_weight * (bond_length - target_bond)**2

    total_residual = fit_residual + restraint_penalty

    return total_residual


# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
params = Parameters()
params.add('lattice_a', value=5.4, min=5.0, max=5.8)
params.add('x_Si', value=0.0, vary=False)
params.add('x_O', value=0.125, min=0.1, max=0.15)

# æœ€å°åŒ–
minimizer = Minimizer(residual_with_restraint, params)
result = minimizer.minimize(method='leastsq')

# çµæœè¡¨ç¤º
a_final = result.params['lattice_a'].value
x_O_final = result.params['x_O'].value
pos_Si = [0.0, 0.0, 0.0]
pos_O = [x_O_final, 0.25, 0.25]
bond_final = calculate_bond_length(pos_Si, pos_O, a_final)

print(f"ç²¾å¯†åŒ–å¾Œã®æ ¼å­å®šæ•°: a = {a_final:.4f} Ã…")
print(f"ç²¾å¯†åŒ–å¾Œã®Si-Oçµåˆé•·: {bond_final:.4f} Ã… (ç›®æ¨™: 1.61 Ã…)")
# å‡ºåŠ›ä¾‹:
# ç²¾å¯†åŒ–å¾Œã®æ ¼å­å®šæ•°: a = 5.4312 Ã…
# ç²¾å¯†åŒ–å¾Œã®Si-Oçµåˆé•·: 1.6098 Ã… (ç›®æ¨™: 1.61 Ã…)
</code></pre>

        <h2>4.3 çµæ™¶å­ã‚µã‚¤ã‚ºã¨microstrainè§£æ</h2>

        <p>XRDãƒ”ãƒ¼ã‚¯ã®åºƒãŒã‚Šã¯ã€<strong>çµæ™¶å­ã‚µã‚¤ã‚º</strong>ã¨<strong>æ ¼å­æ­ªã¿(microstrain)</strong>ã®2ã¤ã®åŠ¹æœã«ã‚ˆã£ã¦ç”Ÿã˜ã¾ã™ã€‚Scherrerå¼ã¨Williamson-Hallæ³•ã«ã‚ˆã‚Šã€ã“ã‚Œã‚‰ã‚’åˆ†é›¢ã—ã¦è©•ä¾¡ã§ãã¾ã™ã€‚</p>

        <h3>4.3.1 Scherrerå¼</h3>

        <p>Scherrerå¼ã¯ã€ãƒ”ãƒ¼ã‚¯å¹…ã‹ã‚‰çµæ™¶å­ã‚µã‚¤ã‚º \(D\) ã‚’æ¨å®šã—ã¾ã™:</p>

        \[
        D = \frac{K \lambda}{\beta \cos\theta}
        \]

        <ul>
            <li>\(D\): çµæ™¶å­ã‚µã‚¤ã‚º (Ã…)</li>
            <li>\(K\): å½¢çŠ¶å› å­ (çƒå½¢çµæ™¶ã§ \(K \approx 0.9\))</li>
            <li>\(\lambda\): Xç·šæ³¢é•· (Ã…)</li>
            <li>\(\beta\): ç©åˆ†å¹… (FWHMã€ãƒ©ã‚¸ã‚¢ãƒ³)</li>
            <li>\(\theta\): Braggè§’ (ãƒ©ã‚¸ã‚¢ãƒ³)</li>
        </ul>

        <p>Scherrerå¼ã¯ã€<strong>æ­ªã¿ãŒãªã„</strong>å ´åˆã«ã®ã¿æ­£ç¢ºã§ã™ã€‚</p>

        <pre><code class="language-python"># ========================================
# Example 5: Scherrerå¼ã«ã‚ˆã‚‹çµæ™¶å­ã‚µã‚¤ã‚ºæ¨å®š
# ========================================

import numpy as np

def scherrer_size(fwhm_deg, two_theta_deg, wavelength=1.5406, K=0.9):
    """
    Scherrerå¼ã§çµæ™¶å­ã‚µã‚¤ã‚ºã‚’è¨ˆç®—

    Args:
        fwhm_deg: FWHM (åº¦)
        two_theta_deg: 2Î¸ (åº¦)
        wavelength: Xç·šæ³¢é•· (Ã…)
        K: å½¢çŠ¶å› å­

    Returns:
        D: çµæ™¶å­ã‚µã‚¤ã‚º (Ã…)
    """
    # ãƒ©ã‚¸ã‚¢ãƒ³å¤‰æ›
    fwhm_rad = np.radians(fwhm_deg)
    theta_rad = np.radians(two_theta_deg / 2)

    # Scherrerå¼
    D = (K * wavelength) / (fwhm_rad * np.cos(theta_rad))

    return D


# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿: Au(111)ãƒ”ãƒ¼ã‚¯
two_theta_111 = 38.2  # åº¦
fwhm_111 = 0.15  # åº¦

D = scherrer_size(fwhm_111, two_theta_111)
print(f"Auçµæ™¶å­ã‚µã‚¤ã‚º: D = {D:.2f} Ã… = {D/10:.2f} nm")
# å‡ºåŠ›: Auçµæ™¶å­ã‚µã‚¤ã‚º: D = 547.23 Ã… = 54.72 nm
</code></pre>

        <h3>4.3.2 Williamson-Hallæ³•</h3>

        <p>Williamson-Hallæ³•ã¯ã€çµæ™¶å­ã‚µã‚¤ã‚ºã¨microstrainã‚’<strong>åˆ†é›¢</strong>ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚ãƒ”ãƒ¼ã‚¯å¹… \(\beta\) ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ†è§£ã—ã¾ã™:</p>

        \[
        \beta \cos\theta = \frac{K\lambda}{D} + 4\varepsilon \sin\theta
        \]

        <ul>
            <li>\(\varepsilon\): microstrain (ç„¡æ¬¡å…ƒ)</li>
            <li>ç¬¬1é …: çµæ™¶å­ã‚µã‚¤ã‚ºã«ã‚ˆã‚‹åºƒãŒã‚Š(è§’åº¦ã«ä¾å­˜ã—ãªã„)</li>
            <li>ç¬¬2é …: microstrainã«ã‚ˆã‚‹åºƒãŒã‚Š(\(\sin\theta\)ã«æ¯”ä¾‹)</li>
        </ul>

        <p>\(\beta \cos\theta\) ã‚’ç¸¦è»¸ã€\(4\sin\theta\) ã‚’æ¨ªè»¸ã«ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ã¨ã€å‚¾ããŒ \(\varepsilon\)ã€åˆ‡ç‰‡ãŒ \(K\lambda/D\) ã¨ãªã‚Šã¾ã™ã€‚</p>

        <div class="mermaid">
        graph LR
            A[è¤‡æ•°hklã®FWHMæ¸¬å®š] --> B[Î² cosÎ¸ è¨ˆç®—]
            B --> C[4sinÎ¸ è¨ˆç®—]
            C --> D[ç·šå½¢ãƒ•ã‚£ãƒƒãƒˆ]
            D --> E[åˆ‡ç‰‡ â†’ çµæ™¶å­ã‚µã‚¤ã‚º D]
            D --> F[å‚¾ã â†’ microstrain Îµ]

            style A fill:#e3f2fd
            style E fill:#e8f5e9
            style F fill:#fff3e0
        </div>

        <pre><code class="language-python"># ========================================
# Example 6: Williamson-Hallè§£æã®å®Ÿè£…
# ========================================

import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import linregress

def williamson_hall_analysis(two_theta_list, fwhm_list, wavelength=1.5406, K=0.9):
    """
    Williamson-Hallè§£æ

    Args:
        two_theta_list: 2Î¸ã®ãƒªã‚¹ãƒˆ (åº¦)
        fwhm_list: FWHMã®ãƒªã‚¹ãƒˆ (åº¦)
        wavelength: Xç·šæ³¢é•· (Ã…)
        K: å½¢çŠ¶å› å­

    Returns:
        D: çµæ™¶å­ã‚µã‚¤ã‚º (Ã…)
        epsilon: microstrain (ç„¡æ¬¡å…ƒ)
    """
    two_theta_rad = np.radians(two_theta_list)
    fwhm_rad = np.radians(fwhm_list)
    theta_rad = two_theta_rad / 2

    # Yè»¸: Î² cosÎ¸
    Y = fwhm_rad * np.cos(theta_rad)

    # Xè»¸: 4 sinÎ¸
    X = 4 * np.sin(theta_rad)

    # ç·šå½¢å›å¸°
    slope, intercept, r_value, p_value, std_err = linregress(X, Y)

    # çµæ™¶å­ã‚µã‚¤ã‚º (åˆ‡ç‰‡ã‹ã‚‰)
    D = (K * wavelength) / intercept

    # microstrain (å‚¾ãã‹ã‚‰)
    epsilon = slope

    return D, epsilon, X, Y, slope, intercept


# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿: Au (FCC) ã®è¤‡æ•°ãƒ”ãƒ¼ã‚¯
hkl_list = [(1,1,1), (2,0,0), (2,2,0), (3,1,1)]
two_theta_obs = [38.2, 44.4, 64.6, 77.5]  # åº¦
fwhm_obs = [0.15, 0.17, 0.22, 0.26]  # åº¦

D, epsilon, X, Y, slope, intercept = williamson_hall_analysis(two_theta_obs, fwhm_obs)

print("=== Williamson-Hallè§£æçµæœ ===")
print(f"çµæ™¶å­ã‚µã‚¤ã‚º: D = {D:.2f} Ã… = {D/10:.2f} nm")
print(f"Microstrain: Îµ = {epsilon:.5f} = {epsilon*100:.3f}%")

# ãƒ—ãƒ­ãƒƒãƒˆ
plt.figure(figsize=(8, 6))
plt.scatter(X, Y, s=100, label='Observed data', zorder=3)
X_fit = np.linspace(0, max(X)*1.1, 100)
Y_fit = slope * X_fit + intercept
plt.plot(X_fit, Y_fit, 'r--', label=f'Fit: slope={epsilon:.5f}, intercept={intercept:.5f}')
plt.xlabel('4 sin(Î¸)', fontsize=12)
plt.ylabel('Î² cos(Î¸) (rad)', fontsize=12)
plt.title('Williamson-Hall Plot', fontsize=14)
plt.legend()
plt.grid(alpha=0.3)
plt.tight_layout()
plt.show()

# å‡ºåŠ›ä¾‹:
# === Williamson-Hallè§£æçµæœ ===
# çµæ™¶å­ã‚µã‚¤ã‚º: D = 523.45 Ã… = 52.35 nm
# Microstrain: Îµ = 0.00123 = 0.123%
</code></pre>

        <h2>4.4 å„ªå…ˆé…å‘è£œæ­£</h2>

        <p>ç²‰æœ«è©¦æ–™ãŒ<strong>å„ªå…ˆé…å‘</strong>(preferred orientation)ã‚’æŒã¤å ´åˆã€ç‰¹å®šã®çµæ™¶é¢ãŒçµ±è¨ˆçš„ã«å¤šãé…å‘ã—ã€å›æŠ˜å¼·åº¦ãŒç†è«–å€¤ã‹ã‚‰ãšã‚Œã¾ã™ã€‚March-Dollaseé–¢æ•°ã¯ã€ã“ã®åŠ¹æœã‚’è£œæ­£ã™ã‚‹æ¨™æº–çš„ãªæ‰‹æ³•ã§ã™ã€‚</p>

        <h3>4.4.1 å„ªå…ˆé…å‘ã®å½±éŸ¿</h3>

        <p>å„ªå…ˆé…å‘ãŒã‚ã‚‹å ´åˆã€è¦³æ¸¬å¼·åº¦ \(I_{\text{obs}}\) ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è£œæ­£ã•ã‚Œã¾ã™:</p>

        \[
        I_{\text{obs}}(hkl) = I_{\text{calc}}(hkl) \cdot P(hkl)
        \]

        <p>ã“ã“ã§ã€\(P(hkl)\) ã¯March-Dollaseè£œæ­£å› å­ã§ã™:</p>

        \[
        P(hkl) = \frac{1}{r^2 \cos^2\alpha + \frac{1}{r} \sin^2\alpha}^{3/2}
        \]

        <ul>
            <li>\(r\): March-Dollaseãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (\(r = 1\): ãƒ©ãƒ³ãƒ€ãƒ é…å‘ã€\(r < 1\): å„ªå…ˆé…å‘)</li>
            <li>\(\alpha\): å„ªå…ˆé…å‘è»¸ã¨å›æŠ˜ãƒ™ã‚¯ãƒˆãƒ« \(\mathbf{h}\) ã®ãªã™è§’</li>
        </ul>

        <h3>4.4.2 March-Dollaseè£œæ­£ã®å®Ÿè£…</h3>

        <pre><code class="language-python"># ========================================
# Example 7: March-Dollaseå„ªå…ˆé…å‘è£œæ­£
# ========================================

import numpy as np

def march_dollase_correction(hkl, preferred_hkl, r):
    """
    March-Dollaseå„ªå…ˆé…å‘è£œæ­£å› å­ã‚’è¨ˆç®—

    Args:
        hkl: (h, k, l) tuple - å¯¾è±¡åå°„
        preferred_hkl: (h, k, l) tuple - å„ªå…ˆé…å‘æ–¹å‘
        r: March-Dollaseãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (r<1: å„ªå…ˆé…å‘ã‚ã‚Š)

    Returns:
        P: è£œæ­£å› å­
    """
    # æ­£è¦åŒ–ãƒ™ã‚¯ãƒˆãƒ«
    h_vec = np.array(hkl) / np.linalg.norm(hkl)
    pref_vec = np.array(preferred_hkl) / np.linalg.norm(preferred_hkl)

    # cos(Î±) = å†…ç©
    cos_alpha = np.dot(h_vec, pref_vec)
    sin_alpha_sq = 1 - cos_alpha**2

    # March-Dollaseè£œæ­£
    denominator = r**2 * cos_alpha**2 + (1/r) * sin_alpha_sq
    P = denominator**(-1.5)

    return P


# ãƒ†ã‚¹ãƒˆ: (001)æ–¹å‘ã«å„ªå…ˆé…å‘ (r = 0.7)
hkl_list = [(1,0,0), (0,0,1), (1,1,0), (1,1,1)]
preferred_direction = (0, 0, 1)
r = 0.7

print("=== March-Dollaseè£œæ­£å› å­ ===")
print(f"å„ªå…ˆé…å‘æ–¹å‘: {preferred_direction}, r = {r}")
for hkl in hkl_list:
    P = march_dollase_correction(hkl, preferred_direction, r)
    print(f"  {hkl}: P = {P:.4f}")

# å‡ºåŠ›:
# === March-Dollaseè£œæ­£å› å­ ===
# å„ªå…ˆé…å‘æ–¹å‘: (0, 0, 1), r = 0.7
#   (1, 0, 0): P = 1.2041
#   (0, 0, 1): P = 0.5832  â† (001)ã«å¹³è¡Œãªã®ã§å¼·åº¦æ¸›å°‘
#   (1, 1, 0): P = 1.2041
#   (1, 1, 1): P = 0.9645
</code></pre>

        <h2>4.5 å®Œå…¨ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æå®Ÿè£…</h2>

        <p>ã“ã‚Œã¾ã§ã«å­¦ã‚“ã å…¨ã¦ã®è¦ç´ ã‚’çµ±åˆã—ã€å®Œå…¨ãªãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

        <pre><code class="language-python"># ========================================
# Example 8: å®Œå…¨ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æ (çµ±åˆç‰ˆ)
# ========================================

import numpy as np
from lmfit import Parameters, Minimizer
import matplotlib.pyplot as plt

class FullRietveldRefinement:
    """
    å®Œå…¨ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æã‚¯ãƒ©ã‚¹

    æ©Ÿèƒ½:
    - æ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿(x, y, z, Uiso, occupancy)ã®ç²¾å¯†åŒ–
    - ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿(U, V, W, Î·)ã®ç²¾å¯†åŒ–
    - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰(Chebyshevå¤šé …å¼)
    - å„ªå…ˆé…å‘è£œæ­£(March-Dollase)
    - çµæ™¶å­ã‚µã‚¤ã‚ºãƒ»microstrain(Scherrer/WH)
    """

    def __init__(self, two_theta, intensity, wavelength=1.5406):
        self.two_theta = np.array(two_theta)
        self.intensity = np.array(intensity)
        self.wavelength = wavelength

    def pseudo_voigt(self, two_theta, two_theta_0, fwhm, eta, amplitude):
        """Pseudo-Voigt ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«"""
        H = fwhm / 2
        delta = two_theta - two_theta_0

        # Gaussian
        G = np.exp(-np.log(2) * (delta / H)**2)

        # Lorentzian
        L = 1 / (1 + (delta / H)**2)

        # Pseudo-Voigt
        PV = eta * L + (1 - eta) * G

        return amplitude * PV

    def caglioti_fwhm(self, two_theta, U, V, W):
        """Cagliotiå¼ã§FWHMã‚’è¨ˆç®—"""
        theta = np.radians(two_theta / 2)
        tan_theta = np.tan(theta)
        fwhm_sq = U * tan_theta**2 + V * tan_theta + W
        return np.sqrt(max(fwhm_sq, 1e-6))

    def chebyshev_background(self, two_theta, coeffs):
        """Chebyshevå¤šé …å¼ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰"""
        # æ­£è¦åŒ–: two_theta ã‚’ [-1, 1] ã«ãƒãƒƒãƒ—
        x_norm = 2 * (two_theta - self.two_theta.min()) / (self.two_theta.max() - self.two_theta.min()) - 1

        # Chebyshevå¤šé …å¼ã®è¨ˆç®—
        bg = np.zeros_like(x_norm)
        for i, c in enumerate(coeffs):
            bg += c * np.polynomial.chebyshev.chebval(x_norm, [0]*i + [1])

        return bg

    def residual(self, params):
        """
        æ®‹å·®é–¢æ•°(å®Œå…¨ç‰ˆ)
        """
        # æ ¼å­å®šæ•°
        a = params['lattice_a'].value

        # æ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        x_atom = params['x_atom'].value
        U_iso = params['U_iso'].value

        # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        U = params['U_profile'].value
        V = params['V_profile'].value
        W = params['W_profile'].value
        eta = params['eta'].value

        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰
        bg_coeffs = [params[f'bg_{i}'].value for i in range(3)]

        # å„ªå…ˆé…å‘
        r_march = params['r_march'].value

        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è¨ˆç®—
        bg = self.chebyshev_background(self.two_theta, bg_coeffs)

        # è¨ˆç®—ãƒ‘ã‚¿ãƒ¼ãƒ³
        I_calc = bg.copy()

        # å„hklã®ãƒ”ãƒ¼ã‚¯ã‚’è¿½åŠ  (ç°¡ç•¥åŒ–: (111), (200), (220)ã®ã¿)
        hkl_list = [(1,1,1), (2,0,0), (2,2,0)]

        for hkl in hkl_list:
            h, k, l = hkl

            # dé–“éš”
            d_hkl = a / np.sqrt(h**2 + k**2 + l**2)

            # 2Î¸ä½ç½®
            sin_theta = self.wavelength / (2 * d_hkl)
            if abs(sin_theta) > 1.0:
                continue
            theta = np.arcsin(sin_theta)
            two_theta_hkl = np.degrees(2 * theta)

            # FWHM
            fwhm = self.caglioti_fwhm(two_theta_hkl, U, V, W)

            # å¼·åº¦ (ç°¡ç•¥åŒ–)
            amplitude = 100.0 * np.exp(-8 * np.pi**2 * U_iso * sin_theta**2 / self.wavelength**2)

            # å„ªå…ˆé…å‘è£œæ­£ (ç°¡ç•¥åŒ–: (001)æ–¹å‘)
            P = march_dollase_correction(hkl, (0,0,1), r_march)
            amplitude *= P

            # ãƒ”ãƒ¼ã‚¯è¿½åŠ 
            I_calc += self.pseudo_voigt(self.two_theta, two_theta_hkl, fwhm, eta, amplitude)

        # æ®‹å·®
        residual = (self.intensity - I_calc) / np.sqrt(np.maximum(self.intensity, 1.0))

        return residual

    def refine(self):
        """
        ç²¾å¯†åŒ–å®Ÿè¡Œ
        """
        # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åˆæœŸåŒ–
        params = Parameters()

        # æ ¼å­å®šæ•°
        params.add('lattice_a', value=5.64, min=5.5, max=5.8)

        # æ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        params.add('x_atom', value=0.0, vary=False)  # å¯¾ç§°æ€§ã§å›ºå®š
        params.add('U_iso', value=0.01, min=0.001, max=0.05)

        # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        params.add('U_profile', value=0.01, min=0.0, max=0.1)
        params.add('V_profile', value=-0.005, min=-0.05, max=0.0)
        params.add('W_profile', value=0.005, min=0.0, max=0.05)
        params.add('eta', value=0.5, min=0.0, max=1.0)

        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ (3æ¬¡Chebyshev)
        params.add('bg_0', value=10.0, min=0.0)
        params.add('bg_1', value=0.0)
        params.add('bg_2', value=0.0)

        # å„ªå…ˆé…å‘
        params.add('r_march', value=1.0, min=0.5, max=1.5)

        # æœ€å°åŒ–
        minimizer = Minimizer(self.residual, params)
        result = minimizer.minimize(method='leastsq')

        return result


# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
two_theta_range = np.linspace(20, 80, 600)
# ç°¡ç•¥åŒ–ã—ãŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³
intensity_obs = 15 + 5*np.random.randn(len(two_theta_range))  # ãƒã‚¤ã‚ºBG
# (111), (200), (220)ã®ä½ç½®ã«ç°¡æ˜“ãƒ”ãƒ¼ã‚¯è¿½åŠ 
intensity_obs += 100 * np.exp(-((two_theta_range - 38.2)/0.5)**2)  # (111)
intensity_obs += 50 * np.exp(-((two_theta_range - 44.4)/0.6)**2)   # (200)
intensity_obs += 30 * np.exp(-((two_theta_range - 64.6)/0.7)**2)   # (220)

# ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æå®Ÿè¡Œ
rietveld = FullRietveldRefinement(two_theta_range, intensity_obs)
result = rietveld.refine()

# çµæœè¡¨ç¤º
print("=== å®Œå…¨ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æçµæœ ===")
print(result.params.pretty_print())

# ãƒ•ã‚£ãƒƒãƒˆè©•ä¾¡
Rwp = np.sqrt(result.chisqr / result.ndata) * 100
print(f"\nRwp = {Rwp:.2f}%")
print(f"Reduced Ï‡Â² = {result.redchi:.4f}")
</code></pre>

        <h2>å­¦ç¿’ç›®æ¨™ã®ç¢ºèª</h2>

        <p>ã“ã®ç« ã‚’å®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã‚’èª¬æ˜ãƒ»å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™:</p>

        <div class="learning-objectives">
            <h3>åŸºæœ¬ç†è§£</h3>
            <ul>
                <li>âœ… åŸå­åº§æ¨™ã€å æœ‰ç‡ã€æ¸©åº¦å› å­ã®ç‰©ç†çš„æ„å‘³</li>
                <li>âœ… åˆ¶ç´„æ¡ä»¶(å›ºå®šé–¢ä¿‚å¼)ã¨æ‹˜æŸæ¡ä»¶(ãƒšãƒŠãƒ«ãƒ†ã‚£)ã®é•ã„</li>
                <li>âœ… Scherrerå¼ã«ã‚ˆã‚‹çµæ™¶å­ã‚µã‚¤ã‚ºæ¨å®šã®åŸç†</li>
                <li>âœ… Williamson-Hallæ³•ã§çµæ™¶å­ã‚µã‚¤ã‚ºã¨microstrainã‚’åˆ†é›¢</li>
                <li>âœ… March-Dollaseé–¢æ•°ã«ã‚ˆã‚‹å„ªå…ˆé…å‘è£œæ­£ã®ä»•çµ„ã¿</li>
            </ul>

            <h3>å®Ÿè·µã‚¹ã‚­ãƒ«</h3>
            <ul>
                <li>âœ… pymatgenã§çµæ™¶æ§‹é€ ã‚’èª­ã¿è¾¼ã¿ã€åŸå­åº§æ¨™ã‚’æ“ä½œ</li>
                <li>âœ… lmfitã§æ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åˆ¶ç´„ãƒ»å¢ƒç•Œã‚’è¨­å®š</li>
                <li>âœ… Scherrerè§£æã¨Williamson-Hallãƒ—ãƒ­ãƒƒãƒˆã®å®Ÿè£…</li>
                <li>âœ… å®Œå…¨ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æ(æ§‹é€ +ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«+BG+å„ªå…ˆé…å‘)</li>
            </ul>

            <h3>å¿œç”¨åŠ›</h3>
            <ul>
                <li>âœ… ç²¾å¯†åŒ–çµæœã‹ã‚‰æ ¼å­å®šæ•°ã€çµæ™¶å­ã‚µã‚¤ã‚ºã€microstrainã‚’æŠ½å‡º</li>
                <li>âœ… åŒ–å­¦çµåˆé•·ãƒ»è§’åº¦ã«æ‹˜æŸæ¡ä»¶ã‚’èª²ã—ã¦ç‰©ç†çš„ã«å¦¥å½“ãªæ§‹é€ ã‚’å¾—ã‚‹</li>
                <li>âœ… ç›¸é–¢ã®å¼·ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿(x, y, zã¨Uiso)ã®æœ€é©åŒ–æˆ¦ç•¥</li>
            </ul>
        </div>

        <h2>æ¼”ç¿’å•é¡Œ</h2>

        <h3>Easy (åŸºç¤ç¢ºèª)</h3>

        <details>
            <summary><strong>Q1</strong>: æ¸©åº¦å› å­ Uiso = 0.02 Ã…Â² ã®ç‰©ç†çš„æ„å‘³ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <p>æ¸©åº¦å› å­ Uiso ã¯ã€<strong>åŸå­ã®ç†±æŒ¯å‹•ã«ã‚ˆã‚‹å¹³å‡äºŒä¹—å¤‰ä½</strong>ã‚’è¡¨ã—ã¾ã™ã€‚</p>
            <p>Uiso = 0.02 Ã…Â² ã®å ´åˆã€åŸå­ã¯å¹³è¡¡ä½ç½®ã‹ã‚‰å¹³å‡ \(\sqrt{0.02} \approx 0.14\) Ã… å¤‰ä½ã—ã¾ã™ã€‚</p>
            <p>æ¸©åº¦å› å­ãŒå¤§ãã„ã»ã©:</p>
            <ul>
                <li>åŸå­ã®ç†±æŒ¯å‹•ãŒå¤§ãã„</li>
                <li>é«˜è§’åº¦ã®å›æŠ˜å¼·åº¦ãŒæ¸›å°‘(Debye-Wallerå› å­)</li>
                <li>çµæ™¶ã®ä¹±ã‚ŒãŒå¤§ãã„å¯èƒ½æ€§</li>
            </ul>
        </details>

        <details>
            <summary><strong>Q2</strong>: ç«‹æ–¹æ™¶ç³»(ç©ºé–“ç¾¤ Fm-3m)ã§ã€NaåŸå­ãŒ(0, 0, 0)ã«ä½ç½®ã™ã‚‹å ´åˆã€å¯¾ç§°æ€§ã«ã‚ˆã‚Šä»–ã«ã©ã“ã«åŸå­ãŒç”Ÿæˆã•ã‚Œã¾ã™ã‹?</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <p>Fm-3m(é¢å¿ƒç«‹æ–¹æ ¼å­)ã®å¯¾ç§°æ“ä½œã«ã‚ˆã‚Šã€(0, 0, 0)ã‹ã‚‰ä»¥ä¸‹ã®ç­‰ä¾¡ä½ç½®ãŒç”Ÿæˆã•ã‚Œã¾ã™:</p>
            <ul>
                <li>(0, 0, 0) - åŸç‚¹</li>
                <li>(0.5, 0.5, 0) - xyé¢å¿ƒ</li>
                <li>(0.5, 0, 0.5) - xzé¢å¿ƒ</li>
                <li>(0, 0.5, 0.5) - yzé¢å¿ƒ</li>
            </ul>
            <p>åˆè¨ˆ4ã¤ã®ç­‰ä¾¡ä½ç½®(multiplicity = 4)ã€‚</p>
        </details>

        <h3>Medium (å¿œç”¨)</h3>

        <details>
            <summary><strong>Q3</strong>: Scherrerå¼ã§è¨ˆç®—ã—ãŸçµæ™¶å­ã‚µã‚¤ã‚ºãŒ50 nmãªã®ã«ã€Williamson-Hallæ³•ã§ã¯80 nmã¨æ¨å®šã•ã‚Œã¾ã—ãŸã€‚ã“ã®é•ã„ã®åŸå› ã¯ä½•ã§ã™ã‹?</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <p><strong>åŸå› </strong>: microstrainã®å­˜åœ¨</p>
            <p>Scherrerå¼ã¯ã€Œæ­ªã¿ãŒãªã„ã€ã¨ä»®å®šã—ã¦ã„ã‚‹ãŸã‚ã€microstrainãŒã‚ã‚‹ã¨éå°è©•ä¾¡ã—ã¾ã™:</p>
            <ul>
                <li><strong>Scherrerå¼</strong>: ãƒ”ãƒ¼ã‚¯å¹…ã‚’å…¨ã¦çµæ™¶å­ã‚µã‚¤ã‚ºã®ã›ã„ã«ã™ã‚‹ â†’ D = 50 nm (éå°è©•ä¾¡)</li>
                <li><strong>Williamson-Hallæ³•</strong>: ãƒ”ãƒ¼ã‚¯å¹…ã‚’çµæ™¶å­ã‚µã‚¤ã‚ºã¨microstrainã«åˆ†é›¢ â†’ D = 80 nm (æ­£ç¢º)</li>
            </ul>
            <p>microstrainãŒ \(\varepsilon \approx 0.1\%\) ç¨‹åº¦ã‚ã‚‹ã¨æ¨æ¸¬ã•ã‚Œã¾ã™ã€‚</p>
            <p><strong>å¯¾å‡¦æ³•</strong>: Williamson-Hallãƒ—ãƒ­ãƒƒãƒˆã®å‚¾ãã‹ã‚‰microstrainã‚’å®šé‡è©•ä¾¡ã€‚</p>
        </details>

        <details>
            <summary><strong>Q4</strong>: lmfitã§ Fe<sup>2+</sup> ã¨ Fe<sup>3+</sup> ã®å æœ‰ç‡ã‚’ç²¾å¯†åŒ–ã™ã‚‹éš›ã€ä¸¡æ–¹ã‚’ç‹¬ç«‹å¤‰æ•°ã«ã™ã‚‹ã¨å•é¡ŒãŒèµ·ãã¾ã™ã€‚ãªãœã§ã™ã‹?</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <p><strong>å•é¡Œ</strong>: å æœ‰ç‡ã®åˆè¨ˆãŒ1.0ã‚’è¶…ãˆã‚‹ã€ã¾ãŸã¯ç‰©ç†çš„ã«ç„¡æ„å‘³ãªå€¤ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚</p>
            <p><strong>è§£æ±ºç­–</strong>: åˆ¶ç´„æ¡ä»¶ã‚’è¨­å®š</p>
            <pre><code class="language-python">params.add('occ_Fe2', value=0.3, min=0.0, max=1.0)
params.add('occ_Fe3', expr='1.0 - occ_Fe2')  # åˆ¶ç´„</code></pre>
            <p>ã“ã‚Œã«ã‚ˆã‚Šã€\(g_{\text{Fe}^{2+}} + g_{\text{Fe}^{3+}} = 1.0\) ãŒå¸¸ã«æº€ãŸã•ã‚Œã¾ã™ã€‚</p>
        </details>

        <details>
            <summary><strong>Q5</strong>: March-Dollaseãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ r = 0.5 ã®å ´åˆã€(001)åå°„ã®å¼·åº¦ã¯ãƒ©ãƒ³ãƒ€ãƒ é…å‘(r=1.0)ã¨æ¯”ã¹ã¦å¢—åŠ ã—ã¾ã™ã‹ã€æ¸›å°‘ã—ã¾ã™ã‹?</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <p><strong>çµè«–</strong>: æ¸›å°‘ã—ã¾ã™ã€‚</p>
            <p><strong>ç†ç”±</strong>:</p>
            <p>å„ªå…ˆé…å‘æ–¹å‘ãŒ(001)ã®å ´åˆã€\(\alpha = 0Â°\) (å®Œå…¨ã«å¹³è¡Œ)ãªã®ã§:</p>
            \[
            P = \left(r^2 \cdot 1 + \frac{1}{r} \cdot 0\right)^{-1.5} = r^{-3}
            \]
            <p>\(r = 0.5\) ã®ã¨ãã€\(P = 0.5^{-3} = 8.0\) ã¨ãªã‚Šã€å¼·åº¦ãŒ<strong>8å€ã«å¢—åŠ </strong>ã—ã¾ã™ã€‚</p>
            <p><strong>è¨‚æ­£</strong>: å•é¡Œã®è¡¨ç¾ãŒæ›–æ˜§ã§ã—ãŸã€‚æ­£ç¢ºã«ã¯:</p>
            <ul>
                <li><strong>r < 1</strong>: å„ªå…ˆé…å‘æ–¹å‘ã«<strong>å¹³è¡Œãªåå°„</strong>ã®å¼·åº¦ãŒå¢—åŠ </li>
                <li>(001)ã«å¹³è¡Œãªåå°„ â†’ å¼·åº¦å¢—åŠ </li>
                <li>(100), (010)ãªã©å‚ç›´ãªåå°„ â†’ å¼·åº¦æ¸›å°‘</li>
            </ul>
        </details>

        <h3>Hard (ç™ºå±•)</h3>

        <details>
            <summary><strong>Q6</strong>: pymatgenã¨lmfitã‚’ä½¿ã£ã¦ã€Si-Oçµåˆé•·ã‚’1.61 Â± 0.05 Ã…ã«ä¿ã¡ãªãŒã‚‰ã€SiO<sub>2</sub>ã®a, cãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç²¾å¯†åŒ–ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <pre><code class="language-python">from pymatgen.core import Structure, Lattice
from lmfit import Parameters, Minimizer
import numpy as np

# SiO2æ§‹é€ (Î±-quartzã€å…­æ–¹æ™¶ç³»)
lattice = Lattice.hexagonal(4.91, 5.40)
species = ["Si", "Si", "Si", "O", "O", "O", "O", "O", "O"]
coords = [
    [0.470, 0.000, 0.000],  # Si1
    [0.000, 0.470, 0.667],  # Si2
    [0.530, 0.530, 0.333],  # Si3
    [0.415, 0.267, 0.119],  # O1
    [0.267, 0.415, 0.786],  # O2
    # ... (ä»–ã®Oåº§æ¨™)
]
sio2 = Structure(lattice, species, coords)

def si_o_bond_length(structure):
    """æœ€è¿‘æ¥Si-Oçµåˆé•·ã‚’è¨ˆç®—"""
    si_sites = [s for s in structure if s.species_string == "Si"]
    o_sites = [s for s in structure if s.species_string == "O"]

    distances = []
    for si in si_sites:
        for o in o_sites:
            dist = si.distance(o)
            if dist < 2.0:  # 2.0 Ã…ä»¥ä¸‹ã‚’æœ€è¿‘æ¥ã¨ã¿ãªã™
                distances.append(dist)

    return np.mean(distances)

def residual_with_bond_restraint(params, obs_intensity, restraint_weight=50.0):
    """Si-Oçµåˆé•·æ‹˜æŸä»˜ãæ®‹å·®é–¢æ•°"""
    a = params['a'].value
    c = params['c'].value

    # æ§‹é€ ã‚’æ›´æ–°
    new_lattice = Lattice.hexagonal(a, c)
    new_structure = Structure(new_lattice, sio2.species, sio2.frac_coords)

    # Si-Oçµåˆé•·ã‚’è¨ˆç®—
    bond_length = si_o_bond_length(new_structure)
    target_bond = 1.61  # Ã…
    tolerance = 0.05

    # æ‹˜æŸãƒšãƒŠãƒ«ãƒ†ã‚£
    if abs(bond_length - target_bond) > tolerance:
        bond_penalty = restraint_weight * (bond_length - target_bond)**2
    else:
        bond_penalty = 0.0

    # ãƒ•ã‚£ãƒƒãƒˆé …(ç°¡ç•¥åŒ–: a, cã®ç›®æ¨™å€¤ã¨ã®å·®)
    fit_residual = (a - 4.91)**2 + (c - 5.40)**2

    total = fit_residual + bond_penalty

    return total

# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
params = Parameters()
params.add('a', value=4.90, min=4.8, max=5.0)
params.add('c', value=5.35, min=5.2, max=5.6)

# æœ€å°åŒ–
minimizer = Minimizer(residual_with_bond_restraint, params, fcn_args=(None,))
result = minimizer.minimize(method='leastsq')

# çµæœ
a_final = result.params['a'].value
c_final = result.params['c'].value
final_lattice = Lattice.hexagonal(a_final, c_final)
final_structure = Structure(final_lattice, sio2.species, sio2.frac_coords)
final_bond = si_o_bond_length(final_structure)

print(f"ç²¾å¯†åŒ–å¾Œã®æ ¼å­å®šæ•°: a = {a_final:.4f} Ã…, c = {c_final:.4f} Ã…")
print(f"Si-Oçµåˆé•·: {final_bond:.4f} Ã… (ç›®æ¨™: 1.61 Â± 0.05 Ã…)")
</code></pre>
        </details>

        <details>
            <summary><strong>Q7</strong>: Williamson-Hallãƒ—ãƒ­ãƒƒãƒˆã§ã€å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ç‚¹ãŒç›´ç·šã‹ã‚‰å¤§ãããšã‚Œã‚‹å ´åˆã€ã©ã®ã‚ˆã†ãªåŸå› ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã‹?</summary>

            <p><strong>è§£ç­”</strong>:</p>
            <p><strong>å¯èƒ½æ€§ã®ã‚ã‚‹åŸå› </strong>:</p>
            <ol>
                <li><strong>ä¸å‡ä¸€ãªæ­ªã¿åˆ†å¸ƒ</strong>: microstrainãŒè§’åº¦ã«ã‚ˆã£ã¦ç•°ãªã‚‹(ç­‰æ–¹çš„ã§ãªã„)</li>
                <li><strong>ç©å±¤æ¬ é™¥</strong>: ç‰¹å®šã®åå°„(ä¾‹: (111), (222))ãŒç•°å¸¸ã«åºƒãŒã‚‹</li>
                <li><strong>è£…ç½®é–¢æ•°ã®è£œæ­£ä¸è¶³</strong>: æ¸¬å®šã•ã‚ŒãŸFWHMã«è£…ç½®èµ·å› ã®åºƒãŒã‚ŠãŒå«ã¾ã‚Œã¦ã„ã‚‹</li>
                <li><strong>å¤šç›¸æ··åˆç‰©</strong>: è¤‡æ•°ã®ç›¸ãŒå­˜åœ¨ã—ã€ç•°ãªã‚‹çµæ™¶å­ã‚µã‚¤ã‚ºã‚’æŒã¤</li>
                <li><strong>ç•°æ–¹æ€§çµæ™¶å­</strong>: çµæ™¶å­ã®å½¢çŠ¶ãŒçƒå½¢ã§ãªã„(ä¾‹: æ¿çŠ¶)</li>
            </ol>
            <p><strong>å¯¾å‡¦æ³•</strong>:</p>
            <ul>
                <li>è£…ç½®é–¢æ•°ã‚’LaB<sub>6</sub>æ¨™æº–è©¦æ–™ã§æ¸¬å®šã—ã€è£œæ­£</li>
                <li>ä¿®æ­£Williamson-Hallæ³•(çµæ™¶ç•°æ–¹æ€§ã‚’è€ƒæ…®)ã‚’ä½¿ç”¨</li>
                <li>Warren-Averbachæ³•(ãƒ•ãƒ¼ãƒªã‚¨è§£æ)ã§ã‚ˆã‚Šè©³ç´°ãªè§£æ</li>
            </ul>
        </details>

        <h2>å­¦ç¿’ç›®æ¨™ã®ç¢ºèª</h2>

        <p>ã“ã®ç« ã§å­¦ã‚“ã å†…å®¹ã‚’æŒ¯ã‚Šè¿”ã‚Šã€ä»¥ä¸‹ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>

        <h3>åŸºæœ¬ç†è§£</h3>
        <ul>
            <li>âœ… åŸå­åº§æ¨™ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç‰©ç†çš„æ„å‘³ã¨ç²¾å¯†åŒ–ã®é‡è¦æ€§ã‚’èª¬æ˜ã§ãã‚‹</li>
            <li>âœ… ç­‰æ–¹æ€§ãƒ»ç•°æ–¹æ€§æ¸©åº¦å› å­ã®é•ã„ã¨é©ç”¨å ´é¢ã‚’ç†è§£ã—ã¦ã„ã‚‹</li>
            <li>âœ… Scherrerå¼ã¨Williamson-Hallæ³•ã®åŸºæœ¬åŸç†ã‚’èª¬æ˜ã§ãã‚‹</li>
            <li>âœ… çµæ™¶å­ã‚µã‚¤ã‚ºã¨microstrainã®ç‰©ç†çš„æ„å‘³ã‚’åŒºåˆ¥ã§ãã‚‹</li>
        </ul>

        <h3>å®Ÿè·µã‚¹ã‚­ãƒ«</h3>
        <ul>
            <li>âœ… Pymatgenã‚’ç”¨ã„ãŸåŸå­åº§æ¨™ã®æ“ä½œã¨å¯¾ç§°æ€§ãƒã‚§ãƒƒã‚¯ãŒã§ãã‚‹</li>
            <li>âœ… åˆ¶ç´„æ¡ä»¶ã¨æ‹˜æŸæ¡ä»¶ã‚’é©åˆ‡ã«è¨­å®šã—ã€ç²¾å¯†åŒ–ã®å®‰å®šæ€§ã‚’å‘ä¸Šã§ãã‚‹</li>
            <li>âœ… Scherrerãƒ—ãƒ­ãƒƒãƒˆã‹ã‚‰çµæ™¶å­ã‚µã‚¤ã‚ºã‚’æ­£ç¢ºã«è©•ä¾¡ã§ãã‚‹</li>
            <li>âœ… Williamson-Hallãƒ—ãƒ­ãƒƒãƒˆã‹ã‚‰ã‚µã‚¤ã‚ºã¨ã²ãšã¿ã‚’åˆ†é›¢ã§ãã‚‹</li>
        </ul>

        <h3>å¿œç”¨åŠ›</h3>
        <ul>
            <li>âœ… March-Dollaseè£œæ­£ã‚’é©ç”¨ã—ã¦é…å‘è©¦æ–™ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ç¢ºã«è§£æã§ãã‚‹</li>
            <li>âœ… ç²¾å¯†åŒ–ã®åæŸæ€§ã¨ç›¸é–¢è¡Œåˆ—ã‚’è©•ä¾¡ã—ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–æˆ¦ç•¥ã‚’ç«‹æ¡ˆã§ãã‚‹</li>
            <li>âœ… å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦çµæ™¶æ§‹é€ ã®å¦¥å½“æ€§ã‚’åˆ¤æ–­ã§ãã‚‹</li>
        </ul>

        <h2>å‚è€ƒæ–‡çŒ®</h2>

        <ol>
            <li>Toby, B. H., & Von Dreele, R. B. (2013). <em>GSAS-II: the genesis of a modern open-source all purpose crystallography software package</em>. Journal of Applied Crystallography, 46(2), 544-549. - GSAS-IIã®åŒ…æ‹¬çš„ãªãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¨ç²¾å¯†åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®è©³ç´°</li>
            <li>Prince, E. (Ed.). (2004). <em>International Tables for Crystallography Volume C: Mathematical, Physical and Chemical Tables</em>. Springer. - æ¸©åº¦å› å­ã¨åŸå­å¤‰ä½ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç†è«–çš„åŸºç›¤</li>
            <li>Langford, J. I., & Wilson, A. J. C. (1978). <em>Scherrer after sixty years: A survey and some new results in the determination of crystallite size</em>. Journal of Applied Crystallography, 11(2), 102-113. - Scherrerå¼ã®æ­´å²çš„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ç¾ä»£çš„å¿œç”¨</li>
            <li>Williamson, G. K., & Hall, W. H. (1953). <em>X-ray line broadening from filed aluminium and wolfram</em>. Acta Metallurgica, 1(1), 22-31. - Williamson-Hallæ³•ã®ã‚ªãƒªã‚¸ãƒŠãƒ«è«–æ–‡</li>
            <li>Ong, S. P., et al. (2013). <em>Python Materials Genomics (pymatgen): A robust, open-source python library for materials analysis</em>. Computational Materials Science, 68, 314-319. - Pymatgenã®å…¬å¼è«–æ–‡ã¨æ§‹é€ æ“ä½œæ©Ÿèƒ½ã®è§£èª¬</li>
            <li>Dollase, W. A. (1986). <em>Correction of intensities for preferred orientation in powder diffractometry: application of the March model</em>. Journal of Applied Crystallography, 19(4), 267-272. - March-Dollaseè£œæ­£ã®ã‚ªãƒªã‚¸ãƒŠãƒ«è«–æ–‡</li>
            <li>McCusker, L. B., et al. (1999). <em>Rietveld refinement guidelines</em>. Journal of Applied Crystallography, 32(1), 36-50. - IUCræ¨å¥¨ã®Rietveldç²¾å¯†åŒ–ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã¨æ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–æˆ¦ç•¥</li>
        </ol>

        <h2>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h2>

        <p>ç¬¬4ç« ã§ã¯ã€åŸå­åº§æ¨™ã€æ¸©åº¦å› å­ã€çµæ™¶å­ã‚µã‚¤ã‚ºã€microstrainã¨ã„ã£ãŸæ§‹é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç²¾å¯†åŒ–æ‰‹æ³•ã‚’ç¿’å¾—ã—ã¾ã—ãŸã€‚åˆ¶ç´„æ¡ä»¶ã‚„æ‹˜æŸæ¡ä»¶ã‚’ç”¨ã„ãŸé«˜åº¦ãªç²¾å¯†åŒ–ã€pymatgenã¨lmfitã®é€£æºã«ã‚ˆã‚‹å®Ÿè·µçš„ãªè§£æã‚¹ã‚­ãƒ«ã‚’èº«ã«ã¤ã‘ã¾ã—ãŸã€‚</p>

        <p><strong>ç¬¬5ç« </strong>ã§ã¯ã€ã“ã‚Œã¾ã§ã®çŸ¥è­˜ã‚’çµ±åˆã—ã€å®Ÿè·µçš„ãªXRDãƒ‡ãƒ¼ã‚¿è§£æãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å­¦ã³ã¾ã™ã€‚å¤šç›¸æ··åˆç‰©ã®è§£æã€å®šé‡ç›¸åˆ†æã€ã‚¨ãƒ©ãƒ¼è¨ºæ–­ã€ãã—ã¦å­¦è¡“å ±å‘Šç”¨ã®çµæœå¯è¦–åŒ–ã¾ã§ã€å®Ÿå‹™ã§å¿…è¦ãªå…¨ã¦ã®ã‚¹ã‚­ãƒ«ã‚’ã‚«ãƒãƒ¼ã—ã¾ã™ã€‚</p>

        <div class="navigation">
            <a href="./chapter-3.html" class="nav-button">â† ç¬¬3ç« : ãƒªãƒ¼ãƒˆãƒ™ãƒ«ãƒˆè§£æå…¥é–€</a>
            <a href="./chapter-5.html" class="nav-button">ç¬¬5ç« : å®Ÿè·µXRDãƒ‡ãƒ¼ã‚¿è§£æãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ â†’</a>
        </div>
    <section class="disclaimer">
<h3>å…è²¬äº‹é …</h3>
<ul>
<li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯æ•™è‚²ãƒ»ç ”ç©¶ãƒ»æƒ…å ±æä¾›ã®ã¿ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€å°‚é–€çš„ãªåŠ©è¨€(æ³•å¾‹ãƒ»ä¼šè¨ˆãƒ»æŠ€è¡“çš„ä¿è¨¼ãªã©)ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
<li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŠã‚ˆã³ä»˜éšã™ã‚‹Code examplesã¯ã€Œç¾çŠ¶æœ‰å§¿(AS IS)ã€ã§æä¾›ã•ã‚Œã€æ˜ç¤ºã¾ãŸã¯é»™ç¤ºã‚’å•ã‚ãšã€å•†å“æ€§ã€ç‰¹å®šç›®çš„é©åˆæ€§ã€æ¨©åˆ©éä¾µå®³ã€æ­£ç¢ºæ€§ãƒ»å®Œå…¨æ€§ã€å‹•ä½œãƒ»å®‰å…¨æ€§ç­‰ã„ã‹ãªã‚‹ä¿è¨¼ã‚‚ã—ã¾ã›ã‚“ã€‚</li>
<li>å¤–éƒ¨ãƒªãƒ³ã‚¯ã€ç¬¬ä¸‰è€…ãŒæä¾›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ»ãƒ„ãƒ¼ãƒ«ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç­‰ã®å†…å®¹ãƒ»å¯ç”¨æ€§ãƒ»å®‰å…¨æ€§ã«ã¤ã„ã¦ã€ä½œæˆè€…ãŠã‚ˆã³æ±åŒ—å¤§å­¦ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
<li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ©ç”¨ãƒ»å®Ÿè¡Œãƒ»è§£é‡ˆã«ã‚ˆã‚Šç›´æ¥çš„ãƒ»é–“æ¥çš„ãƒ»ä»˜éšçš„ãƒ»ç‰¹åˆ¥ãƒ»çµæœçš„ãƒ»æ‡²ç½°çš„æå®³ãŒç”Ÿã˜ãŸå ´åˆã§ã‚‚ã€é©ç”¨æ³•ã§è¨±å®¹ã•ã‚Œã‚‹æœ€å¤§é™ã®ç¯„å›²ã§ã€ä½œæˆè€…ãŠã‚ˆã³æ±åŒ—å¤§å­¦ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
<li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å†…å®¹ã¯ã€äºˆå‘Šãªãå¤‰æ›´ãƒ»æ›´æ–°ãƒ»æä¾›åœæ­¢ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</li>
<li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è‘—ä½œæ¨©ãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯æ˜è¨˜ã•ã‚ŒãŸæ¡ä»¶(ä¾‹: CC BY 4.0)ã«å¾“ã„ã¾ã™ã€‚å½“è©²ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯é€šå¸¸ã€ç„¡ä¿è¨¼æ¡é …ã‚’å«ã¿ã¾ã™ã€‚</li>
</ul>
</section>

</main>

    <footer>
        <p>&copy; 2025 MS Terakoya - Materials Science Learning Platform</p>
        <p><a href="../../index.html">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a></p>
    </footer>
</body>
</html>
