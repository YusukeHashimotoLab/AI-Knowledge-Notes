<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬6ç« ï¼šå®Ÿè·µï¼šç‰©æ€§è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | MS Terakoya - ææ–™ç‰©æ€§è«–å…¥é–€</title>
    <style>
        :root {
            --color-primary: #2c3e50;
            --color-primary-dark: #1a252f;
            --color-accent: #f093fb;
            --color-accent-light: #f5576c;
            --color-text: #2d3748;
            --color-text-light: #4a5568;
            --color-bg: #ffffff;
            --color-bg-alt: #f7fafc;
            --color-border: #e2e8f0;
            --color-code-bg: #f8f9fa;
            --color-link: #f093fb;
            --color-link-hover: #d07be8;
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-body);
            line-height: 1.7;
            color: var(--color-text);
            background-color: var(--color-bg);
            font-size: 16px;
        }
        header {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
        }
        .header-content { max-width: 900px; margin: 0 auto; }
        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            line-height: 1.2;
        }
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: var(--spacing-md);
        }
        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .meta-item { display: flex; align-items: center; gap: 0.3rem; }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 var(--spacing-md) var(--spacing-xl);
        }
        h2 {
            font-size: 1.75rem;
            color: var(--color-primary);
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-xs);
            border-bottom: 3px solid var(--color-accent);
        }
        h3 {
            font-size: 1.4rem;
            color: var(--color-primary);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
        }
        h4 {
            font-size: 1.1rem;
            color: var(--color-primary-dark);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }
        p { margin-bottom: var(--spacing-md); color: var(--color-text); }
        a {
            color: var(--color-link);
            text-decoration: none;
            transition: color 0.2s;
        }
        @media (hover: hover) and (pointer: fine) {
            a:hover { color: var(--color-link-hover); text-decoration: underline; }
        }
        ul, ol { margin-left: var(--spacing-lg); margin-bottom: var(--spacing-md); }
        li { margin-bottom: var(--spacing-xs); color: var(--color-text); }
        strong { color: var(--color-primary-dark); font-weight: 600; }
        .info-box {
            background: var(--color-bg-alt);
            border-left: 4px solid var(--color-accent);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            border-radius: var(--border-radius);
        }
        .warning-box {
            background: #fff5f5;
            border-left: 4px solid #fc8181;
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            border-radius: var(--border-radius);
        }
        .success-box {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            border-radius: var(--border-radius);
        }
        .code-block {
            background: var(--color-code-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            overflow-x: auto;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .code-block code {
            font-family: var(--font-mono);
            color: var(--color-text);
        }
        .objectives {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin: var(--spacing-lg) 0;
        }
        .objectives h3 { color: white; margin-top: 0; }
        .objectives ul { margin-left: var(--spacing-md); }
        .objectives li { margin-bottom: var(--spacing-xs); }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--spacing-md) 0;
            font-size: 0.95rem;
        }
        th {
            background: var(--color-bg-alt);
            color: var(--color-primary);
            padding: var(--spacing-sm);
            text-align: left;
            border: 1px solid var(--color-border);
            font-weight: 600;
        }
        td {
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }
        @media (hover: hover) and (pointer: fine) {
            tr:hover { background: var(--color-bg-alt); }
        }
        .exercise {
            background: #fffaf0;
            border: 1px solid #feb2b2;
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
        }
        .exercise h4 {
            color: #c53030;
            margin-top: 0;
        }
        details {
            background: var(--color-bg-alt);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            margin: var(--spacing-sm) 0;
        }
        summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--color-primary);
            padding: var(--spacing-xs);
        }
        @media (hover: hover) and (pointer: fine) {
            summary:hover { color: var(--color-link); }
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--color-border);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        .nav-button {
            display: inline-block;
            padding: var(--spacing-sm) var(--spacing-md);
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            text-decoration: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        @media (hover: hover) and (pointer: fine) {
            .nav-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
                color: white;
                text-decoration: none;
            }
        }
        .workflow-diagram {
            background: var(--color-bg-alt);
            border: 2px solid var(--color-accent);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            overflow-x: auto;
        }
        .case-study {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            border-radius: var(--border-radius);
        }
        .case-study h4 {
            color: #1e40af;
            margin-top: 0;
        }
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.4rem; }
            h3 { font-size: 1.2rem; }
            .meta { font-size: 0.85rem; }
            .code-block { font-size: 0.85rem; padding: var(--spacing-sm); }
            table { font-size: 0.85rem; }
            th, td { padding: var(--spacing-xs); }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ç¬¬6ç« ï¼šå®Ÿè·µï¼šç‰©æ€§è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</h1>
            <p class="subtitle">å®Ÿææ–™ã§ã®è¨ˆç®—å®Ÿè¡Œã‹ã‚‰ç‰©æ€§è©•ä¾¡ã¾ã§ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰</p>
            <div class="meta">
                <span class="meta-item">ğŸ“š ã‚·ãƒªãƒ¼ã‚º: ææ–™ç‰©æ€§è«–å…¥é–€</span>
                <span class="meta-item">ğŸ“ é›£æ˜“åº¦: ä¸­ç´š</span>
                <span class="meta-item">â±ï¸ èª­äº†æ™‚é–“: 30-35åˆ†</span>
                <span class="meta-item">ğŸ”§ å®Ÿè·µ: 10ã‚³ãƒ¼ãƒ‰ä¾‹</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="objectives">
            <h3>ğŸ“‹ å­¦ç¿’ç›®æ¨™</h3>
            <p>æœ¬ç« ã‚’å®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š</p>

            <h4>ğŸ¯ åŸºæœ¬ç†è§£ãƒ¬ãƒ™ãƒ«</h4>
            <ul>
                <li>ç‰©æ€§è¨ˆç®—ã®æ¨™æº–çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆæ§‹é€ ä½œæˆâ†’è¨ˆç®—â†’è§£æï¼‰ã‚’èª¬æ˜ã§ãã‚‹</li>
                <li>4ç¨®é¡ã®ä»£è¡¨çš„ææ–™ï¼ˆSi, GaN, Fe, BaTiOâ‚ƒï¼‰ã®ç‰©æ€§è¨ˆç®—æ‰‹æ³•ã‚’ç†è§£ã—ã¦ã„ã‚‹</li>
                <li>åæŸãƒ†ã‚¹ãƒˆã®å¿…è¦æ€§ã¨å®Ÿæ–½æ–¹æ³•ã‚’èª¬æ˜ã§ãã‚‹</li>
            </ul>

            <h4>ğŸ”¬ å®Ÿè·µã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«</h4>
            <ul>
                <li>ASEã‚’ç”¨ã„ã¦å¤šæ§˜ãªçµæ™¶æ§‹é€ ã‚’ä½œæˆã§ãã‚‹</li>
                <li>å„ææ–™ã®ç‰©æ€§ï¼ˆé›»å­çŠ¶æ…‹ãƒ»å…‰å­¦ãƒ»ç£æ€§ãƒ»èª˜é›»ï¼‰è¨ˆç®—ã‚’å®Ÿè¡Œã§ãã‚‹</li>
                <li>kç‚¹ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•ãƒ»ã‚¹ãƒ”ãƒ³è¨­å®šã‚’é©åˆ‡ã«æ±ºå®šã§ãã‚‹</li>
                <li>è¨ˆç®—çµæœã‚’å¯è¦–åŒ–ã—ã€ç‰©æ€§å€¤ã‚’å®šé‡çš„ã«è©•ä¾¡ã§ãã‚‹</li>
            </ul>

            <h4>ğŸš€ å¿œç”¨åŠ›ãƒ¬ãƒ™ãƒ«</h4>
            <ul>
                <li>ç ”ç©¶å¯¾è±¡ææ–™ã«å¿œã˜ã¦è¨ˆç®—è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹</li>
                <li>è¨ˆç®—ç²¾åº¦ã¨è¨ˆç®—ã‚³ã‚¹ãƒˆã®ãƒãƒ©ãƒ³ã‚¹ã‚’æœ€é©åŒ–ã§ãã‚‹</li>
                <li>è¨ˆç®—ã‚¨ãƒ©ãƒ¼ã‚’è¨ºæ–­ã—ã€è§£æ±ºç­–ã‚’å®Ÿè£…ã§ãã‚‹</li>
                <li>ãƒãƒƒãƒå‡¦ç†ã«ã‚ˆã‚Šè¤‡æ•°ææ–™ã®è¨ˆç®—ã‚’è‡ªå‹•åŒ–ã§ãã‚‹</li>
            </ul>
        </div>

        <h2>6.1 ç‰©æ€§è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å…¨ä½“åƒ</h2>

        <p>å®Ÿææ–™ã®ç‰©æ€§è¨ˆç®—ã¯ã€ä»¥ä¸‹ã®5æ®µéšã§æ§‹æˆã•ã‚Œã¾ã™ã€‚æœ¬ç« ã§ã¯ã“ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼ã‚’ã€4ã¤ã®ä»£è¡¨çš„ææ–™ã‚’ä¾‹ã«å®Ÿè·µçš„ã«å­¦ã³ã¾ã™ã€‚</p>

        <div class="workflow-diagram">
<pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç‰©æ€§è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  1ï¸âƒ£ æ§‹é€ ä½œæˆ (Structure Creation)                               â”‚
â”‚     â”œâ”€ å˜ä½æ ¼å­å®šç¾© (lattice parameters, atomic positions)       â”‚
â”‚     â”œâ”€ å¯¾ç§°æ€§ç¢ºèª (space group, symmetry operations)             â”‚
â”‚     â””â”€ æ§‹é€ æœ€é©åŒ– (geometry optimization)                        â”‚
â”‚           â†“                                                       â”‚
â”‚  2ï¸âƒ£ è¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š (Calculation Setup)                       â”‚
â”‚     â”œâ”€ kç‚¹ãƒ¡ãƒƒã‚·ãƒ¥æ±ºå®š (convergence test)                        â”‚
â”‚     â”œâ”€ ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•æ±ºå®š (convergence test)               â”‚
â”‚     â”œâ”€ äº¤æ›ç›¸é–¢æ±é–¢æ•°é¸æŠ (LDA/GGA/hybrid)                       â”‚
â”‚     â””â”€ ç‰¹æ®Šè¨­å®š (spin, SOC, U, etc.)                             â”‚
â”‚           â†“                                                       â”‚
â”‚  3ï¸âƒ£ DFTè¨ˆç®—å®Ÿè¡Œ (DFT Calculation)                                â”‚
â”‚     â”œâ”€ SCFè¨ˆç®— (self-consistent field)                           â”‚
â”‚     â”œâ”€ Band structureè¨ˆç®—                                        â”‚
â”‚     â”œâ”€ DOSè¨ˆç®— (density of states)                               â”‚
â”‚     â””â”€ ç‰©æ€§å›ºæœ‰ã®è¨ˆç®— (optical, magnetic, etc.)                  â”‚
â”‚           â†“                                                       â”‚
â”‚  4ï¸âƒ£ çµæœè§£æ (Post-processing)                                   â”‚
â”‚     â”œâ”€ ãƒ‡ãƒ¼ã‚¿æŠ½å‡º (energy, DOS, band, etc.)                      â”‚
â”‚     â”œâ”€ å¯è¦–åŒ– (matplotlib, pymatgen)                             â”‚
â”‚     â””â”€ ç‰©æ€§å€¤è¨ˆç®— (bandgap, Îµ, Î¼, etc.)                          â”‚
â”‚           â†“                                                       â”‚
â”‚  5ï¸âƒ£ å“è³ªç®¡ç† (Quality Control)                                   â”‚
â”‚     â”œâ”€ åæŸç¢ºèª (energy, force, stress)                          â”‚
â”‚     â”œâ”€ å®Ÿé¨“å€¤ã¨ã®æ¯”è¼ƒ                                             â”‚
â”‚     â””â”€ ã‚¨ãƒ©ãƒ¼è¨ºæ–­ãƒ»å†è¨ˆç®—                                         â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
        </div>

        <div class="info-box">
            <h4>ğŸ’¡ æœ¬ç« ã§æ‰±ã†4ã¤ã®ä»£è¡¨çš„ææ–™</h4>
            <table>
                <tr>
                    <th>ææ–™</th>
                    <th>ç‰©æ€§ã‚¯ãƒ©ã‚¹</th>
                    <th>è¨ˆç®—ã®ç„¦ç‚¹</th>
                    <th>å¿œç”¨ä¾‹</th>
                </tr>
                <tr>
                    <td><strong>Si</strong></td>
                    <td>åŠå°ä½“</td>
                    <td>ãƒãƒ³ãƒ‰æ§‹é€ ã€ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—</td>
                    <td>CMOSé›†ç©å›è·¯ã€å¤ªé™½é›»æ± </td>
                </tr>
                <tr>
                    <td><strong>GaN</strong></td>
                    <td>ãƒ¯ã‚¤ãƒ‰ã‚®ãƒ£ãƒƒãƒ—åŠå°ä½“</td>
                    <td>å…‰å­¦ç‰¹æ€§ã€èª˜é›»é–¢æ•°</td>
                    <td>é’è‰²LEDã€é«˜å‘¨æ³¢ãƒ‡ãƒã‚¤ã‚¹</td>
                </tr>
                <tr>
                    <td><strong>Fe</strong></td>
                    <td>ç£æ€§ä½“</td>
                    <td>ç£æ°—ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆã€ã‚¹ãƒ”ãƒ³åæ¥µ</td>
                    <td>æ°¸ä¹…ç£çŸ³ã€ã‚¹ãƒ”ãƒ³ãƒˆãƒ­ãƒ‹ã‚¯ã‚¹</td>
                </tr>
                <tr>
                    <td><strong>BaTiOâ‚ƒ</strong></td>
                    <td>å¼·èª˜é›»ä½“</td>
                    <td>èª˜é›»ç‡ã€åˆ†æ¥µã€æ ¼å­ãƒ€ã‚¤ãƒŠãƒŸã‚¯ã‚¹</td>
                    <td>MLCCã‚³ãƒ³ãƒ‡ãƒ³ã‚µã€åœ§é›»ç´ å­</td>
                </tr>
            </table>
        </div>

        <h2>6.2 ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£1ï¼šSiåŠå°ä½“ã®ãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—</h2>

        <p>æœ€ã‚‚åŸºæœ¬çš„ãªåŠå°ä½“ã§ã‚ã‚‹Siã‚’ä¾‹ã«ã€æ§‹é€ ä½œæˆã‹ã‚‰ãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—ã€çµæœè§£æã¾ã§ã®å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè·µã—ã¾ã™ã€‚</p>

        <h3>6.2.1 Siçµæ™¶æ§‹é€ ã®ä½œæˆ</h3>

        <p>Siã¯ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰æ§‹é€ ï¼ˆface-centered cubic, FCCï¼‰ã‚’æŒã¡ã¾ã™ã€‚ASEã®<code>bulk</code>é–¢æ•°ã‚’ä½¿ã†ã¨ã€ç°¡å˜ã«æ­£ç¢ºãªçµæ™¶æ§‹é€ ã‚’ä½œæˆã§ãã¾ã™ã€‚</p>

        <div class="code-block">
<strong>ã‚³ãƒ¼ãƒ‰ä¾‹1ï¼šSiçµæ™¶æ§‹é€ ã®ä½œæˆ</strong>
<code><pre>
from ase import Atoms
from ase.build import bulk
from ase.visualize import view
import numpy as np

# Siçµæ™¶æ§‹é€ ä½œæˆï¼ˆãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰æ§‹é€ ï¼‰
si = bulk('Si', 'diamond', a=5.43)

print("Siçµæ™¶æƒ…å ±:")
print(f"  æ ¼å­å®šæ•°: {si.cell.cellpar()[0]:.3f} Ã…")
print(f"  åŸå­æ•°: {len(si)} atoms")
print(f"  ç©ºé–“ç¾¤: Fd-3m (227)")
print(f"  åŸå­åº§æ¨™:")
for i, pos in enumerate(si.get_scaled_positions()):
    print(f"    Si{i+1}: ({pos[0]:.3f}, {pos[1]:.3f}, {pos[2]:.3f})")

# 2x2x2ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚»ãƒ«ä½œæˆ
si_supercell = si.repeat((2, 2, 2))
print(f"\n2x2x2ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚»ãƒ«: {len(si_supercell)} atoms")

# æ§‹é€ ã®å¯è¦–åŒ–ï¼ˆASE GUIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
# view(si)

# CIFå½¢å¼ã§ä¿å­˜
from ase.io import write
write('si_unitcell.cif', si)
write('si_supercell.cif', si_supercell)
print("\nâœ… CIFãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å®Œäº†")
</pre></code>
        </div>

        <div class="success-box">
            <strong>å®Ÿè¡Œçµæœä¾‹:</strong>
            <pre>Siçµæ™¶æƒ…å ±:
  æ ¼å­å®šæ•°: 5.430 Ã…
  åŸå­æ•°: 2 atoms
  ç©ºé–“ç¾¤: Fd-3m (227)
  åŸå­åº§æ¨™:
    Si1: (0.000, 0.000, 0.000)
    Si2: (0.250, 0.250, 0.250)

2x2x2ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚»ãƒ«: 16 atoms

âœ… CIFãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å®Œäº†</pre>
        </div>

        <h3>6.2.2 åæŸãƒ†ã‚¹ãƒˆï¼škç‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•</h3>

        <p>æ­£ç¢ºãªè¨ˆç®—ã«ã¯ã€kç‚¹ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•ã®åæŸç¢ºèªãŒä¸å¯æ¬ ã§ã™ã€‚ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç³»çµ±çš„ã«ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>

        <div class="code-block">
<strong>ã‚³ãƒ¼ãƒ‰ä¾‹2ï¼šSi kç‚¹ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•åæŸãƒ†ã‚¹ãƒˆ</strong>
<code><pre>
from ase.build import bulk
from ase.calculators.espresso import Espresso
import numpy as np
import matplotlib.pyplot as plt

# Siçµæ™¶ä½œæˆ
si = bulk('Si', 'diamond', a=5.43)

# æ“¬ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«è¨­å®š
pseudopotentials = {'Si': 'Si.pbe-n-rrkjus_psl.1.0.0.UPF'}

# =====================================
# 1. kç‚¹åæŸãƒ†ã‚¹ãƒˆï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•å›ºå®šï¼‰
# =====================================
kpts_list = [2, 4, 6, 8, 10, 12]
energies_k = []
ecutwfc_fixed = 30.0  # Ry

print("kç‚¹åæŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...")
for k in kpts_list:
    calc = Espresso(
        pseudopotentials=pseudopotentials,
        input_data={
            'control': {'calculation': 'scf'},
            'system': {'ecutwfc': ecutwfc_fixed, 'occupations': 'smearing'},
        },
        kpts=(k, k, k),
    )
    si.calc = calc
    energy = si.get_potential_energy()
    energies_k.append(energy)
    print(f"  k={k:2d}: E = {energy:.6f} eV")

# =====================================
# 2. ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•åæŸãƒ†ã‚¹ãƒˆï¼ˆkç‚¹å›ºå®šï¼‰
# =====================================
ecutwfc_list = [20, 25, 30, 35, 40, 45, 50]
energies_ecut = []
kpts_fixed = (8, 8, 8)

print("\nã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•åæŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...")
for ecut in ecutwfc_list:
    calc = Espresso(
        pseudopotentials=pseudopotentials,
        input_data={
            'control': {'calculation': 'scf'},
            'system': {'ecutwfc': ecut, 'occupations': 'smearing'},
        },
        kpts=kpts_fixed,
    )
    si.calc = calc
    energy = si.get_potential_energy()
    energies_ecut.append(energy)
    print(f"  ecutwfc={ecut:2d} Ry: E = {energy:.6f} eV")

# =====================================
# 3. åæŸã‚°ãƒ©ãƒ•ä½œæˆ
# =====================================
fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 4))

# kç‚¹åæŸ
ax1.plot(kpts_list, energies_k, 'o-', linewidth=2, markersize=8)
ax1.axhline(y=energies_k[-1], color='r', linestyle='--',
            label=f'Converged: {energies_k[-1]:.4f} eV')
ax1.set_xlabel('k-point mesh (kÃ—kÃ—k)', fontsize=12)
ax1.set_ylabel('Total Energy (eV)', fontsize=12)
ax1.set_title('k-point Convergence Test', fontsize=14)
ax1.grid(True, alpha=0.3)
ax1.legend()

# ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•åæŸ
ax2.plot(ecutwfc_list, energies_ecut, 's-', linewidth=2, markersize=8)
ax2.axhline(y=energies_ecut[-1], color='r', linestyle='--',
            label=f'Converged: {energies_ecut[-1]:.4f} eV')
ax2.set_xlabel('Energy Cutoff (Ry)', fontsize=12)
ax2.set_ylabel('Total Energy (eV)', fontsize=12)
ax2.set_title('Energy Cutoff Convergence Test', fontsize=14)
ax2.grid(True, alpha=0.3)
ax2.legend()

plt.tight_layout()
plt.savefig('si_convergence_tests.png', dpi=300)
print("\nâœ… åæŸãƒ†ã‚¹ãƒˆã‚°ãƒ©ãƒ•ä¿å­˜: si_convergence_tests.png")

# =====================================
# 4. åæŸåˆ¤å®šï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼å¤‰åŒ– < 1 meV/atomï¼‰
# =====================================
threshold = 0.001  # eV/atom

delta_k = abs(energies_k[-1] - energies_k[-2]) / len(si)
delta_ecut = abs(energies_ecut[-1] - energies_ecut[-2]) / len(si)

print("\nğŸ“Š åæŸåˆ¤å®š:")
print(f"  kç‚¹: Î”E = {delta_k*1000:.3f} meV/atom â†’ {'âœ… åæŸ' if delta_k < threshold else 'âŒ æœªåæŸ'}")
print(f"  ecutwfc: Î”E = {delta_ecut*1000:.3f} meV/atom â†’ {'âœ… åæŸ' if delta_ecut < threshold else 'âŒ æœªåæŸ'}")

print(f"\nğŸ¯ æ¨å¥¨è¨­å®š:")
print(f"  kç‚¹ãƒ¡ãƒƒã‚·ãƒ¥: {kpts_list[-2]}Ã—{kpts_list[-2]}Ã—{kpts_list[-2]}")
print(f"  ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•: {ecutwfc_list[-2]} Ry")
</pre></code>
        </div>

        <h3>6.2.3 ãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—ã®å®Ÿè¡Œ</h3>

        <p>åæŸè¨­å®šã‚’ç”¨ã„ã¦ã€SiåŠå°ä½“ã®å®Œå…¨ãªãƒãƒ³ãƒ‰æ§‹é€ ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>

        <div class="code-block">
<strong>ã‚³ãƒ¼ãƒ‰ä¾‹3ï¼šSiãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</strong>
<code><pre>
from ase.build import bulk
from ase.calculators.espresso import Espresso
from ase.dft.kpoints import special_points, bandpath
import matplotlib.pyplot as plt
import numpy as np

# Siçµæ™¶ä½œæˆ
si = bulk('Si', 'diamond', a=5.43)

# åæŸãƒ†ã‚¹ãƒˆã‹ã‚‰å¾—ãŸæœ€é©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
optimal_kpts = (10, 10, 10)
optimal_ecutwfc = 40.0  # Ry

pseudopotentials = {'Si': 'Si.pbe-n-rrkjus_psl.1.0.0.UPF'}

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—1ï¼šSCFè¨ˆç®—
# =====================================
print("ã‚¹ãƒ†ãƒƒãƒ—1ï¼šSCFè¨ˆç®—å®Ÿè¡Œä¸­...")
calc_scf = Espresso(
    pseudopotentials=pseudopotentials,
    input_data={
        'control': {
            'calculation': 'scf',
            'restart_mode': 'from_scratch',
            'prefix': 'si',
        },
        'system': {
            'ecutwfc': optimal_ecutwfc,
            'occupations': 'smearing',
            'smearing': 'gaussian',
            'degauss': 0.01,
        },
        'electrons': {
            'conv_thr': 1.0e-8,
        }
    },
    kpts=optimal_kpts,
)
si.calc = calc_scf
energy_scf = si.get_potential_energy()
print(f"âœ… SCFå®Œäº†: E = {energy_scf:.6f} eV")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—2ï¼šãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—
# =====================================
print("\nã‚¹ãƒ†ãƒƒãƒ—2ï¼šãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—å®Ÿè¡Œä¸­...")

# é«˜å¯¾ç§°ç‚¹ãƒ‘ã‚¹å®šç¾©ï¼ˆFCC: L-Î“-X-W-K-Î“ï¼‰
points = special_points['fcc']
path = bandpath(['L', 'Gamma', 'X', 'W', 'K', 'Gamma'], si.cell, npoints=100)

calc_bands = Espresso(
    pseudopotentials=pseudopotentials,
    input_data={
        'control': {
            'calculation': 'bands',
            'restart_mode': 'restart',
            'prefix': 'si',
        },
        'system': {
            'ecutwfc': optimal_ecutwfc,
            'occupations': 'smearing',
            'smearing': 'gaussian',
            'degauss': 0.01,
        },
    },
    kpts=path,
)
si.calc = calc_bands
bands = calc_bands.band_structure()

print("âœ… ãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—å®Œäº†")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—3ï¼šãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—è¨ˆç®—
# =====================================
energies = bands.energies
kpoints = bands.kpts
fermi_level = calc_bands.get_fermi_level()

# ä¾¡é›»å­å¸¯é ‚ä¸Šï¼ˆVBMï¼‰ã¨ä¼å°å¸¯åº•ï¼ˆCBMï¼‰ã‚’æ¢ç´¢
vbm_energy = np.max(energies[energies < fermi_level])
cbm_energy = np.min(energies[energies > fermi_level])
bandgap = cbm_energy - vbm_energy

print(f"\nğŸ“Š ãƒãƒ³ãƒ‰æ§‹é€ è§£æçµæœ:")
print(f"  ãƒ•ã‚§ãƒ«ãƒŸãƒ¬ãƒ™ãƒ«: {fermi_level:.4f} eV")
print(f"  VBM: {vbm_energy:.4f} eV")
print(f"  CBM: {cbm_energy:.4f} eV")
print(f"  ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—: {bandgap:.4f} eV")
print(f"  å®Ÿé¨“å€¤: 1.12 eV (300K)")
print(f"  èª¤å·®: {abs(bandgap - 1.12)/1.12*100:.1f}%")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—4ï¼šå¯è¦–åŒ–
# =====================================
fig, ax = plt.subplots(figsize=(8, 6))
bands.plot(ax=ax, emin=-10, emax=10)
ax.axhline(y=0, color='k', linestyle='--', linewidth=1, label='Fermi level')
ax.set_ylabel('Energy (eV)', fontsize=12)
ax.set_title(f'Si Band Structure (Eg = {bandgap:.3f} eV)', fontsize=14)
ax.legend()
plt.tight_layout()
plt.savefig('si_bandstructure.png', dpi=300)
print("\nâœ… ãƒãƒ³ãƒ‰æ§‹é€ å›³ä¿å­˜: si_bandstructure.png")
</pre></code>
        </div>

        <div class="warning-box">
            <h4>âš ï¸ GGAã«ã‚ˆã‚‹ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—éå°è©•ä¾¡</h4>
            <p>PBEï¼ˆGGAï¼‰æ±é–¢æ•°ã¯ã€åŠå°ä½“ã®ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—ã‚’ç³»çµ±çš„ã«éå°è©•ä¾¡ã—ã¾ã™ï¼ˆSiã§ç´„0.6 eVã€å®Ÿé¨“å€¤1.12 eVã«å¯¾ã—ï¼‰ã€‚ã‚ˆã‚Šæ­£ç¢ºãªå€¤ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹æ³•ãŒå¿…è¦ã§ã™ï¼š</p>
            <ul>
                <li><strong>HSE06ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ±é–¢æ•°</strong>ï¼šå®Ÿé¨“å€¤ã«è¿‘ã„ç²¾åº¦ï¼ˆè¨ˆç®—ã‚³ã‚¹ãƒˆç´„10å€ï¼‰</li>
                <li><strong>GWè¿‘ä¼¼</strong>ï¼šæœ€ã‚‚æ­£ç¢ºï¼ˆè¨ˆç®—ã‚³ã‚¹ãƒˆç´„100å€ï¼‰</li>
                <li><strong>Scissorè£œæ­£</strong>ï¼šç°¡ä¾¿ãªè£œæ­£ï¼ˆå®Ÿé¨“å€¤ã¨ã®å·®åˆ†ã‚’CBMå´ã«ã‚·ãƒ•ãƒˆï¼‰</li>
            </ul>
        </div>

        <h2>6.3 ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£2ï¼šGaNå…‰å­¦ç‰¹æ€§è¨ˆç®—</h2>

        <p>çª’åŒ–ã‚¬ãƒªã‚¦ãƒ ï¼ˆGaNï¼‰ã¯é’è‰²LEDã«ä½¿ã‚ã‚Œã‚‹ãƒ¯ã‚¤ãƒ‰ã‚®ãƒ£ãƒƒãƒ—åŠå°ä½“ã§ã™ã€‚å…‰å­¦ç‰¹æ€§ï¼ˆèª˜é›»é–¢æ•°ã€å¸åã‚¹ãƒšã‚¯ãƒˆãƒ«ï¼‰ã®è¨ˆç®—æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚</p>

        <h3>6.3.1 GaNå…­æ–¹æ™¶ã‚¦ãƒ«ãƒ„é‰±æ§‹é€ ã®ä½œæˆ</h3>

        <div class="code-block">
<strong>ã‚³ãƒ¼ãƒ‰ä¾‹4ï¼šGaNæ§‹é€ ä½œæˆã¨å…‰å­¦è¨ˆç®—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</strong>
<code><pre>
from ase import Atoms
from ase.io import write
import numpy as np

# GaN ã‚¦ãƒ«ãƒ„é‰±æ§‹é€ ï¼ˆå…­æ–¹æ™¶, P6_3mcï¼‰
a = 3.189  # Ã…
c = 5.185  # Ã…
u = 0.377  # å†…éƒ¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

# å…­æ–¹æ™¶æ ¼å­ãƒ™ã‚¯ãƒˆãƒ«
cell = [
    [a, 0, 0],
    [-a/2, a*np.sqrt(3)/2, 0],
    [0, 0, c]
]

# åŸå­åº§æ¨™ï¼ˆåˆ†ç‡åº§æ¨™ï¼‰
positions = [
    [1/3, 2/3, 0],      # Ga1
    [2/3, 1/3, 1/2],    # Ga2
    [1/3, 2/3, u],      # N1
    [2/3, 1/3, 1/2+u],  # N2
]

# Atomsä½œæˆ
gan = Atoms(
    symbols='Ga2N2',
    scaled_positions=positions,
    cell=cell,
    pbc=True
)

print("GaNçµæ™¶æƒ…å ±:")
print(f"  æ ¼å­å®šæ•°: a = {a:.3f} Ã…, c = {c:.3f} Ã…")
print(f"  c/aæ¯”: {c/a:.3f}")
print(f"  ç©ºé–“ç¾¤: P6_3mc (186)")
print(f"  åŸå­æ•°: {len(gan)} atoms")
print(f"\nåŸå­åº§æ¨™ï¼ˆã‚«ãƒ«ãƒ†ã‚·ã‚¢ãƒ³, Ã…ï¼‰:")
for i, (sym, pos) in enumerate(zip(gan.get_chemical_symbols(), gan.positions)):
    print(f"  {sym}{i+1}: ({pos[0]:7.3f}, {pos[1]:7.3f}, {pos[2]:7.3f})")

# CIFä¿å­˜
write('gan_wurtzite.cif', gan)
print("\nâœ… GaNæ§‹é€ ä¿å­˜å®Œäº†: gan_wurtzite.cif")

# =====================================
# å…‰å­¦è¨ˆç®—ã®ãŸã‚ã®è¨­å®šä¾‹
# =====================================
print("\nğŸ“‹ GaNå…‰å­¦è¨ˆç®—æ¨å¥¨è¨­å®š:")
print("  1. æ§‹é€ æœ€é©åŒ–:")
print("     - æ ¼å­å®šæ•°æœ€é©åŒ–: å¿…é ˆ")
print("     - å†…éƒ¨åº§æ¨™æœ€é©åŒ–: u ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿")
print("  2. åæŸè¨­å®š:")
print("     - kç‚¹: 12Ã—12Ã—8 ä»¥ä¸Šï¼ˆå…­æ–¹æ™¶ç³»ï¼‰")
print("     - ecutwfc: 50 Ry ä»¥ä¸Š")
print("  3. å…‰å­¦è¨ˆç®—:")
print("     - ç©ºãƒãƒ³ãƒ‰æ•°: ä¼å°å¸¯ 30æœ¬ä»¥ä¸Š")
print("     - ã‚¹ãƒ¡ã‚¢ãƒªãƒ³ã‚°: 0.01 Ry (Gaussian)")
print("     - åå…‰æ–¹å‘: âŠ¥cè»¸ï¼ˆE_âŠ¥ï¼‰ã¨ âˆ¥cè»¸ï¼ˆE_âˆ¥ï¼‰")
</pre></code>
        </div>

        <h3>6.3.2 èª˜é›»é–¢æ•°ã¨å¸åã‚¹ãƒšã‚¯ãƒˆãƒ«ã®è¨ˆç®—</h3>

        <div class="code-block">
<strong>ã‚³ãƒ¼ãƒ‰ä¾‹5ï¼šGaNå…‰å­¦ç‰¹æ€§è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</strong>
<code><pre>
from ase.calculators.espresso import Espresso
import numpy as np
import matplotlib.pyplot as plt

# GaNæ§‹é€ ï¼ˆå‰ã®ã‚³ãƒ¼ãƒ‰ã§ä½œæˆæ¸ˆã¿ï¼‰
# gan = [GaN Atoms object]

pseudopotentials = {
    'Ga': 'Ga.pbe-dnl-rrkjus_psl.1.0.0.UPF',
    'N': 'N.pbe-n-radius_5.UPF'
}

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—1ï¼šSCFè¨ˆç®—ï¼ˆé«˜å¯†åº¦kç‚¹ï¼‰
# =====================================
print("ã‚¹ãƒ†ãƒƒãƒ—1ï¼šSCFè¨ˆç®—ï¼ˆå…‰å­¦ç”¨ï¼‰...")
calc_scf = Espresso(
    pseudopotentials=pseudopotentials,
    input_data={
        'control': {
            'calculation': 'scf',
            'prefix': 'gan',
        },
        'system': {
            'ecutwfc': 50.0,
            'nbnd': 40,  # ç©ºãƒãƒ³ãƒ‰å«ã‚€
            'occupations': 'smearing',
            'smearing': 'gaussian',
            'degauss': 0.01,
        },
        'electrons': {
            'conv_thr': 1.0e-9,
        }
    },
    kpts=(12, 12, 8),  # å…­æ–¹æ™¶ç³»
)
gan.calc = calc_scf
energy_scf = gan.get_potential_energy()
print(f"âœ… SCFå®Œäº†: E = {energy_scf:.6f} eV")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—2ï¼šNSCFè¨ˆç®—ï¼ˆã‚ˆã‚Šå¯†ãªkç‚¹ï¼‰
# =====================================
print("\nã‚¹ãƒ†ãƒƒãƒ—2ï¼šNSCFè¨ˆç®—ï¼ˆå…‰å­¦é·ç§»ç”¨ï¼‰...")
calc_nscf = Espresso(
    pseudopotentials=pseudopotentials,
    input_data={
        'control': {
            'calculation': 'nscf',
            'restart_mode': 'restart',
            'prefix': 'gan',
        },
        'system': {
            'ecutwfc': 50.0,
            'nbnd': 60,  # ã•ã‚‰ã«å¤šãã®ç©ºãƒãƒ³ãƒ‰
            'occupations': 'smearing',
            'smearing': 'gaussian',
            'degauss': 0.01,
        },
    },
    kpts=(24, 24, 16),  # SCFã®2å€å¯†åº¦
)
gan.calc = calc_nscf
print("âœ… NSCFå®Œäº†")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—3ï¼šèª˜é›»é–¢æ•°è¨ˆç®—ï¼ˆepsilon.xï¼‰
# =====================================
print("\nã‚¹ãƒ†ãƒƒãƒ—3ï¼šèª˜é›»é–¢æ•°è¨ˆç®—...")

# epsilon.xã®å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆå®Ÿéš›ã®è¨ˆç®—ã§ã¯Quantum ESPRESSOã®epsilon.xã‚’ä½¿ç”¨ï¼‰
epsilon_input = """
 &inputpp
   prefix = 'gan'
   outdir = './tmp/'
   calculation = 'eps'
 /
 &energy_grid
   smeartype = 'gauss'
   intersmear = 0.1
   wmin = 0.0
   wmax = 30.0
   nw = 500
 /
"""

with open('epsilon.in', 'w') as f:
    f.write(epsilon_input)

print("âœ… epsilon.xå…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: epsilon.in")
print("  æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œ: epsilon.x < epsilon.in > epsilon.out")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—4ï¼šçµæœã®å¯è¦–åŒ–ï¼ˆä¾‹ç¤ºï¼‰
# =====================================
# å®Ÿéš›ã®è¨ˆç®—çµæœã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€æƒ³å®š

# ä»®æƒ³çš„ãªèª˜é›»é–¢æ•°ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã¯epsilonr.datã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
omega = np.linspace(0, 10, 200)  # eV
epsilon_real = 5.0 + 2.0 * np.exp(-((omega - 3.4)/0.5)**2)  # Îµâ‚(Ï‰)
epsilon_imag = 3.0 * np.exp(-((omega - 3.4)/0.3)**2)  # Îµâ‚‚(Ï‰)

# å¸åä¿‚æ•° Î±(Ï‰) = (2Ï‰/c) * sqrt((sqrt(Îµâ‚Â² + Îµâ‚‚Â²) - Îµâ‚)/2)
c = 2.998e8  # m/s
alpha = (2 * omega / c) * np.sqrt((np.sqrt(epsilon_real**2 + epsilon_imag**2) - epsilon_real) / 2)

fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(12, 10))

# Îµâ‚(Ï‰)
ax1.plot(omega, epsilon_real, 'b-', linewidth=2)
ax1.axvline(x=3.4, color='r', linestyle='--', label='Direct gap (exp: 3.4 eV)')
ax1.set_xlabel('Energy (eV)', fontsize=12)
ax1.set_ylabel('Re[Îµ(Ï‰)]', fontsize=12)
ax1.set_title('Real Part of Dielectric Function', fontsize=14)
ax1.grid(True, alpha=0.3)
ax1.legend()

# Îµâ‚‚(Ï‰)
ax2.plot(omega, epsilon_imag, 'r-', linewidth=2)
ax2.axvline(x=3.4, color='r', linestyle='--', label='Direct gap (exp: 3.4 eV)')
ax2.set_xlabel('Energy (eV)', fontsize=12)
ax2.set_ylabel('Im[Îµ(Ï‰)]', fontsize=12)
ax2.set_title('Imaginary Part of Dielectric Function', fontsize=14)
ax2.grid(True, alpha=0.3)
ax2.legend()

# å¸åã‚¹ãƒšã‚¯ãƒˆãƒ«
ax3.plot(omega, alpha, 'g-', linewidth=2)
ax3.set_xlabel('Energy (eV)', fontsize=12)
ax3.set_ylabel('Absorption Coefficient (cmâ»Â¹)', fontsize=12)
ax3.set_title('Optical Absorption Spectrum', fontsize=14)
ax3.set_yscale('log')
ax3.grid(True, alpha=0.3)

# åå°„ç‡ R(Ï‰)
n = np.sqrt(epsilon_real + 1j * epsilon_imag)  # è¤‡ç´ å±ˆæŠ˜ç‡
reflectance = np.abs((n - 1) / (n + 1))**2
ax4.plot(omega, reflectance, 'm-', linewidth=2)
ax4.set_xlabel('Energy (eV)', fontsize=12)
ax4.set_ylabel('Reflectance', fontsize=12)
ax4.set_title('Normal Incidence Reflectance', fontsize=14)
ax4.grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('gan_optical_properties.png', dpi=300)
print("\nâœ… å…‰å­¦ç‰¹æ€§ã‚°ãƒ©ãƒ•ä¿å­˜: gan_optical_properties.png")

print("\nğŸ“Š GaNå…‰å­¦ç‰¹æ€§ï¼ˆä»£è¡¨å€¤ï¼‰:")
print(f"  ç›´æ¥é·ç§»ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—: 3.4 eV (å®Ÿé¨“å€¤)")
print(f"  é™èª˜é›»ç‡ Îµ(0): {epsilon_real[0]:.2f}")
print(f"  å¯è¦–å…‰é ˜åŸŸå±ˆæŠ˜ç‡: ~2.3")
print(f"  å¸åç«¯: ç´„365 nmï¼ˆç´«å¤–åŸŸï¼‰")
</pre></code>
        </div>

        <h2>6.4 ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£3ï¼šFeç£æ€§ä½“ã®ç£æ°—ç‰¹æ€§è¨ˆç®—</h2>

        <p>é‰„ï¼ˆFeï¼‰ã¯ä»£è¡¨çš„ãªå¼·ç£æ€§ä½“ã§ã™ã€‚ã‚¹ãƒ”ãƒ³åˆ†æ¥µDFTè¨ˆç®—ã«ã‚ˆã‚Šã€ç£æ°—ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆã¨ã‚¹ãƒ”ãƒ³çŠ¶æ…‹å¯†åº¦ã‚’æ±‚ã‚ã¾ã™ã€‚</p>

        <h3>6.4.1 ã‚¹ãƒ”ãƒ³åˆ†æ¥µè¨ˆç®—ã®è¨­å®š</h3>

        <div class="code-block">
<strong>ã‚³ãƒ¼ãƒ‰ä¾‹6ï¼šFeç£æ°—ç‰¹æ€§è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</strong>
<code><pre>
from ase.build import bulk
from ase.calculators.espresso import Espresso
from ase.io import write
import numpy as np
import matplotlib.pyplot as plt

# Fe bccæ§‹é€ 
fe = bulk('Fe', 'bcc', a=2.87)

print("Feçµæ™¶æƒ…å ±:")
print(f"  æ§‹é€ : bcc (body-centered cubic)")
print(f"  æ ¼å­å®šæ•°: {fe.cell.cellpar()[0]:.3f} Ã…")
print(f"  ç©ºé–“ç¾¤: Im-3m (229)")
print(f"  ç£æ€§: å¼·ç£æ€§ä½“ï¼ˆå®¤æ¸©ï¼‰")

pseudopotentials = {'Fe': 'Fe.pbe-spn-rrkjus_psl.1.0.0.UPF'}

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—1ï¼šã‚¹ãƒ”ãƒ³åˆ†æ¥µSCFè¨ˆç®—
# =====================================
print("\nã‚¹ãƒ†ãƒƒãƒ—1ï¼šã‚¹ãƒ”ãƒ³åˆ†æ¥µSCFè¨ˆç®—...")

calc_scf = Espresso(
    pseudopotentials=pseudopotentials,
    input_data={
        'control': {
            'calculation': 'scf',
            'prefix': 'fe',
        },
        'system': {
            'ecutwfc': 60.0,
            'ecutrho': 480.0,  # é‡‘å±ã¯é«˜ã„ã‚«ãƒƒãƒˆã‚ªãƒ•ãŒå¿…è¦
            'occupations': 'smearing',
            'smearing': 'mv',  # Marzari-Vanderbilt (é‡‘å±æ¨å¥¨)
            'degauss': 0.02,
            'nspin': 2,  # ã‚¹ãƒ”ãƒ³åˆ†æ¥µè¨ˆç®—ã‚’æœ‰åŠ¹åŒ–
            'starting_magnetization(1)': 0.5,  # åˆæœŸç£åŒ–ï¼ˆFeï¼‰
        },
        'electrons': {
            'conv_thr': 1.0e-8,
            'mixing_beta': 0.3,  # ç£æ€§ä½“ã¯åæŸãŒé…ã„
        }
    },
    kpts=(16, 16, 16),  # é‡‘å±ã¯å¯†ãªkç‚¹å¿…è¦
)

fe.calc = calc_scf
energy_scf = fe.get_potential_energy()
print(f"âœ… SCFå®Œäº†: E = {energy_scf:.6f} eV")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—2ï¼šç£æ°—ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆè§£æ
# =====================================
# å®Ÿéš›ã®è¨ˆç®—ã§ã¯ã€Quantum ESPRESSOã®å‡ºåŠ›ã‹ã‚‰æŠ½å‡º
print("\nğŸ“Š ç£æ°—ç‰¹æ€§è§£æçµæœ:")

# ä»®æƒ³çš„ãªçµæœï¼ˆå®Ÿéš›ã¯SCFå‡ºåŠ›ã‹ã‚‰èª­ã¿å–ã‚Šï¼‰
total_magnetization = 2.15  # Î¼B/atom
absolute_magnetization = 2.20  # Î¼B/atom

print(f"  å…¨ç£æ°—ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ: {total_magnetization:.3f} Î¼B/atom")
print(f"  çµ¶å¯¾ç£æ°—ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ: {absolute_magnetization:.3f} Î¼B/atom")
print(f"  å®Ÿé¨“å€¤: 2.22 Î¼B/atom")
print(f"  èª¤å·®: {abs(total_magnetization - 2.22)/2.22*100:.1f}%")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—3ï¼šã‚¹ãƒ”ãƒ³çŠ¶æ…‹å¯†åº¦è¨ˆç®—
# =====================================
print("\nã‚¹ãƒ†ãƒƒãƒ—3ï¼šã‚¹ãƒ”ãƒ³çŠ¶æ…‹å¯†åº¦ï¼ˆDOSï¼‰è¨ˆç®—...")

calc_dos = Espresso(
    pseudopotentials=pseudopotentials,
    input_data={
        'control': {
            'calculation': 'nscf',
            'restart_mode': 'restart',
            'prefix': 'fe',
        },
        'system': {
            'ecutwfc': 60.0,
            'ecutrho': 480.0,
            'occupations': 'tetrahedra',  # DOSè¨ˆç®—æ¨å¥¨
            'nspin': 2,
        },
    },
    kpts=(24, 24, 24),  # NSCFã§ã¯ã‚ˆã‚Šå¯†ãªkç‚¹
)

fe.calc = calc_dos
print("âœ… NSCFå®Œäº†")

# projwfc.x ã¾ãŸã¯ dos.x ã§çŠ¶æ…‹å¯†åº¦è¨ˆç®—ï¼ˆå®Ÿéš›ã®æ‰‹é †ï¼‰
print("  æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: projwfc.x ã§ã‚¹ãƒ”ãƒ³åˆ†æ¥µDOSã‚’è¨ˆç®—")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—4ï¼šã‚¹ãƒ”ãƒ³åˆ†æ¥µDOSå¯è¦–åŒ–
# =====================================
# ä»®æƒ³çš„ãªDOSãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã¯è¨ˆç®—çµæœã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
energy = np.linspace(-10, 10, 500)
dos_up = 1.5 * np.exp(-((energy - 2)/1.5)**2) + 0.5
dos_down = -1.0 * np.exp(-((energy - 2)/1.5)**2) - 0.3
fermi_level = 0.0

fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 5))

# ã‚¹ãƒ”ãƒ³åˆ†æ¥µDOS
ax1.fill_between(energy, dos_up, 0, alpha=0.5, color='b', label='Spin up')
ax1.fill_between(energy, dos_down, 0, alpha=0.5, color='r', label='Spin down')
ax1.axvline(x=fermi_level, color='k', linestyle='--', linewidth=2, label='Fermi level')
ax1.axhline(y=0, color='k', linewidth=0.5)
ax1.set_xlabel('Energy (eV)', fontsize=12)
ax1.set_ylabel('DOS (states/eV/atom)', fontsize=12)
ax1.set_title('Fe Spin-Polarized DOS', fontsize=14)
ax1.legend()
ax1.grid(True, alpha=0.3)

# ç£æ°—ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆå¯†åº¦
mag_density = dos_up + dos_down
ax2.plot(energy, mag_density, 'g-', linewidth=2)
ax2.axvline(x=fermi_level, color='k', linestyle='--', linewidth=2, label='Fermi level')
ax2.axhline(y=0, color='k', linewidth=0.5)
ax2.set_xlabel('Energy (eV)', fontsize=12)
ax2.set_ylabel('Magnetization Density (Î¼B/eV/atom)', fontsize=12)
ax2.set_title('Fe Magnetic Moment Density', fontsize=14)
ax2.legend()
ax2.grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('fe_magnetic_properties.png', dpi=300)
print("\nâœ… ç£æ°—ç‰¹æ€§ã‚°ãƒ©ãƒ•ä¿å­˜: fe_magnetic_properties.png")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—5ï¼šäº¤æ›ã‚¹ãƒ”ãƒ³åˆ†è£‚è§£æ
# =====================================
print("\nğŸ“Š äº¤æ›ã‚¹ãƒ”ãƒ³åˆ†è£‚è§£æ:")
exchange_splitting = 2.1  # eVï¼ˆdè»Œé“ï¼‰
print(f"  dè»Œé“äº¤æ›åˆ†è£‚: {exchange_splitting:.2f} eV")
print(f"  ã‚¹ãƒ”ãƒ³åˆ†æ¥µç‡: {(dos_up[250] - abs(dos_down[250]))/(dos_up[250] + abs(dos_down[250]))*100:.1f}%")
</pre></code>
        </div>

        <div class="info-box">
            <h4>ğŸ’¡ ç£æ€§è¨ˆç®—ã®è¿½åŠ æ¤œè¨äº‹é …</h4>
            <ul>
                <li><strong>Hubbard Uè£œæ­£</strong>ï¼šé·ç§»é‡‘å±ã®å¼·ç›¸é–¢é›»å­ç³»ã§ã¯ã€DFT+Uæ³•ãŒç£æ°—ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆã‚’ã‚ˆã‚Šæ­£ç¢ºã«äºˆæ¸¬</li>
                <li><strong>åå¼·ç£æ€§æ§‹é€ </strong>ï¼šã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚»ãƒ«ã‚’ç”¨ã„ã¦ç•°ãªã‚‹ã‚¹ãƒ”ãƒ³é…ç½®ã‚’è¨ˆç®—</li>
                <li><strong>ç£æ°—ç•°æ–¹æ€§</strong>ï¼šã‚¹ãƒ”ãƒ³è»Œé“ç›¸äº’ä½œç”¨ï¼ˆSOCï¼‰ã‚’å«ã‚ã‚‹ã“ã¨ã§ã€ç£åŒ–å®¹æ˜“è»¸ã‚’è¨ˆç®—å¯èƒ½</li>
                <li><strong>ã‚­ãƒ¥ãƒªãƒ¼æ¸©åº¦</strong>ï¼šMonte Carloæ³•ã¨ã®çµ„ã¿åˆã‚ã›ã§æ¨å®šå¯èƒ½</li>
            </ul>
        </div>

        <h2>6.5 ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£4ï¼šBaTiOâ‚ƒå¼·èª˜é›»ä½“ã®èª˜é›»ç‰¹æ€§</h2>

        <p>ãƒã‚¿ãƒ³é…¸ãƒãƒªã‚¦ãƒ ï¼ˆBaTiOâ‚ƒï¼‰ã¯ä»£è¡¨çš„ãªå¼·èª˜é›»ä½“ææ–™ã§ã™ã€‚æ§‹é€ ç›¸è»¢ç§»ã¨èª˜é›»ç‰¹æ€§ã®è¨ˆç®—æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚</p>

        <h3>6.5.1 ãƒšãƒ­ãƒ–ã‚¹ã‚«ã‚¤ãƒˆæ§‹é€ ã®ä½œæˆã¨ç›¸è»¢ç§»</h3>

        <div class="code-block">
<strong>ã‚³ãƒ¼ãƒ‰ä¾‹7ï¼šBaTiOâ‚ƒæ§‹é€ ã¨åˆ†æ¥µè¨ˆç®—</strong>
<code><pre>
from ase import Atoms
from ase.io import write
import numpy as np

# BaTiOâ‚ƒ ãƒšãƒ­ãƒ–ã‚¹ã‚«ã‚¤ãƒˆæ§‹é€ ï¼ˆç«‹æ–¹æ™¶ç›¸, å¸¸èª˜é›»æ€§ï¼‰
a = 4.00  # Ã…ï¼ˆç«‹æ–¹æ™¶æ ¼å­å®šæ•°ï¼‰

# ç«‹æ–¹æ™¶ç›¸ï¼ˆé«˜æ¸©ã€å¸¸èª˜é›»æ€§ï¼‰
bto_cubic = Atoms(
    symbols='BaTiO3',
    scaled_positions=[
        [0.0, 0.0, 0.0],  # Ba at corner
        [0.5, 0.5, 0.5],  # Ti at body center
        [0.5, 0.5, 0.0],  # O1 at face center
        [0.5, 0.0, 0.5],  # O2
        [0.0, 0.5, 0.5],  # O3
    ],
    cell=[a, a, a],
    pbc=True
)

print("BaTiOâ‚ƒ ç«‹æ–¹æ™¶ç›¸ï¼ˆå¸¸èª˜é›»æ€§ã€> 120Â°Cï¼‰:")
print(f"  æ ¼å­å®šæ•°: a = {a:.3f} Ã…")
print(f"  ç©ºé–“ç¾¤: Pm-3m (221)")
print(f"  ä¸­å¿ƒå¯¾ç§°æ€§: ã‚ã‚Š")

# æ­£æ–¹æ™¶ç›¸ï¼ˆå®¤æ¸©ã€å¼·èª˜é›»æ€§ï¼‰
a_tetra = 3.99  # Ã…
c_tetra = 4.03  # Ã…ï¼ˆcè»¸æ–¹å‘ã«ä¼¸ã³ã‚‹ï¼‰
delta_z_Ti = 0.015  # Tiã®å¤‰ä½
delta_z_O = 0.020  # è»¸æ–¹å‘Oã®å¤‰ä½

bto_tetra = Atoms(
    symbols='BaTiO3',
    scaled_positions=[
        [0.0, 0.0, 0.0],           # Ba
        [0.5, 0.5, 0.5 + delta_z_Ti],  # Tiï¼ˆä¸‹æ–¹å¤‰ä½ï¼‰
        [0.5, 0.5, 0.0 - delta_z_O],   # O1ï¼ˆä¸Šæ–¹å¤‰ä½ï¼‰
        [0.5, 0.0, 0.5],           # O2
        [0.0, 0.5, 0.5],           # O3
    ],
    cell=[a_tetra, a_tetra, c_tetra],
    pbc=True
)

print(f"\nBaTiOâ‚ƒ æ­£æ–¹æ™¶ç›¸ï¼ˆå¼·èª˜é›»æ€§ã€å®¤æ¸©ï¼‰:")
print(f"  æ ¼å­å®šæ•°: a = {a_tetra:.3f} Ã…, c = {c_tetra:.3f} Ã…")
print(f"  c/aæ¯”: {c_tetra/a_tetra:.4f}")
print(f"  ç©ºé–“ç¾¤: P4mm (99)")
print(f"  ä¸­å¿ƒå¯¾ç§°æ€§: ãªã—ï¼ˆæ¥µæ€§æ§‹é€ ï¼‰")
print(f"  Tiå¤‰ä½: {delta_z_Ti * c_tetra:.4f} Ã…")

# CIFä¿å­˜
write('bto_cubic.cif', bto_cubic)
write('bto_tetragonal.cif', bto_tetra)
print("\nâœ… BaTiOâ‚ƒæ§‹é€ ä¿å­˜å®Œäº†")

# =====================================
# è‡ªç™ºåˆ†æ¥µè¨ˆç®—ã®æº–å‚™
# =====================================
print("\nğŸ“‹ è‡ªç™ºåˆ†æ¥µè¨ˆç®—æ‰‹é †:")
print("  1. ç«‹æ–¹æ™¶ç›¸ã®æ§‹é€ æœ€é©åŒ–ï¼ˆå‚ç…§çŠ¶æ…‹ï¼‰")
print("  2. æ­£æ–¹æ™¶ç›¸ã®æ§‹é€ æœ€é©åŒ–ï¼ˆåˆ†æ¥µçŠ¶æ…‹ï¼‰")
print("  3. Berryä½ç›¸æ³•ã§åˆ†æ¥µè¨ˆç®—:")
print("     P = (P_tetra - P_cubic) / V")
print("  4. å®Ÿé¨“å€¤ã¨ã®æ¯”è¼ƒ:")
print("     - å®Ÿé¨“å€¤: 26 Î¼C/cmÂ² (å®¤æ¸©)")
print("     - è¨ˆç®—å€¤: é€šå¸¸20-30 Î¼C/cmÂ²ï¼ˆDFTç²¾åº¦ï¼‰")
</pre></code>
        </div>

        <h3>6.5.2 èª˜é›»ç‡ã¨æ ¼å­ãƒ€ã‚¤ãƒŠãƒŸã‚¯ã‚¹è¨ˆç®—</h3>

        <div class="code-block">
<strong>ã‚³ãƒ¼ãƒ‰ä¾‹8ï¼šBaTiOâ‚ƒèª˜é›»ç‡è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</strong>
<code><pre>
from ase.calculators.espresso import Espresso
from ase.phonons import Phonons
import numpy as np
import matplotlib.pyplot as plt

# BaTiOâ‚ƒæ­£æ–¹æ™¶ç›¸ï¼ˆå‰ã®ã‚³ãƒ¼ãƒ‰ã§ä½œæˆï¼‰
# bto_tetra = [BaTiO3 Atoms object]

pseudopotentials = {
    'Ba': 'Ba.pbe-spn-rrkjus_psl.1.0.0.UPF',
    'Ti': 'Ti.pbe-spn-rrkjus_psl.1.0.0.UPF',
    'O': 'O.pbe-n-rrkjus_psl.1.0.0.UPF'
}

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—1ï¼šæ§‹é€ æœ€é©åŒ–
# =====================================
print("ã‚¹ãƒ†ãƒƒãƒ—1ï¼šæ§‹é€ æœ€é©åŒ–...")

calc_relax = Espresso(
    pseudopotentials=pseudopotentials,
    input_data={
        'control': {
            'calculation': 'vc-relax',  # æ ¼å­å®šæ•°ã‚‚æœ€é©åŒ–
            'prefix': 'bto',
        },
        'system': {
            'ecutwfc': 60.0,
            'ecutrho': 600.0,  # é…¸åŒ–ç‰©ã¯é«˜ã„ã‚«ãƒƒãƒˆã‚ªãƒ•å¿…è¦
            'occupations': 'fixed',
        },
        'electrons': {
            'conv_thr': 1.0e-9,
        },
        'ions': {
            'ion_dynamics': 'bfgs',
        },
        'cell': {
            'cell_dynamics': 'bfgs',
        }
    },
    kpts=(8, 8, 8),
)

bto_tetra.calc = calc_relax
energy_relax = bto_tetra.get_potential_energy()
optimized_cell = bto_tetra.get_cell()

print(f"âœ… æ§‹é€ æœ€é©åŒ–å®Œäº†")
print(f"  æœ€é©åŒ–å¾Œæ ¼å­å®šæ•°: a = {optimized_cell[0][0]:.4f} Ã…, c = {optimized_cell[2][2]:.4f} Ã…")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—2ï¼šèª˜é›»å®šæ•°è¨ˆç®—ï¼ˆDFPTï¼‰
# =====================================
print("\nã‚¹ãƒ†ãƒƒãƒ—2ï¼šèª˜é›»å®šæ•°è¨ˆç®—ï¼ˆDFPT: å¯†åº¦æ±é–¢æ•°æ‘‚å‹•è«–ï¼‰...")

# ph.xã®å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
ph_input = """
 &inputph
   prefix = 'bto'
   tr2_ph = 1.0d-14
   epsil = .true.
   zeu = .true.
   ldisp = .false.
   qplot = .false.
 /
 0.0 0.0 0.0
"""

with open('ph_epsilon.in', 'w') as f:
    f.write(ph_input)

print("âœ… ph.xå…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: ph_epsilon.in")
print("  æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œ: ph.x < ph_epsilon.in > ph_epsilon.out")
print("  å‡ºåŠ›ã‹ã‚‰èª˜é›»ãƒ†ãƒ³ã‚½ãƒ«ã¨Bornæœ‰åŠ¹é›»è·ã‚’å–å¾—")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—3ï¼šçµæœè§£æï¼ˆä¾‹ç¤ºï¼‰
# =====================================
# å®Ÿéš›ã®è¨ˆç®—çµæœã‹ã‚‰èª­ã¿å–ã‚‹æƒ³å®š

print("\nğŸ“Š BaTiOâ‚ƒèª˜é›»ç‰¹æ€§ï¼ˆè¨ˆç®—çµæœä¾‹ï¼‰:")

# é›»å­èª˜é›»ç‡ï¼ˆé«˜å‘¨æ³¢ï¼‰
epsilon_inf = np.array([
    [6.5, 0.0, 0.0],
    [0.0, 6.5, 0.0],
    [0.0, 0.0, 6.8]
])

print("\n1. é›»å­èª˜é›»ç‡ Îµâˆï¼ˆå…‰å­¦èª˜é›»ç‡ï¼‰:")
print(f"  Îµâˆ_âŠ¥ï¼ˆaè»¸æ–¹å‘ï¼‰: {epsilon_inf[0,0]:.2f}")
print(f"  Îµâˆ_âˆ¥ï¼ˆcè»¸æ–¹å‘ï¼‰: {epsilon_inf[2,2]:.2f}")

# ã‚¤ã‚ªãƒ³èª˜é›»ç‡å¯„ä¸ï¼ˆæ ¼å­æŒ¯å‹•ï¼‰
epsilon_ionic = np.array([
    [150, 0, 0],
    [0, 150, 0],
    [0, 0, 200]
])

print("\n2. ã‚¤ã‚ªãƒ³èª˜é›»ç‡å¯„ä¸ Î”Îµï¼ˆæ ¼å­æŒ¯å‹•ï¼‰:")
print(f"  Î”Îµ_âŠ¥: {epsilon_ionic[0,0]:.0f}")
print(f"  Î”Îµ_âˆ¥: {epsilon_ionic[2,2]:.0f}")

# é™èª˜é›»ç‡
epsilon_static = epsilon_inf + epsilon_ionic
print("\n3. é™èª˜é›»ç‡ Îµâ‚€:")
print(f"  Îµâ‚€_âŠ¥: {epsilon_static[0,0]:.0f}")
print(f"  Îµâ‚€_âˆ¥: {epsilon_static[2,2]:.0f}")
print(f"  å®Ÿé¨“å€¤ï¼ˆå®¤æ¸©ï¼‰: Îµâ‚€_âŠ¥ â‰ˆ 170, Îµâ‚€_âˆ¥ â‰ˆ 90")

# Bornæœ‰åŠ¹é›»è·
Z_Ti_star = 7.2  # eï¼ˆTiåŸå­ï¼‰
Z_O_star = -5.8  # eï¼ˆè»¸æ–¹å‘Oï¼‰

print(f"\n4. Bornæœ‰åŠ¹é›»è·:")
print(f"  Z*(Ti): +{Z_Ti_star:.2f} eï¼ˆåç›®ä¾¡æ•°: +4ï¼‰")
print(f"  Z*(O, axial): {Z_O_star:.2f} eï¼ˆåç›®ä¾¡æ•°: -2ï¼‰")
print(f"  â†’ å¼·ã„å…±æœ‰çµåˆæ€§ã‚’åæ˜ ")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—4ï¼šã‚½ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰è§£æ
# =====================================
print("\n5. ã‚½ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå¼·èª˜é›»ä¸å®‰å®šæ€§ï¼‰:")
omega_soft = 50  # cmâ»Â¹ï¼ˆÎ“ç‚¹ã®A1ãƒ¢ãƒ¼ãƒ‰ï¼‰
print(f"  A1ãƒ¢ãƒ¼ãƒ‰æŒ¯å‹•æ•°: {omega_soft:.0f} cmâ»Â¹")
print(f"  â†’ ç«‹æ–¹æ™¶ã§ã¯è™šæ•°æŒ¯å‹•æ•°ï¼ˆæ§‹é€ ä¸å®‰å®šï¼‰")
print(f"  â†’ æ­£æ–¹æ™¶ã§ã¯æ­£ã®æŒ¯å‹•æ•°ï¼ˆå®‰å®šï¼‰")

# =====================================
# ã‚¹ãƒ†ãƒƒãƒ—5ï¼šèª˜é›»ç‡ã®æ¸©åº¦ä¾å­˜æ€§ï¼ˆCurie-Weisså‰‡ï¼‰
# =====================================
T = np.linspace(130, 400, 100)  # K
T_c = 393  # Kï¼ˆã‚­ãƒ¥ãƒªãƒ¼æ¸©åº¦ï¼‰
C = 1.7e5  # Kï¼ˆCurieå®šæ•°ï¼‰

epsilon_para = epsilon_inf[0,0] + C / (T - T_c)  # å¸¸èª˜é›»ç›¸ï¼ˆT > Tcï¼‰

fig, ax = plt.subplots(figsize=(8, 6))
ax.plot(T, epsilon_para, 'r-', linewidth=2, label='Paraelectric phase (T > Tc)')
ax.axvline(x=T_c, color='k', linestyle='--', linewidth=2, label=f'Tc = {T_c} K')
ax.set_xlabel('Temperature (K)', fontsize=12)
ax.set_ylabel('Dielectric Constant Îµ', fontsize=12)
ax.set_title('BaTiOâ‚ƒ Temperature Dependence (Curie-Weiss Law)', fontsize=14)
ax.set_ylim(0, 10000)
ax.legend()
ax.grid(True, alpha=0.3)
plt.tight_layout()
plt.savefig('bto_curie_weiss.png', dpi=300)
print("\nâœ… èª˜é›»ç‡æ¸©åº¦ä¾å­˜æ€§ã‚°ãƒ©ãƒ•ä¿å­˜: bto_curie_weiss.png")
</pre></code>
        </div>

        <h2>6.6 åæŸãƒ†ã‚¹ãƒˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</h2>

        <p>ã™ã¹ã¦ã®ç‰©æ€§è¨ˆç®—ã§æœ€åˆã«å®Ÿæ–½ã™ã¹ãåæŸãƒ†ã‚¹ãƒˆã®å®Ÿè·µçš„ãªæ–¹æ³•ã‚’ã€è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦ç¤ºã—ã¾ã™ã€‚</p>

        <div class="code-block">
<strong>ã‚³ãƒ¼ãƒ‰ä¾‹9ï¼šæ±ç”¨åæŸãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ</strong>
<code><pre>
"""
convergence_tester.py
ä»»æ„ã®ææ–™ã«å¯¾ã—ã¦kç‚¹ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•åæŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
"""

import numpy as np
import matplotlib.pyplot as plt
from ase.calculators.espresso import Espresso
from typing import List, Tuple, Dict
import json

class ConvergenceTester:
    """DFTè¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åæŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚¯ãƒ©ã‚¹"""

    def __init__(self, atoms, pseudopotentials, threshold_meV=1.0):
        """
        Parameters
        ----------
        atoms : ase.Atoms
            ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®åŸå­æ§‹é€ 
        pseudopotentials : dict
            æ“¬ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«è¾æ›¸ {'å…ƒç´ ': 'ãƒ•ã‚¡ã‚¤ãƒ«å'}
        threshold_meV : float
            åæŸåˆ¤å®šé–¾å€¤ï¼ˆmeV/atomï¼‰
        """
        self.atoms = atoms
        self.pseudopotentials = pseudopotentials
        self.threshold = threshold_meV / 1000  # eV/atomã«å¤‰æ›
        self.results = {}

    def test_kpoints(self,
                     kpts_list: List[int],
                     ecutwfc: float,
                     base_input: Dict = None) -> Tuple[List[float], Dict]:
        """
        kç‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã®åæŸãƒ†ã‚¹ãƒˆ

        Parameters
        ----------
        kpts_list : List[int]
            ãƒ†ã‚¹ãƒˆã™ã‚‹kç‚¹ãƒªã‚¹ãƒˆï¼ˆä¾‹: [4, 6, 8, 10, 12]ï¼‰
        ecutwfc : float
            å›ºå®šã™ã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•ï¼ˆRyï¼‰
        base_input : Dict
            è¿½åŠ ã®è¨ˆç®—è¨­å®š

        Returns
        -------
        energies : List[float]
            å„kç‚¹ã§ã®å…¨ã‚¨ãƒãƒ«ã‚®ãƒ¼
        convergence_info : Dict
            åæŸæƒ…å ±
        """
        print(f"\n{'='*60}")
        print(f"kç‚¹åæŸãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆecutwfc = {ecutwfc} Ry å›ºå®šï¼‰")
        print(f"{'='*60}")

        if base_input is None:
            base_input = {
                'control': {'calculation': 'scf'},
                'system': {'ecutwfc': ecutwfc},
                'electrons': {'conv_thr': 1.0e-8},
            }
        else:
            base_input['system']['ecutwfc'] = ecutwfc

        energies = []
        for k in kpts_list:
            calc = Espresso(
                pseudopotentials=self.pseudopotentials,
                input_data=base_input,
                kpts=(k, k, k),
            )
            self.atoms.calc = calc
            energy = self.atoms.get_potential_energy()
            energies.append(energy)
            print(f"  k = {k:2d}Ã—{k:2d}Ã—{k:2d}: E = {energy:12.6f} eV")

        # åæŸåˆ¤å®š
        converged_idx = self._check_convergence(energies)
        optimal_k = kpts_list[converged_idx] if converged_idx is not None else kpts_list[-1]

        convergence_info = {
            'converged': converged_idx is not None,
            'optimal_k': optimal_k,
            'threshold_meV': self.threshold * 1000,
            'final_energy': energies[-1],
        }

        print(f"\nğŸ“Š åæŸåˆ¤å®š:")
        if converged_idx is not None:
            print(f"  âœ… åæŸé”æˆ: k = {optimal_k}")
        else:
            print(f"  âš ï¸ æœªåæŸ: ã‚ˆã‚Šå¯†ãªkç‚¹ãŒå¿…è¦")

        self.results['kpoints'] = {
            'kpts_list': kpts_list,
            'energies': energies,
            'convergence_info': convergence_info
        }

        return energies, convergence_info

    def test_ecutwfc(self,
                     ecutwfc_list: List[float],
                     kpts: Tuple[int, int, int],
                     base_input: Dict = None) -> Tuple[List[float], Dict]:
        """
        ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•ã®åæŸãƒ†ã‚¹ãƒˆ

        Parameters
        ----------
        ecutwfc_list : List[float]
            ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚«ãƒƒãƒˆã‚ªãƒ•ãƒªã‚¹ãƒˆï¼ˆRyï¼‰
        kpts : Tuple[int, int, int]
            å›ºå®šã™ã‚‹kç‚¹ãƒ¡ãƒƒã‚·ãƒ¥
        base_input : Dict
            è¿½åŠ ã®è¨ˆç®—è¨­å®š

        Returns
        -------
        energies : List[float]
            å„ã‚«ãƒƒãƒˆã‚ªãƒ•ã§ã®å…¨ã‚¨ãƒãƒ«ã‚®ãƒ¼
        convergence_info : Dict
            åæŸæƒ…å ±
        """
        print(f"\n{'='*60}")
        print(f"ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•åæŸãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆkpts = {kpts} å›ºå®šï¼‰")
        print(f"{'='*60}")

        if base_input is None:
            base_input = {
                'control': {'calculation': 'scf'},
                'system': {},
                'electrons': {'conv_thr': 1.0e-8},
            }

        energies = []
        for ecut in ecutwfc_list:
            base_input['system']['ecutwfc'] = ecut
            calc = Espresso(
                pseudopotentials=self.pseudopotentials,
                input_data=base_input,
                kpts=kpts,
            )
            self.atoms.calc = calc
            energy = self.atoms.get_potential_energy()
            energies.append(energy)
            print(f"  ecutwfc = {ecut:5.1f} Ry: E = {energy:12.6f} eV")

        # åæŸåˆ¤å®š
        converged_idx = self._check_convergence(energies)
        optimal_ecut = ecutwfc_list[converged_idx] if converged_idx is not None else ecutwfc_list[-1]

        convergence_info = {
            'converged': converged_idx is not None,
            'optimal_ecutwfc': optimal_ecut,
            'threshold_meV': self.threshold * 1000,
            'final_energy': energies[-1],
        }

        print(f"\nğŸ“Š åæŸåˆ¤å®š:")
        if converged_idx is not None:
            print(f"  âœ… åæŸé”æˆ: ecutwfc = {optimal_ecut} Ry")
        else:
            print(f"  âš ï¸ æœªåæŸ: ã‚ˆã‚Šé«˜ã„ã‚«ãƒƒãƒˆã‚ªãƒ•ãŒå¿…è¦")

        self.results['ecutwfc'] = {
            'ecutwfc_list': ecutwfc_list,
            'energies': energies,
            'convergence_info': convergence_info
        }

        return energies, convergence_info

    def _check_convergence(self, energies: List[float]) -> int:
        """
        ã‚¨ãƒãƒ«ã‚®ãƒ¼å¤‰åŒ–ã‹ã‚‰åæŸã‚’åˆ¤å®š

        Returns
        -------
        converged_idx : int or None
            åæŸã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆNoneã¯æœªåæŸï¼‰
        """
        n_atoms = len(self.atoms)
        for i in range(1, len(energies)):
            delta = abs(energies[i] - energies[i-1]) / n_atoms
            if delta < self.threshold:
                return i
        return None

    def plot_results(self, filename='convergence_tests.png'):
        """åæŸãƒ†ã‚¹ãƒˆçµæœã®ãƒ—ãƒ­ãƒƒãƒˆ"""
        fig, axes = plt.subplots(1, 2, figsize=(14, 5))

        # kç‚¹åæŸ
        if 'kpoints' in self.results:
            data = self.results['kpoints']
            ax = axes[0]
            ax.plot(data['kpts_list'], data['energies'], 'o-',
                   linewidth=2, markersize=8, label='Calculated')
            if data['convergence_info']['converged']:
                opt_k = data['convergence_info']['optimal_k']
                ax.axvline(x=opt_k, color='r', linestyle='--',
                          label=f'Converged: {opt_k}')
            ax.set_xlabel('k-points (kÃ—kÃ—k)', fontsize=12)
            ax.set_ylabel('Total Energy (eV)', fontsize=12)
            ax.set_title('k-point Convergence', fontsize=14)
            ax.grid(True, alpha=0.3)
            ax.legend()

        # ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•åæŸ
        if 'ecutwfc' in self.results:
            data = self.results['ecutwfc']
            ax = axes[1]
            ax.plot(data['ecutwfc_list'], data['energies'], 's-',
                   linewidth=2, markersize=8, label='Calculated')
            if data['convergence_info']['converged']:
                opt_ecut = data['convergence_info']['optimal_ecutwfc']
                ax.axvline(x=opt_ecut, color='r', linestyle='--',
                          label=f'Converged: {opt_ecut} Ry')
            ax.set_xlabel('Energy Cutoff (Ry)', fontsize=12)
            ax.set_ylabel('Total Energy (eV)', fontsize=12)
            ax.set_title('Energy Cutoff Convergence', fontsize=14)
            ax.grid(True, alpha=0.3)
            ax.legend()

        plt.tight_layout()
        plt.savefig(filename, dpi=300)
        print(f"\nâœ… åæŸãƒ†ã‚¹ãƒˆã‚°ãƒ©ãƒ•ä¿å­˜: {filename}")

    def save_results(self, filename='convergence_results.json'):
        """çµæœã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""
        with open(filename, 'w') as f:
            json.dump(self.results, f, indent=2)
        print(f"âœ… åæŸãƒ†ã‚¹ãƒˆçµæœä¿å­˜: {filename}")


# =====================================
# ä½¿ç”¨ä¾‹
# =====================================
if __name__ == "__main__":
    from ase.build import bulk

    # Siçµæ™¶
    si = bulk('Si', 'diamond', a=5.43)
    pseudopotentials = {'Si': 'Si.pbe-n-rrkjus_psl.1.0.0.UPF'}

    # ãƒ†ã‚¹ã‚¿ãƒ¼åˆæœŸåŒ–
    tester = ConvergenceTester(si, pseudopotentials, threshold_meV=1.0)

    # kç‚¹ãƒ†ã‚¹ãƒˆ
    tester.test_kpoints(
        kpts_list=[4, 6, 8, 10, 12],
        ecutwfc=30.0
    )

    # ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•ãƒ†ã‚¹ãƒˆ
    tester.test_ecutwfc(
        ecutwfc_list=[20, 25, 30, 35, 40, 45],
        kpts=(8, 8, 8)
    )

    # çµæœã®å¯è¦–åŒ–ã¨ä¿å­˜
    tester.plot_results('si_convergence.png')
    tester.save_results('si_convergence.json')

    print("\nğŸ‰ åæŸãƒ†ã‚¹ãƒˆå®Œäº†ï¼")
</pre></code>
        </div>

        <h2>6.7 ãƒãƒƒãƒè¨ˆç®—ã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è‡ªå‹•åŒ–</h2>

        <p>è¤‡æ•°ã®ææ–™ã‚„è¨ˆç®—æ¡ä»¶ã‚’ç³»çµ±çš„ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒãƒƒãƒå‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

        <div class="code-block">
<strong>ã‚³ãƒ¼ãƒ‰ä¾‹10ï¼šå®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ</strong>
<code><pre>
"""
materials_workflow_manager.py
è¤‡æ•°ææ–™ã®ç‰©æ€§è¨ˆç®—ã‚’è‡ªå‹•åŒ–ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
"""

import os
import json
import time
from pathlib import Path
from typing import List, Dict, Any
from datetime import datetime
from ase import Atoms
from ase.io import read, write
from ase.calculators.espresso import Espresso
import yaml

class MaterialsWorkflow:
    """ç‰©æ€§è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ """

    def __init__(self, config_file: str):
        """
        Parameters
        ----------
        config_file : str
            ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆYAMLå½¢å¼ï¼‰
        """
        with open(config_file, 'r') as f:
            self.config = yaml.safe_load(f)

        self.results_dir = Path(self.config['output_dir'])
        self.results_dir.mkdir(exist_ok=True)

        self.log_file = self.results_dir / 'workflow.log'
        self._log("ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–å®Œäº†")

    def run_workflow(self):
        """å…¨ææ–™ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ"""
        materials = self.config['materials']

        self._log(f"\n{'='*70}")
        self._log(f"ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œé–‹å§‹: {len(materials)}ææ–™")
        self._log(f"{'='*70}")

        results_summary = []

        for i, mat_config in enumerate(materials, 1):
            self._log(f"\n[{i}/{len(materials)}] {mat_config['name']} å‡¦ç†é–‹å§‹...")

            try:
                result = self._process_material(mat_config)
                results_summary.append(result)
                self._log(f"âœ… {mat_config['name']} å®Œäº†")
            except Exception as e:
                self._log(f"âŒ {mat_config['name']} ã‚¨ãƒ©ãƒ¼: {str(e)}")
                results_summary.append({
                    'name': mat_config['name'],
                    'status': 'failed',
                    'error': str(e)
                })

        # æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
        self._generate_report(results_summary)
        self._log("\nğŸ‰ å…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ï¼")

    def _process_material(self, mat_config: Dict) -> Dict:
        """å˜ä¸€ææ–™ã®å®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ"""
        mat_name = mat_config['name']
        mat_dir = self.results_dir / mat_name
        mat_dir.mkdir(exist_ok=True)

        result = {
            'name': mat_name,
            'status': 'running',
            'start_time': datetime.now().isoformat()
        }

        # ã‚¹ãƒ†ãƒƒãƒ—1ï¼šæ§‹é€ ä½œæˆ
        atoms = self._create_structure(mat_config)
        write(mat_dir / f'{mat_name}.cif', atoms)
        result['structure_created'] = True

        # ã‚¹ãƒ†ãƒƒãƒ—2ï¼šåæŸãƒ†ã‚¹ãƒˆï¼ˆè¨­å®šã§æœ‰åŠ¹ãªå ´åˆï¼‰
        if self.config.get('run_convergence_tests', True):
            conv_result = self._run_convergence_tests(atoms, mat_config, mat_dir)
            result['convergence'] = conv_result
            optimal_kpts = conv_result['optimal_kpts']
            optimal_ecutwfc = conv_result['optimal_ecutwfc']
        else:
            optimal_kpts = tuple(mat_config.get('kpts', [8, 8, 8]))
            optimal_ecutwfc = mat_config.get('ecutwfc', 40.0)

        # ã‚¹ãƒ†ãƒƒãƒ—3ï¼šç‰©æ€§è¨ˆç®—
        properties = mat_config.get('properties', ['scf', 'bands', 'dos'])
        result['properties'] = {}

        for prop in properties:
            self._log(f"  - {prop}è¨ˆç®—å®Ÿè¡Œä¸­...")
            prop_result = self._calculate_property(
                atoms, prop, mat_config,
                optimal_kpts, optimal_ecutwfc, mat_dir
            )
            result['properties'][prop] = prop_result

        # ã‚¹ãƒ†ãƒƒãƒ—4ï¼šå¾Œå‡¦ç†ã¨å¯è¦–åŒ–
        self._postprocess(atoms, result, mat_dir)

        result['status'] = 'completed'
        result['end_time'] = datetime.now().isoformat()

        # ææ–™ã”ã¨ã®çµæœä¿å­˜
        with open(mat_dir / 'results.json', 'w') as f:
            json.dump(result, f, indent=2)

        return result

    def _create_structure(self, mat_config: Dict) -> Atoms:
        """çµæ™¶æ§‹é€ ä½œæˆ"""
        if 'structure_file' in mat_config:
            return read(mat_config['structure_file'])

        # çµ„ã¿è¾¼ã¿æ§‹é€ ç”Ÿæˆ
        from ase.build import bulk
        name = mat_config['formula']
        crystal_type = mat_config.get('crystal_type', 'fcc')
        lattice_constant = mat_config.get('lattice_constant', 4.0)

        return bulk(name, crystal_type, a=lattice_constant)

    def _run_convergence_tests(self, atoms: Atoms,
                                mat_config: Dict,
                                output_dir: Path) -> Dict:
        """åæŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
        from convergence_tester import ConvergenceTester

        pseudopotentials = mat_config['pseudopotentials']
        tester = ConvergenceTester(atoms, pseudopotentials, threshold_meV=1.0)

        # kç‚¹ãƒ†ã‚¹ãƒˆ
        kpts_range = mat_config.get('kpts_test_range', [4, 6, 8, 10, 12])
        ecutwfc_test = mat_config.get('ecutwfc_test', 30.0)
        tester.test_kpoints(kpts_range, ecutwfc_test)

        # ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•ãƒ†ã‚¹ãƒˆ
        ecutwfc_range = mat_config.get('ecutwfc_test_range', [20, 30, 40, 50])
        kpts_test = tuple(mat_config.get('kpts_test', [8, 8, 8]))
        tester.test_ecutwfc(ecutwfc_range, kpts_test)

        # çµæœä¿å­˜
        tester.plot_results(str(output_dir / 'convergence.png'))
        tester.save_results(str(output_dir / 'convergence.json'))

        return {
            'optimal_kpts': tuple([tester.results['kpoints']['convergence_info']['optimal_k']] * 3),
            'optimal_ecutwfc': tester.results['ecutwfc']['convergence_info']['optimal_ecutwfc']
        }

    def _calculate_property(self, atoms: Atoms,
                           property_type: str,
                           mat_config: Dict,
                           kpts: tuple,
                           ecutwfc: float,
                           output_dir: Path) -> Dict:
        """æŒ‡å®šã•ã‚ŒãŸç‰©æ€§ã‚’è¨ˆç®—"""
        pseudopotentials = mat_config['pseudopotentials']

        # ç‰©æ€§ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè¨ˆç®—è¨­å®š
        if property_type == 'scf':
            return self._run_scf(atoms, pseudopotentials, kpts, ecutwfc, output_dir)

        elif property_type == 'bands':
            return self._run_bands(atoms, pseudopotentials, kpts, ecutwfc, output_dir)

        elif property_type == 'dos':
            return self._run_dos(atoms, pseudopotentials, kpts, ecutwfc, output_dir)

        elif property_type == 'optical':
            return self._run_optical(atoms, pseudopotentials, kpts, ecutwfc, output_dir)

        elif property_type == 'magnetic':
            return self._run_magnetic(atoms, pseudopotentials, kpts, ecutwfc, output_dir)

        else:
            raise ValueError(f"æœªå¯¾å¿œã®ç‰©æ€§ã‚¿ã‚¤ãƒ—: {property_type}")

    def _run_scf(self, atoms, pseudopotentials, kpts, ecutwfc, output_dir):
        """SCFè¨ˆç®—"""
        calc = Espresso(
            pseudopotentials=pseudopotentials,
            input_data={
                'control': {'calculation': 'scf', 'prefix': 'scf'},
                'system': {'ecutwfc': ecutwfc},
                'electrons': {'conv_thr': 1.0e-8},
            },
            kpts=kpts,
        )
        atoms.calc = calc
        energy = atoms.get_potential_energy()
        forces = atoms.get_forces()

        return {
            'energy': energy,
            'energy_per_atom': energy / len(atoms),
            'max_force': float(np.max(np.abs(forces))),
        }

    def _run_bands(self, atoms, pseudopotentials, kpts, ecutwfc, output_dir):
        """ãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—"""
        # å®Ÿè£…ã¯ç°¡ç•¥åŒ–ï¼ˆå®Ÿéš›ã¯ã‚³ãƒ¼ãƒ‰ä¾‹3ã«æº–æ‹ ï¼‰
        return {'status': 'completed', 'output': 'bands.dat'}

    def _run_dos(self, atoms, pseudopotentials, kpts, ecutwfc, output_dir):
        """çŠ¶æ…‹å¯†åº¦è¨ˆç®—"""
        return {'status': 'completed', 'output': 'dos.dat'}

    def _run_optical(self, atoms, pseudopotentials, kpts, ecutwfc, output_dir):
        """å…‰å­¦ç‰¹æ€§è¨ˆç®—"""
        return {'status': 'completed', 'output': 'epsilon.dat'}

    def _run_magnetic(self, atoms, pseudopotentials, kpts, ecutwfc, output_dir):
        """ç£æ°—ç‰¹æ€§è¨ˆç®—"""
        return {'status': 'completed', 'magnetization': 2.15}

    def _postprocess(self, atoms: Atoms, result: Dict, output_dir: Path):
        """çµæœã®å¾Œå‡¦ç†ã¨å¯è¦–åŒ–"""
        # ãƒ—ãƒ­ãƒƒãƒˆç”Ÿæˆãªã©ã®å¾Œå‡¦ç†
        pass

    def _generate_report(self, results_summary: List[Dict]):
        """æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"""
        report_file = self.results_dir / 'workflow_report.md'

        with open(report_file, 'w') as f:
            f.write("# ç‰©æ€§è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ\n\n")
            f.write(f"å®Ÿè¡Œæ—¥æ™‚: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")

            f.write("## å®Ÿè¡Œã‚µãƒãƒªãƒ¼\n\n")
            total = len(results_summary)
            completed = sum(1 for r in results_summary if r['status'] == 'completed')
            failed = total - completed

            f.write(f"- ç·ææ–™æ•°: {total}\n")
            f.write(f"- æˆåŠŸ: {completed}\n")
            f.write(f"- å¤±æ•—: {failed}\n\n")

            f.write("## ææ–™åˆ¥è©³ç´°\n\n")
            for result in results_summary:
                f.write(f"### {result['name']}\n\n")
                f.write(f"- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {result['status']}\n")
                if 'properties' in result:
                    f.write(f"- è¨ˆç®—ç‰©æ€§: {', '.join(result['properties'].keys())}\n")
                if 'error' in result:
                    f.write(f"- ã‚¨ãƒ©ãƒ¼: {result['error']}\n")
                f.write("\n")

        self._log(f"\nâœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: {report_file}")

    def _log(self, message: str):
        """ãƒ­ã‚°å‡ºåŠ›"""
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        log_message = f"[{timestamp}] {message}"
        print(log_message)

        with open(self.log_file, 'a') as f:
            f.write(log_message + '\n')


# =====================================
# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¾‹ï¼ˆworkflow_config.yamlï¼‰
# =====================================
example_config = """
output_dir: ./workflow_results
run_convergence_tests: true

materials:
  - name: Si
    formula: Si
    crystal_type: diamond
    lattice_constant: 5.43
    pseudopotentials:
      Si: Si.pbe-n-rrkjus_psl.1.0.0.UPF
    properties: [scf, bands, dos]
    kpts_test_range: [4, 6, 8, 10]
    ecutwfc_test_range: [25, 30, 35, 40]

  - name: GaN
    formula: GaN
    structure_file: gan_wurtzite.cif
    pseudopotentials:
      Ga: Ga.pbe-dnl-rrkjus_psl.1.0.0.UPF
      N: N.pbe-n-radius_5.UPF
    properties: [scf, bands, optical]
    kpts: [12, 12, 8]
    ecutwfc: 50.0

  - name: Fe
    formula: Fe
    crystal_type: bcc
    lattice_constant: 2.87
    pseudopotentials:
      Fe: Fe.pbe-spn-rrkjus_psl.1.0.0.UPF
    properties: [scf, magnetic]
    kpts: [16, 16, 16]
    ecutwfc: 60.0
"""

# ä½¿ç”¨ä¾‹
if __name__ == "__main__":
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    with open('workflow_config.yaml', 'w') as f:
        f.write(example_config)

    # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
    workflow = MaterialsWorkflow('workflow_config.yaml')
    workflow.run_workflow()
</pre></code>
        </div>

        <h2>6.8 ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•</h2>

        <div class="case-study">
            <h4>ã‚¨ãƒ©ãƒ¼1ï¼šSCFè¨ˆç®—ãŒåæŸã—ãªã„</h4>
            <p><strong>ç—‡çŠ¶</strong>ï¼šæœ€å¤§ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°ã‚’è¶…ãˆã¦ã‚‚ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚„é›»è·å¯†åº¦ãŒåæŸã—ãªã„</p>
            <p><strong>åŸå› ã¨å¯¾ç­–</strong>ï¼š</p>
            <ul>
                <li><strong>é‡‘å±ç³»</strong>ï¼šsmearingãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆdegaussï¼‰ã‚’èª¿æ•´ã€‚Marzari-Vanderbiltæ³•ã‚’è©¦ã™</li>
                <li><strong>ç£æ€§ä½“</strong>ï¼šmixing_betaã‚’å°ã•ãï¼ˆ0.1-0.3ï¼‰ã€starting_magnetizationã‚’é©åˆ‡ã«è¨­å®š</li>
                <li><strong>é…¸åŒ–ç‰©</strong>ï¼šHubbard Uè£œæ­£ã‚’è¿½åŠ ï¼ˆDFT+Uï¼‰</li>
                <li><strong>kç‚¹ä¸è¶³</strong>ï¼šã‚ˆã‚Šå¯†ãªkç‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨</li>
            </ul>
            <div class="code-block">
<code><pre>
# åæŸæ€§æ”¹å–„ã®è¨­å®šä¾‹
input_data = {
    'electrons': {
        'conv_thr': 1.0e-6,        # é–¾å€¤ã‚’ç·©ã‚ã‚‹ï¼ˆåˆæœŸæ®µéšï¼‰
        'mixing_beta': 0.2,         # æ··åˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å°ã•ã
        'mixing_mode': 'local-TF',  # ThomasFermiæ··åˆ
        'diagonalization': 'david', # Davidsonæ³•ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        'electron_maxstep': 200,    # æœ€å¤§ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¢—åŠ 
    }
}
</pre></code>
            </div>
        </div>

        <div class="case-study">
            <h4>ã‚¨ãƒ©ãƒ¼2ï¼šãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—ãŒå®Ÿé¨“å€¤ã¨å¤§ããç•°ãªã‚‹</h4>
            <p><strong>ç—‡çŠ¶</strong>ï¼šGGAã§è¨ˆç®—ã—ãŸãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—ãŒå®Ÿé¨“å€¤ã‚ˆã‚Š0.5-1.0 eVå°ã•ã„</p>
            <p><strong>åŸå› ã¨å¯¾ç­–</strong>ï¼š</p>
            <ul>
                <li><strong>GGAã®ç³»çµ±èª¤å·®</strong>ï¼šãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ±é–¢æ•°ï¼ˆHSE06ï¼‰ã¾ãŸã¯GWè¿‘ä¼¼ã‚’ä½¿ç”¨</li>
                <li><strong>Scissorè£œæ­£</strong>ï¼šç°¡æ˜“çš„ãªè£œæ­£ã¨ã—ã¦ã€å®Ÿé¨“å€¤ã¨ã®å·®åˆ†ã‚’CBMå…¨ä½“ã«ã‚·ãƒ•ãƒˆ</li>
                <li><strong>ã‚¹ãƒ”ãƒ³è»Œé“ç›¸äº’ä½œç”¨</strong>ï¼šé‡å…ƒç´ ç³»ã§ã¯å¿…é ˆï¼ˆlspinorb=.true.ï¼‰</li>
            </ul>
            <div class="code-block">
<code><pre>
# HSE06ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ±é–¢æ•°ã®è¨­å®šä¾‹
input_data = {
    'system': {
        'input_dft': 'hse',
        'exxdiv_treatment': 'gygi-baldereschi',
        'x_gamma_extrapolation': True,
        'ecutvcut': 0.7,  # ã‚«ãƒƒãƒˆã‚ªãƒ•ï¼ˆRyï¼‰
    }
}
# æ³¨æ„ï¼šHSEè¨ˆç®—ã¯GGAã®ç´„10å€ã®è¨ˆç®—ã‚³ã‚¹ãƒˆ
</pre></code>
            </div>
        </div>

        <div class="case-study">
            <h4>ã‚¨ãƒ©ãƒ¼3ï¼šãƒ¡ãƒ¢ãƒªä¸è¶³ã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥</h4>
            <p><strong>ç—‡çŠ¶</strong>ï¼šå¤§ããªç³»ã‚„å¯†ãªkç‚¹ã§ãƒ¡ãƒ¢ãƒªã‚¨ãƒ©ãƒ¼</p>
            <p><strong>å¯¾ç­–</strong>ï¼š</p>
            <ul>
                <li><strong>ä¸¦åˆ—åŒ–</strong>ï¼šMPIä¸¦åˆ—æ•°ã¨ãƒ—ãƒ­ã‚»ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æœ€é©åŒ–</li>
                <li><strong>ãƒ¡ãƒ¢ãƒªå‰Šæ¸›</strong>ï¼šdisk_ioã‚’'low'ã«ã€wf_collectã‚’.false.ã«</li>
                <li><strong>æ®µéšçš„è¨ˆç®—</strong>ï¼šç²—ã„kç‚¹ã§åæŸå¾Œã€å¯†ãªkç‚¹ã§NSCF</li>
            </ul>
            <div class="code-block">
<code><pre>
# ãƒ¡ãƒ¢ãƒªå‰Šæ¸›è¨­å®š
input_data = {
    'control': {
        'disk_io': 'low',         # ãƒ‡ã‚£ã‚¹ã‚¯I/Oå‰Šæ¸›
        'wf_collect': False,      # æ³¢å‹•é–¢æ•°ã‚’åˆ†æ•£ä¿å­˜
    }
}

# å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ä¾‹ï¼ˆMPIä¸¦åˆ—ï¼‰
# mpirun -np 16 pw.x -nk 4 -nd 4 < input.in > output.out
# -nk: kç‚¹ä¸¦åˆ—åŒ–
# -nd: å¯¾è§’åŒ–ä¸¦åˆ—åŒ–
</pre></code>
            </div>
        </div>

        <div class="warning-box">
            <h4>âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®åŸºæœ¬åŸå‰‡</h4>
            <ol>
                <li><strong>å°ã•ã„ç³»ã§å‹•ä½œç¢ºèª</strong>ï¼šå˜ä½æ ¼å­ã§è¨­å®šã‚’ãƒ†ã‚¹ãƒˆå¾Œã€ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚»ãƒ«ã¸</li>
                <li><strong>æ®µéšçš„ã«å³å¯†åŒ–</strong>ï¼šç²—ã„è¨­å®šã§å‹•ä½œç¢ºèªâ†’åæŸè¨­å®šã¸</li>
                <li><strong>ãƒ­ã‚°ã‚’è©³ç´°ã«ç¢ºèª</strong>ï¼šã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ­£ç¢ºãªç†è§£</li>
                <li><strong>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«ç›¸è«‡</strong>ï¼šQuantum ESPRESSO forumã‚„Materials Projectã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’æ´»ç”¨</li>
            </ol>
        </div>

        <h2>6.9 æœ¬ç« ã®ã¾ã¨ã‚</h2>

        <p>æœ¬ç« ã§ã¯ã€4ç¨®é¡ã®ä»£è¡¨çš„ææ–™ï¼ˆSi, GaN, Fe, BaTiOâ‚ƒï¼‰ã‚’ä¾‹ã«ã€å®Ÿè·µçš„ãªç‰©æ€§è¨ˆç®—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Œå…¨ã«ç¿’å¾—ã—ã¾ã—ãŸã€‚</p>

        <div class="success-box">
            <h4>âœ… ç¿’å¾—ã—ãŸå®Ÿè·µã‚¹ã‚­ãƒ«</h4>
            <ul>
                <li><strong>æ§‹é€ ä½œæˆ</strong>ï¼šASEã‚’ç”¨ã„ãŸå¤šæ§˜ãªçµæ™¶æ§‹é€ ã®ä½œæˆã¨CIFå‡ºåŠ›</li>
                <li><strong>åæŸãƒ†ã‚¹ãƒˆ</strong>ï¼škç‚¹ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•ã®ç³»çµ±çš„æ±ºå®šæ³•</li>
                <li><strong>ç‰©æ€§è¨ˆç®—</strong>ï¼š
                    <ul>
                        <li>åŠå°ä½“ï¼šãƒãƒ³ãƒ‰æ§‹é€ ã€ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—</li>
                        <li>å…‰å­¦ï¼šèª˜é›»é–¢æ•°ã€å¸åã‚¹ãƒšã‚¯ãƒˆãƒ«</li>
                        <li>ç£æ€§ï¼šç£æ°—ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆã€ã‚¹ãƒ”ãƒ³åˆ†æ¥µDOS</li>
                        <li>èª˜é›»ï¼šèª˜é›»ç‡ã€åˆ†æ¥µã€ã‚½ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰</li>
                    </ul>
                </li>
                <li><strong>è‡ªå‹•åŒ–</strong>ï¼šãƒãƒƒãƒå‡¦ç†ã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </li>
                <li><strong>ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</strong>ï¼šã‚¨ãƒ©ãƒ¼è¨ºæ–­ã¨è§£æ±ºç­–ã®å®Ÿè£…</li>
            </ul>
        </div>

        <div class="info-box">
            <h4>ğŸ’¡ å®Ÿå‹™ã§ã®å¿œç”¨æŒ‡é‡</h4>
            <table>
                <tr>
                    <th>ç ”ç©¶ç›®çš„</th>
                    <th>æ¨å¥¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</th>
                    <th>è¨ˆç®—ã‚³ã‚¹ãƒˆ</th>
                </tr>
                <tr>
                    <td>ææ–™ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°</td>
                    <td>GGA-PBEã€ç²—ã‚ã®kç‚¹ã€ãƒãƒƒãƒå‡¦ç†</td>
                    <td>ä½ï¼ˆ1ææ–™ < 1æ™‚é–“ï¼‰</td>
                </tr>
                <tr>
                    <td>ç‰©æ€§äºˆæ¸¬</td>
                    <td>åæŸãƒ†ã‚¹ãƒˆæ¸ˆã¿GGAã€æ¨™æº–kç‚¹å¯†åº¦</td>
                    <td>ä¸­ï¼ˆ1ææ–™ æ•°æ™‚é–“ï¼‰</td>
                </tr>
                <tr>
                    <td>ç²¾å¯†ç‰©æ€§è©•ä¾¡</td>
                    <td>HSE06ã¾ãŸã¯GWã€å¯†ãªkç‚¹ã€SOCè€ƒæ…®</td>
                    <td>é«˜ï¼ˆ1ææ–™ 1-3æ—¥ï¼‰</td>
                </tr>
                <tr>
                    <td>è«–æ–‡ç™ºè¡¨ãƒ¬ãƒ™ãƒ«</td>
                    <td>è¤‡æ•°æ±é–¢æ•°æ¯”è¼ƒã€å®Ÿé¨“å€¤æ¤œè¨¼ã€ä¸ç¢ºå®Ÿæ€§è©•ä¾¡</td>
                    <td>æœ€é«˜ï¼ˆ1ææ–™ 1é€±é–“ï¼‰</td>
                </tr>
            </table>
        </div>

        <hr style="margin: 2rem 0; border: none; border-top: 2px solid var(--color-border);">

        <h2>ğŸ“ æ¼”ç¿’å•é¡Œ</h2>

        <div class="exercise">
            <h4>æ¼”ç¿’6-1ï¼šåŸºç¤ï¼ˆæ§‹é€ ä½œæˆã¨ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œï¼‰</h4>
            <p>ä»¥ä¸‹ã®ææ–™ã«ã¤ã„ã¦ã€ASEã§çµæ™¶æ§‹é€ ã‚’ä½œæˆã—ã€CIFãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ï¼š</p>
            <ol>
                <li>Cuï¼ˆFCCã€a = 3.61 Ã…ï¼‰</li>
                <li>NaClï¼ˆrocksaltã€a = 5.64 Ã…ï¼‰</li>
                <li>Diamondï¼ˆCã€a = 3.57 Ã…ï¼‰</li>
            </ol>
            <p>å„æ§‹é€ ã«ã¤ã„ã¦ã€æ ¼å­å®šæ•°ã€åŸå­æ•°ã€ç©ºé–“ç¾¤ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚</p>
        </div>

        <details>
            <summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>
            <div class="code-block">
<code><pre>
from ase.build import bulk
from ase.io import write
from ase.spacegroup import get_spacegroup

materials = [
    ('Cu', 'fcc', 3.61),
    ('NaCl', 'rocksalt', 5.64),
    ('C', 'diamond', 3.57)
]

for name, struct_type, a in materials:
    atoms = bulk(name, struct_type, a=a)

    print(f"\n{name} æ§‹é€ æƒ…å ±:")
    print(f"  æ ¼å­å®šæ•°: {a:.3f} Ã…")
    print(f"  åŸå­æ•°: {len(atoms)}")
    sg = get_spacegroup(atoms, symprec=1e-5)
    print(f"  ç©ºé–“ç¾¤: {sg.symbol} ({sg.no})")

    write(f'{name.lower()}_{struct_type}.cif', atoms)
    print(f"  âœ… ä¿å­˜å®Œäº†: {name.lower()}_{struct_type}.cif")
</pre></code>
            </div>
        </details>

        <div class="exercise">
            <h4>æ¼”ç¿’6-2ï¼šä¸­ç´šï¼ˆåæŸãƒ†ã‚¹ãƒˆã®å®Ÿè£…ï¼‰</h4>
            <p>Alï¼ˆFCCã€a = 4.05 Ã…ï¼‰ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®åæŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š</p>
            <ol>
                <li>kç‚¹åæŸãƒ†ã‚¹ãƒˆï¼š4, 8, 12, 16, 20 ã®å„ãƒ¡ãƒƒã‚·ãƒ¥ã§å…¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è¨ˆç®—</li>
                <li>ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•åæŸãƒ†ã‚¹ãƒˆï¼š20, 30, 40, 50, 60 Ry ã§è¨ˆç®—</li>
                <li>åæŸåˆ¤å®šï¼šé€£ç¶šã™ã‚‹ç‚¹ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼å·®ãŒ1 meV/atomä»¥ä¸‹</li>
                <li>çµæœã‚’ã‚°ãƒ©ãƒ•ã§å¯è¦–åŒ–ã—ã€æœ€é©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ±ºå®š</li>
            </ol>
            <p><strong>ãƒ’ãƒ³ãƒˆ</strong>ï¼šAlã¯é‡‘å±ãªã®ã§ã€smearingãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«è¨­å®šã™ã‚‹ã“ã¨ã€‚</p>
        </div>

        <details>
            <summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>
            <div class="code-block">
<code><pre>
from ase.build import bulk
from convergence_tester import ConvergenceTester

# Al FCCæ§‹é€ 
al = bulk('Al', 'fcc', a=4.05)

pseudopotentials = {'Al': 'Al.pbe-n-kjpaw_psl.1.0.0.UPF'}

# ãƒ†ã‚¹ã‚¿ãƒ¼åˆæœŸåŒ–
tester = ConvergenceTester(al, pseudopotentials, threshold_meV=1.0)

# é‡‘å±ç”¨ã®è¿½åŠ è¨­å®š
base_input = {
    'control': {'calculation': 'scf'},
    'system': {
        'occupations': 'smearing',
        'smearing': 'mv',  # Marzari-Vanderbilt
        'degauss': 0.02,
    },
    'electrons': {'conv_thr': 1.0e-8},
}

# kç‚¹ãƒ†ã‚¹ãƒˆ
tester.test_kpoints(
    kpts_list=[4, 8, 12, 16, 20],
    ecutwfc=30.0,
    base_input=base_input
)

# ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•ãƒ†ã‚¹ãƒˆ
tester.test_ecutwfc(
    ecutwfc_list=[20, 30, 40, 50, 60],
    kpts=(12, 12, 12),
    base_input=base_input
)

# çµæœå¯è¦–åŒ–
tester.plot_results('al_convergence.png')
tester.save_results('al_convergence.json')

print("\næœ€é©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:")
print(f"  kç‚¹: {tester.results['kpoints']['convergence_info']['optimal_k']}")
print(f"  ecutwfc: {tester.results['ecutwfc']['convergence_info']['optimal_ecutwfc']} Ry")
</pre></code>
            </div>
        </details>

        <div class="exercise">
            <h4>æ¼”ç¿’6-3ï¼šå¿œç”¨ï¼ˆå®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè£…ï¼‰</h4>
            <p>MgOï¼ˆrocksaltã€a = 4.21 Ã…ï¼‰ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®å®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š</p>
            <ol>
                <li>æ§‹é€ ä½œæˆã¨æœ€é©åŒ–</li>
                <li>åæŸãƒ†ã‚¹ãƒˆï¼ˆkç‚¹ã¨ecutï¼‰</li>
                <li>ãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—ï¼ˆFCCé«˜å¯¾ç§°ç‚¹ãƒ‘ã‚¹ï¼‰</li>
                <li>çŠ¶æ…‹å¯†åº¦ï¼ˆDOSï¼‰è¨ˆç®—</li>
                <li>ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—æ±ºå®šã¨å®Ÿé¨“å€¤ï¼ˆ7.8 eVï¼‰ã¨ã®æ¯”è¼ƒ</li>
                <li>å…¨çµæœã‚’çµ±åˆã—ãŸãƒ¬ãƒãƒ¼ãƒˆï¼ˆMarkdownï¼‰ã®è‡ªå‹•ç”Ÿæˆ</li>
            </ol>
            <p><strong>è©•ä¾¡åŸºæº–</strong>ï¼š</p>
            <ul>
                <li>ã™ã¹ã¦ã®è¨ˆç®—ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹ã“ã¨</li>
                <li>çµæœãŒé©åˆ‡ã«å¯è¦–åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨</li>
                <li>ãƒ¬ãƒãƒ¼ãƒˆã«è¨ˆç®—æ‰‹é †ã¨çµæœãŒæ˜ç¢ºã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨</li>
            </ul>
        </div>

        <details>
            <summary>è§£ç­”ä¾‹ã‚’è¦‹ã‚‹</summary>
            <div class="code-block">
<code><pre>
"""
MgOå®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
"""
from ase.build import bulk
from ase.io import write
from ase.calculators.espresso import Espresso
from ase.dft.kpoints import bandpath
import matplotlib.pyplot as plt
from datetime import datetime

# =====================================
# åˆæœŸåŒ–
# =====================================
report_lines = []
report_lines.append("# MgO ç‰©æ€§è¨ˆç®—ãƒ¬ãƒãƒ¼ãƒˆ\n")
report_lines.append(f"å®Ÿè¡Œæ—¥æ™‚: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")

# =====================================
# 1. æ§‹é€ ä½œæˆ
# =====================================
print("1. æ§‹é€ ä½œæˆ...")
mgo = bulk('MgO', 'rocksalt', a=4.21)
write('mgo.cif', mgo)

report_lines.append("## 1. çµæ™¶æ§‹é€ \n")
report_lines.append(f"- åŒ–å­¦å¼: MgO\n")
report_lines.append(f"- æ§‹é€ : rocksalt (NaClå‹)\n")
report_lines.append(f"- æ ¼å­å®šæ•°: {mgo.cell.cellpar()[0]:.3f} Ã…\n")
report_lines.append(f"- åŸå­æ•°: {len(mgo)}\n\n")

# =====================================
# 2. åæŸãƒ†ã‚¹ãƒˆ
# =====================================
print("2. åæŸãƒ†ã‚¹ãƒˆ...")
from convergence_tester import ConvergenceTester

pseudopotentials = {
    'Mg': 'Mg.pbe-spnl-kjpaw_psl.1.0.0.UPF',
    'O': 'O.pbe-n-kjpaw_psl.1.0.0.UPF'
}

tester = ConvergenceTester(mgo, pseudopotentials, threshold_meV=1.0)

tester.test_kpoints([4, 6, 8, 10, 12], ecutwfc=50.0)
tester.test_ecutwfc([40, 50, 60, 70], kpts=(8, 8, 8))
tester.plot_results('mgo_convergence.png')

optimal_k = tester.results['kpoints']['convergence_info']['optimal_k']
optimal_ecut = tester.results['ecutwfc']['convergence_info']['optimal_ecutwfc']

report_lines.append("## 2. åæŸãƒ†ã‚¹ãƒˆçµæœ\n")
report_lines.append(f"- æœ€é©kç‚¹: {optimal_k}Ã—{optimal_k}Ã—{optimal_k}\n")
report_lines.append(f"- æœ€é©ecutwfc: {optimal_ecut} Ry\n")
report_lines.append(f"- åæŸé–¾å€¤: 1 meV/atom\n\n")

# =====================================
# 3. ãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—
# =====================================
print("3. ãƒãƒ³ãƒ‰æ§‹é€ è¨ˆç®—...")

# SCF
calc_scf = Espresso(
    pseudopotentials=pseudopotentials,
    input_data={
        'control': {'calculation': 'scf', 'prefix': 'mgo'},
        'system': {'ecutwfc': optimal_ecut},
        'electrons': {'conv_thr': 1.0e-8},
    },
    kpts=(optimal_k, optimal_k, optimal_k),
)
mgo.calc = calc_scf
energy_scf = mgo.get_potential_energy()

# ãƒãƒ³ãƒ‰æ§‹é€ 
path = bandpath(['L', 'Gamma', 'X', 'W', 'K', 'Gamma'], mgo.cell, npoints=100)
calc_bands = Espresso(
    pseudopotentials=pseudopotentials,
    input_data={
        'control': {'calculation': 'bands', 'restart_mode': 'restart', 'prefix': 'mgo'},
        'system': {'ecutwfc': optimal_ecut},
    },
    kpts=path,
)
mgo.calc = calc_bands
bands = calc_bands.band_structure()

# ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—è¨ˆç®—
fermi = calc_bands.get_fermi_level()
energies = bands.energies
vbm = np.max(energies[energies < fermi])
cbm = np.min(energies[energies > fermi])
bandgap = cbm - vbm

report_lines.append("## 3. é›»å­æ§‹é€ \n")
report_lines.append(f"- ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—ï¼ˆè¨ˆç®—å€¤ï¼‰: {bandgap:.2f} eV\n")
report_lines.append(f"- ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—ï¼ˆå®Ÿé¨“å€¤ï¼‰: 7.8 eV\n")
report_lines.append(f"- èª¤å·®: {abs(bandgap - 7.8):.2f} eV ({abs(bandgap - 7.8)/7.8*100:.1f}%)\n")
report_lines.append(f"- æ³¨è¨˜: GGAæ±é–¢æ•°ã¯çµ¶ç¸ä½“ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’éå°è©•ä¾¡\n\n")

# ãƒãƒ³ãƒ‰æ§‹é€ ãƒ—ãƒ­ãƒƒãƒˆ
fig, ax = plt.subplots(figsize=(8, 6))
bands.plot(ax=ax, emin=-15, emax=15)
ax.axhline(y=0, color='k', linestyle='--')
ax.set_title(f'MgO Band Structure (Eg = {bandgap:.2f} eV)')
plt.savefig('mgo_bandstructure.png', dpi=300)

# =====================================
# 4. DOSè¨ˆç®—
# =====================================
print("4. DOSè¨ˆç®—...")
# ï¼ˆå®Ÿè£…ã¯çœç•¥ã€å®Ÿéš›ã¯projwfc.xã‚’ä½¿ç”¨ï¼‰

report_lines.append("## 4. çŠ¶æ…‹å¯†åº¦\n")
report_lines.append("- DOSã‚°ãƒ©ãƒ•: mgo_dos.png\n")
report_lines.append("- ä¾¡é›»å­å¸¯: ä¸»ã«O 2pè»Œé“\n")
report_lines.append("- ä¼å°å¸¯: Mg 3sè»Œé“ã¨O 2pè»Œé“ã®æ··æˆ\n\n")

# =====================================
# 5. ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
# =====================================
report_lines.append("## 5. è¨ˆç®—è¨­å®šã¾ã¨ã‚\n")
report_lines.append(f"- æ“¬ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«: PBE-PAW\n")
report_lines.append(f"- äº¤æ›ç›¸é–¢æ±é–¢æ•°: PBE (GGA)\n")
report_lines.append(f"- kç‚¹ãƒ¡ãƒƒã‚·ãƒ¥: {optimal_k}Ã—{optimal_k}Ã—{optimal_k}\n")
report_lines.append(f"- ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒƒãƒˆã‚ªãƒ•: {optimal_ecut} Ry\n")
report_lines.append(f"- åæŸé–¾å€¤: 1Ã—10â»â¸ Ry\n\n")

report_lines.append("## 6. çµè«–\n")
report_lines.append("MgOã®é›»å­æ§‹é€ è¨ˆç®—ã‚’å®Œäº†ã€‚ãƒ¯ã‚¤ãƒ‰ã‚®ãƒ£ãƒƒãƒ—çµ¶ç¸ä½“ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚\n")
report_lines.append("GGAæ±é–¢æ•°ã«ã‚ˆã‚‹ç³»çµ±çš„ãªãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—éå°è©•ä¾¡ãŒç¢ºèªã•ã‚ŒãŸã€‚\n")
report_lines.append("ã‚ˆã‚Šæ­£ç¢ºãªå€¤ã«ã¯HSE06ã¾ãŸã¯GWè¨ˆç®—ãŒå¿…è¦ã€‚\n")

with open('mgo_report.md', 'w') as f:
    f.writelines(report_lines)

print("\nâœ… å…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ï¼")
print("ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«:")
print("  - mgo.cif: çµæ™¶æ§‹é€ ")
print("  - mgo_convergence.png: åæŸãƒ†ã‚¹ãƒˆ")
print("  - mgo_bandstructure.png: ãƒãƒ³ãƒ‰æ§‹é€ ")
print("  - mgo_report.md: çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ")
</pre></code>
            </div>
        </details>

        <div class="exercise">
            <h4>æ¼”ç¿’6-4ï¼šç™ºå±•ï¼ˆã‚ªãƒªã‚¸ãƒŠãƒ«ææ–™ã®å®Œå…¨è§£æï¼‰</h4>
            <p>ã‚ãªãŸãŒèˆˆå‘³ã‚’æŒã¤ææ–™ï¼ˆæœªå­¦ç¿’ã®ææ–™ï¼‰ã‚’1ã¤é¸ã³ã€ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š</p>
            <ol>
                <li>æ–‡çŒ®èª¿æŸ»ï¼šçµæ™¶æ§‹é€ ã€æ ¼å­å®šæ•°ã€å®Ÿé¨“çš„ç‰©æ€§å€¤ã‚’èª¿æŸ»</li>
                <li>æ§‹é€ ä½œæˆï¼šæ­£ç¢ºãªåŸå­åº§æ¨™ã¨æ ¼å­å®šæ•°ã§çµæ™¶æ§‹é€ ã‚’ä½œæˆ</li>
                <li>è¨ˆç®—è¨­å®šæœ€é©åŒ–ï¼šææ–™ç‰¹æ€§ã«å¿œã˜ãŸè¨­å®šï¼ˆã‚¹ãƒ”ãƒ³ã€Uè£œæ­£ãªã©ï¼‰</li>
                <li>è¤‡æ•°ç‰©æ€§è¨ˆç®—ï¼šå°‘ãªãã¨ã‚‚3ç¨®é¡ã®ç‰©æ€§ï¼ˆä¾‹ï¼šbands, DOS, opticalï¼‰</li>
                <li>å®Ÿé¨“å€¤ã¨ã®æ¯”è¼ƒæ¤œè¨¼</li>
                <li>è¨ˆç®—ç²¾åº¦ã®è©•ä¾¡ã¨æ”¹å–„ææ¡ˆ</li>
                <li>åŒ…æ‹¬çš„ãªãƒ¬ãƒãƒ¼ãƒˆä½œæˆï¼ˆèƒŒæ™¯ã€æ‰‹æ³•ã€çµæœã€è€ƒå¯Ÿï¼‰</li>
            </ol>
            <p><strong>æå‡ºç‰©</strong>ï¼š</p>
            <ul>
                <li>å…¨è¨ˆç®—ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆå®Ÿè¡Œå¯èƒ½ãªçŠ¶æ…‹ï¼‰</li>
                <li>çµæœå¯è¦–åŒ–å›³ï¼ˆ3ã¤ä»¥ä¸Šï¼‰</li>
                <li>åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ3000å­—ä»¥ä¸Šã€è‹±èªå¯ï¼‰</li>
            </ul>
        </div>

        <details>
            <summary>è©•ä¾¡åŸºæº–ã¨ãƒ’ãƒ³ãƒˆ</summary>
            <div class="info-box">
                <h4>ğŸ“‹ è©•ä¾¡åŸºæº–</h4>
                <ul>
                    <li><strong>æ§‹é€ ä½œæˆï¼ˆ20ç‚¹ï¼‰</strong>ï¼šæ­£ç¢ºæ€§ã€å¯¾ç§°æ€§ç¢ºèªã€å¯è¦–åŒ–</li>
                    <li><strong>è¨ˆç®—è¨­å®šï¼ˆ25ç‚¹ï¼‰</strong>ï¼šåæŸãƒ†ã‚¹ãƒˆã€ææ–™ç‰¹æ€§ã¸ã®é…æ…®ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–</li>
                    <li><strong>ç‰©æ€§è¨ˆç®—ï¼ˆ30ç‚¹ï¼‰</strong>ï¼šè¤‡æ•°ç‰©æ€§ã®å®Ÿè£…ã€è¨ˆç®—ã®æ­£ç¢ºæ€§ã€ãƒ‡ãƒ¼ã‚¿æŠ½å‡º</li>
                    <li><strong>æ¤œè¨¼ã¨è€ƒå¯Ÿï¼ˆ15ç‚¹ï¼‰</strong>ï¼šå®Ÿé¨“å€¤æ¯”è¼ƒã€èª¤å·®åˆ†æã€æ”¹å–„ææ¡ˆ</li>
                    <li><strong>ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ10ç‚¹ï¼‰</strong>ï¼šè«–ç†æ€§ã€å›³è¡¨ã®è³ªã€å†ç¾æ€§</li>
                </ul>

                <h4>ğŸ’¡ æ¨å¥¨ææ–™ä¾‹</h4>
                <ul>
                    <li><strong>åŠå°ä½“</strong>ï¼šZnOï¼ˆã‚¦ãƒ«ãƒ„é‰±ï¼‰ã€InPï¼ˆé–ƒäºœé‰›é‰±ï¼‰</li>
                    <li><strong>é‡‘å±é…¸åŒ–ç‰©</strong>ï¼šTiOâ‚‚ï¼ˆãƒ«ãƒãƒ«/ã‚¢ãƒŠã‚¿ãƒ¼ã‚¼ï¼‰ã€Alâ‚‚Oâ‚ƒï¼ˆã‚³ãƒ©ãƒ³ãƒ€ãƒ ï¼‰</li>
                    <li><strong>å±¤çŠ¶ææ–™</strong>ï¼šMoSâ‚‚ã€graphite</li>
                    <li><strong>ãƒšãƒ­ãƒ–ã‚¹ã‚«ã‚¤ãƒˆ</strong>ï¼šSrTiOâ‚ƒã€LaAlOâ‚ƒ</li>
                </ul>
            </div>
        </details>

        <div class="nav-buttons">
            <a href="chapter-5.html" class="nav-button">â† ç¬¬5ç« ï¼šå…‰å­¦çš„ãƒ»ç†±çš„æ€§è³ª</a>
            <a href="index.html" class="nav-button">ç›®æ¬¡ã¸æˆ»ã‚‹ â†‘</a>
        </div>
    </div>
</body>
</html>
