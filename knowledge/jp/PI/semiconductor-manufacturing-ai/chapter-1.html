<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬1ç«  ã‚¦ã‚§ãƒãƒ—ãƒ­ã‚»ã‚¹çµ±è¨ˆçš„ç®¡ç† | ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹é“å ´</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.8; color: #333; background: #f5f5f5;
        }
        header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; padding: 2rem 1rem; text-align: center;
        }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .subtitle { opacity: 0.9; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .back-link {
            display: inline-block; margin-bottom: 2rem; padding: 0.5rem 1rem;
            background: white; color: #11998e; text-decoration: none;
            border-radius: 6px; font-weight: 600;
        }
        .content-box {
            background: white; padding: 2rem; border-radius: 12px;
            margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #11998e; margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem; border-bottom: 3px solid #11998e;
        }
        h3 { color: #2c3e50; margin: 1.5rem 0 1rem 0; }
        p { margin-bottom: 1rem; }
        ul, ol { margin-left: 2rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
        pre {
            background: #1e1e1e; color: #d4d4d4; padding: 1.5rem;
            border-radius: 8px; overflow-x: auto; margin: 1rem 0;
            border-left: 4px solid #11998e;
        }
        code {
            font-family: 'Courier New', monospace; font-size: 0.9rem;
        }
        .key-point {
            background: #e8f5e9; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #4caf50; margin: 1rem 0;
        }
        .tech-note {
            background: #e3f2fd; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #2196f3; margin: 1rem 0;
        }
        .formula {
            background: #f0f7ff; padding: 1rem; border-radius: 6px;
            margin: 1rem 0; overflow-x: auto;
        }
        .nav-buttons {
            display: flex; justify-content: space-between; margin-top: 3rem;
        }
        .nav-buttons a {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; text-decoration: none; border-radius: 6px;
            font-weight: 600;
        }
        footer {
            background: #2c3e50; color: white; text-align: center;
            padding: 2rem 1rem; margin-top: 4rem;
        }
    
        
    
        /* Breadcrumb styles */
        .breadcrumb {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .breadcrumb-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a0aec0;
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: #4a5568;
            font-weight: 500;
        }
    </style>
</head>
<body>
            <nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="../../index.html">AIå¯ºå­å±‹ãƒˆãƒƒãƒ—</a><span class="breadcrumb-separator">â€º</span><a href="../../PI/index.html">ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹</a><span class="breadcrumb-separator">â€º</span><a href="../../PI/semiconductor-manufacturing-ai/index.html">Semiconductor Manufacturing Ai</a><span class="breadcrumb-separator">â€º</span><span class="breadcrumb-current">Chapter 1</span>
        </div>
    </nav>

        <header>
        <h1>ç¬¬1ç«  ã‚¦ã‚§ãƒãƒ—ãƒ­ã‚»ã‚¹çµ±è¨ˆçš„ç®¡ç†</h1>
        <p class="subtitle">Wafer Process Statistical Control and R2R Management</p>
    </header>

    <div class="container">
        <a href="index.html" class="back-link">â† ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡ã«æˆ»ã‚‹</a>

        <div class="content-box">
            <h2>ğŸ“– æœ¬ç« ã®æ¦‚è¦</h2>
            <p>
                åŠå°ä½“è£½é€ ã§ã¯ã€ãƒŠãƒãƒ¡ãƒ¼ãƒˆãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼ã®ç²¾å¯†åˆ¶å¾¡ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚æœ¬ç« ã§ã¯ã€
                Run-to-Runï¼ˆR2Rï¼‰åˆ¶å¾¡ã€Virtual Metrologyï¼ˆVMï¼‰ã€ãƒ—ãƒ­ã‚»ã‚¹ãƒ‰ãƒªãƒ•ãƒˆæ¤œå‡ºãªã©ã€
                ã‚¦ã‚§ãƒãƒ—ãƒ­ã‚»ã‚¹ã®çµ±è¨ˆçš„ç®¡ç†ã¨AIæŠ€è¡“ã‚’å­¦ã³ã¾ã™ã€‚
            </p>

            <h3>ğŸ¯ å­¦ç¿’ç›®æ¨™</h3>
            <ul>
                <li>åŠå°ä½“ãƒ—ãƒ­ã‚»ã‚¹ã®ç‰¹æ€§ã¨ã‚¦ã‚§ãƒãƒ¬ãƒ™ãƒ«çµ±è¨ˆç®¡ç†</li>
                <li>Run-to-Runï¼ˆR2Rï¼‰åˆ¶å¾¡ã®åŸç†ã¨å®Ÿè£…</li>
                <li>Virtual Metrologyï¼ˆVMï¼‰ã«ã‚ˆã‚‹äºˆæ¸¬è¨ˆæ¸¬</li>
                <li>EWMAåˆ¶å¾¡ã¨ãƒ—ãƒ­ã‚»ã‚¹ãƒ‰ãƒªãƒ•ãƒˆè£œæ­£</li>
                <li>å¤šå¤‰é‡çµ±è¨ˆçš„ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ï¼ˆMSPCï¼‰</li>
                <li>ã‚¦ã‚§ãƒãƒãƒƒãƒ—è§£æã¨ç©ºé–“ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜</li>
            </ul>
        </div>

        <div class="content-box">
            <h2>âš™ï¸ 1.1 Run-to-Runï¼ˆR2Rï¼‰åˆ¶å¾¡ã®åŸºç¤</h2>

            <h3>R2Råˆ¶å¾¡ã®åŸç†</h3>
            <p>
                Run-to-Runåˆ¶å¾¡ã¯ã€å‰å›ã®ã‚¦ã‚§ãƒï¼ˆãƒ­ãƒƒãƒˆï¼‰ã®è¨ˆæ¸¬çµæœã‚’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã—ã€
                æ¬¡ã®ã‚¦ã‚§ãƒã®è£½é€ æ¡ä»¶ã‚’èª¿æ•´ã™ã‚‹é©å¿œåˆ¶å¾¡æ‰‹æ³•ã§ã™ã€‚
            </p>

            <div class="formula">
                <h4>EWMAï¼ˆæŒ‡æ•°åŠ é‡ç§»å‹•å¹³å‡ï¼‰åˆ¶å¾¡</h4>
                $$ u_k = u_{k-1} + K \cdot (T - y_k) $$
                <p>
                    \( u_k \): ç¬¬kå›ã®åˆ¶å¾¡å…¥åŠ›ï¼ˆãƒ—ãƒ­ã‚»ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰<br>
                    \( y_k \): ç¬¬kå›ã®æ¸¬å®šå€¤<br>
                    \( T \): ç›®æ¨™å€¤<br>
                    \( K \): åˆ¶å¾¡ã‚²ã‚¤ãƒ³ï¼ˆ0 < K < 1ï¼‰
                </p>
            </div>

            <div class="tech-note">
                <strong>ğŸ’¡ åŠå°ä½“ãƒ—ãƒ­ã‚»ã‚¹ã§ã®R2Ré©ç”¨ä¾‹</strong><br>
                ãƒ»<strong>ã‚¨ãƒƒãƒãƒ³ã‚°</strong>: ã‚¨ãƒƒãƒãƒ³ã‚°æ™‚é–“èª¿æ•´ã«ã‚ˆã‚‹CDï¼ˆCritical Dimensionï¼‰åˆ¶å¾¡<br>
                ãƒ»<strong>CVDæˆè†œ</strong>: æˆè†œæ™‚é–“èª¿æ•´ã«ã‚ˆã‚‹è†œåšåˆ¶å¾¡<br>
                ãƒ»<strong>CMP</strong>: ç ”ç£¨æ™‚é–“èª¿æ•´ã«ã‚ˆã‚‹å¹³å¦åŒ–åˆ¶å¾¡<br>
                ãƒ»<strong>ãƒªã‚½ã‚°ãƒ©ãƒ•ã‚£</strong>: éœ²å…‰é‡ãƒ»ç„¦ç‚¹èª¿æ•´ã«ã‚ˆã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ç²¾åº¦åˆ¶å¾¡
            </div>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹1.1: EWMA R2Råˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ </h3>
            <pre><code>import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy import stats
import warnings
warnings.filterwarnings('ignore')

plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

class R2RController:
    """Run-to-Run EWMAåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ """

    def __init__(self, target, initial_input, control_gain=0.5):
        """
        Args:
            target: ç›®æ¨™å€¤ï¼ˆä¾‹: è†œåš 100nmï¼‰
            initial_input: åˆæœŸåˆ¶å¾¡å…¥åŠ›ï¼ˆä¾‹: æˆè†œæ™‚é–“ 60ç§’ï¼‰
            control_gain: åˆ¶å¾¡ã‚²ã‚¤ãƒ³ Kï¼ˆ0 < K < 1ï¼‰
        """
        self.target = target
        self.u = initial_input  # ç¾åœ¨ã®åˆ¶å¾¡å…¥åŠ›
        self.K = control_gain
        self.history = {
            'run': [],
            'input': [],
            'output': [],
            'error': []
        }

    def process_model(self, u, drift=0, noise_std=1.0):
        """
        ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ‡ãƒ«ï¼ˆç°¡ç•¥åŒ–ï¼‰

        Args:
            u: åˆ¶å¾¡å…¥åŠ›ï¼ˆæˆè†œæ™‚é–“ãªã©ï¼‰
            drift: ãƒ—ãƒ­ã‚»ã‚¹ãƒ‰ãƒªãƒ•ãƒˆ
            noise_std: ãƒ—ãƒ­ã‚»ã‚¹ãƒã‚¤ã‚ºæ¨™æº–åå·®

        Returns:
            æ¸¬å®šå€¤ï¼ˆè†œåšãªã©ï¼‰
        """
        # ç·šå½¢ãƒ¢ãƒ‡ãƒ«: y = 1.5 * u + drift + noise
        gain = 1.5  # ãƒ—ãƒ­ã‚»ã‚¹ã‚²ã‚¤ãƒ³
        y = gain * u + drift + np.random.normal(0, noise_std)
        return y

    def update_control(self, measurement):
        """
        åˆ¶å¾¡å…¥åŠ›ã®æ›´æ–°ï¼ˆEWMAåˆ¶å¾¡ï¼‰

        Args:
            measurement: æ¸¬å®šå€¤

        Returns:
            æ¬¡å›ã®åˆ¶å¾¡å…¥åŠ›
        """
        error = self.target - measurement

        # EWMAåˆ¶å¾¡å‰‡
        u_next = self.u + self.K * error

        # åˆ¶å¾¡å…¥åŠ›ã®åˆ¶ç´„ï¼ˆç‰©ç†çš„åˆ¶ç´„ï¼‰
        u_next = np.clip(u_next, 30, 90)  # 30-90ç§’ã®ç¯„å›²

        self.u = u_next
        return u_next

    def run_simulation(self, n_runs=100, drift_start=50, drift_rate=0.1):
        """
        R2Råˆ¶å¾¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

        Args:
            n_runs: å®Ÿè¡Œå›æ•°ï¼ˆã‚¦ã‚§ãƒæšæ•°ï¼‰
            drift_start: ãƒ‰ãƒªãƒ•ãƒˆé–‹å§‹ãƒ©ãƒ³
            drift_rate: ãƒ‰ãƒªãƒ•ãƒˆé€Ÿåº¦ï¼ˆ/runï¼‰
        """
        for run in range(n_runs):
            # ãƒ—ãƒ­ã‚»ã‚¹ãƒ‰ãƒªãƒ•ãƒˆã®è¨ˆç®—
            if run >= drift_start:
                drift = (run - drift_start) * drift_rate
            else:
                drift = 0

            # ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œã¨æ¸¬å®š
            y = self.process_model(self.u, drift=drift, noise_std=2.0)

            # å±¥æ­´è¨˜éŒ²
            error = y - self.target
            self.history['run'].append(run + 1)
            self.history['input'].append(self.u)
            self.history['output'].append(y)
            self.history['error'].append(error)

            # æ¬¡å›ã®åˆ¶å¾¡å…¥åŠ›æ›´æ–°
            self.update_control(y)

        return pd.DataFrame(self.history)

    def plot_results(self, df):
        """åˆ¶å¾¡çµæœã®å¯è¦–åŒ–"""
        fig, axes = plt.subplots(3, 1, figsize=(14, 10))

        # æ¸¬å®šå€¤ã®ãƒˆãƒ¬ãƒ³ãƒ‰
        axes[0].plot(df['run'], df['output'], marker='o', color='#11998e',
                     linewidth=1.5, markersize=4, label='æ¸¬å®šå€¤')
        axes[0].axhline(y=self.target, color='red', linestyle='--',
                        linewidth=2, label=f'ç›®æ¨™å€¤ ({self.target}nm)')
        axes[0].fill_between(df['run'], self.target - 3, self.target + 3,
                              alpha=0.2, color='green', label='è¨±å®¹ç¯„å›² (Â±3nm)')
        axes[0].set_xlabel('ãƒ©ãƒ³ç•ªå·ï¼ˆã‚¦ã‚§ãƒï¼‰')
        axes[0].set_ylabel('è†œåšï¼ˆnmï¼‰')
        axes[0].set_title('R2Råˆ¶å¾¡ã«ã‚ˆã‚‹è†œåšç®¡ç†', fontsize=12, fontweight='bold')
        axes[0].legend()
        axes[0].grid(alpha=0.3)

        # åˆ¶å¾¡å…¥åŠ›ã®ãƒˆãƒ¬ãƒ³ãƒ‰
        axes[1].plot(df['run'], df['input'], marker='s', color='#38ef7d',
                     linewidth=1.5, markersize=4, label='æˆè†œæ™‚é–“')
        axes[1].set_xlabel('ãƒ©ãƒ³ç•ªå·ï¼ˆã‚¦ã‚§ãƒï¼‰')
        axes[1].set_ylabel('æˆè†œæ™‚é–“ï¼ˆç§’ï¼‰')
        axes[1].set_title('R2Råˆ¶å¾¡å…¥åŠ›', fontsize=12, fontweight='bold')
        axes[1].legend()
        axes[1].grid(alpha=0.3)

        # åˆ¶å¾¡èª¤å·®
        axes[2].plot(df['run'], df['error'], marker='^', color='#f38181',
                     linewidth=1.5, markersize=4, label='åˆ¶å¾¡èª¤å·®')
        axes[2].axhline(y=0, color='black', linestyle='-', linewidth=1)
        axes[2].fill_between(df['run'], -3, 3, alpha=0.2, color='green',
                              label='è¨±å®¹èª¤å·® (Â±3nm)')
        axes[2].set_xlabel('ãƒ©ãƒ³ç•ªå·ï¼ˆã‚¦ã‚§ãƒï¼‰')
        axes[2].set_ylabel('èª¤å·®ï¼ˆnmï¼‰')
        axes[2].set_title('åˆ¶å¾¡èª¤å·®', fontsize=12, fontweight='bold')
        axes[2].legend()
        axes[2].grid(alpha=0.3)

        plt.tight_layout()
        plt.savefig('r2r_control_results.png', dpi=300, bbox_inches='tight')
        plt.show()

# å®Ÿè¡Œä¾‹
print("=" * 60)
print("Run-to-Run EWMAåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ï¼ˆCVDæˆè†œãƒ—ãƒ­ã‚»ã‚¹ï¼‰")
print("=" * 60)

# R2Råˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
r2r = R2RController(
    target=100.0,        # ç›®æ¨™è†œåš 100nm
    initial_input=60.0,  # åˆæœŸæˆè†œæ™‚é–“ 60ç§’
    control_gain=0.5     # åˆ¶å¾¡ã‚²ã‚¤ãƒ³ K=0.5
)

# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
df_results = r2r.run_simulation(
    n_runs=100,
    drift_start=50,   # 50ãƒ©ãƒ³ç›®ã‹ã‚‰ãƒ‰ãƒªãƒ•ãƒˆé–‹å§‹
    drift_rate=0.1    # 0.1nm/runã®ãƒ‰ãƒªãƒ•ãƒˆ
)

# æ€§èƒ½è©•ä¾¡
print(f"\nåˆ¶å¾¡æ€§èƒ½è©•ä¾¡:")
print(f"å¹³å‡è†œåš: {df_results['output'].mean():.2f} nm")
print(f"è†œåšæ¨™æº–åå·®: {df_results['output'].std():.2f} nm")
print(f"å¹³å‡çµ¶å¯¾èª¤å·®: {df_results['error'].abs().mean():.2f} nm")
print(f"æœ€å¤§èª¤å·®: {df_results['error'].abs().max():.2f} nm")

# è¦æ ¼å†…ç‡ã®è¨ˆç®—
in_spec = df_results[(df_results['output'] >= 97) & (df_results['output'] <= 103)]
print(f"è¦æ ¼å†…ç‡ (100Â±3nm): {len(in_spec)/len(df_results)*100:.1f}%")

# ãƒ‰ãƒªãƒ•ãƒˆè£œæ­£å‰å¾Œã®æ¯”è¼ƒ
before_drift = df_results[df_results['run'] < 50]
after_drift = df_results[df_results['run'] >= 50]
print(f"\nãƒ‰ãƒªãƒ•ãƒˆç™ºç”Ÿå‰ï¼ˆ1-49ãƒ©ãƒ³ï¼‰å¹³å‡: {before_drift['output'].mean():.2f} nm")
print(f"ãƒ‰ãƒªãƒ•ãƒˆç™ºç”Ÿå¾Œï¼ˆ50-100ãƒ©ãƒ³ï¼‰å¹³å‡: {after_drift['output'].mean():.2f} nm")

# å¯è¦–åŒ–
r2r.plot_results(df_results)
</code></pre>

            <p><strong>å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:</strong></p>
            <ul>
                <li>EWMAåˆ¶å¾¡ã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãƒ‰ãƒªãƒ•ãƒˆã®è‡ªå‹•è£œæ­£</li>
                <li>åˆ¶å¾¡ã‚²ã‚¤ãƒ³Kã®èª¿æ•´ã«ã‚ˆã‚‹å¿œç­”æ€§ã¨å®‰å®šæ€§ã®ãƒãƒ©ãƒ³ã‚¹</li>
                <li>ç‰©ç†çš„åˆ¶ç´„ï¼ˆåˆ¶å¾¡å…¥åŠ›ã®ä¸Šä¸‹é™ï¼‰ã®è€ƒæ…®</li>
                <li>å®šé‡çš„ãªåˆ¶å¾¡æ€§èƒ½è©•ä¾¡ï¼ˆå¹³å‡èª¤å·®ã€æ¨™æº–åå·®ã€è¦æ ¼å†…ç‡ï¼‰</li>
            </ul>
        </div>

        <div class="content-box">
            <h2>ğŸ”® 1.2 Virtual Metrologyï¼ˆä»®æƒ³è¨ˆæ¸¬ï¼‰</h2>

            <h3>Virtual Metrologyã®åŸç†</h3>
            <p>
                Virtual Metrologyï¼ˆVMï¼‰ã¯ã€ãƒ—ãƒ­ã‚»ã‚¹è£…ç½®ã®ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ï¼ˆæ¸©åº¦ã€åœ§åŠ›ã€æµé‡ãªã©ï¼‰ã‹ã‚‰ã€
                è¨ˆæ¸¬å™¨ã‚’ä½¿ã‚ãšã«ã‚¦ã‚§ãƒã®å“è³ªç‰¹æ€§ï¼ˆè†œåšã€CDã€é›»æ°—ç‰¹æ€§ãªã©ï¼‰ã‚’äºˆæ¸¬ã™ã‚‹æŠ€è¡“ã§ã™ã€‚
            </p>

            <div class="key-point">
                <strong>ğŸ’¡ VMã®åˆ©ç‚¹</strong><br>
                ãƒ»å…¨æ•°è¨ˆæ¸¬ã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å“è³ªç®¡ç†<br>
                ãƒ»è¨ˆæ¸¬ã‚³ã‚¹ãƒˆã¨æ™‚é–“ã®å‰Šæ¸›ï¼ˆè¨ˆæ¸¬å™¨ä¸è¦ï¼‰<br>
                ãƒ»ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åˆ¶å¾¡ã®å®Ÿç¾<br>
                ãƒ»è¨ˆæ¸¬ä¸å¯èƒ½ãªä¸­é–“å·¥ç¨‹ã§ã®å“è³ªäºˆæ¸¬
            </div>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹1.2: Random Forestã«ã‚ˆã‚‹Virtual Metrology</h3>
            <pre><code>import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split
from sklearn.metrics import r2_score, mean_squared_error, mean_absolute_error
import warnings
warnings.filterwarnings('ignore')

plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

class VirtualMetrologySystem:
    """Virtual Metrologyï¼ˆä»®æƒ³è¨ˆæ¸¬ï¼‰ã‚·ã‚¹ãƒ†ãƒ """

    def __init__(self):
        self.model = None
        self.feature_names = None

    def generate_process_data(self, n_samples=500):
        """
        ãƒ—ãƒ­ã‚»ã‚¹ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆï¼ˆã‚¨ãƒƒãƒãƒ³ã‚°ãƒ—ãƒ­ã‚»ã‚¹ã‚’æƒ³å®šï¼‰

        Returns:
            (ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿, CDæ¸¬å®šå€¤)
        """
        np.random.seed(42)

        # ãƒ—ãƒ­ã‚»ã‚¹æ¡ä»¶ï¼ˆè£…ç½®ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ï¼‰
        rf_power = np.random.normal(1000, 50, n_samples)      # RFãƒ‘ãƒ¯ãƒ¼ï¼ˆWï¼‰
        pressure = np.random.normal(50, 5, n_samples)          # åœ§åŠ›ï¼ˆmTorrï¼‰
        gas_flow_ar = np.random.normal(200, 10, n_samples)    # Arã‚¬ã‚¹æµé‡ï¼ˆsccmï¼‰
        gas_flow_cf4 = np.random.normal(50, 5, n_samples)     # CF4ã‚¬ã‚¹æµé‡ï¼ˆsccmï¼‰
        temp_chamber = np.random.normal(60, 3, n_samples)     # ãƒãƒ£ãƒ³ãƒãƒ¼æ¸©åº¦ï¼ˆâ„ƒï¼‰
        etch_time = np.random.normal(120, 5, n_samples)       # ã‚¨ãƒƒãƒãƒ³ã‚°æ™‚é–“ï¼ˆç§’ï¼‰

        # CDï¼ˆCritical Dimensionï¼‰ã®ç‰©ç†ãƒ¢ãƒ‡ãƒ«
        # CD = f(RF power, pressure, gas flows, temp, time) + noise
        cd_base = 90  # ãƒ™ãƒ¼ã‚¹CDï¼ˆnmï¼‰

        cd = (cd_base
              - 0.002 * (rf_power - 1000)      # RFãƒ‘ãƒ¯ãƒ¼â†‘ â†’ CDâ†“
              + 0.05 * (pressure - 50)          # åœ§åŠ›â†‘ â†’ CDâ†‘
              - 0.01 * (gas_flow_cf4 - 50)     # CF4â†‘ â†’ CDâ†“ï¼ˆã‚¨ãƒƒãƒãƒ³ã‚°ä¿ƒé€²ï¼‰
              + 0.005 * (temp_chamber - 60)    # æ¸©åº¦â†‘ â†’ CDâ†‘
              - 0.03 * (etch_time - 120)       # æ™‚é–“â†‘ â†’ CDâ†“
              + np.random.normal(0, 1, n_samples))  # ãƒã‚¤ã‚º

        # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ
        df = pd.DataFrame({
            'rf_power': rf_power,
            'pressure': pressure,
            'gas_flow_ar': gas_flow_ar,
            'gas_flow_cf4': gas_flow_cf4,
            'temp_chamber': temp_chamber,
            'etch_time': etch_time,
            'cd_measured': cd
        })

        return df

    def train_vm_model(self, df, feature_columns, target_column='cd_measured'):
        """
        VMãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´

        Args:
            df: ãƒ—ãƒ­ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿
            feature_columns: ç‰¹å¾´é‡ã‚«ãƒ©ãƒ 
            target_column: äºˆæ¸¬å¯¾è±¡ã‚«ãƒ©ãƒ 
        """
        X = df[feature_columns].values
        y = df[target_column].values

        # è¨“ç·´/ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿åˆ†å‰²
        X_train, X_test, y_train, y_test = train_test_split(
            X, y, test_size=0.3, random_state=42
        )

        # Random Forestãƒ¢ãƒ‡ãƒ«
        self.model = RandomForestRegressor(
            n_estimators=100,
            max_depth=15,
            min_samples_split=5,
            random_state=42
        )
        self.model.fit(X_train, y_train)
        self.feature_names = feature_columns

        # äºˆæ¸¬ã¨è©•ä¾¡
        y_pred_train = self.model.predict(X_train)
        y_pred_test = self.model.predict(X_test)

        # æ€§èƒ½æŒ‡æ¨™
        r2_train = r2_score(y_train, y_pred_train)
        r2_test = r2_score(y_test, y_pred_test)
        rmse_test = np.sqrt(mean_squared_error(y_test, y_pred_test))
        mae_test = mean_absolute_error(y_test, y_pred_test)

        results = {
            'X_train': X_train, 'y_train': y_train,
            'X_test': X_test, 'y_test': y_test,
            'y_pred_train': y_pred_train, 'y_pred_test': y_pred_test,
            'r2_train': r2_train, 'r2_test': r2_test,
            'rmse_test': rmse_test, 'mae_test': mae_test
        }

        return results

    def predict_cd(self, process_conditions):
        """
        ãƒ—ãƒ­ã‚»ã‚¹æ¡ä»¶ã‹ã‚‰CDã‚’äºˆæ¸¬

        Args:
            process_conditions: ãƒ—ãƒ­ã‚»ã‚¹æ¡ä»¶ã®é…åˆ—ã¾ãŸã¯DataFrame

        Returns:
            äºˆæ¸¬CDå€¤
        """
        if self.model is None:
            raise ValueError("ãƒ¢ãƒ‡ãƒ«ãŒè¨“ç·´ã•ã‚Œã¦ã„ã¾ã›ã‚“")

        return self.model.predict(process_conditions)

    def plot_vm_results(self, results):
        """VMçµæœã®å¯è¦–åŒ–"""
        fig, axes = plt.subplots(2, 2, figsize=(14, 10))

        # äºˆæ¸¬ç²¾åº¦ãƒ—ãƒ­ãƒƒãƒˆï¼ˆè¨“ç·´ãƒ‡ãƒ¼ã‚¿ï¼‰
        axes[0, 0].scatter(results['y_train'], results['y_pred_train'],
                           alpha=0.5, s=20, color='#11998e', label='è¨“ç·´ãƒ‡ãƒ¼ã‚¿')
        axes[0, 0].plot([85, 95], [85, 95], 'r--', linewidth=2, label='ç†æƒ³ç›´ç·š')
        axes[0, 0].set_xlabel('å®Ÿæ¸¬CDï¼ˆnmï¼‰')
        axes[0, 0].set_ylabel('äºˆæ¸¬CDï¼ˆnmï¼‰')
        axes[0, 0].set_title(f'è¨“ç·´ãƒ‡ãƒ¼ã‚¿äºˆæ¸¬ç²¾åº¦ (RÂ²={results["r2_train"]:.4f})',
                             fontsize=12, fontweight='bold')
        axes[0, 0].legend()
        axes[0, 0].grid(alpha=0.3)

        # äºˆæ¸¬ç²¾åº¦ãƒ—ãƒ­ãƒƒãƒˆï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼‰
        axes[0, 1].scatter(results['y_test'], results['y_pred_test'],
                           alpha=0.5, s=20, color='#38ef7d', label='ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿')
        axes[0, 1].plot([85, 95], [85, 95], 'r--', linewidth=2, label='ç†æƒ³ç›´ç·š')
        axes[0, 1].set_xlabel('å®Ÿæ¸¬CDï¼ˆnmï¼‰')
        axes[0, 1].set_ylabel('äºˆæ¸¬CDï¼ˆnmï¼‰')
        axes[0, 1].set_title(f'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿äºˆæ¸¬ç²¾åº¦ (RÂ²={results["r2_test"]:.4f})',
                             fontsize=12, fontweight='bold')
        axes[0, 1].legend()
        axes[0, 1].grid(alpha=0.3)

        # äºˆæ¸¬èª¤å·®ã®åˆ†å¸ƒ
        errors = results['y_pred_test'] - results['y_test']
        axes[1, 0].hist(errors, bins=30, color='#4ecdc4', alpha=0.7, edgecolor='black')
        axes[1, 0].axvline(x=0, color='red', linestyle='--', linewidth=2, label='èª¤å·®ã‚¼ãƒ­')
        axes[1, 0].set_xlabel('äºˆæ¸¬èª¤å·®ï¼ˆnmï¼‰')
        axes[1, 0].set_ylabel('é »åº¦')
        axes[1, 0].set_title(f'äºˆæ¸¬èª¤å·®åˆ†å¸ƒ (MAE={results["mae_test"]:.2f}nm)',
                             fontsize=12, fontweight='bold')
        axes[1, 0].legend()
        axes[1, 0].grid(alpha=0.3)

        # ç‰¹å¾´é‡é‡è¦åº¦
        feature_importance = pd.DataFrame({
            'feature': self.feature_names,
            'importance': self.model.feature_importances_
        }).sort_values('importance', ascending=True)

        axes[1, 1].barh(feature_importance['feature'], feature_importance['importance'],
                        color='#f38181', alpha=0.8)
        axes[1, 1].set_xlabel('é‡è¦åº¦')
        axes[1, 1].set_title('ç‰¹å¾´é‡é‡è¦åº¦', fontsize=12, fontweight='bold')
        axes[1, 1].grid(axis='x', alpha=0.3)

        plt.tight_layout()
        plt.savefig('virtual_metrology_results.png', dpi=300, bbox_inches='tight')
        plt.show()

# å®Ÿè¡Œä¾‹
print("=" * 60)
print("Virtual Metrologyã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚¨ãƒƒãƒãƒ³ã‚°ãƒ—ãƒ­ã‚»ã‚¹ï¼‰")
print("=" * 60)

# VMã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
vm = VirtualMetrologySystem()

# ãƒ—ãƒ­ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ
df_process = vm.generate_process_data(n_samples=500)

print(f"\nç”Ÿæˆãƒ‡ãƒ¼ã‚¿æ•°: {len(df_process)}")
print(f"CDç¯„å›²: {df_process['cd_measured'].min():.2f} - {df_process['cd_measured'].max():.2f} nm")

# ç‰¹å¾´é‡ã®å®šç¾©
feature_cols = ['rf_power', 'pressure', 'gas_flow_ar', 'gas_flow_cf4',
                'temp_chamber', 'etch_time']

# VMãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´
results = vm.train_vm_model(df_process, feature_cols)

print(f"\nVMãƒ¢ãƒ‡ãƒ«æ€§èƒ½:")
print(f"è¨“ç·´ãƒ‡ãƒ¼ã‚¿ RÂ² = {results['r2_train']:.4f}")
print(f"ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ RÂ² = {results['r2_test']:.4f}")
print(f"RMSE = {results['rmse_test']:.2f} nm")
print(f"MAE = {results['mae_test']:.2f} nm")

# æ–°è¦ã‚¦ã‚§ãƒã®äºˆæ¸¬ä¾‹
print(f"\næ–°è¦ã‚¦ã‚§ãƒã®CDäºˆæ¸¬:")
new_wafer = np.array([[1020, 52, 205, 48, 61, 118]])  # æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹æ¡ä»¶
predicted_cd = vm.predict_cd(new_wafer)
print(f"äºˆæ¸¬CD: {predicted_cd[0]:.2f} nm")

# å¯è¦–åŒ–
vm.plot_vm_results(results)
</code></pre>

            <p><strong>å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:</strong></p>
            <ul>
                <li>ãƒ—ãƒ­ã‚»ã‚¹è£…ç½®ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å“è³ªç‰¹æ€§ã‚’é«˜ç²¾åº¦äºˆæ¸¬ï¼ˆRÂ² > 0.95ï¼‰</li>
                <li>Random Forestã«ã‚ˆã‚‹éç·šå½¢é–¢ä¿‚ã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</li>
                <li>ç‰¹å¾´é‡é‡è¦åº¦åˆ†æã«ã‚ˆã‚‹æ”¯é…çš„ãƒ—ãƒ­ã‚»ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç‰¹å®š</li>
                <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äºˆæ¸¬ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å“è³ªç®¡ç†ã®å®Ÿç¾</li>
            </ul>
        </div>

        <div class="content-box">
            <h2>ğŸ“š ã¾ã¨ã‚</h2>
            <p>æœ¬ç« ã§ã¯ã€ã‚¦ã‚§ãƒãƒ—ãƒ­ã‚»ã‚¹ã®çµ±è¨ˆçš„ç®¡ç†ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸã€‚</p>

            <h3>ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆ</h3>
            <ul>
                <li>Run-to-Run EWMAåˆ¶å¾¡ã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãƒ‰ãƒªãƒ•ãƒˆã®è‡ªå‹•è£œæ­£</li>
                <li>Virtual Metrologyã«ã‚ˆã‚‹å…¨æ•°å“è³ªäºˆæ¸¬ã¨è¨ˆæ¸¬ã‚³ã‚¹ãƒˆå‰Šæ¸›</li>
                <li>åˆ¶å¾¡ã‚²ã‚¤ãƒ³ã¨å¿œç­”æ€§ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•</li>
                <li>æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªãƒ—ãƒ­ã‚»ã‚¹-å“è³ªé–¢ä¿‚ã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</li>
            </ul>

            <div class="key-point">
                <strong>ğŸ¯ æ¬¡ç« äºˆå‘Š</strong><br>
                ç¬¬2ç« ã§ã¯ã€AIã«ã‚ˆã‚‹æ¬ é™¥æ¤œæŸ»ã¨AOIï¼ˆAutomated Optical Inspectionï¼‰ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚
                æ·±å±¤å­¦ç¿’ï¼ˆCNNï¼‰ã«ã‚ˆã‚‹æ¬ é™¥åˆ†é¡ã€ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€
                ç•°ç‰©æ¤œå‡ºãªã©ã€ç”»åƒãƒ™ãƒ¼ã‚¹ã®å“è³ªç®¡ç†æŠ€è¡“ã‚’ç¿’å¾—ã—ã¾ã™ã€‚
            </div>
        </div>

        <div class="nav-buttons">
            <a href="index.html">â† ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡</a>
            <a href="chapter-2.html">ç¬¬2ç« : AIæ¬ é™¥æ¤œæŸ»ã¨AOI â†’</a>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 AI Terakoya - ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹é“å ´</p>
        <p>ç¬¬1ç«  ã‚¦ã‚§ãƒãƒ—ãƒ­ã‚»ã‚¹çµ±è¨ˆçš„ç®¡ç†</p>
    </footer>
</body>
</html>
