<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç¬¬6ç« ï¼šå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã¨ã®çµ±åˆ - LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹é«˜åº¦ãªå”èª¿åˆ¶å¾¡ã¨ãƒ—ãƒ­ã‚»ã‚¹è¨ºæ–­">
    <title>ç¬¬6ç« ï¼šå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã¨ã®çµ±åˆ - AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè‡ªå¾‹é‹è»¢ | PI Terakoya</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.8; color: #333; background: #f5f5f5;
        }
        header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; padding: 2rem 1rem; text-align: center;
        }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .subtitle { opacity: 0.9; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .back-link {
            display: inline-block; margin-bottom: 2rem; padding: 0.5rem 1rem;
            background: white; color: #11998e; text-decoration: none;
            border-radius: 6px; font-weight: 600;
        }
        .content-box {
            background: white; padding: 2rem; border-radius: 12px;
            margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #11998e; margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem; border-bottom: 3px solid #11998e;
        }
        h3 { color: #2c3e50; margin: 1.5rem 0 1rem 0; }
        h4 { color: #2c3e50; margin: 1rem 0 0.5rem 0; }
        p { margin-bottom: 1rem; }
        ul, ol { margin-left: 2rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
        pre {
            background: #1e1e1e; color: #d4d4d4; padding: 1.5rem;
            border-radius: 8px; overflow-x: auto; margin: 1rem 0;
            border-left: 4px solid #11998e;
        }
        code {
            font-family: 'Courier New', monospace; font-size: 0.9rem;
        }
        .key-point {
            background: #e8f5e9; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #4caf50; margin: 1rem 0;
        }
        .tech-note {
            background: #e3f2fd; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #2196f3; margin: 1rem 0;
        }
        .warning-box {
            background: #fff3e0; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #ff9800; margin: 1rem 0;
        }
        .info-box {
            background: #f3e5f5; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #9c27b0; margin: 1rem 0;
        }
        .formula {
            background: #f0f7ff; padding: 1rem; border-radius: 6px;
            margin: 1rem 0; overflow-x: auto;
        }
        table {
            width: 100%; border-collapse: collapse; margin: 1rem 0;
        }
        th, td {
            border: 1px solid #ddd; padding: 0.75rem; text-align: left;
        }
        th {
            background: #11998e; color: white; font-weight: 600;
        }
        tr:nth-child(even) { background: #f9f9f9; }
        .nav-buttons {
            display: flex; justify-content: space-between; margin-top: 3rem;
        }
        .nav-buttons a {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; text-decoration: none; border-radius: 6px;
            font-weight: 600;
        }
        footer {
            background: #2c3e50; color: white; text-align: center;
            padding: 2rem 1rem; margin-top: 4rem;
        }
        @media (max-width: 768px) {
            h1 { font-size: 1.6rem; }
            .container { padding: 0 0.5rem; }
            pre { padding: 1rem; }
        }
    
        
    
        /* Breadcrumb styles */
        .breadcrumb {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .breadcrumb-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a0aec0;
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: #4a5568;
            font-weight: 500;
        }
    </style>

    <!-- Mermaid for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({ startOnLoad: true, theme: 'default' });
            }
        });
    </script>

    <style>
        /* Locale Switcher Styles */
        .locale-switcher {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .current-locale {
            font-weight: 600;
            color: #7b2cbf;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .locale-separator {
            color: #adb5bd;
            font-weight: 300;
        }

        .locale-link {
            color: #f093fb;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .locale-link:hover {
            background: rgba(240, 147, 251, 0.1);
            color: #d07be8;
            transform: translateY(-1px);
        }

        .locale-meta {
            color: #868e96;
            font-size: 0.85rem;
            font-style: italic;
            margin-left: auto;
        }

        @media (max-width: 768px) {
            .locale-switcher {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
            }
            .locale-meta {
                display: none;
            }
        }
    </style>
</head>
<body>
            <div class="locale-switcher">
<span class="current-locale">ğŸŒ JP</span>
<span class="locale-separator">|</span>
<a href="../../../en/PI/ai-agent-process/chapter-6.html" class="locale-link">ğŸ‡¬ğŸ‡§ EN</a>
<span class="locale-separator">|</span>
<span class="locale-meta">Last sync: 2025-11-16</span>
</div>
<nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="../../index.html">AIå¯ºå­å±‹ãƒˆãƒƒãƒ—</a><span class="breadcrumb-separator">â€º</span><a href="../../PI/index.html">ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹</a><span class="breadcrumb-separator">â€º</span><a href="../../PI/ai-agent-process/index.html">Ai Agent Process</a><span class="breadcrumb-separator">â€º</span><span class="breadcrumb-current">Chapter 6</span>
        </div>
    </nav>

        <header>
        <div class="container">
            <h1>ç¬¬6ç« ï¼šå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã¨ã®çµ±åˆ</h1>
            <p class="subtitle">LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹é«˜åº¦ãªå”èª¿åˆ¶å¾¡ã¨ãƒ—ãƒ­ã‚»ã‚¹è¨ºæ–­</p>
            <div class="meta">
                <span class="meta">ğŸ“– èª­äº†æ™‚é–“: 30-35åˆ†</span>
                <span class="meta">ğŸ’¡ é›£æ˜“åº¦: ä¸Šç´š</span>
                <span class="meta">ğŸ”¬ å®Ÿä¾‹: LLM+RL Hybridã‚·ã‚¹ãƒ†ãƒ </span>
            </div>
        </div>
    </header>

    <main class="container">
        <a href="./index.html" class="back-link">â† ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡ã«æˆ»ã‚‹</a>

        <div class="content-box">
            <h2>æœ¬ç« ã®æ¦‚è¦</h2>
            <p>æœ¬ç« ã§ã¯ã€å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’å¼·åŒ–å­¦ç¿’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨çµ±åˆã—ã€é«˜åº¦ãªãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚LLMã®è‡ªç„¶è¨€èªç†è§£èƒ½åŠ›ã¨æ¨è«–èƒ½åŠ›ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€å¾“æ¥ã®RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã¯å›°é›£ã ã£ãŸæŸ”è»Ÿãªæ„æ€æ±ºå®šã€ç•°å¸¸è¨ºæ–­ã€äººé–“ã¨ã®å”èª¿ä½œæ¥­ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>

            <div class="key-point">
                <p><strong>ğŸ’¡ æœ¬ç« ã§å­¦ã¶ã“ã¨</strong></p>
                <ul>
                    <li>Claude API / OpenAI APIã‚’ç”¨ã„ãŸLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹ç¯‰</li>
                    <li>LangChainã«ã‚ˆã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®å®Ÿè£…</li>
                    <li>LLMã¨RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ</li>
                    <li>Tool Useï¼ˆFunction Callingï¼‰ã«ã‚ˆã‚‹å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æº</li>
                    <li>ãƒ—ãƒ­ã‚»ã‚¹ç•°å¸¸è¨ºæ–­ã¨LLMèª¬æ˜ç”Ÿæˆ</li>
                    <li>å®Ÿãƒ—ãƒ©ãƒ³ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</li>
                </ul>
            </div>
        </div>

        <div class="content-box">
            <h2>6.1 LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åŸºç¤</h2>

            <p>å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã¯ã€è‡ªç„¶è¨€èªã‚’ç†è§£ã—ç”Ÿæˆã™ã‚‹èƒ½åŠ›ã‚’æŒã¤AIã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡ã¸ã®å¿œç”¨ã§ã¯ã€ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã®è§£é‡ˆã€ç•°å¸¸ã®è¨ºæ–­ã€åˆ¶å¾¡æˆ¦ç•¥ã®ææ¡ˆãªã©ã€å¾“æ¥ã®ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚·ã‚¹ãƒ†ãƒ ã§ã¯å›°é›£ã ã£ãŸã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚</p>

            <h3>6.1.1 LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç‰¹å¾´</h3>

            <table>
                <thead>
                    <tr>
                        <th>ç‰¹å¾´</th>
                        <th>RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</th>
                        <th>LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</th>
                        <th>ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>å­¦ç¿’æ–¹æ³•</td>
                        <td>è©¦è¡ŒéŒ¯èª¤ï¼ˆå ±é…¬æœ€å¤§åŒ–ï¼‰</td>
                        <td>äº‹å‰å­¦ç¿’æ¸ˆã¿ï¼ˆæ¨è«–ã®ã¿ï¼‰</td>
                        <td>RLã§æœ€é©åŒ–ã€LLMã§æ¨è«–</td>
                    </tr>
                    <tr>
                        <td>æ¨è«–é€Ÿåº¦</td>
                        <td>âš¡âš¡âš¡ é«˜é€Ÿï¼ˆmsï¼‰</td>
                        <td>âš¡ ä¸­é€Ÿï¼ˆ1-5ç§’ï¼‰</td>
                        <td>âš¡âš¡ å½¹å‰²åˆ†æ‹…ã§æœ€é©åŒ–</td>
                    </tr>
                    <tr>
                        <td>èª¬æ˜å¯èƒ½æ€§</td>
                        <td>â­ ä½ã„</td>
                        <td>â­â­â­ é«˜ã„ï¼ˆè‡ªç„¶è¨€èªï¼‰</td>
                        <td>â­â­â­ LLMãŒèª¬æ˜</td>
                    </tr>
                    <tr>
                        <td>æŸ”è»Ÿæ€§</td>
                        <td>â­â­ å­¦ç¿’ç¯„å›²å†…</td>
                        <td>â­â­â­ æ±ç”¨æ¨è«–å¯èƒ½</td>
                        <td>â­â­â­ ä¸¡æ–¹ã®é•·æ‰€</td>
                    </tr>
                    <tr>
                        <td>ã‚³ã‚¹ãƒˆ</td>
                        <td>åˆæœŸå­¦ç¿’ã‚³ã‚¹ãƒˆé«˜</td>
                        <td>APIå‘¼ã³å‡ºã—ã‚³ã‚¹ãƒˆ</td>
                        <td>ãƒãƒ©ãƒ³ã‚¹å‹</td>
                    </tr>
                </tbody>
            </table>

            <h3>Example 1: Claude APIã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹åˆ†æ</h3>
            <p>Claude APIï¼ˆAnthropicï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€CSTRï¼ˆé€£ç¶šæ”ªæ‹Œæ§½åå¿œå™¨ï¼‰ã®çŠ¶æ…‹ã‚’åˆ†æã—ã€é‹è»¢çŠ¶æ³ã‚’è‡ªç„¶è¨€èªã§èª¬æ˜ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

<pre><code>import anthropic
import os
import json
from typing import Dict, List

# ===================================
# Example 1: Claude APIã§CSTRçŠ¶æ…‹åˆ†æ
# ===================================

class ClaudeProcessAnalyzer:
    """Claude APIã‚’ç”¨ã„ãŸãƒ—ãƒ­ã‚»ã‚¹åˆ†æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"""

    def __init__(self, api_key: str = None):
        """
        Args:
            api_key: Anthropic API Keyï¼ˆç’°å¢ƒå¤‰æ•°ANTHROPIC_API_KEYã‹ã‚‰è‡ªå‹•å–å¾—ï¼‰
        """
        self.api_key = api_key or os.getenv("ANTHROPIC_API_KEY")
        if not self.api_key:
            raise ValueError("API key required. Set ANTHROPIC_API_KEY environment variable.")

        self.client = anthropic.Anthropic(api_key=self.api_key)
        self.model = "claude-3-5-sonnet-20241022"

    def analyze_cstr_state(self, state: Dict, target: Dict) -> Dict:
        """CSTRçŠ¶æ…‹ã‚’åˆ†æã—ã€é‹è»¢çŠ¶æ³ã‚’èª¬æ˜

        Args:
            state: ç¾åœ¨ã®çŠ¶æ…‹ {'temperature': float, 'concentration': float, ...}
            target: ç›®æ¨™å€¤ {'temperature': float, 'concentration': float, ...}

        Returns:
            {'status': str, 'analysis': str, 'recommendations': List[str]}
        """
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
        prompt = f"""ã‚ãªãŸã¯åŒ–å­¦ãƒ—ãƒ­ã‚»ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®CSTRï¼ˆé€£ç¶šæ”ªæ‹Œæ§½åå¿œå™¨ï¼‰ã®çŠ¶æ…‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

**ç¾åœ¨ã®çŠ¶æ…‹:**
- æ¸©åº¦: {state['temperature']:.1f} K
- æ¿ƒåº¦: {state['concentration']:.3f} mol/L
- æµé‡: {state['flow_rate']:.2f} L/min
- åŠ ç†±é›»åŠ›: {state['heating_power']:.2f} kW

**ç›®æ¨™å€¤:**
- ç›®æ¨™æ¸©åº¦: {target['temperature']:.1f} K
- ç›®æ¨™æ¿ƒåº¦: {target['concentration']:.3f} mol/L

ä»¥ä¸‹ã®å½¢å¼ã§JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{{
    "status": "æ­£å¸¸ or æ³¨æ„ or ç•°å¸¸",
    "analysis": "ç¾åœ¨ã®é‹è»¢çŠ¶æ³ã®èª¬æ˜ï¼ˆ100æ–‡å­—ä»¥å†…ï¼‰",
    "recommendations": ["æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³1", "æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³2", ...]
}}"""

        # Claude APIã‚’å‘¼ã³å‡ºã—
        message = self.client.messages.create(
            model=self.model,
            max_tokens=1024,
            messages=[
                {"role": "user", "content": prompt}
            ]
        )

        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
        response_text = message.content[0].text

        # JSONã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆ```json```ã§å›²ã¾ã‚Œã¦ã„ã‚‹å ´åˆã«å¯¾å¿œï¼‰
        if "```json" in response_text:
            json_str = response_text.split("```json")[1].split("```")[0].strip()
        else:
            json_str = response_text

        result = json.loads(json_str)
        return result


# ä½¿ç”¨ä¾‹
if __name__ == "__main__":
    # CSTRçŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿
    current_state = {
        'temperature': 365.0,  # Kï¼ˆç›®æ¨™350Kã‹ã‚‰+15Ké«˜ã„ï¼‰
        'concentration': 0.32,  # mol/L
        'flow_rate': 1.0,
        'heating_power': 5.2
    }

    target_state = {
        'temperature': 350.0,
        'concentration': 0.30
    }

    # åˆ†æã‚’å®Ÿè¡Œ
    analyzer = ClaudeProcessAnalyzer()
    result = analyzer.analyze_cstr_state(current_state, target_state)

    print("=== CSTRçŠ¶æ…‹åˆ†æçµæœ ===")
    print(f"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {result['status']}")
    print(f"\nåˆ†æ: {result['analysis']}")
    print(f"\næ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:")
    for i, rec in enumerate(result['recommendations'], 1):
        print(f"  {i}. {rec}")

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:
# === CSTRçŠ¶æ…‹åˆ†æçµæœ ===
# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æ³¨æ„
#
# åˆ†æ: æ¸©åº¦ãŒç›®æ¨™å€¤ã‚ˆã‚Š15Ké«˜ãã€ã‚ªãƒ¼ãƒãƒ¼ã‚·ãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã§ã™ã€‚æ¿ƒåº¦ã‚‚ç›®æ¨™ã‚ˆã‚Šé«˜ã‚ã§ã™ãŒè¨±å®¹ç¯„å›²å†…ã§ã™ã€‚
#
# æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
#   1. åŠ ç†±é›»åŠ›ã‚’3.5kWç¨‹åº¦ã¾ã§æ¸›å°‘ã•ã›ã‚‹
#   2. å†·å´æ°´æµé‡ã‚’10%å¢—åŠ ã•ã›ã‚‹
#   3. æ¸©åº¦ãŒ340Kä»¥ä¸‹ã«ä½ä¸‹ã—ãªã„ã‚ˆã†ç›£è¦–ã‚’ç¶™ç¶š
</code></pre>

            <div class="tech-note">
                <p><strong>ğŸ’¡ Pro Tip: API Keyç®¡ç†</strong></p>
                <p>æœ¬ç•ªç’°å¢ƒã§ã¯ã€API Keyã‚’ç’°å¢ƒå¤‰æ•°ã‚„Secret Managerã«ä¿å­˜ã—ã€ã‚³ãƒ¼ãƒ‰ã«ç›´æ¥åŸ‹ã‚è¾¼ã¾ãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚ã¾ãŸã€APIå‘¼ã³å‡ºã—ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆAnthropic: 50 requests/minï¼‰ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        </div>

        <div class="content-box">
            <h2>6.2 Tool Useï¼ˆFunction Callingï¼‰ã®å®Ÿè£…</h2>

            <p>Claude APIã®Tool Useæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€LLMãŒå¤–éƒ¨é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã‚Šã€åˆ¶å¾¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ãŸã‚Šã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå®Ÿãƒ—ãƒ­ã‚»ã‚¹ã¨ç›´æ¥é€£æºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>

            <div class="mermaid">
flowchart LR
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼/ã‚»ãƒ³ã‚µãƒ¼] -->|çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿| B[LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ]
    B -->|Tool Call| C[get_sensor_data]
    C -->|ã‚»ãƒ³ã‚µãƒ¼å€¤| B
    B -->|Tool Call| D[execute_control_action]
    D -->|åˆ¶å¾¡ä¿¡å·| E[CSTR]
    E -->|ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯| A

    style B fill:#e3f2fd
    style C fill:#e8f5e9
    style D fill:#fff3e0
</div>

            <h3>Example 2: Tool Useã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡</h3>
            <p>LLMãŒå®Ÿéš›ã®ãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡é–¢æ•°ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>

<pre><code># ===================================
# Example 2: Tool Useã§ãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡
# ===================================

class ClaudeProcessController:
    """Tool Useã‚’ä½¿ã£ãŸãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"""

    def __init__(self, api_key: str = None):
        self.client = anthropic.Anthropic(api_key=api_key or os.getenv("ANTHROPIC_API_KEY"))
        self.model = "claude-3-5-sonnet-20241022"

        # åˆ¶å¾¡å¯¾è±¡ã®CSTRï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        self.cstr_state = {
            'temperature': 355.0,
            'concentration': 0.35,
            'heating_power': 4.5,
            'flow_rate': 1.0
        }

    def get_sensor_data(self) -> Dict:
        """ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆToolé–¢æ•°ï¼‰"""
        return self.cstr_state

    def set_heating_power(self, power: float) -> Dict:
        """åŠ ç†±é›»åŠ›ã‚’è¨­å®šï¼ˆToolé–¢æ•°ï¼‰

        Args:
            power: åŠ ç†±é›»åŠ› [kW]ï¼ˆ0-10ã®ç¯„å›²ï¼‰
        """
        power = max(0.0, min(10.0, power))  # å®‰å…¨ç¯„å›²ã«åˆ¶é™
        self.cstr_state['heating_power'] = power
        return {
            'success': True,
            'new_power': power,
            'message': f'åŠ ç†±é›»åŠ›ã‚’{power:.1f}kWã«è¨­å®šã—ã¾ã—ãŸ'
        }

    def set_flow_rate(self, flow: float) -> Dict:
        """æµé‡ã‚’è¨­å®šï¼ˆToolé–¢æ•°ï¼‰

        Args:
            flow: æµé‡ [L/min]ï¼ˆ0.5-2.0ã®ç¯„å›²ï¼‰
        """
        flow = max(0.5, min(2.0, flow))
        self.cstr_state['flow_rate'] = flow
        return {
            'success': True,
            'new_flow': flow,
            'message': f'æµé‡ã‚’{flow:.2f}L/minã«è¨­å®šã—ã¾ã—ãŸ'
        }

    def define_tools(self) -> List[Dict]:
        """LLMãŒä½¿ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã‚’å®šç¾©"""
        return [
            {
                "name": "get_sensor_data",
                "description": "CSTRã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆæ¸©åº¦ã€æ¿ƒåº¦ã€åŠ ç†±é›»åŠ›ã€æµé‡ï¼‰ã‚’å–å¾—ã—ã¾ã™ã€‚",
                "input_schema": {
                    "type": "object",
                    "properties": {},
                    "required": []
                }
            },
            {
                "name": "set_heating_power",
                "description": "CSTRã®åŠ ç†±é›»åŠ›ã‚’è¨­å®šã—ã¾ã™ã€‚0-10kWã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "power": {
                            "type": "number",
                            "description": "è¨­å®šã™ã‚‹åŠ ç†±é›»åŠ› [kW]"
                        }
                    },
                    "required": ["power"]
                }
            },
            {
                "name": "set_flow_rate",
                "description": "CSTRã®æµé‡ã‚’è¨­å®šã—ã¾ã™ã€‚0.5-2.0 L/minã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "flow": {
                            "type": "number",
                            "description": "è¨­å®šã™ã‚‹æµé‡ [L/min]"
                        }
                    },
                    "required": ["flow"]
                }
            }
        ]

    def execute_tool(self, tool_name: str, tool_input: Dict) -> Dict:
        """ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ"""
        if tool_name == "get_sensor_data":
            return self.get_sensor_data()
        elif tool_name == "set_heating_power":
            return self.set_heating_power(tool_input['power'])
        elif tool_name == "set_flow_rate":
            return self.set_flow_rate(tool_input['flow'])
        else:
            return {'error': f'Unknown tool: {tool_name}'}

    def run_control_task(self, user_request: str, max_iterations: int = 5) -> str:
        """åˆ¶å¾¡ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ

        Args:
            user_request: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ï¼ˆä¾‹: "æ¸©åº¦ã‚’350Kã«ä¸‹ã’ã¦ãã ã•ã„"ï¼‰
            max_iterations: æœ€å¤§Toolå‘¼ã³å‡ºã—å›æ•°

        Returns:
            æœ€çµ‚çš„ãªLLMã®å¿œç­”
        """
        messages = [
            {"role": "user", "content": user_request}
        ]

        for iteration in range(max_iterations):
            # Claude APIã‚’å‘¼ã³å‡ºã—
            response = self.client.messages.create(
                model=self.model,
                max_tokens=2048,
                tools=self.define_tools(),
                messages=messages
            )

            # å¿œç­”ã‚’ãƒ­ã‚°
            print(f"\n=== Iteration {iteration + 1} ===")
            print(f"Stop reason: {response.stop_reason}")

            # Toolå‘¼ã³å‡ºã—ãŒã‚ã‚‹å ´åˆ
            if response.stop_reason == "tool_use":
                # Assistantã®å¿œç­”ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã«è¿½åŠ 
                messages.append({
                    "role": "assistant",
                    "content": response.content
                })

                # å„Tool callã‚’å®Ÿè¡Œ
                tool_results = []
                for content_block in response.content:
                    if content_block.type == "tool_use":
                        tool_name = content_block.name
                        tool_input = content_block.input

                        print(f"Tool call: {tool_name}({tool_input})")

                        # Toolã‚’å®Ÿè¡Œ
                        result = self.execute_tool(tool_name, tool_input)
                        print(f"Tool result: {result}")

                        tool_results.append({
                            "type": "tool_result",
                            "tool_use_id": content_block.id,
                            "content": json.dumps(result)
                        })

                # Toolçµæœã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã«è¿½åŠ 
                messages.append({
                    "role": "user",
                    "content": tool_results
                })

            # çµ‚äº†æ¡ä»¶
            elif response.stop_reason == "end_turn":
                # æœ€çµ‚å¿œç­”ã‚’æŠ½å‡º
                final_response = ""
                for content_block in response.content:
                    if hasattr(content_block, 'text'):
                        final_response += content_block.text

                return final_response

        return "æœ€å¤§åå¾©å›æ•°ã«åˆ°é”ã—ã¾ã—ãŸ"


# ä½¿ç”¨ä¾‹
if __name__ == "__main__":
    controller = ClaudeProcessController()

    # ã‚¿ã‚¹ã‚¯: æ¸©åº¦ã‚’ä¸‹ã’ã‚‹
    result = controller.run_control_task(
        "ç¾åœ¨ã®CSTRæ¸©åº¦ãŒ355Kã§ç›®æ¨™ã¯350Kã§ã™ã€‚æ¸©åº¦ã‚’ä¸‹ã’ã¦ãã ã•ã„ã€‚"
    )

    print("\n=== æœ€çµ‚çµæœ ===")
    print(result)
    print(f"\nç¾åœ¨ã®çŠ¶æ…‹: {controller.cstr_state}")

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:
# === Iteration 1 ===
# Stop reason: tool_use
# Tool call: get_sensor_data({})
# Tool result: {'temperature': 355.0, 'concentration': 0.35, ...}
#
# === Iteration 2 ===
# Stop reason: tool_use
# Tool call: set_heating_power({'power': 3.5})
# Tool result: {'success': True, 'new_power': 3.5, ...}
#
# === Iteration 3 ===
# Stop reason: end_turn
#
# === æœ€çµ‚çµæœ ===
# åŠ ç†±é›»åŠ›ã‚’4.5kWã‹ã‚‰3.5kWã«æ¸›å°‘ã•ã›ã¾ã—ãŸã€‚ã“ã®èª¿æ•´ã«ã‚ˆã‚Šã€
# åå¿œå™¨æ¸©åº¦ã¯å¾ã€…ã«350Kã®ç›®æ¨™å€¤ã«è¿‘ã¥ã„ã¦ã„ãã¯ãšã§ã™ã€‚
# 10åˆ†å¾Œã«å†åº¦æ¸©åº¦ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦å¾®èª¿æ•´ã‚’è¡Œã†ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
</code></pre>

            <div class="warning-box">
                <p><strong>âš ï¸ å®‰å…¨ä¸Šã®æ³¨æ„</strong></p>
                <p>Tool Useã§å®Ÿãƒ—ãƒ­ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®å®‰å…¨å¯¾ç­–ãŒå¿…é ˆã§ã™ï¼š</p>
                <ul>
                    <li>ã™ã¹ã¦ã®Toolé–¢æ•°ã«å…¥åŠ›å€¤ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…</li>
                    <li>å±é™ºãªæ“ä½œï¼ˆç·Šæ€¥åœæ­¢ãªã©ï¼‰ã¯äººé–“ã®æ‰¿èªã‚’å¿…é ˆã¨ã™ã‚‹</li>
                    <li>LLMã®æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¤œè¨¼ã—ã¦ã‹ã‚‰å®Ÿè¡Œ</li>
                    <li>APIéšœå®³æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿæ§‹ï¼ˆPIDåˆ¶å¾¡ãªã©ï¼‰ã‚’ç”¨æ„</li>
                </ul>
            </div>
        </div>

        <div class="content-box">
            <h2>6.3 LangChainã«ã‚ˆã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯</h2>

            <p>LangChainã¯ã€LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã®ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹ç¯‰ã€ãƒ¡ãƒ¢ãƒªç®¡ç†ã€ãƒ„ãƒ¼ãƒ«çµ±åˆã‚’ç°¡æ½”ã«å®Ÿè£…ã§ãã¾ã™ã€‚</p>

            <h3>6.3.1 LangChainã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹æˆè¦ç´ </h3>

            <div class="mermaid">
flowchart TD
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›] --> B[Agent Executor]
    B --> C[LLM<br/>Claude/GPT-4]
    C --> D{Toolå¿…è¦?}
    D -->|Yes| E[Tool<br/>get_sensor_data<br/>set_control]
    E --> F[Toolçµæœ]
    F --> C
    D -->|No| G[æœ€çµ‚å¿œç­”]

    H[Memory<br/>ä¼šè©±å±¥æ­´] -.-> B
    B -.->|æ›´æ–°| H

    style C fill:#e3f2fd
    style E fill:#e8f5e9
    style H fill:#fff3e0
</div>

            <h3>Example 3: LangChainã§ãƒ—ãƒ­ã‚»ã‚¹è¨ºæ–­ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</h3>
            <p>LangChainã‚’ä½¿ç”¨ã—ã¦ã€ä¼šè©±å±¥æ­´ã‚’ä¿æŒã—ãªãŒã‚‰ãƒ—ãƒ­ã‚»ã‚¹è¨ºæ–­ã‚’è¡Œã†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚</p>

<pre><code>from langchain.agents import AgentExecutor, create_react_agent
from langchain_anthropic import ChatAnthropic
from langchain.tools import Tool
from langchain.prompts import PromptTemplate
from langchain.memory import ConversationBufferMemory
import numpy as np

# ===================================
# Example 3: LangChainãƒ—ãƒ­ã‚»ã‚¹è¨ºæ–­ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
# ===================================

class ProcessDiagnosticAgent:
    """LangChainã‚’ç”¨ã„ãŸãƒ—ãƒ­ã‚»ã‚¹è¨ºæ–­ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"""

    def __init__(self, api_key: str = None):
        self.api_key = api_key or os.getenv("ANTHROPIC_API_KEY")

        # LLMã‚’åˆæœŸåŒ–
        self.llm = ChatAnthropic(
            model="claude-3-5-sonnet-20241022",
            anthropic_api_key=self.api_key,
            temperature=0.0
        )

        # ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        self.process_history = []
        self.current_state = {
            'temperature': 348.0,
            'pressure': 2.1,  # bar
            'flow_rate': 1.0,
            'concentration': 0.28
        }

        # ãƒ¡ãƒ¢ãƒªï¼ˆä¼šè©±å±¥æ­´ã‚’ä¿å­˜ï¼‰
        self.memory = ConversationBufferMemory(
            memory_key="chat_history",
            return_messages=True
        )

        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰
        self.agent_executor = self._build_agent()

    def _get_current_state(self, query: str = "") -> str:
        """ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ã‚’å–å¾—"""
        state_str = f"""ç¾åœ¨ã®CSTRçŠ¶æ…‹:
- æ¸©åº¦: {self.current_state['temperature']:.1f} K
- åœ§åŠ›: {self.current_state['pressure']:.2f} bar
- æµé‡: {self.current_state['flow_rate']:.2f} L/min
- æ¿ƒåº¦: {self.current_state['concentration']:.3f} mol/L"""
        return state_str

    def _get_historical_trend(self, query: str = "") -> str:
        """éå»ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
        if len(self.process_history) == 0:
            return "å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"

        temps = [h['temperature'] for h in self.process_history[-10:]]
        avg_temp = np.mean(temps)
        std_temp = np.std(temps)

        trend = "ä¸Šæ˜‡" if temps[-1] > temps[0] else "ä½ä¸‹"

        return f"""éå»10ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒˆãƒ¬ãƒ³ãƒ‰:
- å¹³å‡æ¸©åº¦: {avg_temp:.1f} K
- æ¸©åº¦æ¨™æº–åå·®: {std_temp:.2f} K
- ãƒˆãƒ¬ãƒ³ãƒ‰: {trend}å‚¾å‘
- å¤‰å‹•ç¯„å›²: {min(temps):.1f} - {max(temps):.1f} K"""

    def _diagnose_anomaly(self, query: str = "") -> str:
        """ç•°å¸¸ã‚’è¨ºæ–­"""
        state = self.current_state
        issues = []

        # æ¸©åº¦ç•°å¸¸ãƒã‚§ãƒƒã‚¯
        if state['temperature'] < 340 or state['temperature'] > 360:
            issues.append(f"æ¸©åº¦ç•°å¸¸: {state['temperature']:.1f} Kï¼ˆæ­£å¸¸ç¯„å›²: 340-360Kï¼‰")

        # åœ§åŠ›ç•°å¸¸ãƒã‚§ãƒƒã‚¯
        if state['pressure'] < 1.8 or state['pressure'] > 2.5:
            issues.append(f"åœ§åŠ›ç•°å¸¸: {state['pressure']:.2f} barï¼ˆæ­£å¸¸ç¯„å›²: 1.8-2.5barï¼‰")

        # æ¿ƒåº¦ç•°å¸¸ãƒã‚§ãƒƒã‚¯
        if state['concentration'] < 0.25 or state['concentration'] > 0.35:
            issues.append(f"æ¿ƒåº¦ç•°å¸¸: {state['concentration']:.3f} mol/Lï¼ˆæ­£å¸¸ç¯„å›²: 0.25-0.35ï¼‰")

        if len(issues) == 0:
            return "ç¾åœ¨ã€ç•°å¸¸ã¯æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ­£å¸¸ç¯„å›²å†…ã§ã™ã€‚"
        else:
            return "æ¤œå‡ºã•ã‚ŒãŸç•°å¸¸:\n" + "\n".join([f"- {issue}" for issue in issues])

    def _build_agent(self) -> AgentExecutor:
        """ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰"""

        # ãƒ„ãƒ¼ãƒ«ã‚’å®šç¾©
        tools = [
            Tool(
                name="get_current_state",
                func=self._get_current_state,
                description="ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ï¼ˆæ¸©åº¦ã€åœ§åŠ›ã€æµé‡ã€æ¿ƒåº¦ï¼‰ã‚’å–å¾—ã—ã¾ã™ã€‚"
            ),
            Tool(
                name="get_historical_trend",
                func=self._get_historical_trend,
                description="éå»ã®ãƒ—ãƒ­ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’åˆ†æã—ã¾ã™ã€‚å¹³å‡å€¤ã€æ¨™æº–åå·®ã€ãƒˆãƒ¬ãƒ³ãƒ‰æ–¹å‘ã‚’è¿”ã—ã¾ã™ã€‚"
            ),
            Tool(
                name="diagnose_anomaly",
                func=self._diagnose_anomaly,
                description="ãƒ—ãƒ­ã‚»ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç•°å¸¸ã‚’è¨ºæ–­ã—ã¾ã™ã€‚æ­£å¸¸ç¯„å›²å¤–ã®å€¤ã‚’æ¤œå‡ºã—ã¾ã™ã€‚"
            )
        ]

        # ReActãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        template = """ã‚ãªãŸã¯åŒ–å­¦ãƒ—ãƒ­ã‚»ã‚¹è¨ºæ–­ã®å°‚é–€å®¶ã§ã™ã€‚åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚

åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«:
{tools}

ãƒ„ãƒ¼ãƒ«å: {tool_names}

ä»¥ä¸‹ã®å½¢å¼ã§å¿œç­”ã—ã¦ãã ã•ã„:

Question: å…¥åŠ›ã•ã‚ŒãŸè³ªå•
Thought: ä½•ã‚’ã™ã¹ãã‹è€ƒãˆã‚‹
Action: å®Ÿè¡Œã™ã‚‹ãƒ„ãƒ¼ãƒ«å
Action Input: ãƒ„ãƒ¼ãƒ«ã¸ã®å…¥åŠ›
Observation: ãƒ„ãƒ¼ãƒ«ã®çµæœ
... (ã“ã® Thought/Action/Action Input/Observation ã‚’å¿…è¦ãªã ã‘ç¹°ã‚Šè¿”ã™)
Thought: æœ€çµ‚çš„ãªç­”ãˆãŒã‚ã‹ã£ãŸ
Final Answer: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æœ€çµ‚å›ç­”

è³ªå•: {input}

{agent_scratchpad}"""

        prompt = PromptTemplate.from_template(template)

        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆ
        agent = create_react_agent(
            llm=self.llm,
            tools=tools,
            prompt=prompt
        )

        # Agent Executorã‚’ä½œæˆ
        agent_executor = AgentExecutor(
            agent=agent,
            tools=tools,
            verbose=True,
            handle_parsing_errors=True,
            max_iterations=5
        )

        return agent_executor

    def diagnose(self, query: str) -> str:
        """è¨ºæ–­ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ

        Args:
            query: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è³ªå•

        Returns:
            è¨ºæ–­çµæœ
        """
        # å±¥æ­´ã«ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿½åŠ 
        self.process_history.append(self.current_state.copy())

        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œ
        result = self.agent_executor.invoke({
            "input": query
        })

        return result['output']


# ä½¿ç”¨ä¾‹
if __name__ == "__main__":
    agent = ProcessDiagnosticAgent()

    # ã‚¯ã‚¨ãƒª1: ç¾åœ¨ã®çŠ¶æ…‹ç¢ºèª
    print("=== Query 1 ===")
    result1 = agent.diagnose("ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚")
    print(f"\nå¿œç­”: {result1}\n")

    # çŠ¶æ…‹ã‚’å¤‰æ›´ï¼ˆç•°å¸¸ã‚’ç™ºç”Ÿã•ã›ã‚‹ï¼‰
    agent.current_state['temperature'] = 365.0  # ç•°å¸¸å€¤
    agent.current_state['pressure'] = 2.7  # ç•°å¸¸å€¤

    # ã‚¯ã‚¨ãƒª2: ç•°å¸¸è¨ºæ–­
    print("\n=== Query 2 ===")
    result2 = agent.diagnose("ä½•ã‹ç•°å¸¸ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿã‚‚ã—ã‚ã‚Œã°åŸå› ã¨å¯¾ç­–ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚")
    print(f"\nå¿œç­”: {result2}\n")

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:
# === Query 1 ===
#
# > Entering new AgentExecutor chain...
# Thought: ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹
# Action: get_current_state
# Action Input:
# Observation: ç¾åœ¨ã®CSTRçŠ¶æ…‹:
# - æ¸©åº¦: 348.0 K
# - åœ§åŠ›: 2.10 bar
# ...
# Thought: æœ€çµ‚çš„ãªç­”ãˆãŒã‚ã‹ã£ãŸ
# Final Answer: ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯æ­£å¸¸ã«é‹è»¢ã•ã‚Œã¦ã„ã¾ã™ã€‚æ¸©åº¦348Kã€åœ§åŠ›2.1barã€
# æµé‡1.0L/minã€æ¿ƒåº¦0.28mol/Lã§ã€ã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ­£å¸¸ç¯„å›²å†…ã«ã‚ã‚Šã¾ã™ã€‚
#
# === Query 2 ===
#
# > Entering new AgentExecutor chain...
# Thought: ç•°å¸¸è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã¹ã
# Action: diagnose_anomaly
# Action Input:
# Observation: æ¤œå‡ºã•ã‚ŒãŸç•°å¸¸:
# - æ¸©åº¦ç•°å¸¸: 365.0 Kï¼ˆæ­£å¸¸ç¯„å›²: 340-360Kï¼‰
# - åœ§åŠ›ç•°å¸¸: 2.70 barï¼ˆæ­£å¸¸ç¯„å›²: 1.8-2.5barï¼‰
# Thought: æœ€çµ‚çš„ãªç­”ãˆãŒã‚ã‹ã£ãŸ
# Final Answer: ç¾åœ¨ã€2ã¤ã®ç•°å¸¸ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚
#
# 1. æ¸©åº¦ç•°å¸¸ï¼ˆ365Kï¼‰: æ­£å¸¸ç¯„å›²ï¼ˆ340-360Kï¼‰ã‚’è¶…é
#    åŸå› : åŠ ç†±é›»åŠ›éå‰°ã€å†·å´ä¸è¶³ã€ã¾ãŸã¯ç™ºç†±åå¿œã®åŠ é€Ÿ
#    å¯¾ç­–: åŠ ç†±é›»åŠ›ã‚’20%æ¸›å°‘ã€å†·å´æ°´æµé‡ã‚’15%å¢—åŠ 
#
# 2. åœ§åŠ›ç•°å¸¸ï¼ˆ2.7barï¼‰: æ­£å¸¸ç¯„å›²ï¼ˆ1.8-2.5barï¼‰ã‚’è¶…é
#    åŸå› : æµå‡ºãƒãƒ«ãƒ–ã®è©°ã¾ã‚Šã€ã¾ãŸã¯æ°—ç›¸ç”Ÿæˆç‰©ã®å¢—åŠ 
#    å¯¾ç­–: æµå‡ºãƒãƒ«ãƒ–ã®é–‹åº¦ã‚’10%å¢—åŠ ã€æ¸©åº¦ä½ä¸‹ã«ã‚ˆã‚Šæ°—ç›¸ç”Ÿæˆã‚’æŠ‘åˆ¶
</code></pre>

            <div class="info-box">
                <p><strong>ğŸ’¡ LangChainã®ãƒ¡ãƒªãƒƒãƒˆ</strong></p>
                <ul>
                    <li><strong>ãƒ¡ãƒ¢ãƒªç®¡ç†</strong>: ä¼šè©±å±¥æ­´ã‚’è‡ªå‹•çš„ã«ä¿å­˜ãƒ»å‚ç…§</li>
                    <li><strong>ãƒ„ãƒ¼ãƒ«çµ±åˆ</strong>: Pythonã•ãˆã‚ã‚Œã°ã©ã‚“ãªé–¢æ•°ã§ã‚‚LLMãƒ„ãƒ¼ãƒ«ã«å¤‰æ›å¯èƒ½</li>
                    <li><strong>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</strong>: LLMã®å‡ºåŠ›ãƒ‘ãƒ¼ã‚¹å¤±æ•—ã‚’è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤</li>
                    <li><strong>ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ€§</strong>: LLMã€Toolsã€Memoryã‚’ç‹¬ç«‹ã—ã¦å¤‰æ›´å¯èƒ½</li>
                </ul>
            </div>
        </div>

        <div class="content-box">
            <h2>6.4 LLM-RL Hybridã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰</h2>

            <p>LLMã®æ¨è«–èƒ½åŠ›ã¨RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æœ€é©åŒ–èƒ½åŠ›ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šé«˜åº¦ãªãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚LLMã¯é«˜ãƒ¬ãƒ™ãƒ«ã®æˆ¦ç•¥æ±ºå®šã‚’æ‹…å½“ã—ã€RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ä½ãƒ¬ãƒ™ãƒ«ã®åˆ¶å¾¡ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>

            <h3>6.4.1 Hierarchical Architecture</h3>

            <div class="mermaid">
flowchart TD
    A[äººé–“ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼] -->|æŒ‡ç¤º/å•ã„åˆã‚ã›| B[LLM Coordinator<br/>Claude/GPT-4]
    B -->|æˆ¦ç•¥æ±ºå®š<br/>ç›®æ¨™è¨­å®š| C[RL Agent 1<br/>åå¿œå™¨åˆ¶å¾¡]
    B -->|æˆ¦ç•¥æ±ºå®š<br/>ç›®æ¨™è¨­å®š| D[RL Agent 2<br/>åˆ†é›¢å™¨åˆ¶å¾¡]
    B -->|æˆ¦ç•¥æ±ºå®š<br/>ç›®æ¨™è¨­å®š| E[RL Agent 3<br/>ç†±äº¤æ›å™¨åˆ¶å¾¡]

    C -->|çŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆ| B
    D -->|çŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆ| B
    E -->|çŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆ| B

    C -.->|å”èª¿| D
    D -.->|å”èª¿| E

    C --> F[CSTR]
    D --> G[è’¸ç•™å¡”]
    E --> H[ç†±äº¤æ›å™¨]

    style B fill:#e3f2fd
    style C fill:#e8f5e9
    style D fill:#e8f5e9
    style E fill:#e8f5e9
</div>

            <h3>Example 4: LLM Coordinatorã¨RL Workers</h3>
            <p>LLMãŒè¤‡æ•°ã®RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’çµ±æ‹¬ã—ã€å…¨ä½“æœ€é©åŒ–ã‚’å®Ÿç¾ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

<pre><code>import gym
import numpy as np
from stable_baselines3 import PPO
from typing import Dict, List

# ===================================
# Example 4: LLM-RL Hybridã‚·ã‚¹ãƒ†ãƒ 
# ===================================

class RLWorkerAgent:
    """RLåˆ¶å¾¡ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"""

    def __init__(self, name: str, env: gym.Env, model_path: str = None):
        self.name = name
        self.env = env

        # äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆã¾ãŸã¯ãƒ€ãƒŸãƒ¼ï¼‰
        if model_path:
            self.model = PPO.load(model_path)
        else:
            # ãƒ‡ãƒ¢ç”¨: ãƒ©ãƒ³ãƒ€ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
            self.model = None

        self.current_state = None
        self.current_reward = 0.0
        self.cumulative_reward = 0.0

    def reset(self):
        """ç’°å¢ƒã‚’ãƒªã‚»ãƒƒãƒˆ"""
        self.current_state = self.env.reset()
        self.cumulative_reward = 0.0
        return self.current_state

    def step(self, target_setpoint: Dict = None) -> Dict:
        """1ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ

        Args:
            target_setpoint: LLMã‹ã‚‰æŒ‡ç¤ºã•ã‚ŒãŸç›®æ¨™å€¤

        Returns:
            {'state': ..., 'reward': ..., 'done': ...}
        """
        # RLãƒ¢ãƒ‡ãƒ«ã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
        if self.model:
            action, _ = self.model.predict(self.current_state, deterministic=True)
        else:
            # ãƒ‡ãƒ¢ç”¨: ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            action = self.env.action_space.sample()

        # ç’°å¢ƒã§å®Ÿè¡Œ
        next_state, reward, done, info = self.env.step(action)

        self.current_state = next_state
        self.current_reward = reward
        self.cumulative_reward += reward

        return {
            'state': next_state,
            'reward': reward,
            'cumulative_reward': self.cumulative_reward,
            'done': done,
            'info': info
        }

    def get_status_report(self) -> str:
        """çŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆLLMã¸ã®å ±å‘Šç”¨ï¼‰"""
        if self.current_state is None:
            return f"{self.name}: æœªåˆæœŸåŒ–"

        state_str = ", ".join([f"{k}={v:.2f}" for k, v in
                               enumerate(self.current_state)])

        return f"""{self.name}ã®çŠ¶æ…‹:
- State: [{state_str}]
- ç›´è¿‘å ±é…¬: {self.current_reward:.3f}
- ç´¯ç©å ±é…¬: {self.cumulative_reward:.3f}"""


class LLMCoordinator:
    """LLMã«ã‚ˆã‚‹å…¨ä½“èª¿æ•´ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"""

    def __init__(self, workers: List[RLWorkerAgent], api_key: str = None):
        self.workers = workers
        self.client = anthropic.Anthropic(api_key=api_key or os.getenv("ANTHROPIC_API_KEY"))
        self.model = "claude-3-5-sonnet-20241022"
        self.conversation_history = []

    def collect_worker_reports(self) -> str:
        """å…¨ãƒ¯ãƒ¼ã‚«ãƒ¼ã‹ã‚‰çŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆã‚’åé›†"""
        reports = []
        for worker in self.workers:
            reports.append(worker.get_status_report())

        return "\n\n".join(reports)

    def coordinate(self, user_goal: str = None) -> Dict:
        """ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’èª¿æ•´ã—ã€æˆ¦ç•¥ã‚’æ±ºå®š

        Args:
            user_goal: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‹ã‚‰ã®ç›®æ¨™ï¼ˆä¾‹: "ç”Ÿç”£é‡ã‚’10%å¢—åŠ "ï¼‰

        Returns:
            å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã¸ã®æŒ‡ç¤º
        """
        # ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’åé›†
        worker_reports = self.collect_worker_reports()

        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
        if user_goal:
            prompt = f"""ã‚ãªãŸã¯ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã‚’ç®¡ç†ã™ã‚‹ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚

**ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ç›®æ¨™:**
{user_goal}

**ç¾åœ¨ã®å„ãƒ¦ãƒ‹ãƒƒãƒˆã®çŠ¶æ…‹:**
{worker_reports}

å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆRLåˆ¶å¾¡ï¼‰ã«å¯¾ã—ã¦ã€ä»¥ä¸‹ã®JSONå½¢å¼ã§æŒ‡ç¤ºã‚’å‡ºã—ã¦ãã ã•ã„:
{{
    "strategy": "å…¨ä½“æˆ¦ç•¥ã®èª¬æ˜",
    "worker_instructions": {{
        "worker_0": {{"action": "å…·ä½“çš„ãªæŒ‡ç¤º"}},
        "worker_1": {{"action": "å…·ä½“çš„ãªæŒ‡ç¤º"}},
        "worker_2": {{"action": "å…·ä½“çš„ãªæŒ‡ç¤º"}}
    }}
}}"""
        else:
            prompt = f"""ç¾åœ¨ã®å„ãƒ¦ãƒ‹ãƒƒãƒˆã®çŠ¶æ…‹ã‚’åˆ†æã—ã€æ”¹å–„ææ¡ˆã‚’ã—ã¦ãã ã•ã„:

{worker_reports}

JSONå½¢å¼ã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚"""

        # Claude APIã‚’å‘¼ã³å‡ºã—
        message = self.client.messages.create(
            model=self.model,
            max_tokens=2048,
            messages=[
                {"role": "user", "content": prompt}
            ]
        )

        response_text = message.content[0].text

        # JSONã‚’ãƒ‘ãƒ¼ã‚¹
        if "```json" in response_text:
            json_str = response_text.split("```json")[1].split("```")[0].strip()
        else:
            json_str = response_text

        try:
            instructions = json.loads(json_str)
            return instructions
        except json.JSONDecodeError:
            return {
                'strategy': response_text,
                'worker_instructions': {}
            }

    def run_coordinated_control(self, user_goal: str, n_steps: int = 10):
        """èª¿æ•´åˆ¶å¾¡ã‚’å®Ÿè¡Œ

        Args:
            user_goal: å…¨ä½“ç›®æ¨™
            n_steps: å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—æ•°
        """
        print(f"=== èª¿æ•´åˆ¶å¾¡é–‹å§‹ ===")
        print(f"ç›®æ¨™: {user_goal}\n")

        # ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’åˆæœŸåŒ–
        for worker in self.workers:
            worker.reset()

        for step in range(n_steps):
            print(f"\n--- Step {step + 1}/{n_steps} ---")

            # 5ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«LLMã§èª¿æ•´
            if step % 5 == 0:
                instructions = self.coordinate(user_goal)
                print(f"\nLLMæˆ¦ç•¥: {instructions.get('strategy', 'N/A')}")
                print(f"æŒ‡ç¤º: {instructions.get('worker_instructions', {})}")

            # å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’1ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ
            for i, worker in enumerate(self.workers):
                result = worker.step()
                print(f"{worker.name}: å ±é…¬={result['reward']:.3f}, "
                      f"ç´¯ç©={result['cumulative_reward']:.3f}")

        print(f"\n=== èª¿æ•´åˆ¶å¾¡å®Œäº† ===")
        final_report = self.collect_worker_reports()
        print(f"\n{final_report}")


# ä½¿ç”¨ä¾‹
if __name__ == "__main__":
    # ãƒ‡ãƒ¢ç”¨ã®ç°¡æ˜“ç’°å¢ƒ
    class DummyEnv(gym.Env):
        def __init__(self):
            self.observation_space = gym.spaces.Box(low=-10, high=10, shape=(4,))
            self.action_space = gym.spaces.Box(low=-1, high=1, shape=(2,))
            self.state = np.array([0.0, 0.0, 0.0, 0.0])

        def reset(self):
            self.state = np.random.randn(4)
            return self.state

        def step(self, action):
            self.state += 0.1 * action[0]  # ç°¡æ˜“ãƒ€ã‚¤ãƒŠãƒŸã‚¯ã‚¹
            reward = -np.sum(self.state**2)  # åŸç‚¹ã«è¿‘ã„ã»ã©é«˜å ±é…¬
            done = False
            return self.state, reward, done, {}

    # ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆ
    workers = [
        RLWorkerAgent("Worker_Reactor", DummyEnv()),
        RLWorkerAgent("Worker_Separator", DummyEnv()),
        RLWorkerAgent("Worker_HeatExchanger", DummyEnv())
    ]

    # LLM Coordinatorã‚’ä½œæˆ
    coordinator = LLMCoordinator(workers)

    # èª¿æ•´åˆ¶å¾¡ã‚’å®Ÿè¡Œ
    coordinator.run_coordinated_control(
        user_goal="å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã®å®‰å®šæ€§ã‚’é«˜ã‚ã¤ã¤ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼æ¶ˆè²»ã‚’10%å‰Šæ¸›ã—ã¦ãã ã•ã„ã€‚",
        n_steps=10
    )

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:
# === èª¿æ•´åˆ¶å¾¡é–‹å§‹ ===
# ç›®æ¨™: å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã®å®‰å®šæ€§ã‚’é«˜ã‚ã¤ã¤ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼æ¶ˆè²»ã‚’10%å‰Šæ¸›ã—ã¦ãã ã•ã„ã€‚
#
# --- Step 1/10 ---
# LLMæˆ¦ç•¥: å„ãƒ¦ãƒ‹ãƒƒãƒˆã®çŠ¶æ…‹ã‚’å®‰å®šåŒ–ã•ã›ã‚‹ãŸã‚ã€ã¾ãšåå¿œå™¨ã®æ¸©åº¦å¤‰å‹•ã‚’æŠ‘ãˆã€
# åˆ†é›¢å™¨ã®é‚„æµæ¯”ã‚’æœ€é©åŒ–ã—ã€ç†±äº¤æ›å™¨ã®åŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚
# æŒ‡ç¤º: {'worker_0': {'action': 'æ¸©åº¦ã‚’Â±2Kä»¥å†…ã«ç¶­æŒ'},
#        'worker_1': {'action': 'é‚„æµæ¯”ã‚’0.7ã«èª¿æ•´'},
#        'worker_2': {'action': 'ä¼ç†±ä¿‚æ•°ã‚’5%å‘ä¸Š'}}
#
# Worker_Reactor: å ±é…¬=-2.134, ç´¯ç©=-2.134
# Worker_Separator: å ±é…¬=-1.876, ç´¯ç©=-1.876
# Worker_HeatExchanger: å ±é…¬=-3.021, ç´¯ç©=-3.021
# ...
</code></pre>

            <div class="key-point">
                <p><strong>ğŸ¯ LLM-RL Hybridã®åˆ©ç‚¹</strong></p>
                <ul>
                    <li><strong>æˆ¦ç•¥ã¨æˆ¦è¡“ã®åˆ†é›¢</strong>: LLMãŒé«˜ãƒ¬ãƒ™ãƒ«æˆ¦ç•¥ã€RLãŒä½ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡ã‚’æ‹…å½“</li>
                    <li><strong>èª¬æ˜å¯èƒ½æ€§</strong>: LLMãŒæ±ºå®šç†ç”±ã‚’è‡ªç„¶è¨€èªã§èª¬æ˜</li>
                    <li><strong>é©å¿œæ€§</strong>: æ–°ã—ã„ç›®æ¨™ã‚„åˆ¶ç´„ã«LLMãŒæŸ”è»Ÿã«å¯¾å¿œ</li>
                    <li><strong>äººé–“å”èª¿</strong>: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã¨ã®è‡ªç„¶è¨€èªå¯¾è©±ãŒå¯èƒ½</li>
                </ul>
            </div>
        </div>

        <div class="content-box">
            <h2>6.5 æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</h2>

            <p>LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿãƒ—ãƒ­ã‚»ã‚¹ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«ã¯ã€RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä»¥ä¸Šã«æ…é‡ãªè¨­è¨ˆãŒå¿…è¦ã§ã™ã€‚</p>

            <h3>6.5.1 å®‰å…¨æ€§ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯</h3>

            <table>
                <thead>
                    <tr>
                        <th>ãƒªã‚¹ã‚¯</th>
                        <th>å¯¾ç­–</th>
                        <th>å®Ÿè£…æ–¹æ³•</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>APIéšœå®³</td>
                        <td>Fallbackåˆ¶å¾¡</td>
                        <td>PID/MPCã¸ã®è‡ªå‹•åˆ‡æ›¿</td>
                    </tr>
                    <tr>
                        <td>ãƒ¬ãƒ¼ãƒˆåˆ¶é™</td>
                        <td>ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°</td>
                        <td>åŒä¸€ã‚¯ã‚¨ãƒªã¯å†åˆ©ç”¨ï¼ˆTTL: 5åˆ†ï¼‰</td>
                    </tr>
                    <tr>
                        <td>ä¸é©åˆ‡ãªæ¨å¥¨</td>
                        <td>ç¯„å›²ãƒã‚§ãƒƒã‚¯</td>
                        <td>å…¨ã¦ã®åˆ¶å¾¡å€¤ã« min/maxåˆ¶ç´„</td>
                    </tr>
                    <tr>
                        <td>ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·</td>
                        <td>éåŒæœŸå®Ÿè¡Œ</td>
                        <td>LLMã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ</td>
                    </tr>
                    <tr>
                        <td>ã‚³ã‚¹ãƒˆè¶…é</td>
                        <td>äºˆç®—ç®¡ç†</td>
                        <td>æœˆé–“$1000ä¸Šé™ã€è¶…éæ™‚ã¯ã‚¢ãƒ©ãƒ¼ãƒˆ</td>
                    </tr>
                </tbody>
            </table>

            <h3>Example 5: æœ¬ç•ªå¯¾å¿œçµ±åˆã‚·ã‚¹ãƒ†ãƒ </h3>

<pre><code># ===================================
# Example 5: æœ¬ç•ªå¯¾å¿œLLM-RLçµ±åˆã‚·ã‚¹ãƒ†ãƒ 
# ===================================

import time
import logging
from functools import lru_cache
import hashlib

# ãƒ­ã‚®ãƒ³ã‚°è¨­å®š
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class ProductionLLMController:
    """æœ¬ç•ªç’°å¢ƒå¯¾å¿œã®LLMåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ """

    def __init__(self, api_key: str = None):
        self.client = anthropic.Anthropic(api_key=api_key or os.getenv("ANTHROPIC_API_KEY"))
        self.model = "claude-3-5-sonnet-20241022"

        # çµ±è¨ˆæƒ…å ±
        self.api_call_count = 0
        self.cache_hit_count = 0
        self.fallback_count = 0
        self.total_cost = 0.0  # ãƒ‰ãƒ«

        # åˆ¶ç´„
        self.monthly_budget = 1000.0  # ãƒ‰ãƒ«
        self.max_retries = 3
        self.timeout = 10.0  # ç§’

        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¶å¾¡å™¨ï¼ˆPIDï¼‰
        self.fallback_controller = SimplePIDController()

    @lru_cache(maxsize=100)
    def _cached_llm_call(self, prompt_hash: str, prompt: str) -> str:
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãLLMå‘¼ã³å‡ºã—"""
        logger.info(f"Cache miss for hash {prompt_hash[:8]}. Calling API...")

        try:
            message = self.client.messages.create(
                model=self.model,
                max_tokens=1024,
                messages=[{"role": "user", "content": prompt}],
                timeout=self.timeout
            )

            self.api_call_count += 1

            # ã‚³ã‚¹ãƒˆè¨ˆç®—ï¼ˆæ¦‚ç®—: $3/1M input tokens, $15/1M output tokensï¼‰
            input_tokens = message.usage.input_tokens
            output_tokens = message.usage.output_tokens
            cost = (input_tokens * 3 / 1_000_000) + (output_tokens * 15 / 1_000_000)
            self.total_cost += cost

            logger.info(f"API call #{self.api_call_count}, Cost: ${cost:.4f}, "
                       f"Total: ${self.total_cost:.2f}")

            # äºˆç®—ãƒã‚§ãƒƒã‚¯
            if self.total_cost > self.monthly_budget:
                logger.error(f"Monthly budget ${self.monthly_budget} exceeded!")
                raise ValueError("Budget exceeded")

            return message.content[0].text

        except Exception as e:
            logger.error(f"API call failed: {e}")
            raise

    def llm_control_decision(self, state: Dict, target: Dict) -> Dict:
        """LLMã§åˆ¶å¾¡åˆ¤æ–­ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰

        Args:
            state: ç¾åœ¨ã®çŠ¶æ…‹
            target: ç›®æ¨™å€¤

        Returns:
            {'action': ..., 'reasoning': ..., 'fallback_used': bool}
        """
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
        prompt = f"""CSTRåˆ¶å¾¡åˆ¤æ–­:
ç¾åœ¨: æ¸©åº¦{state['temperature']:.1f}K, æ¿ƒåº¦{state['concentration']:.3f}
ç›®æ¨™: æ¸©åº¦{target['temperature']:.1f}K, æ¿ƒåº¦{target['concentration']:.3f}

åŠ ç†±é›»åŠ›ï¼ˆ0-10kWï¼‰ã‚’æ¨å¥¨ã—ã¦ãã ã•ã„ã€‚JSONå½¢å¼ã§å›ç­”:
{{"heating_power": float, "reasoning": "ç†ç”±"}}"""

        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ï¼‰
        prompt_hash = hashlib.md5(prompt.encode()).hexdigest()

        try:
            # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã¾ãŸã¯APIå‘¼ã³å‡ºã—
            response = self._cached_llm_call(prompt_hash, prompt)

            # JSONãƒ‘ãƒ¼ã‚¹
            if "```json" in response:
                json_str = response.split("```json")[1].split("```")[0].strip()
            else:
                json_str = response

            result = json.loads(json_str)

            # å®‰å…¨ç¯„å›²ãƒã‚§ãƒƒã‚¯
            power = max(0.0, min(10.0, result['heating_power']))

            if power != result['heating_power']:
                logger.warning(f"Clamped heating power from {result['heating_power']} to {power}")

            return {
                'action': {'heating_power': power},
                'reasoning': result.get('reasoning', 'N/A'),
                'fallback_used': False
            }

        except Exception as e:
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: PIDåˆ¶å¾¡
            logger.warning(f"LLM failed, using fallback PID controller: {e}")
            self.fallback_count += 1

            pid_action = self.fallback_controller.compute(
                state['temperature'],
                target['temperature']
            )

            return {
                'action': {'heating_power': pid_action},
                'reasoning': 'Fallback PID control due to LLM failure',
                'fallback_used': True
            }

    def get_statistics(self) -> Dict:
        """çµ±è¨ˆæƒ…å ±ã‚’å–å¾—"""
        return {
            'api_calls': self.api_call_count,
            'cache_hits': self.cache_hit_count,
            'fallback_uses': self.fallback_count,
            'total_cost_usd': self.total_cost,
            'budget_remaining_usd': self.monthly_budget - self.total_cost
        }


class SimplePIDController:
    """ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨PIDåˆ¶å¾¡å™¨"""

    def __init__(self, Kp: float = 0.5, Ki: float = 0.1, Kd: float = 0.05):
        self.Kp = Kp
        self.Ki = Ki
        self.Kd = Kd
        self.integral = 0.0
        self.prev_error = 0.0

    def compute(self, current: float, setpoint: float) -> float:
        """PIDåˆ¶å¾¡è¨ˆç®—"""
        error = setpoint - current
        self.integral += error
        derivative = error - self.prev_error
        self.prev_error = error

        output = self.Kp * error + self.Ki * self.integral + self.Kd * derivative

        # åŠ ç†±é›»åŠ›ã®ç¯„å›²åˆ¶é™
        return max(0.0, min(10.0, output))


# ä½¿ç”¨ä¾‹
if __name__ == "__main__":
    controller = ProductionLLMController()

    # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: 20ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ
    state = {'temperature': 348.0, 'concentration': 0.30}
    target = {'temperature': 350.0, 'concentration': 0.30}

    for step in range(20):
        print(f"\n=== Step {step + 1} ===")

        # åˆ¶å¾¡åˆ¤æ–­
        decision = controller.llm_control_decision(state, target)

        print(f"Action: {decision['action']}")
        print(f"Reasoning: {decision['reasoning']}")
        print(f"Fallback: {decision['fallback_used']}")

        # çŠ¶æ…‹æ›´æ–°ï¼ˆç°¡æ˜“ãƒ¢ãƒ‡ãƒ«ï¼‰
        heating_power = decision['action']['heating_power']
        state['temperature'] += (heating_power - 5.0) * 0.5  # ç°¡æ˜“ãƒ€ã‚¤ãƒŠãƒŸã‚¯ã‚¹

        # 10ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«çµ±è¨ˆè¡¨ç¤º
        if (step + 1) % 10 == 0:
            stats = controller.get_statistics()
            print(f"\n=== Statistics ===")
            print(f"API Calls: {stats['api_calls']}")
            print(f"Fallback Uses: {stats['fallback_uses']}")
            print(f"Total Cost: ${stats['total_cost_usd']:.2f}")
            print(f"Budget Remaining: ${stats['budget_remaining_usd']:.2f}")

    # æœ€çµ‚çµ±è¨ˆ
    final_stats = controller.get_statistics()
    print(f"\n=== Final Statistics ===")
    for key, value in final_stats.items():
        print(f"{key}: {value}")

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:
# === Step 1 ===
# Cache miss for hash a3b5f21c. Calling API...
# API call #1, Cost: $0.0032, Total: $0.00
# Action: {'heating_power': 5.5}
# Reasoning: æ¸©åº¦ãŒç›®æ¨™ã‚ˆã‚Š2Kä½ã„ãŸã‚ã€åŠ ç†±é›»åŠ›ã‚’ä¸­ç¨‹åº¦ã«å¢—åŠ 
# Fallback: False
#
# === Step 2 ===
# Action: {'heating_power': 5.5}  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ
# Reasoning: æ¸©åº¦ãŒç›®æ¨™ã‚ˆã‚Š2Kä½ã„ãŸã‚ã€åŠ ç†±é›»åŠ›ã‚’ä¸­ç¨‹åº¦ã«å¢—åŠ 
# Fallback: False
# ...
#
# === Statistics ===
# API Calls: 5
# Fallback Uses: 0
# Total Cost: $0.02
# Budget Remaining: $999.98
</code></pre>

            <div class="warning-box">
                <p><strong>âš ï¸ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ</strong></p>
                <ol>
                    <li><strong>å¿…ãšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿæ§‹ã‚’å®Ÿè£…</strong>: APIéšœå®³æ™‚ã§ã‚‚ãƒ—ãƒ­ã‚»ã‚¹ã¯å®‰å…¨ã«é‹è»¢ç¶™ç¶š</li>
                    <li><strong>äºˆç®—ç®¡ç†</strong>: æœˆé–“ã‚³ã‚¹ãƒˆä¸Šé™ã‚’è¨­å®šã—ã€è¶…éæ™‚ã¯ã‚¢ãƒ©ãƒ¼ãƒˆ</li>
                    <li><strong>ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å¯¾ç­–</strong>: LLMå‘¼ã³å‡ºã—ã‚’éåŒæœŸåŒ–ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨</li>
                    <li><strong>ç›£æŸ»ãƒ­ã‚°</strong>: å…¨ã¦ã®LLMåˆ¤æ–­ã¨ç†ç”±ã‚’è¨˜éŒ²ï¼ˆè¦åˆ¶å¯¾å¿œï¼‰</li>
                    <li><strong>æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤</strong>: ã¾ãšã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆææ¡ˆã®ã¿ï¼‰â†’ç›£è¦–ä»˜ãè‡ªå‹•åˆ¶å¾¡â†’å®Œå…¨è‡ªå‹•</li>
                </ol>
            </div>
        </div>

        <div class="content-box">
            <h2>å­¦ç¿’ç›®æ¨™ã®ç¢ºèª</h2>

            <p>ã“ã®ç« ã‚’å®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã‚’èª¬æ˜ãƒ»å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š</p>

            <h3>åŸºæœ¬ç†è§£</h3>
            <ul>
                <li>âœ… LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é•ã„ã¨ç›¸è£œæ€§ã‚’èª¬æ˜ã§ãã‚‹</li>
                <li>âœ… Tool Useï¼ˆFunction Callingï¼‰ã®ä»•çµ„ã¿ã‚’ç†è§£ã—ã¦ã„ã‚‹</li>
                <li>âœ… LangChainã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æ§‹æˆè¦ç´ ã‚’çŸ¥ã£ã¦ã„ã‚‹</li>
                <li>âœ… ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ©ç‚¹ã‚’åˆ—æŒ™ã§ãã‚‹</li>
            </ul>

            <h3>å®Ÿè·µã‚¹ã‚­ãƒ«</h3>
            <ul>
                <li>âœ… Claude API / OpenAI APIã‚’ç”¨ã„ãŸLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã§ãã‚‹</li>
                <li>âœ… Tool Useã§å¤–éƒ¨é–¢æ•°ï¼ˆã‚»ãƒ³ã‚µãƒ¼å–å¾—ã€åˆ¶å¾¡å®Ÿè¡Œï¼‰ã‚’çµ±åˆã§ãã‚‹</li>
                <li>âœ… LangChainã§ãƒ¡ãƒ¢ãƒªä»˜ãã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã§ãã‚‹</li>
                <li>âœ… LLM Coordinatorã¨RL Workersã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã§ãã‚‹</li>
                <li>âœ… æœ¬ç•ªç’°å¢ƒå¯¾å¿œã®å®‰å…¨æ©Ÿæ§‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€äºˆç®—ç®¡ç†ï¼‰ã‚’å®Ÿè£…ã§ãã‚‹</li>
            </ul>

            <h3>å¿œç”¨åŠ›</h3>
            <ul>
                <li>âœ… ãƒ—ãƒ­ã‚»ã‚¹ç•°å¸¸è¨ºæ–­ã«LLMã‚’é©ç”¨ã§ãã‚‹</li>
                <li>âœ… äººé–“ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã¨ã®å”èª¿ä½œæ¥­ã‚·ã‚¹ãƒ†ãƒ ã‚’è¨­è¨ˆã§ãã‚‹</li>
                <li>âœ… LLMã®ã‚³ã‚¹ãƒˆã¨ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’è€ƒæ…®ã—ãŸã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’é¸æŠã§ãã‚‹</li>
                <li>âœ… å®Ÿãƒ—ãƒ©ãƒ³ãƒˆå±•é–‹æ™‚ã®å®‰å…¨æ€§ã¨ãƒ­ãƒã‚¹ãƒˆæ€§ã‚’ç¢ºä¿ã§ãã‚‹</li>
            </ul>
        </div>

        <div class="content-box">
            <h2>æ¼”ç¿’å•é¡Œ</h2>

            <h3>Easyï¼ˆåŸºç¤ç¢ºèªï¼‰</h3>

            <p><strong>Q1</strong>: LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä¸»ãªé•ã„ã¯ä½•ã§ã™ã‹ï¼Ÿ</p>
            <details>
                <summary>è§£ç­”ã‚’è¦‹ã‚‹</summary>
                <p><strong>æ­£è§£</strong>:</p>
                <ul>
                    <li><strong>å­¦ç¿’æ–¹æ³•</strong>: RLã¯è©¦è¡ŒéŒ¯èª¤ã§å­¦ç¿’ã€LLMã¯äº‹å‰å­¦ç¿’æ¸ˆã¿ï¼ˆæ¨è«–ã®ã¿ï¼‰</li>
                    <li><strong>æ¨è«–é€Ÿåº¦</strong>: RLã¯é«˜é€Ÿï¼ˆmså˜ä½ï¼‰ã€LLMã¯ä¸­é€Ÿï¼ˆ1-5ç§’ï¼‰</li>
                    <li><strong>èª¬æ˜å¯èƒ½æ€§</strong>: RLã¯ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€LLMã¯è‡ªç„¶è¨€èªã§èª¬æ˜å¯èƒ½</li>
                    <li><strong>æŸ”è»Ÿæ€§</strong>: RLã¯å­¦ç¿’ç¯„å›²å†…ã€LLMã¯æ±ç”¨æ¨è«–å¯èƒ½</li>
                </ul>
                <p><strong>è§£èª¬</strong>: ãã‚Œãã‚Œã®é•·æ‰€ã‚’æ´»ã‹ã—ã€LLMã§é«˜ãƒ¬ãƒ™ãƒ«æˆ¦ç•¥ã€RLã§ä½ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡ã‚’æ‹…å½“ã™ã‚‹ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãŒæœ‰åŠ¹ã§ã™ã€‚</p>
            </details>

            <p><strong>Q2</strong>: Tool Useï¼ˆFunction Callingï¼‰ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ</p>
            <details>
                <summary>è§£ç­”ã‚’è¦‹ã‚‹</summary>
                <p><strong>æ­£è§£</strong>: LLMãŒå¤–éƒ¨é–¢æ•°ï¼ˆAPIã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ãªã©ï¼‰ã‚’å‘¼ã³å‡ºã—ã¦ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æƒ…å ±ã‚’å–å¾—ã—ãŸã‚Šã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ãŸã‚Šã™ã‚‹æ©Ÿèƒ½ã€‚</p>
                <p><strong>è§£èª¬</strong>: ä¾‹ãˆã°ã€LLMãŒã€Œç¾åœ¨ã®æ¸©åº¦ã¯ï¼Ÿã€ã¨ã„ã†è³ªå•ã«ç­”ãˆã‚‹ãŸã‚ã€get_sensor_data()é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã‚»ãƒ³ã‚µãƒ¼å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€LLMã¯é™çš„ãªçŸ¥è­˜ã ã‘ã§ãªãã€å‹•çš„ãªç’°å¢ƒæƒ…å ±ã«ã‚‚åŸºã¥ã„ã¦æ¨è«–ã§ãã¾ã™ã€‚</p>
            </details>

            <h3>Mediumï¼ˆå¿œç”¨ï¼‰</h3>

            <p><strong>Q3</strong>: Example 5ã®æœ¬ç•ªå¯¾å¿œã‚·ã‚¹ãƒ†ãƒ ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹3ã¤ã®å®‰å…¨æ©Ÿæ§‹ã‚’æŒ™ã’ã€ãã‚Œãã‚Œã®ç›®çš„ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</p>
            <details>
                <summary>è§£ç­”ã‚’è¦‹ã‚‹</summary>
                <p><strong>æ­£è§£</strong>:</p>
                <ol>
                    <li><strong>ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¶å¾¡ï¼ˆPIDï¼‰</strong>: APIéšœå®³æ™‚ã§ã‚‚ãƒ—ãƒ­ã‚»ã‚¹ã‚’å®‰å…¨ã«é‹è»¢ç¶™ç¶š</li>
                    <li><strong>äºˆç®—ç®¡ç†</strong>: æœˆé–“ã‚³ã‚¹ãƒˆä¸Šé™ã‚’è¨­å®šã—ã€è¶…éæ™‚ã¯ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»åœæ­¢</li>
                    <li><strong>ç¯„å›²ãƒã‚§ãƒƒã‚¯</strong>: LLMã®æ¨å¥¨å€¤ã‚’ç‰©ç†çš„å®‰å…¨ç¯„å›²ï¼ˆ0-10kWï¼‰ã«åˆ¶é™</li>
                </ol>
                <p><strong>è§£èª¬</strong>: ã“ã‚Œã‚‰ã®å¤šå±¤é˜²å¾¡ã«ã‚ˆã‚Šã€LLMã®ä¸ç¢ºå®Ÿæ€§ã‚’è¨±å®¹ã—ã¤ã¤ã€ãƒ—ãƒ­ã‚»ã‚¹ã®å®‰å…¨æ€§ã‚’ä¿è¨¼ã—ã¾ã™ã€‚</p>
            </details>

            <p><strong>Q4</strong>: LLM-RL Hybridã‚·ã‚¹ãƒ†ãƒ ã§ã€LLM CoordinatorãŒ5ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ç†ç”±ã‚’2ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</p>
            <details>
                <summary>è§£ç­”ã‚’è¦‹ã‚‹</summary>
                <p><strong>æ­£è§£</strong>:</p>
                <ol>
                    <li><strong>ã‚³ã‚¹ãƒˆå‰Šæ¸›</strong>: LLM APIå‘¼ã³å‡ºã—ã¯ã‚³ã‚¹ãƒˆãŒé«˜ã„ï¼ˆ$0.003/callç¨‹åº¦ï¼‰ãŸã‚ã€é »åº¦ã‚’æ¸›ã‚‰ã™</li>
                    <li><strong>ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å›é¿</strong>: LLMæ¨è«–ã¯1-5ç§’ã‹ã‹ã‚‹ãŸã‚ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¶å¾¡ï¼ˆ100mså‘¨æœŸï¼‰ã«ã¯ä¸å‘ã</li>
                </ol>
                <p><strong>è§£èª¬</strong>: LLMã¯æˆ¦ç•¥çš„ãªåˆ¤æ–­ï¼ˆé•·æœŸç›®æ¨™è¨­å®šï¼‰ã«ç‰¹åŒ–ã—ã€RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé«˜é »åº¦ã®åˆ¶å¾¡ãƒ«ãƒ¼ãƒ—ã‚’æ‹…å½“ã™ã‚‹ã“ã¨ã§ã€ä¸¡è€…ã®é•·æ‰€ã‚’æ´»ã‹ã—ã¾ã™ã€‚</p>
            </details>

            <h3>Hardï¼ˆç™ºå±•ï¼‰</h3>

            <p><strong>Q5</strong>: 3ãƒ¦ãƒ‹ãƒƒãƒˆï¼ˆåå¿œå™¨ã€åˆ†é›¢å™¨ã€ç†±äº¤æ›å™¨ï¼‰ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ã€LLM CoordinatorãŒã€Œã‚¨ãƒãƒ«ã‚®ãƒ¼æ¶ˆè²»ã‚’10%å‰Šæ¸›ã—ã¤ã¤ç”Ÿç”£é‡ã‚’ç¶­æŒã€ã¨ã„ã†ç›®æ¨™ã‚’é”æˆã™ã‚‹ãŸã‚ã®æˆ¦ç•¥ã‚’ã€ä»¥ä¸‹ã®åˆ¶ç´„ã‚’è€ƒæ…®ã—ã¦è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚</p>
            <ul>
                <li>åå¿œå™¨: æ¸©åº¦â†“ â†’ åå¿œé€Ÿåº¦â†“ â†’ ç”Ÿç”£é‡â†“</li>
                <li>åˆ†é›¢å™¨: é‚„æµæ¯”â†“ â†’ ã‚¨ãƒãƒ«ã‚®ãƒ¼â†“ã€ç´”åº¦â†“</li>
                <li>ç†±äº¤æ›å™¨: ä¼ç†±ä¿‚æ•°â†‘ â†’ ã‚¨ãƒãƒ«ã‚®ãƒ¼åŠ¹ç‡â†‘</li>
            </ul>

            <details>
                <summary>è§£ç­”ã‚’è¦‹ã‚‹</summary>
                <p><strong>æ¨å¥¨æˆ¦ç•¥</strong>:</p>
                <ol>
                    <li><strong>åå¿œå™¨</strong>: æ¸©åº¦ã‚’2Kä¸‹ã’ã‚‹ï¼ˆ340K â†’ 338Kï¼‰
                        <ul>
                            <li>ç†ç”±: ã‚ãšã‹ãªåå¿œé€Ÿåº¦ä½ä¸‹ï¼ˆ~5%ï¼‰ã§ã‚¨ãƒãƒ«ã‚®ãƒ¼ç¯€ç´„</li>
                            <li>å¯¾ç­–: è§¦åª’æ¿ƒåº¦ã‚’5%å¢—åŠ ã•ã›ã¦åå¿œé€Ÿåº¦ã‚’è£œå„Ÿ</li>
                        </ul>
                    </li>
                    <li><strong>åˆ†é›¢å™¨</strong>: é‚„æµæ¯”ã‚’0.8ã‹ã‚‰0.75ã«å‰Šæ¸›
                        <ul>
                            <li>ç†ç”±: ãƒªãƒœã‚¤ãƒ©ãƒ¼è² è·ã‚’6%å‰Šæ¸›</li>
                            <li>å¯¾ç­–: ç´”åº¦ä½ä¸‹åˆ†ï¼ˆ98% â†’ 97%ï¼‰ã¯ä¸‹æµãƒ—ãƒ­ã‚»ã‚¹ã§è¨±å®¹ç¯„å›²å†…</li>
                        </ul>
                    </li>
                    <li><strong>ç†±äº¤æ›å™¨</strong>: ä¼ç†±é¢ç©ã‚’10%å¢—åŠ ï¼ˆè¿½åŠ æŠ•è³‡ï¼‰
                        <ul>
                            <li>ç†ç”±: å»ƒç†±å›ååŠ¹ç‡ã‚’15%å‘ä¸Š</li>
                            <li>é•·æœŸçš„ãªã‚¨ãƒãƒ«ã‚®ãƒ¼å‰Šæ¸›åŠ¹æœ</li>
                        </ul>
                    </li>
                </ol>
                <p><strong>ç·åˆåŠ¹æœ</strong>:</p>
                <ul>
                    <li>ã‚¨ãƒãƒ«ã‚®ãƒ¼å‰Šæ¸›: 5% + 6% + (-1%) = 10%é”æˆ</li>
                    <li>ç”Ÿç”£é‡: è§¦åª’å¢—åŠ ã§è£œå„Ÿã€ç¶­æŒå¯èƒ½</li>
                </ul>
                <p><strong>LLMã®å½¹å‰²</strong>: ã“ã®è¤‡é›‘ãªãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•åˆ†æã‚’è‡ªç„¶è¨€èªã§æ¨è«–ã—ã€å„RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å…·ä½“çš„ãªè¨­å®šå€¤ã‚’æŒ‡ç¤ºã€‚</p>
            </details>

            <p><strong>Q6ï¼ˆã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰</strong>: Example 2ã®ClaudeProcessControllerã‚’æ‹¡å¼µã—ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š</p>
            <ul>
                <li>æ–°ã—ã„Tool: check_safety_constraints() - å®‰å…¨åˆ¶ç´„é•åã‚’æ¤œå‡º</li>
                <li>å®‰å…¨åˆ¶ç´„é•åæ™‚ã¯ã€LLMãŒè‡ªå‹•çš„ã«ç·Šæ€¥åœæ­¢æ‰‹é †ã‚’ææ¡ˆ</li>
            </ul>

            <details>
                <summary>ãƒ’ãƒ³ãƒˆ</summary>
                <p>Toolå®šç¾©ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š</p>
                <pre><code>{
    "name": "check_safety_constraints",
    "description": "å®‰å…¨åˆ¶ç´„ï¼ˆæ¸©åº¦ã€åœ§åŠ›ã€æ¿ƒåº¦ï¼‰ã®é•åã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚",
    "input_schema": {
        "type": "object",
        "properties": {},
        "required": []
    }
}</code></pre>
                <p>execute_tool()ã«å®Ÿè£…ã‚’è¿½åŠ ã—ã€é•åãŒã‚ã‚Œã°ç·Šæ€¥åœæ­¢æ‰‹é †ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚</p>
            </details>
        </div>

        <div class="content-box">
            <h2>å‚è€ƒæ–‡çŒ®</h2>

            <ol>
                <li>Wei, J., et al. (2022). "Chain-of-Thought Prompting Elicits Reasoning in Large Language Models." <em>NeurIPS 2022</em>.</li>
                <li>Yao, S., et al. (2023). "ReAct: Synergizing Reasoning and Acting in Language Models." <em>ICLR 2023</em>.</li>
                <li>Schick, T., et al. (2023). "Toolformer: Language Models Can Teach Themselves to Use Tools." <em>arXiv:2302.04761</em>.</li>
                <li>Anthropic. (2024). "Claude API Documentation - Tool Use." https://docs.anthropic.com/claude/docs/tool-use</li>
                <li>Chase, H. (2023). "LangChain: Building Applications with LLMs." https://python.langchain.com</li>
                <li>Ahn, M., et al. (2022). "Do As I Can, Not As I Say: Grounding Language in Robotic Affordances." <em>CoRL 2022</em>.</li>
                <li>Liang, J., et al. (2023). "Code as Policies: Language Model Programs for Embodied Control." <em>ICRA 2023</em>.</li>
                <li>Song, C. H., et al. (2023). "LLM-Planner: Few-Shot Grounded Planning for Embodied Agents with Large Language Models." <em>ICCV 2023</em>.</li>
                <li>Huang, W., et al. (2022). "Inner Monologue: Embodied Reasoning through Planning with Language Models." <em>CoRL 2022</em>.</li>
                <li>Kirk, R., et al. (2023). "A Survey of Zero-Shot Generalisation in Deep Reinforcement Learning." <em>JAIR</em>, 76, 201-264.</li>
            </ol>
        </div>

        <div class="content-box">
            <h2>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h2>

            <p>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æœ¬ã‚·ãƒªãƒ¼ã‚ºå…¨6ç« ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚</p>

            <div class="key-point">
                <p><strong>ğŸ“ ç¿’å¾—ã—ãŸã‚¹ã‚­ãƒ«</strong></p>
                <ul>
                    <li>âœ… ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆReactive, Deliberative, Hybridï¼‰</li>
                    <li>âœ… ãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ï¼ˆOpenAI Gymæº–æ‹ ï¼‰</li>
                    <li>âœ… å ±é…¬è¨­è¨ˆã¨æœ€é©åŒ–ç›®çš„</li>
                    <li>âœ… ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå”èª¿åˆ¶å¾¡ï¼ˆQMIX, Communicationï¼‰</li>
                    <li>âœ… å®Ÿãƒ—ãƒ©ãƒ³ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ã¨å®‰å…¨æ€§ï¼ˆCBF, CQLï¼‰</li>
                    <li>âœ… LLMã¨RLã®çµ±åˆï¼ˆTool Use, LangChain, Hybrid Architectureï¼‰</li>
                </ul>
            </div>

            <h3>æ¨å¥¨ã•ã‚Œã‚‹æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>

            <p><strong>çŸ­æœŸï¼ˆ1-2é€±é–“ï¼‰:</strong></p>
            <ul>
                <li>âœ… è‡ªç¤¾ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã‚’æ§‹ç¯‰</li>
                <li>âœ… Chapter 1-6ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã§å®Ÿè¡Œ</li>
                <li>âœ… LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ãƒ—ãƒ­ã‚»ã‚¹è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ</li>
            </ul>

            <p><strong>ä¸­æœŸï¼ˆ1-3ãƒ¶æœˆï¼‰:</strong></p>
            <ul>
                <li>âœ… RLã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã§è¨“ç·´</li>
                <li>âœ… LLM Coordinatorã¨çµ±åˆã—ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰</li>
                <li>âœ… æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤è¨ˆç”»ã‚’ç­–å®šï¼ˆã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ â†’ è‡ªå‹•åˆ¶å¾¡ï¼‰</li>
            </ul>

            <p><strong>é•·æœŸï¼ˆ6ãƒ¶æœˆä»¥ä¸Šï¼‰:</strong></p>
            <ul>
                <li>âœ… ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆãƒ—ãƒ©ãƒ³ãƒˆã§ã®å®Ÿè¨¼è©¦é¨“</li>
                <li>âœ… å®Ÿãƒ—ãƒ©ãƒ³ãƒˆå±•é–‹ã¨é‹ç”¨ãƒ‡ãƒ¼ã‚¿åé›†</li>
                <li>âœ… å­¦ä¼šç™ºè¡¨ãƒ»è«–æ–‡åŸ·ç­†</li>
            </ul>
        </div>

        <div class="nav-buttons">
            <a href="./chapter-5.html">â† ç¬¬5ç« ï¼šå®Ÿãƒ—ãƒ©ãƒ³ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤</a>
            <a href="./index.html">ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡ã«æˆ»ã‚‹</a>
        </div>
    <section class="disclaimer">
<h3>å…è²¬äº‹é …</h3>
<ul>
<li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯æ•™è‚²ãƒ»ç ”ç©¶ãƒ»æƒ…å ±æä¾›ã®ã¿ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€å°‚é–€çš„ãªåŠ©è¨€(æ³•å¾‹ãƒ»ä¼šè¨ˆãƒ»æŠ€è¡“çš„ä¿è¨¼ãªã©)ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
<li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŠã‚ˆã³ä»˜éšã™ã‚‹Code examplesã¯ã€Œç¾çŠ¶æœ‰å§¿(AS IS)ã€ã§æä¾›ã•ã‚Œã€æ˜ç¤ºã¾ãŸã¯é»™ç¤ºã‚’å•ã‚ãšã€å•†å“æ€§ã€ç‰¹å®šç›®çš„é©åˆæ€§ã€æ¨©åˆ©éä¾µå®³ã€æ­£ç¢ºæ€§ãƒ»å®Œå…¨æ€§ã€å‹•ä½œãƒ»å®‰å…¨æ€§ç­‰ã„ã‹ãªã‚‹ä¿è¨¼ã‚‚ã—ã¾ã›ã‚“ã€‚</li>
<li>å¤–éƒ¨ãƒªãƒ³ã‚¯ã€ç¬¬ä¸‰è€…ãŒæä¾›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ»ãƒ„ãƒ¼ãƒ«ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç­‰ã®å†…å®¹ãƒ»å¯ç”¨æ€§ãƒ»å®‰å…¨æ€§ã«ã¤ã„ã¦ã€ä½œæˆè€…ãŠã‚ˆã³æ±åŒ—å¤§å­¦ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
<li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ©ç”¨ãƒ»å®Ÿè¡Œãƒ»è§£é‡ˆã«ã‚ˆã‚Šç›´æ¥çš„ãƒ»é–“æ¥çš„ãƒ»ä»˜éšçš„ãƒ»ç‰¹åˆ¥ãƒ»çµæœçš„ãƒ»æ‡²ç½°çš„æå®³ãŒç”Ÿã˜ãŸå ´åˆã§ã‚‚ã€é©ç”¨æ³•ã§è¨±å®¹ã•ã‚Œã‚‹æœ€å¤§é™ã®ç¯„å›²ã§ã€ä½œæˆè€…ãŠã‚ˆã³æ±åŒ—å¤§å­¦ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
<li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å†…å®¹ã¯ã€äºˆå‘Šãªãå¤‰æ›´ãƒ»æ›´æ–°ãƒ»æä¾›åœæ­¢ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</li>
<li>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è‘—ä½œæ¨©ãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯æ˜è¨˜ã•ã‚ŒãŸæ¡ä»¶(ä¾‹: CC BY 4.0)ã«å¾“ã„ã¾ã™ã€‚å½“è©²ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯é€šå¸¸ã€ç„¡ä¿è¨¼æ¡é …ã‚’å«ã¿ã¾ã™ã€‚</li>
</ul>
</section>

</main>

    <footer>
        <div class="container">
            <p>&copy; 2025 PI Knowledge Hub - Dr. Yusuke Hashimoto, Tohoku University</p>
            <p>Licensed under CC BY 4.0</p>
        </div>
    </footer>
</body>
</html>
