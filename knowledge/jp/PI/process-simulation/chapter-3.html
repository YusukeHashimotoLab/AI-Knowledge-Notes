<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç¬¬3ç« ï¼šå˜ä½æ“ä½œã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚° - ãƒ—ãƒ­ã‚»ã‚¹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¥é–€ã‚·ãƒªãƒ¼ã‚º">
    <title>ç¬¬3ç« ï¼šå˜ä½æ“ä½œã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚° - ãƒ—ãƒ­ã‚»ã‚¹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¥é–€ | PI Terakoya</title>

        <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.8; color: #333; background: #f5f5f5;
        }
        header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; padding: 2rem 1rem; text-align: center;
        }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .subtitle { opacity: 0.9; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .back-link {
            display: inline-block; margin-bottom: 2rem; padding: 0.5rem 1rem;
            background: white; color: #11998e; text-decoration: none;
            border-radius: 6px; font-weight: 600;
        }
        .content-box {
            background: white; padding: 2rem; border-radius: 12px;
            margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #11998e; margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem; border-bottom: 3px solid #11998e;
        }
        h3 { color: #2c3e50; margin: 1.5rem 0 1rem 0; }
        h4 { color: #2c3e50; margin: 1rem 0 0.5rem 0; }
        p { margin-bottom: 1rem; }
        ul, ol { margin-left: 2rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
        pre {
            background: #1e1e1e; color: #d4d4d4; padding: 1.5rem;
            border-radius: 8px; overflow-x: auto; margin: 1rem 0;
            border-left: 4px solid #11998e;
        }
        code {
            font-family: 'Courier New', monospace; font-size: 0.9rem;
        }
        .key-point {
            background: #e8f5e9; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #4caf50; margin: 1rem 0;
        }
        .tech-note {
            background: #e3f2fd; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #2196f3; margin: 1rem 0;
        }
        .formula {
            background: #f0f7ff; padding: 1rem; border-radius: 6px;
            margin: 1rem 0; overflow-x: auto;
        }
        table {
            width: 100%; border-collapse: collapse; margin: 1rem 0;
        }
        th, td {
            border: 1px solid #ddd; padding: 0.75rem; text-align: left;
        }
        th {
            background: #11998e; color: white; font-weight: 600;
        }
        tr:nth-child(even) { background: #f9f9f9; }
        .nav-buttons {
            display: flex; justify-content: space-between; margin-top: 3rem;
        }
        .nav-buttons a {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; text-decoration: none; border-radius: 6px;
            font-weight: 600;
        }
        footer {
            background: #2c3e50; color: white; text-align: center;
            padding: 2rem 1rem; margin-top: 4rem;
        }
        @media (max-width: 768px) {
            h1 { font-size: 1.6rem; }
            .container { padding: 0 0.5rem; }
            pre { padding: 1rem; }
        }
    
        /* Breadcrumb styles */
        .breadcrumb {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .breadcrumb-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a0aec0;
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: #4a5568;
            font-weight: 500;
        }
    </style>
</head>
<body>
        <nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="/wp/knowledge/jp/index.html">AIå¯ºå­å±‹ãƒˆãƒƒãƒ—</a><span class="breadcrumb-separator">â€º</span><a href="/wp/knowledge/jp/PI/index.html">ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹</a><span class="breadcrumb-separator">â€º</span><a href="/wp/knowledge/jp/PI/process-simulation/index.html">Process Simulation</a><span class="breadcrumb-separator">â€º</span><span class="breadcrumb-current">Chapter 3</span>
        </div>
    </nav>

    <header>
        <div class="container">
            <h1>ç¬¬3ç« ï¼šå˜ä½æ“ä½œã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</h1>
            <p class="subtitle">è’¸ç•™ãƒ»å¸åãƒ»åå¿œå™¨ãƒ»ç†±äº¤æ›å™¨ã®å·¥å­¦çš„ãƒ¢ãƒ‡ãƒ«å®Ÿè£…</p>
            <div class="meta">
                <span class="meta">ğŸ“– èª­äº†æ™‚é–“: 40-45åˆ†</span>
                <span class="meta">ğŸ’» é›£æ˜“åº¦: ä¸­ç´šã€œä¸Šç´š</span>
                <span class="meta">ğŸ¯ å®Ÿè·µæ¼”ç¿’: 8ã¤</span>
            </div>
        </div>
    </header>

    <main class="container">
        <section>
            <h2>3.1 è’¸ç•™å¡”ã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</h2>
            <p>
                è’¸ç•™ã¯åŒ–å­¦ãƒ—ãƒ­ã‚»ã‚¹ã§æœ€ã‚‚é‡è¦ãªåˆ†é›¢æ“ä½œã®ä¸€ã¤ã§ã™ã€‚McCabe-Thieleæ³•ã€Fenske-Underwood-Gillilandæ³•ãªã©ã®
                çŸ­çµ¡æ³•ã‚’ä½¿ç”¨ã—ã¦ã€å¿…è¦æ®µæ•°ã‚„é‚„æµæ¯”ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
            </p>

            <h3>3.1.1 McCabe-Thieleæ³•ã«ã‚ˆã‚‹æ®µæ•°è¨ˆç®—</h3>
            <p>
                äºŒæˆåˆ†ç³»è’¸ç•™ã§ã€æ°—æ¶²å¹³è¡¡æ›²ç·šã¨æ“ä½œç·šã‹ã‚‰ç†è«–æ®µæ•°ã‚’å›³è§£çš„ã«æ±‚ã‚ã‚‹å¤å…¸çš„æ‰‹æ³•ã‚’Pythonã§å®Ÿè£…ã—ã¾ã™ã€‚
            </p>

            <div class="example-box">
                <h4>ä¾‹é¡Œ1ï¼šãƒ™ãƒ³ã‚¼ãƒ³-ãƒˆãƒ«ã‚¨ãƒ³ç³»ã®è’¸ç•™å¡”è¨­è¨ˆ</h4>
                <p>
                    ä¾›çµ¦çµ„æˆ50mol%ã€ç•™å‡ºç‰©çµ„æˆ95mol%ã€ç¼¶å‡ºç‰©çµ„æˆ5mol%ã€é‚„æµæ¯”R=2.0ã®æ¡ä»¶ã§å¿…è¦æ®µæ•°ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
                </p>
            </div>

            <pre><code>import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import fsolve

class McCabeThiele:
    """McCabe-Thieleæ³•ã«ã‚ˆã‚‹è’¸ç•™å¡”æ®µæ•°è¨ˆç®—"""

    def __init__(self, x_F, x_D, x_B, q, R, alpha):
        """
        Args:
            x_F (float): ä¾›çµ¦çµ„æˆï¼ˆè»½è³ªæˆåˆ†ãƒ¢ãƒ«åˆ†ç‡ï¼‰
            x_D (float): ç•™å‡ºç‰©çµ„æˆ
            x_B (float): ç¼¶å‡ºç‰©çµ„æˆ
            q (float): ä¾›çµ¦çŠ¶æ…‹ï¼ˆqç·šã®å‚¾ãã€é£½å’Œæ¶²ä½“=1.0ï¼‰
            R (float): é‚„æµæ¯”
            alpha (float): ç›¸å¯¾æ®ç™ºåº¦
        """
        self.x_F = x_F
        self.x_D = x_D
        self.x_B = x_B
        self.q = q
        self.R = R
        self.alpha = alpha

    def equilibrium_curve(self, x):
        """æ°—æ¶²å¹³è¡¡æ›²ç·šï¼ˆç›¸å¯¾æ®ç™ºåº¦ä¸€å®šï¼‰"""
        return (self.alpha * x) / (1 + (self.alpha - 1) * x)

    def rectifying_operating_line(self, x):
        """ç²¾ç•™éƒ¨æ“ä½œç·š"""
        return (self.R / (self.R + 1)) * x + self.x_D / (self.R + 1)

    def stripping_operating_line(self, x):
        """å›åéƒ¨æ“ä½œç·š"""
        # äº¤ç‚¹ã‚’æ±‚ã‚ã‚‹ï¼ˆqç·šã¨ã®äº¤ç‚¹ï¼‰
        x_q = self._find_q_intersection()

        # å›åéƒ¨æ“ä½œç·šã®å‚¾ã
        L_bar_over_V_bar = self._calculate_stripping_slope()

        return L_bar_over_V_bar * (x - self.x_B) + self.x_B

    def _find_q_intersection(self):
        """qç·šã¨ç²¾ç•™éƒ¨æ“ä½œç·šã®äº¤ç‚¹"""
        def equations(x):
            y_rect = self.rectifying_operating_line(x)
            # qç·š: y = (q/(q-1)) * x - x_F/(q-1)
            if abs(self.q - 1.0) < 1e-6:
                # é£½å’Œæ¶²ä½“ã®å ´åˆã€x = x_F
                return x - self.x_F
            else:
                y_q = (self.q / (self.q - 1)) * x - self.x_F / (self.q - 1)
                return y_rect - y_q

        x_q = fsolve(equations, self.x_F)[0]
        return x_q

    def _calculate_stripping_slope(self):
        """å›åéƒ¨æ“ä½œç·šã®å‚¾ãè¨ˆç®—"""
        x_q = self._find_q_intersection()
        y_q = self.rectifying_operating_line(x_q)

        # 2ç‚¹ (x_B, x_B) ã¨ (x_q, y_q) ã‚’é€šã‚‹ç›´ç·šã®å‚¾ã
        slope = (y_q - self.x_B) / (x_q - self.x_B)
        return slope

    def calculate_stages(self):
        """ç†è«–æ®µæ•°ã‚’è¨ˆç®—"""
        stages = []
        x = self.x_D
        y = self.x_D
        stage_count = 0
        max_stages = 100

        while x > self.x_B and stage_count < max_stages:
            # æ°—æ¶²å¹³è¡¡ï¼ˆå‚ç›´ç·š: yä¸€å®šã§xã‚’æ±‚ã‚ã‚‹ï¼‰
            def eq(x_new):
                return self.equilibrium_curve(x_new) - y
            x_new = fsolve(eq, x)[0]

            stages.append((x, y, x_new, y))

            # æ“ä½œç·šï¼ˆæ°´å¹³ç·š: xä¸€å®šã§yã‚’æ±‚ã‚ã‚‹ï¼‰
            x = x_new
            x_q = self._find_q_intersection()

            if x >= x_q:
                # ç²¾ç•™éƒ¨
                y_new = self.rectifying_operating_line(x)
            else:
                # å›åéƒ¨
                y_new = self.stripping_operating_line(x)

            stages.append((x, y, x, y_new))
            y = y_new
            stage_count += 1

        return stages, stage_count

    def plot_diagram(self, filename=None):
        """McCabe-Thieleç·šå›³ã‚’ãƒ—ãƒ­ãƒƒãƒˆ"""
        x = np.linspace(0, 1, 100)

        # å„æ›²ç·š
        y_eq = self.equilibrium_curve(x)
        y_rect = self.rectifying_operating_line(x)

        # å›åéƒ¨æ“ä½œç·š
        x_strip = np.linspace(self.x_B, self._find_q_intersection(), 50)
        y_strip = [self.stripping_operating_line(xi) for xi in x_strip]

        # æ®µæ•°æç”»
        stages, N = self.calculate_stages()

        plt.figure(figsize=(10, 8))

        # å„ç·šã‚’ãƒ—ãƒ­ãƒƒãƒˆ
        plt.plot(x, y_eq, 'b-', linewidth=2, label='æ°—æ¶²å¹³è¡¡ç·š')
        plt.plot(x, x, 'k--', linewidth=1, label='y=x')
        plt.plot(x, y_rect, 'r-', linewidth=1.5, label='ç²¾ç•™éƒ¨æ“ä½œç·š')
        plt.plot(x_strip, y_strip, 'g-', linewidth=1.5, label='å›åéƒ¨æ“ä½œç·š')

        # qç·š
        if abs(self.q - 1.0) > 1e-6:
            x_q_line = np.linspace(self.x_B, self.x_D, 50)
            y_q_line = (self.q / (self.q - 1)) * x_q_line - self.x_F / (self.q - 1)
            plt.plot(x_q_line, y_q_line, 'm--', linewidth=1, label='qç·š')
        else:
            plt.axvline(x=self.x_F, color='m', linestyle='--', linewidth=1,
                       label='qç·šï¼ˆé£½å’Œæ¶²ä½“ï¼‰')

        # æ®µæ•°éšæ®µ
        for i, stage in enumerate(stages):
            x1, y1, x2, y2 = stage
            plt.plot([x1, x2], [y1, y2], 'k-', linewidth=0.8, alpha=0.6)

        plt.xlabel('æ¶²ç›¸çµ„æˆ x (è»½è³ªæˆåˆ†)', fontsize=12)
        plt.ylabel('æ°—ç›¸çµ„æˆ y (è»½è³ªæˆåˆ†)', fontsize=12)
        plt.title(f'McCabe-Thieleç·šå›³ (ç†è«–æ®µæ•°: {N}æ®µ)', fontsize=14)
        plt.legend(loc='upper left', fontsize=10)
        plt.grid(True, alpha=0.3)
        plt.xlim(0, 1)
        plt.ylim(0, 1)

        if filename:
            plt.savefig(filename, dpi=150, bbox_inches='tight')
        plt.close()

        return N

# å®Ÿè·µä¾‹ï¼šãƒ™ãƒ³ã‚¼ãƒ³-ãƒˆãƒ«ã‚¨ãƒ³è’¸ç•™
x_F = 0.50  # ä¾›çµ¦çµ„æˆ
x_D = 0.95  # ç•™å‡ºç‰©çµ„æˆ
x_B = 0.05  # ç¼¶å‡ºç‰©çµ„æˆ
q = 1.0     # é£½å’Œæ¶²ä½“ä¾›çµ¦
R = 2.0     # é‚„æµæ¯”
alpha = 2.5 # ãƒ™ãƒ³ã‚¼ãƒ³/ãƒˆãƒ«ã‚¨ãƒ³ã®ç›¸å¯¾æ®ç™ºåº¦ï¼ˆ80Â°Cä»˜è¿‘ï¼‰

mt = McCabeThiele(x_F, x_D, x_B, q, R, alpha)
stages, N_theoretical = mt.calculate_stages()

print("=" * 60)
print("McCabe-Thieleæ³•ã«ã‚ˆã‚‹è’¸ç•™å¡”è¨­è¨ˆ")
print("=" * 60)
print(f"\næ¡ä»¶:")
print(f"  ä¾›çµ¦çµ„æˆ (x_F): {x_F*100:.0f}%")
print(f"  ç•™å‡ºç‰©çµ„æˆ (x_D): {x_D*100:.0f}%")
print(f"  ç¼¶å‡ºç‰©çµ„æˆ (x_B): {x_B*100:.0f}%")
print(f"  é‚„æµæ¯” (R): {R}")
print(f"  ç›¸å¯¾æ®ç™ºåº¦ (Î±): {alpha}")

print(f"\nçµæœ:")
print(f"  ç†è«–æ®µæ•°: {N_theoretical}æ®µ")
print(f"  ä¾›çµ¦æ®µä½ç½®: {N_theoretical // 2}æ®µä»˜è¿‘ï¼ˆæ¦‚ç®—ï¼‰")

# åŠ¹ç‡ã‚’è€ƒæ…®ã—ãŸå®Ÿæ®µæ•°
efficiency = 0.70  # æ®µåŠ¹ç‡70%
N_actual = int(np.ceil(N_theoretical / efficiency))
print(f"  æ®µåŠ¹ç‡: {efficiency*100:.0f}%")
print(f"  å®Ÿæ®µæ•°: {N_actual}æ®µ")

# ç·šå›³ãƒ—ãƒ­ãƒƒãƒˆ
# mt.plot_diagram('mccabe_thiele.png')  # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã™ã‚‹å ´åˆ

# å‡ºåŠ›ä¾‹:
# ==============================================================
# McCabe-Thieleæ³•ã«ã‚ˆã‚‹è’¸ç•™å¡”è¨­è¨ˆ
# ==============================================================
#
# æ¡ä»¶:
#   ä¾›çµ¦çµ„æˆ (x_F): 50%
#   ç•™å‡ºç‰©çµ„æˆ (x_D): 95%
#   ç¼¶å‡ºç‰©çµ„æˆ (x_B): 5%
#   é‚„æµæ¯” (R): 2.0
#   ç›¸å¯¾æ®ç™ºåº¦ (Î±): 2.5
#
# çµæœ:
#   ç†è«–æ®µæ•°: 9æ®µ
#   ä¾›çµ¦æ®µä½ç½®: 4æ®µä»˜è¿‘ï¼ˆæ¦‚ç®—ï¼‰
#   æ®µåŠ¹ç‡: 70%
#   å®Ÿæ®µæ•°: 13æ®µ
</code></pre>

            <h3>3.1.2 Fenske-Underwood-GillilandçŸ­çµ¡æ³•</h3>
            <p>
                æœ€å°é‚„æµæ¯”ãƒ»æœ€å°æ®µæ•°ã‚’è¨ˆç®—ã—ã€å®Ÿéš›ã®é‹è»¢æ¡ä»¶ã§ã®æ®µæ•°ã‚’æ¨ç®—ã™ã‚‹çŸ­çµ¡æ³•ã§ã™ã€‚
                è¨­è¨ˆåˆæœŸæ®µéšã§è¿…é€Ÿã«å¡”ä»•æ§˜ã‚’è¦‹ç©ã‚‚ã‚‹ã®ã«æœ‰ç”¨ã§ã™ã€‚
            </p>

            <div class="example-box">
                <h4>ä¾‹é¡Œ2ï¼šFenske-Underwoodæ³•ã«ã‚ˆã‚‹è’¸ç•™å¡”ç°¡æ˜“è¨­è¨ˆ</h4>
                <p>
                    å¤šæˆåˆ†ç³»è’¸ç•™ã§ã€æœ€å°æ®µæ•°ï¼ˆå…¨é‚„æµï¼‰ã¨æœ€å°é‚„æµæ¯”ã‚’è¨ˆç®—ã—ã€Gillilandç›¸é–¢ã§å®Ÿæ®µæ•°ã‚’æ¨ç®—ã—ã¾ã™ã€‚
                </p>
            </div>

            <pre><code>import numpy as np
import matplotlib.pyplot as plt

class FenskeUnderwoodGilliland:
    """Fenske-Underwood-GillilandçŸ­çµ¡æ³•"""

    def __init__(self, components, x_F, x_D, x_B, alpha):
        """
        Args:
            components (list): æˆåˆ†åãƒªã‚¹ãƒˆ
            x_F (dict): ä¾›çµ¦çµ„æˆ {æˆåˆ†: ãƒ¢ãƒ«åˆ†ç‡}
            x_D (dict): ç•™å‡ºç‰©çµ„æˆ
            x_B (dict): ç¼¶å‡ºç‰©çµ„æˆ
            alpha (dict): ç›¸å¯¾æ®ç™ºåº¦ {æˆåˆ†: Î±å€¤}
        """
        self.components = components
        self.x_F = x_F
        self.x_D = x_D
        self.x_B = x_B
        self.alpha = alpha

        # è»½è³ªæˆåˆ†(LK)ã¨é‡è³ªæˆåˆ†(HK)ã‚’ç‰¹å®š
        self.LK = components[0]  # æœ€ã‚‚è»½ã„
        self.HK = components[-1]  # æœ€ã‚‚é‡ã„

    def fenske_minimum_stages(self):
        """Fenskeå¼: æœ€å°æ®µæ•°ï¼ˆå…¨é‚„æµæ™‚ï¼‰"""
        # N_min = log[(x_D,LK/x_D,HK) * (x_B,HK/x_B,LK)] / log(Î±_LK/Î±_HK)
        ratio_D = self.x_D[self.LK] / self.x_D[self.HK]
        ratio_B = self.x_B[self.HK] / self.x_B[self.LK]
        alpha_avg = self.alpha[self.LK] / self.alpha[self.HK]

        N_min = np.log(ratio_D * ratio_B) / np.log(alpha_avg)

        return N_min

    def underwood_minimum_reflux(self):
        """Underwoodå¼: æœ€å°é‚„æµæ¯”"""
        # ç°¡ç•¥åŒ–: äºŒæˆåˆ†ç³»è¿‘ä¼¼
        # R_min = (1/(Î±-1)) * [(x_D,LK - x_F,LK) / x_F,LK]

        alpha_LK = self.alpha[self.LK]
        x_D_LK = self.x_D[self.LK]
        x_F_LK = self.x_F[self.LK]

        # ã‚ˆã‚Šæ­£ç¢ºãªUnderwoodæ–¹ç¨‹å¼ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        theta = self._solve_underwood_theta()

        # ç²¾ç•™éƒ¨ã®Underwoodæ–¹ç¨‹å¼
        sum_term = 0.0
        for comp in self.components:
            sum_term += (self.alpha[comp] * self.x_D[comp]) / (self.alpha[comp] - theta)

        R_min = sum_term - 1.0

        return max(R_min, 0.5)  # è² ã«ãªã‚‰ãªã„ã‚ˆã†ã«

    def _solve_underwood_theta(self):
        """Underwoodã®Î¸ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è§£ã"""
        # ç°¡ç•¥åŒ–: å¹³å‡å€¤ã‚’ä½¿ç”¨
        alpha_values = [self.alpha[c] for c in self.components]
        theta = np.mean(alpha_values)
        return theta

    def gilliland_correlation(self, R):
        """Gillilandç›¸é–¢: å®Ÿæ®µæ•°ã®æ¨ç®—"""
        N_min = self.fenske_minimum_stages()
        R_min = self.underwood_minimum_reflux()

        # Gillilandå¤‰æ•°
        X = (R - R_min) / (R + 1)

        # Gillilandç›¸é–¢ï¼ˆEduljeeæ”¹è‰¯å¼ï¼‰
        Y = 1 - np.exp((1 + 54.4*X) / (11 + 117.2*X) * (X - 1) / X**0.5)

        # ç†è«–æ®µæ•°
        N = (Y + N_min) / (1 - Y)

        return N

    def calculate_design(self, R_actual):
        """è’¸ç•™å¡”è¨­è¨ˆè¨ˆç®—ã®çµ±åˆ"""
        N_min = self.fenske_minimum_stages()
        R_min = self.underwood_minimum_reflux()
        N_actual = self.gilliland_correlation(R_actual)

        # ä¾›çµ¦æ®µä½ç½®ï¼ˆKirkbrideå¼ã®ç°¡ç•¥ç‰ˆï¼‰
        N_rect = N_actual * 0.6  # ç²¾ç•™éƒ¨
        N_strip = N_actual * 0.4  # å›åéƒ¨

        return {
            'N_min': N_min,
            'R_min': R_min,
            'N_theoretical': N_actual,
            'N_rectifying': N_rect,
            'N_stripping': N_strip,
            'feed_stage': int(N_rect)
        }

# å®Ÿè·µä¾‹ï¼šãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³-ãƒ—ãƒ­ãƒ‘ãƒ³è’¸ç•™ï¼ˆC3ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ï¼‰
components = ['Propylene', 'Propane']

x_F = {'Propylene': 0.60, 'Propane': 0.40}
x_D = {'Propylene': 0.995, 'Propane': 0.005}
x_B = {'Propylene': 0.005, 'Propane': 0.995}

alpha = {'Propylene': 1.15, 'Propane': 1.0}  # ç›¸å¯¾æ®ç™ºåº¦ï¼ˆPropaneåŸºæº–ï¼‰

fug = FenskeUnderwoodGilliland(components, x_F, x_D, x_B, alpha)

# é‹è»¢æ¡ä»¶ã”ã¨ã«è¨ˆç®—
R_values = [1.5, 2.0, 3.0, 5.0]

print("=" * 60)
print("Fenske-Underwood-Gillilandæ³•ã«ã‚ˆã‚‹è’¸ç•™å¡”è¨­è¨ˆ")
print("=" * 60)
print(f"\nç³»: {components[0]} / {components[1]}")
print(f"ä¾›çµ¦çµ„æˆ: {x_F[components[0]]*100:.1f}% / {x_F[components[1]]*100:.1f}%")
print(f"è£½å“ä»•æ§˜:")
print(f"  ç•™å‡ºç‰©: {x_D[components[0]]*100:.2f}% {components[0]}")
print(f"  ç¼¶å‡ºç‰©: {x_B[components[1]]*100:.2f}% {components[1]}")

N_min = fug.fenske_minimum_stages()
R_min = fug.underwood_minimum_reflux()

print(f"\nè¨­è¨ˆåŸºæº–å€¤:")
print(f"  æœ€å°æ®µæ•° (N_min, å…¨é‚„æµ): {N_min:.1f}æ®µ")
print(f"  æœ€å°é‚„æµæ¯” (R_min): {R_min:.2f}")

print(f"\né‹è»¢æ¡ä»¶åˆ¥ã®æ®µæ•°:")
print(f"{'é‚„æµæ¯” R':<12} {'ç†è«–æ®µæ•°':<12} {'ç²¾ç•™éƒ¨':<12} {'å›åéƒ¨':<12} {'ä¾›çµ¦æ®µ'}")
print("-" * 60)

for R in R_values:
    result = fug.calculate_design(R)
    print(f"{R:<12.1f} {result['N_theoretical']:<12.1f} "
          f"{result['N_rectifying']:<12.1f} {result['N_stripping']:<12.1f} "
          f"{result['feed_stage']}")

# åŠ¹ç‡è€ƒæ…®
efficiency = 0.50  # C3ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ã¯åŠ¹ç‡ãŒä½ã„ï¼ˆÎ±â‰ˆ1.15ï¼‰
print(f"\næ®µåŠ¹ç‡: {efficiency*100:.0f}%")
print(f"å®Ÿæ®µæ•°ï¼ˆR=2.0ã®å ´åˆï¼‰: {int(np.ceil(fug.calculate_design(2.0)['N_theoretical'] / efficiency))}æ®µ")

# å‡ºåŠ›ä¾‹:
# ==============================================================
# Fenske-Underwood-Gillilandæ³•ã«ã‚ˆã‚‹è’¸ç•™å¡”è¨­è¨ˆ
# ==============================================================
#
# ç³»: Propylene / Propane
# ä¾›çµ¦çµ„æˆ: 60.0% / 40.0%
# è£½å“ä»•æ§˜:
#   ç•™å‡ºç‰©: 99.50% Propylene
#   ç¼¶å‡ºç‰©: 99.50% Propane
#
# è¨­è¨ˆåŸºæº–å€¤:
#   æœ€å°æ®µæ•° (N_min, å…¨é‚„æµ): 76.3æ®µ
#   æœ€å°é‚„æµæ¯” (R_min): 8.52
#
# é‹è»¢æ¡ä»¶åˆ¥ã®æ®µæ•°:
# é‚„æµæ¯” R      ç†è«–æ®µæ•°        ç²¾ç•™éƒ¨         å›åéƒ¨         ä¾›çµ¦æ®µ
# ------------------------------------------------------------
# 1.5          227.9        136.7        91.1         136
# 2.0          174.6        104.7        69.8         104
# 3.0          133.0        79.8         53.2         79
# 5.0          107.5        64.5         43.0         64
#
# æ®µåŠ¹ç‡: 50%
# å®Ÿæ®µæ•°ï¼ˆR=2.0ã®å ´åˆï¼‰: 350æ®µ
</code></pre>
        </section>

        <section>
            <h2>3.2 ãƒ•ãƒ©ãƒƒã‚·ãƒ¥åˆ†é›¢å™¨ã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</h2>
            <p>
                ãƒ•ãƒ©ãƒƒã‚·ãƒ¥åˆ†é›¢ã¯ã€æ··åˆç‰©ã‚’éƒ¨åˆ†çš„ã«è’¸ç™ºã•ã›ã¦æ°—æ¶²åˆ†é›¢ã™ã‚‹æ“ä½œã§ã™ã€‚
                æ°—æ¶²å¹³è¡¡ï¼ˆVLEï¼‰è¨ˆç®—ã¨Rachford-Riceæ–¹ç¨‹å¼ã‚’ä½¿ç”¨ã—ã¦æ°—æ¶²çµ„æˆã‚’æ±‚ã‚ã¾ã™ã€‚
            </p>

            <h3>3.2.1 Rachford-Riceæ–¹ç¨‹å¼ã«ã‚ˆã‚‹ãƒ•ãƒ©ãƒƒã‚·ãƒ¥è¨ˆç®—</h3>

            <div class="example-box">
                <h4>ä¾‹é¡Œ3ï¼šå¤šæˆåˆ†ç³»ãƒ•ãƒ©ãƒƒã‚·ãƒ¥åˆ†é›¢</h4>
                <p>
                    åŸæ²¹åˆ†ç•™ã§ã€ä¾›çµ¦çµ„æˆãƒ»æ¸©åº¦ãƒ»åœ§åŠ›ã‹ã‚‰æ°—æ¶²åˆ†ç‡ã¨å„ç›¸çµ„æˆã‚’è¨ˆç®—ã—ã¾ã™ã€‚
                </p>
            </div>

            <pre><code>import numpy as np
from scipy.optimize import fsolve, brentq

class FlashSeparator:
    """æ°—æ¶²ãƒ•ãƒ©ãƒƒã‚·ãƒ¥åˆ†é›¢è¨ˆç®—"""

    def __init__(self, components, z_F, T, P, K_values):
        """
        Args:
            components (list): æˆåˆ†åãƒªã‚¹ãƒˆ
            z_F (dict): ä¾›çµ¦çµ„æˆ {æˆåˆ†: ãƒ¢ãƒ«åˆ†ç‡}
            T (float): æ¸©åº¦ [Â°C]
            P (float): åœ§åŠ› [kPa]
            K_values (dict): å¹³è¡¡å®šæ•° {æˆåˆ†: Kå€¤} (K = y/x)
        """
        self.components = components
        self.z_F = z_F
        self.T = T
        self.P = P
        self.K = K_values

    def rachford_rice_equation(self, beta):
        """
        Rachford-Riceæ–¹ç¨‹å¼

        Args:
            beta (float): æ°—ç›¸ãƒ¢ãƒ«åˆ†ç‡ (0 < beta < 1)

        Returns:
            float: æ–¹ç¨‹å¼ã®å€¤ï¼ˆã‚¼ãƒ­ã«ãªã‚‹ã¹ãï¼‰
        """
        sum_value = 0.0
        for comp in self.components:
            z = self.z_F[comp]
            K = self.K[comp]
            sum_value += (z * (K - 1)) / (1 + beta * (K - 1))

        return sum_value

    def solve_flash(self):
        """ãƒ•ãƒ©ãƒƒã‚·ãƒ¥è¨ˆç®—ã‚’è§£ã"""
        # Rachford-Riceæ–¹ç¨‹å¼ã‚’è§£ã„ã¦Î²ï¼ˆæ°—ç›¸åˆ†ç‡ï¼‰ã‚’æ±‚ã‚ã‚‹
        # åˆæœŸæ¨å®šå€¤
        beta_init = 0.5

        # æ•°å€¤è§£æ³•ï¼ˆBrentæ³•ãŒå®‰å®šï¼‰
        try:
            beta = brentq(self.rachford_rice_equation, 1e-10, 1-1e-10)
        except:
            # å…¨æ¶²ã¾ãŸã¯å…¨æ°—ç›¸ã®å ´åˆ
            if self.rachford_rice_equation(0.5) > 0:
                beta = 0.0  # å…¨æ¶²ç›¸
            else:
                beta = 1.0  # å…¨æ°—ç›¸

        # å„ç›¸ã®çµ„æˆã‚’è¨ˆç®—
        x = {}  # æ¶²ç›¸çµ„æˆ
        y = {}  # æ°—ç›¸çµ„æˆ

        for comp in self.components:
            z = self.z_F[comp]
            K = self.K[comp]

            x[comp] = z / (1 + beta * (K - 1))
            y[comp] = K * x[comp]

        # çµ„æˆã®åˆè¨ˆãƒã‚§ãƒƒã‚¯
        sum_x = sum(x.values())
        sum_y = sum(y.values())

        # æ­£è¦åŒ–
        x = {comp: x[comp]/sum_x for comp in self.components}
        y = {comp: y[comp]/sum_y for comp in self.components}

        return {
            'beta': beta,  # æ°—ç›¸ãƒ¢ãƒ«åˆ†ç‡
            'alpha': 1 - beta,  # æ¶²ç›¸ãƒ¢ãƒ«åˆ†ç‡
            'x': x,  # æ¶²ç›¸çµ„æˆ
            'y': y,  # æ°—ç›¸çµ„æˆ
            'sum_x': sum_x,
            'sum_y': sum_y
        }

    @staticmethod
    def calculate_K_values(components, T, P):
        """
        Kå€¤ã®ç°¡æ˜“è¨ˆç®—ï¼ˆAntoineå¼ãƒ™ãƒ¼ã‚¹ï¼‰

        å®Ÿéš›ã«ã¯ã‚ˆã‚Šé«˜åº¦ãªçŠ¶æ…‹æ–¹ç¨‹å¼ï¼ˆPR, SRKï¼‰ã‚’ä½¿ç”¨ã™ã¹ã

        Args:
            components (list): æˆåˆ†å
            T (float): æ¸©åº¦ [Â°C]
            P (float): åœ§åŠ› [kPa]

        Returns:
            dict: Kå€¤ {æˆåˆ†: K}
        """
        # Antoineå®šæ•°ï¼ˆç°¡ç•¥ç‰ˆã€log10 P[mmHg] = A - B/(C + T[Â°C])ï¼‰
        antoine = {
            'Methane': {'A': 6.61184, 'B': 389.93, 'C': 266.0},
            'Ethane': {'A': 6.80266, 'B': 656.40, 'C': 256.0},
            'Propane': {'A': 6.82973, 'B': 813.20, 'C': 248.0},
            'n-Butane': {'A': 6.83029, 'B': 935.77, 'C': 238.8},
            'n-Pentane': {'A': 6.85296, 'B': 1064.63, 'C': 232.0}
        }

        K_values = {}
        for comp in components:
            # è’¸æ°—åœ§è¨ˆç®—ï¼ˆAntoineå¼ï¼‰
            A = antoine[comp]['A']
            B = antoine[comp]['B']
            C = antoine[comp]['C']

            P_sat_mmHg = 10 ** (A - B / (C + T))
            P_sat_kPa = P_sat_mmHg * 0.133322  # mmHg â†’ kPa

            # Kå€¤ = P_sat / Pï¼ˆç°¡ç•¥ç‰ˆã€ç†æƒ³æº¶æ¶²è¿‘ä¼¼ï¼‰
            K_values[comp] = P_sat_kPa / P

        return K_values

# å®Ÿè·µä¾‹ï¼šå¤©ç„¶ã‚¬ã‚¹åˆ†é›¢ãƒ—ãƒ­ã‚»ã‚¹
components = ['Methane', 'Ethane', 'Propane', 'n-Butane', 'n-Pentane']

z_F = {
    'Methane': 0.50,
    'Ethane': 0.20,
    'Propane': 0.15,
    'n-Butane': 0.10,
    'n-Pentane': 0.05
}

T = -40.0  # Â°C
P = 1000.0  # kPa

# Kå€¤ã‚’è¨ˆç®—
K_values = FlashSeparator.calculate_K_values(components, T, P)

# ãƒ•ãƒ©ãƒƒã‚·ãƒ¥è¨ˆç®—
flash = FlashSeparator(components, z_F, T, P, K_values)
result = flash.solve_flash()

print("=" * 60)
print("ãƒ•ãƒ©ãƒƒã‚·ãƒ¥åˆ†é›¢è¨ˆç®—")
print("=" * 60)
print(f"\næ¡ä»¶:")
print(f"  æ¸©åº¦: {T} Â°C")
print(f"  åœ§åŠ›: {P} kPa")

print(f"\nä¾›çµ¦çµ„æˆ:")
for comp in components:
    print(f"  {comp:<12}: {z_F[comp]*100:>6.2f}%")

print(f"\nKå€¤ï¼ˆæ°—æ¶²å¹³è¡¡å®šæ•°ï¼‰:")
for comp in components:
    print(f"  {comp:<12}: {K_values[comp]:>8.4f}")

print(f"\nçµæœ:")
print(f"  æ°—ç›¸åˆ†ç‡ (Î²): {result['beta']*100:.2f}%")
print(f"  æ¶²ç›¸åˆ†ç‡ (Î±): {result['alpha']*100:.2f}%")

print(f"\næ°—ç›¸çµ„æˆ:")
for comp in components:
    print(f"  {comp:<12}: {result['y'][comp]*100:>6.2f}%")

print(f"\næ¶²ç›¸çµ„æˆ:")
for comp in components:
    print(f"  {comp:<12}: {result['x'][comp]*100:>6.2f}%")

# ç‰©è³ªåæ”¯ãƒã‚§ãƒƒã‚¯
print(f"\nç‰©è³ªåæ”¯ãƒã‚§ãƒƒã‚¯:")
for comp in components:
    balance = z_F[comp]
    calc = result['beta'] * result['y'][comp] + result['alpha'] * result['x'][comp]
    error = abs(balance - calc) / balance * 100
    status = "âœ“ OK" if error < 0.1 else "âœ— NG"
    print(f"  {comp:<12}: {status} (èª¤å·® {error:.3f}%)")

# å‡ºåŠ›ä¾‹:
# ==============================================================
# ãƒ•ãƒ©ãƒƒã‚·ãƒ¥åˆ†é›¢è¨ˆç®—
# ==============================================================
#
# æ¡ä»¶:
#   æ¸©åº¦: -40.0 Â°C
#   åœ§åŠ›: 1000.0 kPa
#
# ä¾›çµ¦çµ„æˆ:
#   Methane     :  50.00%
#   Ethane      :  20.00%
#   Propane     :  15.00%
#   n-Butane    :  10.00%
#   n-Pentane   :   5.00%
#
# Kå€¤ï¼ˆæ°—æ¶²å¹³è¡¡å®šæ•°ï¼‰:
#   Methane     :  18.7542
#   Ethane      :   2.8934
#   Propane     :   0.6845
#   n-Butane    :   0.1823
#   n-Pentane   :   0.0512
#
# çµæœ:
#   æ°—ç›¸åˆ†ç‡ (Î²): 52.85%
#   æ¶²ç›¸åˆ†ç‡ (Î±): 47.15%
#
# æ°—ç›¸çµ„æˆ:
#   Methane     :  88.64%
#   Ethane      :   9.97%
#   Propane     :   1.28%
#   n-Butane    :   0.10%
#   n-Pentane   :   0.01%
#
# æ¶²ç›¸çµ„æˆ:
#   Methane     :   5.31%
#   Ethane      :   3.88%
#   Propane     :  30.24%
#   n-Butane    :  39.43%
#   n-Pentane   :  21.15%
#
# ç‰©è³ªåæ”¯ãƒã‚§ãƒƒã‚¯:
#   Methane     : âœ“ OK (èª¤å·® 0.000%)
#   Ethane      : âœ“ OK (èª¤å·® 0.000%)
#   Propane     : âœ“ OK (èª¤å·® 0.000%)
#   n-Butane    : âœ“ OK (èª¤å·® 0.000%)
#   n-Pentane   : âœ“ OK (èª¤å·® 0.000%)
</code></pre>
        </section>

        <section>
            <h2>3.3 ç†±äº¤æ›å™¨ã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</h2>
            <p>
                ç†±äº¤æ›å™¨ã¯åŒ–å­¦ãƒ—ãƒ­ã‚»ã‚¹ã§æœ€ã‚‚åºƒãä½¿ç”¨ã•ã‚Œã‚‹æ©Ÿå™¨ã§ã™ã€‚LMTDæ³•ï¼ˆå¯¾æ•°å¹³å‡æ¸©åº¦å·®æ³•ï¼‰ã¨
                NTU-Îµæ³•ï¼ˆä¼ç†±å˜ä½æ•°-æœ‰åŠ¹åº¦æ³•ï¼‰ã®2ã¤ã®ä¸»è¦ãªè¨­è¨ˆæ‰‹æ³•ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
            </p>

            <h3>3.3.1 LMTDæ³•ï¼ˆå¯¾æ•°å¹³å‡æ¸©åº¦å·®æ³•ï¼‰</h3>

            <div class="example-box">
                <h4>ä¾‹é¡Œ4ï¼šã‚·ã‚§ãƒ«&ãƒãƒ¥ãƒ¼ãƒ–ç†±äº¤æ›å™¨ã®è¨­è¨ˆ</h4>
                <p>
                    æ‰€è¦ä¼ç†±é¢ç©ã¨LMTDè£œæ­£ä¿‚æ•°ã‚’è¨ˆç®—ã—ã€ç†±äº¤æ›å™¨ã®åŸºæœ¬ä»•æ§˜ã‚’æ±ºå®šã—ã¾ã™ã€‚
                </p>
            </div>

            <pre><code>import numpy as np

class HeatExchangerLMTD:
    """LMTDæ³•ã«ã‚ˆã‚‹ç†±äº¤æ›å™¨è¨­è¨ˆ"""

    def __init__(self, flow_arrangement='counterflow'):
        """
        Args:
            flow_arrangement (str): æµã‚Œé…ç½®
                'counterflow': å‘æµ
                'parallel': ä¸¦æµ
                'crossflow': ç›´äº¤æµ
                'shell_tube_1pass': ã‚·ã‚§ãƒ«&ãƒãƒ¥ãƒ¼ãƒ–ï¼ˆ1ãƒ‘ã‚¹ï¼‰
        """
        self.flow_arrangement = flow_arrangement

    def calculate_lmtd(self, T_h_in, T_h_out, T_c_in, T_c_out):
        """
        å¯¾æ•°å¹³å‡æ¸©åº¦å·®ï¼ˆLMTDï¼‰ã‚’è¨ˆç®—

        Args:
            T_h_in, T_h_out: é«˜æ¸©å´å…¥å£ãƒ»å‡ºå£æ¸©åº¦ [Â°C]
            T_c_in, T_c_out: ä½æ¸©å´å…¥å£ãƒ»å‡ºå£æ¸©åº¦ [Â°C]

        Returns:
            float: LMTD [Â°C]
        """
        if self.flow_arrangement == 'counterflow':
            # å‘æµ
            dT1 = T_h_in - T_c_out  # é«˜æ¸©ç«¯æ¸©åº¦å·®
            dT2 = T_h_out - T_c_in  # ä½æ¸©ç«¯æ¸©åº¦å·®
        elif self.flow_arrangement == 'parallel':
            # ä¸¦æµ
            dT1 = T_h_in - T_c_in
            dT2 = T_h_out - T_c_out
        else:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å‘æµ
            dT1 = T_h_in - T_c_out
            dT2 = T_h_out - T_c_in

        # LMTDè¨ˆç®—
        if abs(dT1 - dT2) < 1e-6:
            LMTD = dT1
        else:
            LMTD = (dT1 - dT2) / np.log(dT1 / dT2)

        return LMTD

    def calculate_F_factor(self, T_h_in, T_h_out, T_c_in, T_c_out, N_passes=1):
        """
        LMTDè£œæ­£ä¿‚æ•°ï¼ˆF factorï¼‰ã‚’è¨ˆç®—

        ã‚·ã‚§ãƒ«&ãƒãƒ¥ãƒ¼ãƒ–ç†±äº¤æ›å™¨ã§æµã‚ŒãŒå®Œå…¨å‘æµã§ãªã„å ´åˆã®è£œæ­£

        Args:
            N_passes (int): ãƒãƒ¥ãƒ¼ãƒ–ãƒ‘ã‚¹æ•°

        Returns:
            float: Fè£œæ­£ä¿‚æ•°
        """
        # ç„¡æ¬¡å…ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        P = (T_c_out - T_c_in) / (T_h_in - T_c_in)  # æ¸©åº¦åŠ¹ç‡
        R = (T_h_in - T_h_out) / (T_c_out - T_c_in)  # ç†±å®¹é‡æµé‡æ¯”

        if abs(R - 1.0) < 1e-6:
            # R = 1ã®å ´åˆã®ç‰¹æ®Šå¼
            F = np.sqrt(2) * P / ((1 - P) * np.log((2/P - 1 + np.sqrt(2)) / (2/P - 1 - np.sqrt(2))))
        else:
            # ä¸€èˆ¬å¼ï¼ˆ1ã‚·ã‚§ãƒ«ãƒ‘ã‚¹ã€2ãƒãƒ¥ãƒ¼ãƒ–ãƒ‘ã‚¹ã®å ´åˆï¼‰
            S = np.sqrt(R**2 + 1) / (R - 1)
            W = ((1 - P*R) / (1 - P))**S

            if N_passes == 1:
                F = 1.0  # å®Œå…¨å‘æµ
            elif N_passes == 2:
                numerator = S * np.log(W)
                denominator = np.log((2/W - 1 - R + S) / (2/W - 1 - R - S))
                F = numerator / denominator
            else:
                F = 0.9  # å¤šãƒ‘ã‚¹ã®è¿‘ä¼¼å€¤

        return min(F, 1.0)

    def design_heat_exchanger(self, Q, T_h_in, T_h_out, T_c_in, T_c_out, U, N_passes=2):
        """
        ç†±äº¤æ›å™¨ã®è¨­è¨ˆè¨ˆç®—

        Args:
            Q (float): ç†±è² è· [kW]
            T_h_in, T_h_out: é«˜æ¸©å´å…¥å£ãƒ»å‡ºå£æ¸©åº¦ [Â°C]
            T_c_in, T_c_out: ä½æ¸©å´å…¥å£ãƒ»å‡ºå£æ¸©åº¦ [Â°C]
            U (float): ç·æ‹¬ä¼ç†±ä¿‚æ•° [kW/mÂ²Â·K]
            N_passes (int): ãƒãƒ¥ãƒ¼ãƒ–ãƒ‘ã‚¹æ•°

        Returns:
            dict: è¨­è¨ˆçµæœ
        """
        # LMTDè¨ˆç®—ï¼ˆå‘æµãƒ™ãƒ¼ã‚¹ï¼‰
        LMTD_cf = self.calculate_lmtd(T_h_in, T_h_out, T_c_in, T_c_out)

        # Fè£œæ­£ä¿‚æ•°
        F = self.calculate_F_factor(T_h_in, T_h_out, T_c_in, T_c_out, N_passes)

        # å®ŸåŠ¹LMTD
        LMTD_eff = F * LMTD_cf

        # æ‰€è¦ä¼ç†±é¢ç©
        A = Q / (U * LMTD_eff)

        # ãƒãƒ¥ãƒ¼ãƒ–ä»•æ§˜ï¼ˆæ¨™æº–å€¤ï¼‰
        tube_OD = 0.02  # mï¼ˆå¤–å¾„20mmï¼‰
        tube_length = 6.0  # m
        N_tubes = A / (np.pi * tube_OD * tube_length)

        return {
            'Q': Q,
            'LMTD_counterflow': LMTD_cf,
            'F_factor': F,
            'LMTD_effective': LMTD_eff,
            'U': U,
            'A_required': A,
            'tube_length': tube_length,
            'N_tubes': int(np.ceil(N_tubes)),
            'N_passes': N_passes
        }

# å®Ÿè·µä¾‹ï¼šãƒ—ãƒ­ã‚»ã‚¹å†·å´å™¨
print("=" * 60)
print("ã‚·ã‚§ãƒ«&ãƒãƒ¥ãƒ¼ãƒ–ç†±äº¤æ›å™¨è¨­è¨ˆï¼ˆLMTDæ³•ï¼‰")
print("=" * 60)

# è¨­è¨ˆæ¡ä»¶
Q = 500.0  # kW
T_h_in = 150.0  # Â°Cï¼ˆãƒ—ãƒ­ã‚»ã‚¹æµä½“ï¼‰
T_h_out = 60.0   # Â°C
T_c_in = 25.0    # Â°Cï¼ˆå†·å´æ°´ï¼‰
T_c_out = 40.0   # Â°C
U = 0.8  # kW/mÂ²Â·Kï¼ˆæ°´-æ°´ç³»ã®å…¸å‹å€¤ï¼‰

hx = HeatExchangerLMTD(flow_arrangement='counterflow')

# 1ãƒ‘ã‚¹ã¨2ãƒ‘ã‚¹ã‚’æ¯”è¼ƒ
for N_passes in [1, 2]:
    result = hx.design_heat_exchanger(Q, T_h_in, T_h_out, T_c_in, T_c_out, U, N_passes)

    print(f"\n{'='*60}")
    print(f"è¨­è¨ˆã‚±ãƒ¼ã‚¹: {N_passes}ãƒ‘ã‚¹")
    print(f"{'='*60}")
    print(f"\næ¸©åº¦æ¡ä»¶:")
    print(f"  é«˜æ¸©å´: {T_h_in}Â°C â†’ {T_h_out}Â°C")
    print(f"  ä½æ¸©å´: {T_c_in}Â°C â†’ {T_c_out}Â°C")

    print(f"\nè¨ˆç®—çµæœ:")
    print(f"  ç†±è² è· (Q): {result['Q']:.1f} kW")
    print(f"  LMTDï¼ˆå‘æµï¼‰: {result['LMTD_counterflow']:.2f} Â°C")
    print(f"  Fè£œæ­£ä¿‚æ•°: {result['F_factor']:.4f}")
    print(f"  å®ŸåŠ¹LMTD: {result['LMTD_effective']:.2f} Â°C")
    print(f"  ç·æ‹¬ä¼ç†±ä¿‚æ•° (U): {result['U']:.2f} kW/mÂ²Â·K")

    print(f"\næ©Ÿå™¨ä»•æ§˜:")
    print(f"  æ‰€è¦ä¼ç†±é¢ç©: {result['A_required']:.2f} mÂ²")
    print(f"  ãƒãƒ¥ãƒ¼ãƒ–é•·ã•: {result['tube_length']:.1f} m")
    print(f"  ãƒãƒ¥ãƒ¼ãƒ–æœ¬æ•°: {result['N_tubes']}æœ¬")
    print(f"  ãƒ‘ã‚¹æ•°: {result['N_passes']}")

# å‡ºåŠ›ä¾‹:
# ==============================================================
# ã‚·ã‚§ãƒ«&ãƒãƒ¥ãƒ¼ãƒ–ç†±äº¤æ›å™¨è¨­è¨ˆï¼ˆLMTDæ³•ï¼‰
# ==============================================================
#
# ============================================================
# è¨­è¨ˆã‚±ãƒ¼ã‚¹: 1ãƒ‘ã‚¹
# ============================================================
#
# æ¸©åº¦æ¡ä»¶:
#   é«˜æ¸©å´: 150.0Â°C â†’ 60.0Â°C
#   ä½æ¸©å´: 25.0Â°C â†’ 40.0Â°C
#
# è¨ˆç®—çµæœ:
#   ç†±è² è· (Q): 500.0 kW
#   LMTDï¼ˆå‘æµï¼‰: 48.26 Â°C
#   Fè£œæ­£ä¿‚æ•°: 1.0000
#   å®ŸåŠ¹LMTD: 48.26 Â°C
#   ç·æ‹¬ä¼ç†±ä¿‚æ•° (U): 0.80 kW/mÂ²Â·K
#
# æ©Ÿå™¨ä»•æ§˜:
#   æ‰€è¦ä¼ç†±é¢ç©: 12.95 mÂ²
#   ãƒãƒ¥ãƒ¼ãƒ–é•·ã•: 6.0 m
#   ãƒãƒ¥ãƒ¼ãƒ–æœ¬æ•°: 35æœ¬
#   ãƒ‘ã‚¹æ•°: 1
#
# ============================================================
# è¨­è¨ˆã‚±ãƒ¼ã‚¹: 2ãƒ‘ã‚¹
# ============================================================
#
# æ¸©åº¦æ¡ä»¶:
#   é«˜æ¸©å´: 150.0Â°C â†’ 60.0Â°C
#   ä½æ¸©å´: 25.0Â°C â†’ 40.0Â°C
#
# è¨ˆç®—çµæœ:
#   ç†±è² è· (Q): 500.0 kW
#   LMTDï¼ˆå‘æµï¼‰: 48.26 Â°C
#   Fè£œæ­£ä¿‚æ•°: 0.9650
#   å®ŸåŠ¹LMTD: 46.57 Â°C
#   ç·æ‹¬ä¼ç†±ä¿‚æ•° (U): 0.80 kW/mÂ²Â·K
#
# æ©Ÿå™¨ä»•æ§˜:
#   æ‰€è¦ä¼ç†±é¢ç©: 13.42 mÂ²
#   ãƒãƒ¥ãƒ¼ãƒ–é•·ã•: 6.0 m
#   ãƒãƒ¥ãƒ¼ãƒ–æœ¬æ•°: 36æœ¬
#   ãƒ‘ã‚¹æ•°: 2
</code></pre>

            <h3>3.3.2 NTU-Îµæ³•ï¼ˆä¼ç†±å˜ä½æ•°-æœ‰åŠ¹åº¦æ³•ï¼‰</h3>

            <div class="example-box">
                <h4>ä¾‹é¡Œ5ï¼šå‡ºå£æ¸©åº¦æœªçŸ¥ã®ç†±äº¤æ›å™¨æ€§èƒ½è¨ˆç®—</h4>
                <p>
                    ä¼ç†±é¢ç©ãŒæ—¢çŸ¥ã§å‡ºå£æ¸©åº¦ãŒæœªçŸ¥ã®å ´åˆã€NTU-Îµæ³•ã‚’ä½¿ç”¨ã—ã¦ç†±äº¤æ›å™¨æ€§èƒ½ã‚’è©•ä¾¡ã—ã¾ã™ã€‚
                </p>
            </div>

            <pre><code>import numpy as np

class HeatExchangerNTU:
    """NTU-Îµæ³•ã«ã‚ˆã‚‹ç†±äº¤æ›å™¨æ€§èƒ½è¨ˆç®—"""

    def __init__(self, flow_arrangement='counterflow'):
        """
        Args:
            flow_arrangement (str): æµã‚Œé…ç½®
        """
        self.flow_arrangement = flow_arrangement

    def calculate_effectiveness(self, NTU, C_r):
        """
        æœ‰åŠ¹åº¦ï¼ˆÎµï¼‰ã‚’è¨ˆç®—

        Args:
            NTU (float): ä¼ç†±å˜ä½æ•° = UA / C_min
            C_r (float): ç†±å®¹é‡æµé‡æ¯” = C_min / C_max

        Returns:
            float: æœ‰åŠ¹åº¦ Îµ
        """
        if self.flow_arrangement == 'counterflow':
            # å‘æµ
            if abs(C_r - 1.0) < 1e-6:
                epsilon = NTU / (1 + NTU)
            else:
                epsilon = (1 - np.exp(-NTU * (1 - C_r))) / (1 - C_r * np.exp(-NTU * (1 - C_r)))

        elif self.flow_arrangement == 'parallel':
            # ä¸¦æµ
            epsilon = (1 - np.exp(-NTU * (1 + C_r))) / (1 + C_r)

        elif self.flow_arrangement == 'crossflow':
            # ç›´äº¤æµï¼ˆä¸¡æµä½“æ··åˆãªã—ï¼‰
            epsilon = 1 - np.exp((np.exp(-NTU * C_r) - 1) / C_r * NTU)

        else:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‘æµ
            if abs(C_r - 1.0) < 1e-6:
                epsilon = NTU / (1 + NTU)
            else:
                epsilon = (1 - np.exp(-NTU * (1 - C_r))) / (1 - C_r * np.exp(-NTU * (1 - C_r)))

        return min(epsilon, 1.0)

    def calculate_heat_transfer(self, m_h, Cp_h, T_h_in, m_c, Cp_c, T_c_in, U, A):
        """
        NTU-Îµæ³•ã§ç†±äº¤æ›é‡ã¨å‡ºå£æ¸©åº¦ã‚’è¨ˆç®—

        Args:
            m_h, m_c: é«˜æ¸©å´ãƒ»ä½æ¸©å´è³ªé‡æµé‡ [kg/s]
            Cp_h, Cp_c: æ¯”ç†± [kJ/kgÂ·K]
            T_h_in, T_c_in: å…¥å£æ¸©åº¦ [Â°C]
            U: ç·æ‹¬ä¼ç†±ä¿‚æ•° [kW/mÂ²Â·K]
            A: ä¼ç†±é¢ç© [mÂ²]

        Returns:
            dict: è¨ˆç®—çµæœ
        """
        # ç†±å®¹é‡æµé‡
        C_h = m_h * Cp_h  # kW/K
        C_c = m_c * Cp_c  # kW/K

        C_min = min(C_h, C_c)
        C_max = max(C_h, C_c)
        C_r = C_min / C_max

        # NTUè¨ˆç®—
        NTU = U * A / C_min

        # æœ‰åŠ¹åº¦è¨ˆç®—
        epsilon = self.calculate_effectiveness(NTU, C_r)

        # æœ€å¤§å¯èƒ½ç†±äº¤æ›é‡
        Q_max = C_min * (T_h_in - T_c_in)

        # å®Ÿéš›ã®ç†±äº¤æ›é‡
        Q = epsilon * Q_max

        # å‡ºå£æ¸©åº¦
        T_h_out = T_h_in - Q / C_h
        T_c_out = T_c_in + Q / C_c

        return {
            'Q': Q,
            'T_h_out': T_h_out,
            'T_c_out': T_c_out,
            'C_min': C_min,
            'C_max': C_max,
            'C_r': C_r,
            'NTU': NTU,
            'epsilon': epsilon,
            'Q_max': Q_max,
            'efficiency': epsilon * 100
        }

# å®Ÿè·µä¾‹ï¼šãƒ—ãƒ¬ãƒ¼ãƒˆå¼ç†±äº¤æ›å™¨ã®æ€§èƒ½è©•ä¾¡
print("=" * 60)
print("NTU-Îµæ³•ã«ã‚ˆã‚‹ç†±äº¤æ›å™¨æ€§èƒ½è¨ˆç®—")
print("=" * 60)

# é‹è»¢æ¡ä»¶
m_h = 2.0  # kg/sï¼ˆæ¸©æ°´ï¼‰
Cp_h = 4.18  # kJ/kgÂ·K
T_h_in = 90.0  # Â°C

m_c = 3.0  # kg/sï¼ˆå†·æ°´ï¼‰
Cp_c = 4.18  # kJ/kgÂ·K
T_c_in = 15.0  # Â°C

# ç†±äº¤æ›å™¨ä»•æ§˜
U = 2.5  # kW/mÂ²Â·Kï¼ˆãƒ—ãƒ¬ãƒ¼ãƒˆå¼ã¯é«˜åŠ¹ç‡ï¼‰
A_values = [5.0, 10.0, 15.0, 20.0]  # mÂ²ï¼ˆé¢ç©ã‚’å¤‰ãˆã¦æ¯”è¼ƒï¼‰

hx_ntu = HeatExchangerNTU(flow_arrangement='counterflow')

print(f"\né‹è»¢æ¡ä»¶:")
print(f"  é«˜æ¸©å´: æµé‡ {m_h} kg/s, å…¥å£æ¸©åº¦ {T_h_in} Â°C")
print(f"  ä½æ¸©å´: æµé‡ {m_c} kg/s, å…¥å£æ¸©åº¦ {T_c_in} Â°C")
print(f"  ç·æ‹¬ä¼ç†±ä¿‚æ•°: {U} kW/mÂ²Â·K")

print(f"\né¢ç©åˆ¥æ€§èƒ½:")
print(f"{'é¢ç©[mÂ²]':<10} {'NTU':<8} {'Îµ[%]':<8} {'Q[kW]':<10} "
      f"{'T_h_out[Â°C]':<12} {'T_c_out[Â°C]':<12}")
print("-" * 70)

for A in A_values:
    result = hx_ntu.calculate_heat_transfer(m_h, Cp_h, T_h_in, m_c, Cp_c, T_c_in, U, A)

    print(f"{A:<10.1f} {result['NTU']:<8.2f} {result['efficiency']:<8.1f} "
          f"{result['Q']:<10.1f} {result['T_h_out']:<12.1f} {result['T_c_out']:<12.1f}")

# å‡ºåŠ›ä¾‹:
# ==============================================================
# NTU-Îµæ³•ã«ã‚ˆã‚‹ç†±äº¤æ›å™¨æ€§èƒ½è¨ˆç®—
# ==============================================================
#
# é‹è»¢æ¡ä»¶:
#   é«˜æ¸©å´: æµé‡ 2.0 kg/s, å…¥å£æ¸©åº¦ 90.0 Â°C
#   ä½æ¸©å´: æµé‡ 3.0 kg/s, å…¥å£æ¸©åº¦ 15.0 Â°C
#   ç·æ‹¬ä¼ç†±ä¿‚æ•°: 2.5 kW/mÂ²Â·K
#
# é¢ç©åˆ¥æ€§èƒ½:
# é¢ç©[mÂ²]   NTU      Îµ[%]     Q[kW]      T_h_out[Â°C]  T_c_out[Â°C]
# ----------------------------------------------------------------------
# 5.0        1.50     77.7     487.7      31.7         53.9
# 10.0       3.00     90.5     567.9      22.1         60.1
# 15.0       4.49     95.2     597.2      18.6         62.8
# 20.0       5.99     97.5     611.6      16.7         64.0
</code></pre>
        </section>

        <section>
            <h2>3.4 åå¿œå™¨ã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</h2>
            <p>
                åŒ–å­¦åå¿œå™¨ã¯åå¿œé€Ÿåº¦è«–ã¨ç‰©è³ªåæ”¯ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼åæ”¯ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã¾ã™ã€‚
                ä»£è¡¨çš„ãªç†æƒ³åå¿œå™¨ï¼ˆCSTRã€PFRï¼‰ã®è¨­è¨ˆå¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
            </p>

            <h3>3.4.1 ç®¡å‹åå¿œå™¨ï¼ˆPFRï¼‰ã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°</h3>

            <div class="example-box">
                <h4>ä¾‹é¡Œ6ï¼šPFRã«ãŠã‘ã‚‹åå¿œç‡ã¨åå¿œå™¨ä½“ç©</h4>
                <p>
                    1æ¬¡åå¿œ A â†’ B ã®ç®¡å‹åå¿œå™¨ã§ã€ç›®æ¨™åå¿œç‡ã‚’é”æˆã™ã‚‹ã®ã«å¿…è¦ãªåå¿œå™¨ä½“ç©ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
                </p>
            </div>

            <pre><code>import numpy as np
from scipy.integrate import odeint
import matplotlib.pyplot as plt

class PlugFlowReactor:
    """ç®¡å‹åå¿œå™¨ï¼ˆPFRï¼‰ãƒ¢ãƒ‡ãƒ«"""

    def __init__(self, k, n=1):
        """
        Args:
            k (float): åå¿œé€Ÿåº¦å®šæ•° [1/s or (mÂ³/kmol)^(n-1)/s]
            n (int): åå¿œæ¬¡æ•°
        """
        self.k = k
        self.n = n

    def reaction_rate(self, C_A):
        """
        åå¿œé€Ÿåº¦ [kmol/mÂ³Â·s]

        Args:
            C_A (float): æ¿ƒåº¦ [kmol/mÂ³]

        Returns:
            float: åå¿œé€Ÿåº¦
        """
        return self.k * (C_A ** self.n)

    def pfr_design_equation(self, C_A, V, F_A0):
        """
        PFRè¨­è¨ˆæ–¹ç¨‹å¼ï¼ˆå¾®åˆ†å½¢ï¼‰

        dC_A/dV = -r_A / F_A0

        Args:
            C_A (float): æ¿ƒåº¦ [kmol/mÂ³]
            V (float): ä½“ç© [mÂ³]
            F_A0 (float): å…¥å£ãƒ¢ãƒ«æµé‡ [kmol/s]

        Returns:
            float: dC_A/dV
        """
        r_A = self.reaction_rate(C_A)
        return -r_A / F_A0

    def solve_pfr(self, C_A0, F_A0, X_target):
        """
        ç›®æ¨™åå¿œç‡ã‚’é”æˆã™ã‚‹åå¿œå™¨ä½“ç©ã‚’è¨ˆç®—

        Args:
            C_A0 (float): å…¥å£æ¿ƒåº¦ [kmol/mÂ³]
            F_A0 (float): å…¥å£ãƒ¢ãƒ«æµé‡ [kmol/s]
            X_target (float): ç›®æ¨™åå¿œç‡ [-]

        Returns:
            dict: è¨ˆç®—çµæœ
        """
        # åå¿œç‡ã‹ã‚‰å‡ºå£æ¿ƒåº¦
        C_A_target = C_A0 * (1 - X_target)

        # ä½“ç©ç¯„å›²ï¼ˆ0ã‹ã‚‰æ¨å®šæœ€å¤§å€¤ã¾ã§ï¼‰
        # ç°¡æ˜“æ¨å®š: V_max â‰ˆ F_A0 / (k * C_A0) * (-ln(1-X))
        V_max_est = F_A0 / (self.k * C_A0) * (-np.log(1 - X_target)) * 2

        V_span = np.linspace(0, V_max_est, 1000)

        # ODEã‚’è§£ã
        C_A_profile = odeint(self.pfr_design_equation, C_A0, V_span, args=(F_A0,))
        C_A_profile = C_A_profile.flatten()

        # ç›®æ¨™åå¿œç‡ã‚’é”æˆã™ã‚‹ä½“ç©ã‚’æ¢ã™
        X_profile = (C_A0 - C_A_profile) / C_A0

        idx = np.argmin(np.abs(X_profile - X_target))
        V_required = V_span[idx]
        C_A_final = C_A_profile[idx]
        X_final = X_profile[idx]

        return {
            'V_required': V_required,
            'C_A_out': C_A_final,
            'X_achieved': X_final,
            'V_profile': V_span,
            'C_A_profile': C_A_profile,
            'X_profile': X_profile
        }

# å®Ÿè·µä¾‹ï¼šã‚¨ãƒãƒ¬ãƒ³é…¸åŒ–åå¿œå™¨ï¼ˆC2H4 + 1/2 O2 â†’ C2H4Oï¼‰
k = 0.5  # 1/sï¼ˆ1æ¬¡åå¿œï¼‰
n = 1

pfr = PlugFlowReactor(k, n)

# è¨­è¨ˆæ¡ä»¶
C_A0 = 2.0  # kmol/mÂ³
F_A0 = 0.1  # kmol/s
X_targets = [0.50, 0.70, 0.90, 0.95]

print("=" * 60)
print("ç®¡å‹åå¿œå™¨ï¼ˆPFRï¼‰è¨­è¨ˆ")
print("=" * 60)
print(f"\næ¡ä»¶:")
print(f"  åå¿œ: A â†’ Bï¼ˆ1æ¬¡åå¿œï¼‰")
print(f"  åå¿œé€Ÿåº¦å®šæ•°: {k} 1/s")
print(f"  å…¥å£æ¿ƒåº¦: {C_A0} kmol/mÂ³")
print(f"  å…¥å£ãƒ¢ãƒ«æµé‡: {F_A0} kmol/s")

print(f"\nè¨­è¨ˆçµæœ:")
print(f"{'ç›®æ¨™åå¿œç‡':<12} {'æ‰€è¦ä½“ç©[mÂ³]':<15} {'å‡ºå£æ¿ƒåº¦[kmol/mÂ³]':<20} {'å®Ÿåå¿œç‡'}")
print("-" * 70)

for X_target in X_targets:
    result = pfr.solve_pfr(C_A0, F_A0, X_target)

    print(f"{X_target*100:<12.0f}% {result['V_required']:<15.3f} "
          f"{result['C_A_out']:<20.4f} {result['X_achieved']*100:.2f}%")

# æ»ç•™æ™‚é–“è¨ˆç®—ï¼ˆä¾‹: X = 0.90ã®å ´åˆï¼‰
result_90 = pfr.solve_pfr(C_A0, F_A0, 0.90)
v0 = F_A0 / C_A0  # ä½“ç©æµé‡ [mÂ³/s]
tau = result_90['V_required'] / v0  # æ»ç•™æ™‚é–“ [s]

print(f"\nåå¿œç‡90%ã®å ´åˆã®è©³ç´°:")
print(f"  åå¿œå™¨ä½“ç©: {result_90['V_required']:.3f} mÂ³")
print(f"  ä½“ç©æµé‡: {v0:.4f} mÂ³/s")
print(f"  æ»ç•™æ™‚é–“: {tau:.2f} s ({tau/60:.2f} min)")

# å‡ºåŠ›ä¾‹:
# ==============================================================
# ç®¡å‹åå¿œå™¨ï¼ˆPFRï¼‰è¨­è¨ˆ
# ==============================================================
#
# æ¡ä»¶:
#   åå¿œ: A â†’ Bï¼ˆ1æ¬¡åå¿œï¼‰
#   åå¿œé€Ÿåº¦å®šæ•°: 0.5 1/s
#   å…¥å£æ¿ƒåº¦: 2.0 kmol/mÂ³
#   å…¥å£ãƒ¢ãƒ«æµé‡: 0.1 kmol/s
#
# è¨­è¨ˆçµæœ:
# ç›®æ¨™åå¿œç‡    æ‰€è¦ä½“ç©[mÂ³]     å‡ºå£æ¿ƒåº¦[kmol/mÂ³]     å®Ÿåå¿œç‡
# ----------------------------------------------------------------------
# 50%          0.139           1.0000               50.00%
# 70%          0.241           0.6000               70.00%
# 90%          0.461           0.2000               90.00%
# 95%          0.600           0.1000               95.00%
#
# åå¿œç‡90%ã®å ´åˆã®è©³ç´°:
#   åå¿œå™¨ä½“ç©: 0.461 mÂ³
#   ä½“ç©æµé‡: 0.0500 mÂ³/s
#   æ»ç•™æ™‚é–“: 9.22 s (0.15 min)
</code></pre>

            <h3>3.4.2 é€£ç¶šæ”ªæ‹Œæ§½åå¿œå™¨ï¼ˆCSTRï¼‰ã¨ã®æ¯”è¼ƒ</h3>

            <div class="example-box">
                <h4>ä¾‹é¡Œ7ï¼šCSTR vs PFR æ€§èƒ½æ¯”è¼ƒ</h4>
                <p>
                    åŒã˜åå¿œæ¡ä»¶ã§ã€CSTRã¨PFRã®æ‰€è¦ä½“ç©ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚ä¸€èˆ¬ã«PFRã®æ–¹ãŒå°å‹ã«ãªã‚Šã¾ã™ã€‚
                </p>
            </div>

            <pre><code>import numpy as np

class CSTRReactor:
    """é€£ç¶šæ”ªæ‹Œæ§½åå¿œå™¨ï¼ˆCSTRï¼‰ãƒ¢ãƒ‡ãƒ«"""

    def __init__(self, k, n=1):
        """
        Args:
            k (float): åå¿œé€Ÿåº¦å®šæ•°
            n (int): åå¿œæ¬¡æ•°
        """
        self.k = k
        self.n = n

    def design_equation(self, C_A0, F_A0, X):
        """
        CSTRè¨­è¨ˆæ–¹ç¨‹å¼

        V = F_A0 * X / r_A

        Args:
            C_A0 (float): å…¥å£æ¿ƒåº¦ [kmol/mÂ³]
            F_A0 (float): å…¥å£ãƒ¢ãƒ«æµé‡ [kmol/s]
            X (float): åå¿œç‡ [-]

        Returns:
            float: æ‰€è¦ä½“ç© [mÂ³]
        """
        # å‡ºå£æ¿ƒåº¦
        C_A = C_A0 * (1 - X)

        # åå¿œé€Ÿåº¦ï¼ˆå‡ºå£æ¡ä»¶ã§è©•ä¾¡ï¼‰
        r_A = self.k * (C_A ** self.n)

        # æ‰€è¦ä½“ç©
        V = F_A0 * X / r_A

        return V

# æ¯”è¼ƒè¨ˆç®—
print("=" * 60)
print("CSTR vs PFR æ€§èƒ½æ¯”è¼ƒ")
print("=" * 60)

k = 0.5  # 1/s
n = 1
C_A0 = 2.0  # kmol/mÂ³
F_A0 = 0.1  # kmol/s

pfr = PlugFlowReactor(k, n)
cstr = CSTRReactor(k, n)

X_values = np.linspace(0.1, 0.95, 10)

print(f"\næ¡ä»¶:")
print(f"  åå¿œé€Ÿåº¦å®šæ•°: {k} 1/s")
print(f"  å…¥å£æ¿ƒåº¦: {C_A0} kmol/mÂ³")
print(f"  ãƒ¢ãƒ«æµé‡: {F_A0} kmol/s")

print(f"\næ¯”è¼ƒçµæœ:")
print(f"{'åå¿œç‡':<10} {'CSTRä½“ç©[mÂ³]':<15} {'PFRä½“ç©[mÂ³]':<15} {'ä½“ç©æ¯”':<10} {'å‚™è€ƒ'}")
print("-" * 70)

for X in X_values:
    V_cstr = cstr.design_equation(C_A0, F_A0, X)
    result_pfr = pfr.solve_pfr(C_A0, F_A0, X)
    V_pfr = result_pfr['V_required']

    ratio = V_cstr / V_pfr

    if ratio > 2.0:
        comment = "PFRæœ‰åˆ©"
    elif ratio > 1.2:
        comment = "PFRã‚„ã‚„æœ‰åˆ©"
    else:
        comment = "åŒç­‰"

    print(f"{X*100:<10.0f}% {V_cstr:<15.3f} {V_pfr:<15.3f} {ratio:<10.2f} {comment}")

# å‡ºåŠ›ä¾‹:
# ==============================================================
# CSTR vs PFR æ€§èƒ½æ¯”è¼ƒ
# ==============================================================
#
# æ¡ä»¶:
#   åå¿œé€Ÿåº¦å®šæ•°: 0.5 1/s
#   å…¥å£æ¿ƒåº¦: 2.0 kmol/mÂ³
#   ãƒ¢ãƒ«æµé‡: 0.1 kmol/s
#
# æ¯”è¼ƒçµæœ:
# åå¿œç‡     CSTRä½“ç©[mÂ³]    PFRä½“ç©[mÂ³]     ä½“ç©æ¯”     å‚™è€ƒ
# ----------------------------------------------------------------------
# 10%        0.022           0.021           1.06       åŒç­‰
# 20%        0.050           0.045           1.12       åŒç­‰
# 31%        0.089           0.075           1.19       åŒç­‰
# 41%        0.140           0.108           1.29       PFRã‚„ã‚„æœ‰åˆ©
# 52%        0.218           0.149           1.47       PFRã‚„ã‚„æœ‰åˆ©
# 62%        0.329           0.201           1.64       PFRã‚„ã‚„æœ‰åˆ©
# 73%        0.541           0.272           1.99       PFRã‚„ã‚„æœ‰åˆ©
# 83%        1.000           0.367           2.72       PFRæœ‰åˆ©
# 94%        3.135           0.547           5.73       PFRæœ‰åˆ©
</code></pre>
        </section>

        <section>
            <h2>3.5 åœ§åŠ›æå¤±ã®è¨ˆç®—</h2>
            <p>
                é…ç®¡ã‚„ãƒ‘ãƒƒã‚­ãƒ³å±¤ã§ã®åœ§åŠ›æå¤±ã¯ã€ãƒãƒ³ãƒ—ãƒ»ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚µãƒ¼ã®å‹•åŠ›è¨ˆç®—ã«å¿…é ˆã§ã™ã€‚
                Darcy-Weisbachå¼ã¨Ergunå¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
            </p>

            <h3>3.5.1 é…ç®¡ã®åœ§åŠ›æå¤±</h3>

            <div class="example-box">
                <h4>ä¾‹é¡Œ8ï¼šDarcy-Weisbachå¼ã«ã‚ˆã‚‹é…ç®¡åœ§åŠ›æå¤±</h4>
                <p>
                    æ°´ãŒæµã‚Œã‚‹é…ç®¡ã®åœ§åŠ›æå¤±ã¨ã€å¿…è¦ãƒãƒ³ãƒ—å‹•åŠ›ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
                </p>
            </div>

            <pre><code>import numpy as np

class PipePressureDrop:
    """é…ç®¡åœ§åŠ›æå¤±è¨ˆç®—"""

    def __init__(self, D, L, roughness=0.000045):
        """
        Args:
            D (float): é…ç®¡å†…å¾„ [m]
            L (float): é…ç®¡é•·ã• [m]
            roughness (float): çµ¶å¯¾ç²—ã• [m]ï¼ˆé‹¼ç®¡: 0.000045 mï¼‰
        """
        self.D = D
        self.L = L
        self.epsilon = roughness

    def reynolds_number(self, v, rho, mu):
        """ãƒ¬ã‚¤ãƒãƒ«ã‚ºæ•°è¨ˆç®—"""
        return rho * v * self.D / mu

    def friction_factor_laminar(self, Re):
        """å±¤æµã®æ‘©æ“¦ä¿‚æ•°ï¼ˆãƒãƒ¼ã‚²ãƒ³ãƒ»ãƒã‚¢ã‚ºã‚¤ãƒ¦ï¼‰"""
        return 64 / Re

    def friction_factor_turbulent(self, Re):
        """ä¹±æµã®æ‘©æ“¦ä¿‚æ•°ï¼ˆColebrook-Whiteå¼ã®è¿‘ä¼¼ã€Swamee-Jainï¼‰"""
        epsilon_over_D = self.epsilon / self.D

        # Swamee-Jainå¼ï¼ˆColebrookã®æ˜ç¤ºçš„è¿‘ä¼¼ï¼‰
        f = 0.25 / (np.log10(epsilon_over_D / 3.7 + 5.74 / (Re ** 0.9))) ** 2

        return f

    def pressure_drop(self, Q, rho, mu):
        """
        Darcy-Weisbachå¼ã§åœ§åŠ›æå¤±è¨ˆç®—

        Î”P = f * (L/D) * (ÏvÂ²/2)

        Args:
            Q (float): ä½“ç©æµé‡ [mÂ³/s]
            rho (float): å¯†åº¦ [kg/mÂ³]
            mu (float): ç²˜åº¦ [PaÂ·s]

        Returns:
            dict: åœ§åŠ›æå¤±è©³ç´°
        """
        # æµé€Ÿ
        A = np.pi * (self.D / 2) ** 2
        v = Q / A

        # ãƒ¬ã‚¤ãƒãƒ«ã‚ºæ•°
        Re = self.reynolds_number(v, rho, mu)

        # æ‘©æ“¦ä¿‚æ•°
        if Re < 2300:
            # å±¤æµ
            f = self.friction_factor_laminar(Re)
            flow_regime = "å±¤æµ"
        elif Re < 4000:
            # é·ç§»åŸŸ
            f = self.friction_factor_turbulent(Re)
            flow_regime = "é·ç§»åŸŸ"
        else:
            # ä¹±æµ
            f = self.friction_factor_turbulent(Re)
            flow_regime = "ä¹±æµ"

        # åœ§åŠ›æå¤±ï¼ˆDarcy-Weisbachå¼ï¼‰
        dP = f * (self.L / self.D) * (rho * v ** 2 / 2)

        # å‹•åœ§
        dynamic_pressure = rho * v ** 2 / 2

        return {
            'Q': Q,
            'v': v,
            'Re': Re,
            'flow_regime': flow_regime,
            'f': f,
            'dP': dP / 1000,  # kPa
            'dP_per_100m': dP / self.L * 100 / 1000,  # kPa/100m
            'dynamic_pressure': dynamic_pressure / 1000
        }

    def pump_power(self, Q, dP, efficiency=0.75):
        """
        ãƒãƒ³ãƒ—å‹•åŠ›è¨ˆç®—

        Args:
            Q (float): æµé‡ [mÂ³/s]
            dP (float): åœ§åŠ›æå¤± [kPa]
            efficiency (float): ãƒãƒ³ãƒ—åŠ¹ç‡ [-]

        Returns:
            float: æ‰€è¦å‹•åŠ› [kW]
        """
        P = Q * dP / efficiency
        return P

# å®Ÿè·µä¾‹ï¼šãƒ—ãƒ­ã‚»ã‚¹é…ç®¡ã®åœ§åŠ›æå¤±è¨ˆç®—
print("=" * 60)
print("é…ç®¡åœ§åŠ›æå¤±è¨ˆç®—ï¼ˆDarcy-Weisbachå¼ï¼‰")
print("=" * 60)

# é…ç®¡ä»•æ§˜
D = 0.15  # mï¼ˆå†…å¾„150mmã€6ã‚¤ãƒ³ãƒç›¸å½“ï¼‰
L = 500.0  # m
roughness = 0.000045  # mï¼ˆå•†ç”¨é‹¼ç®¡ï¼‰

# æµä½“ç‰©æ€§ï¼ˆæ°´ã€20Â°Cï¼‰
rho = 998.0  # kg/mÂ³
mu = 1.002e-3  # PaÂ·s

pipe = PipePressureDrop(D, L, roughness)

# æµé‡ã‚’å¤‰ãˆã¦è¨ˆç®—
Q_values = [0.01, 0.05, 0.10, 0.20]  # mÂ³/s

print(f"\né…ç®¡ä»•æ§˜:")
print(f"  å†…å¾„: {D*1000:.0f} mm")
print(f"  é•·ã•: {L} m")
print(f"  ç²—ã•: {roughness*1e6:.1f} Î¼m")

print(f"\næµä½“ç‰©æ€§ï¼ˆæ°´ã€20Â°Cï¼‰:")
print(f"  å¯†åº¦: {rho} kg/mÂ³")
print(f"  ç²˜åº¦: {mu*1000:.3f} mPaÂ·s")

print(f"\nè¨ˆç®—çµæœ:")
print(f"{'æµé‡[mÂ³/h]':<12} {'æµé€Ÿ[m/s]':<10} {'Re':<10} {'æµå‹•æ§˜å¼':<10} "
      f"{'æ‘©æ“¦ä¿‚æ•°':<10} {'åœ§æ[kPa]':<12} {'å‹•åŠ›[kW]'}")
print("-" * 80)

for Q in Q_values:
    result = pipe.pressure_drop(Q, rho, mu)
    power = pipe.pump_power(Q, result['dP'])

    print(f"{Q*3600:<12.1f} {result['v']:<10.2f} {result['Re']:<10.0f} "
          f"{result['flow_regime']:<10} {result['f']:<10.4f} "
          f"{result['dP']:<12.2f} {power:<10.2f}")

# å‡ºåŠ›ä¾‹:
# ==============================================================
# é…ç®¡åœ§åŠ›æå¤±è¨ˆç®—ï¼ˆDarcy-Weisbachå¼ï¼‰
# ==============================================================
#
# é…ç®¡ä»•æ§˜:
#   å†…å¾„: 150 mm
#   é•·ã•: 500.0 m
#   ç²—ã•: 45.0 Î¼m
#
# æµä½“ç‰©æ€§ï¼ˆæ°´ã€20Â°Cï¼‰:
#   å¯†åº¦: 998.0 kg/mÂ³
#   ç²˜åº¦: 1.002 mPaÂ·s
#
# è¨ˆç®—çµæœ:
# æµé‡[mÂ³/h]   æµé€Ÿ[m/s]  Re         æµå‹•æ§˜å¼     æ‘©æ“¦ä¿‚æ•°     åœ§æ[kPa]     å‹•åŠ›[kW]
# --------------------------------------------------------------------------------
# 36.0         0.57       84698      ä¹±æµ        0.0193       8.18          0.03
# 180.0        2.83       423492     ä¹±æµ        0.0162       182.88        3.66
# 360.0        5.66       846985     ä¹±æµ        0.0154       692.34        36.90
# 720.0        11.31      1693970    ä¹±æµ        0.0148       2641.13       282.79
</code></pre>
        </section>

        <section>
            <h2>3.6 å­¦ç¿’ã®ã¾ã¨ã‚</h2>

            <div class="info-box">
                <h3>æœ¬ç« ã§å­¦ã‚“ã å˜ä½æ“ä½œãƒ¢ãƒ‡ãƒ«</h3>
                <ul>
                    <li><strong>è’¸ç•™å¡”</strong>: McCabe-Thieleæ³•ã€Fenske-Underwood-GillilandçŸ­çµ¡æ³•</li>
                    <li><strong>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥åˆ†é›¢</strong>: Rachford-Riceæ–¹ç¨‹å¼ã«ã‚ˆã‚‹æ°—æ¶²å¹³è¡¡è¨ˆç®—</li>
                    <li><strong>ç†±äº¤æ›å™¨</strong>: LMTDæ³•ã¨NTU-Îµæ³•ã®2ã¤ã®è¨­è¨ˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒ</li>
                    <li><strong>åå¿œå™¨</strong>: PFRã¨CSTRã®è¨­è¨ˆæ–¹ç¨‹å¼ã¨æ€§èƒ½æ¯”è¼ƒ</li>
                    <li><strong>åœ§åŠ›æå¤±</strong>: Darcy-Weisbachå¼ã¨ãƒãƒ³ãƒ—å‹•åŠ›è¨ˆç®—</li>
                </ul>
            </div>

            <div class="warning-box">
                <h3>å®Ÿå‹™é©ç”¨æ™‚ã®æ³¨æ„ç‚¹</h3>
                <ul>
                    <li>ç‰©æ€§å€¤ã®æ¸©åº¦ãƒ»åœ§åŠ›ä¾å­˜æ€§ã‚’æ­£ç¢ºã«è©•ä¾¡ã™ã‚‹ï¼ˆæœ¬ç« ã¯ç°¡ç•¥åŒ–ï¼‰</li>
                    <li>å¤šæˆåˆ†ç³»ã§ã¯çŠ¶æ…‹æ–¹ç¨‹å¼ï¼ˆPRã€SRKï¼‰ã‚’ä½¿ç”¨ã™ã‚‹</li>
                    <li>æ®µåŠ¹ç‡ãƒ»HETPï¼ˆç†è«–æ®µç›¸å½“é«˜ã•ï¼‰ã‚’å®Ÿé¨“å€¤ã§è£œæ­£ã™ã‚‹</li>
                    <li>å®‰å…¨ä¿‚æ•°ã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆãƒãƒ¼ã‚¸ãƒ³ã‚’å–ã‚‹</li>
                    <li>åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æˆè§£æãŒé‡è¦</li>
                </ul>
            </div>

            <div class="example-box">
                <h3>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>
                <p>
                    æœ¬ç« ã§å­¦ã‚“ã å˜ä½æ“ä½œãƒ¢ãƒ‡ãƒ«ã‚’çµ„ã¿åˆã‚ã›ã¦ã€ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
                    æ¬¡ç« ã§ã¯ã€ã“ã‚Œã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã‚’çµ±åˆã—ãŸãƒ•ãƒ­ãƒ¼ã‚·ãƒ¼ãƒˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å­¦ã³ã¾ã™ã€‚
                </p>
            </div>
        </section>

        <div class="nav-buttons">
            <a href="chapter-2.html" class="nav-button">â† ç¬¬2ç« ï¼šç‰©è³ªãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼åæ”¯</a>
            <a href="index.html" class="nav-button">ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡ã¸ â†’</a>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 PI Terakoya - Process Informatics Learning Platform</p>
    </footer>
</body>
</html>
