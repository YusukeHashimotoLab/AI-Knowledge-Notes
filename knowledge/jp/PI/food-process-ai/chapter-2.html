<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬2ç«  ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–ã¨å“è³ªç®¡ç† - é£Ÿå“ãƒ—ãƒ­ã‚»ã‚¹ã¸ã®AIå¿œç”¨</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #11998e;
            --accent-color: #38ef7d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.8; color: #2c3e50; background: #fff;
        }
        header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; padding: 3rem 2rem; text-align: center;
        }
        header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .breadcrumb {
            color: rgba(255,255,255,0.9); margin-bottom: 1rem; font-size: 0.9rem;
        }
        .breadcrumb a {
            color: white; text-decoration: none; border-bottom: 1px solid rgba(255,255,255,0.5);
        }
        main {
            max-width: 1200px; margin: 0 auto; padding: 3rem 2rem;
        }
        h2 {
            color: var(--primary-color); margin: 2rem 0 1rem 0; font-size: 1.8rem;
        }
        h3 {
            color: var(--secondary-color); margin: 1.5rem 0 0.75rem 0; font-size: 1.3rem;
        }
        p { margin-bottom: 1rem; line-height: 1.8; }
        ul, ol { margin-left: 2rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
        .code-example {
            margin: 2rem 0; background: #f8f9fa; border-radius: 8px;
            overflow: hidden; border-left: 4px solid #11998e;
        }
        .code-header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; padding: 1rem 1.5rem; font-weight: 600;
        }
        pre {
            background: #1e1e1e; color: #d4d4d4; padding: 1.5rem;
            overflow-x: auto; font-size: 0.9rem; line-height: 1.6;
        }
        .info-box {
            background: #e8f5e9; padding: 1.5rem; border-radius: 8px;
            border-left: 4px solid #4caf50; margin: 2rem 0;
        }
        .warning-box {
            background: #fff3e0; padding: 1.5rem; border-radius: 8px;
            border-left: 4px solid #ff9800; margin: 2rem 0;
        }
        .nav-buttons {
            display: flex; justify-content: space-between; margin: 3rem 0;
            padding: 2rem 0; border-top: 2px solid #e0e0e0;
        }
        .nav-button {
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; text-decoration: none; border-radius: 8px;
            font-weight: 600; transition: all 0.3s;
        }
        .nav-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(17,153,142,0.3); }
        footer {
            background: #2c3e50; color: white; text-align: center;
            padding: 2rem 1rem; margin-top: 4rem;
        }
        table {
            width: 100%; border-collapse: collapse; margin: 1.5rem 0;
        }
        th, td {
            padding: 0.75rem; text-align: left; border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f8f9fa; font-weight: 600; color: var(--primary-color);
        }
    </style>
</head>
<body>
    <header>
        <nav class="breadcrumb">
            <a href="../index.html">ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹é“å ´</a> /
            <a href="index.html">é£Ÿå“ãƒ—ãƒ­ã‚»ã‚¹ã¸ã®AIå¿œç”¨</a> /
            ç¬¬2ç« 
        </nav>
        <h1>ç¬¬2ç«  ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–ã¨å“è³ªç®¡ç†</h1>
        <p>Process Monitoring and Quality Control</p>
    </header>

    <main>
        <h2>2.1 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–</h2>
        <p>
            é£Ÿå“è£½é€ ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã¯ã€å“è³ªã®ä¸€è²«æ€§ã¨é£Ÿå“å®‰å…¨ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ä¸å¯æ¬ ã§ã™ã€‚
            æ¸©åº¦ã€åœ§åŠ›ã€æµé‡ãªã©ã®ç‰©ç†é‡ã«åŠ ãˆã€è¿‘èµ¤å¤–åˆ†å…‰ï¼ˆNIRï¼‰ã‚„ç”»åƒè§£æã«ã‚ˆã‚‹æˆåˆ†ãƒ»å“è³ªãƒ‡ãƒ¼ã‚¿ã®
            ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å–å¾—ãŒå¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚AIæŠ€è¡“ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€ã“ã‚Œã‚‰ã®å¤šå¤‰é‡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰
            ç•°å¸¸ã®æ—©æœŸæ¤œçŸ¥ã‚„å“è³ªäºˆæ¸¬ãŒå®Ÿç¾ã§ãã¾ã™ã€‚
        </p>

        <h3>ä¸»è¦ãªç›£è¦–é …ç›®</h3>
        <table>
            <thead>
                <tr>
                    <th>ç›£è¦–é …ç›®</th>
                    <th>æ¸¬å®šæ–¹æ³•</th>
                    <th>ç®¡ç†ç›®çš„</th>
                    <th>AIæ´»ç”¨</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>æ¸©åº¦</td>
                    <td>ç†±é›»å¯¾ã€PT100ã‚»ãƒ³ã‚µãƒ¼</td>
                    <td>æ®ºèŒåŠ¹æœã€å“è³ªç¶­æŒ</td>
                    <td>ç•°å¸¸æ¤œçŸ¥ã€Få€¤äºˆæ¸¬</td>
                </tr>
                <tr>
                    <td>åœ§åŠ›</td>
                    <td>åœ§åŠ›ã‚»ãƒ³ã‚µãƒ¼</td>
                    <td>è£…ç½®å®‰å…¨ã€ãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡</td>
                    <td>è£…ç½®åŠ£åŒ–äºˆæ¸¬</td>
                </tr>
                <tr>
                    <td>æµé‡</td>
                    <td>æµé‡è¨ˆï¼ˆé›»ç£å¼ã€è¶…éŸ³æ³¢å¼ï¼‰</td>
                    <td>é…åˆæ¯”åˆ¶å¾¡ã€åé‡ç®¡ç†</td>
                    <td>æµé‡ç•°å¸¸æ¤œçŸ¥</td>
                </tr>
                <tr>
                    <td>pH</td>
                    <td>pHã‚»ãƒ³ã‚µãƒ¼</td>
                    <td>ç™ºé…µç®¡ç†ã€å“è³ªåˆ¶å¾¡</td>
                    <td>ç™ºé…µçµ‚ç‚¹äºˆæ¸¬</td>
                </tr>
                <tr>
                    <td>ç³–åº¦</td>
                    <td>NIRåˆ†å…‰ã€å±ˆæŠ˜è¨ˆ</td>
                    <td>å“è³ªç®¡ç†ã€é…åˆåˆ¶å¾¡</td>
                    <td>å“è³ªäºˆæ¸¬</td>
                </tr>
                <tr>
                    <td>è‰²</td>
                    <td>ã‚«ãƒ©ãƒ¼ã‚»ãƒ³ã‚µãƒ¼ã€ç”»åƒè§£æ</td>
                    <td>ç„¼æˆåº¦ã€å“è³ªè©•ä¾¡</td>
                    <td>å¤–è¦³å“è³ªåˆ¤å®š</td>
                </tr>
                <tr>
                    <td>ç²˜åº¦</td>
                    <td>ç²˜åº¦è¨ˆï¼ˆå›è»¢å¼ã€æŒ¯å‹•å¼ï¼‰</td>
                    <td>é£Ÿæ„Ÿåˆ¶å¾¡ã€é…åˆç®¡ç†</td>
                    <td>é£Ÿæ„Ÿäºˆæ¸¬</td>
                </tr>
            </tbody>
        </table>

        <div class="code-example">
            <div class="code-header">ğŸ“Š ã‚³ãƒ¼ãƒ‰ä¾‹1: å¤šå¤‰é‡ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</div>
            <pre><code class="language-python">import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA
import seaborn as sns

# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ­ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
np.random.seed(42)
n_samples = 500

# æ­£å¸¸é‹è»¢ãƒ‡ãƒ¼ã‚¿ï¼ˆ400ã‚µãƒ³ãƒ—ãƒ«ï¼‰
normal_data = pd.DataFrame({
    'æ¸©åº¦_C': np.random.normal(85, 2, 400),
    'åœ§åŠ›_kPa': np.random.normal(150, 5, 400),
    'æµé‡_L/min': np.random.normal(50, 3, 400),
    'pH': np.random.normal(4.0, 0.2, 400),
    'ç³–åº¦_Brix': np.random.normal(12, 0.8, 400),
    'ç²˜åº¦_cP': np.random.normal(100, 10, 400),
})
normal_data['çŠ¶æ…‹'] = 'æ­£å¸¸'

# ç•°å¸¸ãƒ‡ãƒ¼ã‚¿ï¼ˆ100ã‚µãƒ³ãƒ—ãƒ«ï¼‰- è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
anomaly1 = pd.DataFrame({  # æ¸©åº¦ç•°å¸¸
    'æ¸©åº¦_C': np.random.normal(78, 2, 30),
    'åœ§åŠ›_kPa': np.random.normal(150, 5, 30),
    'æµé‡_L/min': np.random.normal(50, 3, 30),
    'pH': np.random.normal(4.0, 0.2, 30),
    'ç³–åº¦_Brix': np.random.normal(12, 0.8, 30),
    'ç²˜åº¦_cP': np.random.normal(100, 10, 30),
})
anomaly1['çŠ¶æ…‹'] = 'æ¸©åº¦ä½ä¸‹'

anomaly2 = pd.DataFrame({  # åœ§åŠ›ç•°å¸¸
    'æ¸©åº¦_C': np.random.normal(85, 2, 30),
    'åœ§åŠ›_kPa': np.random.normal(170, 5, 30),
    'æµé‡_L/min': np.random.normal(50, 3, 30),
    'pH': np.random.normal(4.0, 0.2, 30),
    'ç³–åº¦_Brix': np.random.normal(12, 0.8, 30),
    'ç²˜åº¦_cP': np.random.normal(100, 10, 30),
})
anomaly2['çŠ¶æ…‹'] = 'åœ§åŠ›ä¸Šæ˜‡'

anomaly3 = pd.DataFrame({  # å¤šå¤‰é‡ç•°å¸¸ï¼ˆå“è³ªåŠ£åŒ–ï¼‰
    'æ¸©åº¦_C': np.random.normal(83, 2, 40),
    'åœ§åŠ›_kPa': np.random.normal(145, 5, 40),
    'æµé‡_L/min': np.random.normal(55, 3, 40),
    'pH': np.random.normal(4.3, 0.2, 40),
    'ç³–åº¦_Brix': np.random.normal(13, 0.8, 40),
    'ç²˜åº¦_cP': np.random.normal(110, 10, 40),
})
anomaly3['çŠ¶æ…‹'] = 'å“è³ªåŠ£åŒ–'

# ãƒ‡ãƒ¼ã‚¿çµåˆ
data = pd.concat([normal_data, anomaly1, anomaly2, anomaly3], ignore_index=True)

# ç‰¹å¾´é‡ã®æ¨™æº–åŒ–
features = ['æ¸©åº¦_C', 'åœ§åŠ›_kPa', 'æµé‡_L/min', 'pH', 'ç³–åº¦_Brix', 'ç²˜åº¦_cP']
scaler = StandardScaler()
data_scaled = scaler.fit_transform(data[features])

# PCAã«ã‚ˆã‚‹æ¬¡å…ƒå‰Šæ¸›ï¼ˆ6æ¬¡å…ƒ â†’ 2æ¬¡å…ƒï¼‰
pca = PCA(n_components=2)
data_pca = pca.fit_transform(data_scaled)

# å¯è¦–åŒ–
fig = plt.figure(figsize=(16, 10))
gs = fig.add_gridspec(3, 2, hspace=0.3, wspace=0.3)

# 1. PCAã‚¹ã‚³ã‚¢ãƒ—ãƒ­ãƒƒãƒˆ
ax1 = fig.add_subplot(gs[0, :])
colors = {'æ­£å¸¸': '#11998e', 'æ¸©åº¦ä½ä¸‹': '#ff6b6b', 'åœ§åŠ›ä¸Šæ˜‡': '#ffa500', 'å“è³ªåŠ£åŒ–': '#9b59b6'}
for state in data['çŠ¶æ…‹'].unique():
    mask = data['çŠ¶æ…‹'] == state
    ax1.scatter(data_pca[mask, 0], data_pca[mask, 1], 
                label=state, alpha=0.6, s=50, color=colors[state])
ax1.set_xlabel(f'PC1 ({pca.explained_variance_ratio_[0]*100:.1f}% èª¬æ˜)', fontsize=12)
ax1.set_ylabel(f'PC2 ({pca.explained_variance_ratio_[1]*100:.1f}% èª¬æ˜)', fontsize=12)
ax1.set_title('ä¸»æˆåˆ†åˆ†æã«ã‚ˆã‚‹ç•°å¸¸æ¤œçŸ¥ï¼ˆPCAã‚¹ã‚³ã‚¢ãƒ—ãƒ­ãƒƒãƒˆï¼‰', fontsize=14, fontweight='bold')
ax1.legend(loc='best', fontsize=10)
ax1.grid(True, alpha=0.3)

# 2. å¯„ä¸ç‡ãƒ—ãƒ­ãƒƒãƒˆ
ax2 = fig.add_subplot(gs[1, 0])
ax2.bar(range(len(pca.explained_variance_ratio_)), 
        pca.explained_variance_ratio_, color='#11998e', alpha=0.7)
ax2.set_xlabel('ä¸»æˆåˆ†', fontsize=11)
ax2.set_ylabel('å¯„ä¸ç‡', fontsize=11)
ax2.set_title('ä¸»æˆåˆ†ã®å¯„ä¸ç‡', fontsize=12, fontweight='bold')
ax2.grid(True, alpha=0.3, axis='y')

# 3. å› å­è² è·é‡
ax3 = fig.add_subplot(gs[1, 1])
loadings = pca.components_.T * np.sqrt(pca.explained_variance_)
for i, feature in enumerate(features):
    ax3.arrow(0, 0, loadings[i, 0], loadings[i, 1],
              head_width=0.05, head_length=0.05, fc='#11998e', ec='#11998e')
    ax3.text(loadings[i, 0]*1.15, loadings[i, 1]*1.15, feature,
             fontsize=10, ha='center', va='center')
ax3.set_xlim(-1, 1)
ax3.set_ylim(-1, 1)
ax3.axhline(0, color='gray', linestyle='--', alpha=0.5)
ax3.axvline(0, color='gray', linestyle='--', alpha=0.5)
ax3.set_xlabel('PC1', fontsize=11)
ax3.set_ylabel('PC2', fontsize=11)
ax3.set_title('å› å­è² è·é‡ï¼ˆå¤‰æ•°ã®å¯„ä¸ï¼‰', fontsize=12, fontweight='bold')
ax3.grid(True, alpha=0.3)

# 4-6. ä¸»è¦å¤‰æ•°ã®æ™‚ç³»åˆ—ãƒ—ãƒ­ãƒƒãƒˆ
time = np.arange(len(data))
axes = [fig.add_subplot(gs[2, 0]), fig.add_subplot(gs[2, 1])]
plot_vars = ['æ¸©åº¦_C', 'åœ§åŠ›_kPa']
for ax, var in zip(axes, plot_vars):
    ax.plot(time[:400], data[var][:400], color='#11998e', alpha=0.7, linewidth=1, label='æ­£å¸¸')
    ax.plot(time[400:], data[var][400:], color='#ff6b6b', alpha=0.7, linewidth=1, label='ç•°å¸¸')
    ax.set_xlabel('ã‚µãƒ³ãƒ—ãƒ«ç•ªå·', fontsize=11)
    ax.set_ylabel(var, fontsize=11)
    ax.set_title(f'{var}ã®æ™‚ç³»åˆ—å¤‰åŒ–', fontsize=12, fontweight='bold')
    ax.legend(fontsize=10)
    ax.grid(True, alpha=0.3)

plt.savefig('multivariate_monitoring.png', dpi=300, bbox_inches='tight')
plt.show()

# çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ
print("=== ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ ===")
print(f"\nç·ã‚µãƒ³ãƒ—ãƒ«æ•°: {len(data)}")
print(f"æ­£å¸¸ãƒ‡ãƒ¼ã‚¿: {len(normal_data)} ({len(normal_data)/len(data)*100:.1f}%)")
print(f"ç•°å¸¸ãƒ‡ãƒ¼ã‚¿: {len(data)-len(normal_data)} ({(len(data)-len(normal_data))/len(data)*100:.1f}%)")

print("\n=== ä¸»æˆåˆ†åˆ†æçµæœ ===")
print(f"ç´¯ç©å¯„ä¸ç‡ï¼ˆPC1+PC2ï¼‰: {pca.explained_variance_ratio_.sum()*100:.1f}%")
print("\nå› å­è² è·é‡:")
loadings_df = pd.DataFrame(loadings[:, :2], index=features, columns=['PC1', 'PC2'])
print(loadings_df.round(3))

print("\n=== çŠ¶æ…‹åˆ¥çµ±è¨ˆ ===")
for state in data['çŠ¶æ…‹'].unique():
    state_data = data[data['çŠ¶æ…‹'] == state]
    print(f"\n{state}:")
    print(state_data[features].describe().loc[['mean', 'std']].round(2))</code></pre>
        </div>

        <h2>2.2 å®˜èƒ½è©•ä¾¡ã¨AI</h2>
        <p>
            é£Ÿå“ã®å“è³ªè©•ä¾¡ã«ãŠã„ã¦ã€å®˜èƒ½è©•ä¾¡ï¼ˆé¢¨å‘³ã€é£Ÿæ„Ÿã€è‰²ã€é¦™ã‚Šï¼‰ã¯æ¥µã‚ã¦é‡è¦ã§ã™ã€‚
            ã—ã‹ã—ã€å®˜èƒ½è©•ä¾¡ã¯ä¸»è¦³çš„ã§ã€è©•ä¾¡è€…é–“ã®ã°ã‚‰ã¤ããŒå¤§ãã„ã¨ã„ã†èª²é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
            AIæŠ€è¡“ã€ç‰¹ã«æ©Ÿæ¢°å­¦ç¿’ã¨ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€å®¢è¦³çš„ãªå“è³ªäºˆæ¸¬ã‚„
            å®˜èƒ½è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã®å®šé‡åŒ–ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
        </p>

        <div class="info-box">
            <h3>ğŸ½ï¸ å®˜èƒ½è©•ä¾¡ã®5ã¤ã®æ„Ÿè¦š</h3>
            <ul>
                <li><strong>å‘³è¦š</strong>: ç”˜å‘³ã€é…¸å‘³ã€å¡©å‘³ã€è‹¦å‘³ã€ã†ã¾å‘³ï¼ˆ5åŸºæœ¬å‘³ï¼‰</li>
                <li><strong>å—…è¦š</strong>: é¦™ã‚Šæˆåˆ†ã®è¤‡é›‘ãªçµ„ã¿åˆã‚ã›ï¼ˆæ•°åƒç¨®é¡ï¼‰</li>
                <li><strong>è§¦è¦š</strong>: é£Ÿæ„Ÿï¼ˆç¡¬ã•ã€ç²˜æ€§ã€æ»‘ã‚‰ã‹ã•ã€ã‚¯ãƒªã‚¹ãƒ”ãƒ¼ã•ï¼‰</li>
                <li><strong>è¦–è¦š</strong>: è‰²ã€å½¢ã€å…‰æ²¢ã€é€æ˜åº¦</li>
                <li><strong>è´è¦š</strong>: å’€åš¼éŸ³ã€ãƒ‘ãƒªãƒ‘ãƒªæ„Ÿ</li>
            </ul>
        </div>

        <div class="code-example">
            <div class="code-header">ğŸ“Š ã‚³ãƒ¼ãƒ‰ä¾‹2: å®˜èƒ½è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã®å¤šå¤‰é‡è§£æã¨å“è³ªäºˆæ¸¬</div>
            <pre><code class="language-python">import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split, cross_val_score
from sklearn.metrics import mean_squared_error, r2_score
import seaborn as sns

# å®˜èƒ½è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ç”Ÿæˆ
np.random.seed(42)
n_samples = 300

# ç†åŒ–å­¦åˆ†æãƒ‡ãƒ¼ã‚¿
sensory_data = pd.DataFrame({
    'ç³–åº¦_Brix': np.random.uniform(10, 15, n_samples),
    'é…¸åº¦_%': np.random.uniform(0.3, 0.8, n_samples),
    'æ°´åˆ†å«é‡_%': np.random.uniform(80, 90, n_samples),
    'ç¡¬åº¦_N': np.random.uniform(5, 15, n_samples),
    'è‰²_Lå€¤': np.random.uniform(60, 80, n_samples),
    'é¦™æ°—æˆåˆ†_ppm': np.random.uniform(50, 150, n_samples),
})

# å®˜èƒ½è©•ä¾¡ã‚¹ã‚³ã‚¢ï¼ˆç·åˆè©•ä¾¡ï¼‰: è¤‡é›‘ãªéç·šå½¢é–¢ä¿‚ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
sensory_data['ç”˜å‘³ã‚¹ã‚³ã‚¢'] = (
    8 * sensory_data['ç³–åº¦_Brix'] / 15 +
    np.random.normal(0, 0.5, n_samples)
).clip(1, 10)

sensory_data['é…¸å‘³ã‚¹ã‚³ã‚¢'] = (
    8 * sensory_data['é…¸åº¦_%'] / 0.8 +
    np.random.normal(0, 0.5, n_samples)
).clip(1, 10)

sensory_data['é£Ÿæ„Ÿã‚¹ã‚³ã‚¢'] = (
    5 + 3 * np.sin(sensory_data['ç¡¬åº¦_N'] / 5) +
    np.random.normal(0, 0.5, n_samples)
).clip(1, 10)

sensory_data['é¦™ã‚Šã‚¹ã‚³ã‚¢'] = (
    4 + 4 * np.log(sensory_data['é¦™æ°—æˆåˆ†_ppm'] / 50) +
    np.random.normal(0, 0.5, n_samples)
).clip(1, 10)

# ç·åˆè©•ä¾¡ï¼ˆå„ã‚¹ã‚³ã‚¢ã®åŠ é‡å¹³å‡ï¼‰
sensory_data['ç·åˆè©•ä¾¡'] = (
    0.3 * sensory_data['ç”˜å‘³ã‚¹ã‚³ã‚¢'] +
    0.2 * sensory_data['é…¸å‘³ã‚¹ã‚³ã‚¢'] +
    0.3 * sensory_data['é£Ÿæ„Ÿã‚¹ã‚³ã‚¢'] +
    0.2 * sensory_data['é¦™ã‚Šã‚¹ã‚³ã‚¢'] +
    np.random.normal(0, 0.3, n_samples)
).clip(1, 10)

# ç‰¹å¾´é‡ã¨ç›®çš„å¤‰æ•°
X = sensory_data[['ç³–åº¦_Brix', 'é…¸åº¦_%', 'æ°´åˆ†å«é‡_%', 'ç¡¬åº¦_N', 'è‰²_Lå€¤', 'é¦™æ°—æˆåˆ†_ppm']]
y = sensory_data['ç·åˆè©•ä¾¡']

# ãƒ‡ãƒ¼ã‚¿åˆ†å‰²
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰
model = RandomForestRegressor(n_estimators=200, max_depth=15, random_state=42, n_jobs=-1)
model.fit(X_train, y_train)

# äºˆæ¸¬ã¨è©•ä¾¡
y_pred = model.predict(X_test)
r2 = r2_score(y_test, y_pred)
rmse = np.sqrt(mean_squared_error(y_test, y_pred))
cv_scores = cross_val_score(model, X_train, y_train, cv=5, scoring='r2')

# å¯è¦–åŒ–
fig = plt.figure(figsize=(16, 10))
gs = fig.add_gridspec(2, 3, hspace=0.3, wspace=0.3)

# 1. äºˆæ¸¬vså®Ÿæ¸¬å€¤
ax1 = fig.add_subplot(gs[0, 0])
ax1.scatter(y_test, y_pred, alpha=0.6, s=60, color='#11998e', edgecolors='white', linewidth=0.5)
ax1.plot([y_test.min(), y_test.max()], [y_test.min(), y_test.max()],
         'r--', lw=2, label='ç†æƒ³ãƒ©ã‚¤ãƒ³')
ax1.set_xlabel('å®Ÿæ¸¬å€¤ï¼ˆå®˜èƒ½è©•ä¾¡ï¼‰', fontsize=12)
ax1.set_ylabel('äºˆæ¸¬å€¤ï¼ˆAIãƒ¢ãƒ‡ãƒ«ï¼‰', fontsize=12)
ax1.set_title(f'å®˜èƒ½è©•ä¾¡äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«\n(RÂ²={r2:.3f}, RMSE={rmse:.3f})', 
              fontsize=13, fontweight='bold')
ax1.legend(fontsize=10)
ax1.grid(True, alpha=0.3)

# 2. æ®‹å·®ãƒ—ãƒ­ãƒƒãƒˆ
ax2 = fig.add_subplot(gs[0, 1])
residuals = y_test - y_pred
ax2.scatter(y_pred, residuals, alpha=0.6, s=60, color='#38ef7d', edgecolors='white', linewidth=0.5)
ax2.axhline(0, color='red', linestyle='--', lw=2)
ax2.set_xlabel('äºˆæ¸¬å€¤', fontsize=12)
ax2.set_ylabel('æ®‹å·®ï¼ˆå®Ÿæ¸¬å€¤ - äºˆæ¸¬å€¤ï¼‰', fontsize=12)
ax2.set_title('æ®‹å·®ãƒ—ãƒ­ãƒƒãƒˆ', fontsize=13, fontweight='bold')
ax2.grid(True, alpha=0.3)

# 3. ç‰¹å¾´é‡é‡è¦åº¦
ax3 = fig.add_subplot(gs[0, 2])
feature_importance = pd.DataFrame({
    'ç‰¹å¾´é‡': X.columns,
    'é‡è¦åº¦': model.feature_importances_
}).sort_values('é‡è¦åº¦', ascending=True)

ax3.barh(feature_importance['ç‰¹å¾´é‡'], feature_importance['é‡è¦åº¦'], color='#11998e')
ax3.set_xlabel('é‡è¦åº¦', fontsize=12)
ax3.set_title('ç‰¹å¾´é‡é‡è¦åº¦', fontsize=13, fontweight='bold')
ax3.grid(True, alpha=0.3, axis='x')

# 4. ç›¸é–¢è¡Œåˆ—ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
ax4 = fig.add_subplot(gs[1, :])
corr_data = sensory_data[['ç³–åº¦_Brix', 'é…¸åº¦_%', 'ç¡¬åº¦_N', 'é¦™æ°—æˆåˆ†_ppm', 
                           'ç”˜å‘³ã‚¹ã‚³ã‚¢', 'é…¸å‘³ã‚¹ã‚³ã‚¢', 'é£Ÿæ„Ÿã‚¹ã‚³ã‚¢', 'é¦™ã‚Šã‚¹ã‚³ã‚¢', 'ç·åˆè©•ä¾¡']]
correlation_matrix = corr_data.corr()

sns.heatmap(correlation_matrix, annot=True, fmt='.2f', cmap='RdYlGn', center=0,
            square=True, linewidths=1, cbar_kws={'label': 'ç›¸é–¢ä¿‚æ•°'}, ax=ax4)
ax4.set_title('ç†åŒ–å­¦åˆ†æå€¤ã¨å®˜èƒ½è©•ä¾¡ã‚¹ã‚³ã‚¢ã®ç›¸é–¢', fontsize=13, fontweight='bold')

plt.savefig('sensory_evaluation_ai.png', dpi=300, bbox_inches='tight')
plt.show()

# ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
print("=== å®˜èƒ½è©•ä¾¡äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ ===")
print(f"æ±ºå®šä¿‚æ•° RÂ²: {r2:.4f}")
print(f"RMSE: {rmse:.4f}")
print(f"äº¤å·®æ¤œè¨¼ RÂ² (å¹³å‡Â±æ¨™æº–åå·®): {cv_scores.mean():.4f} Â± {cv_scores.std():.4f}")

print("\n=== ç‰¹å¾´é‡é‡è¦åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===")
feature_ranking = pd.DataFrame({
    'ç‰¹å¾´é‡': X.columns,
    'é‡è¦åº¦': model.feature_importances_
}).sort_values('é‡è¦åº¦', ascending=False)
print(feature_ranking.to_string(index=False))

print("\n=== å®˜èƒ½è©•ä¾¡ã‚¹ã‚³ã‚¢çµ±è¨ˆ ===")
print(sensory_data[['ç”˜å‘³ã‚¹ã‚³ã‚¢', 'é…¸å‘³ã‚¹ã‚³ã‚¢', 'é£Ÿæ„Ÿã‚¹ã‚³ã‚¢', 'é¦™ã‚Šã‚¹ã‚³ã‚¢', 'ç·åˆè©•ä¾¡']].describe())</code></pre>
        </div>

        <h2>2.3 ç”»åƒè§£æã«ã‚ˆã‚‹å¤–è¦³å“è³ªè©•ä¾¡</h2>
        <p>
            é£Ÿå“ã®å¤–è¦³å“è³ªï¼ˆè‰²ã€å½¢çŠ¶ã€è¡¨é¢çŠ¶æ…‹ï¼‰ã¯ã€æ¶ˆè²»è€…ã®è³¼è²·æ„æ¬²ã«ç›´çµã™ã‚‹é‡è¦ãªè¦ç´ ã§ã™ã€‚
            å¾“æ¥ã¯äººã®ç›®è¦–æ¤œæŸ»ã«ä¾å­˜ã—ã¦ã„ã¾ã—ãŸãŒã€ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆç‰¹ã«CNN: Convolutional Neural Networkï¼‰ã‚’
            ç”¨ã„ãŸç”»åƒè§£æã«ã‚ˆã‚Šã€å®¢è¦³çš„ã‹ã¤é«˜é€Ÿãªå“è³ªåˆ¤å®šãŒå¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚
        </p>

        <div class="code-example">
            <div class="code-header">ğŸ“Š ã‚³ãƒ¼ãƒ‰ä¾‹3: ç”»åƒç‰¹å¾´é‡æŠ½å‡ºã¨å“è³ªåˆ†é¡ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰</div>
            <pre><code class="language-python">import numpy as np
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split, cross_val_score
from sklearn.metrics import classification_report, confusion_matrix
import seaborn as sns

# ç”»åƒç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿéš›ã«ã¯CNNã§æŠ½å‡ºï¼‰
np.random.seed(42)
n_samples_per_class = 200

# 3ã¤ã®å“è³ªã‚¯ãƒ©ã‚¹: Aå“ï¼ˆå„ªè‰¯ï¼‰ã€Bå“ï¼ˆæ¨™æº–ï¼‰ã€Cå“ï¼ˆä¸è‰¯ï¼‰
def generate_class_data(mean_color, std_color, mean_shape, std_shape, mean_texture, std_texture, label):
    return pd.DataFrame({
        'å¹³å‡è‰²_R': np.random.normal(mean_color[0], std_color, n_samples_per_class),
        'å¹³å‡è‰²_G': np.random.normal(mean_color[1], std_color, n_samples_per_class),
        'å¹³å‡è‰²_B': np.random.normal(mean_color[2], std_color, n_samples_per_class),
        'å½¢çŠ¶_å††å½¢åº¦': np.random.normal(mean_shape, std_shape, n_samples_per_class),
        'è¡¨é¢ç²—ã•': np.random.normal(mean_texture, std_texture, n_samples_per_class),
        'ã‚µã‚¤ã‚º_mm2': np.random.normal(100, 10, n_samples_per_class),
        'å“è³ªã‚¯ãƒ©ã‚¹': label
    })

# Aå“: æ˜ã‚‹ã„è‰²ã€é«˜ã„å††å½¢åº¦ã€æ»‘ã‚‰ã‹ãªè¡¨é¢
class_A = generate_class_data(
    mean_color=[180, 150, 120], std_color=10,
    mean_shape=0.85, std_shape=0.05,
    mean_texture=5, std_texture=2,
    label='Aå“ï¼ˆå„ªè‰¯ï¼‰'
)

# Bå“: ä¸­é–“çš„ãªç‰¹å¾´
class_B = generate_class_data(
    mean_color=[160, 130, 100], std_color=15,
    mean_shape=0.75, std_shape=0.08,
    mean_texture=10, std_texture=3,
    label='Bå“ï¼ˆæ¨™æº–ï¼‰'
)

# Cå“: æš—ã„è‰²ã€ä½ã„å††å½¢åº¦ã€ç²—ã„è¡¨é¢
class_C = generate_class_data(
    mean_color=[140, 110, 80], std_color=20,
    mean_shape=0.60, std_shape=0.10,
    mean_texture=18, std_texture=5,
    label='Cå“ï¼ˆä¸è‰¯ï¼‰'
)

# ãƒ‡ãƒ¼ã‚¿çµåˆ
image_data = pd.concat([class_A, class_B, class_C], ignore_index=True)

# ç‰¹å¾´é‡ã¨ç›®çš„å¤‰æ•°
X = image_data.drop('å“è³ªã‚¯ãƒ©ã‚¹', axis=1)
y = image_data['å“è³ªã‚¯ãƒ©ã‚¹']

# ãƒ‡ãƒ¼ã‚¿åˆ†å‰²
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)

# åˆ†é¡ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰
clf = RandomForestClassifier(n_estimators=200, max_depth=20, random_state=42, n_jobs=-1)
clf.fit(X_train, y_train)

# äºˆæ¸¬ã¨è©•ä¾¡
y_pred = clf.predict(X_test)
accuracy = clf.score(X_test, y_test)
cv_scores = cross_val_score(clf, X_train, y_train, cv=5, scoring='accuracy')

# æ··åŒè¡Œåˆ—
cm = confusion_matrix(y_test, y_pred, labels=['Aå“ï¼ˆå„ªè‰¯ï¼‰', 'Bå“ï¼ˆæ¨™æº–ï¼‰', 'Cå“ï¼ˆä¸è‰¯ï¼‰'])

# å¯è¦–åŒ–
fig = plt.figure(figsize=(16, 10))
gs = fig.add_gridspec(2, 3, hspace=0.3, wspace=0.3)

# 1. æ··åŒè¡Œåˆ—
ax1 = fig.add_subplot(gs[0, 0])
sns.heatmap(cm, annot=True, fmt='d', cmap='Blues', 
            xticklabels=['Aå“', 'Bå“', 'Cå“'],
            yticklabels=['Aå“', 'Bå“', 'Cå“'],
            ax=ax1, cbar_kws={'label': 'ã‚µãƒ³ãƒ—ãƒ«æ•°'})
ax1.set_xlabel('äºˆæ¸¬ã‚¯ãƒ©ã‚¹', fontsize=12)
ax1.set_ylabel('å®Ÿéš›ã®ã‚¯ãƒ©ã‚¹', fontsize=12)
ax1.set_title(f'æ··åŒè¡Œåˆ—\n(ç²¾åº¦={accuracy:.3f})', fontsize=13, fontweight='bold')

# 2. ç‰¹å¾´é‡é‡è¦åº¦
ax2 = fig.add_subplot(gs[0, 1])
feature_importance = pd.DataFrame({
    'ç‰¹å¾´é‡': X.columns,
    'é‡è¦åº¦': clf.feature_importances_
}).sort_values('é‡è¦åº¦', ascending=True)

ax2.barh(feature_importance['ç‰¹å¾´é‡'], feature_importance['é‡è¦åº¦'], color='#11998e')
ax2.set_xlabel('é‡è¦åº¦', fontsize=12)
ax2.set_title('ç”»åƒç‰¹å¾´é‡ã®é‡è¦åº¦', fontsize=13, fontweight='bold')
ax2.grid(True, alpha=0.3, axis='x')

# 3. ã‚¯ãƒ©ã‚¹åˆ¥ã®è‰²åˆ†å¸ƒ
ax3 = fig.add_subplot(gs[0, 2])
colors_map = {'Aå“ï¼ˆå„ªè‰¯ï¼‰': '#4caf50', 'Bå“ï¼ˆæ¨™æº–ï¼‰': '#ff9800', 'Cå“ï¼ˆä¸è‰¯ï¼‰': '#f44336'}
for label in ['Aå“ï¼ˆå„ªè‰¯ï¼‰', 'Bå“ï¼ˆæ¨™æº–ï¼‰', 'Cå“ï¼ˆä¸è‰¯ï¼‰']:
    class_data = image_data[image_data['å“è³ªã‚¯ãƒ©ã‚¹'] == label]
    ax3.scatter(class_data['å¹³å‡è‰²_R'], class_data['å¹³å‡è‰²_G'], 
                label=label, alpha=0.6, s=40, color=colors_map[label])
ax3.set_xlabel('å¹³å‡è‰² Rå€¤', fontsize=12)
ax3.set_ylabel('å¹³å‡è‰² Gå€¤', fontsize=12)
ax3.set_title('è‰²ç©ºé–“ã§ã®å“è³ªã‚¯ãƒ©ã‚¹åˆ†å¸ƒ', fontsize=13, fontweight='bold')
ax3.legend(fontsize=10)
ax3.grid(True, alpha=0.3)

# 4. å½¢çŠ¶ã¨è¡¨é¢ç²—ã•ã®é–¢ä¿‚
ax4 = fig.add_subplot(gs[1, 0])
for label in ['Aå“ï¼ˆå„ªè‰¯ï¼‰', 'Bå“ï¼ˆæ¨™æº–ï¼‰', 'Cå“ï¼ˆä¸è‰¯ï¼‰']:
    class_data = image_data[image_data['å“è³ªã‚¯ãƒ©ã‚¹'] == label]
    ax4.scatter(class_data['å½¢çŠ¶_å††å½¢åº¦'], class_data['è¡¨é¢ç²—ã•'], 
                label=label, alpha=0.6, s=40, color=colors_map[label])
ax4.set_xlabel('å½¢çŠ¶å††å½¢åº¦', fontsize=12)
ax4.set_ylabel('è¡¨é¢ç²—ã•', fontsize=12)
ax4.set_title('å½¢çŠ¶ã¨è¡¨é¢ç²—ã•ã®é–¢ä¿‚', fontsize=13, fontweight='bold')
ax4.legend(fontsize=10)
ax4.grid(True, alpha=0.3)

# 5. ã‚¯ãƒ©ã‚¹åˆ¥ç‰¹å¾´é‡åˆ†å¸ƒï¼ˆãƒã‚¤ã‚ªãƒªãƒ³ãƒ—ãƒ­ãƒƒãƒˆï¼‰
ax5 = fig.add_subplot(gs[1, 1:])
plot_data = image_data[['å½¢çŠ¶_å††å½¢åº¦', 'è¡¨é¢ç²—ã•', 'å“è³ªã‚¯ãƒ©ã‚¹']].melt(
    id_vars='å“è³ªã‚¯ãƒ©ã‚¹', var_name='ç‰¹å¾´é‡', value_name='å€¤')

sns.violinplot(data=plot_data, x='ç‰¹å¾´é‡', y='å€¤', hue='å“è³ªã‚¯ãƒ©ã‚¹',
               palette={'Aå“ï¼ˆå„ªè‰¯ï¼‰': '#4caf50', 'Bå“ï¼ˆæ¨™æº–ï¼‰': '#ff9800', 'Cå“ï¼ˆä¸è‰¯ï¼‰': '#f44336'},
               split=False, ax=ax5)
ax5.set_title('å“è³ªã‚¯ãƒ©ã‚¹åˆ¥ã®ç‰¹å¾´é‡åˆ†å¸ƒ', fontsize=13, fontweight='bold')
ax5.legend(title='å“è³ªã‚¯ãƒ©ã‚¹', fontsize=10)
ax5.grid(True, alpha=0.3, axis='y')

plt.savefig('image_quality_classification.png', dpi=300, bbox_inches='tight')
plt.show()

# ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
print("=== ç”»åƒå“è³ªåˆ†é¡ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ ===")
print(f"ç²¾åº¦ï¼ˆAccuracyï¼‰: {accuracy:.4f}")
print(f"äº¤å·®æ¤œè¨¼ç²¾åº¦ (å¹³å‡Â±æ¨™æº–åå·®): {cv_scores.mean():.4f} Â± {cv_scores.std():.4f}")

print("\n=== è©³ç´°åˆ†é¡ãƒ¬ãƒãƒ¼ãƒˆ ===")
print(classification_report(y_test, y_pred))

print("\n=== ã‚¯ãƒ©ã‚¹åˆ¥çµ±è¨ˆ ===")
for label in ['Aå“ï¼ˆå„ªè‰¯ï¼‰', 'Bå“ï¼ˆæ¨™æº–ï¼‰', 'Cå“ï¼ˆä¸è‰¯ï¼‰']:
    class_data = image_data[image_data['å“è³ªã‚¯ãƒ©ã‚¹'] == label]
    print(f"\n{label}:")
    print(class_data[['å¹³å‡è‰²_R', 'å½¢çŠ¶_å††å½¢åº¦', 'è¡¨é¢ç²—ã•']].describe().loc[['mean', 'std']].round(2))</code></pre>
        </div>

        <h2>2.4 çµ±è¨ˆçš„å“è³ªç®¡ç†ï¼ˆSQCï¼‰</h2>
        <p>
            çµ±è¨ˆçš„å“è³ªç®¡ç†ï¼ˆStatistical Quality Control: SQCï¼‰ã¯ã€ãƒ—ãƒ­ã‚»ã‚¹ã®å¤‰å‹•ã‚’çµ±è¨ˆçš„æ‰‹æ³•ã§ç›£è¦–ãƒ»ç®¡ç†ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚
            ç®¡ç†å›³ï¼ˆControl Chartï¼‰ã‚’ç”¨ã„ã¦ã€ãƒ—ãƒ­ã‚»ã‚¹ãŒç®¡ç†çŠ¶æ…‹ã«ã‚ã‚‹ã‹ã‚’åˆ¤å®šã—ã€ç•°å¸¸ã®æ—©æœŸæ¤œçŸ¥ã‚’è¡Œã„ã¾ã™ã€‚
        </p>

        <div class="code-example">
            <div class="code-header">ğŸ“Š ã‚³ãƒ¼ãƒ‰ä¾‹4: X-Rç®¡ç†å›³ã¨ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›æŒ‡æ•°</div>
            <pre><code class="language-python">import numpy as np
import matplotlib.pyplot as plt
import pandas as pd

# è£½é€ ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆï¼ˆã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º n=5 ã®ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
np.random.seed(42)
n_subgroups = 30
subgroup_size = 5
target = 100  # ç›®æ¨™å€¤
spec_lower = 95  # è¦æ ¼ä¸‹é™
spec_upper = 105  # è¦æ ¼ä¸Šé™

# æ­£å¸¸ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆ20ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰+ ç•°å¸¸ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆ10ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã€å¹³å‡ã‚·ãƒ•ãƒˆï¼‰
normal_data = np.random.normal(target, 2, (20, subgroup_size))
abnormal_data = np.random.normal(target + 3, 2, (10, subgroup_size))
data = np.vstack([normal_data, abnormal_data])

# X-barï¼ˆå¹³å‡å€¤ï¼‰ã¨Rï¼ˆç¯„å›²ï¼‰ã®è¨ˆç®—
xbar = data.mean(axis=1)
R = data.max(axis=1) - data.min(axis=1)

# ç®¡ç†é™ç•Œç·šã®è¨ˆç®—
xbar_grand = xbar.mean()
R_bar = R.mean()

# ç®¡ç†å›³ä¿‚æ•°ï¼ˆn=5ã®å ´åˆï¼‰
A2 = 0.577  # X-barç®¡ç†å›³ä¿‚æ•°
D3 = 0      # Rç®¡ç†å›³ä¸‹é™ä¿‚æ•°
D4 = 2.114  # Rç®¡ç†å›³ä¸Šé™ä¿‚æ•°

# X-barç®¡ç†å›³ã®ç®¡ç†é™ç•Œ
UCL_xbar = xbar_grand + A2 * R_bar
LCL_xbar = xbar_grand - A2 * R_bar

# Rç®¡ç†å›³ã®ç®¡ç†é™ç•Œ
UCL_R = D4 * R_bar
LCL_R = D3 * R_bar

# ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›æŒ‡æ•°ã®è¨ˆç®—
sigma_hat = R_bar / 1.693  # d2=2.326 for n=5, sigma = R_bar / d2
Cp = (spec_upper - spec_lower) / (6 * sigma_hat)
Cpk = min((spec_upper - xbar_grand), (xbar_grand - spec_lower)) / (3 * sigma_hat)

# å¯è¦–åŒ–
fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(16, 12))

# 1. X-barç®¡ç†å›³
ax1.plot(range(1, n_subgroups+1), xbar, marker='o', color='#11998e', linewidth=2, markersize=6)
ax1.axhline(xbar_grand, color='green', linestyle='-', linewidth=2, label='ä¸­å¿ƒç·šï¼ˆCLï¼‰')
ax1.axhline(UCL_xbar, color='red', linestyle='--', linewidth=2, label='ä¸Šæ–¹ç®¡ç†é™ç•Œï¼ˆUCLï¼‰')
ax1.axhline(LCL_xbar, color='red', linestyle='--', linewidth=2, label='ä¸‹æ–¹ç®¡ç†é™ç•Œï¼ˆLCLï¼‰')
ax1.axhline(spec_upper, color='orange', linestyle=':', linewidth=2, label='è¦æ ¼ä¸Šé™ï¼ˆUSLï¼‰')
ax1.axhline(spec_lower, color='orange', linestyle=':', linewidth=2, label='è¦æ ¼ä¸‹é™ï¼ˆLSLï¼‰')

# ç•°å¸¸ç‚¹ã®æ¤œå‡ºã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ
out_of_control = (xbar > UCL_xbar) | (xbar < LCL_xbar)
if out_of_control.any():
    ax1.scatter(np.where(out_of_control)[0] + 1, xbar[out_of_control], 
                color='red', s=150, marker='x', linewidths=3, zorder=5, label='ç•°å¸¸ç‚¹')

ax1.set_xlabel('ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·', fontsize=12)
ax1.set_ylabel('ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—å¹³å‡å€¤ (XÌ„)', fontsize=12)
ax1.set_title('XÌ„ç®¡ç†å›³ï¼ˆå¹³å‡å€¤ç®¡ç†å›³ï¼‰', fontsize=14, fontweight='bold')
ax1.legend(fontsize=10, loc='upper left')
ax1.grid(True, alpha=0.3)

# 2. Rç®¡ç†å›³
ax2.plot(range(1, n_subgroups+1), R, marker='s', color='#38ef7d', linewidth=2, markersize=6)
ax2.axhline(R_bar, color='green', linestyle='-', linewidth=2, label='ä¸­å¿ƒç·šï¼ˆCLï¼‰')
ax2.axhline(UCL_R, color='red', linestyle='--', linewidth=2, label='ä¸Šæ–¹ç®¡ç†é™ç•Œï¼ˆUCLï¼‰')
if LCL_R > 0:
    ax2.axhline(LCL_R, color='red', linestyle='--', linewidth=2, label='ä¸‹æ–¹ç®¡ç†é™ç•Œï¼ˆLCLï¼‰')

# ç•°å¸¸ç‚¹ã®æ¤œå‡º
out_of_control_R = (R > UCL_R) | (R < LCL_R)
if out_of_control_R.any():
    ax2.scatter(np.where(out_of_control_R)[0] + 1, R[out_of_control_R], 
                color='red', s=150, marker='x', linewidths=3, zorder=5, label='ç•°å¸¸ç‚¹')

ax2.set_xlabel('ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·', fontsize=12)
ax2.set_ylabel('ç¯„å›² (R)', fontsize=12)
ax2.set_title('Rç®¡ç†å›³ï¼ˆç¯„å›²ç®¡ç†å›³ï¼‰', fontsize=14, fontweight='bold')
ax2.legend(fontsize=10, loc='upper left')
ax2.grid(True, alpha=0.3)

# 3. ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã¨ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›
all_data = data.flatten()
ax3.hist(all_data, bins=30, density=True, alpha=0.7, color='#11998e', edgecolor='white')
ax3.axvline(target, color='green', linestyle='-', linewidth=2, label='ç›®æ¨™å€¤')
ax3.axvline(spec_upper, color='red', linestyle='--', linewidth=2, label='è¦æ ¼ä¸Šé™ï¼ˆUSLï¼‰')
ax3.axvline(spec_lower, color='red', linestyle='--', linewidth=2, label='è¦æ ¼ä¸‹é™ï¼ˆLSLï¼‰')

# æ­£è¦åˆ†å¸ƒãƒ•ã‚£ãƒƒãƒˆ
from scipy.stats import norm
mu, sigma = all_data.mean(), all_data.std()
x = np.linspace(all_data.min(), all_data.max(), 100)
ax3.plot(x, norm.pdf(x, mu, sigma), 'r-', linewidth=2, label='æ­£è¦åˆ†å¸ƒãƒ•ã‚£ãƒƒãƒˆ')

ax3.set_xlabel('æ¸¬å®šå€¤', fontsize=12)
ax3.set_ylabel('å¯†åº¦', fontsize=12)
ax3.set_title(f'ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã¨ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›\nCp={Cp:.3f}, Cpk={Cpk:.3f}', 
              fontsize=14, fontweight='bold')
ax3.legend(fontsize=10)
ax3.grid(True, alpha=0.3, axis='y')

# 4. è¦æ ¼å¤–ç‡ã®æ¨å®š
ax4.axis('off')
report_text = f"""
=== çµ±è¨ˆçš„å“è³ªç®¡ç†ï¼ˆSQCï¼‰ãƒ¬ãƒãƒ¼ãƒˆ ===

ã€ç®¡ç†å›³åˆ†æçµæœã€‘
â€¢ ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—æ•°: {n_subgroups}
â€¢ ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã‚µã‚¤ã‚º: {subgroup_size}
â€¢ ç·ã‚µãƒ³ãƒ—ãƒ«æ•°: {n_subgroups * subgroup_size}

ã€XÌ„ç®¡ç†å›³ï¼ˆå¹³å‡å€¤ç®¡ç†å›³ï¼‰ã€‘
â€¢ ä¸­å¿ƒç·šï¼ˆCLï¼‰: {xbar_grand:.2f}
â€¢ ä¸Šæ–¹ç®¡ç†é™ç•Œï¼ˆUCLï¼‰: {UCL_xbar:.2f}
â€¢ ä¸‹æ–¹ç®¡ç†é™ç•Œï¼ˆLCLï¼‰: {LCL_xbar:.2f}
â€¢ ç®¡ç†å¤–ã‚Œç‚¹æ•°: {out_of_control.sum()} / {n_subgroups} ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—

ã€Rç®¡ç†å›³ï¼ˆç¯„å›²ç®¡ç†å›³ï¼‰ã€‘
â€¢ ä¸­å¿ƒç·šï¼ˆRÌ„ï¼‰: {R_bar:.2f}
â€¢ ä¸Šæ–¹ç®¡ç†é™ç•Œï¼ˆUCLï¼‰: {UCL_R:.2f}
â€¢ ç®¡ç†å¤–ã‚Œç‚¹æ•°: {out_of_control_R.sum()} / {n_subgroups} ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—

ã€ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›æŒ‡æ•°ã€‘
â€¢ Cpï¼ˆå·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ï¼‰: {Cp:.3f}
â€¢ Cpkï¼ˆåå¿ƒã‚’è€ƒæ…®ã—ãŸèƒ½åŠ›æŒ‡æ•°ï¼‰: {Cpk:.3f}
â€¢ æ¨å®šæ¨™æº–åå·®ï¼ˆÏƒÌ‚ï¼‰: {sigma_hat:.3f}

ã€åˆ¤å®šã€‘
â€¢ ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›: {"é©æ­£" if Cp >= 1.33 else "æ”¹å–„å¿…è¦" if Cp >= 1.0 else "ä¸é©æ­£"}
â€¢ åå¿ƒçŠ¶æ…‹: {"è‰¯å¥½" if Cpk >= 1.33 else "è¦æ³¨æ„" if Cpk >= 1.0 else "ä¸è‰¯"}

ã€è¦æ ¼å¤–ç‡æ¨å®šã€‘
â€¢ è¦æ ¼ä¸Šé™è¶…éç‡: {(all_data > spec_upper).sum() / len(all_data) * 100:.2f}%
â€¢ è¦æ ¼ä¸‹é™æœªæº€ç‡: {(all_data < spec_lower).sum() / len(all_data) * 100:.2f}%
â€¢ ç·è¦æ ¼å¤–ç‡: {((all_data > spec_upper) | (all_data < spec_lower)).sum() / len(all_data) * 100:.2f}%
"""

ax4.text(0.1, 0.9, report_text, fontsize=11, verticalalignment='top', 
         family='monospace', bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.3))

plt.tight_layout()
plt.savefig('sqc_control_charts.png', dpi=300, bbox_inches='tight')
plt.show()

print(report_text)</code></pre>
        </div>

        <div class="warning-box">
            <h3>âš ï¸ å“è³ªç®¡ç†å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹</h3>
            <ul>
                <li><strong>ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã®é¸å®š</strong>: çŸ­æ™‚é–“å†…ã®é€£ç¶šã‚µãƒ³ãƒ—ãƒ«ã‚’ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆåˆç†çš„ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰</li>
                <li><strong>ç®¡ç†é™ç•Œã®å†è¨ˆç®—</strong>: ãƒ—ãƒ­ã‚»ã‚¹æ”¹å–„å¾Œã¯ç®¡ç†é™ç•Œã‚’å†è¨­å®š</li>
                <li><strong>ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ¤å®š</strong>: ç‚¹ã®ç®¡ç†å¤–ã‚Œä»¥å¤–ã«ã€é€£ãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ»å‘¨æœŸæ€§ã‚‚æ¤œçŸ¥</li>
                <li><strong>Cp/Cpk ã®ç›®æ¨™å€¤</strong>: ä¸€èˆ¬ã« Cp â‰¥ 1.33, Cpk â‰¥ 1.33 ã‚’ç›®æ¨™</li>
                <li><strong>è¦æ ¼ã¨ç®¡ç†é™ç•Œã®é•ã„</strong>: è¦æ ¼ã¯é¡§å®¢è¦æ±‚ã€ç®¡ç†é™ç•Œã¯ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›ã«åŸºã¥ã</li>
            </ul>
        </div>

        <h2>ã¾ã¨ã‚</h2>
        <p>æœ¬ç« ã§ã¯ã€é£Ÿå“ãƒ—ãƒ­ã‚»ã‚¹ã®ç›£è¦–ã¨å“è³ªç®¡ç†ã®AIæŠ€è¡“ã‚’å­¦ã³ã¾ã—ãŸï¼š</p>
        <ul>
            <li>å¤šå¤‰é‡ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–ã¨PCAã«ã‚ˆã‚‹ç•°å¸¸æ¤œçŸ¥</li>
            <li>å®˜èƒ½è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã®å®šé‡åŒ–ã¨æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹å“è³ªäºˆæ¸¬</li>
            <li>ç”»åƒè§£æã«ã‚ˆã‚‹å¤–è¦³å“è³ªã®è‡ªå‹•åˆ†é¡</li>
            <li>çµ±è¨ˆçš„å“è³ªç®¡ç†ï¼ˆX-Rç®¡ç†å›³ã€ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›æŒ‡æ•°ï¼‰</li>
        </ul>
        <p>æ¬¡ç« ã§ã¯ã€ãƒ—ãƒ­ã‚»ã‚¹æœ€é©åŒ–ã¨ãƒ™ã‚¤ã‚ºæœ€é©åŒ–ã®å®Ÿè·µçš„æ‰‹æ³•ã‚’å­¦ã³ã¾ã™ã€‚</p>

        <div class="nav-buttons">
            <a href="chapter-1.html" class="nav-button">â† ç¬¬1ç« : é£Ÿå“ãƒ—ãƒ­ã‚»ã‚¹ã¨AIã®åŸºç¤</a>
            <a href="chapter-3.html" class="nav-button">ç¬¬3ç« : ãƒ—ãƒ­ã‚»ã‚¹æœ€é©åŒ– â†’</a>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹é“å ´ - é£Ÿå“ãƒ—ãƒ­ã‚»ã‚¹ã¸ã®AIå¿œç”¨</p>
        <p>Food Process AI Application Series | Chapter 2</p>
    </footer>
</body>
</html>
