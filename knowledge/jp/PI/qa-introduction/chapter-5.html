<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç¬¬5ç« ï¼šPythonã«ã‚ˆã‚‹å“è³ªç®¡ç†ã®è‡ªå‹•åŒ– - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹äºˆæ¸¬">
    <title>ç¬¬5ç« ï¼šPythonã«ã‚ˆã‚‹å“è³ªç®¡ç†ã®è‡ªå‹•åŒ– - PI Terakoya</title>

        <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.8; color: #333; background: #f5f5f5;
        }
        header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; padding: 2rem 1rem; text-align: center;
        }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .subtitle { opacity: 0.9; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .back-link {
            display: inline-block; margin-bottom: 2rem; padding: 0.5rem 1rem;
            background: white; color: #11998e; text-decoration: none;
            border-radius: 6px; font-weight: 600;
        }
        .content-box {
            background: white; padding: 2rem; border-radius: 12px;
            margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #11998e; margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem; border-bottom: 3px solid #11998e;
        }
        h3 { color: #2c3e50; margin: 1.5rem 0 1rem 0; }
        h4 { color: #2c3e50; margin: 1rem 0 0.5rem 0; }
        p { margin-bottom: 1rem; }
        ul, ol { margin-left: 2rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
        pre {
            background: #1e1e1e; color: #d4d4d4; padding: 1.5rem;
            border-radius: 8px; overflow-x: auto; margin: 1rem 0;
            border-left: 4px solid #11998e;
        }
        code {
            font-family: 'Courier New', monospace; font-size: 0.9rem;
        }
        .key-point {
            background: #e8f5e9; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #4caf50; margin: 1rem 0;
        }
        .tech-note {
            background: #e3f2fd; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #2196f3; margin: 1rem 0;
        }
        .formula {
            background: #f0f7ff; padding: 1rem; border-radius: 6px;
            margin: 1rem 0; overflow-x: auto;
        }
        table {
            width: 100%; border-collapse: collapse; margin: 1rem 0;
        }
        th, td {
            border: 1px solid #ddd; padding: 0.75rem; text-align: left;
        }
        th {
            background: #11998e; color: white; font-weight: 600;
        }
        tr:nth-child(even) { background: #f9f9f9; }
        .nav-buttons {
            display: flex; justify-content: space-between; margin-top: 3rem;
        }
        .nav-buttons a {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; text-decoration: none; border-radius: 6px;
            font-weight: 600;
        }
        footer {
            background: #2c3e50; color: white; text-align: center;
            padding: 2rem 1rem; margin-top: 4rem;
        }
        @media (max-width: 768px) {
            h1 { font-size: 1.6rem; }
            .container { padding: 0 0.5rem; }
            pre { padding: 1rem; }
        }
    
        
    
        /* Breadcrumb styles */
        .breadcrumb {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .breadcrumb-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a0aec0;
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: #4a5568;
            font-weight: 500;
        }
    </style>
</head>
<body>
            <nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="/AI-Knowledge-Notes/knowledge/jp/index.html">AIå¯ºå­å±‹ãƒˆãƒƒãƒ—</a><span class="breadcrumb-separator">â€º</span><a href="/AI-Knowledge-Notes/knowledge/jp/PI/index.html">ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹</a><span class="breadcrumb-separator">â€º</span><a href="/AI-Knowledge-Notes/knowledge/jp/PI/qa-introduction/index.html">Qa</a><span class="breadcrumb-separator">â€º</span><span class="breadcrumb-current">Chapter 5</span>
        </div>
    </nav>

        <header>
        <div class="container">
            <h1>ç¬¬5ç« ï¼šPythonã«ã‚ˆã‚‹å“è³ªç®¡ç†ã®è‡ªå‹•åŒ–</h1>
            <p class="subtitle">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹äºˆæ¸¬</p>
            <div class="meta">
                <span class="meta">ğŸ“š ã‚·ãƒªãƒ¼ã‚º: å“è³ªç®¡ç†ãƒ»QAå…¥é–€</span>
                <span class="meta">â±ï¸ èª­äº†æ™‚é–“: 40-45åˆ†</span>
                <span class="meta">ğŸ¯ é›£æ˜“åº¦: ä¸­ç´š-ä¸Šç´š</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="learning-objectives">
            <h3>ã“ã®ç« ã§å­¦ã¶ã“ã¨</h3>
            <ul>
                <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ SPCç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰</li>
                <li>Plotlyã‚’ä½¿ã£ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªå“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</li>
                <li>è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆPDF/Excelï¼‰ã¨ãƒ¡ãƒ¼ãƒ«é€ä¿¡</li>
                <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆã«ã‚ˆã‚‹å“è³ªãƒ‡ãƒ¼ã‚¿ç®¡ç†</li>
                <li>æ©Ÿæ¢°å­¦ç¿’ã‚’æ´»ç”¨ã—ãŸä¸è‰¯äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ </li>
                <li>å¤–éƒ¨APIã¨ã®çµ±åˆã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åé›†è‡ªå‹•åŒ–</li>
                <li>å®Œå…¨ãªå“è³ªãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</li>
            </ul>
        </div>

        <h2>5.1 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å“è³ªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </h2>

        <h3>5.1.1 è‡ªå‹•SPCç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ </h3>

        <p>è£½é€ ç¾å ´ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç›£è¦–ã—ã€ç®¡ç†é™ç•Œã‚’è¶…ãˆãŸéš›ã«è‡ªå‹•ã§ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚</p>

        <div class="example-box">
            <div class="example-title">ä¾‹1: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ SPCç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </div>
            <pre><code>import numpy as np
import pandas as pd
from datetime import datetime, timedelta
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from typing import List, Dict, Optional
import json

class RealTimeSPCMonitor:
    """ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ SPCç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 

    è£½é€ ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã—ã€ç®¡ç†é™ç•Œè¶…éæ™‚ã«
    è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹ã€‚ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºã‚‚å®Ÿæ–½ã€‚
    """

    def __init__(self, process_name: str, target: float,
                 ucl: float, lcl: float,
                 email_recipients: List[str] = None):
        """
        Args:
            process_name: ãƒ—ãƒ­ã‚»ã‚¹å
            target: ç›®æ¨™å€¤
            ucl: ä¸Šæ–¹ç®¡ç†é™ç•Œ
            lcl: ä¸‹æ–¹ç®¡ç†é™ç•Œ
            email_recipients: ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒªã‚¹ãƒˆ
        """
        self.process_name = process_name
        self.target = target
        self.ucl = ucl
        self.lcl = lcl
        self.email_recipients = email_recipients or []

        self.data_points = []
        self.alerts = []

        # ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºç”¨ã®ãƒ«ãƒ¼ãƒ«è¨­å®šï¼ˆWestern Electric Rulesï¼‰
        self.rules = {
            "rule1": "1ç‚¹ãŒç®¡ç†é™ç•Œå¤–",
            "rule2": "é€£ç¶š3ç‚¹ä¸­2ç‚¹ãŒ2Ïƒå¤–ï¼ˆç‰‡å´ï¼‰",
            "rule3": "é€£ç¶š5ç‚¹ä¸­4ç‚¹ãŒ1Ïƒå¤–ï¼ˆç‰‡å´ï¼‰",
            "rule4": "é€£ç¶š8ç‚¹ãŒç‰‡å´",
            "rule5": "é€£ç¶š6ç‚¹ãŒå˜èª¿å¢—åŠ ã¾ãŸã¯æ¸›å°‘",
            "rule6": "é€£ç¶š14ç‚¹ãŒäº¤äº’ã«ä¸Šä¸‹"
        }

        # Ïƒï¼ˆæ¨™æº–åå·®ï¼‰ã‚’è¨ˆç®—
        self.sigma = (ucl - target) / 3

    def add_measurement(self, value: float, timestamp: datetime = None) -> Dict:
        """æ¸¬å®šå€¤ã‚’è¿½åŠ ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è©•ä¾¡

        Args:
            value: æ¸¬å®šå€¤
            timestamp: æ¸¬å®šæ™‚åˆ»ï¼ˆçœç•¥æ™‚ã¯ç¾åœ¨æ™‚åˆ»ï¼‰

        Returns:
            è©•ä¾¡çµæœ
        """
        if timestamp is None:
            timestamp = datetime.now()

        data_point = {
            "timestamp": timestamp,
            "value": value,
            "in_control": self.lcl <= value <= self.ucl
        }

        self.data_points.append(data_point)

        # ç•°å¸¸æ¤œå‡º
        violations = self._check_violations()

        if violations:
            alert = self._generate_alert(data_point, violations)
            self.alerts.append(alert)

            # ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            if self.email_recipients:
                self._send_alert_email(alert)

            return {
                "status": "ALERT",
                "value": value,
                "violations": violations,
                "alert_id": alert["alert_id"]
            }
        else:
            return {
                "status": "OK",
                "value": value,
                "violations": []
            }

    def _check_violations(self) -> List[str]:
        """Western Electric Rulesã«åŸºã¥ãç•°å¸¸æ¤œå‡º

        Returns:
            é•åã—ãŸãƒ«ãƒ¼ãƒ«ã®ãƒªã‚¹ãƒˆ
        """
        violations = []

        if len(self.data_points) == 0:
            return violations

        recent_data = self.data_points[-14:]  # æœ€æ–°14ç‚¹ã‚’è©•ä¾¡

        # Rule 1: 1ç‚¹ãŒç®¡ç†é™ç•Œå¤–
        if not recent_data[-1]["in_control"]:
            violations.append(self.rules["rule1"])

        if len(recent_data) < 3:
            return violations

        # Rule 2: é€£ç¶š3ç‚¹ä¸­2ç‚¹ãŒ2Ïƒå¤–ï¼ˆç‰‡å´ï¼‰
        last_3 = recent_data[-3:]
        values_3 = [p["value"] for p in last_3]

        upper_2sigma = self.target + 2 * self.sigma
        lower_2sigma = self.target - 2 * self.sigma

        upper_violations = sum(1 for v in values_3 if v > upper_2sigma)
        lower_violations = sum(1 for v in values_3 if v < lower_2sigma)

        if upper_violations >= 2 or lower_violations >= 2:
            violations.append(self.rules["rule2"])

        if len(recent_data) < 5:
            return violations

        # Rule 3: é€£ç¶š5ç‚¹ä¸­4ç‚¹ãŒ1Ïƒå¤–ï¼ˆç‰‡å´ï¼‰
        last_5 = recent_data[-5:]
        values_5 = [p["value"] for p in last_5]

        upper_1sigma = self.target + self.sigma
        lower_1sigma = self.target - self.sigma

        upper_violations_5 = sum(1 for v in values_5 if v > upper_1sigma)
        lower_violations_5 = sum(1 for v in values_5 if v < lower_1sigma)

        if upper_violations_5 >= 4 or lower_violations_5 >= 4:
            violations.append(self.rules["rule3"])

        if len(recent_data) < 8:
            return violations

        # Rule 4: é€£ç¶š8ç‚¹ãŒç‰‡å´
        last_8 = recent_data[-8:]
        values_8 = [p["value"] for p in last_8]

        all_above = all(v > self.target for v in values_8)
        all_below = all(v < self.target for v in values_8)

        if all_above or all_below:
            violations.append(self.rules["rule4"])

        # Rule 5: é€£ç¶š6ç‚¹ãŒå˜èª¿å¢—åŠ ã¾ãŸã¯æ¸›å°‘
        if len(recent_data) >= 6:
            last_6 = recent_data[-6:]
            values_6 = [p["value"] for p in last_6]

            increasing = all(values_6[i] < values_6[i+1] for i in range(5))
            decreasing = all(values_6[i] > values_6[i+1] for i in range(5))

            if increasing or decreasing:
                violations.append(self.rules["rule5"])

        # Rule 6: é€£ç¶š14ç‚¹ãŒäº¤äº’ã«ä¸Šä¸‹
        if len(recent_data) >= 14:
            values_14 = [p["value"] for p in recent_data]

            alternating = all(
                (values_14[i] - values_14[i-1]) * (values_14[i+1] - values_14[i]) < 0
                for i in range(1, 13)
            )

            if alternating:
                violations.append(self.rules["rule6"])

        return violations

    def _generate_alert(self, data_point: Dict, violations: List[str]) -> Dict:
        """ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç”Ÿæˆ

        Args:
            data_point: ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ
            violations: é•åãƒ«ãƒ¼ãƒ«ã®ãƒªã‚¹ãƒˆ

        Returns:
            ã‚¢ãƒ©ãƒ¼ãƒˆæƒ…å ±
        """
        alert_id = f"ALERT-{datetime.now().strftime('%Y%m%d%H%M%S')}"

        alert = {
            "alert_id": alert_id,
            "timestamp": data_point["timestamp"],
            "process_name": self.process_name,
            "value": data_point["value"],
            "target": self.target,
            "ucl": self.ucl,
            "lcl": self.lcl,
            "violations": violations,
            "severity": "Critical" if self.rules["rule1"] in violations else "Warning",
            "acknowledged": False
        }

        return alert

    def _send_alert_email(self, alert: Dict):
        """ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡

        Args:
            alert: ã‚¢ãƒ©ãƒ¼ãƒˆæƒ…å ±
        """
        # å®Ÿéš›ã®å®Ÿè£…ã§ã¯SMTPã‚µãƒ¼ãƒãƒ¼è¨­å®šãŒå¿…è¦
        # ã“ã“ã§ã¯ãƒ­ã‚°å‡ºåŠ›ã®ã¿
        print(f"\n{'='*60}")
        print(f"ğŸ“§ ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡")
        print(f"{'='*60}")
        print(f"é€ä¿¡å…ˆ: {', '.join(self.email_recipients)}")
        print(f"ä»¶å: [{alert['severity']}] {self.process_name} ãƒ—ãƒ­ã‚»ã‚¹ç•°å¸¸æ¤œå‡º")
        print(f"\n--- ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ ---")
        print(f"ã‚¢ãƒ©ãƒ¼ãƒˆID: {alert['alert_id']}")
        print(f"ãƒ—ãƒ­ã‚»ã‚¹: {self.process_name}")
        print(f"ç™ºç”Ÿæ™‚åˆ»: {alert['timestamp'].strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"æ¸¬å®šå€¤: {alert['value']:.3f}")
        print(f"ç›®æ¨™å€¤: {self.target:.3f}")
        print(f"ç®¡ç†é™ç•Œ: {self.lcl:.3f} - {self.ucl:.3f}")
        print(f"\næ¤œå‡ºã•ã‚ŒãŸç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³:")
        for violation in alert['violations']:
            print(f"  â€¢ {violation}")
        print(f"\nå³åº§ã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦å‡¦ç½®ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚")
        print(f"{'='*60}\n")

    def get_control_chart_data(self) -> pd.DataFrame:
        """ç®¡ç†å›³ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

        Returns:
            ç®¡ç†å›³æç”»ç”¨ã®DataFrame
        """
        if not self.data_points:
            return pd.DataFrame()

        df = pd.DataFrame(self.data_points)

        # ç®¡ç†é™ç•Œç·šã‚’è¿½åŠ 
        df['target'] = self.target
        df['ucl'] = self.ucl
        df['lcl'] = self.lcl
        df['upper_2sigma'] = self.target + 2 * self.sigma
        df['lower_2sigma'] = self.target - 2 * self.sigma
        df['upper_1sigma'] = self.target + self.sigma
        df['lower_1sigma'] = self.target - self.sigma

        return df

    def get_alert_summary(self) -> Dict:
        """ã‚¢ãƒ©ãƒ¼ãƒˆã‚µãƒãƒªãƒ¼ã‚’å–å¾—

        Returns:
            ã‚¢ãƒ©ãƒ¼ãƒˆçµ±è¨ˆæƒ…å ±
        """
        if not self.alerts:
            return {"total_alerts": 0}

        df = pd.DataFrame(self.alerts)

        summary = {
            "total_alerts": len(self.alerts),
            "critical_alerts": (df['severity'] == 'Critical').sum(),
            "warning_alerts": (df['severity'] == 'Warning').sum(),
            "latest_alert": self.alerts[-1]['timestamp'].strftime('%Y-%m-%d %H:%M:%S'),
            "most_common_violation": df['violations'].explode().mode()[0]
                                     if len(df) > 0 else None
        }

        return summary


# ä½¿ç”¨ä¾‹
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ SPCç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•
monitor = RealTimeSPCMonitor(
    process_name="æˆå½¢æ¸©åº¦",
    target=200.0,
    ucl=210.0,
    lcl=190.0,
    email_recipients=["quality@example.com", "production@example.com"]
)

# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: æ¸¬å®šå€¤ã‚’é€£ç¶šè¿½åŠ 
np.random.seed(42)

print("=== ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ SPCç›£è¦–é–‹å§‹ ===\n")

# æ­£å¸¸ãªãƒ‡ãƒ¼ã‚¿
for i in range(10):
    value = np.random.normal(200.0, 2.5)
    result = monitor.add_measurement(value, datetime.now() + timedelta(minutes=i))
    print(f"[{i+1:2d}] æ¸¬å®šå€¤: {value:.2f} â†’ {result['status']}")

# ç•°å¸¸ç™ºç”Ÿ: ç®¡ç†é™ç•Œè¶…é
for i in range(10, 13):
    value = np.random.normal(212.0, 1.0)  # UCLè¶…é
    result = monitor.add_measurement(value, datetime.now() + timedelta(minutes=i))
    print(f"[{i+1:2d}] æ¸¬å®šå€¤: {value:.2f} â†’ {result['status']}")
    if result['status'] == 'ALERT':
        print(f"     âš ï¸  ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç”Ÿ: {result['alert_id']}")

# ã‚¢ãƒ©ãƒ¼ãƒˆã‚µãƒãƒªãƒ¼è¡¨ç¤º
print("\n=== ã‚¢ãƒ©ãƒ¼ãƒˆã‚µãƒãƒªãƒ¼ ===")
summary = monitor.get_alert_summary()
for key, value in summary.items():
    print(f"{key}: {value}")</code></pre>
        </div>

        <div class="tip-box">
            <h4>ğŸ’¡ å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ</h4>
            <ul>
                <li><strong>Western Electric Rules</strong>: 6ã¤ã®ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è‡ªå‹•æ¤œå‡º</li>
                <li><strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è©•ä¾¡</strong>: æ¸¬å®šå€¤è¿½åŠ æ™‚ã«å³åº§ã«åˆ¤å®š</li>
                <li><strong>ã‚¢ãƒ©ãƒ¼ãƒˆã®é‡è¦åº¦åˆ†é¡</strong>: Criticalï¼ˆç®¡ç†é™ç•Œå¤–ï¼‰ã¨Warningï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ç•°å¸¸ï¼‰</li>
                <li><strong>é€šçŸ¥æ©Ÿèƒ½</strong>: ãƒ¡ãƒ¼ãƒ«ã€Slackã€SMSç­‰ã¸ã®æ‹¡å¼µãŒå¯èƒ½</li>
            </ul>
        </div>

        <h3>5.1.2 ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–å“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆPlotlyï¼‰</h3>

        <p>Plotlyã‚’ä½¿ç”¨ã—ã¦ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªå“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚</p>

        <div class="example-box">
            <div class="example-title">ä¾‹2: Plotlyã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
            <pre><code>import plotly.graph_objects as go
from plotly.subplots import make_subplots
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

class QualityDashboard:
    """ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–å“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

    Plotlyã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã€‚
    ç®¡ç†å›³ã€ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã€ãƒ‘ãƒ¬ãƒ¼ãƒˆå›³ã€æ™‚ç³»åˆ—ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’çµ±åˆã€‚
    """

    def __init__(self):
        self.data = {
            "control_chart": [],
            "defect_data": [],
            "kpi_data": []
        }

    def add_control_chart_data(self, timestamp: datetime, value: float,
                              target: float, ucl: float, lcl: float):
        """ç®¡ç†å›³ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 

        Args:
            timestamp: æ™‚åˆ»
            value: æ¸¬å®šå€¤
            target: ç›®æ¨™å€¤
            ucl: ä¸Šæ–¹ç®¡ç†é™ç•Œ
            lcl: ä¸‹æ–¹ç®¡ç†é™ç•Œ
        """
        self.data["control_chart"].append({
            "timestamp": timestamp,
            "value": value,
            "target": target,
            "ucl": ucl,
            "lcl": lcl
        })

    def add_defect_data(self, defect_type: str, count: int):
        """ä¸è‰¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 

        Args:
            defect_type: ä¸è‰¯ã‚¿ã‚¤ãƒ—
            count: ä»¶æ•°
        """
        self.data["defect_data"].append({
            "type": defect_type,
            "count": count
        })

    def add_kpi_data(self, kpi_name: str, actual: float,
                    target: float, unit: str):
        """KPIãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 

        Args:
            kpi_name: KPIåç§°
            actual: å®Ÿç¸¾å€¤
            target: ç›®æ¨™å€¤
            unit: å˜ä½
        """
        self.data["kpi_data"].append({
            "kpi": kpi_name,
            "actual": actual,
            "target": target,
            "unit": unit,
            "achievement": (actual / target * 100) if target != 0 else 0
        })

    def create_dashboard(self, title: str = "å“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰") -> go.Figure:
        """ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç”Ÿæˆ

        Args:
            title: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«

        Returns:
            Plotly Figureã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        """
        # 2x2ã®ã‚µãƒ–ãƒ—ãƒ­ãƒƒãƒˆã‚’ä½œæˆ
        fig = make_subplots(
            rows=2, cols=2,
            subplot_titles=(
                "Xbarç®¡ç†å›³",
                "ä¸è‰¯ãƒ‘ãƒ¬ãƒ¼ãƒˆå›³",
                "KPIé”æˆçŠ¶æ³",
                "æ™‚ç³»åˆ—ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆ7æ—¥é–“ï¼‰"
            ),
            specs=[
                [{"type": "scatter"}, {"type": "bar"}],
                [{"type": "bar"}, {"type": "scatter"}]
            ],
            vertical_spacing=0.12,
            horizontal_spacing=0.1
        )

        # 1. ç®¡ç†å›³ï¼ˆå·¦ä¸Šï¼‰
        if self.data["control_chart"]:
            self._add_control_chart(fig, row=1, col=1)

        # 2. ãƒ‘ãƒ¬ãƒ¼ãƒˆå›³ï¼ˆå³ä¸Šï¼‰
        if self.data["defect_data"]:
            self._add_pareto_chart(fig, row=1, col=2)

        # 3. KPIé”æˆçŠ¶æ³ï¼ˆå·¦ä¸‹ï¼‰
        if self.data["kpi_data"]:
            self._add_kpi_chart(fig, row=2, col=1)

        # 4. æ™‚ç³»åˆ—ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆå³ä¸‹ï¼‰
        if self.data["control_chart"]:
            self._add_trend_chart(fig, row=2, col=2)

        # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š
        fig.update_layout(
            title_text=title,
            title_font_size=20,
            showlegend=True,
            height=800,
            template="plotly_white"
        )

        return fig

    def _add_control_chart(self, fig: go.Figure, row: int, col: int):
        """ç®¡ç†å›³ã‚’è¿½åŠ ï¼ˆå†…éƒ¨ç”¨ï¼‰"""
        df = pd.DataFrame(self.data["control_chart"])

        # æ¸¬å®šå€¤
        fig.add_trace(
            go.Scatter(
                x=df['timestamp'],
                y=df['value'],
                mode='lines+markers',
                name='æ¸¬å®šå€¤',
                line=dict(color='blue', width=2),
                marker=dict(size=6)
            ),
            row=row, col=col
        )

        # ç›®æ¨™å€¤
        fig.add_trace(
            go.Scatter(
                x=df['timestamp'],
                y=df['target'],
                mode='lines',
                name='ç›®æ¨™å€¤',
                line=dict(color='green', width=2, dash='dash')
            ),
            row=row, col=col
        )

        # UCL
        fig.add_trace(
            go.Scatter(
                x=df['timestamp'],
                y=df['ucl'],
                mode='lines',
                name='UCL',
                line=dict(color='red', width=1, dash='dot')
            ),
            row=row, col=col
        )

        # LCL
        fig.add_trace(
            go.Scatter(
                x=df['timestamp'],
                y=df['lcl'],
                mode='lines',
                name='LCL',
                line=dict(color='red', width=1, dash='dot')
            ),
            row=row, col=col
        )

        fig.update_xaxes(title_text="æ™‚åˆ»", row=row, col=col)
        fig.update_yaxes(title_text="æ¸¬å®šå€¤", row=row, col=col)

    def _add_pareto_chart(self, fig: go.Figure, row: int, col: int):
        """ãƒ‘ãƒ¬ãƒ¼ãƒˆå›³ã‚’è¿½åŠ ï¼ˆå†…éƒ¨ç”¨ï¼‰"""
        df = pd.DataFrame(self.data["defect_data"])
        df = df.sort_values('count', ascending=False)

        # ç´¯ç©æ¯”ç‡ã‚’è¨ˆç®—
        df['cumulative'] = df['count'].cumsum()
        df['cumulative_pct'] = df['cumulative'] / df['count'].sum() * 100

        # æ£’ã‚°ãƒ©ãƒ•
        fig.add_trace(
            go.Bar(
                x=df['type'],
                y=df['count'],
                name='ä¸è‰¯ä»¶æ•°',
                marker_color='lightblue',
                yaxis='y'
            ),
            row=row, col=col
        )

        # ç´¯ç©ç·šã‚°ãƒ©ãƒ•
        fig.add_trace(
            go.Scatter(
                x=df['type'],
                y=df['cumulative_pct'],
                name='ç´¯ç©æ¯”ç‡',
                mode='lines+markers',
                line=dict(color='red', width=2),
                marker=dict(size=8),
                yaxis='y2'
            ),
            row=row, col=col
        )

        fig.update_xaxes(title_text="ä¸è‰¯ã‚¿ã‚¤ãƒ—", row=row, col=col)
        fig.update_yaxes(title_text="ä»¶æ•°", row=row, col=col)

    def _add_kpi_chart(self, fig: go.Figure, row: int, col: int):
        """KPIé”æˆçŠ¶æ³ã‚’è¿½åŠ ï¼ˆå†…éƒ¨ç”¨ï¼‰"""
        df = pd.DataFrame(self.data["kpi_data"])

        # è‰²åˆ†ã‘ï¼ˆé”æˆç‡ã«å¿œã˜ã¦ï¼‰
        colors = ['green' if ach >= 100 else 'orange' if ach >= 80 else 'red'
                 for ach in df['achievement']]

        fig.add_trace(
            go.Bar(
                x=df['kpi'],
                y=df['achievement'],
                name='é”æˆç‡',
                marker_color=colors,
                text=df['achievement'].round(1).astype(str) + '%',
                textposition='outside'
            ),
            row=row, col=col
        )

        # 100%ãƒ©ã‚¤ãƒ³
        fig.add_hline(
            y=100,
            line_dash="dash",
            line_color="green",
            row=row, col=col
        )

        fig.update_xaxes(title_text="KPI", row=row, col=col)
        fig.update_yaxes(title_text="é”æˆç‡ (%)", row=row, col=col)

    def _add_trend_chart(self, fig: go.Figure, row: int, col: int):
        """æ™‚ç³»åˆ—ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¿½åŠ ï¼ˆå†…éƒ¨ç”¨ï¼‰"""
        df = pd.DataFrame(self.data["control_chart"])

        # ç›´è¿‘7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
        if len(df) > 0:
            cutoff = datetime.now() - timedelta(days=7)
            df = df[df['timestamp'] >= cutoff]

        if len(df) > 0:
            fig.add_trace(
                go.Scatter(
                    x=df['timestamp'],
                    y=df['value'],
                    mode='lines',
                    name='ãƒˆãƒ¬ãƒ³ãƒ‰',
                    line=dict(color='purple', width=2),
                    fill='tonexty'
                ),
                row=row, col=col
            )

            fig.update_xaxes(title_text="æ—¥æ™‚", row=row, col=col)
            fig.update_yaxes(title_text="æ¸¬å®šå€¤", row=row, col=col)

    def export_html(self, filename: str):
        """HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

        Args:
            filename: å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å
        """
        fig = self.create_dashboard()
        fig.write_html(filename)
        print(f"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ {filename} ã«å‡ºåŠ›ã—ã¾ã—ãŸ")


# ä½¿ç”¨ä¾‹
dashboard = QualityDashboard()

# ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
np.random.seed(42)

# ç®¡ç†å›³ãƒ‡ãƒ¼ã‚¿
for i in range(20):
    timestamp = datetime.now() - timedelta(hours=20-i)
    value = np.random.normal(100, 2)
    dashboard.add_control_chart_data(
        timestamp=timestamp,
        value=value,
        target=100.0,
        ucl=106.0,
        lcl=94.0
    )

# ä¸è‰¯ãƒ‡ãƒ¼ã‚¿
defect_types = ["å¯¸æ³•ä¸è‰¯", "å¤–è¦³ä¸è‰¯", "æ©Ÿèƒ½ä¸è‰¯", "æ¢±åŒ…ä¸è‰¯", "ãã®ä»–"]
defect_counts = [45, 28, 15, 8, 4]

for defect_type, count in zip(defect_types, defect_counts):
    dashboard.add_defect_data(defect_type, count)

# KPIãƒ‡ãƒ¼ã‚¿
kpis = [
    ("è‰¯å“ç‡", 98.5, 99.0, "%"),
    ("ç´æœŸéµå®ˆç‡", 96.0, 95.0, "%"),
    ("æ­©ç•™ã¾ã‚Š", 92.0, 90.0, "%"),
    ("ã‚¯ãƒ¬ãƒ¼ãƒ ä»¶æ•°", 8, 10, "ä»¶")
]

for kpi_name, actual, target, unit in kpis:
    dashboard.add_kpi_data(kpi_name, actual, target, unit)

# ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º
fig = dashboard.create_dashboard(title="è£½é€ å“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - 2025å¹´10æœˆ")
# fig.show()  # Jupyterç­‰ã§è¡¨ç¤º

# HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
dashboard.export_html("quality_dashboard.html")
print("ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸ")</code></pre>
        </div>

        <h2>5.2 è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã¨ãƒ‡ãƒ¼ã‚¿çµ±åˆ</h2>

        <h3>5.2.1 PDF/Excelè‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</h3>

        <p>å“è³ªãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•çš„ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã€PDFã¾ãŸã¯Excelå½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚</p>

        <div class="example-box">
            <div class="example-title">ä¾‹3: è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </div>
            <pre><code>from reportlab.lib.pagesizes import A4
from reportlab.lib import colors
from reportlab.lib.units import cm
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from datetime import datetime
import pandas as pd
import openpyxl
from openpyxl.styles import Font, PatternFill, Alignment
from openpyxl.chart import BarChart, Reference

class AutoReportGenerator:
    """è‡ªå‹•å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 

    å“è³ªãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«PDF/Excelå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã€‚
    ç®¡ç†å›³ã€çµ±è¨ˆã‚µãƒãƒªãƒ¼ã€æ˜¯æ­£å‡¦ç½®ãƒªã‚¹ãƒˆã‚’å«ã‚€ã€‚
    """

    def __init__(self, report_period: str):
        self.report_period = report_period
        self.data = {
            "summary": {},
            "spc_data": pd.DataFrame(),
            "capa_data": [],
            "kpi_data": []
        }

    def add_summary_data(self, total_production: int, defect_count: int,
                        yield_rate: float, customer_complaints: int):
        """ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 

        Args:
            total_production: ç·ç”Ÿç”£æ•°
            defect_count: ä¸è‰¯æ•°
            yield_rate: æ­©ç•™ã¾ã‚Šç‡
            customer_complaints: é¡§å®¢ã‚¯ãƒ¬ãƒ¼ãƒ ä»¶æ•°
        """
        self.data["summary"] = {
            "total_production": total_production,
            "defect_count": defect_count,
            "yield_rate": yield_rate,
            "customer_complaints": customer_complaints,
            "defect_rate": (defect_count / total_production * 100)
                          if total_production > 0 else 0
        }

    def add_spc_data(self, df: pd.DataFrame):
        """SPCãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 

        Args:
            df: SPCæ¸¬å®šãƒ‡ãƒ¼ã‚¿ã®DataFrame
        """
        self.data["spc_data"] = df

    def add_capa_data(self, capa_list: list):
        """CAPAãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 

        Args:
            capa_list: CAPAæƒ…å ±ã®ãƒªã‚¹ãƒˆ
        """
        self.data["capa_data"] = capa_list

    def add_kpi_data(self, kpi_list: list):
        """KPIãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 

        Args:
            kpi_list: KPIæƒ…å ±ã®ãƒªã‚¹ãƒˆ
        """
        self.data["kpi_data"] = kpi_list

    def generate_excel_report(self, filename: str):
        """Excelãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

        Args:
            filename: å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å
        """
        wb = openpyxl.Workbook()

        # ã‚·ãƒ¼ãƒˆ1: ã‚µãƒãƒªãƒ¼
        ws_summary = wb.active
        ws_summary.title = "ã‚µãƒãƒªãƒ¼"

        # ãƒ˜ãƒƒãƒ€ãƒ¼
        ws_summary['A1'] = f"å“è³ªãƒ¬ãƒãƒ¼ãƒˆ - {self.report_period}"
        ws_summary['A1'].font = Font(size=16, bold=True)
        ws_summary['A1'].fill = PatternFill(start_color="4472C4", fill_type="solid")
        ws_summary['A1'].font = Font(size=16, bold=True, color="FFFFFF")

        # ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿
        summary_data = [
            ["é …ç›®", "å€¤"],
            ["ç·ç”Ÿç”£æ•°", self.data["summary"]["total_production"]],
            ["ä¸è‰¯æ•°", self.data["summary"]["defect_count"]],
            ["ä¸è‰¯ç‡", f"{self.data['summary']['defect_rate']:.2f}%"],
            ["æ­©ç•™ã¾ã‚Šç‡", f"{self.data['summary']['yield_rate']:.2f}%"],
            ["é¡§å®¢ã‚¯ãƒ¬ãƒ¼ãƒ ", self.data["summary"]["customer_complaints"]]
        ]

        for row_idx, row_data in enumerate(summary_data, start=3):
            for col_idx, value in enumerate(row_data, start=1):
                cell = ws_summary.cell(row=row_idx, column=col_idx, value=value)
                if row_idx == 3:  # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                    cell.font = Font(bold=True)
                    cell.fill = PatternFill(start_color="D9E1F2", fill_type="solid")
                cell.alignment = Alignment(horizontal="left")

        # ã‚·ãƒ¼ãƒˆ2: SPC ãƒ‡ãƒ¼ã‚¿
        if not self.data["spc_data"].empty:
            ws_spc = wb.create_sheet(title="SPC ãƒ‡ãƒ¼ã‚¿")

            # DataFrameã‚’ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
            for r_idx, row in enumerate(
                dataframe_to_rows(self.data["spc_data"], index=False, header=True),
                start=1
            ):
                for c_idx, value in enumerate(row, start=1):
                    cell = ws_spc.cell(row=r_idx, column=c_idx, value=value)
                    if r_idx == 1:  # ãƒ˜ãƒƒãƒ€ãƒ¼
                        cell.font = Font(bold=True)
                        cell.fill = PatternFill(start_color="D9E1F2", fill_type="solid")

        # ã‚·ãƒ¼ãƒˆ3: CAPA
        if self.data["capa_data"]:
            ws_capa = wb.create_sheet(title="CAPA")

            capa_headers = ["CAPA ID", "èª¬æ˜", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "æœŸé™"]
            for col_idx, header in enumerate(capa_headers, start=1):
                cell = ws_capa.cell(row=1, column=col_idx, value=header)
                cell.font = Font(bold=True)
                cell.fill = PatternFill(start_color="D9E1F2", fill_type="solid")

            for row_idx, capa in enumerate(self.data["capa_data"], start=2):
                ws_capa.cell(row=row_idx, column=1, value=capa["capa_id"])
                ws_capa.cell(row=row_idx, column=2, value=capa["description"])
                ws_capa.cell(row=row_idx, column=3, value=capa["status"])
                ws_capa.cell(row=row_idx, column=4, value=capa["due_date"])

        # ã‚·ãƒ¼ãƒˆ4: KPI
        if self.data["kpi_data"]:
            ws_kpi = wb.create_sheet(title="KPI")

            kpi_headers = ["KPIå", "ç›®æ¨™å€¤", "å®Ÿç¸¾å€¤", "é”æˆç‡"]
            for col_idx, header in enumerate(kpi_headers, start=1):
                cell = ws_kpi.cell(row=1, column=col_idx, value=header)
                cell.font = Font(bold=True)
                cell.fill = PatternFill(start_color="D9E1F2", fill_type="solid")

            for row_idx, kpi in enumerate(self.data["kpi_data"], start=2):
                ws_kpi.cell(row=row_idx, column=1, value=kpi["name"])
                ws_kpi.cell(row=row_idx, column=2, value=kpi["target"])
                ws_kpi.cell(row=row_idx, column=3, value=kpi["actual"])
                ws_kpi.cell(row=row_idx, column=4,
                           value=f"{kpi['achievement']:.1f}%")

                # é”æˆç‡ã«å¿œã˜ã¦è‰²ä»˜ã‘
                achievement = kpi['achievement']
                cell = ws_kpi.cell(row=row_idx, column=4)
                if achievement >= 100:
                    cell.fill = PatternFill(start_color="C6EFCE", fill_type="solid")
                elif achievement >= 80:
                    cell.fill = PatternFill(start_color="FFEB9C", fill_type="solid")
                else:
                    cell.fill = PatternFill(start_color="FFC7CE", fill_type="solid")

        wb.save(filename)
        print(f"Excelãƒ¬ãƒãƒ¼ãƒˆã‚’ {filename} ã«å‡ºåŠ›ã—ã¾ã—ãŸ")

    def generate_pdf_report(self, filename: str):
        """PDFãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

        Args:
            filename: å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å
        """
        doc = SimpleDocTemplate(filename, pagesize=A4)
        story = []
        styles = getSampleStyleSheet()

        # ã‚¿ã‚¤ãƒˆãƒ«
        title_style = ParagraphStyle(
            'CustomTitle',
            parent=styles['Heading1'],
            fontSize=24,
            textColor=colors.HexColor("#2c3e50"),
            spaceAfter=30
        )

        title = Paragraph(f"å“è³ªãƒ¬ãƒãƒ¼ãƒˆ<br/>{self.report_period}", title_style)
        story.append(title)
        story.append(Spacer(1, 0.5*cm))

        # ã‚µãƒãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        heading_style = styles['Heading2']
        story.append(Paragraph("1. ã‚µãƒãƒªãƒ¼", heading_style))
        story.append(Spacer(1, 0.3*cm))

        summary_data = [
            ["é …ç›®", "å€¤"],
            ["ç·ç”Ÿç”£æ•°", f"{self.data['summary']['total_production']:,}"],
            ["ä¸è‰¯æ•°", f"{self.data['summary']['defect_count']:,}"],
            ["ä¸è‰¯ç‡", f"{self.data['summary']['defect_rate']:.2f}%"],
            ["æ­©ç•™ã¾ã‚Šç‡", f"{self.data['summary']['yield_rate']:.2f}%"],
            ["é¡§å®¢ã‚¯ãƒ¬ãƒ¼ãƒ ", f"{self.data['summary']['customer_complaints']}ä»¶"]
        ]

        summary_table = Table(summary_data, colWidths=[8*cm, 6*cm])
        summary_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black)
        ]))

        story.append(summary_table)
        story.append(Spacer(1, 1*cm))

        # CAPAã‚»ã‚¯ã‚·ãƒ§ãƒ³
        if self.data["capa_data"]:
            story.append(Paragraph("2. æ˜¯æ­£å‡¦ç½®ï¼ˆCAPAï¼‰", heading_style))
            story.append(Spacer(1, 0.3*cm))

            capa_data = [["CAPA ID", "èª¬æ˜", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "æœŸé™"]]
            for capa in self.data["capa_data"]:
                capa_data.append([
                    capa["capa_id"],
                    capa["description"][:40] + "..." if len(capa["description"]) > 40
                                                      else capa["description"],
                    capa["status"],
                    capa["due_date"]
                ])

            capa_table = Table(capa_data, colWidths=[3*cm, 7*cm, 2.5*cm, 2.5*cm])
            capa_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, -1), 8),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.lightgrey),
                ('GRID', (0, 0), (-1, -1), 1, colors.black)
            ]))

            story.append(capa_table)
            story.append(Spacer(1, 1*cm))

        # KPIã‚»ã‚¯ã‚·ãƒ§ãƒ³
        if self.data["kpi_data"]:
            story.append(Paragraph("3. KPIé”æˆçŠ¶æ³", heading_style))
            story.append(Spacer(1, 0.3*cm))

            kpi_data = [["KPIå", "ç›®æ¨™", "å®Ÿç¸¾", "é”æˆç‡"]]
            for kpi in self.data["kpi_data"]:
                kpi_data.append([
                    kpi["name"],
                    str(kpi["target"]),
                    str(kpi["actual"]),
                    f"{kpi['achievement']:.1f}%"
                ])

            kpi_table = Table(kpi_data, colWidths=[5*cm, 3*cm, 3*cm, 3*cm])
            kpi_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 10),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.lightblue),
                ('GRID', (0, 0), (-1, -1), 1, colors.black)
            ]))

            story.append(kpi_table)

        # PDFãƒ“ãƒ«ãƒ‰
        doc.build(story)
        print(f"PDFãƒ¬ãƒãƒ¼ãƒˆã‚’ {filename} ã«å‡ºåŠ›ã—ã¾ã—ãŸ")


# openpyxlç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
from openpyxl.utils.dataframe import dataframe_to_rows

# ä½¿ç”¨ä¾‹
report_gen = AutoReportGenerator(report_period="2025å¹´10æœˆ")

# ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
report_gen.add_summary_data(
    total_production=50000,
    defect_count=750,
    yield_rate=98.5,
    customer_complaints=8
)

# CAPAãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
capa_list = [
    {
        "capa_id": "CAPA-20251001-001",
        "description": "æˆå½¢æ¸©åº¦ã®ç®¡ç†é™ç•Œè¶…é",
        "status": "é€²è¡Œä¸­",
        "due_date": "2025-10-31"
    },
    {
        "capa_id": "CAPA-20251005-002",
        "description": "æ¤œæŸ»æ¼ã‚Œã«ã‚ˆã‚‹ä¸è‰¯æµå‡º",
        "status": "å®Œäº†",
        "due_date": "2025-10-25"
    }
]
report_gen.add_capa_data(capa_list)

# KPIãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
kpi_list = [
    {"name": "è‰¯å“ç‡", "target": 99.0, "actual": 98.5, "achievement": 99.5},
    {"name": "ç´æœŸéµå®ˆç‡", "target": 95.0, "actual": 96.5, "achievement": 101.6},
    {"name": "ã‚¯ãƒ¬ãƒ¼ãƒ å‰Šæ¸›", "target": 10, "actual": 8, "achievement": 125.0}
]
report_gen.add_kpi_data(kpi_list)

# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
report_gen.generate_excel_report("quality_report_202510.xlsx")
# report_gen.generate_pdf_report("quality_report_202510.pdf")  # æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®šãŒå¿…è¦

print("\nè‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†")</code></pre>
        </div>

        <h3>5.2.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆã«ã‚ˆã‚‹å“è³ªãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>

        <p>SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦å“è³ªãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã—ã€å±¥æ­´ç®¡ç†ã¨ã‚¯ã‚¨ãƒªæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

        <div class="example-box">
            <div class="example-title">ä¾‹4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆå“è³ªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
            <pre><code>import sqlite3
import pandas as pd
from datetime import datetime
from typing import List, Dict, Optional

class QualityDatabase:
    """å“è³ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

    SQLiteã‚’ä½¿ç”¨ã—ã¦å“è³ªãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã€‚
    æ¸¬å®šãƒ‡ãƒ¼ã‚¿ã€ä¸é©åˆã€CAPAã€ç›£æŸ»çµæœã‚’ä¸€å…ƒç®¡ç†ã€‚
    """

    def __init__(self, db_file: str = "quality_data.db"):
        self.db_file = db_file
        self.conn = None
        self._initialize_database()

    def _initialize_database(self):
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åˆæœŸåŒ–"""
        self.conn = sqlite3.connect(self.db_file)
        cursor = self.conn.cursor()

        # æ¸¬å®šãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS measurements (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            timestamp DATETIME NOT NULL,
            process_name TEXT NOT NULL,
            parameter_name TEXT NOT NULL,
            value REAL NOT NULL,
            target REAL,
            ucl REAL,
            lcl REAL,
            in_control BOOLEAN,
            operator TEXT,
            lot_number TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
        """)

        # ä¸é©åˆãƒ†ãƒ¼ãƒ–ãƒ«
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS nonconformances (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            nc_id TEXT UNIQUE NOT NULL,
            date_detected DATE NOT NULL,
            product TEXT,
            defect_type TEXT NOT NULL,
            quantity INTEGER,
            severity TEXT,
            detected_by TEXT,
            status TEXT DEFAULT 'Open',
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
        """)

        # CAPAãƒ†ãƒ¼ãƒ–ãƒ«
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS capas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            capa_id TEXT UNIQUE NOT NULL,
            nc_id TEXT,
            description TEXT NOT NULL,
            root_cause TEXT,
            corrective_action TEXT,
            preventive_action TEXT,
            assigned_to TEXT,
            due_date DATE,
            status TEXT DEFAULT 'Open',
            effectiveness_verified BOOLEAN DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (nc_id) REFERENCES nonconformances(nc_id)
        )
        """)

        # ç›£æŸ»ãƒ†ãƒ¼ãƒ–ãƒ«
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS audits (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            audit_id TEXT UNIQUE NOT NULL,
            audit_date DATE NOT NULL,
            department TEXT NOT NULL,
            auditor TEXT NOT NULL,
            findings_count INTEGER DEFAULT 0,
            nc_count INTEGER DEFAULT 0,
            status TEXT DEFAULT 'Planned',
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
        """)

        self.conn.commit()
        print(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å®Œäº†: {self.db_file}")

    def add_measurement(self, timestamp: datetime, process_name: str,
                       parameter_name: str, value: float,
                       target: float = None, ucl: float = None,
                       lcl: float = None, operator: str = None,
                       lot_number: str = None):
        """æ¸¬å®šãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²

        Args:
            timestamp: æ¸¬å®šæ™‚åˆ»
            process_name: ãƒ—ãƒ­ã‚»ã‚¹å
            parameter_name: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å
            value: æ¸¬å®šå€¤
            target: ç›®æ¨™å€¤
            ucl: ä¸Šæ–¹ç®¡ç†é™ç•Œ
            lcl: ä¸‹æ–¹ç®¡ç†é™ç•Œ
            operator: ä½œæ¥­è€…
            lot_number: ãƒ­ãƒƒãƒˆç•ªå·
        """
        cursor = self.conn.cursor()

        in_control = True
        if ucl is not None and lcl is not None:
            in_control = lcl <= value <= ucl

        cursor.execute("""
        INSERT INTO measurements
        (timestamp, process_name, parameter_name, value, target, ucl, lcl,
         in_control, operator, lot_number)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (timestamp, process_name, parameter_name, value, target, ucl, lcl,
              in_control, operator, lot_number))

        self.conn.commit()

    def add_nonconformance(self, nc_id: str, date_detected: datetime,
                          product: str, defect_type: str,
                          quantity: int, severity: str,
                          detected_by: str) -> int:
        """ä¸é©åˆã‚’è¨˜éŒ²

        Args:
            nc_id: ä¸é©åˆID
            date_detected: æ¤œå‡ºæ—¥
            product: è£½å“å
            defect_type: ä¸è‰¯ã‚¿ã‚¤ãƒ—
            quantity: æ•°é‡
            severity: é‡å¤§åº¦
            detected_by: æ¤œå‡ºè€…

        Returns:
            æŒ¿å…¥ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã®ID
        """
        cursor = self.conn.cursor()

        cursor.execute("""
        INSERT INTO nonconformances
        (nc_id, date_detected, product, defect_type, quantity, severity, detected_by)
        VALUES (?, ?, ?, ?, ?, ?, ?)
        """, (nc_id, date_detected, product, defect_type, quantity, severity, detected_by))

        self.conn.commit()
        return cursor.lastrowid

    def add_capa(self, capa_id: str, nc_id: str, description: str,
                assigned_to: str, due_date: datetime) -> int:
        """CAPAã‚’è¨˜éŒ²

        Args:
            capa_id: CAPA ID
            nc_id: é–¢é€£ã™ã‚‹ä¸é©åˆID
            description: èª¬æ˜
            assigned_to: æ‹…å½“è€…
            due_date: æœŸé™

        Returns:
            æŒ¿å…¥ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã®ID
        """
        cursor = self.conn.cursor()

        cursor.execute("""
        INSERT INTO capas
        (capa_id, nc_id, description, assigned_to, due_date)
        VALUES (?, ?, ?, ?, ?)
        """, (capa_id, nc_id, description, assigned_to, due_date))

        self.conn.commit()
        return cursor.lastrowid

    def update_capa(self, capa_id: str, root_cause: str = None,
                   corrective_action: str = None,
                   preventive_action: str = None,
                   status: str = None,
                   effectiveness_verified: bool = None):
        """CAPAã‚’æ›´æ–°

        Args:
            capa_id: CAPA ID
            root_cause: æ ¹æœ¬åŸå› 
            corrective_action: æ˜¯æ­£å‡¦ç½®
            preventive_action: äºˆé˜²å‡¦ç½®
            status: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            effectiveness_verified: æœ‰åŠ¹æ€§ç¢ºèªæ¸ˆã¿
        """
        cursor = self.conn.cursor()

        updates = []
        params = []

        if root_cause is not None:
            updates.append("root_cause = ?")
            params.append(root_cause)

        if corrective_action is not None:
            updates.append("corrective_action = ?")
            params.append(corrective_action)

        if preventive_action is not None:
            updates.append("preventive_action = ?")
            params.append(preventive_action)

        if status is not None:
            updates.append("status = ?")
            params.append(status)

        if effectiveness_verified is not None:
            updates.append("effectiveness_verified = ?")
            params.append(effectiveness_verified)

        if updates:
            params.append(capa_id)
            sql = f"UPDATE capas SET {', '.join(updates)} WHERE capa_id = ?"
            cursor.execute(sql, params)
            self.conn.commit()

    def get_measurements(self, process_name: str = None,
                        start_date: datetime = None,
                        end_date: datetime = None) -> pd.DataFrame:
        """æ¸¬å®šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

        Args:
            process_name: ãƒ—ãƒ­ã‚»ã‚¹åï¼ˆãƒ•ã‚£ãƒ«ã‚¿ç”¨ï¼‰
            start_date: é–‹å§‹æ—¥
            end_date: çµ‚äº†æ—¥

        Returns:
            æ¸¬å®šãƒ‡ãƒ¼ã‚¿ã®DataFrame
        """
        query = "SELECT * FROM measurements WHERE 1=1"
        params = []

        if process_name:
            query += " AND process_name = ?"
            params.append(process_name)

        if start_date:
            query += " AND timestamp >= ?"
            params.append(start_date)

        if end_date:
            query += " AND timestamp <= ?"
            params.append(end_date)

        query += " ORDER BY timestamp"

        df = pd.read_sql_query(query, self.conn, params=params)
        return df

    def get_open_capas(self) -> pd.DataFrame:
        """æœªå®Œäº†CAPAã‚’å–å¾—

        Returns:
            æœªå®Œäº†CAPAã®DataFrame
        """
        query = """
        SELECT c.capa_id, c.description, c.assigned_to, c.due_date,
               c.status, n.defect_type, n.severity
        FROM capas c
        LEFT JOIN nonconformances n ON c.nc_id = n.nc_id
        WHERE c.status != 'Closed'
        ORDER BY c.due_date
        """

        df = pd.read_sql_query(query, self.conn)
        return df

    def get_defect_analysis(self, start_date: datetime = None,
                           end_date: datetime = None) -> pd.DataFrame:
        """ä¸è‰¯åˆ†æï¼ˆãƒ‘ãƒ¬ãƒ¼ãƒˆå›³ç”¨ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’å–å¾—

        Args:
            start_date: é–‹å§‹æ—¥
            end_date: çµ‚äº†æ—¥

        Returns:
            ä¸è‰¯ã‚¿ã‚¤ãƒ—åˆ¥é›†è¨ˆã®DataFrame
        """
        query = """
        SELECT defect_type, SUM(quantity) as total_quantity, COUNT(*) as occurrence
        FROM nonconformances
        WHERE 1=1
        """
        params = []

        if start_date:
            query += " AND date_detected >= ?"
            params.append(start_date)

        if end_date:
            query += " AND date_detected <= ?"
            params.append(end_date)

        query += " GROUP BY defect_type ORDER BY total_quantity DESC"

        df = pd.read_sql_query(query, self.conn, params=params)
        return df

    def get_dashboard_metrics(self) -> Dict:
        """ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—

        Returns:
            ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¾æ›¸
        """
        cursor = self.conn.cursor()

        # ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
        start_of_month = datetime.now().replace(day=1, hour=0, minute=0, second=0)

        # ç·æ¸¬å®šæ•°
        cursor.execute("""
        SELECT COUNT(*) FROM measurements WHERE timestamp >= ?
        """, (start_of_month,))
        total_measurements = cursor.fetchone()[0]

        # ç®¡ç†å¤–ã®æ¸¬å®šæ•°
        cursor.execute("""
        SELECT COUNT(*) FROM measurements
        WHERE timestamp >= ? AND in_control = 0
        """, (start_of_month,))
        out_of_control = cursor.fetchone()[0]

        # ä¸é©åˆä»¶æ•°
        cursor.execute("""
        SELECT COUNT(*), COALESCE(SUM(quantity), 0)
        FROM nonconformances WHERE date_detected >= ?
        """, (start_of_month,))
        nc_count, nc_quantity = cursor.fetchone()

        # æœªå®Œäº†CAPA
        cursor.execute("""
        SELECT COUNT(*) FROM capas WHERE status != 'Closed'
        """)
        open_capas = cursor.fetchone()[0]

        metrics = {
            "total_measurements": total_measurements,
            "out_of_control_rate": (out_of_control / total_measurements * 100)
                                   if total_measurements > 0 else 0,
            "nc_count": nc_count,
            "nc_quantity": nc_quantity,
            "open_capas": open_capas
        }

        return metrics

    def close(self):
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’é–‰ã˜ã‚‹"""
        if self.conn:
            self.conn.close()
            print("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’é–‰ã˜ã¾ã—ãŸ")


# ä½¿ç”¨ä¾‹
db = QualityDatabase("quality_management.db")

# æ¸¬å®šãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
for i in range(10):
    timestamp = datetime.now() - timedelta(hours=10-i)
    value = np.random.normal(100, 2)

    db.add_measurement(
        timestamp=timestamp,
        process_name="æˆå½¢æ¸©åº¦",
        parameter_name="æ¸©åº¦",
        value=value,
        target=100.0,
        ucl=106.0,
        lcl=94.0,
        operator="ä½œæ¥­è€…A",
        lot_number=f"LOT-2025{i:03d}"
    )

# ä¸é©åˆã‚’è¨˜éŒ²
nc_id = "NC-20251026-001"
db.add_nonconformance(
    nc_id=nc_id,
    date_detected=datetime.now(),
    product="è£½å“X",
    defect_type="å¯¸æ³•ä¸è‰¯",
    quantity=50,
    severity="Major",
    detected_by="æ¤œæŸ»å“¡B"
)

# CAPAã‚’è¨˜éŒ²
capa_id = "CAPA-20251026-001"
db.add_capa(
    capa_id=capa_id,
    nc_id=nc_id,
    description="æˆå½¢é‡‘å‹ã®æ‘©è€—ã«ã‚ˆã‚‹å¯¸æ³•ä¸è‰¯",
    assigned_to="è£½é€ éƒ¨é•·",
    due_date=datetime.now() + timedelta(days=30)
)

# CAPAã‚’æ›´æ–°
db.update_capa(
    capa_id=capa_id,
    root_cause="é‡‘å‹ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸è¶³",
    corrective_action="é‡‘å‹ã‚’äº¤æ›ã—ã€æ¸¬å®šã‚’å®Ÿæ–½",
    preventive_action="å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç¢ºç«‹",
    status="é€²è¡Œä¸­"
)

# ãƒ‡ãƒ¼ã‚¿å–å¾—
print("\n=== æ¸¬å®šãƒ‡ãƒ¼ã‚¿ ===")
measurements_df = db.get_measurements(process_name="æˆå½¢æ¸©åº¦")
print(measurements_df.head())

print("\n=== æœªå®Œäº†CAPA ===")
open_capas_df = db.get_open_capas()
print(open_capas_df)

print("\n=== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===")
metrics = db.get_dashboard_metrics()
for key, value in metrics.items():
    print(f"{key}: {value}")

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’é–‰ã˜ã‚‹
db.close()</code></pre>
        </div>

        <h2>5.3 æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹å“è³ªäºˆæ¸¬</h2>

        <h3>5.3.1 ä¸è‰¯äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ï¼‰</h3>

        <p>è£½é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ä¸è‰¯ã‚’äºˆæ¸¬ã™ã‚‹æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚</p>

        <div class="example-box">
            <div class="example-title">ä¾‹5: æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹ä¸è‰¯äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ </div>
            <pre><code>import numpy as np
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report, confusion_matrix, roc_auc_score
from sklearn.preprocessing import StandardScaler
import joblib
from typing import Dict, Tuple

class DefectPredictionSystem:
    """æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹ä¸è‰¯äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ 

    è£½é€ ãƒ—ãƒ­ã‚»ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ä¸è‰¯ç™ºç”Ÿã‚’äºˆæ¸¬ã€‚
    Random Forestãƒ¢ãƒ‡ãƒ«ã§é«˜ç²¾åº¦ãªäºˆæ¸¬ã‚’å®Ÿç¾ã€‚
    """

    def __init__(self):
        self.model = None
        self.scaler = None
        self.feature_names = None
        self.is_trained = False

    def prepare_training_data(self, df: pd.DataFrame,
                             target_column: str = 'is_defect',
                             feature_columns: List[str] = None) -> Tuple:
        """è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™

        Args:
            df: è£½é€ ãƒ‡ãƒ¼ã‚¿ã®DataFrame
            target_column: ç›®çš„å¤‰æ•°ã‚«ãƒ©ãƒ å
            feature_columns: ç‰¹å¾´é‡ã‚«ãƒ©ãƒ åã®ãƒªã‚¹ãƒˆ

        Returns:
            (X_train, X_test, y_train, y_test)ã®ã‚¿ãƒ—ãƒ«
        """
        if feature_columns is None:
            # target_columnã‚’é™¤ãå…¨æ•°å€¤ã‚«ãƒ©ãƒ ã‚’ä½¿ç”¨
            feature_columns = df.select_dtypes(include=[np.number]).columns.tolist()
            feature_columns.remove(target_column)

        self.feature_names = feature_columns

        X = df[feature_columns]
        y = df[target_column]

        # ãƒ‡ãƒ¼ã‚¿åˆ†å‰²
        X_train, X_test, y_train, y_test = train_test_split(
            X, y, test_size=0.2, random_state=42, stratify=y
        )

        # æ¨™æº–åŒ–
        self.scaler = StandardScaler()
        X_train_scaled = self.scaler.fit_transform(X_train)
        X_test_scaled = self.scaler.transform(X_test)

        return X_train_scaled, X_test_scaled, y_train, y_test

    def train(self, X_train, y_train, n_estimators: int = 100,
             max_depth: int = 10):
        """ãƒ¢ãƒ‡ãƒ«ã‚’è¨“ç·´

        Args:
            X_train: è¨“ç·´ãƒ‡ãƒ¼ã‚¿ï¼ˆç‰¹å¾´é‡ï¼‰
            y_train: è¨“ç·´ãƒ‡ãƒ¼ã‚¿ï¼ˆç›®çš„å¤‰æ•°ï¼‰
            n_estimators: æ±ºå®šæœ¨ã®æ•°
            max_depth: æœ¨ã®æœ€å¤§æ·±ã•
        """
        self.model = RandomForestClassifier(
            n_estimators=n_estimators,
            max_depth=max_depth,
            random_state=42,
            class_weight='balanced'  # ä¸å‡è¡¡ãƒ‡ãƒ¼ã‚¿å¯¾ç­–
        )

        self.model.fit(X_train, y_train)
        self.is_trained = True

        print(f"ãƒ¢ãƒ‡ãƒ«è¨“ç·´å®Œäº†")
        print(f"  æ±ºå®šæœ¨æ•°: {n_estimators}")
        print(f"  æœ€å¤§æ·±ã•: {max_depth}")

    def evaluate(self, X_test, y_test) -> Dict:
        """ãƒ¢ãƒ‡ãƒ«ã‚’è©•ä¾¡

        Args:
            X_test: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆç‰¹å¾´é‡ï¼‰
            y_test: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆç›®çš„å¤‰æ•°ï¼‰

        Returns:
            è©•ä¾¡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¾æ›¸
        """
        if not self.is_trained:
            raise ValueError("ãƒ¢ãƒ‡ãƒ«ãŒè¨“ç·´ã•ã‚Œã¦ã„ã¾ã›ã‚“")

        y_pred = self.model.predict(X_test)
        y_pred_proba = self.model.predict_proba(X_test)[:, 1]

        # æ··åŒè¡Œåˆ—
        cm = confusion_matrix(y_test, y_pred)
        tn, fp, fn, tp = cm.ravel()

        # ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆç®—
        accuracy = (tp + tn) / (tp + tn + fp + fn)
        precision = tp / (tp + fp) if (tp + fp) > 0 else 0
        recall = tp / (tp + fn) if (tp + fn) > 0 else 0
        f1_score = (2 * precision * recall / (precision + recall)
                   if (precision + recall) > 0 else 0)
        roc_auc = roc_auc_score(y_test, y_pred_proba)

        metrics = {
            "accuracy": accuracy,
            "precision": precision,
            "recall": recall,
            "f1_score": f1_score,
            "roc_auc": roc_auc,
            "confusion_matrix": cm
        }

        # çµæœã‚’è¡¨ç¤º
        print("\n=== ãƒ¢ãƒ‡ãƒ«è©•ä¾¡çµæœ ===")
        print(f"æ­£è§£ç‡: {accuracy:.3f}")
        print(f"é©åˆç‡: {precision:.3f}")
        print(f"å†ç¾ç‡: {recall:.3f}")
        print(f"F1ã‚¹ã‚³ã‚¢: {f1_score:.3f}")
        print(f"ROC-AUC: {roc_auc:.3f}")
        print("\næ··åŒè¡Œåˆ—:")
        print(f"  çœŸé™°æ€§: {tn}, å½é™½æ€§: {fp}")
        print(f"  å½é™°æ€§: {fn}, çœŸé™½æ€§: {tp}")

        return metrics

    def predict(self, X: pd.DataFrame) -> Dict:
        """ä¸è‰¯ã‚’äºˆæ¸¬

        Args:
            X: è£½é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®DataFrame

        Returns:
            äºˆæ¸¬çµæœï¼ˆäºˆæ¸¬ã‚¯ãƒ©ã‚¹ã€ç¢ºç‡ã€ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ï¼‰
        """
        if not self.is_trained:
            raise ValueError("ãƒ¢ãƒ‡ãƒ«ãŒè¨“ç·´ã•ã‚Œã¦ã„ã¾ã›ã‚“")

        # ç‰¹å¾´é‡ã®é †åºã‚’ç¢ºèª
        X_ordered = X[self.feature_names]

        # æ¨™æº–åŒ–
        X_scaled = self.scaler.transform(X_ordered)

        # äºˆæ¸¬
        prediction = self.model.predict(X_scaled)[0]
        probability = self.model.predict_proba(X_scaled)[0, 1]

        # ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã‚’åˆ¤å®š
        if probability >= 0.7:
            risk_level = "High"
        elif probability >= 0.4:
            risk_level = "Medium"
        else:
            risk_level = "Low"

        result = {
            "prediction": "ä¸è‰¯" if prediction == 1 else "è‰¯å“",
            "defect_probability": probability,
            "risk_level": risk_level
        }

        return result

    def get_feature_importance(self) -> pd.DataFrame:
        """ç‰¹å¾´é‡ã®é‡è¦åº¦ã‚’å–å¾—

        Returns:
            ç‰¹å¾´é‡é‡è¦åº¦ã®DataFrame
        """
        if not self.is_trained:
            raise ValueError("ãƒ¢ãƒ‡ãƒ«ãŒè¨“ç·´ã•ã‚Œã¦ã„ã¾ã›ã‚“")

        importance_df = pd.DataFrame({
            'feature': self.feature_names,
            'importance': self.model.feature_importances_
        })

        importance_df = importance_df.sort_values('importance', ascending=False)

        return importance_df

    def save_model(self, filename: str):
        """ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜

        Args:
            filename: ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å
        """
        if not self.is_trained:
            raise ValueError("ãƒ¢ãƒ‡ãƒ«ãŒè¨“ç·´ã•ã‚Œã¦ã„ã¾ã›ã‚“")

        model_data = {
            'model': self.model,
            'scaler': self.scaler,
            'feature_names': self.feature_names
        }

        joblib.dump(model_data, filename)
        print(f"ãƒ¢ãƒ‡ãƒ«ã‚’ {filename} ã«ä¿å­˜ã—ã¾ã—ãŸ")

    def load_model(self, filename: str):
        """ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿

        Args:
            filename: ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å
        """
        model_data = joblib.load(filename)

        self.model = model_data['model']
        self.scaler = model_data['scaler']
        self.feature_names = model_data['feature_names']
        self.is_trained = True

        print(f"ãƒ¢ãƒ‡ãƒ«ã‚’ {filename} ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ")


# ä½¿ç”¨ä¾‹
# ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
np.random.seed(42)

n_samples = 1000

# è£½é€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆç‰¹å¾´é‡ï¼‰
temperature = np.random.normal(200, 5, n_samples)
pressure = np.random.normal(50, 3, n_samples)
speed = np.random.normal(100, 10, n_samples)
humidity = np.random.normal(60, 10, n_samples)

# ä¸è‰¯ç™ºç”Ÿãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ¸©åº¦ãŒé«˜ãã€åœ§åŠ›ãŒä½ã„å ´åˆã«ä¸è‰¯ãŒç™ºç”Ÿã—ã‚„ã™ã„ï¼‰
defect_score = (
    (temperature - 200) * 0.3 +
    (50 - pressure) * 0.4 +
    (speed - 100) * 0.1 +
    np.random.normal(0, 2, n_samples)
)

is_defect = (defect_score > 2).astype(int)

# DataFrameã‚’ä½œæˆ
df = pd.DataFrame({
    'temperature': temperature,
    'pressure': pressure,
    'speed': speed,
    'humidity': humidity,
    'is_defect': is_defect
})

print(f"ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†: {len(df)}ã‚µãƒ³ãƒ—ãƒ«")
print(f"ä¸è‰¯ç‡: {is_defect.mean() * 100:.2f}%")

# ä¸è‰¯äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
defect_predictor = DefectPredictionSystem()

# è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
X_train, X_test, y_train, y_test = defect_predictor.prepare_training_data(df)

# ãƒ¢ãƒ‡ãƒ«ã‚’è¨“ç·´
defect_predictor.train(X_train, y_train, n_estimators=100, max_depth=10)

# ãƒ¢ãƒ‡ãƒ«ã‚’è©•ä¾¡
metrics = defect_predictor.evaluate(X_test, y_test)

# ç‰¹å¾´é‡ã®é‡è¦åº¦ã‚’è¡¨ç¤º
print("\n=== ç‰¹å¾´é‡ã®é‡è¦åº¦ ===")
importance_df = defect_predictor.get_feature_importance()
print(importance_df)

# æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§äºˆæ¸¬
new_data = pd.DataFrame({
    'temperature': [210],  # é«˜æ¸©
    'pressure': [45],      # ä½åœ§
    'speed': [105],
    'humidity': [65]
})

prediction = defect_predictor.predict(new_data)
print("\n=== äºˆæ¸¬çµæœ ===")
print(f"äºˆæ¸¬: {prediction['prediction']}")
print(f"ä¸è‰¯ç¢ºç‡: {prediction['defect_probability']:.3f}")
print(f"ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: {prediction['risk_level']}")

# ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜
defect_predictor.save_model("defect_prediction_model.pkl")</code></pre>
        </div>

        <h3>5.3.2 APIçµ±åˆã¨ãƒ‡ãƒ¼ã‚¿åé›†è‡ªå‹•åŒ–</h3>

        <p>å¤–éƒ¨APIï¼ˆMESã€ERPã‚·ã‚¹ãƒ†ãƒ ï¼‰ã¨ã®çµ±åˆã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿åé›†ã‚’è‡ªå‹•åŒ–ã—ã¾ã™ã€‚</p>

        <div class="example-box">
            <div class="example-title">ä¾‹6: APIçµ±åˆãƒ‡ãƒ¼ã‚¿åé›†ã‚·ã‚¹ãƒ†ãƒ </div>
            <pre><code>import requests
import pandas as pd
from datetime import datetime, timedelta
from typing import List, Dict, Optional
import json
import time

class MESAPIIntegration:
    """MESï¼ˆè£½é€ å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ ï¼‰APIçµ±åˆ

    MESã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è£½é€ ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•åé›†ã—ã€
    å“è³ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«çµ±åˆã€‚
    """

    def __init__(self, api_base_url: str, api_key: str):
        """
        Args:
            api_base_url: MES API ã®ãƒ™ãƒ¼ã‚¹URL
            api_key: èªè¨¼ç”¨APIã‚­ãƒ¼
        """
        self.api_base_url = api_base_url
        self.api_key = api_key
        self.headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }

    def get_production_data(self, start_time: datetime,
                           end_time: datetime,
                           line_id: str = None) -> pd.DataFrame:
        """ç”Ÿç”£ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

        Args:
            start_time: é–‹å§‹æ™‚åˆ»
            end_time: çµ‚äº†æ™‚åˆ»
            line_id: è£½é€ ãƒ©ã‚¤ãƒ³IDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

        Returns:
            ç”Ÿç”£ãƒ‡ãƒ¼ã‚¿ã®DataFrame
        """
        endpoint = f"{self.api_base_url}/production/data"

        params = {
            "start_time": start_time.isoformat(),
            "end_time": end_time.isoformat()
        }

        if line_id:
            params["line_id"] = line_id

        try:
            response = requests.get(
                endpoint,
                headers=self.headers,
                params=params,
                timeout=30
            )

            response.raise_for_status()
            data = response.json()

            # DataFrameã«å¤‰æ›
            df = pd.DataFrame(data['records'])

            print(f"ç”Ÿç”£ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: {len(df)}ãƒ¬ã‚³ãƒ¼ãƒ‰")
            return df

        except requests.exceptions.RequestException as e:
            print(f"APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: {e}")
            return pd.DataFrame()

    def get_quality_inspections(self, start_date: datetime,
                               end_date: datetime) -> pd.DataFrame:
        """å“è³ªæ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

        Args:
            start_date: é–‹å§‹æ—¥
            end_date: çµ‚äº†æ—¥

        Returns:
            æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ã®DataFrame
        """
        endpoint = f"{self.api_base_url}/quality/inspections"

        params = {
            "start_date": start_date.strftime("%Y-%m-%d"),
            "end_date": end_date.strftime("%Y-%m-%d")
        }

        try:
            response = requests.get(
                endpoint,
                headers=self.headers,
                params=params,
                timeout=30
            )

            response.raise_for_status()
            data = response.json()

            df = pd.DataFrame(data['inspections'])

            print(f"æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: {len(df)}ãƒ¬ã‚³ãƒ¼ãƒ‰")
            return df

        except requests.exceptions.RequestException as e:
            print(f"APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: {e}")
            return pd.DataFrame()

    def post_quality_alert(self, alert_data: Dict) -> bool:
        """å“è³ªã‚¢ãƒ©ãƒ¼ãƒˆã‚’MESã«é€ä¿¡

        Args:
            alert_data: ã‚¢ãƒ©ãƒ¼ãƒˆæƒ…å ±

        Returns:
            é€ä¿¡æˆåŠŸã®å¯å¦
        """
        endpoint = f"{self.api_base_url}/quality/alerts"

        try:
            response = requests.post(
                endpoint,
                headers=self.headers,
                json=alert_data,
                timeout=30
            )

            response.raise_for_status()

            print(f"ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡æˆåŠŸ: {alert_data['alert_id']}")
            return True

        except requests.exceptions.RequestException as e:
            print(f"ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
            return False


class AutomatedDataCollector:
    """è‡ªå‹•ãƒ‡ãƒ¼ã‚¿åé›†ã‚·ã‚¹ãƒ†ãƒ 

    å®šæœŸçš„ã«MES APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã€
    å“è³ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ ¼ç´ã€‚ç•°å¸¸æ¤œå‡ºã¨é€šçŸ¥ã‚‚å®Ÿæ–½ã€‚
    """

    def __init__(self, mes_api: MESAPIIntegration,
                quality_db: QualityDatabase,
                spc_monitor: RealTimeSPCMonitor):
        self.mes_api = mes_api
        self.quality_db = quality_db
        self.spc_monitor = spc_monitor

    def collect_and_process(self, interval_minutes: int = 15):
        """ãƒ‡ãƒ¼ã‚¿åé›†ã¨å‡¦ç†ã‚’å®Ÿè¡Œ

        Args:
            interval_minutes: ãƒ‡ãƒ¼ã‚¿åé›†é–“éš”ï¼ˆåˆ†ï¼‰
        """
        end_time = datetime.now()
        start_time = end_time - timedelta(minutes=interval_minutes)

        print(f"\n{'='*60}")
        print(f"ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹: {start_time} - {end_time}")
        print(f"{'='*60}")

        # ç”Ÿç”£ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        production_df = self.mes_api.get_production_data(
            start_time, end_time
        )

        if production_df.empty:
            print("åé›†ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
            return

        # å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‡¦ç†
        for idx, row in production_df.iterrows():
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
            self.quality_db.add_measurement(
                timestamp=pd.to_datetime(row['timestamp']),
                process_name=row['process_name'],
                parameter_name=row['parameter'],
                value=row['value'],
                target=row.get('target'),
                ucl=row.get('ucl'),
                lcl=row.get('lcl'),
                operator=row.get('operator'),
                lot_number=row.get('lot_number')
            )

            # SPCãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
            result = self.spc_monitor.add_measurement(
                value=row['value'],
                timestamp=pd.to_datetime(row['timestamp'])
            )

            # ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç”Ÿæ™‚ã¯MESã«é€šçŸ¥
            if result['status'] == 'ALERT':
                alert_data = {
                    "alert_id": result['alert_id'],
                    "timestamp": datetime.now().isoformat(),
                    "process_name": row['process_name'],
                    "severity": "Critical",
                    "violations": result['violations'],
                    "value": row['value']
                }

                self.mes_api.post_quality_alert(alert_data)

        print(f"ãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Œäº†: {len(production_df)}ãƒ¬ã‚³ãƒ¼ãƒ‰")

    def run_continuous_collection(self, interval_minutes: int = 15,
                                 max_iterations: int = None):
        """ç¶™ç¶šçš„ãƒ‡ãƒ¼ã‚¿åé›†ã‚’å®Ÿè¡Œ

        Args:
            interval_minutes: åé›†é–“éš”ï¼ˆåˆ†ï¼‰
            max_iterations: æœ€å¤§ç¹°ã‚Šè¿”ã—å›æ•°ï¼ˆNone = ç„¡é™ï¼‰
        """
        iteration = 0

        print("ç¶™ç¶šçš„ãƒ‡ãƒ¼ã‚¿åé›†ã‚’é–‹å§‹ã—ã¾ã™")
        print(f"åé›†é–“éš”: {interval_minutes}åˆ†")

        try:
            while True:
                iteration += 1

                if max_iterations and iteration > max_iterations:
                    print(f"{max_iterations}å›ã®åé›†ãŒå®Œäº†ã—ã¾ã—ãŸ")
                    break

                self.collect_and_process(interval_minutes)

                # æ¬¡ã®åé›†ã¾ã§å¾…æ©Ÿ
                print(f"\næ¬¡ã®åé›†ã¾ã§{interval_minutes}åˆ†å¾…æ©Ÿ...")
                time.sleep(interval_minutes * 60)

        except KeyboardInterrupt:
            print("\n\nåé›†ã‚’æ‰‹å‹•ã§åœæ­¢ã—ã¾ã—ãŸ")


# ä½¿ç”¨ä¾‹ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
# æ³¨æ„: å®Ÿéš›ã®API URLã¨ã‚­ãƒ¼ãŒå¿…è¦

# MES APIã‚’åˆæœŸåŒ–ï¼ˆãƒ€ãƒŸãƒ¼URLï¼‰
# mes_api = MESAPIIntegration(
#     api_base_url="https://mes.example.com/api/v1",
#     api_key="your_api_key_here"
# )

# å“è³ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨SPCãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
# quality_db = QualityDatabase("quality_data.db")
# spc_monitor = RealTimeSPCMonitor(
#     process_name="æˆå½¢æ¸©åº¦",
#     target=200.0,
#     ucl=210.0,
#     lcl=190.0
# )

# è‡ªå‹•åé›†ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
# collector = AutomatedDataCollector(mes_api, quality_db, spc_monitor)

# ç¶™ç¶šçš„ãƒ‡ãƒ¼ã‚¿åé›†ã‚’é–‹å§‹
# collector.run_continuous_collection(interval_minutes=15)

print("\nAPIçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®ä¾‹ã‚’ç¤ºã—ã¾ã—ãŸ")
print("å®Ÿéš›ã®ä½¿ç”¨ã«ã¯ã€MESã‚·ã‚¹ãƒ†ãƒ ã®APIä»•æ§˜ã«åˆã‚ã›ãŸå®Ÿè£…ãŒå¿…è¦ã§ã™")</code></pre>
        </div>

        <h3>5.3.3 è‡ªå‹•ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ç”Ÿæˆ</h3>

        <p>çµ±è¨ˆçš„æ‰‹æ³•ã«åŸºã¥ã„ã¦ã€æœ€é©ãªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚</p>

        <div class="example-box">
            <div class="example-title">ä¾‹7: è‡ªå‹•ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </div>
            <pre><code>import numpy as np
import pandas as pd
from scipy import stats
from typing import Dict, Tuple

class SamplingPlanGenerator:
    """è‡ªå‹•ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 

    AQLï¼ˆAcceptable Quality Levelï¼‰ã«åŸºã¥ã„ã¦ã€
    çµ±è¨ˆçš„ã«æœ‰æ„ãªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ã‚’è‡ªå‹•ç”Ÿæˆã€‚
    """

    def __init__(self):
        # MIL-STD-105E ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚³ãƒ¼ãƒ‰è¡¨ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        self.sample_size_codes = {
            "S-1": {"range": (2, 8), "code_letter": "A"},
            "S-2": {"range": (9, 15), "code_letter": "A"},
            "S-3": {"range": (16, 25), "code_letter": "B"},
            "S-4": {"range": (26, 50), "code_letter": "C"},
            "S-5": {"range": (51, 90), "code_letter": "D"},
            "S-6": {"range": (91, 150), "code_letter": "E"},
            "S-7": {"range": (151, 280), "code_letter": "F"},
            "S-8": {"range": (281, 500), "code_letter": "G"},
            "S-9": {"range": (501, 1200), "code_letter": "H"},
            "S-10": {"range": (1201, 3200), "code_letter": "J"},
            "S-11": {"range": (3201, 10000), "code_letter": "K"},
        }

        # ã‚·ãƒ³ã‚°ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        self.single_sampling_plans = {
            "A": {"1.0": {"n": 2, "Ac": 0, "Re": 1}},
            "B": {"1.0": {"n": 3, "Ac": 0, "Re": 1}},
            "C": {"1.0": {"n": 5, "Ac": 0, "Re": 1}},
            "D": {"1.0": {"n": 8, "Ac": 0, "Re": 1}},
            "E": {"1.0": {"n": 13, "Ac": 0, "Re": 1}},
            "F": {"1.0": {"n": 20, "Ac": 0, "Re": 1}},
            "G": {"1.0": {"n": 32, "Ac": 1, "Re": 2}},
            "H": {"1.0": {"n": 50, "Ac": 1, "Re": 2}},
            "J": {"1.0": {"n": 80, "Ac": 2, "Re": 3}},
            "K": {"1.0": {"n": 125, "Ac": 3, "Re": 4}},
        }

    def generate_single_sampling_plan(self, lot_size: int,
                                     aql: float = 1.0,
                                     inspection_level: str = "II") -> Dict:
        """ã‚·ãƒ³ã‚°ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ã‚’ç”Ÿæˆ

        Args:
            lot_size: ãƒ­ãƒƒãƒˆã‚µã‚¤ã‚º
            aql: åˆæ ¼å“è³ªæ°´æº–ï¼ˆ%ï¼‰
            inspection_level: æ¤œæŸ»ãƒ¬ãƒ™ãƒ«ï¼ˆ"I", "II", "III"ï¼‰

        Returns:
            ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ï¼ˆã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã€åˆæ ¼åˆ¤å®šå€‹æ•°ã€ä¸åˆæ ¼åˆ¤å®šå€‹æ•°ï¼‰
        """
        # ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰æ–‡å­—ã‚’æ±ºå®š
        code_letter = None
        for code_info in self.sample_size_codes.values():
            lot_range = code_info["range"]
            if lot_range[0] <= lot_size <= lot_range[1]:
                code_letter = code_info["code_letter"]
                break

        if code_letter is None:
            raise ValueError(f"ãƒ­ãƒƒãƒˆã‚µã‚¤ã‚º {lot_size} ãŒç¯„å›²å¤–ã§ã™")

        # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ã‚’å–å¾—
        aql_str = str(aql)
        if code_letter in self.single_sampling_plans:
            if aql_str in self.single_sampling_plans[code_letter]:
                plan = self.single_sampling_plans[code_letter][aql_str]
            else:
                # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦1.0ã‚’ä½¿ç”¨
                plan = self.single_sampling_plans[code_letter]["1.0"]
        else:
            raise ValueError(f"ã‚³ãƒ¼ãƒ‰æ–‡å­— {code_letter} ã®ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“")

        sampling_plan = {
            "lot_size": lot_size,
            "aql": aql,
            "inspection_level": inspection_level,
            "code_letter": code_letter,
            "sample_size": plan["n"],
            "acceptance_number": plan["Ac"],
            "rejection_number": plan["Re"]
        }

        return sampling_plan

    def calculate_oc_curve(self, n: int, Ac: int,
                          p_range: np.ndarray = None) -> pd.DataFrame:
        """OCæ›²ç·šï¼ˆæ¤œæŸ»ç‰¹æ€§æ›²ç·šï¼‰ã‚’è¨ˆç®—

        Args:
            n: ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º
            Ac: åˆæ ¼åˆ¤å®šå€‹æ•°
            p_range: ä¸è‰¯ç‡ã®ç¯„å›²ï¼ˆé…åˆ—ï¼‰

        Returns:
            OCæ›²ç·šãƒ‡ãƒ¼ã‚¿ã®DataFrame
        """
        if p_range is None:
            p_range = np.linspace(0, 0.15, 100)

        # å„ä¸è‰¯ç‡ã§ã®åˆæ ¼ç¢ºç‡ã‚’è¨ˆç®—ï¼ˆäºŒé …åˆ†å¸ƒï¼‰
        pa_values = []
        for p in p_range:
            pa = sum(stats.binom.pmf(k, n, p) for k in range(Ac + 1))
            pa_values.append(pa)

        oc_df = pd.DataFrame({
            "defect_rate": p_range * 100,  # %è¡¨ç¤º
            "probability_acceptance": pa_values
        })

        return oc_df

    def generate_double_sampling_plan(self, lot_size: int,
                                     aql: float = 1.0) -> Dict:
        """ãƒ€ãƒ–ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ã‚’ç”Ÿæˆ

        Args:
            lot_size: ãƒ­ãƒƒãƒˆã‚µã‚¤ã‚º
            aql: åˆæ ¼å“è³ªæ°´æº–ï¼ˆ%ï¼‰

        Returns:
            ãƒ€ãƒ–ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»
        """
        # ã‚·ãƒ³ã‚°ãƒ«ãƒ—ãƒ©ãƒ³ã‹ã‚‰å°å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
        single_plan = self.generate_single_sampling_plan(lot_size, aql)

        n1 = int(single_plan["sample_size"] * 0.6)
        n2 = int(single_plan["sample_size"] * 0.6)

        Ac1 = 0
        Re1 = max(2, single_plan["rejection_number"])
        Ac2 = single_plan["acceptance_number"]
        Re2 = Ac2 + 1

        double_plan = {
            "lot_size": lot_size,
            "aql": aql,
            "first_sample_size": n1,
            "first_acceptance_number": Ac1,
            "first_rejection_number": Re1,
            "second_sample_size": n2,
            "second_acceptance_number": Ac2,
            "second_rejection_number": Re2,
            "total_max_sample_size": n1 + n2
        }

        return double_plan

    def calculate_sample_size_for_estimation(self,
                                            confidence_level: float = 0.95,
                                            margin_of_error: float = 0.05,
                                            population_std: float = 1.0,
                                            population_size: int = None) -> int:
        """æ¯é›†å›£æ¨å®šã®ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã‚’è¨ˆç®—

        Args:
            confidence_level: ä¿¡é ¼æ°´æº–ï¼ˆ0.9, 0.95, 0.99ï¼‰
            margin_of_error: è¨±å®¹èª¤å·®
            population_std: æ¯é›†å›£ã®æ¨™æº–åå·®ï¼ˆæ¨å®šå€¤ï¼‰
            population_size: æ¯é›†å›£ã‚µã‚¤ã‚ºï¼ˆæœ‰é™æ¯é›†å›£è£œæ­£ç”¨ï¼‰

        Returns:
            å¿…è¦ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º
        """
        # Zå€¤ã‚’å–å¾—
        z = stats.norm.ppf((1 + confidence_level) / 2)

        # ç„¡é™æ¯é›†å›£ã®å ´åˆã®ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º
        n = (z * population_std / margin_of_error) ** 2

        # æœ‰é™æ¯é›†å›£è£œæ­£
        if population_size:
            n = n / (1 + (n - 1) / population_size)

        return int(np.ceil(n))


# ä½¿ç”¨ä¾‹
sampler = SamplingPlanGenerator()

# ã‚·ãƒ³ã‚°ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ã‚’ç”Ÿæˆ
print("=== ã‚·ãƒ³ã‚°ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”» ===")
plan = sampler.generate_single_sampling_plan(
    lot_size=500,
    aql=1.0,
    inspection_level="II"
)

print(f"ãƒ­ãƒƒãƒˆã‚µã‚¤ã‚º: {plan['lot_size']}")
print(f"AQL: {plan['aql']}%")
print(f"ã‚³ãƒ¼ãƒ‰æ–‡å­—: {plan['code_letter']}")
print(f"ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º: {plan['sample_size']}")
print(f"åˆæ ¼åˆ¤å®šå€‹æ•° (Ac): {plan['acceptance_number']}")
print(f"ä¸åˆæ ¼åˆ¤å®šå€‹æ•° (Re): {plan['rejection_number']}")

# OCæ›²ç·šã‚’è¨ˆç®—
print("\n=== OCæ›²ç·šãƒ‡ãƒ¼ã‚¿ ===")
oc_curve = sampler.calculate_oc_curve(
    n=plan['sample_size'],
    Ac=plan['acceptance_number']
)
print(oc_curve.head(10))

# ãƒ€ãƒ–ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ã‚’ç”Ÿæˆ
print("\n=== ãƒ€ãƒ–ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”» ===")
double_plan = sampler.generate_double_sampling_plan(
    lot_size=500,
    aql=1.0
)

print(f"ç¬¬1ã‚µãƒ³ãƒ—ãƒ«: n1={double_plan['first_sample_size']}, "
      f"Ac1={double_plan['first_acceptance_number']}, "
      f"Re1={double_plan['first_rejection_number']}")
print(f"ç¬¬2ã‚µãƒ³ãƒ—ãƒ«: n2={double_plan['second_sample_size']}, "
      f"Ac2={double_plan['second_acceptance_number']}, "
      f"Re2={double_plan['second_rejection_number']}")
print(f"æœ€å¤§ã‚µãƒ³ãƒ—ãƒ«ç·æ•°: {double_plan['total_max_sample_size']}")

# æ¨å®šã®ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºè¨ˆç®—
print("\n=== æ¨å®šç”¨ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º ===")
sample_size_estimation = sampler.calculate_sample_size_for_estimation(
    confidence_level=0.95,
    margin_of_error=0.05,
    population_std=2.0,
    population_size=1000
)
print(f"å¿…è¦ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º: {sample_size_estimation}")</code></pre>
        </div>

        <h3>5.3.4 çµ±åˆå“è³ªãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</h3>

        <p>ã“ã‚Œã¾ã§ã®å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’çµ±åˆã—ãŸã€å®Œå…¨ãªå“è³ªãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¤ºã—ã¾ã™ã€‚</p>

        <div class="example-box">
            <div class="example-title">ä¾‹8: çµ±åˆå“è³ªãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ </div>
            <pre><code>from datetime import datetime, timedelta
import pandas as pd
import numpy as np

class IntegratedQualityManagementSystem:
    """çµ±åˆå“è³ªãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 

    ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã€æ©Ÿæ¢°å­¦ç¿’äºˆæ¸¬ã€
    ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’çµ±åˆã—ãŸã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®QMSãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€‚
    """

    def __init__(self):
        # å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’åˆæœŸåŒ–
        self.quality_db = QualityDatabase("integrated_qms.db")

        self.spc_monitor = RealTimeSPCMonitor(
            process_name="çµ±åˆãƒ—ãƒ­ã‚»ã‚¹",
            target=100.0,
            ucl=106.0,
            lcl=94.0,
            email_recipients=["quality@example.com"]
        )

        self.defect_predictor = DefectPredictionSystem()

        self.dashboard = QualityDashboard()

        self.report_generator = AutoReportGenerator(
            report_period=datetime.now().strftime("%Yå¹´%mæœˆ")
        )

        self.sampler = SamplingPlanGenerator()

        print("çµ±åˆå“è³ªãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ")

    def workflow_step1_data_collection(self):
        """ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿åé›†"""
        print("\n" + "="*60)
        print("ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿åé›†")
        print("="*60)

        # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: è£½é€ ãƒ‡ãƒ¼ã‚¿åé›†
        np.random.seed(42)

        for i in range(20):
            timestamp = datetime.now() - timedelta(hours=20-i)
            value = np.random.normal(100, 2.5)

            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
            self.quality_db.add_measurement(
                timestamp=timestamp,
                process_name="çµ±åˆãƒ—ãƒ­ã‚»ã‚¹",
                parameter_name="ä¸»è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿",
                value=value,
                target=100.0,
                ucl=106.0,
                lcl=94.0,
                operator="ä½œæ¥­è€…A",
                lot_number=f"LOT-{i:03d}"
            )

            # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
            self.dashboard.add_control_chart_data(
                timestamp=timestamp,
                value=value,
                target=100.0,
                ucl=106.0,
                lcl=94.0
            )

        print(f"ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†: 20ãƒ¬ã‚³ãƒ¼ãƒ‰")

    def workflow_step2_realtime_monitoring(self):
        """ã‚¹ãƒ†ãƒƒãƒ—2: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–"""
        print("\n" + "="*60)
        print("ã‚¹ãƒ†ãƒƒãƒ—2: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ")
        print("="*60)

        # æ¸¬å®šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        df = self.quality_db.get_measurements(process_name="çµ±åˆãƒ—ãƒ­ã‚»ã‚¹")

        # SPCç›£è¦–ã‚’å®Ÿè¡Œ
        alert_count = 0
        for _, row in df.iterrows():
            result = self.spc_monitor.add_measurement(
                value=row['value'],
                timestamp=pd.to_datetime(row['timestamp'])
            )

            if result['status'] == 'ALERT':
                alert_count += 1

        print(f"SPCç›£è¦–å®Œäº†: {alert_count}ä»¶ã®ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç”Ÿ")

    def workflow_step3_defect_prediction(self):
        """ã‚¹ãƒ†ãƒƒãƒ—3: ä¸è‰¯äºˆæ¸¬ï¼ˆæ©Ÿæ¢°å­¦ç¿’ï¼‰"""
        print("\n" + "="*60)
        print("ã‚¹ãƒ†ãƒƒãƒ—3: æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹ä¸è‰¯äºˆæ¸¬")
        print("="*60)

        # è¨“ç·´ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        np.random.seed(42)
        n_samples = 1000

        temperature = np.random.normal(200, 5, n_samples)
        pressure = np.random.normal(50, 3, n_samples)
        speed = np.random.normal(100, 10, n_samples)

        defect_score = (
            (temperature - 200) * 0.3 +
            (50 - pressure) * 0.4 +
            np.random.normal(0, 2, n_samples)
        )
        is_defect = (defect_score > 2).astype(int)

        train_df = pd.DataFrame({
            'temperature': temperature,
            'pressure': pressure,
            'speed': speed,
            'is_defect': is_defect
        })

        # ãƒ¢ãƒ‡ãƒ«è¨“ç·´
        X_train, X_test, y_train, y_test = \
            self.defect_predictor.prepare_training_data(train_df)

        self.defect_predictor.train(X_train, y_train)

        # ãƒ¢ãƒ‡ãƒ«è©•ä¾¡
        metrics = self.defect_predictor.evaluate(X_test, y_test)

        print(f"äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«è¨“ç·´å®Œäº†: ROC-AUC = {metrics['roc_auc']:.3f}")

    def workflow_step4_sampling_plan(self):
        """ã‚¹ãƒ†ãƒƒãƒ—4: ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ç”Ÿæˆ"""
        print("\n" + "="*60)
        print("ã‚¹ãƒ†ãƒƒãƒ—4: è‡ªå‹•ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»")
        print("="*60)

        plan = self.sampler.generate_single_sampling_plan(
            lot_size=500,
            aql=1.0
        )

        print(f"ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º: {plan['sample_size']}")
        print(f"åˆæ ¼åˆ¤å®šå€‹æ•°: {plan['acceptance_number']}")

    def workflow_step5_dashboard_generation(self):
        """ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”Ÿæˆ"""
        print("\n" + "="*60)
        print("ã‚¹ãƒ†ãƒƒãƒ—5: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”Ÿæˆ")
        print("="*60)

        # ä¸è‰¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        defect_types = ["å¯¸æ³•ä¸è‰¯", "å¤–è¦³ä¸è‰¯", "æ©Ÿèƒ½ä¸è‰¯", "æ¢±åŒ…ä¸è‰¯"]
        defect_counts = [45, 28, 15, 8]

        for defect_type, count in zip(defect_types, defect_counts):
            self.dashboard.add_defect_data(defect_type, count)

        # KPIãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        kpis = [
            ("è‰¯å“ç‡", 98.5, 99.0, "%"),
            ("ç´æœŸéµå®ˆç‡", 96.0, 95.0, "%"),
        ]

        for kpi_name, actual, target, unit in kpis:
            self.dashboard.add_kpi_data(kpi_name, actual, target, unit)

        # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        self.dashboard.export_html("integrated_dashboard.html")

        print("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†: integrated_dashboard.html")

    def workflow_step6_report_generation(self):
        """ã‚¹ãƒ†ãƒƒãƒ—6: è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"""
        print("\n" + "="*60)
        print("ã‚¹ãƒ†ãƒƒãƒ—6: è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ")
        print("="*60)

        # ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        self.report_generator.add_summary_data(
            total_production=50000,
            defect_count=750,
            yield_rate=98.5,
            customer_complaints=8
        )

        # KPIãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        kpi_list = [
            {"name": "è‰¯å“ç‡", "target": 99.0, "actual": 98.5, "achievement": 99.5},
            {"name": "ç´æœŸéµå®ˆç‡", "target": 95.0, "actual": 96.5, "achievement": 101.6}
        ]
        self.report_generator.add_kpi_data(kpi_list)

        # Excelãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        self.report_generator.generate_excel_report("integrated_report.xlsx")

        print("ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: integrated_report.xlsx")

    def run_complete_workflow(self):
        """å®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ"""
        print("\n" + "#"*60)
        print("# çµ±åˆå“è³ªãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ  - å®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼")
        print("#"*60)

        # å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’é †æ¬¡å®Ÿè¡Œ
        self.workflow_step1_data_collection()
        self.workflow_step2_realtime_monitoring()
        self.workflow_step3_defect_prediction()
        self.workflow_step4_sampling_plan()
        self.workflow_step5_dashboard_generation()
        self.workflow_step6_report_generation()

        print("\n" + "="*60)
        print("ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†")
        print("="*60)

        # ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
        metrics = self.quality_db.get_dashboard_metrics()
        print("\n=== æœ€çµ‚ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===")
        for key, value in metrics.items():
            print(f"{key}: {value}")

        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’é–‰ã˜ã‚‹
        self.quality_db.close()


# ä½¿ç”¨ä¾‹
qms = IntegratedQualityManagementSystem()

# å®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
qms.run_complete_workflow()

print("\nçµ±åˆå“è³ªãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ")</code></pre>
        </div>

        <h2>ã¾ã¨ã‚</h2>

        <p>ã“ã®ç« ã§ã¯ã€Pythonã‚’ä½¿ã£ãŸå“è³ªç®¡ç†ã®è‡ªå‹•åŒ–ã«ã¤ã„ã¦ã€å®Ÿè·µçš„ãªå®Ÿè£…æ–¹æ³•ã‚’å­¦ã³ã¾ã—ãŸã€‚</p>

        <div class="info-box">
            <h4>ğŸ“š é‡è¦ãƒã‚¤ãƒ³ãƒˆ</h4>
            <ul>
                <li><strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–</strong>: Western Electric Rulesã«ã‚ˆã‚‹ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³è‡ªå‹•æ¤œå‡º</li>
                <li><strong>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</strong>: Plotlyã«ã‚ˆã‚‹å¯è¦–åŒ–ã¨HTMLå‡ºåŠ›</li>
                <li><strong>è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</strong>: PDF/Excelå½¢å¼ã§ã®å®šæœŸãƒ¬ãƒãƒ¼ãƒˆä½œæˆ</li>
                <li><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆ</strong>: SQLiteã«ã‚ˆã‚‹æ°¸ç¶šåŒ–ã¨å±¥æ­´ç®¡ç†</li>
                <li><strong>æ©Ÿæ¢°å­¦ç¿’äºˆæ¸¬</strong>: Random Forestã«ã‚ˆã‚‹ä¸è‰¯äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«</li>
                <li><strong>APIçµ±åˆ</strong>: MES/ERPã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åé›†è‡ªå‹•åŒ–</li>
                <li><strong>ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»</strong>: çµ±è¨ˆçš„æ‰‹æ³•ã«åŸºã¥ãæœ€é©è¨ˆç”»ã®è‡ªå‹•ç”Ÿæˆ</li>
                <li><strong>ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰çµ±åˆ</strong>: å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’çµ±åˆã—ãŸQMSãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</li>
            </ul>
        </div>

        <div class="tip-box">
            <h4>ğŸ’¡ å®Ÿå‹™ã¸ã®å¿œç”¨</h4>
            <p>ã“ã‚Œã‚‰ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªé«˜åº¦ãªå“è³ªãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆãŒå®Ÿç¾ã§ãã¾ã™ï¼š</p>
            <ul>
                <li>è£½é€ ãƒ—ãƒ­ã‚»ã‚¹ã®24æ™‚é–“è‡ªå‹•ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ</li>
                <li>çµŒå–¶å±¤å‘ã‘ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</li>
                <li>AI ã«ã‚ˆã‚‹ä¸è‰¯äºˆæ¸¬ã¨äºˆé˜²ä¿å…¨</li>
                <li>å®Œå…¨è‡ªå‹•åŒ–ã•ã‚ŒãŸå“è³ªãƒ¬ãƒãƒ¼ãƒ†ã‚£ãƒ³ã‚°</li>
                <li>ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ãªç¶™ç¶šçš„æ”¹å–„æ´»å‹•</li>
            </ul>
        </div>

        <div class="nav-links">
            <a href="chapter-4.html">â† ç¬¬4ç« ï¼šå“è³ªæ¨™æº–ã¨ISO 9001</a>
            <a href="index.html">ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡ã«æˆ»ã‚‹ â†’</a>
        </div>
    </div>
</body>
</html>