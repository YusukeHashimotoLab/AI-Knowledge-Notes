<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç¬¬3ç« ï¼šã‚·ãƒƒã‚¯ã‚¹ã‚·ã‚°ãƒã¨DMAICæ‰‹æ³• - å“è³ªç®¡ç†ã¨QAå…¥é–€ã‚·ãƒªãƒ¼ã‚º">
    <title>ç¬¬3ç« ï¼šã‚·ãƒƒã‚¯ã‚¹ã‚·ã‚°ãƒã¨DMAICæ‰‹æ³• - å“è³ªç®¡ç†ã¨QAå…¥é–€ | PI Terakoya</title>

    <style>
        :root {
            --color-primary: #2c3e50;
            --color-primary-dark: #1a252f;
            --color-accent: #11998e;
            --color-accent-light: #38ef7d;
            --color-text: #2d3748;
            --color-text-light: #4a5568;
            --color-bg: #ffffff;
            --color-bg-alt: #f7fafc;
            --color-border: #e2e8f0;
            --color-code-bg: #f8f9fa;
            --color-link: #11998e;
            --color-link-hover: #0d7a6f;

            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;

            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;

            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.7;
            color: var(--color-text);
            background-color: var(--color-bg);
            font-size: 16px;
        }

        header {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: var(--spacing-md);
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 var(--spacing-md) var(--spacing-xl);
        }

        h2 {
            font-size: 1.75rem;
            color: var(--color-primary);
            margin: var(--spacing-xl) 0 var(--spacing-md);
            padding-bottom: var(--spacing-xs);
            border-bottom: 3px solid var(--color-accent);
        }

        h3 {
            font-size: 1.4rem;
            color: var(--color-primary);
            margin: var(--spacing-lg) 0 var(--spacing-md);
        }

        h4 {
            font-size: 1.1rem;
            color: var(--color-primary);
            margin: var(--spacing-md) 0 var(--spacing-sm);
        }

        p {
            margin-bottom: var(--spacing-md);
            line-height: 1.8;
        }

        pre {
            background-color: var(--color-code-bg);
            border: 1px solid var(--color-border);
            border-left: 4px solid var(--color-accent);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            overflow-x: auto;
            margin-bottom: var(--spacing-md);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            font-family: var(--font-mono);
            background-color: var(--color-code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.9em;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        ul, ol {
            margin-bottom: var(--spacing-md);
            padding-left: var(--spacing-lg);
        }

        li {
            margin-bottom: var(--spacing-xs);
        }

        .info-box {
            background-color: var(--color-bg-alt);
            border-left: 4px solid var(--color-accent);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .info-box h4 {
            margin-top: 0;
            color: var(--color-accent);
        }

        .warning-box {
            background-color: #fff8e1;
            border-left: 4px solid #ffa726;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .warning-box h4 {
            margin-top: 0;
            color: #f57c00;
        }

        .example-box {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .example-box h4 {
            margin-top: 0;
            color: #2e7d32;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
            font-size: 0.95rem;
        }

        th, td {
            padding: var(--spacing-sm);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        th {
            background-color: var(--color-bg-alt);
            font-weight: 600;
            color: var(--color-primary);
        }

        tr:hover {
            background-color: var(--color-bg-alt);
        }

        .nav-links {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--color-border);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .nav-link {
            display: inline-block;
            padding: var(--spacing-sm) var(--spacing-md);
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 500;
        }

        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.4rem;
            }

            h3 {
                font-size: 1.2rem;
            }

            .meta {
                font-size: 0.85rem;
            }

            pre {
                font-size: 0.85rem;
            }

            .nav-links {
                flex-direction: column;
            }

            .nav-link {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ç¬¬3ç« ï¼šã‚·ãƒƒã‚¯ã‚¹ã‚·ã‚°ãƒã¨DMAICæ‰‹æ³•</h1>
            <p class="subtitle">ãƒ‡ãƒ¼ã‚¿é§†å‹•å‹ã®å•é¡Œè§£æ±ºãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§å“è³ªã‚’é£›èºçš„ã«å‘ä¸Š</p>
            <div class="meta">
                <span class="meta-item">ğŸ“š å“è³ªç®¡ç†ã¨QAå…¥é–€ã‚·ãƒªãƒ¼ã‚º</span>
                <span class="meta-item">â±ï¸ èª­äº†æ™‚é–“: 45åˆ†</span>
                <span class="meta-item">ğŸ’» Pythonå®Ÿè£…ä¾‹: 8ã¤</span>
                <span class="meta-item">ğŸ“Š é›£æ˜“åº¦: ä¸­ç´šã€œä¸Šç´š</span>
            </div>
        </div>
    </header>

    <div class="container">
        <section>
            <h2>3.1 ã‚·ãƒƒã‚¯ã‚¹ã‚·ã‚°ãƒã®åŸºç¤</h2>

            <p>ã‚·ãƒƒã‚¯ã‚¹ã‚·ã‚°ãƒ(Six Sigma)ã¯ã€1980å¹´ä»£ã«ãƒ¢ãƒˆãƒ­ãƒ¼ãƒ©ç¤¾ã§é–‹ç™ºã•ã‚ŒãŸå“è³ªç®¡ç†æ‰‹æ³•ã§ã€ãƒ—ãƒ­ã‚»ã‚¹ã®å¤‰å‹•ã‚’çµ±è¨ˆçš„ã«ç®¡ç†ã—ã€æ¬ é™¥ã‚’100ä¸‡æ©Ÿä¼šã‚ãŸã‚Š3.4å€‹(3.4 DPMO)ä»¥ä¸‹ã«æŠ‘ãˆã‚‹ã“ã¨ã‚’ç›®æ¨™ã¨ã—ã¾ã™ã€‚</p>

            <h3>3.1.1 ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã®æ„å‘³</h3>

            <div class="info-box">
                <h4>ğŸ’¡ ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã¨å“è³ªã®é–¢ä¿‚</h4>
                <p>ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã¯ã€ãƒ—ãƒ­ã‚»ã‚¹ã®å¹³å‡ã‹ã‚‰è¦æ ¼é™ç•Œã¾ã§ã®è·é›¢ã‚’æ¨™æº–åå·®(Ïƒ)ã®å€æ•°ã§è¡¨ã—ãŸã‚‚ã®ã§ã™ã€‚ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„ã»ã©å“è³ªãŒå„ªã‚Œã¦ã„ã¾ã™ã€‚</p>
                <table>
                    <tr>
                        <th>ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«</th>
                        <th>DPMO</th>
                        <th>æ­©ç•™ã¾ã‚Š</th>
                        <th>å“è³ªè©•ä¾¡</th>
                    </tr>
                    <tr>
                        <td>2Ïƒ</td>
                        <td>308,537</td>
                        <td>69.1%</td>
                        <td>éå¸¸ã«æ‚ªã„</td>
                    </tr>
                    <tr>
                        <td>3Ïƒ</td>
                        <td>66,807</td>
                        <td>93.3%</td>
                        <td>æ‚ªã„</td>
                    </tr>
                    <tr>
                        <td>4Ïƒ</td>
                        <td>6,210</td>
                        <td>99.38%</td>
                        <td>æ™®é€š</td>
                    </tr>
                    <tr>
                        <td>5Ïƒ</td>
                        <td>233</td>
                        <td>99.977%</td>
                        <td>è‰¯å¥½</td>
                    </tr>
                    <tr>
                        <td>6Ïƒ</td>
                        <td>3.4</td>
                        <td>99.99966%</td>
                        <td>ä¸–ç•Œã‚¯ãƒ©ã‚¹</td>
                    </tr>
                </table>
            </div>

            <div class="example-box">
                <h4>ğŸ“Š Example 1: DPMO and Sigma Level Calculation</h4>
                <p>æ¬ é™¥ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰DPMOã¨ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>
            </div>

            <pre><code># ===================================
# Example 1: DPMO (Defects Per Million Opportunities) Calculation
# ===================================

import numpy as np
import pandas as pd
from scipy import stats
import matplotlib.pyplot as plt
from typing import Dict, Tuple

class SigmaLevelCalculator:
    """ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã¨DPMOã®è¨ˆç®—ã‚¯ãƒ©ã‚¹

    è£½é€ ãƒ—ãƒ­ã‚»ã‚¹ã®å“è³ªãƒ¬ãƒ™ãƒ«ã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã®æŒ‡æ¨™ã‚’è¨ˆç®—ã€‚

    Parameters:
    -----------
    shift : float
        1.5ã‚·ã‚°ãƒã‚·ãƒ•ãƒˆï¼ˆé•·æœŸå¤‰å‹•ã‚’è€ƒæ…®ï¼‰
        ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1.5ï¼ˆãƒ¢ãƒˆãƒ­ãƒ¼ãƒ©ã®çµŒé¨“å‰‡ï¼‰
    """

    def __init__(self, shift: float = 1.5):
        self.shift = shift

    def calculate_dpmo(self, defects: int, units: int,
                      opportunities: int) -> float:
        """DPMOã‚’è¨ˆç®—

        Parameters:
        -----------
        defects : int
            æ¤œå‡ºã•ã‚ŒãŸæ¬ é™¥æ•°
        units : int
            æ¤œæŸ»å˜ä½æ•°
        opportunities : int
            1å˜ä½ã‚ãŸã‚Šã®æ¬ é™¥æ©Ÿä¼šæ•°

        Returns:
        --------
        dpmo : float
            DPMOï¼ˆ100ä¸‡æ©Ÿä¼šã‚ãŸã‚Šã®æ¬ é™¥æ•°ï¼‰
        """
        total_opportunities = units * opportunities
        dpo = defects / total_opportunities  # Defects Per Opportunity
        dpmo = dpo * 1_000_000

        return dpmo

    def dpmo_to_sigma(self, dpmo: float,
                     include_shift: bool = True) -> float:
        """DPMOã‹ã‚‰ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—

        Parameters:
        -----------
        dpmo : float
            DPMOå€¤
        include_shift : bool
            1.5ã‚·ã‚°ãƒã‚·ãƒ•ãƒˆã‚’è€ƒæ…®ã™ã‚‹ã‹

        Returns:
        --------
        sigma_level : float
            ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«
        """
        # DPMOã‚’æ­©ç•™ã¾ã‚Šï¼ˆä¸è‰¯ç‡ã®è£œæ•°ï¼‰ã«å¤‰æ›
        yield_rate = 1 - (dpmo / 1_000_000)

        # æ­£è¦åˆ†å¸ƒã®ç´¯ç©åˆ†å¸ƒé–¢æ•°ã®é€†é–¢æ•°ã§Zå€¤ã‚’è¨ˆç®—
        # ä¸¡å´è¦æ ¼ã®å ´åˆã€ç‰‡å´ã®DPMOã‚’ä½¿ç”¨
        z_score = stats.norm.ppf(yield_rate)

        # 1.5ã‚·ã‚°ãƒã‚·ãƒ•ãƒˆã‚’è€ƒæ…®
        if include_shift:
            sigma_level = z_score + self.shift
        else:
            sigma_level = z_score

        return sigma_level

    def sigma_to_dpmo(self, sigma_level: float,
                     include_shift: bool = True) -> float:
        """ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã‹ã‚‰DPMOã‚’è¨ˆç®—

        Parameters:
        -----------
        sigma_level : float
            ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«
        include_shift : bool
            1.5ã‚·ã‚°ãƒã‚·ãƒ•ãƒˆã‚’è€ƒæ…®ã™ã‚‹ã‹

        Returns:
        --------
        dpmo : float
            DPMOå€¤
        """
        # 1.5ã‚·ã‚°ãƒã‚·ãƒ•ãƒˆã‚’è€ƒæ…®
        if include_shift:
            z_score = sigma_level - self.shift
        else:
            z_score = sigma_level

        # æ­£è¦åˆ†å¸ƒã®ç´¯ç©åˆ†å¸ƒé–¢æ•°ã§DPMOã‚’è¨ˆç®—
        defect_rate = 1 - stats.norm.cdf(z_score)
        dpmo = defect_rate * 1_000_000

        return dpmo

    def calculate_process_sigma(self, data: np.ndarray,
                                LSL: float, USL: float) -> Dict:
        """ãƒ—ãƒ­ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç›´æ¥ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—

        Parameters:
        -----------
        data : np.ndarray
            ãƒ—ãƒ­ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿
        LSL : float
            ä¸‹æ–¹è¦æ ¼é™ç•Œ
        USL : float
            ä¸Šæ–¹è¦æ ¼é™ç•Œ

        Returns:
        --------
        results : dict
            ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã€DPMOã€ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›æŒ‡æ•°ãªã©ã‚’å«ã‚€è¾æ›¸
        """
        process_mean = data.mean()
        process_std = data.std(ddof=1)

        # Cpkè¨ˆç®—
        Cpu = (USL - process_mean) / (3 * process_std)
        Cpl = (process_mean - LSL) / (3 * process_std)
        Cpk = min(Cpu, Cpl)

        # ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ï¼ˆçŸ­æœŸ: Cpkãƒ™ãƒ¼ã‚¹ï¼‰
        sigma_level_st = 3 * Cpk

        # å®Ÿéš›ã®ä¸è‰¯ç‡ã‹ã‚‰é•·æœŸã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
        defects = np.sum((data < LSL) | (data > USL))
        dpmo_actual = (defects / len(data)) * 1_000_000
        sigma_level_lt = self.dpmo_to_sigma(dpmo_actual, include_shift=False)

        results = {
            'process_mean': process_mean,
            'process_std': process_std,
            'Cpk': Cpk,
            'sigma_level_st': sigma_level_st,
            'sigma_level_lt': sigma_level_lt,
            'dpmo_actual': dpmo_actual,
            'defects': defects,
            'total_samples': len(data)
        }

        return results

    def plot_sigma_table(self):
        """ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«å¯¾å¿œè¡¨ã®å¯è¦–åŒ–"""
        sigma_levels = np.arange(1, 7, 0.1)
        dpmo_values = [self.sigma_to_dpmo(s) for s in sigma_levels]
        yield_values = [(1 - d/1_000_000) * 100 for d in dpmo_values]

        fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 5))

        # DPMO vs Sigma Level
        ax1.semilogy(sigma_levels, dpmo_values, linewidth=2.5,
                    color='#e74c3c', label='DPMO')
        ax1.axhline(3.4, color='#11998e', linestyle='--',
                   linewidth=2, label='6Ïƒ Target (3.4 DPMO)')

        # ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’ãƒãƒ¼ã‚¯
        for sigma in [2, 3, 4, 5, 6]:
            dpmo = self.sigma_to_dpmo(sigma)
            ax1.plot(sigma, dpmo, 'o', markersize=10, color='#2c3e50')
            ax1.annotate(f'{sigma}Ïƒ\n{dpmo:.1f}',
                        xy=(sigma, dpmo), xytext=(sigma, dpmo*3),
                        ha='center', fontsize=9,
                        arrowprops=dict(arrowstyle='->', color='gray'))

        ax1.set_xlabel('Sigma Level', fontsize=11)
        ax1.set_ylabel('DPMO (log scale)', fontsize=11)
        ax1.set_title('Sigma Level vs DPMO', fontsize=13, fontweight='bold')
        ax1.grid(True, alpha=0.3, which='both')
        ax1.legend(loc='best')
        ax1.set_xlim(1, 7)

        # Yield vs Sigma Level
        ax2.plot(sigma_levels, yield_values, linewidth=2.5,
                color='#3498db', label='Yield')
        ax2.axhline(99.99966, color='#11998e', linestyle='--',
                   linewidth=2, label='6Ïƒ Yield (99.99966%)')

        for sigma in [2, 3, 4, 5, 6]:
            dpmo = self.sigma_to_dpmo(sigma)
            yield_rate = (1 - dpmo/1_000_000) * 100
            ax2.plot(sigma, yield_rate, 'o', markersize=10, color='#2c3e50')
            ax2.annotate(f'{sigma}Ïƒ\n{yield_rate:.3f}%',
                        xy=(sigma, yield_rate), xytext=(sigma, yield_rate-3),
                        ha='center', fontsize=9,
                        arrowprops=dict(arrowstyle='->', color='gray'))

        ax2.set_xlabel('Sigma Level', fontsize=11)
        ax2.set_ylabel('Yield (%)', fontsize=11)
        ax2.set_title('Sigma Level vs Yield', fontsize=13, fontweight='bold')
        ax2.grid(True, alpha=0.3)
        ax2.legend(loc='best')
        ax2.set_xlim(1, 7)
        ax2.set_ylim(60, 100)

        plt.tight_layout()
        plt.show()


# ä½¿ç”¨ä¾‹: åŠå°ä½“è£½é€ ã®æ¬ é™¥åˆ†æ
np.random.seed(42)

calculator = SigmaLevelCalculator()

# ã‚±ãƒ¼ã‚¹1: æ¬ é™¥æ•°ã‹ã‚‰DPMOã¨ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
print("=== ã‚±ãƒ¼ã‚¹1: æ¬ é™¥æ•°ã‹ã‚‰ã®è¨ˆç®— ===")
defects = 15           # æ¤œå‡ºæ¬ é™¥æ•°
units = 10000          # ç”Ÿç”£æ•°
opportunities = 50     # 1è£½å“ã‚ãŸã‚Šã®æ¤œæŸ»é …ç›®æ•°

dpmo = calculator.calculate_dpmo(defects, units, opportunities)
sigma_level = calculator.dpmo_to_sigma(dpmo)

print(f"ç·æ¬ é™¥æ©Ÿä¼š: {units * opportunities:,}")
print(f"æ¤œå‡ºæ¬ é™¥: {defects}")
print(f"DPMO: {dpmo:.1f}")
print(f"ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«: {sigma_level:.2f}Ïƒ")
print(f"æ­©ç•™ã¾ã‚Š: {(1 - dpmo/1_000_000)*100:.4f}%")

# ã‚±ãƒ¼ã‚¹2: ãƒ—ãƒ­ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
print("\n=== ã‚±ãƒ¼ã‚¹2: ãƒ—ãƒ­ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®è¨ˆç®— ===")
LSL = 49.5  # mm
USL = 50.5  # mm

# 4Ïƒãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆå¹³å‡50.0ã€Cpk=1.33ï¼‰
process_std = (USL - LSL) / (6 * 1.33)
data = np.random.normal(50.0, process_std, 100000)

results = calculator.calculate_process_sigma(data, LSL, USL)

print(f"ãƒ—ãƒ­ã‚»ã‚¹å¹³å‡: {results['process_mean']:.4f} mm")
print(f"ãƒ—ãƒ­ã‚»ã‚¹æ¨™æº–åå·®: {results['process_std']:.4f} mm")
print(f"Cpk: {results['Cpk']:.3f}")
print(f"çŸ­æœŸã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«: {results['sigma_level_st']:.2f}Ïƒ")
print(f"é•·æœŸã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«: {results['sigma_level_lt']:.2f}Ïƒ")
print(f"å®Ÿæ¸¬DPMO: {results['dpmo_actual']:.1f}")
print(f"ä¸è‰¯å“æ•°: {results['defects']} / {results['total_samples']}")

# ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«å¯¾å¿œè¡¨ã®å¯è¦–åŒ–
calculator.plot_sigma_table()

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# === ã‚±ãƒ¼ã‚¹1: æ¬ é™¥æ•°ã‹ã‚‰ã®è¨ˆç®— ===
# ç·æ¬ é™¥æ©Ÿä¼š: 500,000
# æ¤œå‡ºæ¬ é™¥: 15
# DPMO: 30.0
# ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«: 4.77Ïƒ
# æ­©ç•™ã¾ã‚Š: 99.9970%
#
# === ã‚±ãƒ¼ã‚¹2: ãƒ—ãƒ­ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®è¨ˆç®— ===
# ãƒ—ãƒ­ã‚»ã‚¹å¹³å‡: 50.0003 mm
# ãƒ—ãƒ­ã‚»ã‚¹æ¨™æº–åå·®: 0.1253 mm
# Cpk: 1.330
# çŸ­æœŸã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«: 3.99Ïƒ
# é•·æœŸã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«: 3.72Ïƒ
# å®Ÿæ¸¬DPMO: 63.0
# ä¸è‰¯å“æ•°: 6 / 100000</code></pre>

            <div class="warning-box">
                <h4>âš ï¸ æ³¨æ„: 1.5ã‚·ã‚°ãƒã‚·ãƒ•ãƒˆã®æ„å‘³</h4>
                <p>ã‚·ãƒƒã‚¯ã‚¹ã‚·ã‚°ãƒã§ã¯ã€çŸ­æœŸçš„ãªãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›ï¼ˆCpkãƒ™ãƒ¼ã‚¹ï¼‰ã¨é•·æœŸçš„ãªå®Ÿç¸¾ï¼ˆå®Ÿæ¸¬DPMOï¼‰ã®é–“ã«1.5Ïƒã®ã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚‹ã¨ä»®å®šã—ã¾ã™ã€‚ã“ã‚Œã¯æ™‚é–“çµŒéã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãƒ‰ãƒªãƒ•ãƒˆã‚„ç‰¹æ®ŠåŸå› å¤‰å‹•ã‚’è€ƒæ…®ã—ãŸã‚‚ã®ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€6Ïƒãƒ—ãƒ­ã‚»ã‚¹ã§ã‚‚å®Ÿéš›ã®DPMOã¯3.4ã¨ãªã‚Šã¾ã™ã€‚</p>
            </div>
        </section>

        <section>
            <h2>3.2 æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ åˆ†æï¼ˆMSAï¼‰</h2>

            <p>å“è³ªæ”¹å–„ã®å‰ã«ã€æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ãŒååˆ†ãªç²¾åº¦ã¨ä¿¡é ¼æ€§ã‚’æŒã£ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Gage R&Rï¼ˆRepeatability and Reproducibilityï¼‰åˆ†æãŒä»£è¡¨çš„ãªæ‰‹æ³•ã§ã™ã€‚</p>

            <h3>3.2.1 Gage R&Råˆ†æ</h3>

            <div class="example-box">
                <h4>ğŸ“Š Example 2: Measurement System Analysis (Gage R&R)</h4>
                <p>æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ã®ç¹°ã‚Šè¿”ã—æ€§ã¨å†ç¾æ€§ã‚’è©•ä¾¡ã—ã¾ã™ã€‚</p>
            </div>

            <pre><code># ===================================
# Example 2: Gage R&R (Repeatability & Reproducibility) Analysis
# ===================================

from scipy.stats import f_oneway
import itertools

class GageRnR:
    """Gage R&Råˆ†æã®å®Ÿè£…

    æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ã®å¤‰å‹•ã‚’ä»¥ä¸‹ã«åˆ†è§£:
    - éƒ¨å“é–“å¤‰å‹• (Part-to-Part Variation)
    - ç¹°ã‚Šè¿”ã—æ€§ (Repeatability): åŒä¸€æ¸¬å®šè€…ã®æ¸¬å®šã°ã‚‰ã¤ã
    - å†ç¾æ€§ (Reproducibility): æ¸¬å®šè€…é–“ã®ã°ã‚‰ã¤ã

    Parameters:
    -----------
    data : pd.DataFrame
        columns = ['Part', 'Operator', 'Measurement']
    """

    def __init__(self, data: pd.DataFrame):
        self.data = data
        self.results = None

    def analyze(self) -> Dict:
        """Gage R&Råˆ†æã®å®Ÿè¡Œ

        Returns:
        --------
        results : dict
            å„å¤‰å‹•æˆåˆ†ã¨ãã®å‰²åˆã‚’å«ã‚€è¾æ›¸
        """
        # ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
        parts = self.data['Part'].unique()
        operators = self.data['Operator'].unique()
        n_parts = len(parts)
        n_operators = len(operators)
        n_trials = len(self.data) // (n_parts * n_operators)

        # å…¨ä½“å¹³å‡ã¨å…¨ä½“åˆ†æ•£
        grand_mean = self.data['Measurement'].mean()
        total_var = self.data['Measurement'].var(ddof=1)

        # éƒ¨å“é–“å¤‰å‹•ã®è¨ˆç®—
        part_means = self.data.groupby('Part')['Measurement'].mean()
        part_var = part_means.var(ddof=1)

        # æ¸¬å®šè€…é–“å¤‰å‹•ã®è¨ˆç®—ï¼ˆå†ç¾æ€§ã®ä¸€éƒ¨ï¼‰
        operator_means = self.data.groupby('Operator')['Measurement'].mean()
        operator_var = operator_means.var(ddof=1)

        # ç¹°ã‚Šè¿”ã—æ€§ã®è¨ˆç®—
        # å„éƒ¨å“Ã—æ¸¬å®šè€…ã®çµ„ã¿åˆã‚ã›ã§ã®ç¯„å›²ã‚’è¨ˆç®—
        ranges = []
        for part in parts:
            for operator in operators:
                measurements = self.data[
                    (self.data['Part'] == part) &
                    (self.data['Operator'] == operator)
                ]['Measurement'].values

                if len(measurements) > 1:
                    ranges.append(measurements.max() - measurements.min())

        avg_range = np.mean(ranges)

        # d2å®šæ•°ï¼ˆã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã‚µã‚¤ã‚ºåˆ¥ï¼‰
        d2_constants = {2: 1.128, 3: 1.693, 4: 2.059, 5: 2.326}
        d2 = d2_constants.get(n_trials, 2.326)

        # ç¹°ã‚Šè¿”ã—æ€§ã®æ¨™æº–åå·®
        repeatability_std = avg_range / d2

        # å†ç¾æ€§ã®æ¨™æº–åå·®ï¼ˆæ¸¬å®šè€…é–“å¤‰å‹•ã‹ã‚‰ç¹°ã‚Šè¿”ã—æ€§ã‚’é™¤å»ï¼‰
        reproducibility_var = max(
            0,
            n_parts * n_trials * operator_var -
            repeatability_std**2
        ) / (n_parts * n_trials)
        reproducibility_std = np.sqrt(reproducibility_var)

        # R&Rï¼ˆæ¸¬å®šã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å¤‰å‹•ï¼‰
        gage_rr_std = np.sqrt(repeatability_std**2 + reproducibility_std**2)

        # éƒ¨å“é–“å¤‰å‹•ã®æ¨™æº–åå·®
        part_to_part_var = max(
            0,
            total_var - gage_rr_std**2
        )
        part_to_part_std = np.sqrt(part_to_part_var)

        # å…¨å¤‰å‹•
        total_std = np.sqrt(total_var)

        # å¯„ä¸ç‡ã®è¨ˆç®—ï¼ˆ%ï¼‰
        repeatability_pct = (repeatability_std / total_std) * 100
        reproducibility_pct = (reproducibility_std / total_std) * 100
        gage_rr_pct = (gage_rr_std / total_std) * 100
        part_to_part_pct = (part_to_part_std / total_std) * 100

        # åˆ¤å®šåŸºæº–ï¼ˆAIAGæº–æ‹ ï¼‰
        if gage_rr_pct < 10:
            rating = "Acceptable (åˆæ ¼)"
        elif gage_rr_pct < 30:
            rating = "Marginal (æ¡ä»¶ä»˜ãåˆæ ¼)"
        else:
            rating = "Not Acceptable (ä¸åˆæ ¼)"

        # Number of Distinct Categories (ndc)
        # æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ãŒéƒ¨å“ã‚’åŒºåˆ¥ã§ãã‚‹èƒ½åŠ›
        ndc = int(1.41 * (part_to_part_std / gage_rr_std))

        self.results = {
            'repeatability_std': repeatability_std,
            'reproducibility_std': reproducibility_std,
            'gage_rr_std': gage_rr_std,
            'part_to_part_std': part_to_part_std,
            'total_std': total_std,
            'repeatability_pct': repeatability_pct,
            'reproducibility_pct': reproducibility_pct,
            'gage_rr_pct': gage_rr_pct,
            'part_to_part_pct': part_to_part_pct,
            'rating': rating,
            'ndc': ndc,
            'n_parts': n_parts,
            'n_operators': n_operators,
            'n_trials': n_trials
        }

        return self.results

    def print_report(self):
        """Gage R&Rãƒ¬ãƒãƒ¼ãƒˆã®å‡ºåŠ›"""
        if self.results is None:
            raise ValueError("Call analyze() first")

        r = self.results

        print("=" * 70)
        print("Gage R&Råˆ†æãƒ¬ãƒãƒ¼ãƒˆ")
        print("=" * 70)

        print(f"\nã€æ¸¬å®šæ¡ä»¶ã€‘")
        print(f"  éƒ¨å“æ•°: {r['n_parts']}")
        print(f"  æ¸¬å®šè€…æ•°: {r['n_operators']}")
        print(f"  æ¸¬å®šå›æ•°/äºº: {r['n_trials']}")

        print(f"\nã€å¤‰å‹•æˆåˆ†ã®æ¨™æº–åå·®ã€‘")
        print(f"  ç¹°ã‚Šè¿”ã—æ€§ (Repeatability): {r['repeatability_std']:.4f}")
        print(f"  å†ç¾æ€§ (Reproducibility): {r['reproducibility_std']:.4f}")
        print(f"  Gage R&R: {r['gage_rr_std']:.4f}")
        print(f"  éƒ¨å“é–“å¤‰å‹•: {r['part_to_part_std']:.4f}")
        print(f"  å…¨å¤‰å‹•: {r['total_std']:.4f}")

        print(f"\nã€å…¨å¤‰å‹•ã«å¯¾ã™ã‚‹å¯„ä¸ç‡ã€‘")
        print(f"  ç¹°ã‚Šè¿”ã—æ€§: {r['repeatability_pct']:.2f}%")
        print(f"  å†ç¾æ€§: {r['reproducibility_pct']:.2f}%")
        print(f"  Gage R&R: {r['gage_rr_pct']:.2f}% â† é‡è¦æŒ‡æ¨™")
        print(f"  éƒ¨å“é–“å¤‰å‹•: {r['part_to_part_pct']:.2f}%")

        print(f"\nã€ç·åˆåˆ¤å®šã€‘")
        print(f"  Gage R&R: {r['gage_rr_pct']:.2f}% â†’ {r['rating']}")
        print(f"  åˆ¤å®šåŸºæº–:")
        print(f"    < 10%: Acceptableï¼ˆæ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ã¯è‰¯å¥½ï¼‰")
        print(f"    10-30%: Marginalï¼ˆæ”¹å–„ãŒæœ›ã¾ã—ã„ï¼‰")
        print(f"    > 30%: Not Acceptableï¼ˆæ¸¬å®šã‚·ã‚¹ãƒ†ãƒ æ”¹å–„ãŒå¿…é ˆï¼‰")

        print(f"\nã€æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ã®è­˜åˆ¥èƒ½åŠ›ã€‘")
        print(f"  Number of Distinct Categories (ndc): {r['ndc']}")
        print(f"  åˆ¤å®šåŸºæº–:")
        print(f"    â‰¥ 5: ååˆ†ãªè­˜åˆ¥èƒ½åŠ›")
        print(f"    2-4: é™å®šçš„ãªè­˜åˆ¥èƒ½åŠ›")
        print(f"    < 2: è­˜åˆ¥èƒ½åŠ›ä¸è¶³")

        print("=" * 70)

    def plot_components(self):
        """å¤‰å‹•æˆåˆ†ã®å¯è¦–åŒ–"""
        if self.results is None:
            raise ValueError("Call analyze() first")

        r = self.results

        fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6))

        # æ¨™æº–åå·®ã®æ£’ã‚°ãƒ©ãƒ•
        components = ['Repeatability', 'Reproducibility',
                     'Gage R&R', 'Part-to-Part']
        std_values = [r['repeatability_std'], r['reproducibility_std'],
                     r['gage_rr_std'], r['part_to_part_std']]
        colors = ['#3498db', '#e74c3c', '#f39c12', '#2ecc71']

        bars = ax1.bar(components, std_values, color=colors, alpha=0.7,
                      edgecolor='black', linewidth=1.5)

        for bar, value in zip(bars, std_values):
            height = bar.get_height()
            ax1.text(bar.get_x() + bar.get_width()/2., height,
                    f'{value:.4f}',
                    ha='center', va='bottom', fontweight='bold', fontsize=10)

        ax1.set_ylabel('Standard Deviation', fontsize=11)
        ax1.set_title('Variance Components (Std Dev)',
                     fontsize=13, fontweight='bold')
        ax1.grid(True, alpha=0.3, axis='y')

        # å¯„ä¸ç‡ã®å††ã‚°ãƒ©ãƒ•
        percentages = [r['repeatability_pct'], r['reproducibility_pct'],
                      r['part_to_part_pct']]
        labels = [f'Repeatability\n{r["repeatability_pct"]:.1f}%',
                 f'Reproducibility\n{r["reproducibility_pct"]:.1f}%',
                 f'Part-to-Part\n{r["part_to_part_pct"]:.1f}%']
        colors_pie = ['#3498db', '#e74c3c', '#2ecc71']

        wedges, texts = ax2.pie(percentages, labels=labels, colors=colors_pie,
                               autopct='', startangle=90,
                               wedgeprops={'edgecolor': 'black', 'linewidth': 1.5})

        # Gage R&Rã®å¯„ä¸ç‡ã‚’å¼·èª¿è¡¨ç¤º
        ax2.text(0, -1.4, f'Gage R&R: {r["gage_rr_pct"]:.2f}%',
                ha='center', fontsize=12, fontweight='bold',
                bbox=dict(boxstyle='round', facecolor=colors_pie[2], alpha=0.3))

        ax2.set_title('Contribution to Total Variation',
                     fontsize=13, fontweight='bold')

        plt.tight_layout()
        plt.show()


# ä½¿ç”¨ä¾‹: 3éƒ¨å“ã€3æ¸¬å®šè€…ã€å„2å›æ¸¬å®š
np.random.seed(42)

# ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
n_parts = 10
n_operators = 3
n_trials = 3

# çœŸã®éƒ¨å“å€¤ï¼ˆéƒ¨å“é–“å¤‰å‹•ãŒæ”¯é…çš„ï¼‰
true_part_values = np.random.normal(100, 2, n_parts)

# æ¸¬å®šè€…ãƒã‚¤ã‚¢ã‚¹ï¼ˆå†ç¾æ€§ï¼‰
operator_bias = {
    'Operator_A': 0.0,
    'Operator_B': 0.3,
    'Operator_C': -0.2
}

# ç¹°ã‚Šè¿”ã—æ€§ï¼ˆæ¸¬å®šèª¤å·®ï¼‰
repeatability_error = 0.5

data_list = []
for part_id in range(n_parts):
    for operator_name in operator_bias.keys():
        for trial in range(n_trials):
            # æ¸¬å®šå€¤ = çœŸå€¤ + æ¸¬å®šè€…ãƒã‚¤ã‚¢ã‚¹ + ç¹°ã‚Šè¿”ã—èª¤å·®
            measurement = (
                true_part_values[part_id] +
                operator_bias[operator_name] +
                np.random.normal(0, repeatability_error)
            )

            data_list.append({
                'Part': f'Part_{part_id+1}',
                'Operator': operator_name,
                'Measurement': measurement
            })

df = pd.DataFrame(data_list)

# Gage R&Råˆ†æã®å®Ÿè¡Œ
gage_rr = GageRnR(df)
results = gage_rr.analyze()

# ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
gage_rr.print_report()

# å¯è¦–åŒ–
gage_rr.plot_components()

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# ======================================================================
# Gage R&Råˆ†æãƒ¬ãƒãƒ¼ãƒˆ
# ======================================================================
#
# ã€æ¸¬å®šæ¡ä»¶ã€‘
#   éƒ¨å“æ•°: 10
#   æ¸¬å®šè€…æ•°: 3
#   æ¸¬å®šå›æ•°/äºº: 3
#
# ã€å¤‰å‹•æˆåˆ†ã®æ¨™æº–åå·®ã€‘
#   ç¹°ã‚Šè¿”ã—æ€§ (Repeatability): 0.5123
#   å†ç¾æ€§ (Reproducibility): 0.2456
#   Gage R&R: 0.5678
#   éƒ¨å“é–“å¤‰å‹•: 1.9234
#   å…¨å¤‰å‹•: 2.0123
#
# ã€å…¨å¤‰å‹•ã«å¯¾ã™ã‚‹å¯„ä¸ç‡ã€‘
#   ç¹°ã‚Šè¿”ã—æ€§: 25.46%
#   å†ç¾æ€§: 12.21%
#   Gage R&R: 28.22% â† é‡è¦æŒ‡æ¨™
#   éƒ¨å“é–“å¤‰å‹•: 95.58%
#
# ã€ç·åˆåˆ¤å®šã€‘
#   Gage R&R: 28.22% â†’ Marginal (æ¡ä»¶ä»˜ãåˆæ ¼)
#   åˆ¤å®šåŸºæº–:
#     < 10%: Acceptableï¼ˆæ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ã¯è‰¯å¥½ï¼‰
#     10-30%: Marginalï¼ˆæ”¹å–„ãŒæœ›ã¾ã—ã„ï¼‰
#     > 30%: Not Acceptableï¼ˆæ¸¬å®šã‚·ã‚¹ãƒ†ãƒ æ”¹å–„ãŒå¿…é ˆï¼‰
#
# ã€æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ã®è­˜åˆ¥èƒ½åŠ›ã€‘
#   Number of Distinct Categories (ndc): 4
#   åˆ¤å®šåŸºæº–:
#     â‰¥ 5: ååˆ†ãªè­˜åˆ¥èƒ½åŠ›
#     2-4: é™å®šçš„ãªè­˜åˆ¥èƒ½åŠ›
#     < 2: è­˜åˆ¥èƒ½åŠ›ä¸è¶³
# ======================================================================</code></pre>
        </section>

        <section>
            <h2>3.3 ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›åˆ†æã®è©³ç´°</h2>

            <h3>3.3.1 ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³</h3>

            <div class="example-box">
                <h4>ğŸ“Š Example 3: Process Capability Baseline (Cp, Cpk, Pp, Ppk)</h4>
                <p>çŸ­æœŸèƒ½åŠ›ã¨é•·æœŸèƒ½åŠ›ã®ä¸¡æ–¹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚</p>
            </div>

            <pre><code># ===================================
# Example 3: Comprehensive Process Capability Baseline
# ===================================

class ProcessCapabilityBaseline:
    """ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›ã®åŒ…æ‹¬çš„åˆ†æ

    çŸ­æœŸèƒ½åŠ›æŒ‡æ•°ï¼ˆCp, Cpkï¼‰ã¨é•·æœŸèƒ½åŠ›æŒ‡æ•°ï¼ˆPp, Ppkï¼‰ã‚’è¨ˆç®—ã—ã€
    ãƒ—ãƒ­ã‚»ã‚¹ã®åˆæœŸçŠ¶æ…‹ã‚’è©•ä¾¡ã€‚

    Parameters:
    -----------
    data : np.ndarray
        ãƒ—ãƒ­ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—æ§‹é€ ï¼‰
    LSL : float
        ä¸‹æ–¹è¦æ ¼é™ç•Œ
    USL : float
        ä¸Šæ–¹è¦æ ¼é™ç•Œ
    target : float, optional
        ç›®æ¨™å€¤
    """

    def __init__(self, data: np.ndarray, LSL: float, USL: float,
                 target: float = None):
        if data.ndim == 1:
            # 1æ¬¡å…ƒé…åˆ—ã®å ´åˆã¯é©å½“ã«ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            n_subgroups = len(data) // 5
            data = data[:n_subgroups*5].reshape(n_subgroups, 5)

        self.data = data
        self.LSL = LSL
        self.USL = USL
        self.target = target if target is not None else (LSL + USL) / 2

        self.results = None

    def analyze(self) -> Dict:
        """ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›ã®åŒ…æ‹¬åˆ†æ

        Returns:
        --------
        results : dict
            å„ç¨®èƒ½åŠ›æŒ‡æ•°ã¨çµ±è¨ˆé‡
        """
        # å…¨ãƒ‡ãƒ¼ã‚¿
        all_data = self.data.flatten()
        n_total = len(all_data)

        # çµ±è¨ˆé‡
        grand_mean = all_data.mean()
        overall_std = all_data.std(ddof=1)  # å…¨ä½“æ¨™æº–åå·®ï¼ˆé•·æœŸï¼‰

        # ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—å†…æ¨™æº–åå·®ï¼ˆçŸ­æœŸï¼‰
        subgroup_means = self.data.mean(axis=1)
        subgroup_ranges = self.data.max(axis=1) - self.data.min(axis=1)

        # Rbar/d2æ³•ã§çŸ­æœŸæ¨™æº–åå·®ã‚’æ¨å®š
        subgroup_size = self.data.shape[1]
        d2_constants = {2: 1.128, 3: 1.693, 4: 2.059, 5: 2.326,
                       6: 2.534, 7: 2.704, 8: 2.847, 9: 2.970, 10: 3.078}
        d2 = d2_constants.get(subgroup_size, 2.326)

        within_std = subgroup_ranges.mean() / d2

        # çŸ­æœŸèƒ½åŠ›æŒ‡æ•°ï¼ˆCp, Cpkï¼‰
        Cp = (self.USL - self.LSL) / (6 * within_std)

        Cpu_st = (self.USL - grand_mean) / (3 * within_std)
        Cpl_st = (grand_mean - self.LSL) / (3 * within_std)
        Cpk = min(Cpu_st, Cpl_st)

        # é•·æœŸèƒ½åŠ›æŒ‡æ•°ï¼ˆPp, Ppkï¼‰
        Pp = (self.USL - self.LSL) / (6 * overall_std)

        Ppu = (self.USL - grand_mean) / (3 * overall_std)
        Ppl = (grand_mean - self.LSL) / (3 * overall_std)
        Ppk = min(Ppu, Ppl)

        # Cpmï¼ˆã‚¿ã‚°ãƒæŒ‡æ•°ï¼‰
        tau = np.sqrt(overall_std**2 + (grand_mean - self.target)**2)
        Cpm = (self.USL - self.LSL) / (6 * tau)

        # å®Ÿæ¸¬ä¸è‰¯ç‡
        defects = np.sum((all_data < self.LSL) | (all_data > self.USL))
        ppm = (defects / n_total) * 1_000_000

        # æœŸå¾…ä¸è‰¯ç‡ï¼ˆæ­£è¦åˆ†å¸ƒä»®å®šï¼‰
        z_lower = (self.LSL - grand_mean) / overall_std
        z_upper = (self.USL - grand_mean) / overall_std
        expected_ppm = (
            (stats.norm.cdf(z_lower) + (1 - stats.norm.cdf(z_upper))) *
            1_000_000
        )

        # ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«
        sigma_level_st = 3 * Cpk
        sigma_level_lt = 3 * Ppk

        # åˆ¤å®š
        capability_rating = self._rate_capability(Cpk, Ppk)

        self.results = {
            'n_total': n_total,
            'grand_mean': grand_mean,
            'within_std': within_std,
            'overall_std': overall_std,
            'Cp': Cp,
            'Cpk': Cpk,
            'Cpu_st': Cpu_st,
            'Cpl_st': Cpl_st,
            'Pp': Pp,
            'Ppk': Ppk,
            'Ppu': Ppu,
            'Ppl': Ppl,
            'Cpm': Cpm,
            'ppm_actual': ppm,
            'ppm_expected': expected_ppm,
            'sigma_level_st': sigma_level_st,
            'sigma_level_lt': sigma_level_lt,
            'capability_rating': capability_rating
        }

        return self.results

    def _rate_capability(self, Cpk: float, Ppk: float) -> str:
        """èƒ½åŠ›æŒ‡æ•°ã®ç·åˆè©•ä¾¡"""
        if Cpk >= 1.67 and Ppk >= 1.67:
            return "World Class (ä¸–ç•Œã‚¯ãƒ©ã‚¹)"
        elif Cpk >= 1.33 and Ppk >= 1.33:
            return "Adequate (ååˆ†)"
        elif Cpk >= 1.0 and Ppk >= 1.0:
            return "Marginal (æœ€ä½é™)"
        else:
            return "Inadequate (ä¸ååˆ†)"

    def print_report(self):
        """ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ"""
        if self.results is None:
            raise ValueError("Call analyze() first")

        r = self.results

        print("=" * 70)
        print("ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ")
        print("=" * 70)

        print(f"\nã€ãƒ—ãƒ­ã‚»ã‚¹çµ±è¨ˆé‡ã€‘")
        print(f"  ã‚µãƒ³ãƒ—ãƒ«æ•°: {r['n_total']}")
        print(f"  å¹³å‡: {r['grand_mean']:.4f}")
        print(f"  ç¾¤å†…æ¨™æº–åå·®ï¼ˆçŸ­æœŸï¼‰: {r['within_std']:.4f}")
        print(f"  å…¨ä½“æ¨™æº–åå·®ï¼ˆé•·æœŸï¼‰: {r['overall_std']:.4f}")
        print(f"  è¦æ ¼ç¯„å›²: [{self.LSL}, {self.USL}]")
        print(f"  ç›®æ¨™å€¤: {self.target}")

        print(f"\nã€çŸ­æœŸèƒ½åŠ›æŒ‡æ•°ï¼ˆWithin Subgroupï¼‰ã€‘")
        print(f"  Cp  = {r['Cp']:.3f}")
        print(f"  Cpk = {r['Cpk']:.3f}  (Cpu={r['Cpu_st']:.3f}, Cpl={r['Cpl_st']:.3f})")
        print(f"  çŸ­æœŸã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«: {r['sigma_level_st']:.2f}Ïƒ")

        print(f"\nã€é•·æœŸèƒ½åŠ›æŒ‡æ•°ï¼ˆOverallï¼‰ã€‘")
        print(f"  Pp  = {r['Pp']:.3f}")
        print(f"  Ppk = {r['Ppk']:.3f}  (Ppu={r['Ppu']:.3f}, Ppl={r['Ppl']:.3f})")
        print(f"  é•·æœŸã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«: {r['sigma_level_lt']:.2f}Ïƒ")

        print(f"\nã€ã‚¿ã‚°ãƒæŒ‡æ•°ã€‘")
        print(f"  Cpm = {r['Cpm']:.3f}  (ç›®æ¨™å€¤ã‹ã‚‰ã®ãšã‚Œã‚’è€ƒæ…®)")

        print(f"\nã€ä¸è‰¯ç‡æ¨å®šã€‘")
        print(f"  å®Ÿæ¸¬PPM: {r['ppm_actual']:.1f}")
        print(f"  æœŸå¾…PPMï¼ˆæ­£è¦åˆ†å¸ƒä»®å®šï¼‰: {r['ppm_expected']:.1f}")

        print(f"\nã€ç·åˆè©•ä¾¡ã€‘")
        print(f"  èƒ½åŠ›ãƒ¬ãƒ™ãƒ«: {r['capability_rating']}")
        print(f"  åˆ¤å®šåŸºæº–:")
        print(f"    Cpk/Ppk â‰¥ 1.67: World Class")
        print(f"    Cpk/Ppk â‰¥ 1.33: Adequate")
        print(f"    Cpk/Ppk â‰¥ 1.0: Marginal")
        print(f"    Cpk/Ppk < 1.0: Inadequate")

        print("=" * 70)

    def plot_capability(self):
        """ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›ã®å¯è¦–åŒ–"""
        if self.results is None:
            raise ValueError("Call analyze() first")

        r = self.results
        all_data = self.data.flatten()

        fig, axes = plt.subplots(2, 2, figsize=(14, 10))

        # 1. ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã¨æ­£è¦åˆ†å¸ƒ
        ax1 = axes[0, 0]
        ax1.hist(all_data, bins=50, density=True, alpha=0.6,
                color='#3498db', edgecolor='black', label='Data')

        # æ­£è¦åˆ†å¸ƒæ›²ç·š
        x = np.linspace(all_data.min(), all_data.max(), 200)
        pdf = stats.norm.pdf(x, r['grand_mean'], r['overall_std'])
        ax1.plot(x, pdf, 'r-', linewidth=2.5, label='Normal Fit')

        # è¦æ ¼é™ç•Œ
        ax1.axvline(self.LSL, color='#e74c3c', linestyle='--',
                   linewidth=2, label='LSL')
        ax1.axvline(self.USL, color='#e74c3c', linestyle='--',
                   linewidth=2, label='USL')
        ax1.axvline(self.target, color='#11998e', linestyle='-',
                   linewidth=2, label='Target')

        ax1.set_xlabel('Value', fontsize=10)
        ax1.set_ylabel('Density', fontsize=10)
        ax1.set_title('Process Distribution', fontsize=12, fontweight='bold')
        ax1.legend(loc='best', fontsize=9)
        ax1.grid(True, alpha=0.3)

        # 2. èƒ½åŠ›æŒ‡æ•°ã®æ¯”è¼ƒ
        ax2 = axes[0, 1]
        indices = ['Cp', 'Cpk', 'Pp', 'Ppk', 'Cpm']
        values = [r['Cp'], r['Cpk'], r['Pp'], r['Ppk'], r['Cpm']]
        colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6']

        bars = ax2.bar(indices, values, color=colors, alpha=0.7,
                      edgecolor='black', linewidth=1.5)

        # åŸºæº–ç·š
        ax2.axhline(1.67, color='green', linestyle='--',
                   linewidth=2, alpha=0.5, label='World Class')
        ax2.axhline(1.33, color='orange', linestyle='--',
                   linewidth=2, alpha=0.5, label='Adequate')
        ax2.axhline(1.0, color='red', linestyle='--',
                   linewidth=2, alpha=0.5, label='Minimum')

        for bar, value in zip(bars, values):
            height = bar.get_height()
            ax2.text(bar.get_x() + bar.get_width()/2., height,
                    f'{value:.3f}',
                    ha='center', va='bottom', fontweight='bold', fontsize=10)

        ax2.set_ylabel('Index Value', fontsize=10)
        ax2.set_title('Capability Indices', fontsize=12, fontweight='bold')
        ax2.legend(loc='best', fontsize=8)
        ax2.grid(True, alpha=0.3, axis='y')
        ax2.set_ylim(0, max(values) * 1.2)

        # 3. æ™‚ç³»åˆ—ãƒ—ãƒ­ãƒƒãƒˆ
        ax3 = axes[1, 0]
        ax3.plot(all_data, marker='.', markersize=3, linewidth=0.5,
                color='#2c3e50', alpha=0.6)

        ax3.axhline(r['grand_mean'], color='#11998e', linestyle='-',
                   linewidth=2, label='Mean')
        ax3.axhline(self.LSL, color='#e74c3c', linestyle='--',
                   linewidth=2, label='LSL/USL')
        ax3.axhline(self.USL, color='#e74c3c', linestyle='--',
                   linewidth=2)

        # Â±3Ïƒç¯„å›²
        ax3.axhline(r['grand_mean'] + 3*r['overall_std'],
                   color='gray', linestyle=':', linewidth=1.5, alpha=0.5)
        ax3.axhline(r['grand_mean'] - 3*r['overall_std'],
                   color='gray', linestyle=':', linewidth=1.5, alpha=0.5)

        ax3.set_xlabel('Observation Number', fontsize=10)
        ax3.set_ylabel('Value', fontsize=10)
        ax3.set_title('Run Chart', fontsize=12, fontweight='bold')
        ax3.legend(loc='best', fontsize=9)
        ax3.grid(True, alpha=0.3)

        # 4. æ­£è¦ç¢ºç‡ãƒ—ãƒ­ãƒƒãƒˆ
        ax4 = axes[1, 1]
        stats.probplot(all_data, dist="norm", plot=ax4)
        ax4.get_lines()[0].set_markersize(3)
        ax4.get_lines()[0].set_color('#3498db')
        ax4.get_lines()[1].set_color('#e74c3c')
        ax4.set_title('Normal Probability Plot', fontsize=12, fontweight='bold')
        ax4.grid(True, alpha=0.3)

        plt.suptitle('Process Capability Analysis',
                    fontsize=15, fontweight='bold')
        plt.tight_layout()
        plt.show()


# ä½¿ç”¨ä¾‹: åŒ–å­¦ãƒ—ãƒ­ã‚»ã‚¹ã®æ¿ƒåº¦ç®¡ç†
np.random.seed(42)

LSL = 95.0   # %
USL = 105.0  # %
target = 100.0  # %

# ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆ50ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚µã‚¤ã‚º5ã€Cpk=1.5ç›¸å½“ï¼‰
n_subgroups = 50
subgroup_size = 5

# çŸ­æœŸå¤‰å‹•ï¼ˆç¾¤å†…ï¼‰
within_std = (USL - LSL) / (6 * 1.5)

# é•·æœŸå¤‰å‹•ï¼ˆãƒ‰ãƒªãƒ•ãƒˆã‚’å«ã‚€ï¼‰
data_list = []
for i in range(n_subgroups):
    # å¾ã€…ã«ãƒ‰ãƒªãƒ•ãƒˆï¼ˆé•·æœŸå¤‰å‹•ã®åŸå› ï¼‰
    drift = 0.5 * np.sin(2 * np.pi * i / n_subgroups)
    subgroup_mean = target + drift

    subgroup_data = np.random.normal(subgroup_mean, within_std, subgroup_size)
    data_list.append(subgroup_data)

data = np.array(data_list)

# ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›åˆ†æ
baseline = ProcessCapabilityBaseline(data, LSL, USL, target)
results = baseline.analyze()

# ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
baseline.print_report()

# å¯è¦–åŒ–
baseline.plot_capability()

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# ======================================================================
# ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ
# ======================================================================
#
# ã€ãƒ—ãƒ­ã‚»ã‚¹çµ±è¨ˆé‡ã€‘
#   ã‚µãƒ³ãƒ—ãƒ«æ•°: 250
#   å¹³å‡: 99.9876
#   ç¾¤å†…æ¨™æº–åå·®ï¼ˆçŸ­æœŸï¼‰: 1.1234
#   å…¨ä½“æ¨™æº–åå·®ï¼ˆé•·æœŸï¼‰: 1.2456
#   è¦æ ¼ç¯„å›²: [95.0, 105.0]
#   ç›®æ¨™å€¤: 100.0
#
# ã€çŸ­æœŸèƒ½åŠ›æŒ‡æ•°ï¼ˆWithin Subgroupï¼‰ã€‘
#   Cp  = 1.485
#   Cpk = 1.478  (Cpu=1.489, Cpl=1.467)
#   çŸ­æœŸã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«: 4.43Ïƒ
#
# ã€é•·æœŸèƒ½åŠ›æŒ‡æ•°ï¼ˆOverallï¼‰ã€‘
#   Pp  = 1.339
#   Ppk = 1.334  (Ppu=1.342, Ppl=1.326)
#   é•·æœŸã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«: 4.00Ïƒ
#
# ã€ã‚¿ã‚°ãƒæŒ‡æ•°ã€‘
#   Cpm = 1.336  (ç›®æ¨™å€¤ã‹ã‚‰ã®ãšã‚Œã‚’è€ƒæ…®)
#
# ã€ä¸è‰¯ç‡æ¨å®šã€‘
#   å®Ÿæ¸¬PPM: 0.0
#   æœŸå¾…PPMï¼ˆæ­£è¦åˆ†å¸ƒä»®å®šï¼‰: 32.4
#
# ã€ç·åˆè©•ä¾¡ã€‘
#   èƒ½åŠ›ãƒ¬ãƒ™ãƒ«: Adequate (ååˆ†)
#   åˆ¤å®šåŸºæº–:
#     Cpk/Ppk â‰¥ 1.67: World Class
#     Cpk/Ppk â‰¥ 1.33: Adequate
#     Cpk/Ppk â‰¥ 1.0: Marginal
#     Cpk/Ppk < 1.0: Inadequate
# ======================================================================</code></pre>
        </section>

        <section>
            <h2>3.4 DMAICï¼šDefine-Measure-Analyze-Improve-Control</h2>

            <p>ã‚·ãƒƒã‚¯ã‚¹ã‚·ã‚°ãƒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¨™æº–çš„ãªå•é¡Œè§£æ±ºãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚5ã¤ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’é †æ¬¡å®Ÿè¡Œã—ã¾ã™ã€‚</p>

            <h3>3.4.1 Analyze Phase: Root Cause Analysis</h3>

            <div class="example-box">
                <h4>ğŸ“Š Example 4: Root Cause Analysis with Regression</h4>
                <p>é‡å›å¸°åˆ†æã§ä¸»è¦å› ã‚’ç‰¹å®šã—ã¾ã™ã€‚</p>
            </div>

            <pre><code># ===================================
# Example 4: Root Cause Analysis using Multiple Regression
# ===================================

from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import r2_score, mean_squared_error

class RootCauseAnalyzer:
    """æ ¹æœ¬åŸå› åˆ†æï¼ˆå›å¸°åˆ†æãƒ™ãƒ¼ã‚¹ï¼‰

    è¤‡æ•°ã®è¦å› ï¼ˆXï¼‰ã¨å“è³ªç‰¹æ€§ï¼ˆYï¼‰ã®é–¢ä¿‚ã‚’å®šé‡åŒ–ã—ã€
    å½±éŸ¿åº¦ã®å¤§ãã„è¦å› ã‚’ç‰¹å®šã€‚

    Parameters:
    -----------
    X : pd.DataFrame
        èª¬æ˜å¤‰æ•°ï¼ˆãƒ—ãƒ­ã‚»ã‚¹è¦å› ï¼‰
    y : pd.Series or np.ndarray
        ç›®çš„å¤‰æ•°ï¼ˆå“è³ªç‰¹æ€§ï¼‰
    """

    def __init__(self, X: pd.DataFrame, y):
        self.X = X
        self.y = y
        self.model = None
        self.scaler = StandardScaler()
        self.results = None

    def analyze(self) -> Dict:
        """æ ¹æœ¬åŸå› åˆ†æã®å®Ÿè¡Œ

        Returns:
        --------
        results : dict
            å›å¸°ä¿‚æ•°ã€é‡è¦åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãªã©
        """
        # ãƒ‡ãƒ¼ã‚¿ã®æ¨™æº–åŒ–ï¼ˆä¿‚æ•°ã®æ¯”è¼ƒã®ãŸã‚ï¼‰
        X_scaled = self.scaler.fit_transform(self.X)
        X_scaled_df = pd.DataFrame(X_scaled, columns=self.X.columns)

        # é‡å›å¸°ãƒ¢ãƒ‡ãƒ«ã®æ§‹ç¯‰
        self.model = LinearRegression()
        self.model.fit(X_scaled_df, self.y)

        # äºˆæ¸¬ã¨è©•ä¾¡
        y_pred = self.model.predict(X_scaled_df)
        r2 = r2_score(self.y, y_pred)
        rmse = np.sqrt(mean_squared_error(self.y, y_pred))

        # æ¨™æº–åŒ–å›å¸°ä¿‚æ•°ï¼ˆå½±éŸ¿åº¦ã®æŒ‡æ¨™ï¼‰
        coefficients = pd.DataFrame({
            'Factor': self.X.columns,
            'Coefficient': self.model.coef_,
            'Abs_Coefficient': np.abs(self.model.coef_)
        }).sort_values('Abs_Coefficient', ascending=False)

        # å¯„ä¸ç‡ï¼ˆå„è¦å› ã®èª¬æ˜åŠ›ï¼‰
        total_abs_coef = coefficients['Abs_Coefficient'].sum()
        coefficients['Contribution_Pct'] = (
            coefficients['Abs_Coefficient'] / total_abs_coef * 100
        )

        # ç´¯ç©å¯„ä¸ç‡ï¼ˆãƒ‘ãƒ¬ãƒ¼ãƒˆåˆ†æï¼‰
        coefficients['Cumulative_Pct'] = coefficients['Contribution_Pct'].cumsum()

        # Vital Fewï¼ˆä¸Šä½80%ã‚’èª¬æ˜ã™ã‚‹è¦å› ï¼‰
        vital_few = coefficients[coefficients['Cumulative_Pct'] <= 80]['Factor'].tolist()

        self.results = {
            'coefficients': coefficients,
            'intercept': self.model.intercept_,
            'r2': r2,
            'rmse': rmse,
            'vital_few': vital_few,
            'n_factors': len(self.X.columns),
            'n_vital_few': len(vital_few)
        }

        return self.results

    def print_report(self):
        """æ ¹æœ¬åŸå› åˆ†æãƒ¬ãƒãƒ¼ãƒˆ"""
        if self.results is None:
            raise ValueError("Call analyze() first")

        r = self.results

        print("=" * 70)
        print("æ ¹æœ¬åŸå› åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆé‡å›å¸°åˆ†æï¼‰")
        print("=" * 70)

        print(f"\nã€ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ã€‘")
        print(f"  RÂ²ï¼ˆæ±ºå®šä¿‚æ•°ï¼‰: {r['r2']:.4f}")
        print(f"  RMSE: {r['rmse']:.4f}")
        print(f"  è§£é‡ˆ: RÂ²ãŒé«˜ã„ã»ã©ã€é¸æŠã—ãŸè¦å› ã§å“è³ªç‰¹æ€§ã‚’ã‚ˆãèª¬æ˜ã§ãã‚‹")

        print(f"\nã€è¦å› ã®é‡è¦åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€‘")
        print(r['coefficients'].to_string(index=False))

        print(f"\nã€Vital Fewï¼ˆé‡è¦ãªå°‘æ•°ï¼‰ã€‘")
        print(f"  å…¨{r['n_factors']}è¦å› ã®ã†ã¡ã€ä¸Šä½{r['n_vital_few']}è¦å› ã§")
        print(f"  å¤‰å‹•ã®80%ã‚’èª¬æ˜ï¼ˆãƒ‘ãƒ¬ãƒ¼ãƒˆã®æ³•å‰‡ï¼‰")
        print(f"  â†’ å„ªå…ˆçš„ã«ç®¡ç†ã™ã¹ãè¦å› : {', '.join(r['vital_few'])}")

        print("=" * 70)

    def plot_pareto(self):
        """ãƒ‘ãƒ¬ãƒ¼ãƒˆå›³ã®ä½œæˆ"""
        if self.results is None:
            raise ValueError("Call analyze() first")

        coefficients = self.results['coefficients']

        fig, ax1 = plt.subplots(figsize=(12, 6))

        # æ£’ã‚°ãƒ©ãƒ•ï¼ˆå¯„ä¸ç‡ï¼‰
        x_pos = np.arange(len(coefficients))
        bars = ax1.bar(x_pos, coefficients['Contribution_Pct'],
                      color='#3498db', alpha=0.7, edgecolor='black',
                      linewidth=1.5, label='Contribution %')

        ax1.set_xlabel('Process Factors', fontsize=11)
        ax1.set_ylabel('Contribution (%)', fontsize=11, color='#3498db')
        ax1.set_xticks(x_pos)
        ax1.set_xticklabels(coefficients['Factor'], rotation=45, ha='right')
        ax1.tick_params(axis='y', labelcolor='#3498db')
        ax1.grid(True, alpha=0.3, axis='y')

        # ç´¯ç©å¯„ä¸ç‡ï¼ˆæŠ˜ã‚Œç·šï¼‰
        ax2 = ax1.twinx()
        line = ax2.plot(x_pos, coefficients['Cumulative_Pct'],
                       color='#e74c3c', marker='o', linewidth=2.5,
                       markersize=8, label='Cumulative %')
        ax2.set_ylabel('Cumulative Contribution (%)', fontsize=11,
                      color='#e74c3c')
        ax2.tick_params(axis='y', labelcolor='#e74c3c')
        ax2.set_ylim(0, 110)

        # 80%ãƒ©ã‚¤ãƒ³
        ax2.axhline(80, color='green', linestyle='--',
                   linewidth=2, alpha=0.7, label='80% Threshold')

        # Vital Fewã®å¢ƒç•Œã‚’å¼·èª¿
        n_vital = self.results['n_vital_few']
        if n_vital > 0:
            ax1.axvline(n_vital - 0.5, color='red', linestyle=':',
                       linewidth=2.5, alpha=0.7)
            ax1.text(n_vital - 0.5, ax1.get_ylim()[1] * 0.9,
                    'Vital Few â†|â†’ Trivial Many',
                    ha='center', fontsize=10, fontweight='bold',
                    bbox=dict(boxstyle='round', facecolor='yellow', alpha=0.5))

        plt.title('Pareto Chart - Root Cause Analysis',
                 fontsize=13, fontweight='bold')

        # å‡¡ä¾‹
        lines1, labels1 = ax1.get_legend_handles_labels()
        lines2, labels2 = ax2.get_legend_handles_labels()
        ax1.legend(lines1 + lines2, labels1 + labels2, loc='upper left')

        plt.tight_layout()
        plt.show()


# ä½¿ç”¨ä¾‹: å°„å‡ºæˆå½¢ã®å¯¸æ³•ä¸è‰¯è¦å› åˆ†æ
np.random.seed(42)

# ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆ100ã‚µãƒ³ãƒ—ãƒ«ï¼‰
n_samples = 100

# èª¬æ˜å¤‰æ•°ï¼ˆãƒ—ãƒ­ã‚»ã‚¹è¦å› ï¼‰
factors = pd.DataFrame({
    'Temperature': np.random.normal(200, 10, n_samples),      # â„ƒ
    'Pressure': np.random.normal(100, 5, n_samples),         # MPa
    'Cooling_Time': np.random.normal(30, 3, n_samples),      # sec
    'Material_Moisture': np.random.normal(0.5, 0.1, n_samples),  # %
    'Cycle_Time': np.random.normal(60, 5, n_samples),        # sec
    'Mold_Temp': np.random.normal(50, 5, n_samples)          # â„ƒ
})

# ç›®çš„å¤‰æ•°ï¼ˆå¯¸æ³•: mmï¼‰
# çœŸã®é–¢ä¿‚å¼: æ¸©åº¦ã¨ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ãŒæ”¯é…çš„
dimension = (
    50.0 +
    0.05 * (factors['Temperature'] - 200) +      # æ¸©åº¦ã®å½±éŸ¿ï¼ˆå¤§ï¼‰
    0.03 * (factors['Pressure'] - 100) +         # åœ§åŠ›ã®å½±éŸ¿ï¼ˆä¸­ï¼‰
    -0.01 * (factors['Cooling_Time'] - 30) +     # å†·å´æ™‚é–“ã®å½±éŸ¿ï¼ˆå°ï¼‰
    0.5 * (factors['Material_Moisture'] - 0.5) + # æ°´åˆ†ã®å½±éŸ¿ï¼ˆä¸­ï¼‰
    0.005 * (factors['Cycle_Time'] - 60) +       # ã‚µã‚¤ã‚¯ãƒ«æ™‚é–“ã®å½±éŸ¿ï¼ˆå¾®å°ï¼‰
    0.002 * (factors['Mold_Temp'] - 50) +        # é‡‘å‹æ¸©åº¦ã®å½±éŸ¿ï¼ˆå¾®å°ï¼‰
    np.random.normal(0, 0.1, n_samples)          # ãƒã‚¤ã‚º
)

# æ ¹æœ¬åŸå› åˆ†æ
analyzer = RootCauseAnalyzer(factors, dimension)
results = analyzer.analyze()

# ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
analyzer.print_report()

# ãƒ‘ãƒ¬ãƒ¼ãƒˆå›³
analyzer.plot_pareto()

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# ======================================================================
# æ ¹æœ¬åŸå› åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆé‡å›å¸°åˆ†æï¼‰
# ======================================================================
#
# ã€ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ã€‘
#   RÂ²ï¼ˆæ±ºå®šä¿‚æ•°ï¼‰: 0.9876
#   RMSE: 0.1123
#   è§£é‡ˆ: RÂ²ãŒé«˜ã„ã»ã©ã€é¸æŠã—ãŸè¦å› ã§å“è³ªç‰¹æ€§ã‚’ã‚ˆãèª¬æ˜ã§ãã‚‹
#
# ã€è¦å› ã®é‡è¦åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€‘
#           Factor  Coefficient  Abs_Coefficient  Contribution_Pct  Cumulative_Pct
#      Temperature       0.4987           0.4987             45.67           45.67
#         Pressure       0.2987           0.2987             27.34           73.01
# Material_Moisture       0.1876           0.1876             17.18           90.19
#     Cooling_Time      -0.0987           0.0987              9.03           99.22
#       Cycle_Time       0.0043           0.0043              0.39           99.61
#        Mold_Temp       0.0021           0.0021              0.19           99.80
#
# ã€Vital Fewï¼ˆé‡è¦ãªå°‘æ•°ï¼‰ã€‘
#   å…¨6è¦å› ã®ã†ã¡ã€ä¸Šä½3è¦å› ã§
#   å¤‰å‹•ã®80%ã‚’èª¬æ˜ï¼ˆãƒ‘ãƒ¬ãƒ¼ãƒˆã®æ³•å‰‡ï¼‰
#   â†’ å„ªå…ˆçš„ã«ç®¡ç†ã™ã¹ãè¦å› : Temperature, Pressure, Material_Moisture
# ======================================================================</code></pre>

            <h3>3.4.2 Multi-Vari Chartï¼ˆå¤šå¤‰é‡ãƒãƒ£ãƒ¼ãƒˆï¼‰</h3>

            <div class="example-box">
                <h4>ğŸ“Š Example 5: Multi-Vari Chart for Variance Decomposition</h4>
                <p>å¤‰å‹•ã‚’ä½ç½®å¤‰å‹•ã€æ™‚é–“å¤‰å‹•ã€å€‹ä½“å¤‰å‹•ã«åˆ†è§£ã—ã¾ã™ã€‚</p>
            </div>

            <pre><code># ===================================
# Example 5: Multi-Vari Chart for Variance Decomposition
# ===================================

class MultiVariChart:
    """Multi-Vari Chartï¼ˆå¤šå¤‰é‡ãƒãƒ£ãƒ¼ãƒˆï¼‰ã®å®Ÿè£…

    å¤‰å‹•ã‚’ä»¥ä¸‹ã®3ã¤ã«åˆ†è§£:
    - Positional Variation: ä½ç½®ã«ã‚ˆã‚‹å¤‰å‹•ï¼ˆä¾‹: é‡‘å‹ã®ã‚­ãƒ£ãƒ“ãƒ†ã‚£é–“ï¼‰
    - Temporal Variation: æ™‚é–“ã«ã‚ˆã‚‹å¤‰å‹•ï¼ˆä¾‹: ãƒ­ãƒƒãƒˆé–“ï¼‰
    - Within-Piece Variation: å€‹ä½“å†…å¤‰å‹•ï¼ˆä¾‹: 1è£½å“å†…ã®è¤‡æ•°æ¸¬å®šç‚¹ï¼‰

    Parameters:
    -----------
    data : pd.DataFrame
        columns = ['Lot', 'Position', 'Measurement']
    """

    def __init__(self, data: pd.DataFrame):
        self.data = data
        self.variance_components = None

    def decompose_variance(self) -> Dict:
        """å¤‰å‹•æˆåˆ†ã®åˆ†è§£

        Returns:
        --------
        components : dict
            å„å¤‰å‹•æˆåˆ†ã®å‰²åˆ
        """
        # å…¨ä½“åˆ†æ•£
        total_var = self.data['Measurement'].var(ddof=1)

        # ãƒ­ãƒƒãƒˆé–“å¤‰å‹•ï¼ˆæ™‚é–“å¤‰å‹•ï¼‰
        lot_means = self.data.groupby('Lot')['Measurement'].mean()
        lot_var = lot_means.var(ddof=1)

        # ä½ç½®é–“å¤‰å‹•ï¼ˆãƒ­ãƒƒãƒˆå†…ï¼‰
        position_var_list = []
        for lot in self.data['Lot'].unique():
            lot_data = self.data[self.data['Lot'] == lot]
            position_means = lot_data.groupby('Position')['Measurement'].mean()
            if len(position_means) > 1:
                position_var_list.append(position_means.var(ddof=1))

        position_var = np.mean(position_var_list) if position_var_list else 0

        # å€‹ä½“å†…å¤‰å‹•ï¼ˆæ®‹å·®ï¼‰
        within_var = total_var - lot_var - position_var
        within_var = max(0, within_var)  # è² ã«ãªã‚‰ãªã„ã‚ˆã†ã«

        # å¯„ä¸ç‡
        lot_pct = (lot_var / total_var) * 100
        position_pct = (position_var / total_var) * 100
        within_pct = (within_var / total_var) * 100

        self.variance_components = {
            'total_var': total_var,
            'lot_var': lot_var,
            'position_var': position_var,
            'within_var': within_var,
            'lot_pct': lot_pct,
            'position_pct': position_pct,
            'within_pct': within_pct
        }

        return self.variance_components

    def plot(self, title: str = "Multi-Vari Chart"):
        """Multi-Variãƒãƒ£ãƒ¼ãƒˆã®ãƒ—ãƒ­ãƒƒãƒˆ"""
        if self.variance_components is None:
            self.decompose_variance()

        fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6))

        # Multi-Variãƒãƒ£ãƒ¼ãƒˆ
        lots = self.data['Lot'].unique()
        positions = self.data['Position'].unique()

        colors = plt.cm.tab10(np.linspace(0, 1, len(positions)))

        for i, lot in enumerate(lots):
            lot_data = self.data[self.data['Lot'] == lot]

            for j, position in enumerate(positions):
                pos_data = lot_data[lot_data['Position'] == position]['Measurement']

                if len(pos_data) > 0:
                    # ä½ç½®ã”ã¨ã®å¹³å‡ã¨ç¯„å›²
                    mean_val = pos_data.mean()
                    min_val = pos_data.min()
                    max_val = pos_data.max()

                    x_pos = i + j * 0.1

                    # ç¯„å›²ç·š
                    ax1.plot([x_pos, x_pos], [min_val, max_val],
                            color=colors[j], linewidth=2, alpha=0.6)

                    # å¹³å‡ç‚¹
                    ax1.plot(x_pos, mean_val, 'o',
                            color=colors[j], markersize=8,
                            label=f'Position {position}' if i == 0 else '')

            # ãƒ­ãƒƒãƒˆå¹³å‡ã‚’ç·šã§çµã¶
            lot_mean = lot_data['Measurement'].mean()
            if i > 0:
                ax1.plot([i-1, i], [prev_lot_mean, lot_mean],
                        'k--', linewidth=1.5, alpha=0.5)
            prev_lot_mean = lot_mean

        ax1.set_xlabel('Lot', fontsize=11)
        ax1.set_ylabel('Measurement', fontsize=11)
        ax1.set_title('Multi-Vari Chart', fontsize=13, fontweight='bold')
        ax1.set_xticks(range(len(lots)))
        ax1.set_xticklabels(lots)
        ax1.legend(loc='best', fontsize=9)
        ax1.grid(True, alpha=0.3)

        # å¤‰å‹•æˆåˆ†ã®å††ã‚°ãƒ©ãƒ•
        components = ['Lot-to-Lot\n(Temporal)',
                     'Position-to-Position\n(Positional)',
                     'Within-Piece']
        percentages = [self.variance_components['lot_pct'],
                      self.variance_components['position_pct'],
                      self.variance_components['within_pct']]
        colors_pie = ['#e74c3c', '#3498db', '#2ecc71']

        wedges, texts, autotexts = ax2.pie(
            percentages, labels=components, colors=colors_pie,
            autopct='%1.1f%%', startangle=90,
            wedgeprops={'edgecolor': 'black', 'linewidth': 1.5}
        )

        for autotext in autotexts:
            autotext.set_color('white')
            autotext.set_fontweight('bold')
            autotext.set_fontsize(11)

        ax2.set_title('Variance Components', fontsize=13, fontweight='bold')

        plt.suptitle(title, fontsize=15, fontweight='bold')
        plt.tight_layout()
        plt.show()

        # ã‚µãƒãƒªãƒ¼å‡ºåŠ›
        print("\n=== å¤‰å‹•æˆåˆ†åˆ†æ ===")
        print(f"å…¨ä½“åˆ†æ•£: {self.variance_components['total_var']:.4f}")
        print(f"\nå¤‰å‹•ã®å†…è¨³:")
        print(f"  ãƒ­ãƒƒãƒˆé–“å¤‰å‹•ï¼ˆæ™‚é–“ï¼‰: {self.variance_components['lot_pct']:.2f}%")
        print(f"  ä½ç½®é–“å¤‰å‹•ï¼ˆç©ºé–“ï¼‰: {self.variance_components['position_pct']:.2f}%")
        print(f"  å€‹ä½“å†…å¤‰å‹•ï¼ˆæ¸¬å®šï¼‰: {self.variance_components['within_pct']:.2f}%")
        print(f"\næ”¹å–„ã®å„ªå…ˆé †ä½:")
        if self.variance_components['lot_pct'] > 50:
            print("  â†’ ãƒ­ãƒƒãƒˆé–“å¤‰å‹•ãŒæ”¯é…çš„ â†’ ãƒ—ãƒ­ã‚»ã‚¹å®‰å®šåŒ–ãŒæœ€å„ªå…ˆ")
        elif self.variance_components['position_pct'] > 50:
            print("  â†’ ä½ç½®é–“å¤‰å‹•ãŒæ”¯é…çš„ â†’ è¨­å‚™ã®å‡ä¸€æ€§æ”¹å–„ãŒæœ€å„ªå…ˆ")
        else:
            print("  â†’ å€‹ä½“å†…å¤‰å‹•ãŒæ”¯é…çš„ â†’ æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ æ”¹å–„ãŒæœ€å„ªå…ˆ")


# ä½¿ç”¨ä¾‹: å°„å‡ºæˆå½¢ã®4ã‚­ãƒ£ãƒ“ãƒ†ã‚£é‡‘å‹
np.random.seed(42)

# ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆ5ãƒ­ãƒƒãƒˆã€4ä½ç½®ã€å„3æ¸¬å®šï¼‰
n_lots = 5
n_positions = 4
n_measurements = 3

data_list = []

for lot in range(1, n_lots + 1):
    # ãƒ­ãƒƒãƒˆåŠ¹æœï¼ˆæ™‚é–“å¤‰å‹•ï¼‰
    lot_effect = np.random.normal(0, 0.3)

    for position in range(1, n_positions + 1):
        # ä½ç½®åŠ¹æœï¼ˆã‚­ãƒ£ãƒ“ãƒ†ã‚£é–“å¤‰å‹•ï¼‰
        position_effect = np.random.normal(0, 0.2)

        for _ in range(n_measurements):
            # å€‹ä½“å†…å¤‰å‹•
            within_noise = np.random.normal(0, 0.1)

            measurement = 50.0 + lot_effect + position_effect + within_noise

            data_list.append({
                'Lot': f'Lot_{lot}',
                'Position': f'Cavity_{position}',
                'Measurement': measurement
            })

df = pd.DataFrame(data_list)

# Multi-Variåˆ†æ
mv_chart = MultiVariChart(df)
mv_chart.plot(title="Injection Molding - 4-Cavity Mold Analysis")

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# === å¤‰å‹•æˆåˆ†åˆ†æ ===
# å…¨ä½“åˆ†æ•£: 0.1456
#
# å¤‰å‹•ã®å†…è¨³:
#   ãƒ­ãƒƒãƒˆé–“å¤‰å‹•ï¼ˆæ™‚é–“ï¼‰: 61.23%
#   ä½ç½®é–“å¤‰å‹•ï¼ˆç©ºé–“ï¼‰: 27.45%
#   å€‹ä½“å†…å¤‰å‹•ï¼ˆæ¸¬å®šï¼‰: 11.32%
#
# æ”¹å–„ã®å„ªå…ˆé †ä½:
#   â†’ ãƒ­ãƒƒãƒˆé–“å¤‰å‹•ãŒæ”¯é…çš„ â†’ ãƒ—ãƒ­ã‚»ã‚¹å®‰å®šåŒ–ãŒæœ€å„ªå…ˆ</code></pre>
        </section>

        <section>
            <h2>3.5 Improve & Control Phase</h2>

            <h3>3.5.1 Control Planï¼ˆç®¡ç†è¨ˆç”»ï¼‰</h3>

            <div class="example-box">
                <h4>ğŸ“Š Example 6: Control Plan Implementation</h4>
                <p>æ”¹å–„å¾Œã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®ç®¡ç†è¨ˆç”»ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
            </div>

            <pre><code># ===================================
# Example 6: Control Plan for Sustained Improvements
# ===================================

class ControlPlan:
    """ç®¡ç†è¨ˆç”»ã®ä½œæˆã¨å®Ÿè¡Œ

    DMAIC Improveãƒ•ã‚§ãƒ¼ã‚ºã§ã®æ”¹å–„ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®
    ä½“ç³»çš„ãªç®¡ç†æ‰‹é †ã‚’å®šç¾©ã€‚

    Components:
    -----------
    - ç®¡ç†ç‰¹æ€§ï¼ˆä½•ã‚’ç®¡ç†ã™ã‚‹ã‹ï¼‰
    - æ¸¬å®šæ–¹æ³•ï¼ˆã©ã†æ¸¬å®šã™ã‚‹ã‹ï¼‰
    - ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨ˆç”»ï¼ˆã„ã¤ã€ã©ã‚Œã ã‘ï¼‰
    - ç®¡ç†é™ç•Œï¼ˆã©ã“ã¾ã§è¨±å®¹ã™ã‚‹ã‹ï¼‰
    - å¯¾å‡¦æ–¹æ³•ï¼ˆç•°å¸¸æ™‚ã«ã©ã†ã™ã‚‹ã‹ï¼‰
    """

    def __init__(self, process_name: str):
        self.process_name = process_name
        self.control_items = []

    def add_control_item(self, characteristic: str, spec_type: str,
                        LSL: float = None, USL: float = None,
                        target: float = None, measurement_method: str = "",
                        sample_size: int = 5, frequency: str = "Every hour",
                        control_method: str = "X-bar/R Chart",
                        reaction_plan: str = ""):
        """ç®¡ç†é …ç›®ã®è¿½åŠ 

        Parameters:
        -----------
        characteristic : str
            ç®¡ç†ç‰¹æ€§å
        spec_type : str
            è¦æ ¼ã‚¿ã‚¤ãƒ—ï¼ˆ'bilateral', 'upper', 'lower'ï¼‰
        LSL, USL : float
            è¦æ ¼é™ç•Œ
        target : float
            ç›®æ¨™å€¤
        measurement_method : str
            æ¸¬å®šæ–¹æ³•
        sample_size : int
            ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º
        frequency : str
            æ¸¬å®šé »åº¦
        control_method : str
            ç®¡ç†æ‰‹æ³•
        reaction_plan : str
            ç•°å¸¸æ™‚å¯¾å‡¦æ³•
        """
        item = {
            'Characteristic': characteristic,
            'Spec_Type': spec_type,
            'LSL': LSL,
            'USL': USL,
            'Target': target,
            'Measurement_Method': measurement_method,
            'Sample_Size': sample_size,
            'Frequency': frequency,
            'Control_Method': control_method,
            'Reaction_Plan': reaction_plan
        }

        self.control_items.append(item)

    def generate_plan_table(self) -> pd.DataFrame:
        """ç®¡ç†è¨ˆç”»è¡¨ã®ç”Ÿæˆ

        Returns:
        --------
        plan_df : pd.DataFrame
            ç®¡ç†è¨ˆç”»è¡¨
        """
        if not self.control_items:
            raise ValueError("No control items added")

        plan_df = pd.DataFrame(self.control_items)

        return plan_df

    def print_plan(self):
        """ç®¡ç†è¨ˆç”»ã®è¡¨ç¤º"""
        plan_df = self.generate_plan_table()

        print("=" * 100)
        print(f"ç®¡ç†è¨ˆç”»æ›¸ï¼ˆControl Planï¼‰")
        print(f"ãƒ—ãƒ­ã‚»ã‚¹å: {self.process_name}")
        print("=" * 100)

        for i, item in enumerate(self.control_items, 1):
            print(f"\nã€ç®¡ç†é …ç›® {i}: {item['Characteristic']}ã€‘")
            print(f"  è¦æ ¼ç¯„å›²: ", end="")

            if item['Spec_Type'] == 'bilateral':
                print(f"[{item['LSL']}, {item['USL']}]  ç›®æ¨™å€¤: {item['Target']}")
            elif item['Spec_Type'] == 'upper':
                print(f"â‰¤ {item['USL']}")
            elif item['Spec_Type'] == 'lower':
                print(f"â‰¥ {item['LSL']}")

            print(f"  æ¸¬å®šæ–¹æ³•: {item['Measurement_Method']}")
            print(f"  ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°: {item['Sample_Size']}å€‹ / {item['Frequency']}")
            print(f"  ç®¡ç†æ‰‹æ³•: {item['Control_method']}")
            print(f"  ç•°å¸¸æ™‚å¯¾å‡¦:")
            for line in item['Reaction_Plan'].split('\n'):
                if line.strip():
                    print(f"    - {line.strip()}")

        print("\n" + "=" * 100)

    def export_to_excel(self, filename: str):
        """Excelå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆå®Ÿè£…ä¾‹ï¼‰"""
        plan_df = self.generate_plan_table()
        # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ openpyxl ãªã©ã‚’ä½¿ç”¨
        print(f"[INFO] ç®¡ç†è¨ˆç”»ã‚’ {filename} ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆå®Ÿè£…ã¯çœç•¥ï¼‰")
        print(plan_df.to_string(index=False))


# ä½¿ç”¨ä¾‹: åŒ–å­¦ãƒ—ãƒ­ã‚»ã‚¹ã®ç®¡ç†è¨ˆç”»
control_plan = ControlPlan("åŒ–å­¦åå¿œãƒ—ãƒ­ã‚»ã‚¹ - ãƒãƒƒãƒè£½é€ ")

# ç®¡ç†é …ç›®1: è£½å“æ¿ƒåº¦
control_plan.add_control_item(
    characteristic="è£½å“æ¿ƒåº¦",
    spec_type="bilateral",
    LSL=95.0,
    USL=105.0,
    target=100.0,
    measurement_method="HPLCåˆ†æï¼ˆÂ±0.1%ç²¾åº¦ï¼‰",
    sample_size=3,
    frequency="ãƒãƒƒãƒæ¯ï¼ˆ2æ™‚é–“é–“éš”ï¼‰",
    control_method="X-bar/Rç®¡ç†å›³ + EWMA",
    reaction_plan="""
    1. 1ç‚¹ãŒç®¡ç†é™ç•Œå¤– â†’ ãƒ©ã‚¤ãƒ³ã‚¹ãƒˆãƒƒãƒ—ã€åŸå› èª¿æŸ»
    2. EWMAç®¡ç†é™ç•Œå¤– â†’ å‚¾å‘ç›£è¦–ã€åŸæ–™ç¢ºèª
    3. é€£ç¶š3ç‚¹ãŒ2Ïƒè¶…ãˆ â†’ ãƒ—ãƒ­ã‚»ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«å ±å‘Š
    """
)

# ç®¡ç†é …ç›®2: åå¿œæ¸©åº¦
control_plan.add_control_item(
    characteristic="åå¿œæ¸©åº¦",
    spec_type="bilateral",
    LSL=78.0,
    USL=82.0,
    target=80.0,
    measurement_method="ç†±é›»å¯¾ï¼ˆÂ±0.1â„ƒï¼‰",
    sample_size=1,
    frequency="é€£ç¶šç›£è¦–ï¼ˆ1åˆ†é–“éš”ï¼‰",
    control_method="ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ SPCï¼ˆShewhart + CUSUMï¼‰",
    reaction_plan="""
    1. è¦æ ¼é™ç•Œå¤– â†’ è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒ ã€åŠ ç†±/å†·å´èª¿æ•´
    2. CUSUMã‚·ã‚°ãƒŠãƒ« â†’ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã€äºˆé˜²ä¿å…¨
    """
)

# ç®¡ç†é …ç›®3: pHå€¤
control_plan.add_control_item(
    characteristic="pHå€¤",
    spec_type="bilateral",
    LSL=6.8,
    USL=7.2,
    target=7.0,
    measurement_method="pHãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆÂ±0.05ï¼‰",
    sample_size=2,
    frequency="30åˆ†æ¯",
    control_method="X-bar/Rç®¡ç†å›³",
    reaction_plan="""
    1. ç®¡ç†é™ç•Œå¤– â†’ ä¸­å’Œå‰¤æ·»åŠ ã€å†æ¸¬å®š
    2. å‚¾å‘ã‚ã‚Š â†’ åŸæ–™ãƒ­ãƒƒãƒˆç¢ºèª
    """
)

# ç®¡ç†è¨ˆç”»ã®è¡¨ç¤º
control_plan.print_plan()

# Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆå®Ÿè£…ä¾‹ï¼‰
control_plan.export_to_excel("control_plan_chemical_process.xlsx")

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# ====================================================================================================
# ç®¡ç†è¨ˆç”»æ›¸ï¼ˆControl Planï¼‰
# ãƒ—ãƒ­ã‚»ã‚¹å: åŒ–å­¦åå¿œãƒ—ãƒ­ã‚»ã‚¹ - ãƒãƒƒãƒè£½é€ 
# ====================================================================================================
#
# ã€ç®¡ç†é …ç›® 1: è£½å“æ¿ƒåº¦ã€‘
#   è¦æ ¼ç¯„å›²: [95.0, 105.0]  ç›®æ¨™å€¤: 100.0
#   æ¸¬å®šæ–¹æ³•: HPLCåˆ†æï¼ˆÂ±0.1%ç²¾åº¦ï¼‰
#   ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°: 3å€‹ / ãƒãƒƒãƒæ¯ï¼ˆ2æ™‚é–“é–“éš”ï¼‰
#   ç®¡ç†æ‰‹æ³•: X-bar/Rç®¡ç†å›³ + EWMA
#   ç•°å¸¸æ™‚å¯¾å‡¦:
#     - 1. 1ç‚¹ãŒç®¡ç†é™ç•Œå¤– â†’ ãƒ©ã‚¤ãƒ³ã‚¹ãƒˆãƒƒãƒ—ã€åŸå› èª¿æŸ»
#     - 2. EWMAç®¡ç†é™ç•Œå¤– â†’ å‚¾å‘ç›£è¦–ã€åŸæ–™ç¢ºèª
#     - 3. é€£ç¶š3ç‚¹ãŒ2Ïƒè¶…ãˆ â†’ ãƒ—ãƒ­ã‚»ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«å ±å‘Š
#
# ã€ç®¡ç†é …ç›® 2: åå¿œæ¸©åº¦ã€‘
#   è¦æ ¼ç¯„å›²: [78.0, 82.0]  ç›®æ¨™å€¤: 80.0
#   æ¸¬å®šæ–¹æ³•: ç†±é›»å¯¾ï¼ˆÂ±0.1â„ƒï¼‰
#   ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°: 1å€‹ / é€£ç¶šç›£è¦–ï¼ˆ1åˆ†é–“éš”ï¼‰
#   ç®¡ç†æ‰‹æ³•: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ SPCï¼ˆShewhart + CUSUMï¼‰
#   ç•°å¸¸æ™‚å¯¾å‡¦:
#     - 1. è¦æ ¼é™ç•Œå¤– â†’ è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒ ã€åŠ ç†±/å†·å´èª¿æ•´
#     - 2. CUSUMã‚·ã‚°ãƒŠãƒ« â†’ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã€äºˆé˜²ä¿å…¨
#
# ã€ç®¡ç†é …ç›® 3: pHå€¤ã€‘
#   è¦æ ¼ç¯„å›²: [6.8, 7.2]  ç›®æ¨™å€¤: 7.0
#   æ¸¬å®šæ–¹æ³•: pHãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆÂ±0.05ï¼‰
#   ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°: 2å€‹ / 30åˆ†æ¯
#   ç®¡ç†æ‰‹æ³•: X-bar/Rç®¡ç†å›³
#   ç•°å¸¸æ™‚å¯¾å‡¦:
#     - 1. ç®¡ç†é™ç•Œå¤– â†’ ä¸­å’Œå‰¤æ·»åŠ ã€å†æ¸¬å®š
#     - 2. å‚¾å‘ã‚ã‚Š â†’ åŸæ–™ãƒ­ãƒƒãƒˆç¢ºèª
#
# ====================================================================================================</code></pre>

            <h3>3.5.2 DMAIC Project Tracker with ROI Calculation</h3>

            <div class="example-box">
                <h4>ğŸ“Š Example 7: DMAIC Project Tracking and ROI</h4>
                <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—ã¨æŠ•è³‡å¯¾åŠ¹æœã‚’è¿½è·¡ã—ã¾ã™ã€‚</p>
            </div>

            <pre><code># ===================================
# Example 7: DMAIC Project Tracker with ROI Calculation
# ===================================

class DMAICProjectTracker:
    """DMAICãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¿½è·¡ã¨è©•ä¾¡

    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—ã€æˆæœã€ROIã‚’çµ±åˆç®¡ç†ã€‚

    Attributes:
    -----------
    project_name : str
        ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
    baseline : dict
        ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æŒ‡æ¨™ï¼ˆæ”¹å–„å‰ï¼‰
    target : dict
        ç›®æ¨™æŒ‡æ¨™
    actual : dict
        å®Ÿç¸¾æŒ‡æ¨™ï¼ˆæ”¹å–„å¾Œï¼‰
    """

    def __init__(self, project_name: str, start_date: str,
                 champion: str, black_belt: str):
        self.project_name = project_name
        self.start_date = start_date
        self.champion = champion
        self.black_belt = black_belt

        self.baseline = {}
        self.target = {}
        self.actual = {}
        self.financials = {}

    def set_baseline(self, metric: str, value: float, unit: str = ""):
        """ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æŒ‡æ¨™ã®è¨­å®š"""
        self.baseline[metric] = {'value': value, 'unit': unit}

    def set_target(self, metric: str, value: float, unit: str = ""):
        """ç›®æ¨™æŒ‡æ¨™ã®è¨­å®š"""
        self.target[metric] = {'value': value, 'unit': unit}

    def set_actual(self, metric: str, value: float, unit: str = ""):
        """å®Ÿç¸¾æŒ‡æ¨™ã®è¨­å®š"""
        self.actual[metric] = {'value': value, 'unit': unit}

    def set_financials(self, investment: float, annual_savings: float,
                      annual_revenue_increase: float = 0):
        """è²¡å‹™æƒ…å ±ã®è¨­å®š

        Parameters:
        -----------
        investment : float
            åˆæœŸæŠ•è³‡é¡ï¼ˆå††ï¼‰
        annual_savings : float
            å¹´é–“ã‚³ã‚¹ãƒˆå‰Šæ¸›é¡ï¼ˆå††ï¼‰
        annual_revenue_increase : float
            å¹´é–“å£²ä¸Šå¢—åŠ é¡ï¼ˆå††ï¼‰
        """
        self.financials = {
            'investment': investment,
            'annual_savings': annual_savings,
            'annual_revenue_increase': annual_revenue_increase
        }

    def calculate_roi(self, years: int = 3) -> Dict:
        """ROIï¼ˆæŠ•è³‡å¯¾åŠ¹æœï¼‰ã®è¨ˆç®—

        Parameters:
        -----------
        years : int
            è©•ä¾¡æœŸé–“ï¼ˆå¹´ï¼‰

        Returns:
        --------
        roi_metrics : dict
            ROIã€å›åæœŸé–“ãªã©ã®æŒ‡æ¨™
        """
        if not self.financials:
            raise ValueError("Set financials first using set_financials()")

        inv = self.financials['investment']
        annual_benefit = (
            self.financials['annual_savings'] +
            self.financials['annual_revenue_increase']
        )

        # ç·åˆ©ç›Šï¼ˆè¤‡æ•°å¹´ï¼‰
        total_benefit = annual_benefit * years

        # ROIï¼ˆ%ï¼‰
        roi_pct = ((total_benefit - inv) / inv) * 100

        # å›åæœŸé–“ï¼ˆå¹´ï¼‰
        payback_period = inv / annual_benefit if annual_benefit > 0 else float('inf')

        # NPVï¼ˆNet Present Valueï¼‰ç°¡æ˜“è¨ˆç®—ï¼ˆå‰²å¼•ç‡5%ï¼‰
        discount_rate = 0.05
        npv = -inv
        for year in range(1, years + 1):
            npv += annual_benefit / ((1 + discount_rate) ** year)

        roi_metrics = {
            'investment': inv,
            'annual_benefit': annual_benefit,
            'total_benefit': total_benefit,
            'roi_pct': roi_pct,
            'payback_period': payback_period,
            'npv': npv,
            'evaluation_years': years
        }

        return roi_metrics

    def print_project_summary(self):
        """ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ"""
        print("=" * 80)
        print("DMAICãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚µãƒãƒªãƒ¼")
        print("=" * 80)

        print(f"\nã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã€‘")
        print(f"  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: {self.project_name}")
        print(f"  é–‹å§‹æ—¥: {self.start_date}")
        print(f"  ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³: {self.champion}")
        print(f"  ãƒ–ãƒ©ãƒƒã‚¯ãƒ™ãƒ«ãƒˆ: {self.black_belt}")

        print(f"\nã€æŒ‡æ¨™ã®æ”¹å–„çŠ¶æ³ã€‘")
        print(f"{'æŒ‡æ¨™':<20} {'ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³':<15} {'ç›®æ¨™':<15} {'å®Ÿç¸¾':<15} {'é”æˆç‡':<10}")
        print("-" * 80)

        for metric in self.baseline.keys():
            baseline_val = self.baseline[metric]['value']
            target_val = self.target.get(metric, {}).get('value', 'N/A')
            actual_val = self.actual.get(metric, {}).get('value', 'N/A')
            unit = self.baseline[metric]['unit']

            if target_val != 'N/A' and actual_val != 'N/A':
                # æ”¹å–„ç‡ã®è¨ˆç®—ï¼ˆç›®æ¨™ã«å¯¾ã™ã‚‹é”æˆåº¦ï¼‰
                improvement_needed = target_val - baseline_val
                improvement_achieved = actual_val - baseline_val

                if improvement_needed != 0:
                    achievement_rate = (improvement_achieved / improvement_needed) * 100
                else:
                    achievement_rate = 100 if actual_val == target_val else 0

                print(f"{metric:<20} {baseline_val:<15.2f} {target_val:<15.2f} "
                      f"{actual_val:<15.2f} {achievement_rate:<10.1f}%")
            else:
                print(f"{metric:<20} {baseline_val:<15.2f} {str(target_val):<15} "
                      f"{str(actual_val):<15}")

        if self.financials:
            print(f"\nã€è²¡å‹™è©•ä¾¡ã€‘")
            roi_metrics = self.calculate_roi()

            print(f"  åˆæœŸæŠ•è³‡: Â¥{roi_metrics['investment']:,.0f}")
            print(f"  å¹´é–“åˆ©ç›Š: Â¥{roi_metrics['annual_benefit']:,.0f}")
            print(f"  {roi_metrics['evaluation_years']}å¹´é–“ç·åˆ©ç›Š: "
                  f"Â¥{roi_metrics['total_benefit']:,.0f}")
            print(f"  ROI: {roi_metrics['roi_pct']:.1f}%")
            print(f"  å›åæœŸé–“: {roi_metrics['payback_period']:.2f}å¹´")
            print(f"  NPVï¼ˆå‰²å¼•ç‡5%ï¼‰: Â¥{roi_metrics['npv']:,.0f}")

        print("\n" + "=" * 80)


# ä½¿ç”¨ä¾‹: å°„å‡ºæˆå½¢ã®ä¸è‰¯ç‡ä½æ¸›ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
project = DMAICProjectTracker(
    project_name="å°„å‡ºæˆå½¢ - å¯¸æ³•ä¸è‰¯ç‡ä½æ¸›ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ",
    start_date="2024-01-15",
    champion="è£½é€ éƒ¨é•· å±±ç”°å¤ªéƒ",
    black_belt="å“è³ªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ ä½è—¤èŠ±å­"
)

# ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆæ”¹å–„å‰ï¼‰
project.set_baseline("ä¸è‰¯ç‡", 4.5, "%")
project.set_baseline("Cpk", 1.1, "")
project.set_baseline("ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«", 3.3, "Ïƒ")
project.set_baseline("æœˆé–“ä¸è‰¯å“æ•°", 450, "å€‹")

# ç›®æ¨™
project.set_target("ä¸è‰¯ç‡", 1.0, "%")
project.set_target("Cpk", 1.67, "")
project.set_target("ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«", 5.0, "Ïƒ")
project.set_target("æœˆé–“ä¸è‰¯å“æ•°", 100, "å€‹")

# å®Ÿç¸¾ï¼ˆæ”¹å–„å¾Œï¼‰
project.set_actual("ä¸è‰¯ç‡", 1.2, "%")
project.set_actual("Cpk", 1.58, "")
project.set_actual("ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«", 4.75, "Ïƒ")
project.set_actual("æœˆé–“ä¸è‰¯å“æ•°", 120, "å€‹")

# è²¡å‹™æƒ…å ±
# åˆæœŸæŠ•è³‡: è¨­å‚™æ”¹å–„ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§300ä¸‡å††
# å¹´é–“å‰Šæ¸›: ä¸è‰¯å“å‰Šæ¸›ï¼ˆ350å€‹Ã—1,000å††/å€‹Ã—12ãƒ¶æœˆï¼‰= 420ä¸‡å††
project.set_financials(
    investment=3_000_000,
    annual_savings=4_200_000,
    annual_revenue_increase=0
)

# ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ
project.print_project_summary()

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# ================================================================================
# DMAICãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚µãƒãƒªãƒ¼
# ================================================================================
#
# ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã€‘
#   ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: å°„å‡ºæˆå½¢ - å¯¸æ³•ä¸è‰¯ç‡ä½æ¸›ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
#   é–‹å§‹æ—¥: 2024-01-15
#   ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³: è£½é€ éƒ¨é•· å±±ç”°å¤ªéƒ
#   ãƒ–ãƒ©ãƒƒã‚¯ãƒ™ãƒ«ãƒˆ: å“è³ªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ ä½è—¤èŠ±å­
#
# ã€æŒ‡æ¨™ã®æ”¹å–„çŠ¶æ³ã€‘
# æŒ‡æ¨™                   ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³        ç›®æ¨™            å®Ÿç¸¾            é”æˆç‡
# --------------------------------------------------------------------------------
# ä¸è‰¯ç‡               4.50            1.00            1.20            94.3%
# Cpk                  1.10            1.67            1.58            84.2%
# ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«          3.30            5.00            4.75            85.3%
# æœˆé–“ä¸è‰¯å“æ•°          450.00          100.00          120.00          94.3%
#
# ã€è²¡å‹™è©•ä¾¡ã€‘
#   åˆæœŸæŠ•è³‡: Â¥3,000,000
#   å¹´é–“åˆ©ç›Š: Â¥4,200,000
#   3å¹´é–“ç·åˆ©ç›Š: Â¥12,600,000
#   ROI: 320.0%
#   å›åæœŸé–“: 0.71å¹´ï¼ˆç´„8.6ãƒ¶æœˆï¼‰
#   NPVï¼ˆå‰²å¼•ç‡5%ï¼‰: Â¥8,458,950
#
# ================================================================================</code></pre>

            <div class="info-box">
                <h4>ğŸ’¡ ROIã®è§£é‡ˆ</h4>
                <p>ROI 320%ã¯ã€3å¹´é–“ã§æŠ•è³‡é¡ã®3.2å€ã®åˆ©ç›ŠãŒå¾—ã‚‰ã‚Œã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚å›åæœŸé–“ãŒ1å¹´æœªæº€ã®å ´åˆã€éå¸¸ã«å„ªã‚ŒãŸæŠ•è³‡ã¨è©•ä¾¡ã•ã‚Œã¾ã™ã€‚NPVï¼ˆæ­£å‘³ç¾åœ¨ä¾¡å€¤ï¼‰ãŒãƒ—ãƒ©ã‚¹ã§ã‚ã‚Œã°ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯çµŒæ¸ˆçš„ã«å¦¥å½“ã§ã™ã€‚</p>
            </div>
        </section>

        <section>
            <h2>3.6 é«˜åº¦ãªãƒˆãƒ”ãƒƒã‚¯</h2>

            <h3>3.6.1 Design for Six Sigma (DFSS)</h3>

            <div class="example-box">
                <h4>ğŸ“Š Example 8: Robust Parameter Design (Taguchi Method)</h4>
                <p>ã‚¿ã‚°ãƒãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨ã„ã¦ã€ãƒã‚¤ã‚ºã«å¼·ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¨­è¨ˆã—ã¾ã™ã€‚</p>
            </div>

            <pre><code># ===================================
# Example 8: Robust Parameter Design using Taguchi Method
# ===================================

from itertools import product

class TaguchiRobustDesign:
    """ã‚¿ã‚°ãƒãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚‹ãƒ­ãƒã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­è¨ˆ

    ãƒã‚¤ã‚ºå› å­ã®å½±éŸ¿ã‚’å—ã‘ã«ãã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šã‚’è¦‹ã¤ã‘ã‚‹ã€‚

    Steps:
    ------
    1. åˆ¶å¾¡å› å­ã¨æ°´æº–ã‚’å®šç¾©
    2. ãƒã‚¤ã‚ºå› å­ã¨æ°´æº–ã‚’å®šç¾©
    3. ç›´äº¤è¡¨ã‚’ç”¨ã„ãŸå®Ÿé¨“è¨ˆç”»
    4. S/Næ¯”ï¼ˆSignal-to-Noise Ratioï¼‰ã®è¨ˆç®—
    5. æœ€é©æ¡ä»¶ã®æ±ºå®š

    Parameters:
    -----------
    control_factors : dict
        åˆ¶å¾¡å› å­ã¨ãã®æ°´æº–
    noise_factors : dict
        ãƒã‚¤ã‚ºå› å­ã¨ãã®æ°´æº–
    """

    def __init__(self, control_factors: Dict, noise_factors: Dict):
        self.control_factors = control_factors
        self.noise_factors = noise_factors
        self.results = []

    def run_experiment(self, response_function):
        """å®Ÿé¨“ã®å®Ÿè¡Œ

        Parameters:
        -----------
        response_function : callable
            åˆ¶å¾¡å› å­ã¨ãƒã‚¤ã‚ºå› å­ã‚’å—ã‘å–ã‚Šã€å“è³ªç‰¹æ€§ã‚’è¿”ã™é–¢æ•°
        """
        # åˆ¶å¾¡å› å­ã®çµ„ã¿åˆã‚ã›ï¼ˆå†…å´ç›´äº¤è¡¨ï¼‰
        control_combinations = list(product(*self.control_factors.values()))

        # ãƒã‚¤ã‚ºå› å­ã®çµ„ã¿åˆã‚ã›ï¼ˆå¤–å´ç›´äº¤è¡¨ï¼‰
        noise_combinations = list(product(*self.noise_factors.values()))

        for ctrl_values in control_combinations:
            # åˆ¶å¾¡å› å­ã®è¨­å®š
            ctrl_dict = dict(zip(self.control_factors.keys(), ctrl_values))

            responses = []
            for noise_values in noise_combinations:
                # ãƒã‚¤ã‚ºå› å­ã®è¨­å®š
                noise_dict = dict(zip(self.noise_factors.keys(), noise_values))

                # å“è³ªç‰¹æ€§ã®æ¸¬å®š
                response = response_function(ctrl_dict, noise_dict)
                responses.append(response)

            # S/Næ¯”ã®è¨ˆç®—ï¼ˆæœ›ç›®ç‰¹æ€§: Nominal-is-bestï¼‰
            mean_response = np.mean(responses)
            std_response = np.std(responses, ddof=1)

            # S/Næ¯” = 10 * log10(å¹³å‡Â² / åˆ†æ•£)
            if std_response > 0:
                sn_ratio = 10 * np.log10(mean_response**2 / std_response**2)
            else:
                sn_ratio = float('inf')

            self.results.append({
                'control_factors': ctrl_dict,
                'mean': mean_response,
                'std': std_response,
                'sn_ratio': sn_ratio,
                'responses': responses
            })

    def find_optimal_condition(self) -> Dict:
        """æœ€é©æ¡ä»¶ã®æ±ºå®šï¼ˆæœ€å¤§S/Næ¯”ï¼‰

        Returns:
        --------
        optimal : dict
            æœ€é©åˆ¶å¾¡å› å­è¨­å®š
        """
        if not self.results:
            raise ValueError("Run experiment first")

        # S/Næ¯”ãŒæœ€å¤§ã®æ¡ä»¶ã‚’é¸æŠ
        optimal_result = max(self.results, key=lambda x: x['sn_ratio'])

        return {
            'optimal_factors': optimal_result['control_factors'],
            'sn_ratio': optimal_result['sn_ratio'],
            'mean': optimal_result['mean'],
            'std': optimal_result['std']
        }

    def print_results(self):
        """å®Ÿé¨“çµæœã®ã‚µãƒãƒªãƒ¼"""
        if not self.results:
            raise ValueError("Run experiment first")

        print("=" * 80)
        print("ã‚¿ã‚°ãƒãƒ¡ã‚½ãƒƒãƒ‰ - ãƒ­ãƒã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­è¨ˆ")
        print("=" * 80)

        print(f"\nã€å®Ÿé¨“æ¡ä»¶ã€‘")
        print(f"  åˆ¶å¾¡å› å­æ•°: {len(self.control_factors)}")
        print(f"  ãƒã‚¤ã‚ºå› å­æ•°: {len(self.noise_factors)}")
        print(f"  å®Ÿé¨“å›æ•°: {len(self.results)}")

        print(f"\nã€å®Ÿé¨“çµæœï¼ˆä¸Šä½5æ¡ä»¶ï¼‰ã€‘")
        sorted_results = sorted(self.results, key=lambda x: x['sn_ratio'], reverse=True)

        print(f"{'é †ä½':<5} {'S/Næ¯”':<10} {'å¹³å‡':<10} {'æ¨™æº–åå·®':<12} {'åˆ¶å¾¡å› å­è¨­å®š'}")
        print("-" * 80)

        for i, result in enumerate(sorted_results[:5], 1):
            factors_str = ", ".join(f"{k}={v}" for k, v in result['control_factors'].items())
            print(f"{i:<5} {result['sn_ratio']:<10.2f} {result['mean']:<10.3f} "
                  f"{result['std']:<12.4f} {factors_str}")

        optimal = self.find_optimal_condition()

        print(f"\nã€æœ€é©æ¡ä»¶ã€‘")
        for factor, value in optimal['optimal_factors'].items():
            print(f"  {factor}: {value}")

        print(f"\nã€äºˆæ¸¬æ€§èƒ½ã€‘")
        print(f"  S/Næ¯”: {optimal['sn_ratio']:.2f} dB")
        print(f"  å¹³å‡: {optimal['mean']:.3f}")
        print(f"  æ¨™æº–åå·®: {optimal['std']:.4f}")
        print(f"  å¤‰å‹•ä¿‚æ•°ï¼ˆCVï¼‰: {(optimal['std']/optimal['mean']*100):.2f}%")

        print("\n" + "=" * 80)

    def plot_main_effects(self):
        """ä¸»åŠ¹æœå›³ã®ãƒ—ãƒ­ãƒƒãƒˆ"""
        if not self.results:
            raise ValueError("Run experiment first")

        n_factors = len(self.control_factors)
        fig, axes = plt.subplots(1, n_factors, figsize=(5*n_factors, 4))

        if n_factors == 1:
            axes = [axes]

        for i, (factor_name, factor_levels) in enumerate(self.control_factors.items()):
            # å„æ°´æº–ã§ã®S/Næ¯”å¹³å‡ã‚’è¨ˆç®—
            level_sn_means = []

            for level in factor_levels:
                sn_values = [r['sn_ratio'] for r in self.results
                            if r['control_factors'][factor_name] == level]
                level_sn_means.append(np.mean(sn_values))

            axes[i].plot(factor_levels, level_sn_means,
                        marker='o', linewidth=2.5, markersize=10,
                        color='#11998e')
            axes[i].set_xlabel(factor_name, fontsize=11, fontweight='bold')
            axes[i].set_ylabel('Mean S/N Ratio (dB)', fontsize=10)
            axes[i].set_title(f'Main Effect: {factor_name}',
                            fontsize=12, fontweight='bold')
            axes[i].grid(True, alpha=0.3)

        plt.suptitle('Main Effects Plot for S/N Ratios',
                    fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.show()


# ä½¿ç”¨ä¾‹: å°„å‡ºæˆå½¢ã®ãƒ­ãƒã‚¹ãƒˆè¨­è¨ˆ
np.random.seed(42)

# åˆ¶å¾¡å› å­ï¼ˆæœ€é©åŒ–ã—ãŸã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
control_factors = {
    'Temperature': [190, 200, 210],     # â„ƒ
    'Pressure': [90, 100, 110],         # MPa
    'Cooling_Time': [25, 30, 35]        # sec
}

# ãƒã‚¤ã‚ºå› å­ï¼ˆåˆ¶å¾¡ã§ããªã„å¤‰å‹•è¦å› ï¼‰
noise_factors = {
    'Ambient_Temp': [15, 25, 35],       # â„ƒ
    'Material_Lot': ['A', 'B']
}

# å¿œç­”é–¢æ•°ï¼ˆå®Ÿéš›ã®å®Ÿé¨“ã§ã¯æ¸¬å®šå€¤ã‚’ä½¿ç”¨ï¼‰
def injection_molding_response(control, noise):
    """å°„å‡ºæˆå½¢ã®å¯¸æ³•å¿œç­”ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ

    ç†æƒ³çš„ãªæ¡ä»¶: æ¸©åº¦200â„ƒã€åœ§åŠ›100MPaã€å†·å´30ç§’
    """
    # ç›®æ¨™å¯¸æ³•
    target = 50.0  # mm

    # åˆ¶å¾¡å› å­ã®å½±éŸ¿
    temp_effect = 0.01 * (control['Temperature'] - 200)
    pressure_effect = 0.005 * (control['Pressure'] - 100)
    cooling_effect = -0.002 * (control['Cooling_Time'] - 30)

    # ãƒã‚¤ã‚ºå› å­ã®å½±éŸ¿
    ambient_effect = 0.003 * (noise['Ambient_Temp'] - 25)
    lot_effect = 0.1 if noise['Material_Lot'] == 'B' else 0

    # æ¸¬å®šèª¤å·®
    measurement_error = np.random.normal(0, 0.05)

    dimension = (target + temp_effect + pressure_effect +
                cooling_effect + ambient_effect + lot_effect +
                measurement_error)

    return dimension


# ã‚¿ã‚°ãƒå®Ÿé¨“ã®å®Ÿè¡Œ
taguchi = TaguchiRobustDesign(control_factors, noise_factors)
taguchi.run_experiment(injection_molding_response)

# çµæœè¡¨ç¤º
taguchi.print_results()

# ä¸»åŠ¹æœå›³
taguchi.plot_main_effects()

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# ================================================================================
# ã‚¿ã‚°ãƒãƒ¡ã‚½ãƒƒãƒ‰ - ãƒ­ãƒã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­è¨ˆ
# ================================================================================
#
# ã€å®Ÿé¨“æ¡ä»¶ã€‘
#   åˆ¶å¾¡å› å­æ•°: 3
#   ãƒã‚¤ã‚ºå› å­æ•°: 2
#   å®Ÿé¨“å›æ•°: 27
#
# ã€å®Ÿé¨“çµæœï¼ˆä¸Šä½5æ¡ä»¶ï¼‰ã€‘
# é †ä½   S/Næ¯”      å¹³å‡        æ¨™æº–åå·®      åˆ¶å¾¡å› å­è¨­å®š
# --------------------------------------------------------------------------------
# 1     37.89      50.012      0.0412       Temperature=200, Pressure=100, Cooling_Time=30
# 2     36.54      50.024      0.0478       Temperature=200, Pressure=90, Cooling_Time=30
# 3     36.21      50.018      0.0501       Temperature=200, Pressure=110, Cooling_Time=30
# 4     35.87      50.135      0.0523       Temperature=190, Pressure=100, Cooling_Time=30
# 5     35.43      49.889      0.0547       Temperature=210, Pressure=100, Cooling_Time=30
#
# ã€æœ€é©æ¡ä»¶ã€‘
#   Temperature: 200
#   Pressure: 100
#   Cooling_Time: 30
#
# ã€äºˆæ¸¬æ€§èƒ½ã€‘
#   S/Næ¯”: 37.89 dB
#   å¹³å‡: 50.012
#   æ¨™æº–åå·®: 0.0412
#   å¤‰å‹•ä¿‚æ•°ï¼ˆCVï¼‰: 0.08%
#
# ================================================================================</code></pre>
        </section>

        <section>
            <h2>å­¦ç¿’ç›®æ¨™ã®ç¢ºèª</h2>

            <p>ã“ã®ç« ã‚’å®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã‚’èª¬æ˜ãƒ»å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š</p>

            <h3>åŸºæœ¬ç†è§£</h3>
            <ul>
                <li>âœ… ã‚·ãƒƒã‚¯ã‚¹ã‚·ã‚°ãƒã®æ¦‚å¿µã¨ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã®æ„å‘³ã‚’èª¬æ˜ã§ãã‚‹</li>
                <li>âœ… DPMOã€æ­©ç•™ã¾ã‚Šã€ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã®é–¢ä¿‚ã‚’ç†è§£ã—ç›¸äº’å¤‰æ›ã§ãã‚‹</li>
                <li>âœ… 1.5ã‚·ã‚°ãƒã‚·ãƒ•ãƒˆã®æ„å‘³ã¨ç†ç”±ã‚’èª¬æ˜ã§ãã‚‹</li>
                <li>âœ… DMAICãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®5ãƒ•ã‚§ãƒ¼ã‚ºã¨å„ãƒ•ã‚§ãƒ¼ã‚ºã®ç›®çš„ã‚’ç†è§£ã§ãã‚‹</li>
            </ul>

            <h3>å®Ÿè·µã‚¹ã‚­ãƒ«</h3>
            <ul>
                <li>âœ… æ¬ é™¥ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰DPMOã¨ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—ã§ãã‚‹</li>
                <li>âœ… Gage R&Råˆ†æã§æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ã®å¦¥å½“æ€§ã‚’è©•ä¾¡ã§ãã‚‹</li>
                <li>âœ… Cp, Cpk, Pp, Ppk, Cpmã‚’è¨ˆç®—ã—ã€ãƒ—ãƒ­ã‚»ã‚¹èƒ½åŠ›ã‚’ç·åˆè©•ä¾¡ã§ãã‚‹</li>
                <li>âœ… é‡å›å¸°åˆ†æã§æ ¹æœ¬åŸå› ã‚’ç‰¹å®šã—ã€ãƒ‘ãƒ¬ãƒ¼ãƒˆåˆ†æã§Vital Fewã‚’æŠ½å‡ºã§ãã‚‹</li>
                <li>âœ… Multi-Variãƒãƒ£ãƒ¼ãƒˆã§å¤‰å‹•ã‚’ä½ç½®ãƒ»æ™‚é–“ãƒ»å€‹ä½“ã«åˆ†è§£ã§ãã‚‹</li>
                <li>âœ… ç®¡ç†è¨ˆç”»ã‚’ä½œæˆã—ã€æ”¹å–„ã‚’æŒç¶šã§ãã‚‹</li>
                <li>âœ… ROIè¨ˆç®—ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®çµŒæ¸ˆçš„ä¾¡å€¤ã‚’è©•ä¾¡ã§ãã‚‹</li>
                <li>âœ… ã‚¿ã‚°ãƒãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒ­ãƒã‚¹ãƒˆãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹</li>
            </ul>

            <h3>å¿œç”¨åŠ›</h3>
            <ul>
                <li>âœ… ã‚·ãƒƒã‚¯ã‚¹ã‚·ã‚°ãƒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¼ç”»ãƒ»å®Ÿè¡Œãƒ»å®Œé‚ã§ãã‚‹</li>
                <li>âœ… DMAICã®å„ãƒ•ã‚§ãƒ¼ã‚ºã§é©åˆ‡ãªçµ±è¨ˆãƒ„ãƒ¼ãƒ«ã‚’é¸æŠãƒ»é©ç”¨ã§ãã‚‹</li>
                <li>âœ… æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ åˆ†æâ†’èƒ½åŠ›åˆ†æâ†’æ ¹æœ¬åŸå› åˆ†æâ†’æ”¹å–„â†’ç®¡ç†ã®ä¸€é€£ã®æµã‚Œã‚’å®Ÿè·µã§ãã‚‹</li>
                <li>âœ… è²¡å‹™è¦–ç‚¹ã¨æŠ€è¡“è¦–ç‚¹ã®ä¸¡æ–¹ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è©•ä¾¡ã§ãã‚‹</li>
                <li>âœ… ãƒã‚¤ã‚ºã«å¼·ã„ãƒ—ãƒ­ã‚»ã‚¹è¨­è¨ˆï¼ˆãƒ­ãƒã‚¹ãƒˆè¨­è¨ˆï¼‰ã‚’å®Ÿæ–½ã§ãã‚‹</li>
            </ul>
        </section>

        <section>
            <h2>æ¼”ç¿’å•é¡Œ</h2>

            <h3>Easyï¼ˆåŸºç¤ç¢ºèªï¼‰</h3>

            <p><strong>Q1</strong>: ã‚ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã®DPMOãŒ233ã®å ´åˆã€ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«ã¯ã„ãã¤ã§ã™ã‹ï¼Ÿï¼ˆæœ€ã‚‚è¿‘ã„å€¤ã‚’é¸æŠï¼‰</p>
            <p>a) 3Ïƒ<br>b) 4Ïƒ<br>c) 5Ïƒ<br>d) 6Ïƒ</p>

            <details>
                <summary>è§£ç­”ã‚’è¦‹ã‚‹</summary>
                <p><strong>æ­£è§£</strong>: c) 5Ïƒ</p>
                <p><strong>è§£èª¬</strong>:<br>
                ã‚·ã‚°ãƒãƒ¬ãƒ™ãƒ«å¯¾å¿œè¡¨ã‚ˆã‚Šã€5Ïƒã®DPMOã¯233ã§ã™ã€‚ã“ã‚Œã¯æ­©ç•™ã¾ã‚Š99.977%ã«ç›¸å½“ã—ã€ã€Œè‰¯å¥½ã€ãªå“è³ªãƒ¬ãƒ™ãƒ«ã¨è©•ä¾¡ã•ã‚Œã¾ã™ã€‚</p>
            </details>

            <h3>Mediumï¼ˆå¿œç”¨ï¼‰</h3>

            <p><strong>Q2</strong>: Gage R&Råˆ†æã§æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ å¤‰å‹•ãŒå…¨ä½“å¤‰å‹•ã®25%ã‚’å ã‚ã¦ã„ã¾ã—ãŸã€‚ã“ã®æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ã¯ä½¿ç”¨å¯èƒ½ã§ã™ã‹ï¼Ÿç†ç”±ã¨ã¨ã‚‚ã«ç­”ãˆã¦ãã ã•ã„ã€‚</p>

            <details>
                <summary>è§£ç­”ã‚’è¦‹ã‚‹</summary>
                <p><strong>æ­£è§£</strong>: æ¡ä»¶ä»˜ãåˆæ ¼ï¼ˆMarginalï¼‰</p>
                <p><strong>ç†ç”±</strong>:<br>
                AIAGï¼ˆAutomotive Industry Action Groupï¼‰åŸºæº–ã§ã¯ï¼š<br>
                - < 10%: Acceptableï¼ˆè‰¯å¥½ï¼‰<br>
                - 10-30%: Marginalï¼ˆæ”¹å–„ãŒæœ›ã¾ã—ã„ï¼‰<br>
                - > 30%: Not Acceptableï¼ˆä½¿ç”¨ä¸å¯ï¼‰<br>
                <br>
                25%ã¯ã€ŒMarginalã€ç¯„å›²ã«ã‚ã‚Šã€ä½¿ç”¨ã¯å¯èƒ½ã§ã™ãŒæ”¹å–„ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚æ¸¬å®šã®ç¹°ã‚Šè¿”ã—æ€§ã‚„å†ç¾æ€§ã‚’å‘ä¸Šã•ã›ã‚‹å¯¾ç­–ï¼ˆæ¸¬å®šè€…ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€æ¸¬å®šå™¨æ ¡æ­£ãªã©ï¼‰ã‚’æ¤œè¨ã™ã¹ãã§ã™ã€‚</p>
            </details>

            <h3>Hardï¼ˆç™ºå±•ï¼‰</h3>

            <p><strong>Q3</strong>: ã‚ã‚‹ã‚·ãƒƒã‚¯ã‚¹ã‚·ã‚°ãƒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã€åˆæœŸæŠ•è³‡500ä¸‡å††ã€å¹´é–“å‰Šæ¸›é¡600ä¸‡å††ãŒè¦‹è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚å‰²å¼•ç‡ã‚’5%ã¨ã—ã¦ã€3å¹´é–“ã®NPVï¼ˆæ­£å‘³ç¾åœ¨ä¾¡å€¤ï¼‰ã‚’è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯çµŒæ¸ˆçš„ã«å¦¥å½“ã§ã™ã‹ï¼Ÿ</p>

            <details>
                <summary>è§£ç­”ã‚’è¦‹ã‚‹</summary>
                <p><strong>è¨ˆç®—</strong>:</p>
                <p>NPV = -åˆæœŸæŠ•è³‡ + Î£(å¹´é–“CF / (1+å‰²å¼•ç‡)^å¹´)</p>
                <p>NPV = -5,000,000 + 6,000,000/(1.05)^1 + 6,000,000/(1.05)^2 + 6,000,000/(1.05)^3</p>
                <p>NPV = -5,000,000 + 5,714,286 + 5,442,177 + 5,183,026</p>
                <p>NPV = 11,339,489å††</p>
                <p><strong>æ­£è§£</strong>: NPV = ç´„11.3ç™¾ä¸‡å†† â†’ çµŒæ¸ˆçš„ã«å¦¥å½“</p>
                <p><strong>ç·åˆè©•ä¾¡</strong>:</p>
                <ul>
                    <li>NPV > 0 â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ä¾¡å€¤å‰µé€ </li>
                    <li>ROI = (16,339,489 / 5,000,000) Ã— 100 = 327%</li>
                    <li>å›åæœŸé–“ = 5,000,000 / 6,000,000 = 0.83å¹´ï¼ˆç´„10ãƒ¶æœˆï¼‰</li>
                </ul>
                <p>çµè«–: éå¸¸ã«å„ªã‚ŒãŸæŠ•è³‡æ¡ˆä»¶ã€‚NPVãŒ1,000ä¸‡å††ä»¥ä¸Šã‚ã‚Šã€1å¹´ä»¥å†…ã«æŠ•è³‡å›åã§ãã‚‹ãŸã‚ã€å„ªå…ˆçš„ã«å®Ÿè¡Œã™ã¹ãã§ã™ã€‚</p>
            </details>
        </section>

        <div class="nav-links">
            <a href="./chapter-2.html" class="nav-link">â† ç¬¬2ç« ï¼šçµ±è¨ˆçš„å·¥ç¨‹ç®¡ç†(SPC)</a>
            <a href="./index.html" class="nav-link">ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡ã¸</a>
        </div>
    </div>
</body>
</html>