<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬2ç«  é›»å­ãƒãƒƒãƒè¨˜éŒ²è§£æã¨é€¸è„±ç®¡ç† | ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹é“å ´</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.8; color: #333; background: #f5f5f5;
        }
        header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; padding: 2rem 1rem; text-align: center;
        }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .subtitle { opacity: 0.9; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .back-link {
            display: inline-block; margin-bottom: 2rem; padding: 0.5rem 1rem;
            background: white; color: #11998e; text-decoration: none;
            border-radius: 6px; font-weight: 600;
        }
        .content-box {
            background: white; padding: 2rem; border-radius: 12px;
            margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #11998e; margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem; border-bottom: 3px solid #11998e;
        }
        h3 { color: #2c3e50; margin: 1.5rem 0 1rem 0; }
        p { margin-bottom: 1rem; }
        ul, ol { margin-left: 2rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
        pre {
            background: #1e1e1e; color: #d4d4d4; padding: 1.5rem;
            border-radius: 8px; overflow-x: auto; margin: 1rem 0;
            border-left: 4px solid #11998e;
        }
        code {
            font-family: 'Courier New', monospace; font-size: 0.9rem;
        }
        .key-point {
            background: #e8f5e9; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #4caf50; margin: 1rem 0;
        }
        .gmp-note {
            background: #fff3e0; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #ff9800; margin: 1rem 0;
        }
        .warning {
            background: #ffebee; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #f44336; margin: 1rem 0;
        }
        .nav-buttons {
            display: flex; justify-content: space-between; margin-top: 3rem;
        }
        .nav-buttons a {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; text-decoration: none; border-radius: 6px;
            font-weight: 600;
        }
        footer {
            background: #2c3e50; color: white; text-align: center;
            padding: 2rem 1rem; margin-top: 4rem;
        }
        table {
            width: 100%; border-collapse: collapse; margin: 1rem 0;
        }
        th, td {
            border: 1px solid #ddd; padding: 0.75rem; text-align: left;
        }
        th {
            background: #11998e; color: white;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
    
        
    
        /* Breadcrumb styles */
        .breadcrumb {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .breadcrumb-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a0aec0;
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: #4a5568;
            font-weight: 500;
        }
    </style>
</head>
<body>
            <nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="../../index.html">AIå¯ºå­å±‹ãƒˆãƒƒãƒ—</a><span class="breadcrumb-separator">â€º</span><a href="../../PI/index.html">ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹</a><span class="breadcrumb-separator">â€º</span><a href="../../PI/pharma-manufacturing-ai/index.html">Pharma Manufacturing Ai</a><span class="breadcrumb-separator">â€º</span><span class="breadcrumb-current">Chapter 2</span>
        </div>
    </nav>

        <header>
        <h1>ç¬¬2ç«  é›»å­ãƒãƒƒãƒè¨˜éŒ²è§£æã¨é€¸è„±ç®¡ç†</h1>
        <p class="subtitle">Electronic Batch Record Analysis and Deviation Management</p>
    </header>

    <div class="container">
        <a href="index.html" class="back-link">â† ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡ã«æˆ»ã‚‹</a>

        <div class="content-box">
            <h2>ğŸ“– æœ¬ç« ã®æ¦‚è¦</h2>
            <p>
                åŒ»è–¬å“è£½é€ ã«ãŠã‘ã‚‹é›»å­ãƒãƒƒãƒè¨˜éŒ²ï¼ˆEBR: Electronic Batch Recordï¼‰ã¯ã€è£½é€ ãƒ—ãƒ­ã‚»ã‚¹ã®é€æ˜æ€§ã¨
                ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã™ã‚‹é‡è¦ãªã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚æœ¬ç« ã§ã¯ã€EBRãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•è§£æã€
                ç•°å¸¸æ¤œçŸ¥ã€æ ¹æœ¬åŸå› åˆ†æï¼ˆRCAï¼‰ã€æ˜¯æ­£æªç½®ãƒ»äºˆé˜²æªç½®ï¼ˆCAPAï¼‰ã®ææ¡ˆã¾ã§ã€
                AIã‚’æ´»ç”¨ã—ãŸåŒ…æ‹¬çš„ãªé€¸è„±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚
            </p>

            <h3>ğŸ¯ å­¦ç¿’ç›®æ¨™</h3>
            <ul>
                <li>é›»å­ãƒãƒƒãƒè¨˜éŒ²ï¼ˆEBRï¼‰ã®æ§‹é€ ã¨ãƒ‡ãƒ¼ã‚¿è§£ææ‰‹æ³•</li>
                <li>ãƒãƒƒãƒãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹å¤‰å‹•ã®å¯è¦–åŒ–</li>
                <li>æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹ç•°å¸¸ãƒãƒƒãƒã®è‡ªå‹•æ¤œå‡º</li>
                <li>æ ¹æœ¬åŸå› åˆ†æï¼ˆRCAï¼‰ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ‹ãƒ³ã‚°</li>
                <li>CAPAï¼ˆæ˜¯æ­£æªç½®ãƒ»äºˆé˜²æªç½®ï¼‰ææ¡ˆã®è‡ªå‹•ç”Ÿæˆ</li>
                <li>é€¸è„±ç®¡ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è‡ªå‹•åŒ–</li>
                <li>GMPæº–æ‹ ã®æ–‡æ›¸ç®¡ç†ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†</li>
            </ul>
        </div>

        <div class="content-box">
            <h2>ğŸ“‹ 2.1 é›»å­ãƒãƒƒãƒè¨˜éŒ²ï¼ˆEBRï¼‰ã®åŸºç¤</h2>

            <h3>EBRã®æ§‹æˆè¦ç´ </h3>
            <p>é›»å­ãƒãƒƒãƒè¨˜éŒ²ã¯ä»¥ä¸‹ã®ä¸»è¦è¦ç´ ã‹ã‚‰æ§‹æˆã•ã‚Œã¾ã™ï¼š</p>
            <ul>
                <li><strong>ãƒãƒƒãƒãƒ˜ãƒƒãƒ€</strong>: ãƒãƒƒãƒç•ªå·ã€è£½å“åã€è£½é€ æ—¥ã€ãƒ­ãƒƒãƒˆç•ªå·</li>
                <li><strong>åŸææ–™è¨˜éŒ²</strong>: ä½¿ç”¨åŸæ–™ã€æ•°é‡ã€ãƒ­ãƒƒãƒˆç•ªå·ã€æœ‰åŠ¹æœŸé™</li>
                <li><strong>å·¥ç¨‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</strong>: æ¸©åº¦ã€åœ§åŠ›ã€æ™‚é–“ã€pHã€æµé‡ãªã©</li>
                <li><strong>ä¸­é–“ä½“è©¦é¨“</strong>: å„å·¥ç¨‹ã§ã®å“è³ªç¢ºèªçµæœ</li>
                <li><strong>æœ€çµ‚è£½å“è©¦é¨“</strong>: å«é‡ã€æº¶å‡ºã€ç´”åº¦ã€å¾®ç”Ÿç‰©è©¦é¨“</li>
                <li><strong>é€¸è„±è¨˜éŒ²</strong>: ç•°å¸¸ç™ºç”Ÿã€åŸå› ã€å¯¾ç­–ã€æ‰¿èª</li>
                <li><strong>é›»å­ç½²å</strong>: ä½œæ¥­è€…ã€ç¢ºèªè€…ã€æ‰¿èªè€…ã®ç½²å</li>
            </ul>

            <div class="gmp-note">
                <strong>ğŸ­ GMPè¦ä»¶ï¼ˆ21 CFR Part 11ï¼‰</strong><br>
                ãƒ»é›»å­è¨˜éŒ²ã®çœŸæ­£æ€§ï¼ˆAuthenticityï¼‰: æ”¹ã–ã‚“é˜²æ­¢<br>
                ãƒ»å®Œå…¨æ€§ï¼ˆIntegrityï¼‰: ãƒ‡ãƒ¼ã‚¿ã®ä¸€è²«æ€§ã¨æ­£ç¢ºæ€§<br>
                ãƒ»ä¿¡é ¼æ€§ï¼ˆReliabilityï¼‰: ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šå‹•ä½œ<br>
                ãƒ»åˆ©ç”¨å¯èƒ½æ€§ï¼ˆAvailabilityï¼‰: å¿…è¦æ™‚ã®ã‚¢ã‚¯ã‚»ã‚¹ä¿è¨¼<br>
                ãƒ»ç›£æŸ»è¨¼è·¡ï¼ˆAudit Trailï¼‰: ã™ã¹ã¦ã®å¤‰æ›´å±¥æ­´ã®è¨˜éŒ²
            </div>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹2.1: EBRãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã¨ãƒãƒƒãƒãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</h3>
            <pre><code>import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime, timedelta
import json
import warnings
warnings.filterwarnings('ignore')

plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

class ElectronicBatchRecord:
    """é›»å­ãƒãƒƒãƒè¨˜éŒ²ï¼ˆEBRï¼‰ç®¡ç†ã‚¯ãƒ©ã‚¹"""

    def __init__(self, batch_id, product_name, manufacturing_date):
        self.batch_id = batch_id
        self.product_name = product_name
        self.manufacturing_date = manufacturing_date
        self.process_parameters = {}
        self.quality_tests = {}
        self.deviations = []
        self.signatures = []
        self.audit_trail = []

    def add_process_parameter(self, step_name, parameter_name, target, actual, unit, tolerance=None):
        """å·¥ç¨‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨˜éŒ²"""
        if step_name not in self.process_parameters:
            self.process_parameters[step_name] = []

        param = {
            'parameter': parameter_name,
            'target': target,
            'actual': actual,
            'unit': unit,
            'tolerance': tolerance,
            'timestamp': datetime.now().isoformat(),
            'in_spec': self._check_tolerance(target, actual, tolerance) if tolerance else True
        }

        self.process_parameters[step_name].append(param)
        self._log_audit(f"å·¥ç¨‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨˜éŒ²: {step_name} - {parameter_name}")

    def _check_tolerance(self, target, actual, tolerance):
        """è¨±å®¹ç¯„å›²ãƒã‚§ãƒƒã‚¯"""
        lower = target - tolerance
        upper = target + tolerance
        return lower <= actual <= upper

    def add_deviation(self, description, severity, root_cause=None, capa=None):
        """é€¸è„±ã®è¨˜éŒ²"""
        deviation = {
            'id': f"DEV-{self.batch_id}-{len(self.deviations)+1:03d}",
            'description': description,
            'severity': severity,  # Critical, Major, Minor
            'root_cause': root_cause,
            'capa': capa,
            'timestamp': datetime.now().isoformat(),
            'status': 'Open'
        }
        self.deviations.append(deviation)
        self._log_audit(f"é€¸è„±è¨˜éŒ²: {deviation['id']}")

    def add_signature(self, role, user_name):
        """é›»å­ç½²åã®è¨˜éŒ²"""
        signature = {
            'role': role,
            'user': user_name,
            'timestamp': datetime.now().isoformat()
        }
        self.signatures.append(signature)
        self._log_audit(f"é›»å­ç½²å: {role} by {user_name}")

    def _log_audit(self, action):
        """ç›£æŸ»è¨¼è·¡ã®è¨˜éŒ²"""
        entry = {
            'timestamp': datetime.now().isoformat(),
            'action': action
        }
        self.audit_trail.append(entry)

    def to_dict(self):
        """è¾æ›¸å½¢å¼ã¸ã®å¤‰æ›"""
        return {
            'batch_id': self.batch_id,
            'product_name': self.product_name,
            'manufacturing_date': self.manufacturing_date,
            'process_parameters': self.process_parameters,
            'quality_tests': self.quality_tests,
            'deviations': self.deviations,
            'signatures': self.signatures,
            'audit_trail': self.audit_trail
        }

    def export_json(self, filename):
        """JSONå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(self.to_dict(), f, ensure_ascii=False, indent=2)
        print(f"EBRã‚’ {filename} ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ")


class BatchTrendAnalyzer:
    """ãƒãƒƒãƒãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚¯ãƒ©ã‚¹"""

    def __init__(self):
        self.batches = []

    def generate_batch_data(self, n_batches=50):
        """ã‚µãƒ³ãƒ—ãƒ«ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ"""
        np.random.seed(42)
        start_date = datetime(2025, 1, 1)

        for i in range(n_batches):
            batch_id = f"B-2025-{i+1:04d}"
            mfg_date = (start_date + timedelta(days=i)).strftime("%Y-%m-%d")

            # æ­£å¸¸ãƒãƒƒãƒï¼ˆ1-35ï¼‰
            if i < 35:
                reaction_temp = np.random.normal(80, 1, 1)[0]
                reaction_time = np.random.normal(120, 5, 1)[0]
                yield_value = np.random.normal(95, 2, 1)[0]
                purity = np.random.normal(99.5, 0.3, 1)[0]

            # æ¸©åº¦ç•°å¸¸ãƒãƒƒãƒï¼ˆ36-40ï¼‰
            elif 35 <= i < 40:
                reaction_temp = np.random.normal(85, 2, 1)[0]  # æ¸©åº¦ä¸Šæ˜‡
                reaction_time = np.random.normal(120, 5, 1)[0]
                yield_value = np.random.normal(92, 3, 1)[0]  # åç‡ä½ä¸‹
                purity = np.random.normal(99.2, 0.5, 1)[0]

            # æ™‚é–“ç•°å¸¸ãƒãƒƒãƒï¼ˆ41-45ï¼‰
            elif 40 <= i < 45:
                reaction_temp = np.random.normal(80, 1, 1)[0]
                reaction_time = np.random.normal(140, 10, 1)[0]  # æ™‚é–“å»¶é•·
                yield_value = np.random.normal(93, 2, 1)[0]
                purity = np.random.normal(99.3, 0.4, 1)[0]

            # è¤‡åˆç•°å¸¸ãƒãƒƒãƒï¼ˆ46-50ï¼‰
            else:
                reaction_temp = np.random.normal(83, 2, 1)[0]
                reaction_time = np.random.normal(130, 8, 1)[0]
                yield_value = np.random.normal(90, 3, 1)[0]
                purity = np.random.normal(99.0, 0.6, 1)[0]

            self.batches.append({
                'batch_id': batch_id,
                'date': mfg_date,
                'reaction_temp': reaction_temp,
                'reaction_time': reaction_time,
                'yield': yield_value,
                'purity': purity
            })

        return pd.DataFrame(self.batches)

    def plot_batch_trends(self, df):
        """ãƒãƒƒãƒãƒˆãƒ¬ãƒ³ãƒ‰ã®å¯è¦–åŒ–"""
        fig, axes = plt.subplots(2, 2, figsize=(14, 10))

        batch_indices = range(len(df))

        # åå¿œæ¸©åº¦ãƒˆãƒ¬ãƒ³ãƒ‰
        axes[0, 0].plot(batch_indices, df['reaction_temp'], marker='o', color='#11998e',
                        linewidth=1.5, markersize=4)
        axes[0, 0].axhline(y=80, color='green', linestyle='--', linewidth=2, label='ç›®æ¨™å€¤ (80â„ƒ)')
        axes[0, 0].axhline(y=82, color='orange', linestyle='--', linewidth=1, alpha=0.7, label='è­¦å‘Šé™ç•Œ (Â±2â„ƒ)')
        axes[0, 0].axhline(y=78, color='orange', linestyle='--', linewidth=1, alpha=0.7)
        axes[0, 0].set_xlabel('ãƒãƒƒãƒç•ªå·')
        axes[0, 0].set_ylabel('åå¿œæ¸©åº¦ï¼ˆâ„ƒï¼‰')
        axes[0, 0].set_title('åå¿œæ¸©åº¦ãƒˆãƒ¬ãƒ³ãƒ‰', fontsize=12, fontweight='bold')
        axes[0, 0].legend()
        axes[0, 0].grid(alpha=0.3)

        # åå¿œæ™‚é–“ãƒˆãƒ¬ãƒ³ãƒ‰
        axes[0, 1].plot(batch_indices, df['reaction_time'], marker='s', color='#38ef7d',
                        linewidth=1.5, markersize=4)
        axes[0, 1].axhline(y=120, color='green', linestyle='--', linewidth=2, label='ç›®æ¨™å€¤ (120åˆ†)')
        axes[0, 1].axhline(y=130, color='orange', linestyle='--', linewidth=1, alpha=0.7, label='è­¦å‘Šé™ç•Œ (Â±10åˆ†)')
        axes[0, 1].axhline(y=110, color='orange', linestyle='--', linewidth=1, alpha=0.7)
        axes[0, 1].set_xlabel('ãƒãƒƒãƒç•ªå·')
        axes[0, 1].set_ylabel('åå¿œæ™‚é–“ï¼ˆåˆ†ï¼‰')
        axes[0, 1].set_title('åå¿œæ™‚é–“ãƒˆãƒ¬ãƒ³ãƒ‰', fontsize=12, fontweight='bold')
        axes[0, 1].legend()
        axes[0, 1].grid(alpha=0.3)

        # åç‡ãƒˆãƒ¬ãƒ³ãƒ‰
        axes[1, 0].plot(batch_indices, df['yield'], marker='^', color='#4ecdc4',
                        linewidth=1.5, markersize=4)
        axes[1, 0].axhline(y=95, color='green', linestyle='--', linewidth=2, label='ç›®æ¨™å€¤ (95%)')
        axes[1, 0].axhline(y=90, color='red', linestyle='--', linewidth=1, alpha=0.7, label='ä¸‹é™ (90%)')
        axes[1, 0].set_xlabel('ãƒãƒƒãƒç•ªå·')
        axes[1, 0].set_ylabel('åç‡ï¼ˆ%ï¼‰')
        axes[1, 0].set_title('åç‡ãƒˆãƒ¬ãƒ³ãƒ‰', fontsize=12, fontweight='bold')
        axes[1, 0].legend()
        axes[1, 0].grid(alpha=0.3)

        # ç´”åº¦ãƒˆãƒ¬ãƒ³ãƒ‰
        axes[1, 1].plot(batch_indices, df['purity'], marker='D', color='#f38181',
                        linewidth=1.5, markersize=4)
        axes[1, 1].axhline(y=99.5, color='green', linestyle='--', linewidth=2, label='ç›®æ¨™å€¤ (99.5%)')
        axes[1, 1].axhline(y=99.0, color='red', linestyle='--', linewidth=1, alpha=0.7, label='è¦æ ¼ä¸‹é™ (99.0%)')
        axes[1, 1].set_xlabel('ãƒãƒƒãƒç•ªå·')
        axes[1, 1].set_ylabel('ç´”åº¦ï¼ˆ%ï¼‰')
        axes[1, 1].set_title('ç´”åº¦ãƒˆãƒ¬ãƒ³ãƒ‰', fontsize=12, fontweight='bold')
        axes[1, 1].legend()
        axes[1, 1].grid(alpha=0.3)

        plt.tight_layout()
        plt.savefig('batch_trend_analysis.png', dpi=300, bbox_inches='tight')
        plt.show()

# å®Ÿè¡Œä¾‹
print("=" * 60)
print("é›»å­ãƒãƒƒãƒè¨˜éŒ²ï¼ˆEBRï¼‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ")
print("=" * 60)

# EBRã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
ebr = ElectronicBatchRecord(
    batch_id="B-2025-0042",
    product_name="ã‚¢ã‚¹ãƒ”ãƒªãƒ³éŒ 100mg",
    manufacturing_date="2025-10-27"
)

# å·¥ç¨‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨˜éŒ²
ebr.add_process_parameter("åå¿œ", "æ¸©åº¦", target=80, actual=80.5, unit="â„ƒ", tolerance=2)
ebr.add_process_parameter("åå¿œ", "æ™‚é–“", target=120, actual=118, unit="åˆ†", tolerance=10)
ebr.add_process_parameter("ä¹¾ç‡¥", "æ¸©åº¦", target=60, actual=61, unit="â„ƒ", tolerance=3)

# é€¸è„±ã®è¨˜éŒ²ï¼ˆä¾‹ï¼‰
ebr.add_deviation(
    description="åå¿œæ¸©åº¦ãŒä¸€æ™‚çš„ã«82â„ƒã¾ã§ä¸Šæ˜‡",
    severity="Minor",
    root_cause="æ¸©èª¿ã‚·ã‚¹ãƒ†ãƒ ã®PIDãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸é©åˆ‡",
    capa="PIDãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å†èª¿æ•´ã¨ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®š"
)

# é›»å­ç½²å
ebr.add_signature("è£½é€ æ‹…å½“", "ç”°ä¸­å¤ªéƒ")
ebr.add_signature("å“è³ªä¿è¨¼", "éˆ´æœ¨èŠ±å­")

# ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
ebr.export_json("ebr_sample.json")

print(f"\nãƒãƒƒãƒID: {ebr.batch_id}")
print(f"è£½å“å: {ebr.product_name}")
print(f"è¨˜éŒ²ã•ã‚ŒãŸå·¥ç¨‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°: {sum(len(params) for params in ebr.process_parameters.values())}")
print(f"é€¸è„±ä»¶æ•°: {len(ebr.deviations)}")
print(f"é›»å­ç½²åæ•°: {len(ebr.signatures)}")

# ãƒãƒƒãƒãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
print("\n" + "=" * 60)
print("ãƒãƒƒãƒãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ")
print("=" * 60)

analyzer = BatchTrendAnalyzer()
df_batches = analyzer.generate_batch_data(n_batches=50)

print(f"\nåˆ†æå¯¾è±¡ãƒãƒƒãƒæ•°: {len(df_batches)}")
print(f"æœŸé–“: {df_batches['date'].min()} ~ {df_batches['date'].max()}")

# çµ±è¨ˆã‚µãƒãƒªãƒ¼
print(f"\nåå¿œæ¸©åº¦: å¹³å‡ {df_batches['reaction_temp'].mean():.2f}â„ƒ, æ¨™æº–åå·® {df_batches['reaction_temp'].std():.2f}â„ƒ")
print(f"åå¿œæ™‚é–“: å¹³å‡ {df_batches['reaction_time'].mean():.1f}åˆ†, æ¨™æº–åå·® {df_batches['reaction_time'].std():.1f}åˆ†")
print(f"åç‡: å¹³å‡ {df_batches['yield'].mean():.2f}%, æ¨™æº–åå·® {df_batches['yield'].std():.2f}%")
print(f"ç´”åº¦: å¹³å‡ {df_batches['purity'].mean():.2f}%, æ¨™æº–åå·® {df_batches['purity'].std():.2f}%")

# ãƒˆãƒ¬ãƒ³ãƒ‰å¯è¦–åŒ–
analyzer.plot_batch_trends(df_batches)
</code></pre>

            <p><strong>å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:</strong></p>
            <ul>
                <li>GMPæº–æ‹ ã®EBRãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆå·¥ç¨‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€é€¸è„±ã€é›»å­ç½²åï¼‰</li>
                <li>ç›£æŸ»è¨¼è·¡ã®è‡ªå‹•è¨˜éŒ²æ©Ÿèƒ½</li>
                <li>è¨±å®¹ç¯„å›²ãƒã‚§ãƒƒã‚¯ã®è‡ªå‹•åŒ–</li>
                <li>ãƒãƒƒãƒãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã«ã‚ˆã‚‹ç•°å¸¸æ¤œå‡ºã®å¯è¦–åŒ–</li>
                <li>JSONå½¢å¼ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆç›¸äº’é‹ç”¨æ€§ï¼‰</li>
            </ul>
        </div>

        <div class="content-box">
            <h2>ğŸ” 2.2 æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹ç•°å¸¸ãƒãƒƒãƒæ¤œå‡º</h2>

            <h3>ç•°å¸¸æ¤œå‡ºã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ</h3>
            <p>ãƒãƒƒãƒè£½é€ ã«ãŠã‘ã‚‹ç•°å¸¸æ¤œå‡ºã«ã¯ã€ä»¥ä¸‹ã®æ©Ÿæ¢°å­¦ç¿’æ‰‹æ³•ãŒæœ‰åŠ¹ã§ã™ï¼š</p>
            <ul>
                <li><strong>Isolation Forest</strong>: æ•™å¸«ãªã—ç•°å¸¸æ¤œå‡ºã€å¤šå¤‰é‡ãƒ‡ãƒ¼ã‚¿ã«æœ‰åŠ¹</li>
                <li><strong>One-Class SVM</strong>: æ­£å¸¸ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§å­¦ç¿’ã€å¢ƒç•Œæ±ºå®š</li>
                <li><strong>Autoencoder</strong>: æ·±å±¤å­¦ç¿’ã«ã‚ˆã‚‹å†æ§‹æˆèª¤å·®ãƒ™ãƒ¼ã‚¹ã®æ¤œå‡º</li>
                <li><strong>Statistical Process Control</strong>: Hotelling's TÂ², MEWMA</li>
            </ul>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹2.2: Isolation Forestã«ã‚ˆã‚‹ç•°å¸¸ãƒãƒƒãƒæ¤œå‡º</h3>
            <pre><code>import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.ensemble import IsolationForest
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA
import warnings
warnings.filterwarnings('ignore')

plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

class AnomalyBatchDetector:
    """ç•°å¸¸ãƒãƒƒãƒæ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ """

    def __init__(self, contamination=0.1):
        """
        Args:
            contamination: ç•°å¸¸ãƒ‡ãƒ¼ã‚¿ã®æ¨å®šå‰²åˆï¼ˆ0.1 = 10%ï¼‰
        """
        self.contamination = contamination
        self.scaler = StandardScaler()
        self.model = IsolationForest(
            contamination=contamination,
            random_state=42,
            n_estimators=100
        )
        self.pca = PCA(n_components=2)

    def train(self, df, feature_columns):
        """
        ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´

        Args:
            df: ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
            feature_columns: ç‰¹å¾´é‡ã‚«ãƒ©ãƒ ã®ãƒªã‚¹ãƒˆ
        """
        X = df[feature_columns].values
        X_scaled = self.scaler.fit_transform(X)

        self.model.fit(X_scaled)

        # ç•°å¸¸ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
        anomaly_scores = self.model.score_samples(X_scaled)
        predictions = self.model.predict(X_scaled)

        # PCAã§2æ¬¡å…ƒã«å¤‰æ›ï¼ˆå¯è¦–åŒ–ç”¨ï¼‰
        X_pca = self.pca.fit_transform(X_scaled)

        return anomaly_scores, predictions, X_pca

    def detect_anomalies(self, df, feature_columns, anomaly_scores, predictions):
        """
        ç•°å¸¸ãƒãƒƒãƒã®ç‰¹å®š

        Args:
            df: ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
            feature_columns: ç‰¹å¾´é‡ã‚«ãƒ©ãƒ 
            anomaly_scores: ç•°å¸¸ã‚¹ã‚³ã‚¢
            predictions: äºˆæ¸¬çµæœï¼ˆ-1: ç•°å¸¸, 1: æ­£å¸¸ï¼‰

        Returns:
            ç•°å¸¸ãƒãƒƒãƒã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
        """
        df_result = df.copy()
        df_result['anomaly_score'] = anomaly_scores
        df_result['is_anomaly'] = predictions == -1

        # ç•°å¸¸ãƒãƒƒãƒã®æŠ½å‡º
        anomalies = df_result[df_result['is_anomaly']].copy()

        # ç•°å¸¸ã®é‡è¦åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã‚¹ã‚³ã‚¢ãŒä½ã„ã»ã©ç•°å¸¸ï¼‰
        anomalies = anomalies.sort_values('anomaly_score')

        return df_result, anomalies

    def plot_anomaly_detection(self, df_result, X_pca, feature_columns):
        """ç•°å¸¸æ¤œå‡ºçµæœã®å¯è¦–åŒ–"""
        fig, axes = plt.subplots(2, 2, figsize=(14, 10))

        # PCAç©ºé–“ã§ã®ãƒ—ãƒ­ãƒƒãƒˆ
        normal_mask = ~df_result['is_anomaly']
        anomaly_mask = df_result['is_anomaly']

        axes[0, 0].scatter(X_pca[normal_mask, 0], X_pca[normal_mask, 1],
                           c='green', s=30, alpha=0.6, label='æ­£å¸¸ãƒãƒƒãƒ')
        axes[0, 0].scatter(X_pca[anomaly_mask, 0], X_pca[anomaly_mask, 1],
                           c='red', s=100, alpha=0.8, marker='X', label='ç•°å¸¸ãƒãƒƒãƒ')
        axes[0, 0].set_xlabel(f'ç¬¬1ä¸»æˆåˆ† (å¯„ä¸ç‡: {self.pca.explained_variance_ratio_[0]:.1%})')
        axes[0, 0].set_ylabel(f'ç¬¬2ä¸»æˆåˆ† (å¯„ä¸ç‡: {self.pca.explained_variance_ratio_[1]:.1%})')
        axes[0, 0].set_title('PCAç©ºé–“ã§ã®ç•°å¸¸æ¤œå‡º', fontsize=12, fontweight='bold')
        axes[0, 0].legend()
        axes[0, 0].grid(alpha=0.3)

        # ç•°å¸¸ã‚¹ã‚³ã‚¢åˆ†å¸ƒ
        axes[0, 1].hist(df_result[normal_mask]['anomaly_score'], bins=30,
                        alpha=0.6, label='æ­£å¸¸', color='green')
        axes[0, 1].hist(df_result[anomaly_mask]['anomaly_score'], bins=30,
                        alpha=0.6, label='ç•°å¸¸', color='red')
        axes[0, 1].set_xlabel('ç•°å¸¸ã‚¹ã‚³ã‚¢ï¼ˆå°ã•ã„ã»ã©ç•°å¸¸ï¼‰')
        axes[0, 1].set_ylabel('é »åº¦')
        axes[0, 1].set_title('ç•°å¸¸ã‚¹ã‚³ã‚¢åˆ†å¸ƒ', fontsize=12, fontweight='bold')
        axes[0, 1].legend()
        axes[0, 1].grid(alpha=0.3)

        # æ™‚ç³»åˆ—ã§ã®ç•°å¸¸æ¤œå‡º
        batch_indices = range(len(df_result))
        colors = ['red' if x else 'green' for x in df_result['is_anomaly']]

        axes[1, 0].scatter(batch_indices, df_result['anomaly_score'],
                           c=colors, s=50, alpha=0.7)
        axes[1, 0].axhline(y=df_result['anomaly_score'].quantile(0.1), color='orange',
                           linestyle='--', linewidth=2, label='ç•°å¸¸é–¾å€¤')
        axes[1, 0].set_xlabel('ãƒãƒƒãƒç•ªå·')
        axes[1, 0].set_ylabel('ç•°å¸¸ã‚¹ã‚³ã‚¢')
        axes[1, 0].set_title('æ™‚ç³»åˆ—ç•°å¸¸æ¤œå‡º', fontsize=12, fontweight='bold')
        axes[1, 0].legend()
        axes[1, 0].grid(alpha=0.3)

        # ç‰¹å¾´é‡åˆ¥ã®ç•°å¸¸ãƒãƒƒãƒåˆ†å¸ƒ
        if len(feature_columns) >= 2:
            feat1, feat2 = feature_columns[0], feature_columns[1]

            axes[1, 1].scatter(df_result[normal_mask][feat1], df_result[normal_mask][feat2],
                               c='green', s=30, alpha=0.6, label='æ­£å¸¸ãƒãƒƒãƒ')
            axes[1, 1].scatter(df_result[anomaly_mask][feat1], df_result[anomaly_mask][feat2],
                               c='red', s=100, alpha=0.8, marker='X', label='ç•°å¸¸ãƒãƒƒãƒ')
            axes[1, 1].set_xlabel(feat1)
            axes[1, 1].set_ylabel(feat2)
            axes[1, 1].set_title(f'{feat1} vs {feat2}', fontsize=12, fontweight='bold')
            axes[1, 1].legend()
            axes[1, 1].grid(alpha=0.3)

        plt.tight_layout()
        plt.savefig('anomaly_batch_detection.png', dpi=300, bbox_inches='tight')
        plt.show()

    def generate_anomaly_report(self, anomalies, feature_columns):
        """ç•°å¸¸ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ"""
        print("\n" + "=" * 60)
        print("ç•°å¸¸ãƒãƒƒãƒæ¤œå‡ºãƒ¬ãƒãƒ¼ãƒˆ")
        print("=" * 60)

        for idx, row in anomalies.iterrows():
            print(f"\nğŸš¨ ãƒãƒƒãƒID: {row['batch_id']}")
            print(f"   è£½é€ æ—¥: {row['date']}")
            print(f"   ç•°å¸¸ã‚¹ã‚³ã‚¢: {row['anomaly_score']:.4f}")
            print(f"   å·¥ç¨‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:")

            for feat in feature_columns:
                print(f"     - {feat}: {row[feat]:.2f}")

# å®Ÿè¡Œä¾‹
print("=" * 60)
print("ç•°å¸¸ãƒãƒƒãƒæ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ï¼ˆIsolation Forestï¼‰")
print("=" * 60)

# ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆï¼ˆå‰ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‹ã‚‰å†åˆ©ç”¨ï¼‰
analyzer = BatchTrendAnalyzer()
df_batches = analyzer.generate_batch_data(n_batches=50)

# ç‰¹å¾´é‡ã®å®šç¾©
feature_columns = ['reaction_temp', 'reaction_time', 'yield', 'purity']

# ç•°å¸¸æ¤œå‡ºãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´
detector = AnomalyBatchDetector(contamination=0.15)  # 15%ãŒç•°å¸¸ã¨ä»®å®š
anomaly_scores, predictions, X_pca = detector.train(df_batches, feature_columns)

# ç•°å¸¸ãƒãƒƒãƒã®æ¤œå‡º
df_result, anomalies = detector.detect_anomalies(df_batches, feature_columns, anomaly_scores, predictions)

print(f"\nç·ãƒãƒƒãƒæ•°: {len(df_batches)}")
print(f"æ¤œå‡ºã•ã‚ŒãŸç•°å¸¸ãƒãƒƒãƒæ•°: {len(anomalies)} ({len(anomalies)/len(df_batches)*100:.1f}%)")

# å¯è¦–åŒ–
detector.plot_anomaly_detection(df_result, X_pca, feature_columns)

# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
detector.generate_anomaly_report(anomalies.head(5), feature_columns)
</code></pre>

            <p><strong>å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:</strong></p>
            <ul>
                <li>æ•™å¸«ãªã—å­¦ç¿’ã«ã‚ˆã‚‹æœªçŸ¥ã®ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º</li>
                <li>å¤šå¤‰é‡ãƒ‡ãƒ¼ã‚¿ã®çµ±åˆçš„ãªè©•ä¾¡ï¼ˆæ¸©åº¦ã€æ™‚é–“ã€åç‡ã€ç´”åº¦ï¼‰</li>
                <li>PCAã«ã‚ˆã‚‹é«˜æ¬¡å…ƒãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–</li>
                <li>ç•°å¸¸ã‚¹ã‚³ã‚¢ã«ã‚ˆã‚‹å„ªå…ˆåº¦ä»˜ã‘</li>
                <li>è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½</li>
            </ul>
        </div>

        <div class="content-box">
            <h2>ğŸ“š ã¾ã¨ã‚</h2>
            <p>æœ¬ç« ã§ã¯ã€é›»å­ãƒãƒƒãƒè¨˜éŒ²ã®è§£æã¨é€¸è„±ç®¡ç†ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸã€‚</p>

            <h3>ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆ</h3>
            <ul>
                <li>GMPæº–æ‹ ã®EBRãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã¨ç›£æŸ»è¨¼è·¡ã®å®Ÿè£…</li>
                <li>ãƒãƒƒãƒãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã«ã‚ˆã‚‹å·¥ç¨‹å¤‰å‹•ã®å¯è¦–åŒ–</li>
                <li>æ©Ÿæ¢°å­¦ç¿’ï¼ˆIsolation Forestï¼‰ã«ã‚ˆã‚‹ç•°å¸¸ãƒãƒƒãƒã®è‡ªå‹•æ¤œå‡º</li>
                <li>å¤šå¤‰é‡ãƒ‡ãƒ¼ã‚¿è§£æã«ã‚ˆã‚‹åŒ…æ‹¬çš„ãªå“è³ªè©•ä¾¡</li>
                <li>è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«ã‚ˆã‚‹ä½œæ¥­åŠ¹ç‡åŒ–</li>
            </ul>

            <div class="key-point">
                <strong>ğŸ¯ æ¬¡ç« äºˆå‘Š</strong><br>
                ç¬¬3ç« ã§ã¯ã€ãƒ—ãƒ­ã‚»ã‚¹åˆ†ææŠ€è¡“ï¼ˆPATï¼‰ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å“è³ªç®¡ç†ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚
                NIR/Ramanåˆ†å…‰åˆ†æã€å¤šå¤‰é‡çµ±è¨ˆçš„ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ï¼ˆMSPCï¼‰ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªãƒªãƒ¼ã‚¹è©¦é¨“ï¼ˆRTRTï¼‰ãªã©ã€
                ã‚ˆã‚Šé«˜åº¦ãªãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†æŠ€è¡“ã‚’ç¿’å¾—ã—ã¾ã™ã€‚
            </div>
        </div>

        <div class="nav-buttons">
            <a href="chapter-1.html">â† ç¬¬1ç« : GMPçµ±è¨ˆçš„å“è³ªç®¡ç†</a>
            <a href="chapter-3.html">ç¬¬3ç« : PATã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å“è³ªç®¡ç† â†’</a>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 AI Terakoya - ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹é“å ´</p>
        <p>ç¬¬2ç«  é›»å­ãƒãƒƒãƒè¨˜éŒ²è§£æã¨é€¸è„±ç®¡ç†</p>
    </footer>
</body>
</html>
