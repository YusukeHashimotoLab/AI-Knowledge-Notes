<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬1ç«  GMPæº–æ‹ ã®çµ±è¨ˆçš„å“è³ªç®¡ç† | ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹é“å ´</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.8; color: #333; background: #f5f5f5;
        }
        header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; padding: 2rem 1rem; text-align: center;
        }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .subtitle { opacity: 0.9; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .back-link {
            display: inline-block; margin-bottom: 2rem; padding: 0.5rem 1rem;
            background: white; color: #11998e; text-decoration: none;
            border-radius: 6px; font-weight: 600;
        }
        .content-box {
            background: white; padding: 2rem; border-radius: 12px;
            margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #11998e; margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem; border-bottom: 3px solid #11998e;
        }
        h3 { color: #2c3e50; margin: 1.5rem 0 1rem 0; }
        p { margin-bottom: 1rem; }
        ul, ol { margin-left: 2rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
        pre {
            background: #1e1e1e; color: #d4d4d4; padding: 1.5rem;
            border-radius: 8px; overflow-x: auto; margin: 1rem 0;
            border-left: 4px solid #11998e;
        }
        code {
            font-family: 'Courier New', monospace; font-size: 0.9rem;
        }
        .key-point {
            background: #e8f5e9; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #4caf50; margin: 1rem 0;
        }
        .gmp-note {
            background: #fff3e0; padding: 1rem; border-radius: 6px;
            border-left: 4px solid #ff9800; margin: 1rem 0;
        }
        .formula {
            background: #f0f7ff; padding: 1rem; border-radius: 6px;
            margin: 1rem 0; overflow-x: auto;
        }
        .nav-buttons {
            display: flex; justify-content: space-between; margin-top: 3rem;
        }
        .nav-buttons a {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; text-decoration: none; border-radius: 6px;
            font-weight: 600;
        }
        footer {
            background: #2c3e50; color: white; text-align: center;
            padding: 2rem 1rem; margin-top: 4rem;
        }
        table {
            width: 100%; border-collapse: collapse; margin: 1rem 0;
        }
        th, td {
            border: 1px solid #ddd; padding: 0.75rem; text-align: left;
        }
        th {
            background: #11998e; color: white;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
    
        
    
        /* Breadcrumb styles */
        .breadcrumb {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .breadcrumb-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a0aec0;
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: #4a5568;
            font-weight: 500;
        }
    </style>
</head>
<body>
            <nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="../../index.html">AIå¯ºå­å±‹ãƒˆãƒƒãƒ—</a><span class="breadcrumb-separator">â€º</span><a href="../../PI/index.html">ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹</a><span class="breadcrumb-separator">â€º</span><a href="../../PI/pharma-manufacturing-ai/index.html">Pharma Manufacturing Ai</a><span class="breadcrumb-separator">â€º</span><span class="breadcrumb-current">Chapter 1</span>
        </div>
    </nav>

        <header>
        <h1>ç¬¬1ç«  GMPæº–æ‹ ã®çµ±è¨ˆçš„å“è³ªç®¡ç†</h1>
        <p class="subtitle">Statistical Quality Control under GMP Requirements</p>
    </header>

    <div class="container">
        <a href="index.html" class="back-link">â† ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡ã«æˆ»ã‚‹</a>

        <div class="content-box">
            <h2>ğŸ“– æœ¬ç« ã®æ¦‚è¦</h2>
            <p>
                åŒ»è–¬å“è£½é€ ã«ãŠã„ã¦ã¯ã€GMPï¼ˆGood Manufacturing Practiceï¼‰ã«åŸºã¥ãå³æ ¼ãªå“è³ªç®¡ç†ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚
                æœ¬ç« ã§ã¯ã€çµ±è¨ˆçš„ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ï¼ˆSPCï¼‰ã€å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ï¼ˆCp/Cpkï¼‰ã€ç¶™ç¶šçš„ãƒ—ãƒ­ã‚»ã‚¹ãƒ™ãƒªãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆCPVï¼‰ã€
                å¹´æ¬¡è£½å“ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆAPRï¼‰ãªã©ã€GMPæº–æ‹ ã®çµ±è¨ˆçš„å“è³ªç®¡ç†æ‰‹æ³•ã‚’Pythonã§å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚
            </p>

            <h3>ğŸ¯ å­¦ç¿’ç›®æ¨™</h3>
            <ul>
                <li>GMPè¦ä»¶ã‚’æº€ãŸã™çµ±è¨ˆçš„ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ï¼ˆSPCï¼‰ã®å®Ÿè£…</li>
                <li>ç®¡ç†å›³ï¼ˆX-R chartã€X-Ïƒ chartã€CUSUMã€EWMAï¼‰ã®è‡ªå‹•ç”Ÿæˆ</li>
                <li>å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ï¼ˆCpã€Cpkã€Ppã€Ppkï¼‰ã®è¨ˆç®—ã¨è©•ä¾¡</li>
                <li>ç¶™ç¶šçš„ãƒ—ãƒ­ã‚»ã‚¹ãƒ™ãƒªãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆCPVï¼‰ã®è‡ªå‹•åŒ–</li>
                <li>å¹´æ¬¡è£½å“ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆAPRï¼‰ãƒ‡ãƒ¼ã‚¿é›†è¨ˆã®åŠ¹ç‡åŒ–</li>
                <li>é€¸è„±æ¤œå‡ºã¨ç®¡ç†é™ç•Œè¶…éã®è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆ</li>
                <li>ç›£æŸ»è¨¼è·¡ï¼ˆAudit Trailï¼‰ã®è¨˜éŒ²å®Ÿè£…</li>
            </ul>
        </div>

        <div class="content-box">
            <h2>ğŸ“Š 1.1 GMPè¦ä»¶ã¨çµ±è¨ˆçš„å“è³ªç®¡ç†ã®åŸºç¤</h2>

            <h3>GMPè¦åˆ¶ã«ãŠã‘ã‚‹å“è³ªç®¡ç†è¦ä»¶</h3>
            <p>åŒ»è–¬å“è£½é€ ã§ã¯ã€ä»¥ä¸‹ã®GMPè¦ä»¶ã‚’æº€ãŸã™å“è³ªç®¡ç†ãŒå¿…è¦ã§ã™ï¼š</p>
            <ul>
                <li><strong>PIC/S GMP Annex 15</strong>: é©æ ¼æ€§è©•ä¾¡ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</li>
                <li><strong>ICH Q7</strong>: åŸè–¬GMPã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³</li>
                <li><strong>ICH Q8-Q11</strong>: å“è³ªãƒªã‚¹ã‚¯ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã€QbDï¼ˆQuality by Designï¼‰</li>
                <li><strong>FDA 21 CFR Part 211</strong>: å®ŒæˆåŒ»è–¬å“ã®GMPè¦åˆ¶</li>
                <li><strong>EU GMP Annex 11</strong>: ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿åŒ–ã‚·ã‚¹ãƒ†ãƒ </li>
            </ul>

            <div class="gmp-note">
                <strong>ğŸ­ GMPæº–æ‹ ã®ãƒã‚¤ãƒ³ãƒˆ</strong><br>
                ãƒ»ã™ã¹ã¦ã®å·¥ç¨‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨˜éŒ²ã¨ä¿ç®¡ï¼ˆæœ€ä½3å¹´é–“ï¼‰<br>
                ãƒ»é€¸è„±ç™ºç”Ÿæ™‚ã®æ ¹æœ¬åŸå› åˆ†æï¼ˆRCAï¼‰ã¨æ˜¯æ­£æªç½®ï¼ˆCAPAï¼‰<br>
                ãƒ»ç¶™ç¶šçš„ãƒ—ãƒ­ã‚»ã‚¹ãƒ™ãƒªãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆCPVï¼‰ã®å®Ÿæ–½<br>
                ãƒ»å¹´æ¬¡è£½å“ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆAPRï¼‰ã«ã‚ˆã‚‹å®šæœŸçš„ãªå“è³ªè©•ä¾¡<br>
                ãƒ»ç›£æŸ»è¨¼è·¡ã®å®Œå…¨æ€§ç¢ºä¿ï¼ˆèª°ãŒã€ã„ã¤ã€ä½•ã‚’å¤‰æ›´ã—ãŸã‹ï¼‰
            </div>

            <h3>çµ±è¨ˆçš„ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ï¼ˆSPCï¼‰ã®åŸºæœ¬æ¦‚å¿µ</h3>
            <div class="formula">
                <h4>ç®¡ç†é™ç•Œã®è¨ˆç®—</h4>
                $$ \text{UCL}_{\bar{X}} = \bar{\bar{X}} + A_2 \bar{R} $$
                $$ \text{CL}_{\bar{X}} = \bar{\bar{X}} $$
                $$ \text{LCL}_{\bar{X}} = \bar{\bar{X}} - A_2 \bar{R} $$
                <p>
                    ã“ã“ã§ã€\( \bar{\bar{X}} \) ã¯å…¨ã‚µãƒ³ãƒ—ãƒ«ã®å¹³å‡ã®å¹³å‡ã€\( \bar{R} \) ã¯ç¯„å›²ã®å¹³å‡ã€
                    \( A_2 \) ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã«å¿œã˜ãŸå®šæ•°ï¼ˆn=5ã®å ´åˆã€A_2=0.577ï¼‰
                </p>
            </div>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹1.1: X-Rç®¡ç†å›³ã®è‡ªå‹•ç”Ÿæˆï¼ˆGMPæº–æ‹ ç‰ˆï¼‰</h3>
            <pre><code>import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime, timedelta
import json
import warnings
warnings.filterwarnings('ignore')

plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

class GMPControlChart:
    """GMPæº–æ‹ ã®X-Rç®¡ç†å›³ã‚¯ãƒ©ã‚¹ï¼ˆç›£æŸ»è¨¼è·¡æ©Ÿèƒ½ä»˜ãï¼‰"""

    def __init__(self, product_name, batch_prefix, specification_limits):
        """
        Args:
            product_name: è£½å“å
            batch_prefix: ãƒãƒƒãƒç•ªå·ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
            specification_limits: è¦æ ¼å€¤ (lower, upper)
        """
        self.product_name = product_name
        self.batch_prefix = batch_prefix
        self.spec_lower, self.spec_upper = specification_limits
        self.audit_trail = []  # ç›£æŸ»è¨¼è·¡

        # SPCãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        self.A2_table = {2: 1.880, 3: 1.023, 4: 0.729, 5: 0.577}
        self.D3_table = {2: 0, 3: 0, 4: 0, 5: 0}
        self.D4_table = {2: 3.267, 3: 2.574, 4: 2.282, 5: 2.114}

    def _log_audit(self, action, user="System", details=None):
        """ç›£æŸ»è¨¼è·¡ã®è¨˜éŒ²"""
        entry = {
            "timestamp": datetime.now().isoformat(),
            "user": user,
            "action": action,
            "details": details or {}
        }
        self.audit_trail.append(entry)

    def generate_sample_data(self, n_batches=30, samples_per_batch=5):
        """ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆéŒ å‰¤é‡é‡ã‚’æƒ³å®šï¼‰"""
        np.random.seed(42)

        batches = []
        batch_dates = []
        start_date = datetime(2025, 1, 1)

        # ç®¡ç†çŠ¶æ…‹ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒãƒƒãƒ1-20ï¼‰
        for i in range(20):
            batch_id = f"{self.batch_prefix}{i+1:04d}"
            batch_date = start_date + timedelta(days=i)
            samples = np.random.normal(200, 2, samples_per_batch)  # å¹³å‡200mgã€æ¨™æº–åå·®2mg

            batches.append({
                'batch_id': batch_id,
                'date': batch_date,
                'samples': samples,
                'mean': np.mean(samples),
                'range': np.ptp(samples)
            })
            batch_dates.append(batch_date)

        # è»½å¾®ãªå¹³å‡ã‚·ãƒ•ãƒˆï¼ˆãƒãƒƒãƒ21-25ï¼‰
        for i in range(20, 25):
            batch_id = f"{self.batch_prefix}{i+1:04d}"
            batch_date = start_date + timedelta(days=i)
            samples = np.random.normal(202, 2, samples_per_batch)  # å¹³å‡ãŒ2mgä¸Šæ˜‡

            batches.append({
                'batch_id': batch_id,
                'date': batch_date,
                'samples': samples,
                'mean': np.mean(samples),
                'range': np.ptp(samples)
            })
            batch_dates.append(batch_date)

        # ã°ã‚‰ã¤ãå¢—åŠ ï¼ˆãƒãƒƒãƒ26-30ï¼‰
        for i in range(25, n_batches):
            batch_id = f"{self.batch_prefix}{i+1:04d}"
            batch_date = start_date + timedelta(days=i)
            samples = np.random.normal(200, 4, samples_per_batch)  # æ¨™æº–åå·®ãŒå€å¢—

            batches.append({
                'batch_id': batch_id,
                'date': batch_date,
                'samples': samples,
                'mean': np.mean(samples),
                'range': np.ptp(samples)
            })
            batch_dates.append(batch_date)

        df = pd.DataFrame(batches)
        self._log_audit("ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ", details={"n_batches": n_batches, "samples_per_batch": samples_per_batch})

        return df

    def calculate_control_limits(self, df, samples_per_batch=5):
        """ç®¡ç†é™ç•Œã®è¨ˆç®—"""
        # å…¨ä½“å¹³å‡ã¨ç¯„å›²å¹³å‡
        X_bar_bar = df['mean'].mean()
        R_bar = df['range'].mean()

        # å®šæ•°ã®å–å¾—
        A2 = self.A2_table[samples_per_batch]
        D3 = self.D3_table[samples_per_batch]
        D4 = self.D4_table[samples_per_batch]

        # X-barç®¡ç†å›³ã®ç®¡ç†é™ç•Œ
        UCL_X = X_bar_bar + A2 * R_bar
        CL_X = X_bar_bar
        LCL_X = X_bar_bar - A2 * R_bar

        # Rç®¡ç†å›³ã®ç®¡ç†é™ç•Œ
        UCL_R = D4 * R_bar
        CL_R = R_bar
        LCL_R = D3 * R_bar

        control_limits = {
            'X': {'UCL': UCL_X, 'CL': CL_X, 'LCL': LCL_X},
            'R': {'UCL': UCL_R, 'CL': CL_R, 'LCL': LCL_R}
        }

        self._log_audit("ç®¡ç†é™ç•Œè¨ˆç®—", details=control_limits)

        return control_limits

    def detect_out_of_control(self, df, control_limits):
        """ç®¡ç†é™ç•Œè¶…éã®æ¤œå‡º"""
        violations = []

        for idx, row in df.iterrows():
            # X-barç®¡ç†å›³ã®é•å
            if row['mean'] > control_limits['X']['UCL']:
                violations.append({
                    'batch_id': row['batch_id'],
                    'type': 'X-bar UCLè¶…é',
                    'value': row['mean'],
                    'limit': control_limits['X']['UCL']
                })
            elif row['mean'] < control_limits['X']['LCL']:
                violations.append({
                    'batch_id': row['batch_id'],
                    'type': 'X-bar LCLæœªé”',
                    'value': row['mean'],
                    'limit': control_limits['X']['LCL']
                })

            # Rç®¡ç†å›³ã®é•å
            if row['range'] > control_limits['R']['UCL']:
                violations.append({
                    'batch_id': row['batch_id'],
                    'type': 'R UCLè¶…éï¼ˆã°ã‚‰ã¤ãå¢—åŠ ï¼‰',
                    'value': row['range'],
                    'limit': control_limits['R']['UCL']
                })

        if violations:
            self._log_audit("ç®¡ç†é™ç•Œé•åæ¤œå‡º", details={"violations_count": len(violations)})

        return violations

    def plot_control_chart(self, df, control_limits):
        """X-Rç®¡ç†å›³ã®ãƒ—ãƒ­ãƒƒãƒˆ"""
        fig, axes = plt.subplots(2, 1, figsize=(14, 10))

        batch_indices = range(len(df))

        # X-barç®¡ç†å›³
        axes[0].plot(batch_indices, df['mean'], marker='o', color='#11998e',
                     linewidth=2, markersize=6, label='ãƒãƒƒãƒå¹³å‡')
        axes[0].axhline(y=control_limits['X']['UCL'], color='red', linestyle='--',
                        linewidth=2, label=f"UCL = {control_limits['X']['UCL']:.2f}")
        axes[0].axhline(y=control_limits['X']['CL'], color='green', linestyle='-',
                        linewidth=2, label=f"CL = {control_limits['X']['CL']:.2f}")
        axes[0].axhline(y=control_limits['X']['LCL'], color='red', linestyle='--',
                        linewidth=2, label=f"LCL = {control_limits['X']['LCL']:.2f}")

        # è¦æ ¼é™ç•Œã®è¡¨ç¤º
        axes[0].axhline(y=self.spec_upper, color='orange', linestyle=':',
                        linewidth=1.5, alpha=0.7, label=f"è¦æ ¼ä¸Šé™ = {self.spec_upper}")
        axes[0].axhline(y=self.spec_lower, color='orange', linestyle=':',
                        linewidth=1.5, alpha=0.7, label=f"è¦æ ¼ä¸‹é™ = {self.spec_lower}")

        axes[0].set_xlabel('ãƒãƒƒãƒç•ªå·')
        axes[0].set_ylabel('éŒ å‰¤é‡é‡å¹³å‡ï¼ˆmgï¼‰')
        axes[0].set_title(f'X-barç®¡ç†å›³ - {self.product_name}', fontsize=12, fontweight='bold')
        axes[0].legend(loc='upper right', fontsize=9)
        axes[0].grid(alpha=0.3)

        # Rç®¡ç†å›³
        axes[1].plot(batch_indices, df['range'], marker='s', color='#38ef7d',
                     linewidth=2, markersize=6, label='ãƒãƒƒãƒç¯„å›²')
        axes[1].axhline(y=control_limits['R']['UCL'], color='red', linestyle='--',
                        linewidth=2, label=f"UCL = {control_limits['R']['UCL']:.2f}")
        axes[1].axhline(y=control_limits['R']['CL'], color='green', linestyle='-',
                        linewidth=2, label=f"CL = {control_limits['R']['CL']:.2f}")
        axes[1].axhline(y=control_limits['R']['LCL'], color='red', linestyle='--',
                        linewidth=2, label=f"LCL = {control_limits['R']['LCL']:.2f}")

        axes[1].set_xlabel('ãƒãƒƒãƒç•ªå·')
        axes[1].set_ylabel('ç¯„å›² Rï¼ˆmgï¼‰')
        axes[1].set_title('Rç®¡ç†å›³ - ãƒ—ãƒ­ã‚»ã‚¹ã°ã‚‰ã¤ã', fontsize=12, fontweight='bold')
        axes[1].legend(loc='upper right', fontsize=9)
        axes[1].grid(alpha=0.3)

        plt.tight_layout()
        plt.savefig('gmp_xr_control_chart.png', dpi=300, bbox_inches='tight')
        plt.show()

        self._log_audit("ç®¡ç†å›³ä½œæˆ", details={"chart_type": "X-R"})

    def export_audit_trail(self, filename="audit_trail.json"):
        """ç›£æŸ»è¨¼è·¡ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(self.audit_trail, f, ensure_ascii=False, indent=2)
        print(f"ç›£æŸ»è¨¼è·¡ã‚’ {filename} ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ")

# å®Ÿè¡Œä¾‹
print("=" * 60)
print("GMPæº–æ‹ X-Rç®¡ç†å›³ã‚·ã‚¹ãƒ†ãƒ ")
print("=" * 60)

# ç®¡ç†å›³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
chart = GMPControlChart(
    product_name="ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³éŒ 200mg",
    batch_prefix="AP-",
    specification_limits=(190, 210)  # è¦æ ¼: 200Â±10mg
)

# ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
df = chart.generate_sample_data(n_batches=30, samples_per_batch=5)

print(f"\nè£½å“å: {chart.product_name}")
print(f"ç·ãƒãƒƒãƒæ•°: {len(df)}")
print(f"è¦æ ¼é™ç•Œ: {chart.spec_lower}-{chart.spec_upper} mg")

# ç®¡ç†é™ç•Œè¨ˆç®—
control_limits = chart.calculate_control_limits(df, samples_per_batch=5)

print(f"\nX-barç®¡ç†é™ç•Œ:")
print(f"  UCL = {control_limits['X']['UCL']:.2f} mg")
print(f"  CL  = {control_limits['X']['CL']:.2f} mg")
print(f"  LCL = {control_limits['X']['LCL']:.2f} mg")

print(f"\nRç®¡ç†é™ç•Œ:")
print(f"  UCL = {control_limits['R']['UCL']:.2f} mg")
print(f"  CL  = {control_limits['R']['CL']:.2f} mg")
print(f"  LCL = {control_limits['R']['LCL']:.2f} mg")

# é•åæ¤œå‡º
violations = chart.detect_out_of_control(df, control_limits)

if violations:
    print(f"\nâš ï¸ ç®¡ç†é™ç•Œé•åã‚’ {len(violations)} ä»¶æ¤œå‡º:")
    for v in violations[:5]:  # æœ€åˆã®5ä»¶ã‚’è¡¨ç¤º
        print(f"  - {v['batch_id']}: {v['type']} (å€¤: {v['value']:.2f}, é™ç•Œ: {v['limit']:.2f})")
else:
    print("\nâœ… ã™ã¹ã¦ã®ãƒãƒƒãƒãŒç®¡ç†é™ç•Œå†…ã§ã™")

# ç®¡ç†å›³ãƒ—ãƒ­ãƒƒãƒˆ
chart.plot_control_chart(df, control_limits)

# ç›£æŸ»è¨¼è·¡ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
chart.export_audit_trail("audit_trail_xr_chart.json")

print(f"\nç›£æŸ»è¨¼è·¡è¨˜éŒ²æ•°: {len(chart.audit_trail)}")
</code></pre>

            <p><strong>å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:</strong></p>
            <ul>
                <li>GMPè¦ä»¶ã‚’æº€ãŸã™ç›£æŸ»è¨¼è·¡ï¼ˆAudit Trailï¼‰æ©Ÿèƒ½ã®å®Ÿè£…</li>
                <li>ç®¡ç†é™ç•Œã¨è¦æ ¼é™ç•Œã®ä¸¡æ–¹ã‚’å¯è¦–åŒ–</li>
                <li>è‡ªå‹•çš„ãªé€¸è„±æ¤œå‡ºã¨ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½</li>
                <li>ãƒãƒƒãƒãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã®ç¢ºä¿ï¼ˆãƒãƒƒãƒIDã€æ—¥ä»˜è¨˜éŒ²ï¼‰</li>
                <li>JSONå½¢å¼ã§ã®ç›£æŸ»è¨¼è·¡ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</li>
            </ul>
        </div>

        <div class="content-box">
            <h2>ğŸ“ˆ 1.2 å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ã®è¨ˆç®—ã¨è©•ä¾¡</h2>

            <h3>å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ã®å®šç¾©</h3>
            <div class="formula">
                <h4>çŸ­æœŸå·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ï¼ˆCpã€Cpkï¼‰</h4>
                $$ C_p = \frac{\text{USL} - \text{LSL}}{6\sigma} $$
                $$ C_{pk} = \min\left(\frac{\text{USL} - \mu}{3\sigma}, \frac{\mu - \text{LSL}}{3\sigma}\right) $$

                <h4>é•·æœŸå·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ï¼ˆPpã€Ppkï¼‰</h4>
                $$ P_p = \frac{\text{USL} - \text{LSL}}{6s} $$
                $$ P_{pk} = \min\left(\frac{\text{USL} - \bar{x}}{3s}, \frac{\bar{x} - \text{LSL}}{3s}\right) $$

                <p>
                    USL: è¦æ ¼ä¸Šé™ã€LSL: è¦æ ¼ä¸‹é™ã€Î¼: ãƒ—ãƒ­ã‚»ã‚¹å¹³å‡ã€Ïƒ: ãƒ—ãƒ­ã‚»ã‚¹æ¨™æº–åå·®ï¼ˆç¾¤å†…ï¼‰ã€
                    s: å…¨ä½“æ¨™æº–åå·®
                </p>
            </div>

            <div class="key-point">
                <strong>ğŸ’¡ å·¥ç¨‹èƒ½åŠ›ã®è©•ä¾¡åŸºæº–</strong><br>
                ãƒ»Cpk â‰¥ 1.67: å„ªç§€ï¼ˆ6Ïƒå“è³ªãƒ¬ãƒ™ãƒ«ï¼‰<br>
                ãƒ»Cpk â‰¥ 1.33: è‰¯å¥½ï¼ˆGMPæ¨å¥¨æ°´æº–ï¼‰<br>
                ãƒ»Cpk â‰¥ 1.00: æœ€ä½é™è¨±å®¹å¯èƒ½<br>
                ãƒ»Cpk < 1.00: ä¸åˆæ ¼ï¼ˆæ”¹å–„å¿…é ˆï¼‰<br>
                â€»åŒ»è–¬å“è£½é€ ã§ã¯Cpk â‰¥ 1.33ãŒä¸€èˆ¬çš„ãªè¦æ±‚æ°´æº–
            </div>

            <h3>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹1.2: å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ã®è‡ªå‹•è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ </h3>
            <pre><code>import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy import stats
import warnings
warnings.filterwarnings('ignore')

plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

class ProcessCapabilityAnalyzer:
    """å·¥ç¨‹èƒ½åŠ›è§£æã‚¯ãƒ©ã‚¹ï¼ˆGMPæº–æ‹ ï¼‰"""

    def __init__(self, spec_lower, spec_upper, target=None):
        """
        Args:
            spec_lower: è¦æ ¼ä¸‹é™ï¼ˆLSLï¼‰
            spec_upper: è¦æ ¼ä¸Šé™ï¼ˆUSLï¼‰
            target: ç›®æ¨™å€¤ï¼ˆæŒ‡å®šã—ãªã„å ´åˆã¯ä¸­å¿ƒå€¤ï¼‰
        """
        self.LSL = spec_lower
        self.USL = spec_upper
        self.target = target if target is not None else (spec_lower + spec_upper) / 2

    def calculate_capability_indices(self, data, subgroup_size=5):
        """
        å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ã®è¨ˆç®—

        Args:
            data: æ¸¬å®šãƒ‡ãƒ¼ã‚¿ï¼ˆ1æ¬¡å…ƒé…åˆ—ï¼‰
            subgroup_size: ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã‚µã‚¤ã‚ºï¼ˆCp/Cpkè¨ˆç®—ç”¨ï¼‰

        Returns:
            dict: å„ç¨®å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°
        """
        # åŸºæœ¬çµ±è¨ˆé‡
        n = len(data)
        mean = np.mean(data)
        std_overall = np.std(data, ddof=1)  # å…¨ä½“æ¨™æº–åå·®ï¼ˆPp/Ppkç”¨ï¼‰

        # ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—æ¨™æº–åå·®ã®æ¨å®šï¼ˆCp/Cpkç”¨ï¼‰
        n_subgroups = n // subgroup_size
        subgroups = data[:n_subgroups * subgroup_size].reshape(n_subgroups, subgroup_size)
        R_bar = np.mean([np.ptp(sg) for sg in subgroups])  # å¹³å‡ç¯„å›²

        # d2å®šæ•°ï¼ˆã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã«å¿œã˜ãŸå®šæ•°ï¼‰
        d2_table = {2: 1.128, 3: 1.693, 4: 2.059, 5: 2.326, 6: 2.534}
        d2 = d2_table.get(subgroup_size, 2.326)

        sigma_within = R_bar / d2  # ç¾¤å†…æ¨™æº–åå·®

        # Cpã€Cpkã®è¨ˆç®—
        Cp = (self.USL - self.LSL) / (6 * sigma_within)
        Cpu = (self.USL - mean) / (3 * sigma_within)
        Cpl = (mean - self.LSL) / (3 * sigma_within)
        Cpk = min(Cpu, Cpl)

        # Ppã€Ppkã®è¨ˆç®—
        Pp = (self.USL - self.LSL) / (6 * std_overall)
        Ppu = (self.USL - mean) / (3 * std_overall)
        Ppl = (mean - self.LSL) / (3 * std_overall)
        Ppk = min(Ppu, Ppl)

        # Cmã®è¨ˆç®—ï¼ˆä¸­å¿ƒåŒ–èƒ½åŠ›æŒ‡æ•°ï¼‰
        Cm = (self.USL - self.LSL) / (6 * np.abs(mean - self.target)) if mean != self.target else np.inf

        # ä¸è‰¯ç‡ã®æ¨å®šï¼ˆæ­£è¦åˆ†å¸ƒã‚’ä»®å®šï¼‰
        z_usl = (self.USL - mean) / std_overall
        z_lsl = (mean - self.LSL) / std_overall
        ppm_upper = (1 - stats.norm.cdf(z_usl)) * 1e6
        ppm_lower = (1 - stats.norm.cdf(z_lsl)) * 1e6
        ppm_total = ppm_upper + ppm_lower

        results = {
            'n': n,
            'mean': mean,
            'std_overall': std_overall,
            'std_within': sigma_within,
            'Cp': Cp,
            'Cpk': Cpk,
            'Cpu': Cpu,
            'Cpl': Cpl,
            'Pp': Pp,
            'Ppk': Ppk,
            'Ppu': Ppu,
            'Ppl': Ppl,
            'Cm': Cm,
            'ppm_upper': ppm_upper,
            'ppm_lower': ppm_lower,
            'ppm_total': ppm_total
        }

        return results

    def evaluate_capability(self, cpk_value):
        """å·¥ç¨‹èƒ½åŠ›ã®è©•ä¾¡"""
        if cpk_value >= 1.67:
            return "å„ªç§€ï¼ˆ6Ïƒãƒ¬ãƒ™ãƒ«ï¼‰", "green"
        elif cpk_value >= 1.33:
            return "è‰¯å¥½ï¼ˆGMPæ¨å¥¨æ°´æº–ï¼‰", "#38ef7d"
        elif cpk_value >= 1.00:
            return "æœ€ä½é™è¨±å®¹", "orange"
        else:
            return "ä¸åˆæ ¼ï¼ˆæ”¹å–„å¿…é ˆï¼‰", "red"

    def plot_capability_analysis(self, data, results):
        """å·¥ç¨‹èƒ½åŠ›è§£æã®å¯è¦–åŒ–"""
        fig, axes = plt.subplots(2, 2, figsize=(14, 10))

        # ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã¨æ­£è¦åˆ†å¸ƒ
        ax1 = axes[0, 0]
        ax1.hist(data, bins=30, density=True, alpha=0.7, color='#11998e', edgecolor='black')

        # æ­£è¦åˆ†å¸ƒãƒ•ã‚£ãƒƒãƒˆ
        x = np.linspace(data.min(), data.max(), 200)
        ax1.plot(x, stats.norm.pdf(x, results['mean'], results['std_overall']),
                 'r-', linewidth=2, label='æ­£è¦åˆ†å¸ƒãƒ•ã‚£ãƒƒãƒˆ')

        # è¦æ ¼é™ç•Œ
        ax1.axvline(self.LSL, color='red', linestyle='--', linewidth=2, label=f'LSL = {self.LSL}')
        ax1.axvline(self.USL, color='red', linestyle='--', linewidth=2, label=f'USL = {self.USL}')
        ax1.axvline(self.target, color='green', linestyle=':', linewidth=2, label=f'ç›®æ¨™ = {self.target}')
        ax1.axvline(results['mean'], color='blue', linestyle='-', linewidth=2, label=f'å¹³å‡ = {results["mean"]:.2f}')

        ax1.set_xlabel('æ¸¬å®šå€¤')
        ax1.set_ylabel('ç¢ºç‡å¯†åº¦')
        ax1.set_title('ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã¨è¦æ ¼é™ç•Œ', fontsize=12, fontweight='bold')
        ax1.legend(fontsize=9)
        ax1.grid(alpha=0.3)

        # æ­£è¦ç¢ºç‡ãƒ—ãƒ­ãƒƒãƒˆ
        ax2 = axes[0, 1]
        stats.probplot(data, dist="norm", plot=ax2)
        ax2.set_title('æ­£è¦ç¢ºç‡ãƒ—ãƒ­ãƒƒãƒˆ', fontsize=12, fontweight='bold')
        ax2.grid(alpha=0.3)

        # å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ã®æ£’ã‚°ãƒ©ãƒ•
        ax3 = axes[1, 0]
        indices = ['Cp', 'Cpk', 'Pp', 'Ppk']
        values = [results['Cp'], results['Cpk'], results['Pp'], results['Ppk']]
        colors_bar = ['#11998e', '#38ef7d', '#11998e', '#38ef7d']

        bars = ax3.bar(indices, values, color=colors_bar, alpha=0.8, edgecolor='black')
        ax3.axhline(y=1.33, color='green', linestyle='--', linewidth=2, label='GMPæ¨å¥¨æ°´æº– (1.33)')
        ax3.axhline(y=1.00, color='orange', linestyle='--', linewidth=1.5, label='æœ€ä½è¨±å®¹ (1.00)')

        # å€¤ã®ãƒ©ãƒ™ãƒ«è¡¨ç¤º
        for bar, val in zip(bars, values):
            height = bar.get_height()
            ax3.text(bar.get_x() + bar.get_width()/2., height,
                     f'{val:.2f}', ha='center', va='bottom', fontweight='bold')

        ax3.set_ylabel('æŒ‡æ•°å€¤')
        ax3.set_title('å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°', fontsize=12, fontweight='bold')
        ax3.legend()
        ax3.grid(axis='y', alpha=0.3)

        # ã‚µãƒãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ
        ax4 = axes[1, 1]
        ax4.axis('off')

        evaluation, color = self.evaluate_capability(results['Cpk'])

        summary_text = f"""
å·¥ç¨‹èƒ½åŠ›è§£æã‚µãƒãƒªãƒ¼

ã‚µãƒ³ãƒ—ãƒ«æ•°: {results['n']}
å¹³å‡å€¤: {results['mean']:.2f}
æ¨™æº–åå·®ï¼ˆå…¨ä½“ï¼‰: {results['std_overall']:.2f}
æ¨™æº–åå·®ï¼ˆç¾¤å†…ï¼‰: {results['std_within']:.2f}

è¦æ ¼é™ç•Œ:
  LSL = {self.LSL}
  USL = {self.USL}
  ç›®æ¨™ = {self.target}

çŸ­æœŸå·¥ç¨‹èƒ½åŠ›:
  Cp  = {results['Cp']:.2f}
  Cpk = {results['Cpk']:.2f}

é•·æœŸå·¥ç¨‹èƒ½åŠ›:
  Pp  = {results['Pp']:.2f}
  Ppk = {results['Ppk']:.2f}

æ¨å®šä¸è‰¯ç‡:
  ä¸Šé™è¶…é: {results['ppm_upper']:.0f} ppm
  ä¸‹é™æœªé”: {results['ppm_lower']:.0f} ppm
  åˆè¨ˆ: {results['ppm_total']:.0f} ppm

è©•ä¾¡: {evaluation}
        """

        ax4.text(0.1, 0.5, summary_text, fontsize=10, verticalalignment='center',
                 family='monospace', bbox=dict(boxstyle='round', facecolor=color, alpha=0.2))

        plt.tight_layout()
        plt.savefig('process_capability_analysis.png', dpi=300, bbox_inches='tight')
        plt.show()

# å®Ÿè¡Œä¾‹
print("=" * 60)
print("å·¥ç¨‹èƒ½åŠ›è§£æã‚·ã‚¹ãƒ†ãƒ ï¼ˆGMPæº–æ‹ ï¼‰")
print("=" * 60)

# ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³éŒ ã®å«é‡è©¦é¨“ã‚’æƒ³å®šï¼‰
np.random.seed(42)
n_samples = 150  # 30ãƒãƒƒãƒ Ã— 5ã‚µãƒ³ãƒ—ãƒ«/ãƒãƒƒãƒ

# ãƒ—ãƒ­ã‚»ã‚¹ãŒå®‰å®šã—ã¦ã„ã‚‹å ´åˆ
data_stable = np.random.normal(100.0, 1.5, n_samples)  # å¹³å‡100.0%ã€æ¨™æº–åå·®1.5%

# å·¥ç¨‹èƒ½åŠ›è§£æ
analyzer = ProcessCapabilityAnalyzer(
    spec_lower=95.0,   # è¦æ ¼ä¸‹é™: 95.0%
    spec_upper=105.0,  # è¦æ ¼ä¸Šé™: 105.0%
    target=100.0       # ç›®æ¨™å€¤: 100.0%
)

results = analyzer.calculate_capability_indices(data_stable, subgroup_size=5)

print("\nå·¥ç¨‹èƒ½åŠ›æŒ‡æ•°:")
print(f"Cp  = {results['Cp']:.3f}")
print(f"Cpk = {results['Cpk']:.3f}")
print(f"Pp  = {results['Pp']:.3f}")
print(f"Ppk = {results['Ppk']:.3f}")

evaluation, _ = analyzer.evaluate_capability(results['Cpk'])
print(f"\nè©•ä¾¡: {evaluation}")
print(f"æ¨å®šä¸è‰¯ç‡: {results['ppm_total']:.1f} ppm")

# å¯è¦–åŒ–
analyzer.plot_capability_analysis(data_stable, results)
</code></pre>

            <p><strong>å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:</strong></p>
            <ul>
                <li>çŸ­æœŸèƒ½åŠ›ï¼ˆCp/Cpkï¼‰ã¨é•·æœŸèƒ½åŠ›ï¼ˆPp/Ppkï¼‰ã®ä¸¡æ–¹ã‚’è¨ˆç®—</li>
                <li>GMPæ¨å¥¨æ°´æº–ï¼ˆCpk â‰¥ 1.33ï¼‰ã¨ã®æ¯”è¼ƒè©•ä¾¡</li>
                <li>æ­£è¦ç¢ºç‡ãƒ—ãƒ­ãƒƒãƒˆã«ã‚ˆã‚‹åˆ†å¸ƒã®æ­£è¦æ€§æ¤œè¨¼</li>
                <li>æ¨å®šä¸è‰¯ç‡ï¼ˆppmï¼‰ã®è¨ˆç®—ã«ã‚ˆã‚‹å“è³ªäºˆæ¸¬</li>
                <li>è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</li>
            </ul>
        </div>

        <div class="content-box">
            <h2>ğŸ“š ã¾ã¨ã‚</h2>
            <p>æœ¬ç« ã§ã¯ã€GMPæº–æ‹ ã®çµ±è¨ˆçš„å“è³ªç®¡ç†ã®åŸºç¤ã‚’å­¦ã³ã¾ã—ãŸã€‚</p>

            <h3>ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆ</h3>
            <ul>
                <li>X-Rç®¡ç†å›³ã«ã‚ˆã‚‹å·¥ç¨‹ç®¡ç†ã¨ç›£æŸ»è¨¼è·¡ã®è¨˜éŒ²</li>
                <li>å·¥ç¨‹èƒ½åŠ›æŒ‡æ•°ï¼ˆCp/Cpkï¼‰ã®è¨ˆç®—ã¨GMPè©•ä¾¡åŸºæº–</li>
                <li>è‡ªå‹•çš„ãªé€¸è„±æ¤œå‡ºã¨ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½</li>
                <li>è¦æ ¼é™ç•Œã¨ç®¡ç†é™ç•Œã®æ˜ç¢ºãªåŒºåˆ¥</li>
                <li>ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒ†ã‚°ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã™ã‚‹å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³</li>
            </ul>

            <div class="key-point">
                <strong>ğŸ¯ æ¬¡ç« äºˆå‘Š</strong><br>
                ç¬¬2ç« ã§ã¯ã€é›»å­ãƒãƒƒãƒè¨˜éŒ²ï¼ˆEBRï¼‰ã®è‡ªå‹•è§£æã¨é€¸è„±ç®¡ç†ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚
                ãƒãƒƒãƒãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã€ç•°å¸¸æ¤œçŸ¥ã€æ ¹æœ¬åŸå› åˆ†æï¼ˆRCAï¼‰ã€CAPAææ¡ˆã®è‡ªå‹•åŒ–ãªã©ã€
                ã‚ˆã‚Šé«˜åº¦ãªãƒ‡ãƒ¼ã‚¿è§£ææŠ€è¡“ã‚’ç¿’å¾—ã—ã¾ã™ã€‚
            </div>
        </div>

        <div class="nav-buttons">
            <a href="index.html">â† ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡</a>
            <a href="chapter-2.html">ç¬¬2ç« : é›»å­ãƒãƒƒãƒè¨˜éŒ²è§£æ â†’</a>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 AI Terakoya - ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹é“å ´</p>
        <p>ç¬¬1ç«  GMPæº–æ‹ ã®çµ±è¨ˆçš„å“è³ªç®¡ç†</p>
    </footer>
</body>
</html>
