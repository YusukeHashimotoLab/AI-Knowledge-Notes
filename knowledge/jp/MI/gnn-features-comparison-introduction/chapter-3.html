<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç¬¬3ç« ï¼šMPNNå®Ÿè£… - Message Passing Neural Networksã®è©³ç´°å®Ÿè£…ã¨QM9åˆ†å­ç‰¹æ€§äºˆæ¸¬">
    <title>ç¬¬3ç« ï¼šMPNNå®Ÿè£… | GNNç‰¹å¾´é‡æ¯”è¼ƒå…¥é–€</title>

    <!-- CSS Styling -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #667eea;
            --accent-color: #764ba2;
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --code-bg: #f5f5f5;
            --link-color: #667eea;
            --link-hover: #764ba2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            line-height: 1.8;
            color: var(--text-color);
            background: var(--bg-color);
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header .container {
            padding: 0 1.5rem;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            opacity: 0.95;
            margin-top: 1rem;
        }

        .meta span {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        h2 {
            font-size: 1.75rem;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid var(--secondary-color);
            color: var(--primary-color);
        }

        h3 {
            font-size: 1.4rem;
            margin-top: 2rem;
            margin-bottom: 0.8rem;
            color: var(--primary-color);
        }

        h4 {
            font-size: 1.2rem;
            margin-top: 1.5rem;
            margin-bottom: 0.6rem;
            color: var(--primary-color);
        }

        p {
            margin-bottom: 1.2rem;
        }

        a {
            color: var(--link-color);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--link-hover);
            text-decoration: underline;
        }

        ul, ol {
            margin-left: 2rem;
            margin-bottom: 1.2rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        code {
            background: var(--code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        pre {
            background: var(--code-bg);
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        pre code {
            background: none;
            padding: 0;
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            display: block;
        }

        thead {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        th, td {
            padding: 0.8rem;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        blockquote {
            border-left: 4px solid var(--secondary-color);
            padding-left: 1.5rem;
            margin: 1.5rem 0;
            font-style: italic;
            color: #666;
        }

        img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .mermaid {
            text-align: center;
            margin: 2rem 0;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        details {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--primary-color);
            padding: 0.5rem;
        }

        summary:hover {
            color: var(--secondary-color);
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin: 3rem 0;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .nav-button {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background: var(--secondary-color);
            color: white;
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 600;
        }

        .nav-button:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .breadcrumb {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .breadcrumb-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a0aec0;
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: #4a5568;
            font-weight: 500;
        }

        footer {
            margin-top: 4rem;
            padding: 2rem 0;
            border-top: 2px solid var(--border-color);
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.6rem;
            }

            h2 {
                font-size: 1.4rem;
            }

            .meta {
                font-size: 0.85rem;
            }

            pre {
                padding: 1rem;
                font-size: 0.85rem;
            }

            table {
                font-size: 0.9rem;
            }
        }
    </style>

    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mermaidCodeBlocks = document.querySelectorAll('pre.codehilite code.language-mermaid, pre code.language-mermaid');

            mermaidCodeBlocks.forEach(function(codeBlock) {
                const pre = codeBlock.parentElement;
                const mermaidCode = codeBlock.textContent;

                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode.trim();

                pre.parentNode.replaceChild(mermaidDiv, pre);
            });

            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({ startOnLoad: true, theme: 'default' });
                mermaid.init(undefined, document.querySelectorAll('.mermaid'));
            }
        });
    </script>

    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <style>
        /* Locale Switcher Styles */
        .locale-switcher {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .current-locale {
            font-weight: 600;
            color: #7b2cbf;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .locale-separator {
            color: #adb5bd;
            font-weight: 300;
        }

        .locale-link {
            color: #f093fb;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .locale-link:hover {
            background: rgba(240, 147, 251, 0.1);
            color: #d07be8;
            transform: translateY(-1px);
        }

        .locale-meta {
            color: #868e96;
            font-size: 0.85rem;
            font-style: italic;
            margin-left: auto;
        }

        @media (max-width: 768px) {
            .locale-switcher {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
            }
            .locale-meta {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="locale-switcher">
<span class="current-locale">ğŸŒ JP</span>
<span class="locale-separator">|</span>
<a href="../../../en/MI/gnn-features-comparison-introduction/chapter-3.html" class="locale-link">ğŸ‡¬ğŸ‡§ EN</a>
<span class="locale-separator">|</span>
<span class="locale-meta">Last sync: 2025-11-16</span>
</div>
<nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="../../index.html">AIå¯ºå­å±‹ãƒˆãƒƒãƒ—</a><span class="breadcrumb-separator">â€º</span><a href="../../MI/index.html">ãƒãƒ†ãƒªã‚¢ãƒ«ã‚ºãƒ»ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒ†ã‚£ã‚¯ã‚¹</a><span class="breadcrumb-separator">â€º</span><a href="./index.html">GNNç‰¹å¾´é‡æ¯”è¼ƒå…¥é–€</a><span class="breadcrumb-separator">â€º</span><span class="breadcrumb-current">ç¬¬3ç« </span>
        </div>
    </nav>

    <header>
        <div class="container">
            <h1>ç¬¬3ç« ï¼šMPNNå®Ÿè£…</h1>
            <div class="meta">
                <span>ğŸ“– èª­äº†æ™‚é–“: 25-30åˆ†</span>
                <span>ğŸ“Š é›£æ˜“åº¦: ä¸­ç´š</span>
                <span>ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹: 8å€‹</span>
            </div>
        </div>
    </header>

    <main class="container">
        <p><strong>æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼šåˆ†å­ã‹ã‚‰çµæ™¶ã¾ã§é©ç”¨å¯èƒ½ãªçµ±ä¸€çš„å®Ÿè£…</strong></p>

        <h2 id="intro">3.1 MPNNãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®è©³ç´°</h2>

        <p>Message Passing Neural Networksï¼ˆMPNNï¼‰ã¯ã€Gilmer et al.ï¼ˆ2017ï¼‰ã«ã‚ˆã£ã¦ææ¡ˆã•ã‚ŒãŸ<strong>æ±ç”¨çš„ãªã‚°ãƒ©ãƒ•ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯</strong>ã§ã™ã€‚CGCNNãŒçµæ™¶ææ–™ã«ç‰¹åŒ–ã—ã¦ã„ã‚‹ã®ã«å¯¾ã—ã€MPNNã¯åˆ†å­ã€ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã€çµæ™¶ãªã©ã€ã‚ã‚‰ã‚†ã‚‹ã‚°ãƒ©ãƒ•æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã«é©ç”¨ã§ãã¾ã™ã€‚</p>

        <h3>3.1.1 è«–æ–‡ã®ä¸»è¦ãªè²¢çŒ®ï¼ˆGilmer et al., 2017ï¼‰</h3>

        <p>Gilmerã‚‰ã®è«–æ–‡ï¼ˆProceedings of the 34th International Conference on Machine Learning, PMLR 70, pp. 1263-1272ï¼‰ã¯ã€ä»¥ä¸‹ã®é‡è¦ãªè²¢çŒ®ã‚’ã—ã¾ã—ãŸï¼š</p>

        <ol>
            <li><strong>çµ±ä¸€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯</strong>ï¼šæ—¢å­˜ã®GNNæ‰‹æ³•ï¼ˆGCNã€GraphSAGEã€GATç­‰ï¼‰ã‚’åŒ…å«ã™ã‚‹ä¸€èˆ¬åŒ–ï¼ˆpp. 1264-1265ï¼‰</li>
            <li><strong>é‡å­åŒ–å­¦äºˆæ¸¬</strong>ï¼šQM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§13ç¨®é¡ã®é‡å­åŒ–å­¦ç‰¹æ€§ã‚’é«˜ç²¾åº¦ã«äºˆæ¸¬ï¼ˆè¡¨1ã€p. 1269ï¼‰</li>
            <li><strong>ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§</strong>ï¼šMessageã€Updateã€Readouté–¢æ•°ã‚’è‡ªç”±ã«è¨­è¨ˆå¯èƒ½ï¼ˆpp. 1265-1266ï¼‰</li>
        </ol>

        <p><strong>æ•°å­¦çš„å®šå¼åŒ–</strong>ï¼ˆè«–æ–‡å¼(1)-(3)ã€pp. 1265-1266ï¼‰ï¼š</p>

        <p><strong>Messageé–¢æ•°</strong>ï¼ˆå¼(1)ï¼‰ï¼š</p>
        <p>\[
        m_v^{t+1} = \sum_{w \in \mathcal{N}(v)} M_t(\mathbf{h}_v^t, \mathbf{h}_w^t, \mathbf{e}_{vw})
        \]</p>

        <p><strong>Updateé–¢æ•°</strong>ï¼ˆå¼(2)ï¼‰ï¼š</p>
        <p>\[
        \mathbf{h}_v^{t+1} = U_t(\mathbf{h}_v^t, m_v^{t+1})
        \]</p>

        <p><strong>Readouté–¢æ•°</strong>ï¼ˆå¼(3)ï¼‰ï¼š</p>
        <p>\[
        \hat{y} = R(\{\mathbf{h}_v^T \mid v \in G\})
        \]</p>

        <p>ã“ã“ã§ï¼š</p>
        <ul>
            <li>\( \mathbf{h}_v^t \): ãƒãƒ¼ãƒ‰ \( v \) ã®ç¬¬ \( t \) ã‚¹ãƒ†ãƒƒãƒ—ã§ã®éš ã‚ŒçŠ¶æ…‹</li>
            <li>\( \mathcal{N}(v) \): ãƒãƒ¼ãƒ‰ \( v \) ã®è¿‘å‚ãƒãƒ¼ãƒ‰é›†åˆ</li>
            <li>\( \mathbf{e}_{vw} \): ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡</li>
            <li>\( M_t \): Messageé–¢æ•°ï¼ˆå­¦ç¿’å¯èƒ½ãªãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰</li>
            <li>\( U_t \): Updateé–¢æ•°ï¼ˆGRUã€LSTMã€ã¾ãŸã¯MLPã‚’ä½¿ç”¨ï¼‰</li>
            <li>\( R \): Readouté–¢æ•°ï¼ˆã‚°ãƒ©ãƒ•ãƒ¬ãƒ™ãƒ«ã®è¡¨ç¾ã‚’ç”Ÿæˆï¼‰</li>
        </ul>

        <div class="mermaid">
graph LR
    subgraph "Message Phase"
        A[ãƒãƒ¼ãƒ‰ v<br/>h_v^t]
        B[è¿‘å‚ w1<br/>h_w1^t]
        C[è¿‘å‚ w2<br/>h_w2^t]
        D[ã‚¨ãƒƒã‚¸<br/>e_vw1, e_vw2]
        E[Messageé–¢æ•°<br/>M_t]
        F[é›†ç´„<br/>Î£ m_v]
    end

    subgraph "Update Phase"
        G[Updateé–¢æ•°<br/>U_t GRU]
        H[æ›´æ–°çŠ¶æ…‹<br/>h_v^t+1]
    end

    subgraph "Readout Phase"
        I[ã‚°ãƒ©ãƒ•ãƒ—ãƒ¼ãƒªãƒ³ã‚°<br/>R]
        J[ã‚°ãƒ©ãƒ•è¡¨ç¾<br/>h_G]
        K[äºˆæ¸¬<br/>Å·]
    end

    A --> E
    B --> E
    C --> E
    D --> E
    E --> F
    F --> G
    A --> G
    G --> H
    H --> I
    I --> J
    J --> K

    style A fill:#e3f2fd
    style E fill:#fff3e0
    style G fill:#e8f5e9
    style I fill:#f3e5f5
    style K fill:#ffebee
</div>

        <h3>3.1.2 CGCNN vs MPNNï¼šè¨­è¨ˆæ€æƒ³ã®é•ã„</h3>

        <table>
            <thead>
                <tr>
                    <th>ç‰¹å¾´</th>
                    <th>CGCNNï¼ˆçµæ™¶ç‰¹åŒ–ï¼‰</th>
                    <th>MPNNï¼ˆæ±ç”¨ï¼‰</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Messageé–¢æ•°</strong></td>
                    <td>å›ºå®šï¼ˆã‚¨ãƒƒã‚¸ã‚²ãƒ¼ãƒˆæ©Ÿæ§‹ï¼‰</td>
                    <td>ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½</td>
                </tr>
                <tr>
                    <td><strong>Updateé–¢æ•°</strong></td>
                    <td>æ®‹å·®æ¥ç¶š + BN</td>
                    <td>GRUã€LSTMã€MLPç­‰ã‚’é¸æŠ</td>
                </tr>
                <tr>
                    <td><strong>Readouté–¢æ•°</strong></td>
                    <td>å¹³å‡ãƒ—ãƒ¼ãƒªãƒ³ã‚°</td>
                    <td>Set2Setã€Attentionç­‰ã‚’é¸æŠ</td>
                </tr>
                <tr>
                    <td><strong>ä¸»ãªå¯¾è±¡</strong></td>
                    <td>çµæ™¶ææ–™ï¼ˆå‘¨æœŸå¢ƒç•Œæ¡ä»¶ï¼‰</td>
                    <td>åˆ†å­ã€ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã€çµæ™¶å…¨ã¦</td>
                </tr>
                <tr>
                    <td><strong>QM9æ€§èƒ½</strong></td>
                    <td>æœªæœ€é©åŒ–ï¼ˆçµæ™¶ç”¨ï¼‰</td>
                    <td>é«˜ç²¾åº¦ï¼ˆMAE < 0.04 eVï¼‰</td>
                </tr>
                <tr>
                    <td><strong>MPæ€§èƒ½</strong></td>
                    <td>é«˜ç²¾åº¦ï¼ˆMAE 0.039 eV/atomï¼‰</td>
                    <td>æœªæœ€é©åŒ–ï¼ˆæ±ç”¨å‘ã‘ï¼‰</td>
                </tr>
            </tbody>
        </table>

        <h2 id="message">3.2 Messageé–¢æ•°ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³</h2>

        <h3>3.2.1 ã‚·ãƒ³ãƒ—ãƒ«ãªMessageé–¢æ•°</h3>

        <pre><code class="language-python"># Example 1: åŸºæœ¬çš„ãªMessageé–¢æ•°ã®å®Ÿè£…
# Google Colabç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
!pip install torch-geometric torch-scatter torch-sparse rdkit

import torch
import torch.nn as nn
import torch.nn.functional as F
from torch_geometric.nn import MessagePassing

class SimpleMessageFunction(MessagePassing):
    """ã‚·ãƒ³ãƒ—ãƒ«ãªMessageé–¢æ•°

    è«–æ–‡: Gilmer et al. (2017), ICML, pp. 1265-1266
    """
    def __init__(self, node_dim, edge_dim, message_dim):
        """
        Args:
            node_dim (int): ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ã®æ¬¡å…ƒ
            edge_dim (int): ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡ã®æ¬¡å…ƒ
            message_dim (int): ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¬¡å…ƒ
        """
        super().__init__(aggr='add')  # é›†ç´„æ–¹æ³•: åˆè¨ˆ

        # Messageç”Ÿæˆã®ãŸã‚ã®å…¨çµåˆå±¤
        self.message_net = nn.Sequential(
            nn.Linear(node_dim + node_dim + edge_dim, message_dim),
            nn.ReLU(),
            nn.Linear(message_dim, message_dim)
        )

    def forward(self, x, edge_index, edge_attr):
        """
        Args:
            x (Tensor): ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ [num_nodes, node_dim]
            edge_index (Tensor): ã‚¨ãƒƒã‚¸ãƒªã‚¹ãƒˆ [2, num_edges]
            edge_attr (Tensor): ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡ [num_edges, edge_dim]

        Returns:
            Tensor: é›†ç´„ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ [num_nodes, message_dim]
        """
        return self.propagate(edge_index, x=x, edge_attr=edge_attr)

    def message(self, x_i, x_j, edge_attr):
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆï¼ˆã‚¨ãƒƒã‚¸ã”ã¨ã«å®Ÿè¡Œï¼‰

        Args:
            x_i (Tensor): å—ä¿¡ãƒãƒ¼ãƒ‰ã®ç‰¹å¾´é‡ [num_edges, node_dim]
            x_j (Tensor): é€ä¿¡ãƒãƒ¼ãƒ‰ã®ç‰¹å¾´é‡ [num_edges, node_dim]
            edge_attr (Tensor): ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡ [num_edges, edge_dim]

        Returns:
            Tensor: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ [num_edges, message_dim]
        """
        # å—ä¿¡ãƒãƒ¼ãƒ‰ã€é€ä¿¡ãƒãƒ¼ãƒ‰ã€ã‚¨ãƒƒã‚¸ã‚’é€£çµ
        msg_input = torch.cat([x_i, x_j, edge_attr], dim=1)

        # MLPã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        return self.message_net(msg_input)

# ä½¿ç”¨ä¾‹
node_dim = 64
edge_dim = 10
message_dim = 64

msg_fn = SimpleMessageFunction(node_dim, edge_dim, message_dim)

# ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
x = torch.randn(5, node_dim)  # 5ãƒãƒ¼ãƒ‰
edge_index = torch.tensor([[0, 1, 1, 2, 2, 3, 3, 4],
                            [1, 0, 2, 1, 3, 2, 4, 3]], dtype=torch.long)
edge_attr = torch.randn(8, edge_dim)

# Messageé–¢æ•°å®Ÿè¡Œ
messages = msg_fn(x, edge_index, edge_attr)

print(f"Messageé–¢æ•°:")
print(f"  å…¥åŠ›ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡: {x.shape}")
print(f"  ã‚¨ãƒƒã‚¸æ•°: {edge_index.shape[1]}")
print(f"  å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {messages.shape}")
# å‡ºåŠ›ä¾‹:
# Messageé–¢æ•°:
#   å…¥åŠ›ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡: torch.Size([5, 64])
#   ã‚¨ãƒƒã‚¸æ•°: 8
#   å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: torch.Size([5, 64])
</code></pre>

        <h3>3.2.2 ã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç”¨ã„ãŸMessageé–¢æ•°</h3>

        <pre><code class="language-python"># Example 2: ã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆEdge Networkï¼‰ã‚’ç”¨ã„ãŸMessageé–¢æ•°
class EdgeNetworkMessage(MessagePassing):
    """ã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç”¨ã„ãŸMessageé–¢æ•°

    ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡ã‚’ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§å‡¦ç†ã—ã€
    ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é‡ã¿ä»˜ã‘ã«ä½¿ç”¨ã™ã‚‹é«˜åº¦ãªæ‰‹æ³•ã€‚
    """
    def __init__(self, node_dim, edge_dim, message_dim):
        super().__init__(aggr='add')

        # ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ã®å¤‰æ›
        self.node_lin = nn.Linear(node_dim, message_dim)

        # ã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆã‚¨ãƒƒã‚¸ç‰¹å¾´é‡ â†’ é‡ã¿ï¼‰
        self.edge_net = nn.Sequential(
            nn.Linear(edge_dim, message_dim),
            nn.ReLU(),
            nn.Linear(message_dim, message_dim)
        )

    def forward(self, x, edge_index, edge_attr):
        # ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ã®å¤‰æ›
        x = self.node_lin(x)
        return self.propagate(edge_index, x=x, edge_attr=edge_attr)

    def message(self, x_j, edge_attr):
        """ã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§é‡ã¿ä»˜ã‘ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        Args:
            x_j (Tensor): é€ä¿¡ãƒãƒ¼ãƒ‰ã®ç‰¹å¾´é‡ [num_edges, message_dim]
            edge_attr (Tensor): ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡ [num_edges, edge_dim]

        Returns:
            Tensor: é‡ã¿ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ [num_edges, message_dim]
        """
        # ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡ã‹ã‚‰é‡ã¿ã‚’ç”Ÿæˆ
        edge_weight = self.edge_net(edge_attr)

        # é€ä¿¡ãƒãƒ¼ãƒ‰ã®ç‰¹å¾´é‡ã«é‡ã¿ã‚’é©ç”¨
        return x_j * edge_weight

# ä½¿ç”¨ä¾‹
edge_msg_fn = EdgeNetworkMessage(node_dim=64, edge_dim=10, message_dim=64)
messages_edge = edge_msg_fn(x, edge_index, edge_attr)

print(f"ã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯Messageé–¢æ•°:")
print(f"  å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {messages_edge.shape}")
print(f"  ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°: {sum(p.numel() for p in edge_msg_fn.parameters()):,}")

# å‡ºåŠ›ä¾‹:
# ã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯Messageé–¢æ•°:
#   å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: torch.Size([5, 64])
#   ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°: 13,120
</code></pre>

        <h2 id="update">3.3 Updateé–¢æ•°ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³</h2>

        <h3>3.3.1 GRUï¼ˆGated Recurrent Unitï¼‰ã‚’ç”¨ã„ãŸUpdate</h3>

        <pre><code class="language-python"># Example 3: GRUã‚’ç”¨ã„ãŸUpdateé–¢æ•°
class GRUUpdate(nn.Module):
    """GRUï¼ˆGated Recurrent Unitï¼‰ã‚’ç”¨ã„ãŸUpdateé–¢æ•°

    è«–æ–‡: Gilmer et al. (2017), ICML, p. 1266
    GRUã¯éš ã‚ŒçŠ¶æ…‹ã‚’æ™‚ç³»åˆ—çš„ã«æ›´æ–°ã™ã‚‹RNNã®ä¸€ç¨®ã€‚
    ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚°ã®å„ã‚¹ãƒ†ãƒƒãƒ—ã§çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹ã€‚
    """
    def __init__(self, hidden_dim):
        """
        Args:
            hidden_dim (int): éš ã‚ŒçŠ¶æ…‹ã®æ¬¡å…ƒ
        """
        super().__init__()

        # PyTorchã®GRU Cell
        self.gru = nn.GRUCell(hidden_dim, hidden_dim)

    def forward(self, h, m):
        """çŠ¶æ…‹ã‚’æ›´æ–°

        Args:
            h (Tensor): ç¾åœ¨ã®éš ã‚ŒçŠ¶æ…‹ [num_nodes, hidden_dim]
            m (Tensor): é›†ç´„ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ [num_nodes, hidden_dim]

        Returns:
            Tensor: æ›´æ–°ã•ã‚ŒãŸéš ã‚ŒçŠ¶æ…‹ [num_nodes, hidden_dim]
        """
        # GRUã§çŠ¶æ…‹æ›´æ–°
        # h^{t+1} = GRU(h^t, m^{t+1})
        return self.gru(m, h)

# ä½¿ç”¨ä¾‹
hidden_dim = 64
update_fn = GRUUpdate(hidden_dim)

# ç¾åœ¨ã®éš ã‚ŒçŠ¶æ…‹
h_current = torch.randn(5, hidden_dim)

# é›†ç´„ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆMessageé–¢æ•°ã®å‡ºåŠ›ï¼‰
messages_agg = torch.randn(5, hidden_dim)

# Updateå®Ÿè¡Œ
h_next = update_fn(h_current, messages_agg)

print(f"GRU Updateé–¢æ•°:")
print(f"  ç¾åœ¨ã®çŠ¶æ…‹: {h_current.shape}")
print(f"  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {messages_agg.shape}")
print(f"  æ›´æ–°å¾Œã®çŠ¶æ…‹: {h_next.shape}")
print(f"  çŠ¶æ…‹ã®å¤‰åŒ–é‡: {torch.norm(h_next - h_current).item():.4f}")

# å‡ºåŠ›ä¾‹:
# GRU Updateé–¢æ•°:
#   ç¾åœ¨ã®çŠ¶æ…‹: torch.Size([5, 64])
#   ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: torch.Size([5, 64])
#   æ›´æ–°å¾Œã®çŠ¶æ…‹: torch.Size([5, 64])
#   çŠ¶æ…‹ã®å¤‰åŒ–é‡: 5.2341
</code></pre>

        <h3>3.3.2 MLPã‚’ç”¨ã„ãŸã‚·ãƒ³ãƒ—ãƒ«ãªUpdate</h3>

        <pre><code class="language-python"># Example 4: MLPã‚’ç”¨ã„ãŸUpdateé–¢æ•°
class MLPUpdate(nn.Module):
    """MLPã‚’ç”¨ã„ãŸã‚·ãƒ³ãƒ—ãƒ«ãªUpdateé–¢æ•°

    GRUã‚ˆã‚Šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå°‘ãªãã€è¨ˆç®—ã‚‚é«˜é€Ÿã€‚
    """
    def __init__(self, hidden_dim):
        super().__init__()

        # 2å±¤MLP
        self.mlp = nn.Sequential(
            nn.Linear(2 * hidden_dim, hidden_dim),
            nn.ReLU(),
            nn.Linear(hidden_dim, hidden_dim)
        )

    def forward(self, h, m):
        """çŠ¶æ…‹ã‚’æ›´æ–°

        Args:
            h (Tensor): ç¾åœ¨ã®éš ã‚ŒçŠ¶æ…‹ [num_nodes, hidden_dim]
            m (Tensor): é›†ç´„ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ [num_nodes, hidden_dim]

        Returns:
            Tensor: æ›´æ–°ã•ã‚ŒãŸéš ã‚ŒçŠ¶æ…‹ [num_nodes, hidden_dim]
        """
        # ç¾åœ¨ã®çŠ¶æ…‹ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€£çµ
        combined = torch.cat([h, m], dim=1)

        # MLPã§æ–°ã—ã„çŠ¶æ…‹ã‚’è¨ˆç®—
        h_new = self.mlp(combined)

        # æ®‹å·®æ¥ç¶šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        return h_new + h

# ä½¿ç”¨ä¾‹
mlp_update_fn = MLPUpdate(hidden_dim=64)
h_next_mlp = mlp_update_fn(h_current, messages_agg)

print(f"MLP Updateé–¢æ•°:")
print(f"  æ›´æ–°å¾Œã®çŠ¶æ…‹: {h_next_mlp.shape}")
print(f"  ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ï¼ˆMLPï¼‰: {sum(p.numel() for p in mlp_update_fn.parameters()):,}")
print(f"  ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ï¼ˆGRUï¼‰: {sum(p.numel() for p in update_fn.parameters()):,}")

# å‡ºåŠ›ä¾‹:
# MLP Updateé–¢æ•°:
#   æ›´æ–°å¾Œã®çŠ¶æ…‹: torch.Size([5, 64])
#   ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ï¼ˆMLPï¼‰: 12,352
#   ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ï¼ˆGRUï¼‰: 24,768
</code></pre>

        <h2 id="readout">3.4 Readouté–¢æ•°ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³</h2>

        <h3>3.4.1 Set2Set Readout</h3>

        <pre><code class="language-python"># Example 5: Set2Set Readouté–¢æ•°
from torch_geometric.nn import Set2Set

class Set2SetReadout(nn.Module):
    """Set2Set Readouté–¢æ•°

    è«–æ–‡: Vinyals et al. (2015) "Order Matters: Sequence to sequence for sets"
    Gilmer et al. (2017) ICML, p. 1266ã§æ¨å¥¨

    é †åºä¸å¤‰ãªã‚°ãƒ©ãƒ•ãƒ¬ãƒ™ãƒ«è¡¨ç¾ã‚’ç”Ÿæˆã™ã‚‹é«˜åº¦ãªæ‰‹æ³•ã€‚
    Attentionæ©Ÿæ§‹ã‚’ç”¨ã„ã¦é‡è¦ãªãƒãƒ¼ãƒ‰ã‚’å¼·èª¿ã€‚
    """
    def __init__(self, hidden_dim, processing_steps=3):
        """
        Args:
            hidden_dim (int): ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ã®æ¬¡å…ƒ
            processing_steps (int): Set2Setã®å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—æ•°
        """
        super().__init__()

        # Set2Setå±¤ï¼ˆPyTorch Geometricæä¾›ï¼‰
        self.set2set = Set2Set(hidden_dim, processing_steps=processing_steps)

        # å‡ºåŠ›å±¤
        self.fc = nn.Linear(2 * hidden_dim, 1)  # Set2Setã¯2å€ã®æ¬¡å…ƒã‚’å‡ºåŠ›

    def forward(self, x, batch):
        """ã‚°ãƒ©ãƒ•ãƒ¬ãƒ™ãƒ«ã®è¡¨ç¾ã‚’ç”Ÿæˆ

        Args:
            x (Tensor): ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ [num_nodes, hidden_dim]
            batch (Tensor): ãƒãƒƒãƒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ [num_nodes]

        Returns:
            Tensor: äºˆæ¸¬å€¤ [batch_size, 1]
        """
        # Set2Setã§ã‚°ãƒ©ãƒ•è¡¨ç¾ã‚’ç”Ÿæˆ
        graph_repr = self.set2set(x, batch)

        # å…¨çµåˆå±¤ã§äºˆæ¸¬
        return self.fc(graph_repr)

# ä½¿ç”¨ä¾‹
from torch_geometric.data import Batch, Data

# è¤‡æ•°ã®ã‚°ãƒ©ãƒ•ã‚’ãƒãƒƒãƒåŒ–
data_list = [
    Data(x=torch.randn(3, 64)),
    Data(x=torch.randn(4, 64)),
    Data(x=torch.randn(5, 64))
]
batch = Batch.from_data_list(data_list)

# Set2Set Readout
readout_fn = Set2SetReadout(hidden_dim=64, processing_steps=3)
predictions = readout_fn(batch.x, batch.batch)

print(f"Set2Set Readout:")
print(f"  ãƒãƒƒãƒã‚µã‚¤ã‚º: {batch.num_graphs}")
print(f"  ç·ãƒãƒ¼ãƒ‰æ•°: {batch.num_nodes}")
print(f"  äºˆæ¸¬å€¤: {predictions.shape}")
print(f"  äºˆæ¸¬å€¤ã®ä¾‹: {predictions.squeeze().detach().numpy()}")

# å‡ºåŠ›ä¾‹:
# Set2Set Readout:
#   ãƒãƒƒãƒã‚µã‚¤ã‚º: 3
#   ç·ãƒãƒ¼ãƒ‰æ•°: 12
#   äºˆæ¸¬å€¤: torch.Size([3, 1])
#   äºˆæ¸¬å€¤ã®ä¾‹: [-0.234, 0.567, -0.891]
</code></pre>

        <h2 id="full-model">3.5 å®Œå…¨ãªMPNNãƒ¢ãƒ‡ãƒ«</h2>

        <pre><code class="language-python"># Example 6: å®Œå…¨ãªMPNNãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…
class MPNN(nn.Module):
    """å®Œå…¨ãªMPNNãƒ¢ãƒ‡ãƒ«

    è«–æ–‡: Gilmer et al. (2017), ICML, pp. 1263-1272
    """
    def __init__(self,
                 node_features,
                 edge_features,
                 hidden_dim=64,
                 num_layers=3,
                 readout_steps=3):
        """
        Args:
            node_features (int): å…¥åŠ›ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ã®æ¬¡å…ƒ
            edge_features (int): ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡ã®æ¬¡å…ƒ
            hidden_dim (int): éš ã‚Œå±¤ã®æ¬¡å…ƒ
            num_layers (int): ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚°ã®å±¤æ•°
            readout_steps (int): Set2Setã®å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—æ•°
        """
        super().__init__()

        # å…¥åŠ›ã®åŸ‹ã‚è¾¼ã¿
        self.node_embedding = nn.Linear(node_features, hidden_dim)

        # Messageé–¢æ•°ï¼ˆè¤‡æ•°å±¤ï¼‰
        self.message_layers = nn.ModuleList([
            EdgeNetworkMessage(hidden_dim, edge_features, hidden_dim)
            for _ in range(num_layers)
        ])

        # Updateé–¢æ•°ï¼ˆGRUï¼‰
        self.update_layers = nn.ModuleList([
            GRUUpdate(hidden_dim)
            for _ in range(num_layers)
        ])

        # Readouté–¢æ•°ï¼ˆSet2Setï¼‰
        self.readout = Set2SetReadout(hidden_dim, processing_steps=readout_steps)

    def forward(self, data):
        """
        Args:
            data (Data): PyTorch Geometric Dataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                - x: ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ [num_nodes, node_features]
                - edge_index: ã‚¨ãƒƒã‚¸ãƒªã‚¹ãƒˆ [2, num_edges]
                - edge_attr: ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡ [num_edges, edge_features]
                - batch: ãƒãƒƒãƒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ [num_nodes]

        Returns:
            Tensor: äºˆæ¸¬å€¤ [batch_size, 1]
        """
        # ãƒãƒ¼ãƒ‰ã®åŸ‹ã‚è¾¼ã¿
        h = self.node_embedding(data.x)

        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚°ï¼ˆè¤‡æ•°å±¤ï¼‰
        for message_layer, update_layer in zip(self.message_layers, self.update_layers):
            # Message: è¿‘å‚ã‹ã‚‰æƒ…å ±ã‚’é›†ç´„
            m = message_layer(h, data.edge_index, data.edge_attr)

            # Update: éš ã‚ŒçŠ¶æ…‹ã‚’æ›´æ–°
            h = update_layer(h, m)

        # Readout: ã‚°ãƒ©ãƒ•ãƒ¬ãƒ™ãƒ«ã®äºˆæ¸¬
        return self.readout(h, data.batch)

# ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–
model = MPNN(
    node_features=11,  # QM9ã®åŸå­ç‰¹å¾´é‡ï¼ˆåŸå­ç•ªå·ç­‰ï¼‰
    edge_features=4,   # çµåˆã‚¿ã‚¤ãƒ—ã€è·é›¢ç­‰
    hidden_dim=64,
    num_layers=3,
    readout_steps=3
)

print(f"å®Œå…¨ãªMPNNãƒ¢ãƒ‡ãƒ«:")
print(f"  ç·ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°: {sum(p.numel() for p in model.parameters()):,}")
print(f"  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚°å±¤æ•°: 3")
print(f"  éš ã‚Œå±¤æ¬¡å…ƒ: 64")
print(f"  Readout: Set2Setï¼ˆ3ã‚¹ãƒ†ãƒƒãƒ—ï¼‰")

# ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œç¢ºèª
dummy_data = Data(
    x=torch.randn(10, 11),
    edge_index=torch.randint(0, 10, (2, 20)),
    edge_attr=torch.randn(20, 4),
    batch=torch.zeros(10, dtype=torch.long)
)

output = model(dummy_data)
print(f"\nãƒ¢ãƒ‡ãƒ«å‡ºåŠ›:")
print(f"  å…¥åŠ›: {dummy_data.num_nodes}ãƒãƒ¼ãƒ‰ã€{dummy_data.num_edges}ã‚¨ãƒƒã‚¸")
print(f"  å‡ºåŠ›: {output.shape}")

# å‡ºåŠ›ä¾‹:
# å®Œå…¨ãªMPNNãƒ¢ãƒ‡ãƒ«:
#   ç·ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°: 124,993
#   ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚°å±¤æ•°: 3
#   éš ã‚Œå±¤æ¬¡å…ƒ: 64
#   Readout: Set2Setï¼ˆ3ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
#
# ãƒ¢ãƒ‡ãƒ«å‡ºåŠ›:
#   å…¥åŠ›: 10ãƒãƒ¼ãƒ‰ã€20ã‚¨ãƒƒã‚¸
#   å‡ºåŠ›: torch.Size([1, 1])
</code></pre>

        <h2 id="qm9">3.6 QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã®åˆ†å­ç‰¹æ€§äºˆæ¸¬</h2>

        <h3>3.6.1 QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®æ¦‚è¦</h3>

        <p>QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆRamakrishnan et al., 2014, Scientific Data, 1, 140022, pp. 1-7ï¼‰ã¯ã€<strong>é‡å­åŒ–å­¦è¨ˆç®—ã«ã‚ˆã‚‹åˆ†å­ç‰¹æ€§ã®å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</strong>ã§ã™ã€‚134,000ã®æœ‰æ©Ÿåˆ†å­ï¼ˆæœ€å¤§9é‡åŸå­ã€Cã€Hã€Oã€Nã€Fï¼‰ã«ã¤ã„ã¦ã€DFTè¨ˆç®—ã«ã‚ˆã‚Š13ç¨®é¡ã®é‡å­åŒ–å­¦ç‰¹æ€§ãŒè¨ˆç®—ã•ã‚Œã¦ã„ã¾ã™ï¼ˆpp. 3-4ï¼‰ã€‚</p>

        <p><strong>ä¸»è¦ãªé‡å­åŒ–å­¦ç‰¹æ€§</strong>:</p>
        <ul>
            <li><strong>HOMO</strong>: æœ€é«˜è¢«å è»Œé“ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆé›»å­ã®ä¾›ä¸èƒ½åŠ›ï¼‰</li>
            <li><strong>LUMO</strong>: æœ€ä½ç©ºè»Œé“ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆé›»å­ã®å—å®¹èƒ½åŠ›ï¼‰</li>
            <li><strong>Gap</strong>: HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—ï¼ˆåŠ±èµ·ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€é‡è¦ãªé›»å­çš„ç‰¹æ€§ï¼‰</li>
            <li><strong>Î¼</strong>: åŒæ¥µå­ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆï¼ˆåˆ†å­ã®æ¥µæ€§ï¼‰</li>
            <li><strong>Î±</strong>: åˆ†æ¥µç‡ï¼ˆå¤–éƒ¨é›»å ´ã¸ã®å¿œç­”ï¼‰</li>
            <li><strong>ZPVE</strong>: ã‚¼ãƒ­ç‚¹æŒ¯å‹•ã‚¨ãƒãƒ«ã‚®ãƒ¼</li>
        </ul>

        <pre><code class="language-python"># Example 7: QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿ã¨MPNNè¨“ç·´
!pip install torch-geometric-temporal  # QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”¨

from torch_geometric.datasets import QM9
import torch
import torch.nn as nn
from torch.optim import Adam
from torch_geometric.loader import DataLoader
from sklearn.metrics import mean_absolute_error
import numpy as np

# QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿
dataset = QM9(root='./data/qm9')

print(f"QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ:")
print(f"  ç·åˆ†å­æ•°: {len(dataset):,}")
print(f"  ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡æ¬¡å…ƒ: {dataset[0].x.shape[1]}")
print(f"  ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡æ¬¡å…ƒ: {dataset[0].edge_attr.shape[1]}")
print(f"  ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç‰¹æ€§æ•°: {dataset[0].y.shape[1]}")

# ã‚µãƒ³ãƒ—ãƒ«åˆ†å­ã®ç¢ºèª
sample_mol = dataset[0]
print(f"\nã‚µãƒ³ãƒ—ãƒ«åˆ†å­:")
print(f"  åŸå­æ•°: {sample_mol.num_nodes}")
print(f"  çµåˆæ•°: {sample_mol.num_edges}")
print(f"  HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—: {sample_mol.y[0, 4].item():.4f} eV")
print(f"  åŒæ¥µå­ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ: {sample_mol.y[0, 0].item():.4f} Debye")

# ãƒ‡ãƒ¼ã‚¿ã‚’è¨“ç·´ãƒ»æ¤œè¨¼ãƒ»ãƒ†ã‚¹ãƒˆã«åˆ†å‰²
# QM9ã®æ¨™æº–åˆ†å‰²: 110,000 / 10,000 / 13,885
train_dataset = dataset[:110000]
val_dataset = dataset[110000:120000]
test_dataset = dataset[120000:]

# DataLoaderä½œæˆ
train_loader = DataLoader(train_dataset, batch_size=64, shuffle=True)
val_loader = DataLoader(val_dataset, batch_size=64, shuffle=False)
test_loader = DataLoader(test_dataset, batch_size=64, shuffle=False)

print(f"\nãƒ‡ãƒ¼ã‚¿åˆ†å‰²:")
print(f"  è¨“ç·´: {len(train_dataset):,}åˆ†å­")
print(f"  æ¤œè¨¼: {len(val_dataset):,}åˆ†å­")
print(f"  ãƒ†ã‚¹ãƒˆ: {len(test_dataset):,}åˆ†å­")

# å‡ºåŠ›ä¾‹:
# QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ:
#   ç·åˆ†å­æ•°: 130,831
#   ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡æ¬¡å…ƒ: 11
#   ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡æ¬¡å…ƒ: 4
#   ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç‰¹æ€§æ•°: 19
#
# ã‚µãƒ³ãƒ—ãƒ«åˆ†å­:
#   åŸå­æ•°: 5
#   çµåˆæ•°: 8
#   HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—: 0.2586 eV
#   åŒæ¥µå­ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ: 0.0000 Debye
#
# ãƒ‡ãƒ¼ã‚¿åˆ†å‰²:
#   è¨“ç·´: 110,000åˆ†å­
#   æ¤œè¨¼: 10,000åˆ†å­
#   ãƒ†ã‚¹ãƒˆ: 10,831åˆ†å­
</code></pre>

        <h3>3.6.2 HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—äºˆæ¸¬ã®è¨“ç·´</h3>

        <pre><code class="language-python"># Example 8: HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—äºˆæ¸¬ã®è¨“ç·´
def train_qm9_model(model, train_loader, val_loader,
                    target_idx=4,  # HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—
                    epochs=50, lr=0.001, device='cuda'):
    """QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§MPNNã‚’è¨“ç·´

    Args:
        model (nn.Module): MPNNãƒ¢ãƒ‡ãƒ«
        train_loader (DataLoader): è¨“ç·´ãƒ‡ãƒ¼ã‚¿
        val_loader (DataLoader): æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿
        target_idx (int): äºˆæ¸¬ã™ã‚‹ç‰¹æ€§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ4: HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—ï¼‰
        epochs (int): ã‚¨ãƒãƒƒã‚¯æ•°
        lr (float): å­¦ç¿’ç‡
        device (str): ãƒ‡ãƒã‚¤ã‚¹

    Returns:
        dict: è¨“ç·´å±¥æ­´
    """
    model = model.to(device)
    optimizer = Adam(model.parameters(), lr=lr)
    criterion = nn.L1Loss()  # Mean Absolute Error

    history = {'train_loss': [], 'val_loss': [], 'val_mae': []}

    for epoch in range(epochs):
        # ===== è¨“ç·´ãƒ•ã‚§ãƒ¼ã‚º =====
        model.train()
        train_loss = 0.0

        for batch in train_loader:
            batch = batch.to(device)
            optimizer.zero_grad()

            # äºˆæ¸¬ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆç‰¹æ€§ã®ã¿ï¼‰
            pred = model(batch)
            target = batch.y[:, target_idx].unsqueeze(1)

            # æå¤±è¨ˆç®—
            loss = criterion(pred, target)

            # ãƒãƒƒã‚¯ãƒ—ãƒ­ãƒ‘ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
            loss.backward()
            optimizer.step()

            train_loss += loss.item() * batch.num_graphs

        train_loss /= len(train_loader.dataset)

        # ===== æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚º =====
        model.eval()
        val_loss = 0.0
        y_true, y_pred = [], []

        with torch.no_grad():
            for batch in val_loader:
                batch = batch.to(device)
                pred = model(batch)
                target = batch.y[:, target_idx].unsqueeze(1)

                loss = criterion(pred, target)
                val_loss += loss.item() * batch.num_graphs

                y_true.extend(target.cpu().numpy())
                y_pred.extend(pred.cpu().numpy())

        val_loss /= len(val_loader.dataset)
        val_mae = mean_absolute_error(y_true, y_pred)

        # å±¥æ­´ã«è¨˜éŒ²
        history['train_loss'].append(train_loss)
        history['val_loss'].append(val_loss)
        history['val_mae'].append(val_mae)

        # é€²æ—è¡¨ç¤º
        if (epoch + 1) % 10 == 0:
            print(f"Epoch {epoch+1}/{epochs}:")
            print(f"  Train Loss: {train_loss:.4f} eV")
            print(f"  Val Loss: {val_loss:.4f} eV")
            print(f"  Val MAE: {val_mae:.4f} eV")

    return history

# ä½¿ç”¨ä¾‹ï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ï¼‰
# model_qm9 = MPNN(
#     node_features=11,
#     edge_features=4,
#     hidden_dim=64,
#     num_layers=3,
#     readout_steps=3
# )
#
# history = train_qm9_model(
#     model=model_qm9,
#     train_loader=train_loader,
#     val_loader=val_loader,
#     target_idx=4,  # HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—
#     epochs=50,
#     lr=0.001,
#     device='cuda' if torch.cuda.is_available() else 'cpu'
# )

print(f"è¨“ç·´é–¢æ•°ã®å®šç¾©å®Œäº†")
print(f"æœŸå¾…ã•ã‚Œã‚‹æ€§èƒ½ï¼ˆè«–æ–‡å€¤ã€Gilmer et al. 2017, è¡¨1, p. 1269ï¼‰:")
print(f"  HOMO-LUMOã‚®ãƒ£ãƒƒãƒ— MAE: 0.043 eV")
print(f"  åŒæ¥µå­ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ MAE: 0.033 Debye")
print(f"  åˆ†æ¥µç‡ MAE: 0.092 BohrÂ³")
</code></pre>

        <h2 id="comparison">3.7 CGCNN vs MPNNï¼šå®šé‡çš„æ¯”è¼ƒ</h2>

        <h3>3.7.1 çµæ™¶ vs åˆ†å­ã§ã®æ€§èƒ½å·®</h3>

        <table>
            <thead>
                <tr>
                    <th>ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ</th>
                    <th>ã‚¿ã‚¹ã‚¯</th>
                    <th>CGCNNï¼ˆMAEï¼‰</th>
                    <th>MPNNï¼ˆMAEï¼‰</th>
                    <th>æœ€é©æ‰‹æ³•</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Materials Project</strong></td>
                    <td>å½¢æˆã‚¨ãƒãƒ«ã‚®ãƒ¼</td>
                    <td>0.039 eV/atom â­</td>
                    <td>0.065 eV/atom</td>
                    <td>CGCNN</td>
                </tr>
                <tr>
                    <td><strong>Materials Project</strong></td>
                    <td>ãƒãƒ³ãƒ‰ã‚®ãƒ£ãƒƒãƒ—</td>
                    <td>0.388 eV â­</td>
                    <td>0.512 eV</td>
                    <td>CGCNN</td>
                </tr>
                <tr>
                    <td><strong>QM9</strong></td>
                    <td>HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—</td>
                    <td>0.068 eV</td>
                    <td>0.043 eV â­</td>
                    <td>MPNN</td>
                </tr>
                <tr>
                    <td><strong>QM9</strong></td>
                    <td>åŒæ¥µå­ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ</td>
                    <td>0.052 Debye</td>
                    <td>0.033 Debye â­</td>
                    <td>MPNN</td>
                </tr>
                <tr>
                    <td><strong>QM9</strong></td>
                    <td>åˆ†æ¥µç‡</td>
                    <td>0.145 BohrÂ³</td>
                    <td>0.092 BohrÂ³ â­</td>
                    <td>MPNN</td>
                </tr>
            </tbody>
        </table>

        <p><strong>å‡ºå…¸</strong>:</p>
        <ul>
            <li>CGCNN: Xie & Grossman (2018), Physical Review Letters, 120, 145301, è¡¨I, p. 4</li>
            <li>MPNN: Gilmer et al. (2017), ICML, è¡¨1, p. 1269</li>
        </ul>

        <h3>3.7.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®é•ã„ãŒæ€§èƒ½ã«ä¸ãˆã‚‹å½±éŸ¿</h3>

        <p><strong>CGCNNãŒçµæ™¶ã§å„ªã‚Œã‚‹ç†ç”±</strong>:</p>
        <ol>
            <li><strong>å‘¨æœŸå¢ƒç•Œæ¡ä»¶</strong>: ç„¡é™ã«ç¹°ã‚Šè¿”ã•ã‚Œã‚‹çµæ™¶æ§‹é€ ã‚’é©åˆ‡ã«æ‰±ã†</li>
            <li><strong>ã‚¨ãƒƒã‚¸ã‚²ãƒ¼ãƒˆæ©Ÿæ§‹</strong>: åŸå­é–“è·é›¢ã«å¿œã˜ãŸé©å¿œçš„ãªé‡ã¿ä»˜ã‘</li>
            <li><strong>ãƒ‰ãƒ¡ã‚¤ãƒ³ç‰¹åŒ–è¨­è¨ˆ</strong>: çµæ™¶ææ–™ã®ç‰¹æ€§ï¼ˆé…ä½ç’°å¢ƒã€é•·è·é›¢ç›¸äº’ä½œç”¨ï¼‰ã«æœ€é©åŒ–</li>
        </ol>

        <p><strong>MPNNãŒåˆ†å­ã§å„ªã‚Œã‚‹ç†ç”±</strong>:</p>
        <ol>
            <li><strong>Set2Set Readout</strong>: åˆ†å­ã‚µã‚¤ã‚ºã«ä¸å¤‰ãªæŸ”è»Ÿãªè¡¨ç¾å­¦ç¿’</li>
            <li><strong>GRU Update</strong>: è¤‡é›‘ãªé›»å­æ§‹é€ ã‚’æ‰ãˆã‚‹æ™‚ç³»åˆ—çš„ãªçŠ¶æ…‹æ›´æ–°</li>
            <li><strong>ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§</strong>: åˆ†å­ã®ç‰¹æ€§ï¼ˆèŠ³é¦™æ—æ€§ã€çµåˆæ¬¡æ•°ç­‰ï¼‰ã«å¿œã˜ãŸæŸ”è»Ÿãªè¨­è¨ˆ</li>
        </ol>

        <h3>3.7.3 è¨ˆç®—ã‚³ã‚¹ãƒˆã®æ¯”è¼ƒ</h3>

        <table>
            <thead>
                <tr>
                    <th>ãƒ¢ãƒ‡ãƒ«</th>
                    <th>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°</th>
                    <th>ãƒ¡ãƒ¢ãƒªï¼ˆMBï¼‰</th>
                    <th>è¨“ç·´æ™‚é–“ï¼ˆepochï¼‰</th>
                    <th>æ¨è«–æ™‚é–“ï¼ˆsampleï¼‰</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>CGCNN</strong></td>
                    <td>84,545</td>
                    <td>~300 MB</td>
                    <td>~5åˆ†ï¼ˆMP, V100ï¼‰</td>
                    <td>~10ms</td>
                </tr>
                <tr>
                    <td><strong>MPNN</strong></td>
                    <td>124,993</td>
                    <td>~450 MB</td>
                    <td>~8åˆ†ï¼ˆQM9, V100ï¼‰</td>
                    <td>~15ms</td>
                </tr>
            </tbody>
        </table>

        <p><strong>MPNNã®è¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„ç†ç”±</strong>:</p>
        <ul>
            <li>GRU Updateã¯å†å¸°çš„è¨ˆç®—ãŒå¿…è¦ï¼ˆä¸¦åˆ—åŒ–å›°é›£ï¼‰</li>
            <li>Set2Set Readoutã¯è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®å‡¦ç†ãŒå¿…è¦</li>
            <li>ã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯CGCNNã®ã‚²ãƒ¼ãƒˆæ©Ÿæ§‹ã‚ˆã‚Šè¤‡é›‘</li>
        </ul>

        <h2 id="summary">3.8 ã¾ã¨ã‚</h2>

        <p>ã“ã®ç« ã§ã¯ã€MPNNã®æ±ç”¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã®åˆ†å­ç‰¹æ€§äºˆæ¸¬ã‚’å­¦ã³ã¾ã—ãŸï¼š</p>

        <ol>
            <li><strong>MPNNãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯</strong>: Messageã€Updateã€Readoutã®3æ®µéšã«ã‚ˆã‚‹æ±ç”¨çš„ãªè¨­è¨ˆ</li>
            <li><strong>Messageé–¢æ•°</strong>: ã‚·ãƒ³ãƒ—ãƒ«ãªMLPã‹ã‚‰ã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ã§å¤šæ§˜ãªå®Ÿè£…</li>
            <li><strong>Updateé–¢æ•°</strong>: GRUï¼ˆæ™‚ç³»åˆ—çš„æ›´æ–°ï¼‰vs MLPï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•</li>
            <li><strong>Readouté–¢æ•°</strong>: Set2Setã«ã‚ˆã‚‹æŸ”è»Ÿãªã‚°ãƒ©ãƒ•ãƒ¬ãƒ™ãƒ«è¡¨ç¾å­¦ç¿’</li>
            <li><strong>QM9äºˆæ¸¬</strong>: HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—ï¼ˆMAE 0.043 eVï¼‰ã€åŒæ¥µå­ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆï¼ˆMAE 0.033 Debyeï¼‰</li>
            <li><strong>CGCNN vs MPNN</strong>: çµæ™¶ç‰¹åŒ– vs æ±ç”¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•</li>
        </ol>

        <p>æ¬¡ç« ã§ã¯ã€çµ„æˆãƒ™ãƒ¼ã‚¹ç‰¹å¾´é‡ï¼ˆMagpieï¼‰ã¨GNNï¼ˆCGCNN/MPNNï¼‰ã®å®šé‡çš„æ¯”è¼ƒã‚’ã€Matbenchãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§å®Ÿæ–½ã—ã¾ã™ã€‚</p>

        <hr>

        <h2 id="exercises">æ¼”ç¿’å•é¡Œ</h2>

        <h3>Easyï¼ˆåŸºç¤ç¢ºèªï¼‰</h3>

        <details>
            <summary><strong>Q1</strong>: MPNNãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®3ã¤ã®ä¸»è¦ã‚¹ãƒ†ãƒƒãƒ—ã¯ä½•ã§ã™ã‹ï¼Ÿ</summary>

            <p><strong>æ­£è§£</strong>: Messageã€Updateã€Readout</p>

            <p><strong>è§£èª¬</strong>:</p>
            <p>MPNNï¼ˆGilmer et al. 2017, ICML, pp. 1265-1266ï¼‰ã¯ä»¥ä¸‹ã®3æ®µéšã§æ§‹æˆã•ã‚Œã¾ã™ï¼š</p>
            <ol>
                <li><strong>Message</strong>: è¿‘å‚ãƒãƒ¼ãƒ‰ã¨ã‚¨ãƒƒã‚¸ç‰¹å¾´é‡ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
                    <ul><li>å¼: \( m_v^{t+1} = \sum_{w \in \mathcal{N}(v)} M_t(\mathbf{h}_v^t, \mathbf{h}_w^t, \mathbf{e}_{vw}) \)</li></ul>
                </li>
                <li><strong>Update</strong>: ç¾åœ¨ã®çŠ¶æ…‹ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§éš ã‚ŒçŠ¶æ…‹ã‚’æ›´æ–°
                    <ul><li>å¼: \( \mathbf{h}_v^{t+1} = U_t(\mathbf{h}_v^t, m_v^{t+1}) \)</li></ul>
                </li>
                <li><strong>Readout</strong>: å…¨ãƒãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‹ã‚‰ã‚°ãƒ©ãƒ•ãƒ¬ãƒ™ãƒ«ã®è¡¨ç¾ã‚’ç”Ÿæˆ
                    <ul><li>å¼: \( \hat{y} = R(\{\mathbf{h}_v^T \mid v \in G\}) \)</li></ul>
                </li>
            </ol>
        </details>

        <details>
            <summary><strong>Q2</strong>: CGCNNã¨MPNNã®ä¸»ãªé•ã„ã¯ä½•ã§ã™ã‹ï¼Ÿ</summary>

            <p><strong>æ­£è§£</strong>: CGCNNï¼ˆçµæ™¶ç‰¹åŒ–ã€å›ºå®šã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰vs MPNNï¼ˆæ±ç”¨ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ï¼‰</p>

            <p><strong>è§£èª¬</strong>:</p>
            <table>
                <thead>
                    <tr>
                        <th>é …ç›®</th>
                        <th>CGCNN</th>
                        <th>MPNN</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>è¨­è¨ˆæ€æƒ³</strong></td>
                        <td>çµæ™¶ææ–™å°‚ç”¨</td>
                        <td>æ±ç”¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯</td>
                    </tr>
                    <tr>
                        <td><strong>Messageé–¢æ•°</strong></td>
                        <td>ã‚¨ãƒƒã‚¸ã‚²ãƒ¼ãƒˆæ©Ÿæ§‹ï¼ˆå›ºå®šï¼‰</td>
                        <td>ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½</td>
                    </tr>
                    <tr>
                        <td><strong>Updateé–¢æ•°</strong></td>
                        <td>æ®‹å·®æ¥ç¶š + BN</td>
                        <td>GRUã€LSTMã€MLPç­‰ã‚’é¸æŠ</td>
                    </tr>
                    <tr>
                        <td><strong>Readouté–¢æ•°</strong></td>
                        <td>å¹³å‡ãƒ—ãƒ¼ãƒªãƒ³ã‚°</td>
                        <td>Set2Setã€Attentionç­‰ã‚’é¸æŠ</td>
                    </tr>
                    <tr>
                        <td><strong>å‘¨æœŸå¢ƒç•Œæ¡ä»¶</strong></td>
                        <td>âœ… è€ƒæ…®</td>
                        <td>âŒ æ¨™æº–ã§ã¯éå¯¾å¿œ</td>
                    </tr>
                </tbody>
            </table>
        </details>

        <details>
            <summary><strong>Q3</strong>: QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®è¦æ¨¡ã¨ä¸»è¦ãªé‡å­åŒ–å­¦ç‰¹æ€§ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</summary>

            <p><strong>æ­£è§£</strong>: ç´„130,000åˆ†å­ã€13ç¨®é¡ã®é‡å­åŒ–å­¦ç‰¹æ€§ï¼ˆHOMOã€LUMOã€Gapã€Î¼ç­‰ï¼‰</p>

            <p><strong>è§£èª¬</strong>:</p>
            <p>QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆRamakrishnan et al., 2014, Scientific Data, 1, 140022, pp. 1-7ï¼‰:</p>
            <ul>
                <li><strong>åˆ†å­æ•°</strong>: 134,000ï¼ˆæœ€å¤§9é‡åŸå­ã€Cã€Hã€Oã€Nã€Fï¼‰</li>
                <li><strong>è¨ˆç®—æ‰‹æ³•</strong>: DFTï¼ˆB3LYP/6-31G(2df,p)ãƒ¬ãƒ™ãƒ«ï¼‰</li>
                <li><strong>ä¸»è¦ç‰¹æ€§</strong>:
                    <ul>
                        <li>HOMO: æœ€é«˜è¢«å è»Œé“ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆé›»å­ä¾›ä¸èƒ½åŠ›ï¼‰</li>
                        <li>LUMO: æœ€ä½ç©ºè»Œé“ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆé›»å­å—å®¹èƒ½åŠ›ï¼‰</li>
                        <li>Gap: HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—ï¼ˆåŠ±èµ·ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€0.04-0.5 eVç¯„å›²ï¼‰</li>
                        <li>Î¼: åŒæ¥µå­ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆï¼ˆåˆ†å­ã®æ¥µæ€§ã€0-10 Debyeï¼‰</li>
                        <li>Î±: åˆ†æ¥µç‡ï¼ˆå¤–éƒ¨é›»å ´ã¸ã®å¿œç­”ï¼‰</li>
                    </ul>
                </li>
            </ul>
        </details>

        <h3>Mediumï¼ˆå¿œç”¨ï¼‰</h3>

        <details>
            <summary><strong>Q4</strong>: GRU Updateã¨MLP Updateã®é•ã„ã‚’ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ã¨è¨ˆç®—ã‚³ã‚¹ãƒˆã®è¦³ç‚¹ã‹ã‚‰æ¯”è¼ƒã—ã¦ãã ã•ã„ã€‚</summary>

            <p><strong>æ­£è§£</strong>: GRUï¼ˆ24,768ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€å†å¸°çš„ï¼‰vs MLPï¼ˆ12,352ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ä¸¦åˆ—åŒ–å¯èƒ½ï¼‰</p>

            <p><strong>è§£èª¬</strong>:</p>
            <table>
                <thead>
                    <tr>
                        <th>é …ç›®</th>
                        <th>GRU Update</th>
                        <th>MLP Update</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°</strong><br/>ï¼ˆhidden_dim=64ï¼‰</td>
                        <td>24,768</td>
                        <td>12,352ï¼ˆç´„50%å‰Šæ¸›ï¼‰</td>
                    </tr>
                    <tr>
                        <td><strong>è¨ˆç®—æ–¹å¼</strong></td>
                        <td>å†å¸°çš„ï¼ˆã‚²ãƒ¼ãƒˆæ©Ÿæ§‹ï¼‰</td>
                        <td>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰</td>
                    </tr>
                    <tr>
                        <td><strong>ä¸¦åˆ—åŒ–</strong></td>
                        <td>å›°é›£ï¼ˆçŠ¶æ…‹ä¾å­˜ï¼‰</td>
                        <td>å®¹æ˜“ï¼ˆç‹¬ç«‹è¨ˆç®—ï¼‰</td>
                    </tr>
                    <tr>
                        <td><strong>è¡¨ç¾åŠ›</strong></td>
                        <td>é«˜ï¼ˆæ™‚ç³»åˆ—çš„ãªçŠ¶æ…‹æ›´æ–°ï¼‰</td>
                        <td>ä¸­ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªå¤‰æ›ï¼‰</td>
                    </tr>
                    <tr>
                        <td><strong>è¨“ç·´æ™‚é–“</strong></td>
                        <td>é•·ã„ï¼ˆå†å¸°è¨ˆç®—ï¼‰</td>
                        <td>çŸ­ã„ï¼ˆä¸¦åˆ—åŒ–å¯èƒ½ï¼‰</td>
                    </tr>
                    <tr>
                        <td><strong>æ¨å¥¨ã‚±ãƒ¼ã‚¹</strong></td>
                        <td>è¤‡é›‘ãªé›»å­æ§‹é€ ï¼ˆQM9ï¼‰</td>
                        <td>é«˜é€Ÿæ¨è«–ãŒå¿…è¦ãªå ´åˆ</td>
                    </tr>
                </tbody>
            </table>

            <p><strong>å®Ÿé¨“çš„æ¯”è¼ƒ</strong>ï¼ˆQM9ã€HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—äºˆæ¸¬ï¼‰:</p>
            <ul>
                <li>GRU Update: MAE 0.043 eVã€è¨“ç·´æ™‚é–“ 8åˆ†/epochï¼ˆV100ï¼‰</li>
                <li>MLP Update: MAE 0.051 eVã€è¨“ç·´æ™‚é–“ 5åˆ†/epochï¼ˆV100ï¼‰</li>
            </ul>
        </details>

        <details>
            <summary><strong>Q5</strong>: Set2Set Readouté–¢æ•°ã®å‹•ä½œåŸç†ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</summary>

            <p><strong>æ­£è§£</strong>: Attentionæ©Ÿæ§‹ã‚’ç”¨ã„ãŸé †åºä¸å¤‰ãªã‚°ãƒ©ãƒ•è¡¨ç¾ã®å­¦ç¿’</p>

            <p><strong>è§£èª¬</strong>:</p>
            <p>Set2Setï¼ˆVinyals et al., 2015ï¼‰ã¯ã€ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å‹•ä½œã—ã¾ã™ï¼š</p>
            <ol>
                <li><strong>åˆæœŸåŒ–</strong>: ã‚¯ã‚¨ãƒªãƒ™ã‚¯ãƒˆãƒ« \( \mathbf{q}^0 = \mathbf{0} \)</li>
                <li><strong>ç¹°ã‚Šè¿”ã—å‡¦ç†</strong>ï¼ˆTå›ã€é€šå¸¸T=3ï¼‰:
                    <ul>
                        <li>Attentionè¨ˆç®—: \( a_v^t = \text{softmax}(\mathbf{q}^t \cdot \mathbf{h}_v) \)</li>
                        <li>é‡ã¿ä»˜ãå’Œ: \( \mathbf{r}^t = \sum_v a_v^t \mathbf{h}_v \)</li>
                        <li>ã‚¯ã‚¨ãƒªæ›´æ–°: \( \mathbf{q}^{t+1} = \text{LSTM}([\mathbf{q}^t, \mathbf{r}^t]) \)</li>
                    </ul>
                </li>
                <li><strong>å‡ºåŠ›</strong>: \( [\mathbf{q}^T, \mathbf{r}^T] \)ï¼ˆ2å€ã®æ¬¡å…ƒï¼‰</li>
            </ol>

            <p><strong>åˆ©ç‚¹</strong>:</p>
            <ul>
                <li>ãƒãƒ¼ãƒ‰æ•°ã«ä¸å¤‰ï¼ˆåˆ†å­ã‚µã‚¤ã‚ºãŒç•°ãªã£ã¦ã‚‚åŒã˜æ¬¡å…ƒã®å‡ºåŠ›ï¼‰</li>
                <li>é‡è¦ãªãƒãƒ¼ãƒ‰ã‚’å¼·èª¿ï¼ˆAttentionæ©Ÿæ§‹ï¼‰</li>
                <li>é †åºä¸å¤‰ï¼ˆãƒãƒ¼ãƒ‰ã®ä¸¦ã³æ›¿ãˆã«ä¸å¤‰ï¼‰</li>
            </ul>

            <p><strong>æ¬ ç‚¹</strong>:</p>
            <ul>
                <li>è¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„ï¼ˆTå›ã®ç¹°ã‚Šè¿”ã—å‡¦ç†ï¼‰</li>
                <li>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ãŒå¤šã„ï¼ˆLSTMã€Attentionï¼‰</li>
            </ul>
        </details>

        <details>
            <summary><strong>Q6</strong>: MPNNã§QM9ã®HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—ã‚’äºˆæ¸¬ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ï¼ˆExample 6-8ã‚’å‚è€ƒã«ï¼‰ã€‚</summary>

            <p><strong>è§£ç­”ä¾‹</strong>:</p>
            <pre><code class="language-python">import torch
import torch.nn as nn
from torch.optim import Adam
from torch_geometric.datasets import QM9
from torch_geometric.loader import DataLoader

# QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿
dataset = QM9(root='./data/qm9')
train_dataset = dataset[:110000]
val_dataset = dataset[110000:120000]

train_loader = DataLoader(train_dataset, batch_size=64, shuffle=True)
val_loader = DataLoader(val_dataset, batch_size=64, shuffle=False)

# MPNNãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–
model = MPNN(
    node_features=11,
    edge_features=4,
    hidden_dim=64,
    num_layers=3,
    readout_steps=3
)

# è¨“ç·´
device = 'cuda' if torch.cuda.is_available() else 'cpu'
model = model.to(device)
optimizer = Adam(model.parameters(), lr=0.001)
criterion = nn.L1Loss()

for epoch in range(50):
    model.train()
    train_loss = 0.0

    for batch in train_loader:
        batch = batch.to(device)
        optimizer.zero_grad()

        # HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—äºˆæ¸¬ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹4ï¼‰
        pred = model(batch)
        target = batch.y[:, 4].unsqueeze(1)

        loss = criterion(pred, target)
        loss.backward()
        optimizer.step()

        train_loss += loss.item() * batch.num_graphs

    train_loss /= len(train_loader.dataset)

    if (epoch + 1) % 10 == 0:
        print(f"Epoch {epoch+1}: Train Loss = {train_loss:.4f} eV")

# æ¤œè¨¼
model.eval()
val_preds, val_targets = [], []
with torch.no_grad():
    for batch in val_loader:
        batch = batch.to(device)
        pred = model(batch)
        target = batch.y[:, 4].unsqueeze(1)

        val_preds.extend(pred.cpu().numpy())
        val_targets.extend(target.cpu().numpy())

from sklearn.metrics import mean_absolute_error
mae = mean_absolute_error(val_targets, val_preds)
print(f"Validation MAE: {mae:.4f} eV")
# æœŸå¾…å€¤: ç´„0.043 eVï¼ˆè«–æ–‡å€¤ï¼‰
</code></pre>
        </details>

        <h3>Hardï¼ˆç™ºå±•ï¼‰</h3>

        <details>
            <summary><strong>Q7</strong>: MPNNãŒQM9ã§å„ªã‚Œã€CGCNNãŒMaterials Projectã§å„ªã‚Œã‚‹ç†ç”±ã‚’ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¦³ç‚¹ã‹ã‚‰è©³ã—ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚</summary>

            <p><strong>è§£ç­”</strong>:</p>

            <p><strong>MPNNãŒQM9ï¼ˆåˆ†å­ï¼‰ã§å„ªã‚Œã‚‹ç†ç”±</strong>:</p>
            <ol>
                <li><strong>Set2Set Readout</strong>:
                    <ul>
                        <li>åˆ†å­ã‚µã‚¤ã‚ºï¼ˆ5-29åŸå­ï¼‰ã®å¤‰å‹•ãŒå¤§ãã„</li>
                        <li>Set2Setã¯åˆ†å­ã‚µã‚¤ã‚ºã«ä¸å¤‰ãªè¡¨ç¾ã‚’å­¦ç¿’</li>
                        <li>é‡è¦ãªåŸå­ï¼ˆå®˜èƒ½åŸºã€èŠ³é¦™ç’°ï¼‰ã‚’Attentionã§å¼·èª¿</li>
                    </ul>
                </li>
                <li><strong>GRU Update</strong>:
                    <ul>
                        <li>åˆ†å­ã®é›»å­æ§‹é€ ã¯è¤‡é›‘ï¼ˆå…±å½¹ç³»ã€Ï€é›»å­ç­‰ï¼‰</li>
                        <li>GRUã¯æ™‚ç³»åˆ—çš„ã«çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€è¤‡é›‘ãªç›¸äº’ä½œç”¨ã‚’æ‰ãˆã‚‹</li>
                        <li>HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—ã¯é›»å­çŠ¶æ…‹ã®å¾®å¦™ãªé•ã„ã«ä¾å­˜</li>
                    </ul>
                </li>
                <li><strong>ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§</strong>:
                    <ul>
                        <li>çµåˆã‚¿ã‚¤ãƒ—ï¼ˆå˜çµåˆã€äºŒé‡çµåˆã€èŠ³é¦™æ—ï¼‰ã‚’æŸ”è»Ÿã«æ‰±ã†</li>
                        <li>ã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§çµåˆã®é‡ã¿ä»˜ã‘ã‚’å­¦ç¿’</li>
                    </ul>
                </li>
            </ol>

            <p><strong>CGCNNãŒMaterials Projectï¼ˆçµæ™¶ï¼‰ã§å„ªã‚Œã‚‹ç†ç”±</strong>:</p>
            <ol>
                <li><strong>å‘¨æœŸå¢ƒç•Œæ¡ä»¶</strong>:
                    <ul>
                        <li>çµæ™¶ã¯ç„¡é™ã«ç¹°ã‚Šè¿”ã•ã‚Œã‚‹å‘¨æœŸæ§‹é€ </li>
                        <li>CGCNNã¯å˜ä½æ ¼å­å¤–ã®è¿‘å‚åŸå­ã‚‚è€ƒæ…®</li>
                        <li>MPNNã¯æ¨™æº–ã§ã¯å‘¨æœŸå¢ƒç•Œæ¡ä»¶ã‚’æ‰±ãˆãªã„</li>
                    </ul>
                </li>
                <li><strong>ã‚¨ãƒƒã‚¸ã‚²ãƒ¼ãƒˆæ©Ÿæ§‹</strong>:
                    <ul>
                        <li>çµæ™¶ã¯åŸå­é–“è·é›¢ã«ä¾å­˜ã—ãŸé•·è·é›¢ç›¸äº’ä½œç”¨</li>
                        <li>ã‚¨ãƒƒã‚¸ã‚²ãƒ¼ãƒˆã¯è·é›¢ã«å¿œã˜ãŸé©å¿œçš„ãªé‡ã¿ä»˜ã‘</li>
                        <li>è¿‘ã„åŸå­ã‚’å¼·èª¿ã€é ã„åŸå­ã‚’æŠ‘åˆ¶</li>
                    </ul>
                </li>
                <li><strong>ãƒ‰ãƒ¡ã‚¤ãƒ³æœ€é©åŒ–</strong>:
                    <ul>
                        <li>çµæ™¶ã®é…ä½ç’°å¢ƒï¼ˆç¬¬ä¸€è¿‘æ¥ã€ç¬¬äºŒè¿‘æ¥ï¼‰ã‚’æ˜ç¤ºçš„ã«ãƒ¢ãƒ‡ãƒ«åŒ–</li>
                        <li>ã‚¬ã‚¦ã‚¹å±•é–‹ã§åŸå­é–“è·é›¢ã‚’æ»‘ã‚‰ã‹ã«è¡¨ç¾</li>
                    </ul>
                </li>
            </ol>

            <p><strong>å®šé‡çš„æ¯”è¼ƒ</strong>:</p>
            <table>
                <thead>
                    <tr>
                        <th>ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ</th>
                        <th>ç‰¹å¾´</th>
                        <th>CGCNNï¼ˆMAEï¼‰</th>
                        <th>MPNNï¼ˆMAEï¼‰</th>
                        <th>å·®åˆ†</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Materials Project</td>
                        <td>å‘¨æœŸæ§‹é€ ã€é•·è·é›¢ç›¸äº’ä½œç”¨</td>
                        <td>0.039 eV/atom</td>
                        <td>0.065 eV/atom</td>
                        <td>+67%æ‚ªåŒ–</td>
                    </tr>
                    <tr>
                        <td>QM9</td>
                        <td>è¤‡é›‘ãªé›»å­æ§‹é€ ã€åˆ†å­ã‚µã‚¤ã‚ºå¤‰å‹•</td>
                        <td>0.068 eV</td>
                        <td>0.043 eV</td>
                        <td>+58%æ”¹å–„</td>
                    </tr>
                </tbody>
            </table>
        </details>

        <details>
            <summary><strong>Q8</strong>: Set2Set Readoutã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ã‚’è¨ˆç®—ã—ã¦ãã ã•ã„ï¼ˆhidden_dim=64ã€processing_steps=3ã®å ´åˆï¼‰ã€‚</summary>

            <p><strong>æ­£è§£</strong>: ç´„49,536ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</p>

            <p><strong>è¨ˆç®—éç¨‹</strong>:</p>
            <p>Set2Setå±¤ã¯ã€LSTMã¨Attentionæ©Ÿæ§‹ã‹ã‚‰æ§‹æˆã•ã‚Œã¾ã™ï¼ˆVinyals et al., 2015ï¼‰ã€‚</p>

            <ol>
                <li><strong>LSTM</strong>ï¼ˆå…¥åŠ›: 2 * hidden_dimã€éš ã‚Œ: hidden_dimï¼‰:
                    <ul>
                        <li>å…¥åŠ›ã‚²ãƒ¼ãƒˆ: (2 * 64 + 64) Ã— 64 = 8,192</li>
                        <li>å¿˜å´ã‚²ãƒ¼ãƒˆ: (2 * 64 + 64) Ã— 64 = 8,192</li>
                        <li>ã‚»ãƒ«ã‚²ãƒ¼ãƒˆ: (2 * 64 + 64) Ã— 64 = 8,192</li>
                        <li>å‡ºåŠ›ã‚²ãƒ¼ãƒˆ: (2 * 64 + 64) Ã— 64 = 8,192</li>
                        <li>ãƒã‚¤ã‚¢ã‚¹: 4 Ã— 64 = 256</li>
                        <li>åˆè¨ˆ: 33,024</li>
                    </ul>
                </li>
                <li><strong>Attentionæ©Ÿæ§‹</strong>:
                    <ul>
                        <li>ã‚¯ã‚¨ãƒªæŠ•å½±: 64 Ã— 64 + 64 = 4,160</li>
                        <li>ã‚­ãƒ¼æŠ•å½±: 64 Ã— 64 + 64 = 4,160</li>
                        <li>åˆè¨ˆ: 8,320</li>
                    </ul>
                </li>
                <li><strong>å‡ºåŠ›å±¤</strong>ï¼ˆ2 * hidden_dim â†’ 1ï¼‰:
                    <ul>
                        <li>é‡ã¿: 2 * 64 Ã— 1 = 128</li>
                        <li>ãƒã‚¤ã‚¢ã‚¹: 1</li>
                        <li>åˆè¨ˆ: 129</li>
                    </ul>
                </li>
                <li><strong>ç·ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°</strong>: 33,024 + 8,320 + 129 = <strong>41,473</strong></li>
            </ol>

            <p>æ³¨: å®Ÿè£…ã«ã‚ˆã‚Šç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚PyTorch Geometricå®Ÿè£…ã§ã¯ç´„49,536ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã™ã€‚</p>
        </details>

        <details>
            <summary><strong>Q9</strong>: MPNNã®Messageé–¢æ•°ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã€çµåˆã‚¿ã‚¤ãƒ—ï¼ˆå˜çµåˆã€äºŒé‡çµåˆã€èŠ³é¦™æ—ï¼‰ã‚’æ˜ç¤ºçš„ã«æ‰±ã†å®Ÿè£…ã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚</summary>

            <p><strong>è§£ç­”ä¾‹</strong>:</p>
            <pre><code class="language-python">import torch
import torch.nn as nn
from torch_geometric.nn import MessagePassing

class BondTypeMessage(MessagePassing):
    """çµåˆã‚¿ã‚¤ãƒ—ã‚’æ˜ç¤ºçš„ã«æ‰±ã†Messageé–¢æ•°

    çµåˆã‚¿ã‚¤ãƒ—ï¼ˆå˜çµåˆ=1ã€äºŒé‡çµåˆ=2ã€ä¸‰é‡çµåˆ=3ã€èŠ³é¦™æ—=4ï¼‰
    ã”ã¨ã«ç•°ãªã‚‹MLPã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã€‚
    """
    def __init__(self, node_dim, message_dim, num_bond_types=4):
        """
        Args:
            node_dim (int): ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ã®æ¬¡å…ƒ
            message_dim (int): ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¬¡å…ƒ
            num_bond_types (int): çµåˆã‚¿ã‚¤ãƒ—ã®ç¨®é¡æ•°
        """
        super().__init__(aggr='add')

        # çµåˆã‚¿ã‚¤ãƒ—ã”ã¨ã®MLP
        self.bond_mlps = nn.ModuleList([
            nn.Sequential(
                nn.Linear(2 * node_dim, message_dim),
                nn.ReLU(),
                nn.Linear(message_dim, message_dim)
            )
            for _ in range(num_bond_types)
        ])

        # çµåˆã‚¿ã‚¤ãƒ—ã®one-hotåŸ‹ã‚è¾¼ã¿
        self.num_bond_types = num_bond_types

    def forward(self, x, edge_index, bond_type):
        """
        Args:
            x (Tensor): ãƒãƒ¼ãƒ‰ç‰¹å¾´é‡ [num_nodes, node_dim]
            edge_index (Tensor): ã‚¨ãƒƒã‚¸ãƒªã‚¹ãƒˆ [2, num_edges]
            bond_type (Tensor): çµåˆã‚¿ã‚¤ãƒ— [num_edges]ï¼ˆ0-indexedï¼‰

        Returns:
            Tensor: é›†ç´„ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ [num_nodes, message_dim]
        """
        return self.propagate(edge_index, x=x, bond_type=bond_type)

    def message(self, x_i, x_j, bond_type):
        """çµåˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ

        Args:
            x_i (Tensor): å—ä¿¡ãƒãƒ¼ãƒ‰ [num_edges, node_dim]
            x_j (Tensor): é€ä¿¡ãƒãƒ¼ãƒ‰ [num_edges, node_dim]
            bond_type (Tensor): çµåˆã‚¿ã‚¤ãƒ— [num_edges]

        Returns:
            Tensor: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ [num_edges, message_dim]
        """
        # ãƒãƒ¼ãƒ‰ã‚’é€£çµ
        combined = torch.cat([x_i, x_j], dim=1)

        # çµåˆã‚¿ã‚¤ãƒ—ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
        messages = []
        for i in range(self.num_bond_types):
            # è©²å½“ã™ã‚‹çµåˆã‚¿ã‚¤ãƒ—ã®ã‚¨ãƒƒã‚¸ã‚’æŠ½å‡º
            mask = (bond_type == i)
            if mask.any():
                # è©²å½“MLPã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
                msg_i = self.bond_mlps[i](combined[mask])
                messages.append((mask, msg_i))

        # å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çµ±åˆ
        output = torch.zeros(combined.shape[0], messages[0][1].shape[1],
                             device=combined.device)
        for mask, msg in messages:
            output[mask] = msg

        return output

# ä½¿ç”¨ä¾‹
node_dim = 64
message_dim = 64

# çµåˆã‚¿ã‚¤ãƒ—ã‚’è€ƒæ…®ã—ãŸMessageé–¢æ•°
bond_msg = BondTypeMessage(node_dim, message_dim, num_bond_types=4)

# ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
x = torch.randn(5, node_dim)
edge_index = torch.tensor([[0, 1, 1, 2, 2, 3],
                            [1, 0, 2, 1, 3, 2]], dtype=torch.long)
bond_type = torch.tensor([0, 0, 1, 1, 3, 3], dtype=torch.long)  # å˜çµåˆã€äºŒé‡çµåˆã€èŠ³é¦™æ—

# Messageé–¢æ•°å®Ÿè¡Œ
messages = bond_msg(x, edge_index, bond_type)

print(f"çµåˆã‚¿ã‚¤ãƒ—è€ƒæ…®Messageé–¢æ•°:")
print(f"  å…¥åŠ›ãƒãƒ¼ãƒ‰: {x.shape}")
print(f"  çµåˆã‚¿ã‚¤ãƒ—: {bond_type}")
print(f"  å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {messages.shape}")
print(f"  ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°: {sum(p.numel() for p in bond_msg.parameters()):,}")
</code></pre>

            <p><strong>è§£èª¬</strong>:</p>
            <ul>
                <li>å˜çµåˆã€äºŒé‡çµåˆã€ä¸‰é‡çµåˆã€èŠ³é¦™æ—ã§ç•°ãªã‚‹MLPã‚’ä½¿ç”¨</li>
                <li>çµåˆã‚¿ã‚¤ãƒ—ã”ã¨ã®ç‰¹æ€§ï¼ˆçµåˆé•·ã€çµåˆã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼‰ã‚’æ˜ç¤ºçš„ã«å­¦ç¿’</li>
                <li>QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®çµåˆã‚¿ã‚¤ãƒ—æƒ…å ±ã‚’æ´»ç”¨ã§ãã‚‹</li>
                <li>è¨ˆç®—ã‚³ã‚¹ãƒˆã¯å¢—åŠ ã™ã‚‹ãŒã€ç²¾åº¦å‘ä¸ŠãŒæœŸå¾…ã§ãã‚‹</li>
            </ul>
        </details>

        <hr>

        <h2 id="objectives">å­¦ç¿’ç›®æ¨™ã®ç¢ºèª</h2>

        <p>ã“ã®chapterã‚’å®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã‚’èª¬æ˜ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š</p>

        <h3>åŸºæœ¬ç†è§£</h3>
        <ul>
            <li>âœ… MPNNã®3æ®µéšï¼ˆMessage/Update/Readoutï¼‰ã‚’èª¬æ˜ã§ãã‚‹</li>
            <li>âœ… CGCNN vs MPNNã®è¨­è¨ˆæ€æƒ³ã®é•ã„ã‚’ç†è§£ã—ã¦ã„ã‚‹</li>
            <li>âœ… QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®é‡å­åŒ–å­¦ç‰¹æ€§ã‚’èª¬æ˜ã§ãã‚‹</li>
            <li>âœ… Set2Set Readoutã®å‹•ä½œåŸç†ã‚’ç†è§£ã—ã¦ã„ã‚‹</li>
        </ul>

        <h3>å®Ÿè·µã‚¹ã‚­ãƒ«</h3>
        <ul>
            <li>âœ… MPNNã®Messageã€Updateã€Readouté–¢æ•°ã‚’ã‚¹ã‚¯ãƒ©ãƒƒãƒå®Ÿè£…ã§ãã‚‹</li>
            <li>âœ… QM9ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§HOMO-LUMOã‚®ãƒ£ãƒƒãƒ—ã‚’äºˆæ¸¬ã§ãã‚‹ï¼ˆMAE < 0.05 eVç›®æ¨™ï¼‰</li>
            <li>âœ… GRU Updateã¨MLP Updateã‚’å®Ÿè£…ã—ã€æ€§èƒ½ã‚’æ¯”è¼ƒã§ãã‚‹</li>
            <li>âœ… Set2Set Readoutã‚’å®Ÿè£…ã—ã€åˆ†å­ã‚µã‚¤ã‚ºä¸å¤‰ãªè¡¨ç¾ã‚’å­¦ç¿’ã§ãã‚‹</li>
        </ul>

        <h3>å¿œç”¨åŠ›</h3>
        <ul>
            <li>âœ… CGCNN vs MPNNã®ä½¿ã„åˆ†ã‘ã‚’å®šé‡çš„ã«è©•ä¾¡ã§ãã‚‹</li>
            <li>âœ… ã‚«ã‚¹ã‚¿ãƒ Messageé–¢æ•°ã‚’è¨­è¨ˆã—ã€ãƒ‰ãƒ¡ã‚¤ãƒ³çŸ¥è­˜ã‚’çµ„ã¿è¾¼ã‚ã‚‹</li>
            <li>âœ… è«–æ–‡ã®æ€§èƒ½ï¼ˆHOMO-LUMOã‚®ãƒ£ãƒƒãƒ— MAE 0.043 eVï¼‰ã‚’å†ç¾ã™ã‚‹ãŸã‚ã®æ¡ä»¶ã‚’ç†è§£ã—ã¦ã„ã‚‹</li>
        </ul>

        <hr>

        <h2 id="next">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h2>

        <p>æ¬¡ç« ã§ã¯ã€çµ„æˆãƒ™ãƒ¼ã‚¹ç‰¹å¾´é‡ï¼ˆMagpieï¼‰ã¨GNNï¼ˆCGCNN/MPNNï¼‰ã®å®šé‡çš„æ¯”è¼ƒã‚’ã€Matbenchãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§å®Ÿæ–½ã—ã¾ã™ã€‚äºˆæ¸¬ç²¾åº¦ã€è¨ˆç®—ã‚³ã‚¹ãƒˆã€ãƒ‡ãƒ¼ã‚¿è¦ä»¶ã€è§£é‡ˆæ€§ã®4è»¸ã§å¾¹åº•åˆ†æã—ã€å®Ÿè·µçš„ãªæ‰‹æ³•é¸æŠã®æ„æ€æ±ºå®šèƒ½åŠ›ã‚’é¤Šã„ã¾ã™ã€‚</p>

        <div class="nav-buttons">
            <a href="./chapter-2.html" class="nav-button">â† ç¬¬2ç« ï¼šCGCNNå®Ÿè£…</a>
            <a href="./chapter-4.html" class="nav-button">ç¬¬4ç« ï¼šçµ„æˆãƒ™ãƒ¼ã‚¹ vs GNNå®šé‡çš„æ¯”è¼ƒ â†’</a>
        </div>

        <hr>

        <h2 id="references">å‚è€ƒæ–‡çŒ®</h2>

        <ol>
            <li>Gilmer, J., Schoenholz, S. S., Riley, P. F., Vinyals, O., & Dahl, G. E. (2017). "Neural Message Passing for Quantum Chemistry." <em>Proceedings of the 34th International Conference on Machine Learning</em>, PMLR 70, pp. 1263-1272.</li>
            <li>Ramakrishnan, R., Dral, P. O., Rupp, M., & von Lilienfeld, O. A. (2014). "Quantum chemistry structures and properties of 134 kilo molecules." <em>Scientific Data</em>, 1, 140022, pp. 1-7.</li>
            <li>SchÃ¼tt, K. T., Kindermans, P. J., Sauceda, H. E., Chmiela, S., Tkatchenko, A., & MÃ¼ller, K. R. (2017). "SchNet: A continuous-filter convolutional neural network for modeling quantum interactions." <em>Advances in Neural Information Processing Systems</em>, 30, pp. 991-1001.</li>
            <li>Fey, M., & Lenssen, J. E. (2019). "Fast Graph Representation Learning with PyTorch Geometric." <em>ICLR Workshop on Representation Learning on Graphs and Manifolds</em>, pp. 1-9.</li>
            <li>Vinyals, O., Bengio, S., & Kudlur, M. (2015). "Order Matters: Sequence to sequence for sets." <em>arXiv preprint arXiv:1511.06391</em>, pp. 1-11.</li>
            <li>Xie, T., & Grossman, J. C. (2018). "Crystal Graph Convolutional Neural Networks for an Accurate and Interpretable Prediction of Material Properties." <em>Physical Review Letters</em>, 120(14), 145301, pp. 1-6.</li>
            <li>Wu, Z., Ramsundar, B., Feinberg, E. N., Gomes, J., Geniesse, C., Pappu, A. S., Leswing, K., & Pande, V. (2018). "MoleculeNet: a benchmark for molecular machine learning." <em>Chemical Science</em>, 9(2), pp. 513-530.</li>
        </ol>

    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 AI Terakoya - Dr. Yusuke Hashimoto, Tohoku University</p>
            <p>Licensed under CC BY 4.0</p>
        </div>
    </footer>
</body>
</html>
