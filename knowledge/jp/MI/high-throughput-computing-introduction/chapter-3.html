<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬3ç« ï¼šã‚¸ãƒ§ãƒ–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã¨ä¸¦åˆ—åŒ–ï¼ˆSLURM, PBSï¼‰ - AI Terakoya</title>

    <style>
        :root {
            --color-primary: #2c3e50;
            --color-primary-dark: #1a252f;
            --color-accent: #7b2cbf;
            --color-accent-light: #9d4edd;
            --color-text: #2d3748;
            --color-text-light: #4a5568;
            --color-bg: #ffffff;
            --color-bg-alt: #f7fafc;
            --color-border: #e2e8f0;
            --color-code-bg: #f8f9fa;
            --color-link: #3182ce;
            --color-link-hover: #2c5aa0;

            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;

            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;

            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.7;
            color: var(--color-text);
            background-color: var(--color-bg);
            font-size: 16px;
        }

        header {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: var(--spacing-md);
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 var(--spacing-md) var(--spacing-xl);
        }

        h2 {
            font-size: 1.75rem;
            color: var(--color-primary);
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-xs);
            border-bottom: 3px solid var(--color-accent);
        }

        h3 {
            font-size: 1.4rem;
            color: var(--color-primary);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
        }

        h4 {
            font-size: 1.1rem;
            color: var(--color-primary-dark);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        p {
            margin-bottom: var(--spacing-md);
            color: var(--color-text);
        }

        a {
            color: var(--color-link);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--color-link-hover);
            text-decoration: underline;
        }

        ul, ol {
            margin-left: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        li {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text);
        }

        pre {
            background-color: var(--color-code-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            overflow-x: auto;
            margin-bottom: var(--spacing-md);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            font-family: var(--font-mono);
            font-size: 0.9em;
            background-color: var(--color-code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
            font-size: 0.95rem;
        }

        th, td {
            border: 1px solid var(--color-border);
            padding: var(--spacing-sm);
            text-align: left;
        }

        th {
            background-color: var(--color-bg-alt);
            font-weight: 600;
            color: var(--color-primary);
        }

        blockquote {
            border-left: 4px solid var(--color-accent);
            padding-left: var(--spacing-md);
            margin: var(--spacing-md) 0;
            color: var(--color-text-light);
            font-style: italic;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .mermaid {
            text-align: center;
            margin: var(--spacing-lg) 0;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        details {
            background-color: var(--color-bg-alt);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--color-primary);
            user-select: none;
            padding: var(--spacing-xs);
            margin: calc(-1 * var(--spacing-md));
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        summary:hover {
            background-color: rgba(123, 44, 191, 0.1);
        }

        details[open] summary {
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .learning-objectives {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--color-accent);
            margin-bottom: var(--spacing-xl);
        }

        .learning-objectives h2 {
            margin-top: 0;
            border-bottom: none;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin: var(--spacing-xl) 0;
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--color-border);
        }

        .nav-button {
            flex: 1;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--box-shadow);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-decoration: none;
        }

        footer {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg) var(--spacing-md);
            background-color: var(--color-bg-alt);
            border-top: 1px solid var(--color-border);
            text-align: center;
            font-size: 0.9rem;
            color: var(--color-text-light);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.4rem;
            }

            h3 {
                font-size: 1.2rem;
            }

            .meta {
                font-size: 0.85rem;
            }

            .navigation {
                flex-direction: column;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: var(--spacing-xs);
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default', securityLevel: 'strict' });
    </script>

    <!-- MathJax for LaTeX equation rendering -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\(', '\)']],
                displayMath: [['$$', '$$'], ['\[', '\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'mermaid'
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ç¬¬3ç« ï¼šã‚¸ãƒ§ãƒ–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã¨ä¸¦åˆ—åŒ–ï¼ˆSLURM, PBSï¼‰</h1>
            <p class="subtitle"></p>
            <div class="meta">
                <span class="meta-item">ğŸ“– èª­äº†æ™‚é–“: 25-30åˆ†</span>
                <span class="meta-item">ğŸ“Š é›£æ˜“åº¦: ä¸Šç´š</span>
                <span class="meta-item">ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹: 5-6å€‹</span>
                <span class="meta-item">ğŸ“ æ¼”ç¿’å•é¡Œ: 0å•</span>
            </div>
        </div>
    </header>

    <main class="container">
<h1>ç¬¬3ç« ï¼šã‚¸ãƒ§ãƒ–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã¨ä¸¦åˆ—åŒ–ï¼ˆSLURM, PBSï¼‰</h1>
<p class="chapter-description" style="margin: 1.5rem 0; padding: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #7b2cbf; border-radius: 8px; font-size: 1.05rem; line-height: 1.8; color: #2d3748;">FireWorks/AiiDAã§ã®ä¾å­˜é–¢ä¿‚ç®¡ç†ã¨å†å®Ÿè¡Œæ€§ã‚’ç¢ºä¿ã™ã‚‹è¨­è¨ˆã‚’ç†è§£ã—ã¾ã™ã€‚ãƒ­ã‚°ã¨å¯è¦³æ¸¬æ€§ã®è¦ç‚¹ã‚‚æŠ¼ã•ãˆã¾ã™ã€‚</p>
<p class="chapter-supplement" style="margin: 0.75rem 0 1.5rem 0; padding: 0.75rem 1rem; background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%); border-left: 3px solid #f59e0b; border-radius: 6px; font-size: 0.95rem; line-height: 1.7; color: #4a5568;"><strong>ğŸ’¡ è£œè¶³:</strong> DAGï¼ˆæµã‚Œå›³ï¼‰ã§å…¨ä½“åƒã‚’å¯è¦–åŒ–ã€‚ä¸­é–“ç”Ÿæˆç‰©ã®ä¿å­˜å ´æ‰€ã‚’æ±ºã‚ã¦ãŠãã¨å¾©æ—§ãŒé€Ÿã„ã§ã™ã€‚</p>





<h2>å­¦ç¿’ç›®æ¨™</h2>
<p>ã“ã®ç« ã‚’èª­ã‚€ã“ã¨ã§ã€ä»¥ä¸‹ã‚’ç¿’å¾—ã§ãã¾ã™ï¼š</p>
<ul>
<li>âœ… SLURMã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¦ã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥ã§ãã‚‹</li>
<li>âœ… MPIä¸¦åˆ—è¨ˆç®—ã®åŠ¹ç‡ã‚’è©•ä¾¡ã§ãã‚‹</li>
<li>âœ… Pythonã§ã‚¸ãƒ§ãƒ–ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã‘ã‚‹</li>
<li>âœ… 1000ææ–™è¦æ¨¡ã®ä¸¦åˆ—è¨ˆç®—ã‚’è¨­è¨ˆã§ãã‚‹</li>
<li>âœ… ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ã‚ˆã‚‹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãŒã§ãã‚‹</li>
</ul>
<hr />
<h2>3.1 ã‚¸ãƒ§ãƒ–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã®åŸºç¤</h2>
<h3>SLURM vs PBS vs Torque</h3>
<table>
<thead>
<tr>
<th>ç‰¹å¾´</th>
<th>SLURM</th>
<th>PBS Pro</th>
<th>Torque</th>
</tr>
</thead>
<tbody>
<tr>
<td>é–‹ç™ºå…ƒ</td>
<td>SchedMD</td>
<td>Altair</td>
<td>Adaptive Computing</td>
</tr>
<tr>
<td>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</td>
<td>GPLï¼ˆä¸€éƒ¨å•†ç”¨ï¼‰</td>
<td>å•†ç”¨</td>
<td>ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹</td>
</tr>
<tr>
<td>æ¡ç”¨ä¾‹</td>
<td>TSUBAMEã€TOP500ã®å¤šã</td>
<td>NASAã€DOEå›½ç«‹ç ”ç©¶æ‰€</td>
<td>å¤šãã®å¤§å­¦</td>
</tr>
<tr>
<td>ã‚³ãƒãƒ³ãƒ‰</td>
<td><code>sbatch</code>, <code>squeue</code></td>
<td><code>qsub</code>, <code>qstat</code></td>
<td><code>qsub</code>, <code>qstat</code></td>
</tr>
<tr>
<td>æ¨å¥¨ç”¨é€”</td>
<td>å¤§è¦æ¨¡HPC</td>
<td>ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º</td>
<td>ä¸­å°è¦æ¨¡HPC</td>
</tr>
</tbody>
</table>
<h3>SLURMã®åŸºæœ¬æ¦‚å¿µ</h3>
<div class="mermaid">
flowchart TD
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼] -->|sbatch| B[ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼]
    B --> C{ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©}
    C -->|ãƒªã‚½ãƒ¼ã‚¹å‰²å½“| D[è¨ˆç®—ãƒãƒ¼ãƒ‰1]
    C -->|ãƒªã‚½ãƒ¼ã‚¹å‰²å½“| E[è¨ˆç®—ãƒãƒ¼ãƒ‰2]
    C -->|ãƒªã‚½ãƒ¼ã‚¹å‰²å½“| F[è¨ˆç®—ãƒãƒ¼ãƒ‰N]

    D --> G[ã‚¸ãƒ§ãƒ–å®Œäº†]
    E --> G
    F --> G

    style C fill:#4ecdc4
</div>

<p><strong>ä¸»è¦ã‚³ãƒãƒ³ãƒ‰</strong>:</p>
<pre><code class="language-bash"># ã‚¸ãƒ§ãƒ–æŠ•å…¥
sbatch job.sh

# ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ç¢ºèª
squeue -u username

# ã‚¸ãƒ§ãƒ–ã‚­ãƒ£ãƒ³ã‚»ãƒ«
scancel job_id

# ãƒãƒ¼ãƒ‰æƒ…å ±
sinfo

# ã‚¸ãƒ§ãƒ–è©³ç´°
scontrol show job job_id
</code></pre>
<hr />
<h2>3.2 SLURMã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ</h2>
<h3>åŸºæœ¬çš„ãªSLURMã‚¹ã‚¯ãƒªãƒ—ãƒˆ</h3>
<pre><code class="language-bash">#!/bin/bash
#SBATCH --job-name=vasp_relax       # ã‚¸ãƒ§ãƒ–å
#SBATCH --output=slurm-%j.out       # æ¨™æº–å‡ºåŠ›ï¼ˆ%j=ã‚¸ãƒ§ãƒ–IDï¼‰
#SBATCH --error=slurm-%j.err        # æ¨™æº–ã‚¨ãƒ©ãƒ¼
#SBATCH --nodes=1                   # ãƒãƒ¼ãƒ‰æ•°
#SBATCH --ntasks-per-node=48        # ãƒãƒ¼ãƒ‰ã‚ãŸã‚ŠMPIãƒ—ãƒ­ã‚»ã‚¹æ•°
#SBATCH --cpus-per-task=1           # ã‚¿ã‚¹ã‚¯ã‚ãŸã‚Šã‚¹ãƒ¬ãƒƒãƒ‰æ•°
#SBATCH --time=24:00:00             # æ™‚é–“åˆ¶é™ï¼ˆ24æ™‚é–“ï¼‰
#SBATCH --partition=standard        # ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ï¼ˆã‚­ãƒ¥ãƒ¼ï¼‰
#SBATCH --account=project_name      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå

# ç’°å¢ƒè¨­å®š
module purge
module load intel/2021.2
module load vasp/6.3.0

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
cd $SLURM_SUBMIT_DIR

# VASPå®Ÿè¡Œ
echo &quot;ã‚¸ãƒ§ãƒ–é–‹å§‹: $(date)&quot;
echo &quot;ãƒ›ã‚¹ãƒˆ: $(hostname)&quot;
echo &quot;ãƒãƒ¼ãƒ‰æ•°: $SLURM_JOB_NUM_NODES&quot;
echo &quot;ãƒ—ãƒ­ã‚»ã‚¹æ•°: $SLURM_NTASKS&quot;

mpirun -np $SLURM_NTASKS vasp_std

echo &quot;ã‚¸ãƒ§ãƒ–çµ‚äº†: $(date)&quot;
</code></pre>
<h3>ã‚¢ãƒ¬ã‚¤ã‚¸ãƒ§ãƒ–ã«ã‚ˆã‚‹ä¸¦åˆ—å®Ÿè¡Œ</h3>
<p><strong>100ææ–™ã‚’ä¸¦åˆ—è¨ˆç®—</strong>:</p>
<pre><code class="language-bash">#!/bin/bash
#SBATCH --job-name=vasp_array
#SBATCH --output=logs/slurm-%A_%a.out  # %A=ã‚¢ãƒ¬ã‚¤ã‚¸ãƒ§ãƒ–ID, %a=ã‚¿ã‚¹ã‚¯ID
#SBATCH --error=logs/slurm-%A_%a.err
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=48
#SBATCH --time=24:00:00
#SBATCH --array=1-100%10              # 1-100ã®ã‚¿ã‚¹ã‚¯ã€åŒæ™‚10å€‹ã¾ã§

# ç’°å¢ƒè¨­å®š
module load vasp/6.3.0

# ææ–™ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
MATERIAL_LIST=&quot;materials.txt&quot;
MATERIAL=$(sed -n &quot;${SLURM_ARRAY_TASK_ID}p&quot; $MATERIAL_LIST)

echo &quot;å‡¦ç†ä¸­: ã‚¿ã‚¹ã‚¯ID=${SLURM\_ARRAY\_TASK\_ID}, ææ–™=${MATERIAL}&quot;

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORK_DIR=&quot;calculations/${MATERIAL}&quot;
cd $WORK_DIR

# VASPå®Ÿè¡Œ
mpirun -np 48 vasp_std

# åæŸãƒã‚§ãƒƒã‚¯
if grep -q &quot;reached required accuracy&quot; OUTCAR; then
    echo &quot;SUCCESS: ${MATERIAL}&quot; &gt;&gt; ../completed.log
else
    echo &quot;FAILED: ${MATERIAL}&quot; &gt;&gt; ../failed.log
fi
</code></pre>
<p><strong>materials.txt</strong>ã®ä¾‹:</p>
<pre><code>LiCoO2
LiNiO2
LiMnO2
LiFePO4
...ï¼ˆ100è¡Œï¼‰
</code></pre>
<h3>ä¾å­˜é–¢ä¿‚ã®ã‚ã‚‹ã‚¸ãƒ§ãƒ–ãƒã‚§ãƒ¼ãƒ³</h3>
<pre><code class="language-bash"># Step 1: æ§‹é€ æœ€é©åŒ–
JOB1=$(sbatch --parsable relax.sh)
echo &quot;æ§‹é€ æœ€é©åŒ–ã‚¸ãƒ§ãƒ–ID: $JOB1&quot;

# Step 2: é™çš„è¨ˆç®—ï¼ˆæ§‹é€ æœ€é©åŒ–å¾Œã«å®Ÿè¡Œï¼‰
JOB2=$(sbatch --parsable --dependency=afterok:$JOB1 static.sh)
echo &quot;é™çš„è¨ˆç®—ã‚¸ãƒ§ãƒ–ID: $JOB2&quot;

# Step 3: ãƒãƒ³ãƒ‰æ§‹é€ ï¼ˆé™çš„è¨ˆç®—å¾Œã«å®Ÿè¡Œï¼‰
JOB3=$(sbatch --parsable --dependency=afterok:$JOB2 band.sh)
echo &quot;ãƒãƒ³ãƒ‰æ§‹é€ ã‚¸ãƒ§ãƒ–ID: $JOB3&quot;

# Step 4: ãƒ‡ãƒ¼ã‚¿è§£æï¼ˆå…¨ã¦å®Œäº†å¾Œï¼‰
sbatch --dependency=afterok:$JOB3 analysis.sh
</code></pre>
<hr />
<h2>3.3 MPIã«ã‚ˆã‚‹ä¸¦åˆ—è¨ˆç®—</h2>
<h3>ä¸¦åˆ—åŒ–ã®ç¨®é¡</h3>
<pre><code class="language-python"># 1. ã‚¿ã‚¹ã‚¯ä¸¦åˆ—ï¼ˆæ¨å¥¨ï¼šãƒã‚¤ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆè¨ˆç®—ï¼‰
# 100ææ–™ã‚’100ãƒãƒ¼ãƒ‰ã§åŒæ™‚è¨ˆç®—
# ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°åŠ¹ç‡: 100%

# 2. ãƒ‡ãƒ¼ã‚¿ä¸¦åˆ—ï¼ˆVASP: KPARè¨­å®šï¼‰
# k-pointã‚’4ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²
INCAR: KPAR = 4
# ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°åŠ¹ç‡: 80-90%

# 3. MPIä¸¦åˆ—ï¼ˆãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ï¼‰
# 1è¨ˆç®—ã‚’48ã‚³ã‚¢ã§åˆ†æ•£
mpirun -np 48 vasp_std
# ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°åŠ¹ç‡: 50-70%
</code></pre>
<h3>ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°åŠ¹ç‡ã®æ¸¬å®š</h3>
<pre><code class="language-python">import subprocess
import time
import numpy as np
import matplotlib.pyplot as plt

def benchmark_scaling(structure, core_counts=[1, 2, 4, 8, 16, 32, 48]):
    &quot;&quot;&quot;
    ä¸¦åˆ—åŒ–åŠ¹ç‡ã‚’ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

    Parameters:
    -----------
    structure : str
        ãƒ†ã‚¹ãƒˆæ§‹é€ 
    core_counts : list
        ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚³ã‚¢æ•°

    Returns:
    --------
    efficiency : dict
        ã‚³ã‚¢æ•°ã”ã¨ã®åŠ¹ç‡
    &quot;&quot;&quot;
    timings = {}

    for n_cores in core_counts:
        # VASPå®Ÿè¡Œ
        start = time.time()

        result = subprocess.run(
            [f&quot;mpirun -np {n_cores} vasp_std&quot;],
            shell=True,
            cwd=f&quot;benchmark_{n_cores}cores&quot;
        )

        elapsed = time.time() - start
        timings[n_cores] = elapsed

        print(f&quot;{n_cores}ã‚³ã‚¢: {elapsed:.1f}ç§’&quot;)

    # åŠ¹ç‡è¨ˆç®—
    base_time = timings[1]
    efficiency = {}

    for n_cores, t in timings.items():
        ideal_time = base_time / n_cores
        actual_speedup = base_time / t
        ideal_speedup = n_cores

        eff = (actual_speedup / ideal_speedup) * 100
        efficiency[n_cores] = eff

    return efficiency, timings

# çµæœãƒ—ãƒ­ãƒƒãƒˆ
def plot_scaling(efficiency, timings):
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 5))

    cores = list(timings.keys())
    times = list(timings.values())
    effs = [efficiency[c] for c in cores]

    # ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—
    ax1.plot(cores, [timings[1]/t for t in times], 'o-', label='å®Ÿæ¸¬')
    ax1.plot(cores, cores, '--', label='ç†æƒ³ï¼ˆç·šå½¢ï¼‰')
    ax1.set_xlabel('ã‚³ã‚¢æ•°')
    ax1.set_ylabel('ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—')
    ax1.set_xscale('log', base=2)
    ax1.set_yscale('log', base=2)
    ax1.legend()
    ax1.grid(True)

    # åŠ¹ç‡
    ax2.plot(cores, effs, 'o-', color='green')
    ax2.axhline(y=80, color='red', linestyle='--', label='80%ç›®æ¨™')
    ax2.set_xlabel('ã‚³ã‚¢æ•°')
    ax2.set_ylabel('ä¸¦åˆ—åŒ–åŠ¹ç‡ (%)')
    ax2.set_xscale('log', base=2)
    ax2.legend()
    ax2.grid(True)

    plt.tight_layout()
    plt.savefig('scaling_benchmark.png', dpi=300)
    plt.show()
</code></pre>
<h3>VASPã®ä¸¦åˆ—åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–</h3>
<pre><code class="language-python">def optimize_vasp_parallelization(n_kpoints, n_bands, n_cores=48):
    &quot;&quot;&quot;
    VASPä¸¦åˆ—åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æœ€é©åŒ–

    Parameters:
    -----------
    n_kpoints : int
        k-pointæ•°
    n_bands : int
        ãƒãƒ³ãƒ‰æ•°
    n_cores : int
        åˆ©ç”¨å¯èƒ½ãªã‚³ã‚¢æ•°

    Returns:
    --------
    params : dict
        æœ€é©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    &quot;&quot;&quot;
    # KPAR: k-pointä¸¦åˆ—ï¼ˆæœ€ã‚‚åŠ¹ç‡çš„ï¼‰
    # 2ã®ç´¯ä¹—ã§ã€k-pointæ•°ã®ç´„æ•°
    kpar_options = [1, 2, 4, 8, 16]
    valid_kpar = [k for k in kpar_options if n_kpoints % k == 0 and k &lt;= n_cores]

    # NCORE: ãƒãƒ³ãƒ‰ä¸¦åˆ—
    # é€šå¸¸4-8ãŒæœ€é©
    ncore = min(4, n_cores // max(valid_kpar))

    # æ¨å¥¨è¨­å®š
    recommended = {
        'KPAR': max(valid_kpar),
        'NCORE': ncore,
        'cores_per_kpar_group': n_cores // max(valid_kpar),
    }

    print(&quot;ä¸¦åˆ—åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¨å¥¨å€¤:&quot;)
    print(f&quot;  KPAR = {recommended['KPAR']} (k-pointä¸¦åˆ—)&quot;)
    print(f&quot;  NCORE = {recommended['NCORE']} (ãƒãƒ³ãƒ‰ä¸¦åˆ—)&quot;)
    print(f&quot;  1 KPARã‚°ãƒ«ãƒ¼ãƒ—ã‚ãŸã‚Š{recommended['cores_per_kpar_group']}ã‚³ã‚¢&quot;)

    return recommended

# ä½¿ç”¨ä¾‹
params = optimize_vasp_parallelization(n_kpoints=64, n_bands=200, n_cores=48)
# æ¨å¥¨:
#   KPAR = 16 (k-pointä¸¦åˆ—)
#   NCORE = 3 (ãƒãƒ³ãƒ‰ä¸¦åˆ—)
#   1 KPARã‚°ãƒ«ãƒ¼ãƒ—ã‚ãŸã‚Š3ã‚³ã‚¢
</code></pre>
<hr />
<h2>3.4 Pythonã«ã‚ˆã‚‹ã‚¸ãƒ§ãƒ–ç®¡ç†</h2>
<h3>ã‚¸ãƒ§ãƒ–æŠ•å…¥ã¨ç›£è¦–</h3>
<pre><code class="language-python">import subprocess
import time
import re

class SLURMJobManager:
    &quot;&quot;&quot;SLURMã‚¸ãƒ§ãƒ–ç®¡ç†ã‚¯ãƒ©ã‚¹&quot;&quot;&quot;

    def submit_job(self, script_path):
        &quot;&quot;&quot;
        ã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥

        Returns:
        --------
        job_id : int
            ã‚¸ãƒ§ãƒ–ID
        &quot;&quot;&quot;
        result = subprocess.run(
            ['sbatch', script_path],
            capture_output=True,
            text=True
        )

        # &quot;Submitted batch job 12345&quot;ã‹ã‚‰IDã‚’æŠ½å‡º
        match = re.search(r'(\d+)', result.stdout)
        if match:
            job_id = int(match.group(1))
            print(f&quot;ã‚¸ãƒ§ãƒ–æŠ•å…¥: ID={job_id}&quot;)
            return job_id
        else:
            raise RuntimeError(f&quot;ã‚¸ãƒ§ãƒ–æŠ•å…¥å¤±æ•—: {result.stderr}&quot;)

    def get_job_status(self, job_id):
        &quot;&quot;&quot;
        ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ã‚’å–å¾—

        Returns:
        --------
        status : str
            'PENDING', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED'
        &quot;&quot;&quot;
        result = subprocess.run(
            ['squeue', '-j', str(job_id), '-h', '-o', '%T'],
            capture_output=True,
            text=True
        )

        if result.stdout.strip():
            return result.stdout.strip()
        else:
            # ã‚­ãƒ¥ãƒ¼ã«ãªã„ â†’ å®Œäº†ã¾ãŸã¯å¤±æ•—
            result = subprocess.run(
                ['sacct', '-j', str(job_id), '-X', '-n', '-o', 'State'],
                capture_output=True,
                text=True
            )
            return result.stdout.strip()

    def wait_for_completion(self, job_id, check_interval=60):
        &quot;&quot;&quot;
        ã‚¸ãƒ§ãƒ–å®Œäº†ã‚’å¾…æ©Ÿ

        Parameters:
        -----------
        job_id : int
            ã‚¸ãƒ§ãƒ–ID
        check_interval : int
            ãƒã‚§ãƒƒã‚¯é–“éš”ï¼ˆç§’ï¼‰
        &quot;&quot;&quot;
        while True:
            status = self.get_job_status(job_id)

            if status in ['COMPLETED', 'FAILED', 'CANCELLED']:
                print(f&quot;ã‚¸ãƒ§ãƒ–{job_id}: {status}&quot;)
                return status

            print(f&quot;ã‚¸ãƒ§ãƒ–{job_id}: {status}...å¾…æ©Ÿä¸­&quot;)
            time.sleep(check_interval)

    def submit_array_job(self, script_path, n_tasks, max_concurrent=10):
        &quot;&quot;&quot;
        ã‚¢ãƒ¬ã‚¤ã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥

        Parameters:
        -----------
        n_tasks : int
            ã‚¿ã‚¹ã‚¯æ•°
        max_concurrent : int
            åŒæ™‚å®Ÿè¡Œæ•°
        &quot;&quot;&quot;
        result = subprocess.run(
            ['sbatch', f'--array=1-{n_tasks}%{max_concurrent}', script_path],
            capture_output=True,
            text=True
        )

        match = re.search(r'(\d+)', result.stdout)
        if match:
            job_id = int(match.group(1))
            print(f&quot;ã‚¢ãƒ¬ã‚¤ã‚¸ãƒ§ãƒ–æŠ•å…¥: ID={job_id}, ã‚¿ã‚¹ã‚¯æ•°={n_tasks}&quot;)
            return job_id
        else:
            raise RuntimeError(f&quot;æŠ•å…¥å¤±æ•—: {result.stderr}&quot;)

# ä½¿ç”¨ä¾‹
manager = SLURMJobManager()

# å˜ä¸€ã‚¸ãƒ§ãƒ–
job_id = manager.submit_job('relax.sh')
status = manager.wait_for_completion(job_id)

# ã‚¢ãƒ¬ã‚¤ã‚¸ãƒ§ãƒ–
array_id = manager.submit_array_job('array_job.sh', n_tasks=100, max_concurrent=20)
</code></pre>
<h3>å¤§è¦æ¨¡ã‚¸ãƒ§ãƒ–ç®¡ç†ï¼ˆ1000ææ–™ï¼‰</h3>
<pre><code class="language-python">import os
from pathlib import Path
import json

def manage_large_scale_calculation(materials, batch_size=100):
    &quot;&quot;&quot;
    1000ææ–™ã‚’åŠ¹ç‡çš„ã«ç®¡ç†

    Parameters:
    -----------
    materials : list
        ææ–™ã®ãƒªã‚¹ãƒˆ
    batch_size : int
        ãƒãƒƒãƒã‚µã‚¤ã‚º
    &quot;&quot;&quot;
    manager = SLURMJobManager()
    n_materials = len(materials)

    print(f&quot;ç·ææ–™æ•°: {n_materials}&quot;)
    print(f&quot;ãƒãƒƒãƒã‚µã‚¤ã‚º: {batch_size}&quot;)

    # ãƒãƒƒãƒã«åˆ†å‰²
    n_batches = (n_materials + batch_size - 1) // batch_size
    print(f&quot;ãƒãƒƒãƒæ•°: {n_batches}&quot;)

    job_ids = []

    for batch_idx in range(n_batches):
        start_idx = batch_idx * batch_size
        end_idx = min((batch_idx + 1) * batch_size, n_materials)
        batch_materials = materials[start_idx:end_idx]

        print(f&quot;\nãƒãƒƒãƒ {batch_idx+1}/{n_batches}&quot;)
        print(f&quot;  ææ–™æ•°: {len(batch_materials)}&quot;)

        # ãƒãƒƒãƒç”¨ææ–™ãƒªã‚¹ãƒˆä½œæˆ
        list_file = f&quot;batch_{batch_idx+1}_materials.txt&quot;
        with open(list_file, 'w') as f:
            for mat in batch_materials:
                f.write(f&quot;{mat}\n&quot;)

        # ã‚¢ãƒ¬ã‚¤ã‚¸ãƒ§ãƒ–æŠ•å…¥
        job_id = manager.submit_array_job(
            'vasp_array.sh',
            n_tasks=len(batch_materials),
            max_concurrent=20
        )

        job_ids.append(job_id)

    # é€²æ—ç›£è¦–
    print(&quot;\né€²æ—ç›£è¦–ä¸­...&quot;)
    completed = 0

    while completed &lt; len(job_ids):
        time.sleep(300)  # 5åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯

        for i, job_id in enumerate(job_ids):
            status = manager.get_job_status(job_id)

            if status == 'COMPLETED' and i not in completed_jobs:
                completed += 1
                print(f&quot;ãƒãƒƒãƒ {i+1} å®Œäº† ({completed}/{len(job_ids)})&quot;)

    print(&quot;å…¨ãƒãƒƒãƒå®Œäº†ï¼&quot;)

# ä½¿ç”¨ä¾‹
materials = [f&quot;material_{i:04d}&quot; for i in range(1, 1001)]
manage_large_scale_calculation(materials, batch_size=100)
</code></pre>
<hr />
<h2>3.5 æ¼”ç¿’å•é¡Œ</h2>
<h3>å•é¡Œ1ï¼ˆé›£æ˜“åº¦: easyï¼‰</h3>
<p><strong>å•é¡Œ</strong>: ä»¥ä¸‹ã®æ¡ä»¶ã§SLURMã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š</p>
<ul>
<li>ã‚¸ãƒ§ãƒ–å: <code>si_bandgap</code></li>
<li>ãƒãƒ¼ãƒ‰æ•°: 2</li>
<li>ãƒãƒ¼ãƒ‰ã‚ãŸã‚Šãƒ—ãƒ­ã‚»ã‚¹æ•°: 24</li>
<li>æ™‚é–“åˆ¶é™: 12æ™‚é–“</li>
<li>ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³: <code>gpu</code></li>
</ul>
<details>
<summary>è§£ç­”ä¾‹</summary>


<pre><code class="language-bash">#!/bin/bash
#SBATCH --job-name=si_bandgap
#SBATCH --output=slurm-%j.out
#SBATCH --error=slurm-%j.err
#SBATCH --nodes=2
#SBATCH --ntasks-per-node=24
#SBATCH --time=12:00:00
#SBATCH --partition=gpu

module load vasp/6.3.0

cd $SLURM_SUBMIT_DIR

mpirun -np 48 vasp_std
</code></pre>


</details>

<h3>å•é¡Œ2ï¼ˆé›£æ˜“åº¦: mediumï¼‰</h3>
<p><strong>å•é¡Œ</strong>: 50å€‹ã®æ§‹é€ æœ€é©åŒ–è¨ˆç®—ã‚’ã€10å€‹ãšã¤åŒæ™‚å®Ÿè¡Œã™ã‚‹ã‚¢ãƒ¬ã‚¤ã‚¸ãƒ§ãƒ–ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
<details>
<summary>è§£ç­”ä¾‹</summary>


<pre><code class="language-bash">#!/bin/bash
#SBATCH --job-name=relax_array
#SBATCH --output=logs/slurm-%A_%a.out
#SBATCH --error=logs/slurm-%A_%a.err
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=48
#SBATCH --time=24:00:00
#SBATCH --array=1-50%10

module load vasp/6.3.0

MATERIAL=$(sed -n &quot;${SLURM_ARRAY_TASK_ID}p&quot; materials.txt)

cd calculations/${MATERIAL}

mpirun -np 48 vasp_std
</code></pre>


</details>

<h3>å•é¡Œ3ï¼ˆé›£æ˜“åº¦: hardï¼‰</h3>
<p><strong>å•é¡Œ</strong>: Pythonã§ã€1000ææ–™ã®VASPè¨ˆç®—ã‚’ç®¡ç†ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚è¦ä»¶ï¼š</p>
<ol>
<li>50ææ–™ãšã¤ãƒãƒƒãƒå‡¦ç†</li>
<li>å„ãƒãƒƒãƒã¯20ã‚¿ã‚¹ã‚¯åŒæ™‚å®Ÿè¡Œ</li>
<li>å®Œäº†ãƒ»å¤±æ•—ã‚’ãƒ­ã‚°è¨˜éŒ²</li>
<li>å¤±æ•—ã—ãŸã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤</li>
</ol>
<details>
<summary>è§£ç­”ä¾‹</summary>


<pre><code class="language-python">import os
import time
import json
from pathlib import Path

class HighThroughputManager:
    def __init__(self, materials, batch_size=50, max_concurrent=20):
        self.materials = materials
        self.batch_size = batch_size
        self.max_concurrent = max_concurrent
        self.manager = SLURMJobManager()

        self.results = {
            'completed': [],
            'failed': [],
            'retry': []
        }

    def run_batch(self, batch_materials, batch_id):
        &quot;&quot;&quot;ãƒãƒƒãƒå®Ÿè¡Œ&quot;&quot;&quot;
        # ææ–™ãƒªã‚¹ãƒˆä½œæˆ
        list_file = f&quot;batch_{batch_id}.txt&quot;
        with open(list_file, 'w') as f:
            for mat in batch_materials:
                f.write(f&quot;{mat}\n&quot;)

        # ã‚¸ãƒ§ãƒ–æŠ•å…¥
        job_id = self.manager.submit_array_job(
            'vasp_array.sh',
            n_tasks=len(batch_materials),
            max_concurrent=self.max_concurrent
        )

        # å®Œäº†å¾…ã¡
        status = self.manager.wait_for_completion(job_id)

        # çµæœãƒã‚§ãƒƒã‚¯
        self.check_results(batch_materials, batch_id)

    def check_results(self, batch_materials, batch_id):
        &quot;&quot;&quot;çµæœç¢ºèª&quot;&quot;&quot;
        for mat in batch_materials:
            outcar = f&quot;calculations/{mat}/OUTCAR&quot;

            if not os.path.exists(outcar):
                self.results['failed'].append(mat)
                continue

            with open(outcar, 'r') as f:
                content = f.read()
                if 'reached required accuracy' in content:
                    self.results['completed'].append(mat)
                else:
                    self.results['failed'].append(mat)

        # ãƒ­ã‚°ä¿å­˜
        with open(f'batch_{batch_id}_results.json', 'w') as f:
            json.dump(self.results, f, indent=2)

    def retry_failed(self, max_retries=2):
        &quot;&quot;&quot;å¤±æ•—ã‚¿ã‚¹ã‚¯ã‚’ãƒªãƒˆãƒ©ã‚¤&quot;&quot;&quot;
        for retry_count in range(max_retries):
            if not self.results['failed']:
                break

            print(f&quot;\nãƒªãƒˆãƒ©ã‚¤ {retry_count+1}/{max_retries}&quot;)
            print(f&quot;  å¤±æ•—ã‚¿ã‚¹ã‚¯æ•°: {len(self.results['failed'])}&quot;)

            failed_materials = self.results['failed'].copy()
            self.results['failed'] = []

            self.run_batch(failed_materials, f'retry_{retry_count+1}')

    def execute_all(self):
        &quot;&quot;&quot;å…¨ææ–™ã‚’å®Ÿè¡Œ&quot;&quot;&quot;
        n_batches = (len(self.materials) + self.batch_size - 1) // self.batch_size

        for batch_idx in range(n_batches):
            start = batch_idx * self.batch_size
            end = min((batch_idx + 1) * self.batch_size, len(self.materials))
            batch_materials = self.materials[start:end]

            print(f&quot;\nãƒãƒƒãƒ {batch_idx+1}/{n_batches}&quot;)
            self.run_batch(batch_materials, batch_idx+1)

        # ãƒªãƒˆãƒ©ã‚¤
        self.retry_failed(max_retries=2)

        # æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ
        print(&quot;\næœ€çµ‚çµæœ:&quot;)
        print(f&quot;  æˆåŠŸ: {len(self.results['completed'])}&quot;)
        print(f&quot;  å¤±æ•—: {len(self.results['failed'])}&quot;)

        return self.results

# å®Ÿè¡Œ
materials = [f&quot;material_{i:04d}&quot; for i in range(1, 1001)]
manager = HighThroughputManager(materials, batch_size=50, max_concurrent=20)
results = manager.execute_all()
</code></pre>


</details>

<hr />
<h2>3.6 ã¾ã¨ã‚</h2>
<p><strong>ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆ</strong>:</p>
<ol>
<li><strong>SLURM</strong>: å¤§è¦æ¨¡HPCã§åºƒãä½¿ç”¨ã•ã‚Œã‚‹ã‚¸ãƒ§ãƒ–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©</li>
<li><strong>ã‚¢ãƒ¬ã‚¤ã‚¸ãƒ§ãƒ–</strong>: å¤šæ•°ã®ææ–™ã‚’åŠ¹ç‡çš„ã«ä¸¦åˆ—å®Ÿè¡Œ</li>
<li><strong>MPIä¸¦åˆ—</strong>: ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°åŠ¹ç‡ã‚’æ¸¬å®šãƒ»æœ€é©åŒ–</li>
<li><strong>Pythonç®¡ç†</strong>: å¤§è¦æ¨¡è¨ˆç®—ã®è‡ªå‹•åŒ–ã¨ç›£è¦–</li>
</ol>
<p><strong>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</strong>:</p>
<p>ç¬¬4ç« ã§ã¯ã€<strong>FireWorksã¨AiiDAã«ã‚ˆã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†</strong>ã‚’å­¦ã³ã¾ã™ã€‚</p>
<p><strong><a href="./chapter-4.html">ç¬¬4ç« : ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã¨ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹ â†’</a></strong></p>
<hr />
<p><strong>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</strong>: CC BY 4.0
<strong>ä½œæˆæ—¥</strong>: 2025-10-17
<strong>ä½œæˆè€…</strong>: Dr. Yusuke Hashimoto, Tohoku University</p><div class="navigation">
    <a href="chapter-2.html" class="nav-button">â† å‰ã®ç« </a>
    <a href="index.html" class="nav-button">ã‚·ãƒªãƒ¼ã‚ºç›®æ¬¡ã«æˆ»ã‚‹</a>
    <a href="chapter-4.html" class="nav-button">æ¬¡ã®ç«  â†’</a>
</div>
    </main>

    <footer>
        <p><strong>ä½œæˆè€…</strong>: AI Terakoya Content Team</p>
        <p><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</strong>: 1.0 | <strong>ä½œæˆæ—¥</strong>: 2025-10-17</p>
        <p><strong>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</strong>: Creative Commons BY 4.0</p>
        <p>Â© 2025 AI Terakoya. All rights reserved.</p>
    </footer>
</body>
</html>
