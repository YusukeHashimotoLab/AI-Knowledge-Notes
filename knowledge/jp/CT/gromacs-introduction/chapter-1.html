<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第1章: GROMACSの基礎と環境構築 - GROMACS入門 - CT Dojo</title>
    <meta name="description" content="GROMACS分子動力学シミュレーションの基礎、インストール方法、力場の理解、基本ワークフローを学ぶ。">

    <!-- Prism.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

    <!-- MathJax for mathematical expressions -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Mermaid for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        :root {
            --accent-green: #11998e;
            --accent-lime: #38ef7d;
            --primary-dark: #2c3e50;
            --secondary-dark: #34495e;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #ecf0f1;
            --white: #ffffff;
            --code-bg: #2d2d2d;
            --border-light: #bdc3c7;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.8;
            color: var(--text-dark);
            background: var(--bg-light);
        }

        header {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-lime) 100%);
            color: white;
            padding: 3rem 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        nav {
            background: var(--white);
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }

        nav a {
            text-decoration: none;
            color: var(--text-dark);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.3s;
            font-weight: 500;
        }

        nav a:hover {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-lime) 100%);
            color: white;
        }

        main {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        section {
            background: var(--white);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h2 {
            color: var(--primary-dark);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, var(--accent-green), var(--accent-lime)) 1;
        }

        h3 {
            color: var(--secondary-dark);
            font-size: 1.4rem;
            margin: 2rem 0 1rem;
        }

        h4 {
            color: var(--secondary-dark);
            font-size: 1.2rem;
            margin: 1.5rem 0 1rem;
        }

        p {
            margin-bottom: 1rem;
            line-height: 1.8;
        }

        ul, ol {
            margin-left: 2rem;
            margin-bottom: 1rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        code {
            background: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: "Consolas", "Monaco", monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }

        pre {
            background: var(--code-bg);
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.5rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        pre code {
            background: none;
            color: #f8f8f2;
            padding: 0;
        }

        .info-box {
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.1) 0%, rgba(56, 239, 125, 0.1) 100%);
            border-left: 4px solid var(--accent-green);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .info-box strong {
            color: var(--accent-green);
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .warning-box {
            background: rgba(243, 156, 18, 0.1);
            border-left: 4px solid var(--warning);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .warning-box strong {
            color: var(--warning);
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .exercise-box {
            background: rgba(39, 174, 96, 0.05);
            border: 2px solid var(--success);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 8px;
        }

        .exercise-box h4 {
            color: var(--success);
            margin-top: 0;
        }

        .difficulty {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .difficulty.easy {
            background: #d4edda;
            color: #155724;
        }

        .difficulty.medium {
            background: #fff3cd;
            color: #856404;
        }

        .difficulty.hard {
            background: #f8d7da;
            color: #721c24;
        }

        .mermaid {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin: 2rem 0;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        th {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-lime) 100%);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: rgba(17, 153, 142, 0.05);
        }

        footer {
            background: var(--primary-dark);
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 4rem;
        }

        footer a {
            color: var(--accent-green);
            text-decoration: none;
        }

        footer a:hover {
            color: var(--accent-lime);
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.5rem;
            }

            nav ul {
                flex-direction: column;
                align-items: center;
            }

            section {
                padding: 1.5rem;
            }

            pre {
                padding: 1rem;
                font-size: 0.85rem;
            }
        }



        /* Breadcrumb styles */
        .breadcrumb {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .breadcrumb-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .breadcrumb a {
            color: #11998e;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #0e7c74;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #a0aec0;
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: #4a5568;
            font-weight: 500;
        }
    </style>
</head>
<body>
            <nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="/AI-Knowledge-Notes/knowledge/jp/index.html">AI寺子屋トップ</a><span class="breadcrumb-separator">›</span><a href="/AI-Knowledge-Notes/knowledge/jp/CT/index.html">計算工学</a><span class="breadcrumb-separator">›</span><a href="/AI-Knowledge-Notes/knowledge/jp/CT/gromacs-introduction/index.html">GROMACS入門</a><span class="breadcrumb-separator">›</span><span class="breadcrumb-current">Chapter 1</span>
        </div>
    </nav>

        <header>
        <h1>第1章: GROMACSの基礎と環境構築</h1>
        <p>分子動力学シミュレーションの原理・GROMACS特徴・力場・環境構築</p>
    </header>

    <nav>
        <ul>
            <li><a href="index.html">トップ</a></li>
            <li><a href="#intro">本章の概要</a></li>
            <li><a href="#md-basics">MD法の基礎</a></li>
            <li><a href="#gromacs-features">GROMACS特徴</a></li>
            <li><a href="#installation">インストール</a></li>
            <li><a href="#topology">トポロジーとパラメータ</a></li>
            <li><a href="#workflow">基本ワークフロー</a></li>
            <li><a href="#learning-objectives">学習目標</a></li>
            <li><a href="#exercises">演習問題</a></li>
            <li><a href="#references">参考文献</a></li>
            <li><a href="chapter-2.html">次の章へ →</a></li>
        </ul>
    </nav>

    <main>
        <section id="intro">
            <h2>1.1 本章の概要</h2>

            <p>
                GROMACS（GROningen MAchine for Chemical Simulations）は、生体分子の分子動力学（MD）シミュレーションに広く使われているオープンソースソフトウェアです。特にタンパク質、核酸、脂質などの生体高分子の研究で強力なツールであり、GPUを活用した高速計算が可能です。
            </p>

            <div class="info-box">
                <strong>本章の学習目標</strong>
                <ul>
                    <li><strong>レベル1（基本理解）</strong>: 分子動力学法の原理、GROMACSの特徴（GPU対応、力場）、トポロジーファイルとパラメータファイルの役割を説明できる</li>
                    <li><strong>レベル2（実践スキル）</strong>: GROMACSをインストールし、バージョンとGPUサポートを確認でき、簡単な水分子系のMDシミュレーションを実行できる</li>
                    <li><strong>レベル3（応用力）</strong>: 力場（AMBER、CHARMM、OPLS）の特徴を理解し、研究目的に応じて適切な力場を選択でき、MDワークフロー全体（準備→最小化→平衡化→本計算）を設計できる</li>
                </ul>
            </div>

            <div class="warning-box">
                <strong>前提知識</strong>
                <p>本章では、生化学の基礎（タンパク質、核酸の構造）、Linux基本操作（ターミナルコマンド、シェルスクリプト）、物理化学の初歩（分子間力、熱力学）を前提とします。</p>
            </div>
        </section>

        <section id="md-basics">
            <h2>1.2 分子動力学法の基礎</h2>

            <h3>ニュートン方程式による分子運動の記述</h3>
            <p>
                分子動力学（Molecular Dynamics, MD）法は、原子核の古典的運動をニュートンの運動方程式に従ってシミュレートする手法です。各原子\( i \)の運動は以下の式で記述されます：
            </p>
            <p>
                $$
                m_i \frac{d^2 \mathbf{r}_i}{dt^2} = \mathbf{F}_i = -\nabla_i U(\mathbf{r}_1, \mathbf{r}_2, \ldots, \mathbf{r}_N)
                $$
            </p>
            <p>
                ここで、\( m_i \)は原子\( i \)の質量、\( \mathbf{r}_i \)は位置ベクトル、\( \mathbf{F}_i \)は力、\( U \)はポテンシャルエネルギーです。
            </p>

            <h3>力場（Force Field）の役割</h3>
            <p>
                ポテンシャルエネルギー\( U \)は<strong>力場</strong>によって記述されます。力場は、結合、角度、二面角、非結合相互作用（van der Waals力、静電相互作用）のパラメータの集合です：
            </p>
            <p>
                $$
                U = U_{\text{bond}} + U_{\text{angle}} + U_{\text{dihedral}} + U_{\text{vdW}} + U_{\text{elec}}
                $$
            </p>

            <div class="mermaid">
flowchart TD
    A[原子座標] --> B[力場パラメータ]
    B --> C[ポテンシャルエネルギー計算]
    C --> D[力の計算: F = -∇U]
    D --> E[運動方程式の積分]
    E --> F[新しい座標・速度]
    F --> A

    style A fill:#e3f2fd
    style C fill:#fff3e0
    style E fill:#e8f5e9
            </div>

            <h3>数値積分法</h3>
            <p>
                運動方程式の時間発展は、数値積分アルゴリズムで計算されます。GROMACSでは<strong>Leap-frog法</strong>が標準的に使用されます：
            </p>
            <p>
                $$
                \mathbf{v}(t + \frac{\Delta t}{2}) = \mathbf{v}(t - \frac{\Delta t}{2}) + \frac{\mathbf{F}(t)}{m} \Delta t
                $$
            </p>
            <p>
                $$
                \mathbf{r}(t + \Delta t) = \mathbf{r}(t) + \mathbf{v}(t + \frac{\Delta t}{2}) \Delta t
                $$
            </p>
            <p>
                積分時間ステップ\(\Delta t\)は通常2 fs（フェムト秒）に設定されます。
            </p>

            <h3>アンサンブルとサーモスタット</h3>
            <p>
                MDシミュレーションでは、様々なアンサンブル（統計集団）を選択できます：
            </p>
            <ul>
                <li><strong>NVE</strong>: 粒子数（N）、体積（V）、エネルギー（E）が一定（ミクロカノニカルアンサンブル）</li>
                <li><strong>NVT</strong>: 粒子数、体積、温度（T）が一定（カノニカルアンサンブル）</li>
                <li><strong>NPT</strong>: 粒子数、圧力（P）、温度が一定（等温等圧アンサンブル）</li>
            </ul>
            <p>
                温度制御にはBerendsen、Nosé-Hoover、v-rescaleサーモスタット、圧力制御にはBerendsen、Parrinello-Rahmanバロスタットが使われます。
            </p>
        </section>

        <section id="gromacs-features">
            <h2>1.3 GROMACSの特徴</h2>

            <h3>高速性とGPU対応</h3>
            <p>
                GROMACSはNVIDIA GPUを使った高速計算に対応しており、CPU版と比較して10-50倍の高速化が可能です。特に、非結合相互作用計算（PME: Particle Mesh Ewald法）と近接リスト構築がGPUで並列実行されます。
            </p>

            <h3>豊富な力場サポート</h3>
            <table>
                <thead>
                    <tr>
                        <th>力場</th>
                        <th>特徴</th>
                        <th>推奨用途</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>AMBER</strong></td>
                        <td>タンパク質、核酸に最適化<br>ff14SB, ff99bsc0等</td>
                        <td>タンパク質構造解析、DNA/RNA研究</td>
                    </tr>
                    <tr>
                        <td><strong>CHARMM</strong></td>
                        <td>生体分子全般に対応<br>CHARMM36m, CHARMM36</td>
                        <td>膜タンパク質、脂質、糖鎖</td>
                    </tr>
                    <tr>
                        <td><strong>OPLS-AA</strong></td>
                        <td>全原子力場、有機分子に強い</td>
                        <td>リガンド結合、有機小分子</td>
                    </tr>
                    <tr>
                        <td><strong>GROMOS</strong></td>
                        <td>GROMACS標準、高速</td>
                        <td>大規模系、長時間シミュレーション</td>
                    </tr>
                </tbody>
            </table>

            <h3>統合された解析ツール</h3>
            <p>
                GROMACSには、RMSD、RMSF、回転半径、水素結合、二次構造、自由エネルギー計算など、100種類以上の解析コマンドが標準で含まれています。
            </p>

            <h3>並列計算とスケーラビリティ</h3>
            <p>
                GROMACSは、MPI（Message Passing Interface）とOpenMPによるマルチコア並列、マルチGPU並列、クラスタ並列に対応しており、数百万原子系のシミュレーションが可能です。
            </p>
        </section>

        <section id="installation">
            <h2>1.4 GROMACSのインストール</h2>

            <h3>コード例1: ソースからのインストール（GPU対応版）</h3>
            <pre><code class="language-bash"># 依存ライブラリのインストール（Ubuntu/Debian）
sudo apt-get update
sudo apt-get install -y cmake build-essential libfftw3-dev \
    libopenmpi-dev openmpi-bin nvidia-cuda-toolkit

# GROMACSソースコードのダウンロード
cd ~/Downloads
wget https://ftp.gromacs.org/gromacs/gromacs-2024.tar.gz
tar xfz gromacs-2024.tar.gz
cd gromacs-2024

# ビルドディレクトリの作成
mkdir build
cd build

# CMake設定（GPU有効化）
cmake .. \
    -DGMX_BUILD_OWN_FFTW=ON \
    -DGMX_GPU=CUDA \
    -DGMX_MPI=ON \
    -DCMAKE_INSTALL_PREFIX=/usr/local/gromacs

# コンパイル（4コア並列）
make -j4

# インストール
sudo make install

# 環境変数の設定（~/.bashrcに追加）
echo 'source /usr/local/gromacs/bin/GMXRC' >> ~/.bashrc
source ~/.bashrc

# インストール確認
gmx --version
</code></pre>

            <h3>コード例2: GROMACSバージョンとGPUサポート確認</h3>
            <pre><code class="language-bash"># バージョン情報の表示
gmx --version

# 期待される出力例:
# GROMACS version:    2024
# Precision:          single
# Memory model:       64 bit
# MPI library:        thread_mpi
# OpenMP support:     enabled (GMX_OPENMP_MAX_THREADS = 128)
# GPU support:        CUDA
# SIMD instructions:  AVX2_256
# FFT library:        fftw-3.3.10-sse2-avx-avx2-avx2_128

# GPU検出確認
gmx mdrun -ntmpi 1 -nb gpu -pme gpu -bonded gpu

# 利用可能なGPUのリスト表示
nvidia-smi

# GROMACSのGPU設定確認
echo "export GMX_GPU_DD_COMMS=true" >> ~/.bashrc
echo "export GMX_GPU_PME_PP_COMMS=true" >> ~/.bashrc
source ~/.bashrc
</code></pre>

            <div class="info-box">
                <strong>インストールのポイント</strong>
                <ul>
                    <li><strong>GPU有効化</strong>: <code>-DGMX_GPU=CUDA</code>でNVIDIA GPU対応を有効化</li>
                    <li><strong>MPI並列</strong>: <code>-DGMX_MPI=ON</code>でマルチノード並列計算に対応</li>
                    <li><strong>FFTW最適化</strong>: <code>-DGMX_BUILD_OWN_FFTW=ON</code>で最適化されたFFTライブラリを自動ビルド</li>
                    <li><strong>精度設定</strong>: 単精度（デフォルト）または倍精度（<code>-DGMX_DOUBLE=ON</code>）を選択</li>
                </ul>
            </div>

            <h3>Condaによる簡易インストール（学習用）</h3>
            <pre><code class="language-bash"># Conda環境の作成とGROMACSインストール
conda create -n gromacs python=3.10
conda activate gromacs
conda install -c conda-forge gromacs

# 確認
gmx --version

# 注意: Conda版はGPU対応が限定的な場合があります
# 本格的な研究用途にはソースからのビルドを推奨
</code></pre>
        </section>

        <section id="topology">
            <h2>1.5 トポロジーとパラメータファイル</h2>

            <h3>GROMACSの主要ファイル形式</h3>
            <table>
                <thead>
                    <tr>
                        <th>ファイル拡張子</th>
                        <th>説明</th>
                        <th>例</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>.pdb</code></td>
                        <td>タンパク質構造データ（座標）</td>
                        <td>初期構造、PDBデータベースから取得</td>
                    </tr>
                    <tr>
                        <td><code>.gro</code></td>
                        <td>GROMACS座標ファイル</td>
                        <td>シミュレーション中の原子座標</td>
                    </tr>
                    <tr>
                        <td><code>.top</code></td>
                        <td>トポロジーファイル</td>
                        <td>原子の接続性、力場パラメータ</td>
                    </tr>
                    <tr>
                        <td><code>.mdp</code></td>
                        <td>MD実行パラメータ</td>
                        <td>温度、圧力、時間ステップ等の設定</td>
                    </tr>
                    <tr>
                        <td><code>.tpr</code></td>
                        <td>実行用バイナリファイル</td>
                        <td>.gro + .top + .mdpを統合</td>
                    </tr>
                    <tr>
                        <td><code>.xtc</code> / <code>.trr</code></td>
                        <td>トラジェクトリファイル</td>
                        <td>時間発展の座標データ</td>
                    </tr>
                    <tr>
                        <td><code>.edr</code></td>
                        <td>エネルギーファイル</td>
                        <td>温度、圧力、エネルギーの時系列</td>
                    </tr>
                </tbody>
            </table>

            <h3>トポロジーファイル（.top）の構造</h3>
            <p>
                トポロジーファイルは、分子の接続性（結合、角度、二面角）と力場パラメータを定義します。
            </p>
            <pre><code class="language-plaintext">; Topology file example
#include "amber99sb.ff/forcefield.itp"

[ moleculetype ]
; Name            nrexcl
Protein             3

[ atoms ]
;   nr       type  resnr residue  atom   cgnr     charge       mass
     1         N3      1    MET      N      1    -0.3000     14.007
     2          H      1    MET     H1      2     0.3300      1.008
     3          H      1    MET     H2      3     0.3300      1.008

[ bonds ]
;  ai    aj funct           c0           c1
    1     2     1

[ angles ]
;  ai    aj    ak funct           c0           c1
    2     1     3     1

; ... 他のセクション（dihedrals, pairs等）...

[ system ]
; Name
Protein in Water

[ molecules ]
; Compound        #mols
Protein             1
SOL              5000
</code></pre>

            <div class="warning-box">
                <strong>重要な注意点</strong>
                <p>トポロジーファイルは<strong>力場に依存</strong>します。AMBER力場を使う場合は<code>amber99sb.ff</code>、CHARMMを使う場合は<code>charmm36.ff</code>をインクルードします。異なる力場のパラメータを混在させると、エネルギー計算が不正確になります。</p>
            </div>

            <h3>MDパラメータファイル（.mdp）の主要設定</h3>
            <pre><code class="language-plaintext">; エネルギー最小化用mdpファイル例
integrator               = steep      ; 最急降下法
emtol                    = 1000.0     ; 収束判定（kJ/mol/nm）
emstep                   = 0.01       ; 初期ステップサイズ
nsteps                   = 50000      ; 最大ステップ数

; 非結合相互作用
coulombtype              = PME        ; Particle Mesh Ewald
rcoulomb                 = 1.0        ; クーロンカットオフ（nm）
vdwtype                  = Cut-off    ; van der Waals型
rvdw                     = 1.0        ; vdWカットオフ（nm）

; 周期境界条件
pbc                      = xyz        ; 3次元周期境界
</code></pre>
        </section>

        <section id="workflow">
            <h2>1.6 基本MDワークフロー</h2>

            <h3>GROMACSワークフローの5ステップ</h3>
            <div class="mermaid">
flowchart LR
    A[1. 構造準備<br/>pdb2gmx] --> B[2. 溶媒和<br/>solvate, genion]
    B --> C[3. エネルギー最小化<br/>grompp, mdrun]
    C --> D[4. 平衡化<br/>NVT, NPT]
    D --> E[5. 本計算<br/>Production MD]
    E --> F[6. 解析<br/>rms, rmsf等]

    style A fill:#e3f2fd
    style C fill:#fff3e0
    style E fill:#e8f5e9
            </div>

            <h3>コード例3: 水分子系の簡単なMDシミュレーション</h3>
            <pre><code class="language-bash"># ===================================
# ステップ1: 水分子のボックス作成
# ===================================
gmx solvate -cs spc216.gro -o water_box.gro -box 3 3 3

# 出力: water_box.gro（3x3x3 nmの水分子ボックス、約870分子）

# ===================================
# ステップ2: トポロジーファイル作成
# ===================================
# topol.topを手動作成（簡略版）
cat > topol.top << EOF
#include "oplsaa.ff/forcefield.itp"
#include "oplsaa.ff/spc.itp"

[ system ]
Water Box

[ molecules ]
SOL    870
EOF

# ===================================
# ステップ3: エネルギー最小化
# ===================================
# em.mdpファイル作成
cat > em.mdp << EOF
integrator  = steep
emtol       = 1000.0
nsteps      = 5000
nstlist     = 10
cutoff-scheme = Verlet
coulombtype = PME
rcoulomb    = 1.0
rvdw        = 1.0
pbc         = xyz
EOF

# gromppでtprファイル作成
gmx grompp -f em.mdp -c water_box.gro -p topol.top -o em.tpr

# mdrun実行（エネルギー最小化）
gmx mdrun -v -deffnm em

# 結果確認
gmx energy -f em.edr -o potential.xvg << EOF
10 0
EOF
# 10 = Potential エネルギー選択

# ===================================
# ステップ4: NVT平衡化（温度制御）
# ===================================
cat > nvt.mdp << EOF
integrator  = md
dt          = 0.002        ; 2 fs
nsteps      = 50000        ; 100 ps
nstenergy   = 500
nstlog      = 500
nstxout-compressed = 500

cutoff-scheme = Verlet
coulombtype = PME
rcoulomb    = 1.0
rvdw        = 1.0

tcoupl      = V-rescale    ; 温度制御
tc-grps     = System
tau_t       = 0.1
ref_t       = 300          ; 300 K
EOF

gmx grompp -f nvt.mdp -c em.gro -p topol.top -o nvt.tpr
gmx mdrun -v -deffnm nvt

# 温度の確認
gmx energy -f nvt.edr -o temperature.xvg << EOF
16 0
EOF
# 16 = Temperature

# ===================================
# ステップ5: MDシミュレーション実行
# ===================================
cat > md.mdp << EOF
integrator  = md
dt          = 0.002
nsteps      = 500000       ; 1 ns
nstenergy   = 1000
nstlog      = 1000
nstxout-compressed = 1000

cutoff-scheme = Verlet
coulombtype = PME
rcoulomb    = 1.0
rvdw        = 1.0

tcoupl      = V-rescale
tc-grps     = System
tau_t       = 0.1
ref_t       = 300
EOF

gmx grompp -f md.mdp -c nvt.gro -p topol.top -o md.tpr
gmx mdrun -v -deffnm md

# トラジェクトリ確認
echo 0 | gmx trjconv -s md.tpr -f md.xtc -o md_center.xtc -center -pbc mol
# 0 = System選択

echo "水分子系のMDシミュレーション完了！"
echo "出力ファイル: md.xtc（トラジェクトリ）, md.edr（エネルギー）"
</code></pre>

            <h3>コード例4: リゾチームタンパク質のエネルギー最小化</h3>
            <pre><code class="language-bash"># ===================================
# ステップ1: PDBファイルのダウンロード
# ===================================
# リゾチーム（PDB ID: 1AKI）をダウンロード
wget https://files.rcsb.org/download/1AKI.pdb

# ===================================
# ステップ2: トポロジー生成（pdb2gmx）
# ===================================
gmx pdb2gmx -f 1AKI.pdb -o protein.gro -water spce -ff amber99sb

# プロンプトで選択:
# - Force field: 1 (AMBER99SB)
# - Water model: 1 (SPC/E)

# 出力ファイル:
# - protein.gro: 処理後の座標
# - topol.top: トポロジー
# - posre.itp: 位置拘束パラメータ

# ===================================
# ステップ3: ボックス作成と溶媒和
# ===================================
# 立方体ボックス（タンパク質から1.0 nm距離）
gmx editconf -f protein.gro -o protein_box.gro -c -d 1.0 -bt cubic

# 水分子で満たす
gmx solvate -cp protein_box.gro -cs spc216.gro -o protein_solv.gro -p topol.top

# ===================================
# ステップ4: イオン追加（中性化）
# ===================================
# ions.mdpファイル作成
cat > ions.mdp << EOF
integrator  = steep
emtol       = 1000.0
nsteps      = 50000
EOF

gmx grompp -f ions.mdp -c protein_solv.gro -p topol.top -o ions.tpr

# イオン追加（SOLグループを選択）
echo "SOL" | gmx genion -s ions.tpr -o protein_ions.gro -p topol.top -pname NA -nname CL -neutral

# ===================================
# ステップ5: エネルギー最小化
# ===================================
cat > em.mdp << EOF
integrator  = steep
emtol       = 1000.0
emstep      = 0.01
nsteps      = 50000

nstlist     = 10
cutoff-scheme = Verlet
ns_type     = grid
coulombtype = PME
rcoulomb    = 1.0
rvdw        = 1.0
pbc         = xyz
EOF

gmx grompp -f em.mdp -c protein_ions.gro -p topol.top -o em.tpr
gmx mdrun -v -deffnm em

# ===================================
# ステップ6: 結果の確認
# ===================================
# ポテンシャルエネルギーの時間発展
gmx energy -f em.edr -o potential_em.xvg << EOF
10 0
EOF

# グラフ表示（xmgraceまたはPythonで）
# 期待される結果: エネルギーが負の値に収束（約 -1.0e6 kJ/mol）

echo "エネルギー最小化完了！"
echo "最終構造: em.gro"
echo "最大力（Fmax）がem.logに記録されています"

# Fmaxの確認（目標: <1000 kJ/mol/nm）
tail -n 20 em.log | grep "Fmax"
</code></pre>

            <div class="info-box">
                <strong>エネルギー最小化の収束判定</strong>
                <ul>
                    <li><strong>Fmax < 1000 kJ/mol/nm</strong>: 基本的な収束（次のステップへ進める）</li>
                    <li><strong>Fmax < 100 kJ/mol/nm</strong>: 良好な収束（精密なシミュレーション向け）</li>
                    <li><strong>Fmax > 10000 kJ/mol/nm</strong>: 構造に問題がある可能性（原子の重なり、力場の不一致等）</li>
                </ul>
            </div>

            <h3>コード例5: GPU並列実行とパフォーマンス測定</h3>
            <pre><code class="language-bash"># ===================================
# GPU使用でMDシミュレーション実行
# ===================================

# GPU検出確認
gmx mdrun -ntmpi 1 -ntomp 4 -nb gpu -pme gpu -bonded gpu -gpu_id 0 -v

# パフォーマンステスト用mdpファイル作成
cat > benchmark.mdp << EOF
integrator  = md
dt          = 0.002
nsteps      = 50000        ; 100 ps
nstenergy   = 5000
nstlog      = 5000
nstxout-compressed = 5000

cutoff-scheme = Verlet
coulombtype = PME
rcoulomb    = 1.0
rvdw        = 1.0

tcoupl      = V-rescale
tc-grps     = System
tau_t       = 0.1
ref_t       = 300
EOF

# tprファイル作成（前述のリゾチーム系を使用）
gmx grompp -f benchmark.mdp -c em.gro -p topol.top -o benchmark.tpr

# CPU実行（ベースライン）
echo "=== CPU Benchmark ==="
gmx mdrun -v -deffnm benchmark_cpu -ntmpi 1 -ntomp 8 -nb cpu -pme cpu

# CPU実行時間を記録
grep "Performance" md_cpu.log

# GPU実行（非結合相互作用 + PME）
echo "=== GPU Benchmark ==="
gmx mdrun -v -deffnm benchmark_gpu -ntmpi 1 -ntomp 4 -nb gpu -pme gpu -bonded gpu -gpu_id 0

# GPU実行時間を記録
grep "Performance" md_gpu.log

# ===================================
# パフォーマンス比較スクリプト
# ===================================
cat > compare_performance.sh << 'EOF'
#!/bin/bash

cpu_perf=$(grep "Performance:" benchmark_cpu.log | awk '{print $2}')
gpu_perf=$(grep "Performance:" benchmark_gpu.log | awk '{print $2}')

echo "CPU Performance: $cpu_perf ns/day"
echo "GPU Performance: $gpu_perf ns/day"

speedup=$(echo "scale=2; $gpu_perf / $cpu_perf" | bc)
echo "GPU Speedup: ${speedup}x"
EOF

chmod +x compare_performance.sh
./compare_performance.sh

# 期待される出力例:
# CPU Performance: 5.2 ns/day
# GPU Performance: 87.3 ns/day
# GPU Speedup: 16.79x
</code></pre>
        </section>

        <section id="learning-objectives">
            <h2>1.7 学習目標の確認</h2>

            <p>このchapterを完了すると、以下を説明できるようになります：</p>

            <h3>基本理解</h3>
            <ul>
                <li>✅ 分子動力学法がニュートン方程式に基づく古典力学シミュレーションであることを説明できる</li>
                <li>✅ 力場（AMBER、CHARMM、OPLS、GROMOS）の特徴と違いを説明できる</li>
                <li>✅ トポロジーファイル（.top）、座標ファイル（.gro）、パラメータファイル（.mdp）の役割を理解できる</li>
                <li>✅ MDワークフローの5ステップ（構造準備→溶媒和→最小化→平衡化→本計算）を説明できる</li>
            </ul>

            <h3>実践スキル</h3>
            <ul>
                <li>✅ GROMACSをソースからビルドし、GPU対応を有効化できる</li>
                <li>✅ gmx --versionでバージョンとGPUサポートを確認できる</li>
                <li>✅ 水分子系の簡単なMDシミュレーションを実行できる</li>
                <li>✅ pdb2gmxでタンパク質のトポロジーを生成できる</li>
                <li>✅ エネルギー最小化を実行し、Fmax（最大力）を確認できる</li>
            </ul>

            <h3>応用力</h3>
            <ul>
                <li>✅ 研究目的（タンパク質構造、膜系、リガンド結合等）に応じて適切な力場を選択できる</li>
                <li>✅ CPU vs GPU性能を比較し、GPU高速化の効果を評価できる</li>
                <li>✅ エネルギー最小化の収束状況を判断し、次のステップへ進む可否を決定できる</li>
                <li>✅ .mdpファイルのパラメータ（積分法、サーモスタット、カットオフ等）を理解し、目的に応じて調整できる</li>
            </ul>
        </section>

        <section id="exercises">
            <h2>1.8 演習問題</h2>

            <div class="exercise-box">
                <h4>Easy 1: GROMACSバージョン確認 <span class="difficulty easy">基礎</span></h4>
                <p><strong>問題</strong>: インストールしたGROMACSのバージョン、GPU対応、MPI対応を確認しなさい。</p>
                <details>
                    <summary>解答を見る</summary>
                    <p><strong>実行コマンド</strong>:</p>
                    <pre><code class="language-bash">gmx --version</code></pre>
                    <p><strong>確認項目</strong>:</p>
                    <ul>
                        <li><strong>GROMACS version</strong>: バージョン番号（例: 2024）</li>
                        <li><strong>GPU support</strong>: CUDA（GPU対応）またはnone（CPU版）</li>
                        <li><strong>MPI library</strong>: thread_mpi（スレッド並列）またはmpi（MPI並列）</li>
                        <li><strong>SIMD instructions</strong>: 使用されるSIMD命令セット（AVX2_256等）</li>
                    </ul>
                    <p><strong>応用</strong>: GPU IDを指定して実行する場合は<code>gmx mdrun -gpu_id 0</code>のように指定します。</p>
                </details>
            </div>

            <div class="exercise-box">
                <h4>Easy 2: 力場の選択 <span class="difficulty easy">基礎</span></h4>
                <p><strong>問題</strong>: タンパク質構造予測、膜タンパク質研究、有機小分子の結合研究、それぞれに推奨される力場を挙げなさい。</p>
                <details>
                    <summary>解答を見る</summary>
                    <p><strong>解答</strong>:</p>
                    <table>
                        <thead>
                            <tr>
                                <th>研究目的</th>
                                <th>推奨力場</th>
                                <th>理由</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>タンパク質構造予測</td>
                                <td>AMBER ff14SB, CHARMM36m</td>
                                <td>タンパク質の二次構造を正確に再現</td>
                            </tr>
                            <tr>
                                <td>膜タンパク質研究</td>
                                <td>CHARMM36</td>
                                <td>脂質パラメータが豊富、膜系に最適化</td>
                            </tr>
                            <tr>
                                <td>有機小分子結合</td>
                                <td>OPLS-AA, GAFF（AMBER）</td>
                                <td>有機分子のパラメータが充実</td>
                            </tr>
                        </tbody>
                    </table>
                    <p><strong>補足</strong>: 複数の力場を組み合わせる場合（タンパク質 + リガンド）、互換性を確認する必要があります。</p>
                </details>
            </div>

            <div class="exercise-box">
                <h4>Easy 3: エネルギー最小化の収束判定 <span class="difficulty easy">基礎</span></h4>
                <p><strong>問題</strong>: エネルギー最小化後、Fmax（最大力）が以下の値だった場合、それぞれどう判断すべきか答えなさい：(a) 85 kJ/mol/nm、(b) 1200 kJ/mol/nm、(c) 25000 kJ/mol/nm。</p>
                <details>
                    <summary>解答を見る</summary>
                    <p><strong>解答</strong>:</p>
                    <ul>
                        <li><strong>(a) 85 kJ/mol/nm</strong>: ✅ 良好に収束。次のステップ（平衡化）へ進める。精密なシミュレーションに適したレベル。</li>
                        <li><strong>(b) 1200 kJ/mol/nm</strong>: ⚠️ 基本的には収束と見なせるが、やや高い。可能なら追加のエネルギー最小化（nstepsを増やす）を推奨。</li>
                        <li><strong>(c) 25000 kJ/mol/nm</strong>: ❌ 収束していない。構造に問題がある可能性が高い（原子の重なり、力場の不一致、水素原子の欠落等）。pdb2gmxの警告を確認し、構造を修正する必要がある。</li>
                    </ul>
                    <p><strong>対処法（収束しない場合）</strong>:</p>
                    <ol>
                        <li>emstep（ステップサイズ）を小さくする（例: 0.01 → 0.001）</li>
                        <li>アルゴリズムをsteepest descent → conjugate gradientに変更</li>
                        <li>pdb2gmxの出力で警告がないか確認</li>
                    </ol>
                </details>
            </div>

            <div class="exercise-box">
                <h4>Medium 1: トポロジーファイルの理解 <span class="difficulty medium">応用</span></h4>
                <p><strong>問題</strong>: トポロジーファイル（.top）の主要なセクション（[ moleculetype ]、[ atoms ]、[ bonds ]、[ system ]、[ molecules ]）の役割を説明しなさい。</p>
                <details>
                    <summary>解答を見る</summary>
                    <p><strong>解答</strong>:</p>
                    <table>
                        <thead>
                            <tr>
                                <th>セクション</th>
                                <th>役割</th>
                                <th>記述内容</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>[ moleculetype ]</code></td>
                                <td>分子の定義</td>
                                <td>分子名、除外する相互作用の数（nrexcl）</td>
                            </tr>
                            <tr>
                                <td><code>[ atoms ]</code></td>
                                <td>原子リスト</td>
                                <td>原子番号、原子タイプ、残基番号、原子名、電荷、質量</td>
                            </tr>
                            <tr>
                                <td><code>[ bonds ]</code></td>
                                <td>結合の定義</td>
                                <td>結合する2原子のインデックス、結合タイプ</td>
                            </tr>
                            <tr>
                                <td><code>[ angles ]</code></td>
                                <td>角度の定義</td>
                                <td>3原子の角度、角度タイプ</td>
                            </tr>
                            <tr>
                                <td><code>[ dihedrals ]</code></td>
                                <td>二面角の定義</td>
                                <td>4原子の二面角、二面角タイプ</td>
                            </tr>
                            <tr>
                                <td><code>[ system ]</code></td>
                                <td>系の名前</td>
                                <td>シミュレーション系の説明文</td>
                            </tr>
                            <tr>
                                <td><code>[ molecules ]</code></td>
                                <td>分子の個数</td>
                                <td>各分子の名前と個数（タンパク質1個、水分子5000個等）</td>
                            </tr>
                        </tbody>
                    </table>
                    <p><strong>重要ポイント</strong>: [ molecules ]セクションの順序は、.groファイルの原子順序と一致する必要があります。</p>
                </details>
            </div>

            <div class="exercise-box">
                <h4>Medium 2: MDパラメータの設定 <span class="difficulty medium">応用</span></h4>
                <p><strong>問題</strong>: .mdpファイルで以下のパラメータが何を制御するか説明しなさい：(a) dt、(b) nsteps、(c) tcoupl、(d) pcoupl、(e) coulombtype。</p>
                <details>
                    <summary>解答を見る</summary>
                    <p><strong>解答</strong>:</p>
                    <table>
                        <thead>
                            <tr>
                                <th>パラメータ</th>
                                <th>意味</th>
                                <th>典型的な値</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>dt</code></td>
                                <td>時間ステップ（ps単位）</td>
                                <td>0.002（2 fs）、SHAKE/LINCS使用時は0.002、使用しない場合は0.001</td>
                            </tr>
                            <tr>
                                <td><code>nsteps</code></td>
                                <td>総ステップ数</td>
                                <td>50000ステップ × 0.002 ps = 100 ps</td>
                            </tr>
                            <tr>
                                <td><code>tcoupl</code></td>
                                <td>温度制御（サーモスタット）</td>
                                <td>V-rescale（推奨）、Berendsen（平衡化用）、Nose-Hoover（精密な熱力学）</td>
                            </tr>
                            <tr>
                                <td><code>pcoupl</code></td>
                                <td>圧力制御（バロスタット）</td>
                                <td>Berendsen（平衡化用）、Parrinello-Rahman（本計算用）</td>
                            </tr>
                            <tr>
                                <td><code>coulombtype</code></td>
                                <td>静電相互作用の計算法</td>
                                <td>PME（Particle Mesh Ewald）、周期境界条件で精密な静電計算</td>
                            </tr>
                        </tbody>
                    </table>
                    <p><strong>注意</strong>: Berendsenサーモスタット/バロスタットは平衡化には良いですが、本計算ではV-rescale/Parrinello-Rahmanを使うべきです（Berendsenは正しい熱力学アンサンブルを生成しないため）。</p>
                </details>
            </div>

            <div class="exercise-box">
                <h4>Medium 3: Leap-frog積分法の理解 <span class="difficulty medium">応用</span></h4>
                <p><strong>問題</strong>: Leap-frog法で、速度と座標がどのように時間発展するか、数式を用いて説明しなさい。また、Verlet法と比較した利点を述べなさい。</p>
                <details>
                    <summary>解答を見る</summary>
                    <p><strong>Leap-frog法の数式</strong>:</p>
                    <p>
                        $$
                        \mathbf{v}(t + \frac{\Delta t}{2}) = \mathbf{v}(t - \frac{\Delta t}{2}) + \frac{\mathbf{F}(t)}{m} \Delta t
                        $$
                    </p>
                    <p>
                        $$
                        \mathbf{r}(t + \Delta t) = \mathbf{r}(t) + \mathbf{v}(t + \frac{\Delta t}{2}) \Delta t
                        $$
                    </p>
                    <p><strong>説明</strong>:</p>
                    <ul>
                        <li>速度は半ステップずれた時刻（t ± Δt/2）で計算される</li>
                        <li>座標は整数ステップ（t, t+Δt, ...）で更新される</li>
                        <li>力は整数ステップの座標から計算される</li>
                    </ul>
                    <p><strong>Verlet法との比較</strong>:</p>
                    <table>
                        <thead>
                            <tr>
                                <th>特性</th>
                                <th>Leap-frog</th>
                                <th>Verlet</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>速度の扱い</td>
                                <td>明示的に計算</td>
                                <td>間接的（座標の差分から）</td>
                            </tr>
                            <tr>
                                <td>数値安定性</td>
                                <td>同等</td>
                                <td>同等</td>
                            </tr>
                            <tr>
                                <td>運動エネルギー計算</td>
                                <td>直接計算可能</td>
                                <td>補間が必要</td>
                            </tr>
                            <tr>
                                <td>メモリ使用量</td>
                                <td>1世代分の速度を保持</td>
                                <td>2世代分の座標を保持</td>
                            </tr>
                        </tbody>
                    </table>
                    <p><strong>利点</strong>: Leap-frog法は速度が明示的なため、温度制御（サーモスタット）の実装が容易で、運動エネルギーの計算も直接的です。</p>
                </details>
            </div>

            <div class="exercise-box">
                <h4>Medium 4: GPU高速化の評価 <span class="difficulty medium">応用</span></h4>
                <p><strong>問題</strong>: コード例5を実行し、CPU版とGPU版の性能（ns/day）を比較しなさい。高速化率が期待値（10-50倍）より低い場合、考えられる原因を3つ挙げなさい。</p>
                <details>
                    <summary>解答を見る</summary>
                    <p><strong>性能比較方法</strong>:</p>
                    <pre><code class="language-bash"># CPU版実行
gmx mdrun -v -deffnm benchmark_cpu -ntmpi 1 -ntomp 8 -nb cpu -pme cpu

# GPU版実行
gmx mdrun -v -deffnm benchmark_gpu -ntmpi 1 -ntomp 4 -nb gpu -pme gpu -bonded gpu

# パフォーマンス確認
grep "Performance:" benchmark_cpu.log benchmark_gpu.log
</code></pre>
                    <p><strong>高速化率が低い原因</strong>:</p>
                    <ol>
                        <li><strong>システムサイズが小さい</strong>: 数千原子以下の小規模系では、GPUへのデータ転送オーバーヘッドが大きく、並列化の効果が出にくい。目安: 10,000原子以上で高速化率が向上。</li>
                        <li><strong>CPU-GPU間のデータ転送ボトルネック</strong>: PCIe帯域幅（16 GB/s程度）が律速。GPU上でできる限り計算を完結させる（<code>-bonded gpu</code>オプション）ことで改善。</li>
                        <li><strong>GPU性能が低い</strong>: 古いGPU（GTX 900シリーズ以前）やエントリー級GPU（MX150等）では、最新GPUと比較して性能が大幅に低い。RTX 3060以上推奨。</li>
                    </ol>
                    <p><strong>最適化のヒント</strong>:</p>
                    <ul>
                        <li><code>-ntomp</code>（OpenMPスレッド数）を調整（GPU使用時は4-8程度が最適）</li>
                        <li><code>-pme gpu</code>でPME計算もGPUで実行</li>
                        <li><code>-update gpu</code>で座標更新もGPUで実行（GROMACS 2020以降）</li>
                    </ul>
                </details>
            </div>

            <div class="exercise-box">
                <h4>Hard 1: 力場の選択基準 <span class="difficulty hard">発展</span></h4>
                <p><strong>問題</strong>: 以下の研究プロジェクトに対して、最適な力場を選択し、その理由を説明しなさい：(a) 膜貫通型GPCRのリガンド結合、(b) DNA-タンパク質複合体の動態解析、(c) 抗体Fab領域の構造予測。</p>
                <details>
                    <summary>解答を見る</summary>
                    <p><strong>解答</strong>:</p>

                    <h5>(a) 膜貫通型GPCRのリガンド結合</h5>
                    <p><strong>推奨力場</strong>: CHARMM36 + CGenFF（リガンド用）</p>
                    <ul>
                        <li><strong>理由</strong>:
                            <ul>
                                <li>CHARMM36は脂質膜パラメータが充実しており、膜タンパク質研究のゴールドスタンダード</li>
                                <li>CGenFF（CHARMM General Force Field）で小分子リガンドのパラメータを生成可能</li>
                                <li>タンパク質-脂質-リガンドの3者を統一的に扱える</li>
                            </ul>
                        </li>
                        <li><strong>代替案</strong>: AMBER ff14SB（タンパク質） + Slipids（脂質） + GAFF（リガンド）の組み合わせ</li>
                    </ul>

                    <h5>(b) DNA-タンパク質複合体の動態解析</h5>
                    <p><strong>推奨力場</strong>: AMBER ff14SB（タンパク質） + ff99bsc0_chiOL3（DNA）</p>
                    <ul>
                        <li><strong>理由</strong>:
                            <ul>
                                <li>AMBER ff99bsc0はDNA二重らせん構造の安定性を正確に再現</li>
                                <li>chiOL3修正により、糖パッカリング（グリコシド結合回転）の精度向上</li>
                                <li>タンパク質-DNA相互作用のバランスが実験データと一致</li>
                            </ul>
                        </li>
                        <li><strong>注意点</strong>: RNA研究にはff99bsc0_chiOL3（RNA版）を使用</li>
                    </ul>

                    <h5>(c) 抗体Fab領域の構造予測</h5>
                    <p><strong>推奨力場</strong>: AMBER ff14SB または CHARMM36m</p>
                    <ul>
                        <li><strong>理由</strong>:
                            <ul>
                                <li>両力場ともタンパク質二次構造（β-sheet、α-helix）の安定性が高い</li>
                                <li>CHARMM36mは可動性ループ領域の精度が向上</li>
                                <li>抗体CDR（相補性決定領域）のような柔軟な構造の再現に適している</li>
                            </ul>
                        </li>
                        <li><strong>補足</strong>: 糖鎖修飾がある場合は、CHARMM36（糖鎖パラメータが充実）が有利</li>
                    </ul>

                    <p><strong>力場選択の一般原則</strong>:</p>
                    <table>
                        <thead>
                            <tr>
                                <th>系の種類</th>
                                <th>第1候補</th>
                                <th>第2候補</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>タンパク質のみ</td>
                                <td>AMBER ff14SB</td>
                                <td>CHARMM36m</td>
                            </tr>
                            <tr>
                                <td>膜タンパク質</td>
                                <td>CHARMM36</td>
                                <td>AMBER + Slipids</td>
                            </tr>
                            <tr>
                                <td>DNA/RNA</td>
                                <td>AMBER ff99bsc0_chiOL3</td>
                                <td>CHARMM36</td>
                            </tr>
                            <tr>
                                <td>小分子リガンド</td>
                                <td>GAFF（AMBER）</td>
                                <td>CGenFF（CHARMM）</td>
                            </tr>
                        </tbody>
                    </table>
                </details>
            </div>

            <div class="exercise-box">
                <h4>Hard 2: MDワークフローの設計 <span class="difficulty hard">発展</span></h4>
                <p><strong>問題</strong>: タンパク質（300残基）の100 nsシミュレーションを実行する計画を立てなさい。(a) 各ステップ（最小化、NVT、NPT、Production）の推奨時間、(b) 必要な計算資源（GPUスペック、実行時間）、(c) トラジェクトリファイルサイズの見積もりを示しなさい。</p>
                <details>
                    <summary>解答を見る</summary>
                    <p><strong>ワークフロー設計</strong>:</p>

                    <h5>(a) 各ステップの推奨時間</h5>
                    <table>
                        <thead>
                            <tr>
                                <th>ステップ</th>
                                <th>シミュレーション時間</th>
                                <th>時間ステップ</th>
                                <th>目的</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>エネルギー最小化</td>
                                <td>-（50,000ステップ）</td>
                                <td>-</td>
                                <td>構造の緩和、力の最小化</td>
                            </tr>
                            <tr>
                                <td>NVT平衡化</td>
                                <td>100 ps</td>
                                <td>2 fs</td>
                                <td>温度を目標値（300 K）に安定化</td>
                            </tr>
                            <tr>
                                <td>NPT平衡化</td>
                                <td>100 ps</td>
                                <td>2 fs</td>
                                <td>圧力を1 barに安定化、密度調整</td>
                            </tr>
                            <tr>
                                <td>Production MD</td>
                                <td>100 ns</td>
                                <td>2 fs</td>
                                <td>本計算、統計データ収集</td>
                            </tr>
                        </tbody>
                    </table>

                    <h5>(b) 必要な計算資源</h5>
                    <p><strong>システムサイズ見積もり</strong>:</p>
                    <ul>
                        <li>タンパク質: 300残基 × 約10原子/残基 = 約3,000原子</li>
                        <li>水分子: タンパク質から1 nm距離の立方体ボックス → 約40,000原子（水 + イオン）</li>
                        <li><strong>総原子数</strong>: 約43,000原子</li>
                    </ul>

                    <p><strong>GPUスペックと実行時間</strong>:</p>
                    <table>
                        <thead>
                            <tr>
                                <th>GPUモデル</th>
                                <th>性能（ns/day）</th>
                                <th>100 ns実行時間</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>RTX 3060 Ti</td>
                                <td>50-70 ns/day</td>
                                <td>1.5-2日</td>
                            </tr>
                            <tr>
                                <td>RTX 3090</td>
                                <td>100-150 ns/day</td>
                                <td>0.7-1日</td>
                            </tr>
                            <tr>
                                <td>A100 (80GB)</td>
                                <td>200-300 ns/day</td>
                                <td>0.3-0.5日</td>
                            </tr>
                        </tbody>
                    </table>

                    <h5>(c) トラジェクトリファイルサイズの見積もり</h5>
                    <p><strong>計算式</strong>:</p>
                    <p>
                        ファイルサイズ = 原子数 × 座標次元（3） × バイト数（4-8） × フレーム数
                    </p>
                    <p><strong>具体例</strong>:</p>
                    <ul>
                        <li>原子数: 43,000</li>
                        <li>座標: x, y, z（3次元）</li>
                        <li>精度: 単精度（4バイト/座標）</li>
                        <li>保存頻度: 10 ps（100 nsで10,000フレーム）</li>
                    </ul>
                    <p>
                        $$
                        \text{サイズ} = 43{,}000 \times 3 \times 4 \times 10{,}000 = 5{,}160{,}000{,}000 \text{ bytes} \approx 5.2 \text{ GB}
                        $$
                    </p>
                    <p><strong>圧縮（.xtcフォーマット）</strong>: 約1/10に圧縮されるため、<strong>約520 MB</strong>が実際のファイルサイズ。</p>

                    <p><strong>ストレージ要件</strong>:</p>
                    <ul>
                        <li>.xtc（トラジェクトリ）: 約500 MB</li>
                        <li>.edr（エネルギー）: 約10 MB</li>
                        <li>.log（ログ）: 約5 MB</li>
                        <li><strong>合計</strong>: 約515 MB/100 ns</li>
                    </ul>

                    <p><strong>推奨リソース配分</strong>:</p>
                    <pre><code class="language-bash"># 実行コマンド例（RTX 3090想定）
gmx mdrun -v -deffnm production \
    -ntmpi 1 -ntomp 8 \
    -nb gpu -pme gpu -bonded gpu \
    -gpu_id 0 \
    -maxh 24
# -maxh 24: 24時間で自動停止（再開可能）
</code></pre>
                </details>
            </div>

            <div class="exercise-box">
                <h4>Hard 3: 力場パラメータのカスタマイズ <span class="difficulty hard">発展</span></h4>
                <p><strong>問題</strong>: 新規リガンド（未知の有機小分子）のMDシミュレーションを実行する場合、力場パラメータをどのように準備すればよいか説明しなさい。GAFF（General Amber Force Field）を使う方法と、量子化学計算からパラメータを導出する方法を比較しなさい。</p>
                <details>
                    <summary>解答を見る</summary>
                    <p><strong>方法1: GAFF（General Amber Force Field）を使う</strong></p>

                    <h5>ステップ1: 分子構造の準備</h5>
                    <pre><code class="language-bash"># Antechamberで分子構造を読み込み、原子タイプを割り当て
antechamber -i ligand.pdb -fi pdb -o ligand.mol2 -fo mol2 \
    -c bcc -s 2 -nc 0
# -c bcc: AM1-BCC電荷計算（半経験的量子化学）
# -nc 0: 中性分子
</code></pre>

                    <h5>ステップ2: GAFFパラメータの生成</h5>
                    <pre><code class="language-bash"># parmchk2でGAFFパラメータを生成
parmchk2 -i ligand.mol2 -f mol2 -o ligand.frcmod
# 不足しているパラメータを自動生成
</code></pre>

                    <h5>ステップ3: GROMACSフォーマットへの変換</h5>
                    <pre><code class="language-bash"># acpypeでGROMACS用ファイルを生成
acpype -i ligand.mol2
# 出力: ligand_GMX.gro, ligand_GMX.top
</code></pre>

                    <p><strong>利点</strong>:</p>
                    <ul>
                        <li>迅速（数分で完了）</li>
                        <li>有機小分子の大部分をカバーする汎用パラメータ</li>
                        <li>実験値（液体密度等）に基づく検証済み</li>
                    </ul>
                    <p><strong>欠点</strong>:</p>
                    <ul>
                        <li>特殊な官能基（金属配位、ラジカル等）には対応できない場合がある</li>
                        <li>電荷計算がAM1-BCCに限定（精度に限界）</li>
                    </ul>

                    <hr>

                    <p><strong>方法2: 量子化学計算からパラメータを導出</strong></p>

                    <h5>ステップ1: 分子構造の最適化</h5>
                    <pre><code class="language-python"># Gaussian/ORCA/Psi4等で構造最適化
# 例: Gaussian入力ファイル（ligand.gjf）
%Mem=16GB
%NProcShared=8
# B3LYP/6-31G* Opt Freq

0 1
C   0.000  0.000  0.000
H   0.000  0.000  1.089
...（座標省略）...

# 実行後、最適化構造を取得
</code></pre>

                    <h5>ステップ2: 電荷計算（RESP法）</h5>
                    <pre><code class="language-bash"># HF/6-31G*レベルで静電ポテンシャル計算
# RESP法で部分電荷をフィッティング
# （Antechamberのresputilまたは専用ツール使用）
</code></pre>

                    <h5>ステップ3: 力定数の導出</h5>
                    <p>結合、角度、二面角の力定数を振動解析から導出し、トポロジーファイルに手動で追加。</p>

                    <p><strong>利点</strong>:</p>
                    <ul>
                        <li>高精度（量子化学レベルの電荷、力定数）</li>
                        <li>特殊な官能基にも対応可能</li>
                        <li>研究論文での正当性が高い</li>
                    </ul>
                    <p><strong>欠点</strong>:</p>
                    <ul>
                        <li>計算時間が長い（数時間〜数日）</li>
                        <li>専門知識（量子化学、パラメータフィッティング）が必要</li>
                        <li>実装が複雑</li>
                    </ul>

                    <hr>

                    <p><strong>推奨ワークフロー</strong>:</p>
                    <ol>
                        <li><strong>初期検討</strong>: GAFFで迅速にパラメータ生成、予備シミュレーション実行</li>
                        <li><strong>精密化</strong>: 重要な相互作用（リガンド-タンパク質結合等）が見つかった場合、量子化学計算で電荷を再計算</li>
                        <li><strong>検証</strong>: 実験データ（結合自由エネルギー、構造等）と比較し、必要に応じてパラメータを調整</li>
                    </ol>

                    <p><strong>ツール比較</strong>:</p>
                    <table>
                        <thead>
                            <tr>
                                <th>ツール</th>
                                <th>用途</th>
                                <th>精度</th>
                                <th>時間</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>GAFF + Antechamber</td>
                                <td>汎用有機小分子</td>
                                <td>中</td>
                                <td>数分</td>
                            </tr>
                            <tr>
                                <td>CGenFF（CHARMM）</td>
                                <td>CHARMM力場互換</td>
                                <td>中</td>
                                <td>数分</td>
                            </tr>
                            <tr>
                                <td>量子化学（RESP）</td>
                                <td>高精度要求、特殊分子</td>
                                <td>高</td>
                                <td>数時間〜数日</td>
                            </tr>
                            <tr>
                                <td>SwissParam</td>
                                <td>簡易Webツール（CHARMM）</td>
                                <td>低〜中</td>
                                <td>数秒</td>
                            </tr>
                        </tbody>
                    </table>
                </details>
            </div>
        </section>

        <section id="references">
            <h2>1.9 参考文献</h2>

            <ol>
                <li>Abraham, M. J., et al. (2015). <em>GROMACS: High performance molecular simulations through multi-level parallelism from laptops to supercomputers</em>. SoftwareX, 1-2, 19-25. <a href="https://doi.org/10.1016/j.softx.2015.06.001" target="_blank">https://doi.org/10.1016/j.softx.2015.06.001</a></li>
                <li>Maier, J. A., et al. (2015). <em>ff14SB: Improving the Accuracy of Protein Side Chain and Backbone Parameters from ff99SB</em>. Journal of Chemical Theory and Computation, 11(8), 3696-3713. <a href="https://pubs.acs.org/doi/10.1021/acs.jctc.5b00255" target="_blank">DOI: 10.1021/acs.jctc.5b00255</a></li>
                <li>Huang, J., & MacKerell, A. D., Jr. (2013). <em>CHARMM36 all-atom additive protein force field: Validation based on comparison to NMR data</em>. Journal of Computational Chemistry, 34(25), 2135-2145. <a href="https://doi.org/10.1002/jcc.23354" target="_blank">DOI: 10.1002/jcc.23354</a></li>
                <li>Berendsen, H. J. C., et al. (1995). <em>GROMACS: A message-passing parallel molecular dynamics implementation</em>. Computer Physics Communications, 91(1-3), 43-56.</li>
                <li>GROMACS Documentation. (2024). <em>GROMACS User Guide</em>. <a href="https://manual.gromacs.org/" target="_blank">https://manual.gromacs.org/</a></li>
                <li>Lemkul, J. A. (2019). <em>From Proteins to Perturbed Hamiltonians: A Suite of Tutorials for the GROMACS-2018 Molecular Simulation Package [Article v1.0]</em>. Living Journal of Computational Molecular Science, 1(1), 5068. <a href="https://doi.org/10.33011/livecoms.1.1.5068" target="_blank">DOI: 10.33011/livecoms.1.1.5068</a></li>
                <li>Páll, S., et al. (2015). <em>Heterogeneous parallelization and acceleration of molecular dynamics simulations in GROMACS</em>. Journal of Chemical Physics, 153(13), 134110. <a href="https://doi.org/10.1063/5.0018516" target="_blank">DOI: 10.1063/5.0018516</a></li>
            </ol>
        </section>

        <section id="navigation">
            <h2>次のステップ</h2>
            <p>本章で、GROMACSの基礎とMDシミュレーションの原理を理解しました。次章では、タンパク質の本格的なMDシミュレーションを実践し、溶媒和、平衡化、本計算、解析までの全ワークフローを習得します。</p>
            <div style="display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--border-light);">
                <a href="index.html" style="padding: 1rem 2rem; background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-lime) 100%); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">← シリーズ目次</a>
                <a href="chapter-2.html" style="padding: 1rem 2rem; background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-lime) 100%); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">第2章: タンパク質シミュレーションの実践 →</a>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 CT Dojo. All rights reserved.</p>
        <p><a href="https://github.com/yourusername/gromacs-tutorial">GitHub Repository</a> | <a href="mailto:yusuke.hashimoto.b8@tohoku.ac.jp">Contact</a></p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default', securityLevel: 'strict' });
    </script>
</body>
</html>
