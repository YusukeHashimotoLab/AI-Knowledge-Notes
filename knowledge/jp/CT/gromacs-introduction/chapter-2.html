<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 2: ã‚¿ãƒ³ãƒ‘ã‚¯è³ªãƒ»æ°´ç³»ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— | GROMACSå…¥é–€</title>
    <meta name="description" content="GROMACSã«ãŠã‘ã‚‹ã‚¿ãƒ³ãƒ‘ã‚¯è³ªç³»ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€ãƒˆãƒãƒ­ã‚¸ãƒ¼ç”Ÿæˆã€æº¶åª’å’Œã€ã‚¤ã‚ªãƒ³ä»˜åŠ ã®å®Ÿè·µçš„æ‰‹æ³•ã‚’å­¦ã³ã¾ã™ã€‚">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --ct-gradient-start: #11998e;
            --ct-gradient-end: #38ef7d;
            --primary-color: #11998e;
            --text-color: #2c3e50;
            --bg-light: #f8f9fa;
            --code-bg: #1e1e1e;
            --border-color: #e1e8ed;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans JP', sans-serif; line-height: 1.8; color: var(--text-color); background: #fff; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        header { background: linear-gradient(135deg, var(--ct-gradient-start), var(--ct-gradient-end)); color: white; padding: 3rem 0; margin-bottom: 3rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; text-align: center; }
        header p { font-size: 1.1rem; opacity: 0.95; text-align: center; }
        h2 { color: var(--primary-color); font-size: 2rem; margin: 3rem 0 1.5rem 0; padding-bottom: 0.5rem; border-bottom: 3px solid var(--primary-color); }
        h3 { color: var(--primary-color); font-size: 1.5rem; margin: 2rem 0 1rem 0; }
        h4 { color: var(--text-color); font-size: 1.2rem; margin: 1.5rem 0 0.8rem 0; font-weight: 600; }
        p { margin: 1rem 0; line-height: 1.8; }
        ul, ol { margin: 1rem 0 1rem 2rem; }
        li { margin: 0.5rem 0; }
        code { background: #f4f4f4; padding: 0.2rem 0.4rem; border-radius: 3px; font-family: 'Roboto Mono', monospace; font-size: 0.9em; color: #e83e8c; }
        pre { background: var(--code-bg); color: #f8f8f2; padding: 1.5rem; border-radius: 8px; overflow-x: auto; margin: 1.5rem 0; border-left: 4px solid var(--primary-color); }
        pre code { background: none; color: inherit; padding: 0; font-size: 0.95rem; }
        .info-box { background: linear-gradient(to right, #e3f2fd, #f3f8ff); border-left: 4px solid #2196F3; padding: 1.5rem; margin: 2rem 0; border-radius: 4px; }
        .warning-box { background: linear-gradient(to right, #fff3e0, #fffaf5); border-left: 4px solid #ff9800; padding: 1.5rem; margin: 2rem 0; border-radius: 4px; }
        .exercise-box { background: linear-gradient(to right, #f3e5f5, #faf6fb); border-left: 4px solid #9c27b0; padding: 1.5rem; margin: 2rem 0; border-radius: 4px; }
        .tip-box { background: linear-gradient(to right, #e8f5e9, #f5fbf5); border-left: 4px solid #4caf50; padding: 1.5rem; margin: 2rem 0; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin: 2rem 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: linear-gradient(135deg, var(--ct-gradient-start), var(--ct-gradient-end)); color: white; font-weight: 600; }
        tr:hover { background: var(--bg-light); }
        .nav-buttons { display: flex; justify-content: space-between; margin: 3rem 0; }
        .nav-buttons a { background: linear-gradient(135deg, var(--ct-gradient-start), var(--ct-gradient-end)); color: white; padding: 0.8rem 2rem; text-decoration: none; border-radius: 25px; font-weight: 500; transition: transform 0.3s, box-shadow 0.3s; }
        .nav-buttons a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3); }
        .mermaid { background: white; padding: 2rem; border-radius: 8px; margin: 2rem 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            header h1 { font-size: 1.8rem; }
            h2 { font-size: 1.5rem; }
            pre { padding: 1rem; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Chapter 2: ã‚¿ãƒ³ãƒ‘ã‚¯è³ªãƒ»æ°´ç³»ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h1>
            <p>GROMACSã«ãŠã‘ã‚‹ç”Ÿä½“åˆ†å­ç³»ã®æ§‹ç¯‰ - ãƒˆãƒãƒ­ã‚¸ãƒ¼ã€æº¶åª’å’Œã€ã‚¤ã‚ªãƒ³ä»˜åŠ </p>
        </div>
    </header>

    <div class="container">
        <h2>2.1 ã‚¿ãƒ³ãƒ‘ã‚¯è³ªæ§‹é€ ã®æº–å‚™</h2>

        <h3>2.1.1 PDBãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã¨å‰å‡¦ç†</h3>
        <p>ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®MDã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€å®Ÿé¨“çš„ã«æ±ºå®šã•ã‚ŒãŸç«‹ä½“æ§‹é€ ï¼ˆPDBå½¢å¼ï¼‰ã‹ã‚‰é–‹å§‹ã—ã¾ã™ã€‚Protein Data Bank (PDB) ã‹ã‚‰æ§‹é€ ã‚’å–å¾—ã—ã€MDè¨ˆç®—ã«é©ã—ãŸå½¢å¼ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>

        <div class="info-box">
            <h4>ğŸ“˜ PDBå½¢å¼ã¨GROMACSäº’æ›æ€§</h4>
            <p>PDBãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ä»¥ä¸‹ã®å•é¡ŒãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼š</p>
            <ul>
                <li><strong>æ¬ ææ®‹åŸº</strong>ï¼šXç·šå›æŠ˜ã§é›»å­å¯†åº¦ãŒå¾—ã‚‰ã‚Œãªã‹ã£ãŸé ˜åŸŸ</li>
                <li><strong>çµæ™¶æ°´åˆ†å­</strong>ï¼šã‚¿ãƒ³ãƒ‘ã‚¯è³ªè¡¨é¢ã«çµåˆã—ãŸæ°´åˆ†å­</li>
                <li><strong>ãƒ˜ãƒ†ãƒ­åŸå­</strong>ï¼šè£œå› å­ã€é‡‘å±ã‚¤ã‚ªãƒ³ã€ãƒªã‚¬ãƒ³ãƒ‰åˆ†å­</li>
                <li><strong>ä»£æ›¿ä½ç½®</strong>ï¼šè¤‡æ•°ã®ã‚³ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆALTLOC A/Bï¼‰</li>
            </ul>
        </div>

        <h4>Python ã«ã‚ˆã‚‹ PDB ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°</h4>
        <pre><code class="language-python">#!/usr/bin/env python3
"""
PDBãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã¨å‰å‡¦ç†
- ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®ã¿ã‚’æŠ½å‡ºï¼ˆæ°´åˆ†å­ã€ãƒªã‚¬ãƒ³ãƒ‰ã‚’é™¤å»ï¼‰
- ä»£æ›¿ä½ç½®ã®é¸æŠï¼ˆALTLOC A ã‚’é¸æŠï¼‰
- æ¬ ææ®‹åŸºã®æ¤œå‡ºã¨ãƒ¬ãƒãƒ¼ãƒˆ
"""
import sys
from Bio import PDB

def clean_pdb(input_pdb, output_pdb):
    """
    PDBãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®ã¿ã‚’æŠ½å‡ºã—ã€ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°

    Parameters:
    -----------
    input_pdb : str
        å…¥åŠ›PDBãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    output_pdb : str
        å‡ºåŠ›PDBãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    """
    parser = PDB.PDBParser(QUIET=True)
    structure = parser.get_structure('protein', input_pdb)

    # IOã‚¯ãƒ©ã‚¹ã§PDBæ›¸ãå‡ºã—æ™‚ã®å‡¦ç†ã‚’åˆ¶å¾¡
    io = PDB.PDBIO()
    io.set_structure(structure)

    # Selectorã‚¯ãƒ©ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    class ProteinSelect(PDB.Select):
        def accept_residue(self, residue):
            """ã‚¿ãƒ³ãƒ‘ã‚¯è³ªæ®‹åŸºã®ã¿ã‚’å—ã‘å…¥ã‚Œã‚‹"""
            # HETATMãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ°´åˆ†å­ã€ãƒªã‚¬ãƒ³ãƒ‰ã‚’é™¤å¤–ï¼‰
            if residue.id[0] != ' ':
                return False
            # æ¨™æº–ã‚¢ãƒŸãƒé…¸æ®‹åŸºåã®ãƒªã‚¹ãƒˆ
            standard_residues = [
                'ALA', 'ARG', 'ASN', 'ASP', 'CYS', 'GLN', 'GLU',
                'GLY', 'HIS', 'ILE', 'LEU', 'LYS', 'MET', 'PHE',
                'PRO', 'SER', 'THR', 'TRP', 'TYR', 'VAL'
            ]
            return residue.get_resname() in standard_residues

        def accept_atom(self, atom):
            """ä»£æ›¿ä½ç½®ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯ 'A' ã‚’é¸æŠ"""
            if atom.is_disordered():
                atom.disordered_select('A')
            return True

    # ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸPDBã‚’æ›¸ãå‡ºã—
    io.save(output_pdb, ProteinSelect())

    # æ¬ ææ®‹åŸºã®æ¤œå‡º
    detect_missing_residues(structure)

    print(f"âœ… ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Œäº†: {output_pdb}")

def detect_missing_residues(structure):
    """æ¬ ææ®‹åŸºã‚’æ¤œå‡ºã—ã¦å ±å‘Š"""
    for model in structure:
        for chain in model:
            residues = list(chain)
            for i in range(len(residues) - 1):
                current_id = residues[i].id[1]
                next_id = residues[i+1].id[1]
                if next_id - current_id > 1:
                    print(f"âš ï¸  æ¬ ææ¤œå‡º: Chain {chain.id}, "
                          f"æ®‹åŸº {current_id} ã¨ {next_id} ã®é–“")

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print("Usage: python clean_pdb.py input.pdb output.pdb")
        sys.exit(1)

    clean_pdb(sys.argv[1], sys.argv[2])</code></pre>

        <div class="tip-box">
            <h4>ğŸ’¡ å®Ÿè¡Œä¾‹</h4>
            <pre><code class="language-bash"># PDBãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šãƒªã‚¾ãƒãƒ¼ãƒ  1AKIï¼‰
wget https://files.rcsb.org/download/1AKI.pdb

# ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œ
python clean_pdb.py 1AKI.pdb 1AKI_clean.pdb

# çµæœç¢ºèª
grep "^ATOM" 1AKI_clean.pdb | wc -l  # åŸå­æ•°
grep "^TER" 1AKI_clean.pdb | wc -l   # é–æ•°</code></pre>
        </div>

        <h3>2.1.2 pdb2gmx ã«ã‚ˆã‚‹ãƒˆãƒãƒ­ã‚¸ãƒ¼ç”Ÿæˆ</h3>
        <p><code>pdb2gmx</code> ã¯GROMACSç‹¬è‡ªã®ã‚³ãƒãƒ³ãƒ‰ã§ã€PDBæ§‹é€ ã‹ã‚‰MDã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¿…è¦ãªãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>

        <h4>åŠ›å ´ã®é¸æŠ</h4>
        <p>ã‚¿ãƒ³ãƒ‘ã‚¯è³ªMDã§ã¯ä»¥ä¸‹ã®åŠ›å ´ãŒåºƒãä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ï¼š</p>
        <ul>
            <li><strong>AMBER99SB-ILDN</strong>ï¼šã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®å´é–ãƒ€ã‚¤ãƒŠãƒŸã‚¯ã‚¹ã«æœ€é©åŒ–</li>
            <li><strong>CHARMM36</strong>ï¼šã‚¿ãƒ³ãƒ‘ã‚¯è³ªãƒ»è„‚è³ªãƒ»æ ¸é…¸ã®çµ±ä¸€åŠ›å ´</li>
            <li><strong>OPLS-AA/L</strong>ï¼šå¹…åºƒã„æœ‰æ©Ÿåˆ†å­ã«å¯¾å¿œ</li>
        </ul>

        <pre><code class="language-bash"># pdb2gmxå®Ÿè¡Œï¼ˆAMBER99SB-ILDNåŠ›å ´ã‚’é¸æŠï¼‰
gmx pdb2gmx -f 1AKI_clean.pdb -o protein.gro -p topol.top -ignh -water tip3p <<EOF
6
1
EOF

# -f: å…¥åŠ›PDB
# -o: å‡ºåŠ›åº§æ¨™ï¼ˆGROå½¢å¼ï¼‰
# -p: ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«
# -ignh: PDBã®æ°´ç´ åŸå­ã‚’ç„¡è¦–ï¼ˆåŠ›å ´ã®æ°´ç´ é…ç½®ã‚’ä½¿ç”¨ï¼‰
# -water tip3p: æ°´ãƒ¢ãƒ‡ãƒ«ã®é¸æŠ
# 6: AMBER99SB-ILDN
# 1: TIP3Pæ°´ãƒ¢ãƒ‡ãƒ«</code></pre>

        <div class="info-box">
            <h4>ğŸ“˜ ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«</h4>
            <ul>
                <li><code>protein.gro</code>ï¼šæ°´ç´ åŸå­ã‚’å«ã‚€åº§æ¨™ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆGROãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰</li>
                <li><code>topol.top</code>ï¼šç³»å…¨ä½“ã®ãƒˆãƒãƒ­ã‚¸ãƒ¼ï¼ˆåŸå­ã‚¿ã‚¤ãƒ—ã€çµåˆã€è§’åº¦ã€äºŒé¢è§’ï¼‰</li>
                <li><code>posre.itp</code>ï¼šä½ç½®æ‹˜æŸãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå¹³è¡¡åŒ–æ™‚ã«ä½¿ç”¨ï¼‰</li>
            </ul>
        </div>

        <h3>2.1.3 ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ </h3>
        <p><code>topol.top</code> ã¯ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§æ§‹æˆã•ã‚Œã¾ã™ï¼š</p>

        <pre><code class="language-bash"># topol.topã®ä¸»è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³

[ moleculetype ]
; ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®åˆ†å­ã‚¿ã‚¤ãƒ—å®šç¾©
Protein_chain_A     3

[ atoms ]
; åŸå­ID  ã‚¿ã‚¤ãƒ—  æ®‹åŸºç•ªå·  æ®‹åŸºå  åŸå­å  é›»è·ã‚°ãƒ«ãƒ¼ãƒ—  é›»è·  è³ªé‡
     1      N3      1    MET      N     1  -0.3000  14.0067
     2       H      1    MET     H1     1   0.3300   1.0080
     ...

[ bonds ]
; çµåˆç›¸äº’ä½œç”¨ï¼ˆèª¿å’Œãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ï¼‰
; ai  aj  funct  b0(nm)  kb(kJ/mol/nm^2)
    1    2    1   0.1010  363171.2

[ pairs ]
; 1-4ç›¸äº’ä½œç”¨ï¼ˆLJ/ã‚¯ãƒ¼ãƒ­ãƒ³ã‚’ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰
    1    5    1

[ angles ]
; è§’åº¦ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«
; ai  aj  ak  funct  Î¸0(deg)  kÎ¸(kJ/mol/rad^2)
    1    2    3    1   109.50  292.88

[ dihedrals ]
; äºŒé¢è§’ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«
; ai  aj  ak  al  funct  Ï†(deg)  kÏ†(kJ/mol)  mult
    1    2    3    4    9    0.0     1.67     3

[ system ]
; ã‚·ã‚¹ãƒ†ãƒ å
Protein in water

[ molecules ]
; åˆ†å­å  æ•°
Protein_chain_A  1</code></pre>

        <h2>2.2 æº¶åª’å’Œ (Solvation)</h2>

        <h3>2.2.1 å‘¨æœŸå¢ƒç•Œç®±ã®å®šç¾©</h3>
        <p>MDã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯å‘¨æœŸå¢ƒç•Œæ¡ä»¶ï¼ˆPBCï¼‰ã‚’ä½¿ç”¨ã—ã€ç„¡é™ç³»ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ã€‚ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚’å«ã‚€ç®±ã‚’å®šç¾©ã—ã¾ã™ã€‚</p>

        <div class="mermaid">
        flowchart TD
            A[protein.gro] --> B[gmx editconf]
            B --> C{ç®±ã®å½¢çŠ¶é¸æŠ}
            C -->|ç«‹æ–¹ä½“| D[cubic box]
            C -->|è±å½¢åäºŒé¢ä½“| E[dodecahedron]
            C -->|å…«é¢ä½“| F[octahedron]
            D --> G[newbox.gro]
            E --> G
            F --> G
            G --> H[gmx solvate]
            H --> I[æº¶åª’å’Œç³»]

            style A fill:#e3f2fd
            style G fill:#e8f5e9
            style I fill:#fff3e0
        </div>

        <pre><code class="language-bash"># ç®±ã®å®šç¾©ï¼ˆè±å½¢åäºŒé¢ä½“ã€ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‹ã‚‰1.0 nmé›¢ã™ï¼‰
gmx editconf -f protein.gro -o newbox.gro -bt dodecahedron -d 1.0

# -bt: ç®±ã®ã‚¿ã‚¤ãƒ—ï¼ˆdodecahedronæ¨å¥¨ã€çƒå½¢ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã«æœ€é©ï¼‰
# -d: ã‚¿ãƒ³ãƒ‘ã‚¯è³ªè¡¨é¢ã‹ã‚‰ç®±ã®å£ã¾ã§ã®æœ€å°è·é›¢ï¼ˆnmï¼‰

# ç®±ã®å¤§ãã•ç¢ºèª
tail newbox.gro
#   5.16365   5.16365   3.65076  # ç®±ã®ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆnmï¼‰</code></pre>

        <div class="warning-box">
            <h4>âš ï¸ ç®±ã‚µã‚¤ã‚ºã®é¸æŠ</h4>
            <p>ç®±ã‚µã‚¤ã‚ºã¯ä»¥ä¸‹ã®åŸºæº–ã§æ±ºå®šã—ã¾ã™ï¼š</p>
            <ul>
                <li>ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‹ã‚‰æœ€ä½1.0 nmï¼ˆã§ãã‚Œã°1.2 nmä»¥ä¸Šï¼‰</li>
                <li>ã‚«ãƒƒãƒˆã‚ªãƒ•è·é›¢ã®2å€ä»¥ä¸Šï¼ˆ1.0 nm cutoffãªã‚‰2.0 nm boxï¼‰</li>
                <li>å°ã•ã™ãâ†’äººå·¥çš„ãªè‡ªå·±ç›¸äº’ä½œç”¨</li>
                <li>å¤§ãã™ãâ†’è¨ˆç®—ã‚³ã‚¹ãƒˆå¢—å¤§</li>
            </ul>
        </div>

        <h3>2.2.2 æ°´åˆ†å­ã®ä»˜åŠ </h3>
        <p><code>gmx solvate</code> ã§ç®±å†…ã«æ°´åˆ†å­ã‚’å……å¡«ã—ã¾ã™ã€‚</p>

        <pre><code class="language-bash"># æº¶åª’å’Œå®Ÿè¡Œï¼ˆTIP3Pæ°´ãƒ¢ãƒ‡ãƒ«ï¼‰
gmx solvate -cp newbox.gro -cs spc216.gro -o solvated.gro -p topol.top

# -cp: ã‚¿ãƒ³ãƒ‘ã‚¯è³ªåº§æ¨™
# -cs: æº¶åª’åº§æ¨™ï¼ˆspc216.groã¯GROMACSä»˜å±ã®TIP3På¹³è¡¡æ°´ï¼‰
# -o: å‡ºåŠ›åº§æ¨™
# -p: ãƒˆãƒãƒ­ã‚¸ãƒ¼æ›´æ–°ï¼ˆæ°´åˆ†å­æ•°ãŒè‡ªå‹•è¿½è¨˜ã•ã‚Œã‚‹ï¼‰

# å‡ºåŠ›ä¾‹ï¼š
# Generated solvent containing 10455 atoms</code></pre>

        <p>ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ« <code>topol.top</code> ã®æœ«å°¾ã«æ°´åˆ†å­ãŒè¿½åŠ ã•ã‚Œã¾ã™ï¼š</p>
        <pre><code>[ molecules ]
Protein_chain_A  1
SOL          3485  ; æ°´åˆ†å­æ•°ï¼ˆ3åŸå­ Ã— 3485 = 10455åŸå­ï¼‰</code></pre>

        <h3>2.2.3 æ°´ãƒ¢ãƒ‡ãƒ«ã®é¸æŠ</h3>
        <p>GROMACSã§åˆ©ç”¨å¯èƒ½ãªä¸»è¦ãªæ°´ãƒ¢ãƒ‡ãƒ«ï¼š</p>

        <table>
            <thead>
                <tr>
                    <th>æ°´ãƒ¢ãƒ‡ãƒ«</th>
                    <th>ã‚µã‚¤ãƒˆæ•°</th>
                    <th>ç‰¹å¾´</th>
                    <th>è¨ˆç®—ã‚³ã‚¹ãƒˆ</th>
                    <th>æ¨å¥¨ç”¨é€”</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>SPC</td>
                    <td>3</td>
                    <td>ã‚·ãƒ³ãƒ—ãƒ«ã€å¤å…¸çš„</td>
                    <td>ä½</td>
                    <td>ä¸€èˆ¬çš„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</td>
                </tr>
                <tr>
                    <td>SPC/E</td>
                    <td>3</td>
                    <td>SPCã®æ”¹è‰¯ç‰ˆ</td>
                    <td>ä½</td>
                    <td>å¯†åº¦ãƒ»æ‹¡æ•£ã®æ”¹å–„</td>
                </tr>
                <tr>
                    <td>TIP3P</td>
                    <td>3</td>
                    <td>AMBER/CHARMMæ¨™æº–</td>
                    <td>ä½</td>
                    <td>ã‚¿ãƒ³ãƒ‘ã‚¯è³ªMD</td>
                </tr>
                <tr>
                    <td>TIP4P</td>
                    <td>4</td>
                    <td>ä»®æƒ³ã‚µã‚¤ãƒˆè¿½åŠ </td>
                    <td>ä¸­</td>
                    <td>é«˜ç²¾åº¦è¨ˆç®—</td>
                </tr>
                <tr>
                    <td>TIP4P/2005</td>
                    <td>4</td>
                    <td>ç›¸å›³å†ç¾æ€§å‘ä¸Š</td>
                    <td>ä¸­</td>
                    <td>æ¶²ä½“ãƒ»æ°·ç•Œé¢</td>
                </tr>
                <tr>
                    <td>TIP5P</td>
                    <td>5</td>
                    <td>å­¤ç«‹é›»å­å¯¾è¡¨ç¾</td>
                    <td>é«˜</td>
                    <td>æ°´ç´ çµåˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</td>
                </tr>
            </tbody>
        </table>

        <h2>2.3 ã‚¤ã‚ªãƒ³ã®ä»˜åŠ ã¨é›»è·ä¸­æ€§åŒ–</h2>

        <h3>2.3.1 ç³»ã®é›»è·çŠ¶æ…‹ç¢ºèª</h3>
        <p>ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã¯é€šå¸¸ã€æ­£å‘³ã®é›»è·ã‚’æŒã¡ã¾ã™ï¼ˆpH 7ã§ã¯è² é›»è·ãŒå¤šã„ï¼‰ã€‚é•·è·é›¢é™é›»ç›¸äº’ä½œç”¨è¨ˆç®—ï¼ˆPMEï¼‰ã§ã¯ã€ç³»å…¨ä½“ã®é›»è·ãŒä¸­æ€§ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>

        <pre><code class="language-python">#!/usr/bin/env python3
"""
ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç³»ã®ç·é›»è·ã‚’è¨ˆç®—
"""
import sys

def calculate_total_charge(top_file):
    """
    topol.topãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç³»ã®ç·é›»è·ã‚’è¨ˆç®—

    Parameters:
    -----------
    top_file : str
        ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    """
    total_charge = 0.0
    in_atoms_section = False

    with open(top_file, 'r') as f:
        for line in f:
            # ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’é™¤å¤–
            line = line.split(';')[0].strip()
            if not line:
                continue

            # [ atoms ]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ¤œå‡º
            if line.startswith('[ atoms ]'):
                in_atoms_section = True
                continue

            # ä»–ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å…¥ã£ãŸã‚‰atomsèª­ã¿å–ã‚Šçµ‚äº†
            if in_atoms_section and line.startswith('['):
                in_atoms_section = False

            # atomsè¡Œã®å‡¦ç†
            if in_atoms_section:
                parts = line.split()
                if len(parts) >= 7:
                    try:
                        charge = float(parts[6])
                        total_charge += charge
                    except ValueError:
                        continue

    print(f"ç³»ã®ç·é›»è·: {total_charge:.3f} e")

    # ä¸­æ€§åŒ–ã«å¿…è¦ãªã‚¤ã‚ªãƒ³æ•°ã‚’è¨ˆç®—
    if total_charge > 0.1:
        n_cl = int(total_charge + 0.5)
        print(f"æ¨å¥¨: Cl- ã‚¤ã‚ªãƒ³ {n_cl} å€‹ã‚’è¿½åŠ ")
    elif total_charge < -0.1:
        n_na = int(-total_charge + 0.5)
        print(f"æ¨å¥¨: Na+ ã‚¤ã‚ªãƒ³ {n_na} å€‹ã‚’è¿½åŠ ")
    else:
        print("ç³»ã¯ã»ã¼ä¸­æ€§ã§ã™")

    return total_charge

if __name__ == '__main__':
    if len(sys.argv) != 2:
        print("Usage: python calc_charge.py topol.top")
        sys.exit(1)

    calculate_total_charge(sys.argv[1])</code></pre>

        <h3>2.3.2 genion ã«ã‚ˆã‚‹ä¸­æ€§åŒ–</h3>
        <p><code>gmx genion</code> ã§æ°´åˆ†å­ã‚’ã‚¤ã‚ªãƒ³ã«ç½®æ›ã—ã€é›»è·ä¸­æ€§åŒ–ã¨ã‚¤ã‚ªãƒ³æ¿ƒåº¦èª¿æ•´ã‚’è¡Œã„ã¾ã™ã€‚</p>

        <h4>å®Ÿè¡Œæ‰‹é †</h4>
        <pre><code class="language-bash"># 1. ã‚¨ãƒãƒ«ã‚®ãƒ¼æœ€å°åŒ–ç”¨ã®MDPãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆions.mdpï¼‰
cat > ions.mdp <<EOF
; ions.mdp - ã‚¤ã‚ªãƒ³é…ç½®ç”¨ã®ä»®MDPãƒ•ã‚¡ã‚¤ãƒ«
integrator  = steep
nsteps      = 0
EOF

# 2. tprãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆï¼ˆgenionã«ã¯tprãŒå¿…è¦ï¼‰
gmx grompp -f ions.mdp -c solvated.gro -p topol.top -o ions.tpr

# 3. ã‚¤ã‚ªãƒ³ä»˜åŠ å®Ÿè¡Œ
# -8é›»è·ã®ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚’ä¸­æ€§åŒ–ã™ã‚‹ä¾‹ï¼ˆNa+ 8å€‹è¿½åŠ ï¼‰
gmx genion -s ions.tpr -o solvated_ions.gro -p topol.top -pname NA -nname CL -neutral <<EOF
13
EOF

# -s: å…¥åŠ›tpr
# -o: å‡ºåŠ›åº§æ¨™
# -p: ãƒˆãƒãƒ­ã‚¸ãƒ¼æ›´æ–°
# -pname: é™½ã‚¤ã‚ªãƒ³åï¼ˆNA: Na+ï¼‰
# -nname: é™°ã‚¤ã‚ªãƒ³åï¼ˆCL: Cl-ï¼‰
# -neutral: ä¸­æ€§åŒ–ãƒ•ãƒ©ã‚°
# 13: SOLï¼ˆæ°´åˆ†å­ï¼‰ã‚’é¸æŠã—ã¦ã‚¤ã‚ªãƒ³ã«ç½®æ›

# ã‚¤ã‚ªãƒ³æ¿ƒåº¦æŒ‡å®šã®å ´åˆ
gmx genion -s ions.tpr -o solvated_ions.gro -p topol.top \\
    -pname NA -nname CL -neutral -conc 0.15 <<EOF
13
EOF
# -conc 0.15: 150 mM NaClæ¿ƒåº¦</code></pre>

        <div class="info-box">
            <h4>ğŸ“˜ ç”Ÿç†çš„ã‚¤ã‚ªãƒ³æ¿ƒåº¦</h4>
            <p>ç”Ÿä½“ç³»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ä»¥ä¸‹ã®æ¿ƒåº¦ãŒä¸€èˆ¬çš„ã§ã™ï¼š</p>
            <ul>
                <li><strong>150 mM NaCl</strong>ï¼šç”Ÿç†é£Ÿå¡©æ°´æ¿ƒåº¦ï¼ˆç´°èƒå¤–æ¶²ï¼‰</li>
                <li><strong>100 mM KCl</strong>ï¼šç´°èƒå†…æ¶²è¿‘ä¼¼</li>
                <li><strong>MgÂ²âº, CaÂ²âº</strong>ï¼šæ•° mMç¨‹åº¦ï¼ˆç‰¹å®šã®ç³»ã§è¿½åŠ ï¼‰</li>
            </ul>
        </div>

        <h3>2.3.3 ã‚¤ã‚ªãƒ³é…ç½®ã®æ¤œè¨¼</h3>
        <pre><code class="language-python">#!/usr/bin/env python3
"""
ã‚¤ã‚ªãƒ³é…ç½®ã®æ¤œè¨¼ - ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã¨ã®è·é›¢åˆ†å¸ƒ
"""
import MDAnalysis as mda
import numpy as np
import matplotlib.pyplot as plt

def analyze_ion_distribution(gro_file):
    """
    ã‚¤ã‚ªãƒ³ã¨ã‚¿ãƒ³ãƒ‘ã‚¯è³ªé–“ã®è·é›¢åˆ†å¸ƒã‚’è§£æ

    Parameters:
    -----------
    gro_file : str
        ã‚¤ã‚ªãƒ³ã‚’å«ã‚€GROãƒ•ã‚¡ã‚¤ãƒ«
    """
    u = mda.Universe(gro_file)

    # ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã€ã‚¤ã‚ªãƒ³ã®é¸æŠ
    protein = u.select_atoms('protein')
    na_ions = u.select_atoms('name NA')
    cl_ions = u.select_atoms('name CL')

    print(f"Na+ ã‚¤ã‚ªãƒ³æ•°: {len(na_ions)}")
    print(f"Cl- ã‚¤ã‚ªãƒ³æ•°: {len(cl_ions)}")

    # ã‚¿ãƒ³ãƒ‘ã‚¯è³ªé‡å¿ƒ
    protein_center = protein.center_of_mass()

    # ã‚¤ã‚ªãƒ³ã¨ã®è·é›¢è¨ˆç®—
    na_distances = []
    for ion in na_ions:
        dist = np.linalg.norm(ion.position - protein_center)
        na_distances.append(dist / 10.0)  # Ã… â†’ nm

    cl_distances = []
    for ion in cl_ions:
        dist = np.linalg.norm(ion.position - protein_center)
        cl_distances.append(dist / 10.0)

    # ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ä½œæˆ
    plt.figure(figsize=(10, 6))
    plt.hist(na_distances, bins=20, alpha=0.5, label='Na+', color='blue')
    plt.hist(cl_distances, bins=20, alpha=0.5, label='Cl-', color='red')
    plt.xlabel('Distance from protein center (nm)')
    plt.ylabel('Number of ions')
    plt.title('Ion Distribution around Protein')
    plt.legend()
    plt.grid(True, alpha=0.3)
    plt.savefig('ion_distribution.png', dpi=300, bbox_inches='tight')
    print("âœ… ã‚¤ã‚ªãƒ³åˆ†å¸ƒå›³: ion_distribution.png")

    # çµ±è¨ˆ
    print(f"\nNa+ å¹³å‡è·é›¢: {np.mean(na_distances):.2f} nm")
    print(f"Cl- å¹³å‡è·é›¢: {np.mean(cl_distances):.2f} nm")
    print(f"Na+ æœ€å°è·é›¢: {np.min(na_distances):.2f} nm")
    print(f"Cl- æœ€å°è·é›¢: {np.min(cl_distances):.2f} nm")

if __name__ == '__main__':
    import sys
    if len(sys.argv) != 2:
        print("Usage: python analyze_ions.py solvated_ions.gro")
        sys.exit(1)

    analyze_ion_distribution(sys.argv[1])</code></pre>

        <h2>2.4 ãƒˆãƒãƒ­ã‚¸ãƒ¼ã®æ¤œè¨¼</h2>

        <h3>2.4.1 gmx check ã«ã‚ˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ç¢ºèª</h3>
        <pre><code class="language-bash"># GROãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ç¢ºèª
gmx check -f solvated_ions.gro

# å‡ºåŠ›ä¾‹ï¼š
# Item        #atoms  #coords
# solvated_ions.gro    10463    10463

# ãƒˆãƒãƒ­ã‚¸ãƒ¼ã¨ã®ä¸€è‡´ç¢ºèª
echo "Protein_chain_A" | gmx make_ndx -f solvated_ions.gro -o index.ndx

# åŸå­æ•°ã‚«ã‚¦ãƒ³ãƒˆ
grep "^ATOM" protein.gro | wc -l  # ã‚¿ãƒ³ãƒ‘ã‚¯è³ªåŸå­æ•°
tail -2 solvated_ions.gro | head -1 | awk '{print $1}'  # ç·åŸå­æ•°</code></pre>

        <h3>2.4.2 ãƒˆãƒãƒ­ã‚¸ãƒ¼å†…å®¹ã®å¯è¦–åŒ–</h3>
        <pre><code class="language-python">#!/usr/bin/env python3
"""
ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
"""
import re

def analyze_topology(top_file):
    """
    topol.topãƒ•ã‚¡ã‚¤ãƒ«ã®çµ±è¨ˆæƒ…å ±ã‚’é›†è¨ˆ

    Parameters:
    -----------
    top_file : str
        ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    """
    stats = {
        'atoms': 0,
        'bonds': 0,
        'pairs': 0,
        'angles': 0,
        'dihedrals': 0,
        'impropers': 0
    }

    current_section = None

    with open(top_file, 'r') as f:
        for line in f:
            line = line.split(';')[0].strip()
            if not line:
                continue

            # ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡º
            if line.startswith('['):
                match = re.search(r'\[\s*(\w+)\s*\]', line)
                if match:
                    current_section = match.group(1)
                continue

            # ãƒ‡ãƒ¼ã‚¿è¡Œã®ã‚«ã‚¦ãƒ³ãƒˆ
            if current_section in stats:
                # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–è¡Œã§ãªã‘ã‚Œã°ã‚«ã‚¦ãƒ³ãƒˆ
                if not line.startswith('#') and not line.startswith('['):
                    stats[current_section] += 1

    print("=" * 50)
    print("ãƒˆãƒãƒ­ã‚¸ãƒ¼çµ±è¨ˆ")
    print("=" * 50)
    print(f"åŸå­æ•°:           {stats['atoms']:>6}")
    print(f"çµåˆæ•°:           {stats['bonds']:>6}")
    print(f"1-4ãƒšã‚¢:          {stats['pairs']:>6}")
    print(f"è§’åº¦æ•°:           {stats['angles']:>6}")
    print(f"äºŒé¢è§’æ•°:         {stats['dihedrals']:>6}")
    print(f"ç•°å¸¸äºŒé¢è§’æ•°:     {stats['impropers']:>6}")
    print("=" * 50)

    # å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
    print("\nå¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯:")
    # çµŒé¨“å‰‡ï¼šåŸå­æ•° N ã«å¯¾ã—ã¦
    # çµåˆ â‰ˆ N, è§’åº¦ â‰ˆ 2N, äºŒé¢è§’ â‰ˆ 3N
    n_atoms = stats['atoms']
    if n_atoms > 0:
        bond_ratio = stats['bonds'] / n_atoms
        angle_ratio = stats['angles'] / n_atoms
        dihedral_ratio = stats['dihedrals'] / n_atoms

        print(f"  çµåˆ/åŸå­æ¯”:   {bond_ratio:.2f} (æœŸå¾…å€¤: ~1.0)")
        print(f"  è§’åº¦/åŸå­æ¯”:   {angle_ratio:.2f} (æœŸå¾…å€¤: ~2.0)")
        print(f"  äºŒé¢è§’/åŸå­æ¯”: {dihedral_ratio:.2f} (æœŸå¾…å€¤: ~3.0)")

        if 0.8 < bond_ratio < 1.2:
            print("  âœ… çµåˆæ•°ã¯å¦¥å½“ã§ã™")
        else:
            print("  âš ï¸  çµåˆæ•°ãŒç•°å¸¸ã§ã™")

if __name__ == '__main__':
    import sys
    if len(sys.argv) != 2:
        print("Usage: python analyze_topology.py topol.top")
        sys.exit(1)

    analyze_topology(sys.argv[1])</code></pre>

        <h2>2.5 åº§æ¨™ãƒ•ã‚¡ã‚¤ãƒ«ã®å¯è¦–åŒ–</h2>

        <h3>2.5.1 VMD ã«ã‚ˆã‚‹å¯è¦–åŒ–</h3>
        <pre><code class="language-bash"># VMDã§å¯è¦–åŒ–
vmd solvated_ions.gro

# VMD Tclã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è‡ªå‹•ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
cat > visualize.tcl <<'EOF'
# ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®ã¿è¡¨ç¤º
mol delrep 0 top
mol representation NewCartoon
mol color Structure
mol selection {protein}
mol addrep top

# æ°´åˆ†å­ï¼ˆåŠé€æ˜ï¼‰
mol representation Lines
mol color Name
mol selection {resname SOL and within 5 of protein}
mol material Transparent
mol addrep top

# ã‚¤ã‚ªãƒ³ï¼ˆçƒä½“ï¼‰
mol representation VDW 1.0 12.0
mol color Name
mol selection {name NA CL}
mol addrep top

# è¦–ç‚¹è¨­å®š
display resetview
rotate x by 90
scale by 1.2

# ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
render TachyonInternal protein_solvated.tga
quit
EOF

# å®Ÿè¡Œ
vmd -dispdev text -e visualize.tcl</code></pre>

        <h3>2.5.2 PyMOL ã«ã‚ˆã‚‹å¯è¦–åŒ–</h3>
        <pre><code class="language-python">#!/usr/bin/env python3
"""
PyMOLã§ã‚¿ãƒ³ãƒ‘ã‚¯è³ª-æº¶åª’ç³»ã‚’å¯è¦–åŒ–
"""
import pymol
from pymol import cmd

def visualize_solvated_system(gro_file, output_png='system.png'):
    """
    PyMOLã§æº¶åª’å’Œç³»ã‚’å¯è¦–åŒ–ã—ã¦ç”»åƒä¿å­˜

    Parameters:
    -----------
    gro_file : str
        GROãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    output_png : str
        å‡ºåŠ›ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å
    """
    # PyMOLèµ·å‹•
    pymol.finish_launching()

    # æ§‹é€ èª­ã¿è¾¼ã¿
    cmd.load(gro_file, 'system')

    # ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®è¡¨ç¤º
    cmd.select('prot', 'resn ALA+ARG+ASN+ASP+CYS+GLN+GLU+GLY+HIS+ILE+LEU+LYS+MET+PHE+PRO+SER+THR+TRP+TYR+VAL')
    cmd.show('cartoon', 'prot')
    cmd.color('cyan', 'prot')

    # è¿‘å‚ã®æ°´åˆ†å­ã®ã¿è¡¨ç¤ºï¼ˆ5Ã…ä»¥å†…ï¼‰
    cmd.select('nearby_water', 'resn SOL and (prot around 5)')
    cmd.show('lines', 'nearby_water')
    cmd.color('red', 'nearby_water and name O*')
    cmd.color('white', 'nearby_water and name H*')

    # ã‚¤ã‚ªãƒ³ã®è¡¨ç¤º
    cmd.select('ions', 'name NA CL')
    cmd.show('spheres', 'ions')
    cmd.color('blue', 'name NA')
    cmd.color('green', 'name CL')
    cmd.set('sphere_scale', 0.5, 'ions')

    # èƒŒæ™¯ãƒ»è¦–ç‚¹è¨­å®š
    cmd.bg_color('white')
    cmd.set('ray_opaque_background', 0)
    cmd.orient('prot')
    cmd.zoom('prot', 5)

    # ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    cmd.ray(1920, 1080)
    cmd.png(output_png, dpi=300)

    print(f"âœ… ç”»åƒä¿å­˜: {output_png}")

if __name__ == '__main__':
    import sys
    if len(sys.argv) != 2:
        print("Usage: python visualize_pymol.py solvated_ions.gro")
        sys.exit(1)

    visualize_solvated_system(sys.argv[1])</code></pre>

        <h2>æ¼”ç¿’å•é¡Œ</h2>

        <div class="exercise-box">
            <h3>Exercise 2-1: PDBã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã¨æº¶åª’å’Œç³»æ§‹ç¯‰ï¼ˆé›£æ˜“åº¦ï¼šEasyï¼‰</h3>
            <p><strong>èª²é¡Œ</strong>ï¼šPDB ID 1UBQï¼ˆãƒ¦ãƒ“ã‚­ãƒãƒ³ã€76æ®‹åŸºï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€GROMACSç”¨ã®æº¶åª’å’Œç³»ã‚’æ§‹ç¯‰ã›ã‚ˆã€‚</p>

            <h4>å®Ÿè¡Œæ‰‹é †</h4>
            <ol>
                <li>PDBãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°</li>
                <li>pdb2gmxã§ãƒˆãƒãƒ­ã‚¸ãƒ¼ç”Ÿæˆï¼ˆAMBER99SB-ILDNã€TIP3Pï¼‰</li>
                <li>ç«‹æ–¹ä½“ç®±ã®ä½œæˆï¼ˆã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‹ã‚‰1.0 nmï¼‰</li>
                <li>æº¶åª’å’Œã¨ã‚¤ã‚ªãƒ³ä»˜åŠ ï¼ˆ150 mM NaClï¼‰</li>
                <li>æœ€çµ‚çš„ãªåŸå­æ•°ã¨ã‚¤ã‚ªãƒ³æ•°ã®å ±å‘Š</li>
            </ol>

            <details>
                <summary>è§£ç­”ä¾‹ã‚’è¡¨ç¤º</summary>
                <pre><code class="language-bash">#!/bin/bash
# Exercise 2-1 è§£ç­”ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

# 1. PDBãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
wget https://files.rcsb.org/download/1UBQ.pdb

# 2. ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆBiopythonãŒå¿…è¦ï¼‰
python <<EOF
from Bio import PDB
parser = PDB.PDBParser(QUIET=True)
structure = parser.get_structure('ubq', '1UBQ.pdb')
io = PDB.PDBIO()
io.set_structure(structure)

class ProteinSelect(PDB.Select):
    def accept_residue(self, residue):
        return residue.id[0] == ' '  # ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®ã¿

io.save('1UBQ_clean.pdb', ProteinSelect())
print("âœ… ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Œäº†")
EOF

# 3. ãƒˆãƒãƒ­ã‚¸ãƒ¼ç”Ÿæˆ
gmx pdb2gmx -f 1UBQ_clean.pdb -o ubq.gro -p topol.top -ignh -water tip3p <<EOF
6
1
EOF

# 4. ç®±ã®ä½œæˆï¼ˆç«‹æ–¹ä½“ã€1.0 nmè·é›¢ï¼‰
gmx editconf -f ubq.gro -o newbox.gro -bt cubic -d 1.0

# 5. æº¶åª’å’Œ
gmx solvate -cp newbox.gro -cs spc216.gro -o solvated.gro -p topol.top

# 6. ã‚¤ã‚ªãƒ³ä»˜åŠ ç”¨tprä½œæˆ
cat > ions.mdp <<EOF
integrator = steep
nsteps = 0
EOF

gmx grompp -f ions.mdp -c solvated.gro -p topol.top -o ions.tpr -maxwarn 1

# 7. ã‚¤ã‚ªãƒ³ä»˜åŠ ï¼ˆ150 mM NaClã€ä¸­æ€§åŒ–ï¼‰
gmx genion -s ions.tpr -o solvated_ions.gro -p topol.top \\
    -pname NA -nname CL -neutral -conc 0.15 <<EOF
13
EOF

# 8. çµæœå ±å‘Š
echo "=== æœ€çµ‚ç³»ã®çµ±è¨ˆ ==="
total_atoms=$(tail -2 solvated_ions.gro | head -1 | awk '{print $1}')
n_na=$(grep "^ATOM" solvated_ions.gro | grep " NA " | wc -l)
n_cl=$(grep "^ATOM" solvated_ions.gro | grep " CL " | wc -l)

echo "ç·åŸå­æ•°: $total_atoms"
echo "Na+ ã‚¤ã‚ªãƒ³: $n_na"
echo "Cl- ã‚¤ã‚ªãƒ³: $n_cl"
echo "âœ… æ¼”ç¿’å•é¡Œå®Œäº†"</code></pre>

                <p><strong>æœŸå¾…ã•ã‚Œã‚‹çµæœ</strong>ï¼š</p>
                <ul>
                    <li>ç·åŸå­æ•°: ~15,000-20,000ï¼ˆç®±ã‚µã‚¤ã‚ºã«ã‚ˆã‚Šå¤‰å‹•ï¼‰</li>
                    <li>Na+ ã‚¤ã‚ªãƒ³: 20-30å€‹ç¨‹åº¦</li>
                    <li>Cl- ã‚¤ã‚ªãƒ³: 20-30å€‹ç¨‹åº¦ï¼ˆä¸­æ€§åŒ– + 150 mMï¼‰</li>
                    <li>ã‚¿ãƒ³ãƒ‘ã‚¯è³ªåŸå­æ•°: 1231ï¼ˆ76æ®‹åŸº Ã— ç´„16åŸå­/æ®‹åŸºï¼‰</li>
                </ul>
            </details>
        </div>

        <div class="exercise-box">
            <h3>Exercise 2-2: ã‚¤ã‚ªãƒ³é…ç½®ã®æœ€é©æ€§æ¤œè¨¼ï¼ˆé›£æ˜“åº¦ï¼šMediumï¼‰</h3>
            <p><strong>èª²é¡Œ</strong>ï¼šExercise 2-1ã§ä½œæˆã—ãŸç³»ã«ã¤ã„ã¦ã€ã‚¤ã‚ªãƒ³é…ç½®ãŒé©åˆ‡ã‹ã‚’å®šé‡çš„ã«æ¤œè¨¼ã›ã‚ˆã€‚</p>

            <h4>æ¤œè¨¼é …ç›®</h4>
            <ol>
                <li>ã‚¿ãƒ³ãƒ‘ã‚¯è³ªè¡¨é¢ã®é›»è·åˆ†å¸ƒï¼ˆæ­£è² ã®åã‚Šï¼‰</li>
                <li>ã‚¤ã‚ªãƒ³-ã‚¿ãƒ³ãƒ‘ã‚¯è³ªé–“ã®æœ€å°è·é›¢ï¼ˆè¡çªãƒã‚§ãƒƒã‚¯ï¼‰</li>
                <li>ã‚¤ã‚ªãƒ³ã®ç©ºé–“åˆ†å¸ƒï¼ˆã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°æœ‰ç„¡ï¼‰</li>
                <li>é›»è·ä¸­æ€§åŒ–ã®é”æˆç¢ºèª</li>
            </ol>

            <details>
                <summary>è§£ç­”ä¾‹ã‚’è¡¨ç¤º</summary>
                <pre><code class="language-python">#!/usr/bin/env python3
"""
Exercise 2-2 è§£ç­”ï¼šã‚¤ã‚ªãƒ³é…ç½®ã®æ¤œè¨¼
"""
import MDAnalysis as mda
import numpy as np
import matplotlib.pyplot as plt
from scipy.spatial.distance import pdist, squareform

def verify_ion_placement(gro_file, top_file):
    """
    ã‚¤ã‚ªãƒ³é…ç½®ã®æœ€é©æ€§ã‚’å¤šè§’çš„ã«æ¤œè¨¼
    """
    u = mda.Universe(gro_file)

    protein = u.select_atoms('protein')
    na_ions = u.select_atoms('name NA')
    cl_ions = u.select_atoms('name CL')

    print("=" * 60)
    print("ã‚¤ã‚ªãƒ³é…ç½®æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ")
    print("=" * 60)

    # 1. ã‚¿ãƒ³ãƒ‘ã‚¯è³ªè¡¨é¢ã®é›»è·åˆ†å¸ƒ
    print("\nã€1. ã‚¿ãƒ³ãƒ‘ã‚¯è³ªè¡¨é¢ã®é›»è·åˆ†å¸ƒã€‘")
    charged_residues = {
        'ARG': +1, 'LYS': +1, 'HIS': +0.5,  # æ­£é›»è·
        'ASP': -1, 'GLU': -1                 # è² é›»è·
    }

    total_protein_charge = 0
    for residue in protein.residues:
        resname = residue.resname
        if resname in charged_residues:
            total_protein_charge += charged_residues[resname]

    print(f"ã‚¿ãƒ³ãƒ‘ã‚¯è³ªç†è«–é›»è·: {total_protein_charge:+.1f} e")
    print(f"Na+ ã‚¤ã‚ªãƒ³æ•°: {len(na_ions)}")
    print(f"Cl- ã‚¤ã‚ªãƒ³æ•°: {len(cl_ions)}")

    net_charge = total_protein_charge + len(na_ions) - len(cl_ions)
    print(f"ç³»ã®ç·é›»è·: {net_charge:+.1f} e")

    if abs(net_charge) < 0.5:
        print("âœ… é›»è·ä¸­æ€§åŒ–é”æˆ")
    else:
        print("âš ï¸  é›»è·ãŒä¸­æ€§ã§ã¯ã‚ã‚Šã¾ã›ã‚“")

    # 2. ã‚¤ã‚ªãƒ³-ã‚¿ãƒ³ãƒ‘ã‚¯è³ªé–“ã®æœ€å°è·é›¢
    print("\nã€2. ã‚¤ã‚ªãƒ³-ã‚¿ãƒ³ãƒ‘ã‚¯è³ªé–“è·é›¢ã€‘")
    protein_positions = protein.positions

    min_dist_na = float('inf')
    for ion in na_ions:
        distances = np.linalg.norm(protein_positions - ion.position, axis=1)
        min_dist_na = min(min_dist_na, np.min(distances))

    min_dist_cl = float('inf')
    for ion in cl_ions:
        distances = np.linalg.norm(protein_positions - ion.position, axis=1)
        min_dist_cl = min(min_dist_cl, np.min(distances))

    min_dist_na /= 10.0  # Ã… â†’ nm
    min_dist_cl /= 10.0

    print(f"Na+ æœ€å°è·é›¢: {min_dist_na:.2f} nm")
    print(f"Cl- æœ€å°è·é›¢: {min_dist_cl:.2f} nm")

    if min_dist_na > 0.2 and min_dist_cl > 0.2:
        print("âœ… ã‚¤ã‚ªãƒ³ã¯é©åˆ‡ãªè·é›¢ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã™")
    else:
        print("âš ï¸  ã‚¤ã‚ªãƒ³ãŒã‚¿ãƒ³ãƒ‘ã‚¯è³ªã«è¿‘ã™ãã¾ã™ï¼ˆ< 0.2 nmï¼‰")

    # 3. ã‚¤ã‚ªãƒ³ã®ç©ºé–“åˆ†å¸ƒï¼ˆã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°æ¤œå‡ºï¼‰
    print("\nã€3. ã‚¤ã‚ªãƒ³ç©ºé–“åˆ†å¸ƒã€‘")

    # Na+ã‚¤ã‚ªãƒ³é–“è·é›¢
    if len(na_ions) > 1:
        na_positions = na_ions.positions / 10.0  # Ã… â†’ nm
        na_dists = pdist(na_positions)
        na_min_dist = np.min(na_dists)
        na_mean_dist = np.mean(na_dists)
        print(f"Na+ æœ€å°é–“è·é›¢: {na_min_dist:.2f} nm")
        print(f"Na+ å¹³å‡é–“è·é›¢: {na_mean_dist:.2f} nm")

        if na_min_dist < 0.5:
            print("âš ï¸  Na+ ã‚¤ã‚ªãƒ³ãŒã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹å¯èƒ½æ€§")

    # Cl-ã‚¤ã‚ªãƒ³é–“è·é›¢
    if len(cl_ions) > 1:
        cl_positions = cl_ions.positions / 10.0
        cl_dists = pdist(cl_positions)
        cl_min_dist = np.min(cl_dists)
        cl_mean_dist = np.mean(cl_dists)
        print(f"Cl- æœ€å°é–“è·é›¢: {cl_min_dist:.2f} nm")
        print(f"Cl- å¹³å‡é–“è·é›¢: {cl_mean_dist:.2f} nm")

        if cl_min_dist < 0.5:
            print("âš ï¸  Cl- ã‚¤ã‚ªãƒ³ãŒã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹å¯èƒ½æ€§")

    # 4. å‹•å¾„åˆ†å¸ƒé–¢æ•°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    print("\nã€4. ã‚¤ã‚ªãƒ³-ã‚¿ãƒ³ãƒ‘ã‚¯è³ªå‹•å¾„åˆ†å¸ƒã€‘")
    protein_center = protein.center_of_mass()

    na_radii = [np.linalg.norm(ion.position - protein_center) / 10.0
                for ion in na_ions]
    cl_radii = [np.linalg.norm(ion.position - protein_center) / 10.0
                for ion in cl_ions]

    plt.figure(figsize=(12, 5))

    plt.subplot(1, 2, 1)
    plt.hist(na_radii, bins=15, alpha=0.7, color='blue', edgecolor='black')
    plt.xlabel('Distance from protein COM (nm)')
    plt.ylabel('Count')
    plt.title('Na+ Distribution')
    plt.grid(True, alpha=0.3)

    plt.subplot(1, 2, 2)
    plt.hist(cl_radii, bins=15, alpha=0.7, color='red', edgecolor='black')
    plt.xlabel('Distance from protein COM (nm)')
    plt.ylabel('Count')
    plt.title('Cl- Distribution')
    plt.grid(True, alpha=0.3)

    plt.tight_layout()
    plt.savefig('ion_verification.png', dpi=300, bbox_inches='tight')
    print("âœ… åˆ†å¸ƒå›³ä¿å­˜: ion_verification.png")

    print("\n" + "=" * 60)
    print("æ¤œè¨¼å®Œäº†")
    print("=" * 60)

if __name__ == '__main__':
    import sys
    if len(sys.argv) != 3:
        print("Usage: python verify_ions.py solvated_ions.gro topol.top")
        sys.exit(1)

    verify_ion_placement(sys.argv[1], sys.argv[2])</code></pre>

                <p><strong>æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›</strong>ï¼š</p>
                <ul>
                    <li>ç³»ã®ç·é›»è·: 0 Â± 0.5 eï¼ˆä¸­æ€§åŒ–é”æˆï¼‰</li>
                    <li>ã‚¤ã‚ªãƒ³-ã‚¿ãƒ³ãƒ‘ã‚¯è³ªæœ€å°è·é›¢: > 0.2 nmï¼ˆè¡çªãªã—ï¼‰</li>
                    <li>ã‚¤ã‚ªãƒ³é–“æœ€å°è·é›¢: > 0.5 nmï¼ˆã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ãªã—ï¼‰</li>
                    <li>å‹•å¾„åˆ†å¸ƒå›³ã§å‡ä¸€ãªåˆ†å¸ƒç¢ºèª</li>
                </ul>
            </details>
        </div>

        <div class="exercise-box">
            <h3>Exercise 2-3: å¤§è¦æ¨¡ç³»ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è‡ªå‹•åŒ–ï¼ˆé›£æ˜“åº¦ï¼šHardï¼‰</h3>
            <p><strong>èª²é¡Œ</strong>ï¼šè¤‡æ•°ã®ã‚¿ãƒ³ãƒ‘ã‚¯è³ªæ§‹é€ ï¼ˆä¾‹ï¼šPDB IDãƒªã‚¹ãƒˆï¼‰ã«å¯¾ã—ã¦ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è‡ªå‹•å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã›ã‚ˆã€‚</p>

            <h4>è¦ä»¶</h4>
            <ul>
                <li>PDBãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã€ãƒˆãƒãƒ­ã‚¸ãƒ¼ç”Ÿæˆã‚’è‡ªå‹•åŒ–</li>
                <li>ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚µã‚¤ã‚ºã«å¿œã˜ã¦ç®±ã‚µã‚¤ã‚ºã‚’è‡ªå‹•æ±ºå®š</li>
                <li>ä¸¦åˆ—å‡¦ç†ã§ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Š</li>
                <li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨è©³ç´°ãƒ­ã‚°å‡ºåŠ›</li>
                <li>æœ€çµ‚çš„ãªçµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆï¼ˆCSVå½¢å¼ï¼‰</li>
            </ul>

            <details>
                <summary>è§£ç­”ä¾‹ã‚’è¡¨ç¤º</summary>
                <pre><code class="language-python">#!/usr/bin/env python3
"""
Exercise 2-3 è§£ç­”ï¼šå¤§è¦æ¨¡ç³»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è‡ªå‹•åŒ–
"""
import os
import sys
import subprocess
import urllib.request
from pathlib import Path
import multiprocessing as mp
from datetime import datetime
import csv

class GROMACSSetupPipeline:
    """
    GROMACSç³»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®è‡ªå‹•åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
    """
    def __init__(self, pdb_list, output_dir='gromacs_systems',
                 forcefield=6, water=1, box_margin=1.0, ion_conc=0.15):
        """
        Parameters:
        -----------
        pdb_list : list of str
            PDB IDã®ãƒªã‚¹ãƒˆï¼ˆä¾‹: ['1UBQ', '1AKI', '2LYZ']ï¼‰
        output_dir : str
            å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        forcefield : int
            pdb2gmxåŠ›å ´ç•ªå·ï¼ˆ6: AMBER99SB-ILDNï¼‰
        water : int
            æ°´ãƒ¢ãƒ‡ãƒ«ç•ªå·ï¼ˆ1: TIP3Pï¼‰
        box_margin : float
            ç®±ã®ä½™ç™½ï¼ˆnmï¼‰
        ion_conc : float
            ã‚¤ã‚ªãƒ³æ¿ƒåº¦ï¼ˆMï¼‰
        """
        self.pdb_list = pdb_list
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)

        self.forcefield = forcefield
        self.water = water
        self.box_margin = box_margin
        self.ion_conc = ion_conc

        self.results = []

    def download_pdb(self, pdb_id, work_dir):
        """PDBãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"""
        url = f"https://files.rcsb.org/download/{pdb_id}.pdb"
        pdb_file = work_dir / f"{pdb_id}.pdb"

        try:
            urllib.request.urlretrieve(url, pdb_file)
            return pdb_file
        except Exception as e:
            raise RuntimeError(f"PDBãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—: {e}")

    def clean_pdb(self, pdb_file, work_dir):
        """PDBãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®ã¿æŠ½å‡ºï¼‰"""
        from Bio import PDB

        clean_file = work_dir / f"{pdb_file.stem}_clean.pdb"

        try:
            parser = PDB.PDBParser(QUIET=True)
            structure = parser.get_structure('protein', pdb_file)

            io = PDB.PDBIO()
            io.set_structure(structure)

            class ProteinSelect(PDB.Select):
                def accept_residue(self, residue):
                    return residue.id[0] == ' '

            io.save(str(clean_file), ProteinSelect())
            return clean_file
        except Exception as e:
            raise RuntimeError(f"PDBã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å¤±æ•—: {e}")

    def run_pdb2gmx(self, pdb_file, work_dir):
        """pdb2gmxã§ãƒˆãƒãƒ­ã‚¸ãƒ¼ç”Ÿæˆ"""
        cmd = [
            'gmx', 'pdb2gmx',
            '-f', str(pdb_file),
            '-o', str(work_dir / 'protein.gro'),
            '-p', str(work_dir / 'topol.top'),
            '-ignh',
            '-water', 'tip3p'
        ]

        input_str = f"{self.forcefield}\\n{self.water}\\n"

        try:
            result = subprocess.run(cmd, input=input_str.encode(),
                                    capture_output=True, check=True)
            return work_dir / 'protein.gro', work_dir / 'topol.top'
        except subprocess.CalledProcessError as e:
            raise RuntimeError(f"pdb2gmxå¤±æ•—: {e.stderr.decode()}")

    def create_box(self, gro_file, work_dir):
        """ç®±ã®ä½œæˆï¼ˆè±å½¢åäºŒé¢ä½“ï¼‰"""
        cmd = [
            'gmx', 'editconf',
            '-f', str(gro_file),
            '-o', str(work_dir / 'newbox.gro'),
            '-bt', 'dodecahedron',
            '-d', str(self.box_margin)
        ]

        try:
            subprocess.run(cmd, check=True, capture_output=True)
            return work_dir / 'newbox.gro'
        except subprocess.CalledProcessError as e:
            raise RuntimeError(f"editconfå¤±æ•—: {e.stderr.decode()}")

    def solvate(self, gro_file, top_file, work_dir):
        """æº¶åª’å’Œ"""
        cmd = [
            'gmx', 'solvate',
            '-cp', str(gro_file),
            '-cs', 'spc216.gro',
            '-o', str(work_dir / 'solvated.gro'),
            '-p', str(top_file)
        ]

        try:
            subprocess.run(cmd, check=True, capture_output=True)
            return work_dir / 'solvated.gro'
        except subprocess.CalledProcessError as e:
            raise RuntimeError(f"solvateå¤±æ•—: {e.stderr.decode()}")

    def add_ions(self, gro_file, top_file, work_dir):
        """ã‚¤ã‚ªãƒ³ä»˜åŠ """
        # 1. ions.mdpä½œæˆ
        mdp_file = work_dir / 'ions.mdp'
        with open(mdp_file, 'w') as f:
            f.write("integrator = steep\\nnsteps = 0\\n")

        # 2. grompp
        tpr_file = work_dir / 'ions.tpr'
        cmd_grompp = [
            'gmx', 'grompp',
            '-f', str(mdp_file),
            '-c', str(gro_file),
            '-p', str(top_file),
            '-o', str(tpr_file),
            '-maxwarn', '1'
        ]

        try:
            subprocess.run(cmd_grompp, check=True, capture_output=True)
        except subprocess.CalledProcessError as e:
            raise RuntimeError(f"gromppå¤±æ•—: {e.stderr.decode()}")

        # 3. genion
        output_gro = work_dir / 'solvated_ions.gro'
        cmd_genion = [
            'gmx', 'genion',
            '-s', str(tpr_file),
            '-o', str(output_gro),
            '-p', str(top_file),
            '-pname', 'NA',
            '-nname', 'CL',
            '-neutral',
            '-conc', str(self.ion_conc)
        ]

        try:
            # SOLé¸æŠï¼ˆ13ï¼‰
            result = subprocess.run(cmd_genion, input=b'13\\n',
                                    capture_output=True, check=True)
            return output_gro
        except subprocess.CalledProcessError as e:
            raise RuntimeError(f"genionå¤±æ•—: {e.stderr.decode()}")

    def count_statistics(self, gro_file):
        """ç³»ã®çµ±è¨ˆæƒ…å ±ã‚’é›†è¨ˆ"""
        stats = {}

        with open(gro_file, 'r') as f:
            lines = f.readlines()
            # GROãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š2è¡Œç›®ãŒç·åŸå­æ•°
            stats['total_atoms'] = int(lines[1].strip())

            # ã‚¤ã‚ªãƒ³æ•°ã‚«ã‚¦ãƒ³ãƒˆ
            na_count = sum(1 for line in lines if ' NA ' in line)
            cl_count = sum(1 for line in lines if ' CL ' in line)
            stats['na_ions'] = na_count
            stats['cl_ions'] = cl_count

            # æ°´åˆ†å­æ•°ï¼ˆç·åŸå­ - ã‚¿ãƒ³ãƒ‘ã‚¯è³ª - ã‚¤ã‚ªãƒ³ï¼‰/ 3
            protein_atoms = sum(1 for line in lines
                                if line.startswith('    1') and 'SOL' not in line
                                and 'NA' not in line and 'CL' not in line)
            water_atoms = stats['total_atoms'] - protein_atoms - na_count - cl_count
            stats['water_molecules'] = water_atoms // 3

        return stats

    def process_single_pdb(self, pdb_id):
        """å˜ä¸€PDBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ"""
        print(f"\\n{'='*60}")
        print(f"Processing: {pdb_id}")
        print(f"{'='*60}")

        work_dir = self.output_dir / pdb_id
        work_dir.mkdir(exist_ok=True)

        log_file = work_dir / 'setup.log'
        result = {
            'pdb_id': pdb_id,
            'status': 'failed',
            'error': None,
            'timestamp': datetime.now().isoformat()
        }

        try:
            with open(log_file, 'w') as log:
                log.write(f"Setup started: {result['timestamp']}\\n")

                # 1. Download
                log.write("Step 1: Downloading PDB...\\n")
                pdb_file = self.download_pdb(pdb_id, work_dir)

                # 2. Clean
                log.write("Step 2: Cleaning PDB...\\n")
                clean_file = self.clean_pdb(pdb_file, work_dir)

                # 3. pdb2gmx
                log.write("Step 3: Generating topology...\\n")
                gro_file, top_file = self.run_pdb2gmx(clean_file, work_dir)

                # 4. Box
                log.write("Step 4: Creating box...\\n")
                box_file = self.create_box(gro_file, work_dir)

                # 5. Solvate
                log.write("Step 5: Solvating...\\n")
                solvated_file = self.solvate(box_file, top_file, work_dir)

                # 6. Add ions
                log.write("Step 6: Adding ions...\\n")
                final_file = self.add_ions(solvated_file, top_file, work_dir)

                # 7. Statistics
                log.write("Step 7: Collecting statistics...\\n")
                stats = self.count_statistics(final_file)
                result.update(stats)

                result['status'] = 'success'
                log.write(f"âœ… Setup completed successfully\\n")
                log.write(f"Statistics: {stats}\\n")

        except Exception as e:
            result['error'] = str(e)
            with open(log_file, 'a') as log:
                log.write(f"âŒ Error: {e}\\n")
            print(f"âŒ Failed: {pdb_id} - {e}")

        return result

    def run_parallel(self, n_processes=4):
        """ä¸¦åˆ—å‡¦ç†ã§ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ"""
        print(f"\\nğŸš€ Starting pipeline with {n_processes} processes")
        print(f"PDB list: {self.pdb_list}\\n")

        with mp.Pool(processes=n_processes) as pool:
            self.results = pool.map(self.process_single_pdb, self.pdb_list)

        self.save_results()
        self.print_summary()

    def save_results(self):
        """çµæœã‚’CSVä¿å­˜"""
        csv_file = self.output_dir / 'setup_results.csv'

        fieldnames = ['pdb_id', 'status', 'total_atoms', 'water_molecules',
                      'na_ions', 'cl_ions', 'timestamp', 'error']

        with open(csv_file, 'w', newline='') as f:
            writer = csv.DictWriter(f, fieldnames=fieldnames)
            writer.writeheader()
            writer.writerows(self.results)

        print(f"\\nâœ… Results saved: {csv_file}")

    def print_summary(self):
        """ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ"""
        print("\\n" + "="*60)
        print("Pipeline Summary")
        print("="*60)

        total = len(self.results)
        success = sum(1 for r in self.results if r['status'] == 'success')
        failed = total - success

        print(f"Total:    {total}")
        print(f"Success:  {success}")
        print(f"Failed:   {failed}")
        print(f"Success rate: {success/total*100:.1f}%")

        if success > 0:
            avg_atoms = sum(r.get('total_atoms', 0) for r in self.results
                            if r['status'] == 'success') / success
            print(f"Average system size: {avg_atoms:.0f} atoms")

        print("="*60)

if __name__ == '__main__':
    # ãƒ†ã‚¹ãƒˆç”¨PDBãƒªã‚¹ãƒˆï¼ˆå°å‹ã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼‰
    pdb_list = ['1UBQ', '1AKI', '2LYZ', '1CRN', '1L2Y']

    pipeline = GROMACSSetupPipeline(
        pdb_list=pdb_list,
        output_dir='automated_systems',
        forcefield=6,  # AMBER99SB-ILDN
        water=1,       # TIP3P
        box_margin=1.0,
        ion_conc=0.15
    )

    # ä¸¦åˆ—å®Ÿè¡Œï¼ˆ4ãƒ—ãƒ­ã‚»ã‚¹ï¼‰
    pipeline.run_parallel(n_processes=4)</code></pre>

                <p><strong>æœŸå¾…ã•ã‚Œã‚‹çµæœ</strong>ï¼š</p>
                <ul>
                    <li>5ã¤ã®PDBæ§‹é€ ãŒä¸¦åˆ—å‡¦ç†ã•ã‚Œã‚‹</li>
                    <li>å„æ§‹é€ ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å®Œå…¨ãªç³»ãŒæ§‹ç¯‰ã•ã‚Œã‚‹</li>
                    <li>setup_results.csvã«çµ±è¨ˆæƒ…å ±ãŒè¨˜éŒ²ã•ã‚Œã‚‹</li>
                    <li>æˆåŠŸç‡90%ä»¥ä¸Šï¼ˆPDBã®å“è³ªã«ä¾å­˜ï¼‰</li>
                    <li>å‡¦ç†æ™‚é–“ï¼šå˜ä¸€ãƒ—ãƒ­ã‚»ã‚¹ã®1/4ç¨‹åº¦ã«çŸ­ç¸®</li>
                </ul>
            </details>
        </div>

        <h2>å‚è€ƒæ–‡çŒ®</h2>
        <ol>
            <li>Abraham, M. J., Murtola, T., Schulz, R., et al. (2015). "GROMACS: High performance molecular simulations through multi-level parallelism from laptops to supercomputers." <em>SoftwareX</em>, 1-2, pp. 19-25.</li>
            <li>Lindorff-Larsen, K., Piana, S., Palmo, K., et al. (2010). "Improved side-chain torsion potentials for the Amber ff99SB protein force field." <em>Proteins</em>, 78(8), pp. 1950-1958.</li>
            <li>Jorgensen, W. L., Chandrasekhar, J., Madura, J. D., et al. (1983). "Comparison of simple potential functions for simulating liquid water." <em>Journal of Chemical Physics</em>, 79(2), pp. 926-935.</li>
            <li>Berendsen, H. J. C., Postma, J. P. M., van Gunsteren, W. F., Hermans, J. (1981). "Interaction Models for Water in Relation to Protein Hydration." In <em>Intermolecular Forces</em>, Springer, pp. 331-342.</li>
            <li>Cock, P. J. A., Antao, T., Chang, J. T., et al. (2009). "Biopython: freely available Python tools for computational molecular biology and bioinformatics." <em>Bioinformatics</em>, 25(11), pp. 1422-1423.</li>
            <li>Michaud-Agrawal, N., Denning, E. J., Woolf, T. B., Beckstein, O. (2011). "MDAnalysis: A toolkit for the analysis of molecular dynamics simulations." <em>Journal of Computational Chemistry</em>, 32(10), pp. 2319-2327.</li>
            <li>GROMACS Documentation: Preprocessing (2024). Available at: https://manual.gromacs.org/current/reference-manual/topologies.html (Accessed: November 2025)</li>
        </ol>

        <h2>å­¦ç¿’ç›®æ¨™ã®ç¢ºèª</h2>
        <div class="tip-box">
            <h4>ã“ã®Chapterã§å­¦ã‚“ã ã“ã¨</h4>
            <p>ä»¥ä¸‹ã®é …ç›®ã«ã¤ã„ã¦ã€è‡ªå·±è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š</p>

            <h4>ãƒ¬ãƒ™ãƒ«1ï¼šåŸºæœ¬ç†è§£</h4>
            <ul>
                <li>PDBãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ ã¨GROMACSã¸ã®å¤‰æ›ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç†è§£ã—ãŸ</li>
                <li>ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²ã¨åŸºæœ¬æ§‹é€ ã‚’èª¬æ˜ã§ãã‚‹</li>
                <li>å‘¨æœŸå¢ƒç•Œæ¡ä»¶ã¨ç®±ã®æ¦‚å¿µã‚’ç†è§£ã—ãŸ</li>
                <li>æº¶åª’å’Œã¨ã‚¤ã‚ªãƒ³ä»˜åŠ ã®ç›®çš„ã‚’èª¬æ˜ã§ãã‚‹</li>
                <li>é›»è·ä¸­æ€§åŒ–ã®å¿…è¦æ€§ã‚’ç†è§£ã—ãŸ</li>
            </ul>

            <h4>ãƒ¬ãƒ™ãƒ«2ï¼šå®Ÿè·µã‚¹ã‚­ãƒ«</h4>
            <ul>
                <li>pdb2gmxã‚’ä½¿ã£ã¦ãƒˆãƒãƒ­ã‚¸ãƒ¼ã‚’ç”Ÿæˆã§ãã‚‹</li>
                <li>gmx editconf / solvate / genionã‚’å®Ÿè¡Œã§ãã‚‹</li>
                <li>Pythonã§ãƒˆãƒãƒ­ã‚¸ãƒ¼ã¨åº§æ¨™ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã§ãã‚‹</li>
                <li>ç³»ã®çµ±è¨ˆæƒ…å ±ï¼ˆåŸå­æ•°ã€ã‚¤ã‚ªãƒ³æ•°ï¼‰ã‚’é›†è¨ˆã§ãã‚‹</li>
                <li>VMD/PyMOLã§æº¶åª’å’Œç³»ã‚’å¯è¦–åŒ–ã§ãã‚‹</li>
            </ul>

            <h4>ãƒ¬ãƒ™ãƒ«3ï¼šå¿œç”¨åŠ›</h4>
            <ul>
                <li>åŠ›å ´ã¨æ°´ãƒ¢ãƒ‡ãƒ«ã®é¸æŠæ ¹æ‹ ã‚’èª¬æ˜ã§ãã‚‹</li>
                <li>ç®±ã‚µã‚¤ã‚ºã¨ã‚¤ã‚ªãƒ³æ¿ƒåº¦ã‚’ç³»ã«å¿œã˜ã¦æœ€é©åŒ–ã§ãã‚‹</li>
                <li>ã‚¤ã‚ªãƒ³é…ç½®ã®å¦¥å½“æ€§ã‚’å®šé‡çš„ã«æ¤œè¨¼ã§ãã‚‹</li>
                <li>ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã§ãã‚‹</li>
                <li>ãƒˆãƒãƒ­ã‚¸ãƒ¼ã‚¨ãƒ©ãƒ¼ã‚’ãƒ‡ãƒãƒƒã‚°ã—ã€å•é¡Œã‚’è§£æ±ºã§ãã‚‹</li>
            </ul>
        </div>

        <div class="nav-buttons">
            <a href="chapter-1.html">â† Chapter 1</a>
            <a href="index.html">ç›®æ¬¡ã«æˆ»ã‚‹</a>
            <a href="chapter-3.html">Chapter 3 â†’</a>
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>
</html>